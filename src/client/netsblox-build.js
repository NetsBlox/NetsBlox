function nop(){return null}function localize(t){return t}function isNil(t){return void 0===t||null===t}function contains(t,e){return t.some(function(t){return t===e})}function detect(t,e){var o,r=t.length;for(o=0;o<r;o+=1)if(e.call(null,t[o]))return t[o];return null}function sizeOf(t){var e,o=0;for(e in t)Object.prototype.hasOwnProperty.call(t,e)&&(o+=1);return o}function isString(t){return"string"==typeof t||t instanceof String}function isObject(t){return null!==t&&("object"==typeof t||t instanceof Object)}function radians(t){return t*Math.PI/180}function degrees(t){return 180*t/Math.PI}function fontHeight(t){var e=Math.max(t,MorphicPreferences.minimumFontHeight);return 1.2*e}function newCanvas(t,e){var o,r;return r=t||{x:0,y:0},o=document.createElement("canvas"),o.width=r.x,o.height=r.y,e&&o.isRetinaEnabled&&(o.isRetinaEnabled=!1),o}function getMinimumFontHeight(){var t,e,o,r,i,n="I",s=50,a=document.createElement("canvas");for(a.width=s,a.height=s,t=a.getContext("2d"),t.font="1px serif",e=t.measureText(n).width,t.fillStyle="black",t.textBaseline="bottom",t.fillText(n,0,s),i=0;i<s;i+=1)for(r=0;r<e;r+=1)if(o=t.getImageData(r,i,1,1),0!==o.data[3])return s-i+1;return 0}function getBlurredShadowSupport(){var t,e,o;return t=document.createElement("canvas"),t.width=10,t.height=10,o=t.getContext("2d"),o.fillStyle="rgb(255, 0, 0)",o.beginPath(),o.arc(5,5,5,0,2*Math.PI,!0),o.closePath(),o.fill(),e=document.createElement("canvas"),e.width=10,e.height=10,o=e.getContext("2d"),o.shadowBlur=10,o.shadowColor="rgba(0, 0, 255, 1)",o.drawImage(t,0,0),!!o.getImageData(0,0,1,1).data[3]}function getDocumentPositionOf(t){var e,o;if(null===t)return{x:0,y:0};for(e={x:t.offsetLeft,y:t.offsetTop},o=t.offsetParent;null!==o;)e.x+=o.offsetLeft,e.y+=o.offsetTop,o!==document.body&&o!==document.documentElement&&(e.x-=o.scrollLeft,e.y-=o.scrollTop),o=o.offsetParent;return e}function copy(t){var e,o,r,i,n,s;if("object"!=typeof t)return t;if(e=t.valueOf(),t!==e)return new t.constructor(e);if(t instanceof t.constructor&&t.constructor!==Object)for(o=Object.create(t.constructor.prototype),i=Object.keys(t),n=i.length,s=0;s<n;s+=1)r=i[s],o[r]=t[r];else{o={};for(r in t)o[r]=t[r]}return o}function enableRetinaSupport(){function t(t){return t.isRetinaEnabled?(r||1)/o:1}var e=document.createElement("canvas").getContext("2d"),o=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,r=Math.ceil(window.devicePixelRatio),i=HTMLCanvasElement.prototype,n=CanvasRenderingContext2D.prototype,s={drawImage:n.drawImage,getImageData:n.getImageData,width:Object.getOwnPropertyDescriptor(i,"width"),height:Object.getOwnPropertyDescriptor(i,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(n,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(n,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(n,"shadowBlur")};o!==r&&(Object.keys(s).some(function(t){var e=s[t];return e.hasOwnProperty("configurable")&&!e.configurable})||(i._isRetinaEnabled=!0,i._bak=s,Object.defineProperty(i,"isRetinaEnabled",{get:function(){return this._isRetinaEnabled},set:function(e){var o=t(this),r=this.width,i=this.height;this._isRetinaEnabled=e,t(this)!=o&&(this.width=r,this.height=i)},configurable:!0}),Object.defineProperty(i,"width",{get:function(){return s.width.get.call(this)/t(this)},set:function(e){var o=t(this);s.width.set.call(this,e*o);var r=this.getContext("2d");r.restore(),r.save(),r.scale(o,o)}}),Object.defineProperty(i,"height",{get:function(){return s.height.get.call(this)/t(this)},set:function(e){var o=t(this);s.height.set.call(this,e*o);var r=this.getContext("2d");r.restore(),r.save(),r.scale(o,o)}}),n.drawImage=function(e){var o,r,i,n,a,h,l,p,c=t(e);switch(arguments.length){case 9:o=arguments[1],r=arguments[2],i=arguments[3],n=arguments[4],a=arguments[5],h=arguments[6],l=arguments[7],p=arguments[8];break;case 5:o=0,r=0,i=e.width,n=e.height,a=arguments[1],h=arguments[2],l=arguments[3],p=arguments[4];break;case 3:o=0,r=0,i=e.width,n=e.height,a=arguments[1],h=arguments[2],l=e.width,p=e.height;break;default:throw Error("Called drawImage() with "+arguments.length+" arguments")}s.drawImage.call(this,e,o*c,r*c,i*c,n*c,a,h,l,p)},n.getImageData=function(e,o,r,i){var n=t(this.canvas);return s.getImageData.call(this,e*n,o*n,r*n,i*n)},Object.defineProperty(n,"shadowOffsetX",{get:function(){return s.shadowOffsetX.get.call(this)/t(this.canvas)},set:function(e){var o=t(this.canvas);s.shadowOffsetX.set.call(this,e*o)}}),Object.defineProperty(n,"shadowOffsetY",{get:function(){return s.shadowOffsetY.get.call(this)/t(this.canvas)},set:function(e){var o=t(this.canvas);s.shadowOffsetY.set.call(this,e*o)}}),Object.defineProperty(n,"shadowBlur",{get:function(){return s.shadowBlur.get.call(this)/t(this.canvas)},set:function(e){var o=t(this.canvas);s.shadowBlur.set.call(this,e*o)}})))}function isRetinaSupported(){var t=document.createElement("canvas").getContext("2d"),e=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,o=HTMLCanvasElement.prototype,r=CanvasRenderingContext2D.prototype,i={drawImage:r.drawImage,getImageData:r.getImageData,width:Object.getOwnPropertyDescriptor(o,"width"),height:Object.getOwnPropertyDescriptor(o,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(r,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(r,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(r,"shadowBlur")};return e!==window.devicePixelRatio&&!Object.keys(i).some(function(t){var e=i[t];return e.hasOwnProperty("configurable")&&!e.configurable})}function isRetinaEnabled(){return HTMLCanvasElement.prototype.hasOwnProperty("_isRetinaEnabled")}function disableRetinaSupport(){var t,e,o;isRetinaEnabled()&&(t=HTMLCanvasElement.prototype,e=CanvasRenderingContext2D.prototype,o=t._bak,Object.defineProperty(t,"width",o.width),Object.defineProperty(t,"height",o.height),e.drawImage=o.drawImage,e.getImageData=o.getImageData,Object.defineProperty(e,"shadowOffsetX",o.shadowOffsetX),Object.defineProperty(e,"shadowOffsetY",o.shadowOffsetY),Object.defineProperty(e,"shadowBlur",o.shadowBlur),delete t._isRetinaEnabled,delete t.isRetinaEnabled,delete t._bak)}function normalizeCanvas(t,e){var o;return t.isRetinaEnabled?(o=newCanvas(new Point(t.width,t.height),!0),o.getContext("2d").drawImage(t,0,0),e?o:(t.isRetinaEnabled=!1,t.width=o.width,t.height=o.height,t.getContext("2d").drawImage(o,0,0),t)):t}function Color(t,e,o,r){this.r=t||0,this.g=e||0,this.b=o||0,this.a=r||(0===r?0:1)}function Point(t,e){this.x=t||0,this.y=e||0}function Rectangle(t,e,o,r){this.init(new Point(t||0,e||0),new Point(o||0,r||0))}function Node(t,e){this.init(t||null,e||[])}function Morph(){this.init()}function ShadowMorph(){this.init()}function HandleMorph(t,e,o,r,i,n){this.init(t,e,o,r,i,n)}function PenMorph(){this.init()}function ColorPaletteMorph(t,e){this.init(t||null,e||new Point(80,50))}function GrayPaletteMorph(t,e){this.init(t||null,e||new Point(80,10))}function ColorPickerMorph(t){this.init(t||new Color(255,255,255))}function BlinkerMorph(t){this.init(t)}function CursorMorph(t){this.init(t)}function BoxMorph(t,e,o){this.init(t,e,o)}function SpeechBubbleMorph(t,e,o,r,i,n,s){this.init(t,e,o,r,i,n,s)}function CircleBoxMorph(t){this.init(t||"vertical")}function SliderButtonMorph(t){this.init(t)}function SliderMorph(t,e,o,r,i,n){this.init(t||1,e||100,o||50,r||10,i||"vertical",n)}function MouseSensorMorph(t,e,o){this.init(t,e,o)}function InspectorMorph(t){this.init(t)}function MenuMorph(t,e,o,r){this.init(t,e,o,r)}function StringMorph(t,e,o,r,i,n,s,a,h,l){this.init(t,e,o,r,i,n,s,a,h,l)}function TextMorph(t,e,o,r,i,n,s,a,h,l){this.init(t,e,o,r,i,n,s,a,h,l)}function TriggerMorph(t,e,o,r,i,n,s,a,h,l,p){this.init(t,e,o,r,i,n,s,a,h,l,p)}function MenuItemMorph(t,e,o,r,i,n,s,a,h,l,p){this.init(t,e,o,r,i,n,s,a,h,l,p)}function FrameMorph(t){this.init(t)}function ScrollFrameMorph(t,e,o){this.init(t,e,o)}function ListMorph(t,e,o,r){this.init(t||[],e||function(t){return isString(t)?t:t.toSource?t.toSource():t.toString()},o||[],r)}function StringFieldMorph(t,e,o,r,i,n,s){this.init(t||"",e||100,o||12,r||"sans-serif",i||!1,n||!1,s)}function BouncerMorph(){this.init()}function HandMorph(t){this.init(t)}function WorldMorph(t,e){this.init(t,e)}function localize(t){return SnapTranslator.translate(t)}function Localizer(t,e){this.language=t||"en",this.dict=e||{}}function PushButtonMorph(t,e,o,r,i,n){this.init(t,e,o,r,i,n)}function ToggleButtonMorph(t,e,o,r,i,n,s,a,h,l,p){this.init(t,e,o,r,i,n,s,a,h,l,p)}function TabMorph(t,e,o,r,i,n,s){this.init(t,e,o,r,i,n,s)}function ToggleMorph(t,e,o,r,i,n,s,a,h,l){this.init(t,e,o,r,i,n,s,a,h,l)}function ToggleElementMorph(t,e,o,r,i,n,s,a){this.init(t,e,o,r,i,n,s,a)}function DialogBoxMorph(t,e,o){this.init(t,e,o)}function AlignmentMorph(t,e){this.init(t,e)}function InputFieldMorph(t,e,o,r){this.init(t,e,o,r)}function SyntaxElementMorph(){this.init()}function BlockMorph(){this.init()}function CommandBlockMorph(){this.init()}function HatBlockMorph(){this.init()}function ReporterBlockMorph(t){this.init(t)}function RingMorph(){this.init()}function ScriptsMorph(t){this.init(t)}function ArgMorph(t){this.init(t)}function CommandSlotMorph(){this.init()}function RingCommandSlotMorph(){this.init()}function CSlotMorph(){this.init()}function InputSlotMorph(t,e,o,r){this.init(t,e,o,r)}function TemplateSlotMorph(t){this.init(t)}function BooleanSlotMorph(t){this.init(t)}function ArrowMorph(t,e,o,r){this.init(t,e,o,r)}function TextSlotMorph(t,e,o,r){this.init(t,e,o,r)}function SymbolMorph(t,e,o,r,i){this.init(t,e,o,r,i)}function ColorSlotMorph(t){this.init(t)}function BlockHighlightMorph(){this.init()}function MultiArgMorph(t,e,o,r,i,n,s,a,h){this.init(t,e,o,r,i,n,s,a,h)}function ArgLabelMorph(t,e){this.init(t,e)}function FunctionSlotMorph(t){this.init(t)}function ReporterSlotMorph(t){this.init(t)}function RingReporterSlotMorph(t){this.init(t)}function CommentMorph(t){this.init(t)}function ScriptFocusMorph(t,e,o){this.init(t,e,o)}function snapEquals(t,e){if(t instanceof List||e instanceof List)return t instanceof List&&e instanceof List&&t.equalTo(e);var o,r=+t,i=+e,n=[!0,!1,""];for(o=9;o<=13;o+=1)n.push(String.fromCharCode(o));return n.push(String.fromCharCode(160)),(isNaN(r)||isNaN(i)||[t,e].some(function(t){return contains(n,t)||isString(t)&&t.indexOf(" ")>-1}))&&(r=t,i=e),isString(r)&&isString(i)?r.toLowerCase()===i.toLowerCase():r===i}function invoke(t,e,o,r,i,n){var s,a=new Process,h=r?Date.now()+r:null;if(t instanceof Context)o&&(t=a.reportContextFor(o)),a.initializeFor(t,e||new List);else{if(!(t instanceof BlockMorph)){if(t.evaluate)return t.evaluate();throw new Error("expecting a block or ring but getting "+t)}a.topBlock=t,s=o||t.receiver(),s&&(a.homeContext=new Context,a.homeContext.receiver=s,s.variables&&(a.homeContext.variables.parentFrame=s.variables)),a.context=new Context(null,t.blockSequence(),a.homeContext)}for(n&&(a.isCatchingErrors=!1);a.isRunning();){if(h&&Date.now()>h)throw new Error(localize(i||"a synchronous Snap! script has timed out"));a.runStep(h)}return a.homeContext.inputs[0]}function ThreadManager(){this.processes=[]}function Process(t,e,o){this.topBlock=t||null,this.readyToYield=!1,this.readyToTerminate=!1,this.isDead=!1,this.isClicked=!1,this.isShowingResult=!1,this.errorFlag=!1,this.context=null,this.homeContext=new Context,this.lastYield=Date.now(),this.isFirstStep=!0,this.isAtomic=!1,this.prompter=null,this.httpRequest=null,this.isPaused=!1,this.pauseOffset=null,this.frameCount=0,this.exportResult=!1,this.onComplete=e||null,this.procedureCount=0,t&&(this.homeContext.receiver=t.receiver(),this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,t.blockSequence(),this.homeContext),o||this.pushContext("doYield"))}function Context(t,e,o,r){this.outerContext=o||null,this.parentContext=t||null,this.expression=e||null,this.receiver=r||null,this.variables=new VariableFrame,this.outerContext&&(this.variables.parentFrame=this.outerContext.variables,this.receiver=this.outerContext.receiver),this.inputs=[],this.pc=0,this.startTime=null,this.activeAudio=null,this.activeNote=null,this.isCustomBlock=!1,this.emptySlots=0,this.tag=null}function Variable(t,e){this.value=t,this.isTransient=e||!1}function VariableFrame(t,e){this.vars={},this.parentFrame=t||null,this.owner=e||null}function isSnapObject(t){return t instanceof SpriteMorph||t instanceof StageMorph}function SpriteMorph(t){this.init(t)}function SpriteHighlightMorph(){this.init()}function StageMorph(t){this.init(t)}function SpriteBubbleMorph(t,e,o,r){this.init(t,e,o,r)}function Costume(t,e,o){this.contents=t?normalizeCanvas(t,!0):newCanvas(null,!0),this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null}function SVG_Costume(t,e,o){this.contents=t,this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null}function CostumeEditorMorph(t){this.init(t)}function Sound(t,e){this.audio=t,this.name=e||"Sound"}function Note(t){this.pitch=0===t?0:t||69,this.setupContext(),this.oscillator=null}function CellMorph(t,e,o,r){this.init(t,e,o,r)}function WatcherMorph(t,e,o,r,i){this.init(t,e,o,r,i)}function StagePrompterMorph(t){this.init(t)}function IDE_Morph(t){this.init(t)}function ProjectDialogMorph(t,e){this.init(t,e)}function SpriteIconMorph(t,e){this.init(t,e)}function CostumeIconMorph(t,e){this.init(t,e)}function TurtleIconMorph(t,e){this.init(t,e)}function WardrobeMorph(t,e){this.init(t,e)}function SoundIconMorph(t,e){this.init(t,e)}function JukeboxMorph(t,e){this.init(t,e)}function StageHandleMorph(t){this.init(t)}function PaletteHandleMorph(t){this.init(t)}function PaintEditorMorph(){this.init()}function PaintColorPickerMorph(t,e){this.init(t,e)}function PaintCanvasMorph(t){this.init(t)}function List(t){this.contents=t||[],this.first=null,this.rest=null,this.isLinked=!1,this.lastChanged=Date.now()}function ListWatcherMorph(t,e){this.init(t,e)}function CustomBlockDefinition(t,e){this.body=null,this.scripts=[],this.category=null,this.isGlobal=!1,this.type="command",this.spec=t||"",this.declarations={},this.variableNames=[],this.comment=null,this.codeMapping=null,this.codeHeader=null,this.receiver=e||null,this.editorDimensions=null}function CustomCommandBlockMorph(t,e){this.init(t,e)}function CustomReporterBlockMorph(t,e,o){this.init(t,e,o)}function JaggedBlockMorph(t){this.init(t)}function BlockDialogMorph(t,e,o){this.init(t,e,o)}function BlockEditorMorph(t,e){this.init(t,e)}function PrototypeHatBlockMorph(t){this.init(t)}function BlockLabelFragment(t){this.labelString=t||"",this.type="%s",this.defaultValue="",this.options="",this.isReadOnly=!1,this.isDeleted=!1}function BlockLabelFragmentMorph(t){this.init(t)}function BlockLabelPlaceHolderMorph(){this.init()}function BlockInputFragmentMorph(t){this.init(t)}function InputSlotDialogMorph(t,e,o,r,i){this.init(t,e,o,r,i)}function VariableDialogMorph(t,e,o){this.init(t,e,o)}function BlockExportDialogMorph(t,e){this.init(t,e)}function BlockImportDialogMorph(t,e,o){this.init(t,e,o)}function BlockRemovalDialogMorph(t,e){this.init(t,e)}function Table(t,e){this.colCount=+t,this.rowCount=+e,this.colNames=[],this.rowNames=[],this.contents=new Array(+e);for(var o=0;o<e;o+=1)this.contents[o]=new Array(+t);this.lastChanged=Date.now()}function TableCellMorph(t,e,o){this.init(t,e,o)}function TableMorph(t,e,o,r,i,n,s,a,h,l){this.init(t,e,o,r,i,n,s,a,h,l)}function TableFrameMorph(t,e){this.init(t,e)}function TableDialogMorph(t,e,o,r){this.init(t,e,o,r)}function ReadStream(t){this.contents=t||"",this.index=0}function XML_Element(t,e,o){this.init(t,e,o)}function XML_Serializer(){this.contents=[],this.media=[],this.isCollectingMedia=!1}function SnapSerializer(){this.init()}function Cloud(t){this.username=null,this.password=null,this.url=t,this.session=null,this.limo=null,this.route=null,this.api={}}function NetCloud(t){Cloud.call(this,t),this.onLogin=nop}function NetsProcess(t,e,o){this.topBlock=t||null,this.readyToYield=!1,this.readyToTerminate=!1,this.isDead=!1,this.isClicked=!1,this.isShowingResult=!1,this.errorFlag=!1,this.context=null,this.homeContext=o||new Context,this.lastYield=Date.now(),this.isAtomic=!1,this.prompter=null,this.httpRequest=null,this.rpcRequest=null,this.isPaused=!1,this.pauseOffset=null,this.frameCount=0,this.exportResult=!1,this.onComplete=e||null,this.procedureCount=0,t&&(this.homeContext.receiver=t.receiver(),this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,t.blockSequence(),this.homeContext),this.pushContext("doYield"))}function BlockExportDialogMorph(t,e,o){this.init(t,e,o)}function MessageType(t,e){this.name=t,this.fields=e}function Message(t){this.type=t,this.contents={},this.init()}function MessageFrame(){this.msgTypes={}}function MessageCreatorMorph(t,e){this.init(t,e)}function MessageDefinitionBlock(){this.init()}function MessageInputSlotMorph(){this.msgFields=[],this._msgContent=[],InputSlotMorph.call(this,null,!1,"messageTypesMenu",!0),this.isStatic=!0}function HintInputSlotMorph(t,e,o){var r=this;this.hintText=e,this.empty=!0,InputSlotMorph.call(this,t,o),this.contents().mouseDownLeft=function(){r.empty&&(this.text=""),StringMorph.prototype.mouseDownLeft.apply(this,arguments)}}function MessageOutputSlotMorph(){MessageInputSlotMorph.call(this)}function ReadOnlyTemplateSlotMorph(t){TemplateSlotMorph.call(this,t),detect(this.children,function(t){return t instanceof ReporterBlockMorph}).mouseClickLeft=readOnlyReporterClick}function RoomMorph(t){this.ide=t,this.roles={},this.roleLabels={},this.invitations={},this.roomLabel=null,this.init(),this._name=localize("MyRoom"),Object.defineProperty(this,"name",{get:function(){return this._name},set:this._onNameChanged.bind(this)}),this.ownerId=null,this.nextRoom=null,this.editable=!1,this.ide.projectName||(this.ide.projectName=RoomMorph.DEFAULT_ROLE),this.silentSetWidth(RoomMorph.SIZE),this.silentSetHeight(RoomMorph.SIZE),this.isDraggable=!1,RoleMorph.prototype.editRole=RoomMorph.prototype.editRole.bind(this);var e=this;RoleLabelMorph.prototype.mouseClickLeft=function(){e.editable&&e.editRoleName(this.name)},SnapCloud.onLogin=function(){e.update(),e._name===localize("MyRoom")&&e.ide.sockets.sendMessage({type:"request-new-name"})},SnapCloud.onPassiveLogin=function(){e._name===localize("MyRoom")&&e.ide.sockets.sendMessage({type:"request-new-name"})};var o={};o[this.ide.projectName]="me",this.update(null,this.name,o),this.sharedMsgs=[],this.drawNew()}function RoleMorph(t,e,o,r){this.init(t,e,o,r)}function RoleLabelMorph(t,e){this.name=t,this.user=e,this.init()}function EditRoleMorph(t,e){DialogBoxMorph.call(this),this.room=t,this.role=e;var o=new TextMorph("What would you like to do?",null,null,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.labelString="Edit "+e.name,this.createLabel(),this.addBody(o),this.addButton("createRoleClone","Clone"),e.user?e.name!==this.room.role()&&this.addButton("evictUser","Evict User"):(this.addButton("moveToRole","Move to"),this.addButton("inviteUser","Invite User"),this.addButton("deleteRole","Delete role")),this.addButton("cancel","Cancel"),this.drawNew();var r=this.center();this.label.setCenter(r),o.setCenter(r)}function ProjectsMorph(t,e){var o=this;ProjectsMorph.uber.init.call(this,null,null,e),this.acceptsDrops=!1,this.room=t,this.add(t),this.room.silentSetPosition(new Point(0,0)),this.room.changed=function(){o.updateRoom()},this.updateRoom(),this.room.checkForSharedMsgs(this.room.ide.projectName)}function NetsBloxMorph(t){this.init(t)}function NetsBloxSerializer(){this.init()}if("undefined"==typeof Map){var Map=function(){this._content={},this.size=0};Map.prototype.set=function(t,e){this._content.hasOwnProperty(t)||this.size++,this._content[t]=e},Map.prototype.get=function(t){return this._content[t]},Map.prototype.delete=function(t){this._content.hasOwnProperty(t)&&this.size--,delete this._content[t]}}Date.now||(Date.now=function(){return(new Date).getTime()});var morphicVersion="2016-August-12",modules={},useBlurredShadows=getBlurredShadowSupport(),standardSettings={minimumFontHeight:getMinimumFontHeight(),globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:12,mouseScrollAmount:40,useSliderForInput:!1,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:24,bubbleHelpFontSize:18,prompterFontName:"sans-serif",prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useSliderForInput:!0,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},MorphicPreferences=standardSettings;enableRetinaSupport(),Color.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")"},Color.prototype.copy=function(){return new Color(this.r,this.g,this.b,this.a)},Color.prototype.eq=function(t){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b},Color.prototype.hsv=function(){var t,e,o,r,i,n,s=this.r/255,a=this.g/255,h=this.b/255;if(t=Math.max(s,a,h),e=Math.min(s,a,h),o=t,r=t,i=t,n=t-e,r=0===t?0:n/t,t===e)o=0;else{switch(t){case s:o=(a-h)/n+(a<h?6:0);break;case a:o=(h-s)/n+2;break;case h:o=(s-a)/n+4}o/=6}return[o,r,i]},Color.prototype.set_hsv=function(t,e,o){var r,i,n,s,a;switch(r=Math.floor(6*t),i=6*t-r,n=o*(1-e),s=o*(1-i*e),a=o*(1-(1-i)*e),r%6){case 0:this.r=o,this.g=a,this.b=n;break;case 1:this.r=s,this.g=o,this.b=n;break;case 2:this.r=n,this.g=o,this.b=a;break;case 3:this.r=n,this.g=s,this.b=o;break;case 4:this.r=a,this.g=n,this.b=o;break;case 5:this.r=o,this.g=n,this.b=s}this.r*=255,this.g*=255,this.b*=255},Color.prototype.mixed=function(t,e){var o=Math.min(Math.max(t,0),1),r=1-o;return new Color(this.r*o+e.r*r,this.g*o+e.g*r,this.b*o+e.b*r)},Color.prototype.darker=function(t){var e=.8333;return t&&(e=(100-t)/100),this.mixed(e,new Color(0,0,0))},Color.prototype.lighter=function(t){var e=.8333;return t&&(e=(100-t)/100),this.mixed(e,new Color(255,255,255))},Color.prototype.dansDarker=function(){var t=this.hsv(),e=new Color,o=Math.max(t[2]-.16,0);return e.set_hsv(t[0],t[1],o),e},Point.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())},Point.prototype.copy=function(){return new Point(this.x,this.y)},Point.prototype.eq=function(t){return this.x===t.x&&this.y===t.y},Point.prototype.lt=function(t){return this.x<t.x&&this.y<t.y},Point.prototype.gt=function(t){return this.x>t.x&&this.y>t.y},Point.prototype.ge=function(t){return this.x>=t.x&&this.y>=t.y},Point.prototype.le=function(t){return this.x<=t.x&&this.y<=t.y},Point.prototype.max=function(t){return new Point(Math.max(this.x,t.x),Math.max(this.y,t.y))},Point.prototype.min=function(t){return new Point(Math.min(this.x,t.x),Math.min(this.y,t.y))},Point.prototype.round=function(){return new Point(Math.round(this.x),Math.round(this.y))},Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))},Point.prototype.neg=function(){return new Point(-this.x,-this.y)},Point.prototype.mirror=function(){return new Point(this.y,this.x)},Point.prototype.floor=function(){return new Point(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))},Point.prototype.ceil=function(){return new Point(Math.ceil(this.x),Math.ceil(this.y))},Point.prototype.add=function(t){return t instanceof Point?new Point(this.x+t.x,this.y+t.y):new Point(this.x+t,this.y+t)},Point.prototype.subtract=function(t){return t instanceof Point?new Point(this.x-t.x,this.y-t.y):new Point(this.x-t,this.y-t)},Point.prototype.multiplyBy=function(t){return t instanceof Point?new Point(this.x*t.x,this.y*t.y):new Point(this.x*t,this.y*t)},Point.prototype.divideBy=function(t){return t instanceof Point?new Point(this.x/t.x,this.y/t.y):new Point(this.x/t,this.y/t)},Point.prototype.floorDivideBy=function(t){return t instanceof Point?new Point(Math.floor(this.x/t.x),Math.floor(this.y/t.y)):new Point(Math.floor(this.x/t),Math.floor(this.y/t))},Point.prototype.r=function(){var t=this.multiplyBy(this);return Math.sqrt(t.x+t.y)},Point.prototype.degrees=function(){var t,e;return 0===this.x?this.y>=0?90:270:(t=this.y/this.x,e=Math.atan(t),this.x>=0?this.y>=0?degrees(e):360+degrees(e):180+degrees(e))},Point.prototype.theta=function(){var t,e;return 0===this.x?radians(this.y>=0?90:270):(t=this.y/this.x,e=Math.atan(t),this.x>=0?this.y>=0?e:radians(360)+e:radians(180)+e)},Point.prototype.crossProduct=function(t){return this.multiplyBy(t.mirror())},Point.prototype.distanceTo=function(t){return t.subtract(this).r()},Point.prototype.rotate=function(t,e){var o=this.subtract(e);return"right"===t?new Point(-o.y,o.y).add(e):"left"===t?new Point(o.y,-o.y).add(e):e.subtract(o)},Point.prototype.flip=function(t,e){return"vertical"===t?new Point(this.x,2*e.y-this.y):new Point(2*e.x-this.x,this.y)},Point.prototype.distanceAngle=function(t,e){var o,r,i=e;return i>270?i-=360:i<-270&&(i+=360),-90<=i&&i<=90?(o=Math.sin(radians(i))*t,r=Math.sqrt(t*t-o*o),new Point(o+this.x,this.y-r)):(o=Math.sin(radians(180-i))*t,r=Math.sqrt(t*t-o*o),new Point(o+this.x,this.y+r))},Point.prototype.scaleBy=function(t){return this.multiplyBy(t)},Point.prototype.translateBy=function(t){return this.add(t)},Point.prototype.rotateBy=function(t,e){var o=e||new Point(0,0),r=this.subtract(o),i=r.r(),n=t-r.theta();return new Point(o.x+i*Math.cos(n),o.y-i*Math.sin(n))},Point.prototype.asArray=function(){return[this.x,this.y]},Rectangle.prototype.init=function(t,e){this.origin=t,this.corner=e},Rectangle.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"},Rectangle.prototype.copy=function(){return new Rectangle(this.left(),this.top(),this.right(),this.bottom())},Point.prototype.corner=function(t){return new Rectangle(this.x,this.y,t.x,t.y)},Point.prototype.rectangle=function(t){var e,o;return e=this.min(t),o=this.max(t),new Rectangle(e.x,e.y,o.x,o.y)},Point.prototype.extent=function(t){var e=this.add(t);return new Rectangle(this.x,this.y,e.x,e.y)},Rectangle.prototype.setTo=function(t,e,o,r){this.origin=new Point(t||(0===t?0:this.left()),e||(0===e?0:this.top())),this.corner=new Point(o||(0===o?0:this.right()),r||(0===r?0:this.bottom()))},Rectangle.prototype.area=function(){var t=this.width();return t<0?0:Math.max(t*this.height(),0)},Rectangle.prototype.bottom=function(){return this.corner.y},Rectangle.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())},Rectangle.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)},Rectangle.prototype.bottomRight=function(){return this.corner.copy()},Rectangle.prototype.boundingBox=function(){return this},Rectangle.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))},Rectangle.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]},Rectangle.prototype.extent=function(){return this.corner.subtract(this.origin)},Rectangle.prototype.height=function(){return this.corner.y-this.origin.y},Rectangle.prototype.left=function(){return this.origin.x},Rectangle.prototype.leftCenter=function(){return new Point(this.left(),this.center().y)},Rectangle.prototype.right=function(){return this.corner.x},Rectangle.prototype.rightCenter=function(){return new Point(this.right(),this.center().y)},Rectangle.prototype.top=function(){return this.origin.y},Rectangle.prototype.topCenter=function(){return new Point(this.center().x,this.top())},Rectangle.prototype.topLeft=function(){return this.origin},Rectangle.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)},Rectangle.prototype.width=function(){return this.corner.x-this.origin.x},Rectangle.prototype.position=function(){return this.origin},Rectangle.prototype.eq=function(t){return this.origin.eq(t.origin)&&this.corner.eq(t.corner)},Rectangle.prototype.abs=function(){var t,e;return t=this.origin.abs(),e=this.corner.max(t),t.corner(e)},Rectangle.prototype.insetBy=function(t){var e=new Rectangle;return e.origin=this.origin.add(t),e.corner=this.corner.subtract(t),e},Rectangle.prototype.expandBy=function(t){var e=new Rectangle;return e.origin=this.origin.subtract(t),e.corner=this.corner.add(t),e},Rectangle.prototype.growBy=function(t){var e=new Rectangle;return e.origin=this.origin.copy(),e.corner=this.corner.add(t),e},Rectangle.prototype.intersect=function(t){var e=new Rectangle;return e.origin=this.origin.max(t.origin),e.corner=this.corner.min(t.corner),e},Rectangle.prototype.merge=function(t){var e=new Rectangle;return e.origin=this.origin.min(t.origin),e.corner=this.corner.max(t.corner),e},Rectangle.prototype.mergeWith=function(t){this.origin=this.origin.min(t.origin),this.corner=this.corner.max(t.corner)},Rectangle.prototype.round=function(){return this.origin.round().corner(this.corner.round())},Rectangle.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil()).expandBy(1)},Rectangle.prototype.amountToTranslateWithin=function(t){var e=0,o=0;return this.right()>t.right()&&(e=t.right()-this.right()),this.bottom()>t.bottom()&&(o=t.bottom()-this.bottom()),this.left()+e<t.left()&&(e=t.left()-this.left()),this.top()+o<t.top()&&(o=t.top()-this.top()),new Point(e,o)},Rectangle.prototype.containsPoint=function(t){return this.origin.le(t)&&t.lt(this.corner)},Rectangle.prototype.containsRectangle=function(t){return t.origin.gt(this.origin)&&t.corner.lt(this.corner)},Rectangle.prototype.intersects=function(t){var e=t.origin,o=t.corner;return o.x>=this.origin.x&&o.y>=this.origin.y&&e.x<=this.corner.x&&e.y<=this.corner.y},Rectangle.prototype.isNearTo=function(t,e){var o=t.origin,r=t.corner,i=e||0;return r.x+i>=this.origin.x&&r.y+i>=this.origin.y&&o.x-i<=this.corner.x&&o.y-i<=this.corner.y},Rectangle.prototype.scaleBy=function(t){var e=this.origin.multiplyBy(t),o=this.corner.multiplyBy(t);return new Rectangle(e.x,e.y,o.x,o.y)},Rectangle.prototype.translateBy=function(t){var e=this.origin.add(t),o=this.corner.add(t);return new Rectangle(e.x,e.y,o.x,o.y)},Rectangle.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]},Rectangle.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]},Node.prototype.init=function(t,e){this.parent=t||null,this.children=e||[]},Node.prototype.toString=function(){return"a Node["+this.children.length.toString()+"]"},Node.prototype.addChild=function(t){this.children.push(t),t.parent=this},Node.prototype.addChildFirst=function(t){this.children.splice(0,null,t),t.parent=this},Node.prototype.removeChild=function(t){var e=this.children.indexOf(t);e!==-1&&this.children.splice(e,1)},Node.prototype.root=function(){return null===this.parent?this:this.parent.root()},Node.prototype.depth=function(){return null===this.parent?0:this.parent.depth()+1},Node.prototype.allChildren=function(){var t=[this];return this.children.forEach(function(e){t=t.concat(e.allChildren())}),t},Node.prototype.forAllChildren=function(t){this.children.length>0&&this.children.forEach(function(e){e.forAllChildren(t)}),t.call(null,this)},Node.prototype.anyChild=function(t){var e;if(t.call(null,this))return!0;for(e=0;e<this.children.length;e+=1)if(this.children[e].anyChild(t))return!0;return!1},Node.prototype.allLeafs=function(){var t=[];return this.allChildren().forEach(function(e){0===e.children.length&&t.push(e)}),t},Node.prototype.allParents=function(){var t=[this];return null!==this.parent&&(t=t.concat(this.parent.allParents())),t},Node.prototype.siblings=function(){
var t=this;return null===this.parent?[]:this.parent.children.filter(function(e){return e!==t})},Node.prototype.parentThatIsA=function(t){return this instanceof t?this:this.parent?this.parent.parentThatIsA(t):null},Node.prototype.parentThatIsAnyOf=function(t){var e=!1,o=this;return t.forEach(function(t){if(o.constructor===t)return void(e=!0)}),e?this:this.parent?this.parent.parentThatIsAnyOf(t):null};var Morph,WorldMorph,HandMorph,ShadowMorph,FrameMorph,MenuMorph,HandleMorph,StringFieldMorph,ColorPickerMorph,SliderMorph,ScrollFrameMorph,InspectorMorph,StringMorph,TextMorph;Morph.prototype=new Node,Morph.prototype.constructor=Morph,Morph.uber=Node.prototype,Morph.prototype.trackChanges=!0,Morph.prototype.shadowBlur=4,Morph.prototype.init=function(t){Morph.uber.init.call(this),this.isMorph=!0,this.image=null,this.bounds=new Rectangle(0,0,50,40),this.cachedFullImage=null,this.cachedFullBounds=null,this.color=new Color(80,80,80),this.texture=null,this.cachedTexture=null,this.alpha=1,this.isVisible=!0,this.isDraggable=!1,this.isTemplate=!1,this.acceptsDrops=!1,this.noticesTransparentClick=!1,t||this.drawNew(),this.fps=0,this.customContextMenu=null,this.lastTime=Date.now(),this.onNextStep=null},Morph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds},Morph.prototype.destroy=function(){null!==this.parent&&(this.fullChanged(),this.parent.removeChild(this))},Morph.prototype.stepFrame=function(){if(!this.step)return null;var t,e,o,r;t=Date.now(),e=t-this.lastTime,o=this.fps>0?1e3/this.fps-e:0,o<1&&(this.lastTime=t,this.onNextStep&&(r=this.onNextStep,this.onNextStep=null,r.call(this)),this.step(),this.children.forEach(function(t){t.stepFrame()}))},Morph.prototype.nextSteps=function(t){var e=t||[],o=e.shift(),r=this;o&&(this.onNextStep=function(){o.call(r),r.nextSteps(e)})},Morph.prototype.step=nop,Morph.prototype.left=function(){return this.bounds.left()},Morph.prototype.right=function(){return this.bounds.right()},Morph.prototype.top=function(){return this.bounds.top()},Morph.prototype.bottom=function(){return this.bounds.bottom()},Morph.prototype.center=function(){return this.bounds.center()},Morph.prototype.bottomCenter=function(){return this.bounds.bottomCenter()},Morph.prototype.bottomLeft=function(){return this.bounds.bottomLeft()},Morph.prototype.bottomRight=function(){return this.bounds.bottomRight()},Morph.prototype.boundingBox=function(){return this.bounds},Morph.prototype.corners=function(){return this.bounds.corners()},Morph.prototype.leftCenter=function(){return this.bounds.leftCenter()},Morph.prototype.rightCenter=function(){return this.bounds.rightCenter()},Morph.prototype.topCenter=function(){return this.bounds.topCenter()},Morph.prototype.topLeft=function(){return this.bounds.topLeft()},Morph.prototype.topRight=function(){return this.bounds.topRight()},Morph.prototype.position=function(){return this.bounds.origin},Morph.prototype.extent=function(){return this.bounds.extent()},Morph.prototype.width=function(){return this.bounds.width()},Morph.prototype.height=function(){return this.bounds.height()},Morph.prototype.fullBounds=function(){var t;return t=this.bounds,this.children.forEach(function(e){e.isVisible&&(t=t.merge(e.fullBounds()))}),t},Morph.prototype.fullBoundsNoShadow=function(){var t;return t=this.bounds,this.children.forEach(function(e){e instanceof ShadowMorph||!e.isVisible||(t=t.merge(e.fullBounds()))}),t},Morph.prototype.visibleBounds=function(){var t=this.bounds,e=this.allParents().filter(function(t){return t instanceof FrameMorph});return e.forEach(function(e){t=t.intersect(e.bounds)}),t},Morph.prototype.moveBy=function(t){this.fullChanged(),this.silentMoveBy(t),this.fullChanged()},Morph.prototype.silentMoveBy=function(t){var e=this.children,o=e.length;for(this.bounds=this.bounds.translateBy(t),this.cachedFullBounds&&(this.cachedFullBounds=this.cachedFullBounds.translateBy(t)),o;o>0;o-=1)e[o-1].silentMoveBy(t)},Morph.prototype.setPosition=function(t){var e=t.subtract(this.topLeft());0===e.x&&0===e.y||this.moveBy(e)},Morph.prototype.silentSetPosition=function(t){var e=t.subtract(this.topLeft());0===e.x&&0===e.y||this.silentMoveBy(e)},Morph.prototype.setLeft=function(t){this.setPosition(new Point(t,this.top()))},Morph.prototype.setRight=function(t){this.setPosition(new Point(t-this.width(),this.top()))},Morph.prototype.setTop=function(t){this.setPosition(new Point(this.left(),t))},Morph.prototype.setBottom=function(t){this.setPosition(new Point(this.left(),t-this.height()))},Morph.prototype.setCenter=function(t){this.setPosition(t.subtract(this.extent().floorDivideBy(2)))},Morph.prototype.setFullCenter=function(t){this.setPosition(t.subtract(this.fullBounds().extent().floorDivideBy(2)))},Morph.prototype.keepWithin=function(t){var e,o,r,i;e=this.fullBounds().left()-t.left(),e<0&&this.moveBy(new Point(-e,0)),o=this.fullBounds().right()-t.right(),o>0&&this.moveBy(new Point(-o,0)),r=this.fullBounds().top()-t.top(),r<0&&this.moveBy(new Point(0,-r)),i=this.fullBounds().bottom()-t.bottom(),i>0&&this.moveBy(new Point(0,-i))},Morph.prototype.scrollIntoView=function(){var t,e,o,r,i=this.parentThatIsA(ScrollFrameMorph);i&&(e=Math.min(this.fullBounds().right()-i.right(),i.contents.right()-i.right()),e>0&&i.contents.moveBy(new Point(-e,0)),t=this.fullBounds().left()-i.left(),t<0&&i.contents.moveBy(new Point(-t,0)),o=this.fullBounds().top()-i.top(),o<0&&i.contents.moveBy(new Point(0,-o)),r=this.fullBounds().bottom()-i.bottom(),r>0&&i.contents.moveBy(new Point(0,-r)),i.adjustScrollBars())},Morph.prototype.setExtent=function(t,e){return e?void this.silentSetExtent(t):void(t.eq(this.extent())||(this.changed(),this.silentSetExtent(t),this.changed(),this.drawNew()))},Morph.prototype.silentSetExtent=function(t){var e,o,r;e=t.round(),o=Math.max(e.x,0),r=Math.max(e.y,0),this.bounds.corner=new Point(this.bounds.origin.x+o,this.bounds.origin.y+r)},Morph.prototype.setWidth=function(t){this.setExtent(new Point(t||0,this.height()))},Morph.prototype.silentSetWidth=function(t){var e=Math.max(Math.round(t||0),0);this.bounds.corner=new Point(this.bounds.origin.x+e,this.bounds.corner.y)},Morph.prototype.setHeight=function(t){this.setExtent(new Point(this.width(),t||0))},Morph.prototype.silentSetHeight=function(t){var e=Math.max(Math.round(t||0),0);this.bounds.corner=new Point(this.bounds.corner.x,this.bounds.origin.y+e)},Morph.prototype.setColor=function(t){t&&(this.color.eq(t)||(this.color=t,this.changed(),this.drawNew()))},Morph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d");t.fillStyle=this.color.toString(),t.fillRect(0,0,this.width(),this.height()),this.cachedTexture?this.drawCachedTexture():this.texture&&this.drawTexture(this.texture)},Morph.prototype.drawTexture=function(t){var e=this;this.cachedTexture=new Image,this.cachedTexture.onload=function(){e.drawCachedTexture()},this.cachedTexture.src=this.texture=t},Morph.prototype.drawCachedTexture=function(){var t,e,o=this.cachedTexture,r=Math.floor(this.image.width/o.width),i=Math.floor(this.image.height/o.height),n=this.image.getContext("2d");for(e=0;e<=i;e+=1)for(t=0;t<=r;t+=1)n.drawImage(o,t*o.width,e*o.height);this.changed()},Morph.prototype.drawOn=function(t,e){var o,r,i,n,s,a,h,l,p,c=this.cachedFullImage||this.image,d=this.cachedFullBounds||this.bounds;if(!this.isVisible)return null;if(o=e||d,r=o.intersect(d),r.extent().gt(new Point(0,0))){if(i=d.position().neg(),n=r.copy().translateBy(i),s=t.getContext("2d"),s.globalAlpha=this.alpha,l=n.left(),p=n.top(),a=Math.min(n.width(),c.width-l),h=Math.min(n.height(),c.height-p),a<1||h<1)return null;s.drawImage(c,l,p,a,h,r.left(),r.top(),a,h)}},Morph.prototype.fullDrawOn=function(t,e){var o;return this.isVisible?(o=e||this.cachedFullBounds||this.fullBounds(),this.drawOn(t,o),void(this.cachedFullImage||this.children.forEach(function(e){e.fullDrawOn(t,o)}))):null},Morph.prototype.hide=function(){this.isVisible=!1,this.changed(),this.children.forEach(function(t){t.hide()})},Morph.prototype.show=function(){this.isVisible=!0,this.changed(),this.children.forEach(function(t){t.show()})},Morph.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible,this.changed(),this.children.forEach(function(t){t.toggleVisibility()})},Morph.prototype.fullImageClassic=function(){var t=this.cachedFullBounds||this.fullBounds(),e=newCanvas(t.extent()),o=e.getContext("2d");return o.translate(-t.origin.x,-t.origin.y),this.fullDrawOn(e,t),e.globalAlpha=this.alpha,e},Morph.prototype.fullImage=function(){var t,e,o;return t=newCanvas(this.fullBounds().extent()),e=t.getContext("2d"),o=this.fullBounds(),this.allChildren().forEach(function(t){t.isVisible&&(e.globalAlpha=t.alpha,t.image.width&&t.image.height&&e.drawImage(t.image,t.bounds.origin.x-o.origin.x,t.bounds.origin.y-o.origin.y))}),t},Morph.prototype.shadowImage=function(t,e){var o,r,i,n,s,a=t||new Point(7,7),h=e||new Color(0,0,0);return o=this.fullBounds().extent(),r=this.fullImage(),i=newCanvas(o),s=i.getContext("2d"),s.drawImage(r,0,0),s.globalCompositeOperation="destination-out",s.drawImage(r,-a.x,-a.y),n=newCanvas(o),s=n.getContext("2d"),s.drawImage(i,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=h.toString(),s.fillRect(0,0,o.x,o.y),n},Morph.prototype.shadowImageBlurred=function(t,e){var o,r,i,n,s=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return o=this.fullBounds().extent().add(2*a),r=this.fullImage(),i=newCanvas(o),n=i.getContext("2d"),n.shadowOffsetX=s.x,n.shadowOffsetY=s.y,n.shadowBlur=a,n.shadowColor=h.toString(),n.drawImage(r,a-s.x,a-s.y),n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(r,a-s.x,a-s.y),i},Morph.prototype.shadow=function(t,e,o){var r=new ShadowMorph,i=t||new Point(7,7),n=e||(0===e?0:.2),s=this.fullBounds();return r.setExtent(s.extent().add(2*this.shadowBlur)),useBlurredShadows&&!MorphicPreferences.isFlat?(r.image=this.shadowImageBlurred(i,o),r.alpha=n,r.setPosition(s.origin.add(i).subtract(this.shadowBlur))):(r.image=this.shadowImage(i,o),r.alpha=n,r.setPosition(s.origin.add(i))),r},Morph.prototype.addShadow=function(t,e,o){var r,i=t||new Point(7,7),n=e||(0===e?0:.2);return r=this.shadow(i,n,o),this.addBack(r),this.fullChanged(),r},Morph.prototype.getShadow=function(){var t;return t=this.children.slice(0).reverse().filter(function(t){return t instanceof ShadowMorph}),0!==t.length?t[0]:null},Morph.prototype.removeShadow=function(){var t=this.getShadow();null!==t&&(this.fullChanged(),this.removeChild(t))},Morph.prototype.penTrails=function(){return this.image},Morph.prototype.changed=function(){if(this.trackChanges){var t=this.root();t instanceof WorldMorph&&t.broken.push(this.visibleBounds().spread())}this.parent&&this.parent.childChanged(this)},Morph.prototype.fullChanged=function(){if(this.trackChanges){var t=this.root();t instanceof WorldMorph&&t.broken.push((this.cachedFullBounds||this.fullBounds()).spread())}},Morph.prototype.childChanged=function(){this.parent&&this.parent.childChanged(this)},Morph.prototype.world=function(){var t=this.root();return t instanceof WorldMorph?t:t instanceof HandMorph?t.world:null},Morph.prototype.add=function(t){var e=t.parent;null!==e&&e.removeChild(t),this.addChild(t)},Morph.prototype.addBack=function(t){var e=t.parent;null!==e&&e.removeChild(t),this.addChildFirst(t)},Morph.prototype.topMorphAt=function(t){var e,o;if(!this.isVisible)return null;for(e=this.children.length-1;e>=0;e-=1)if(o=this.children[e].topMorphAt(t))return o;return!this.bounds.containsPoint(t)||!this.noticesTransparentClick&&this.isTransparentAt(t)?null:this},Morph.prototype.topMorphSuchThat=function(t){var e;return t.call(null,this)?(e=detect(this.children.slice(0).reverse(),t),e?e.topMorphSuchThat(t):this):null},Morph.prototype.overlappedMorphs=function(){var t,e=this.world(),o=this.fullBounds(),r=this,i=this.allParents(),n=this.allChildren();return t=e.allChildren(),t.filter(function(t){return t.isVisible&&t!==r&&t!==e&&!contains(i,t)&&!contains(n,t)&&t.fullBounds().intersects(o)})},Morph.prototype.getPixelColor=function(t){var e,o,r;return e=t.subtract(this.bounds.origin),o=this.image.getContext("2d"),r=o.getImageData(e.x,e.y,1,1),new Color(r.data[0],r.data[1],r.data[2],r.data[3])},Morph.prototype.isTransparentAt=function(t){var e,o,r;return!!this.bounds.containsPoint(t)&&(!this.texture&&(e=t.subtract(this.bounds.origin),o=this.image.getContext("2d"),r=o.getImageData(Math.floor(e.x),Math.floor(e.y),1,1),0===r.data[3]))},Morph.prototype.copy=function(){var t=copy(this);return t.parent=null,t.children=[],t.bounds=this.bounds.copy(),t},Morph.prototype.fullCopy=function(){var t,e=new Map;return t=this.copyRecordingReferences(e),t.forAllChildren(function(t){t.updateReferences(e)}),t},Morph.prototype.copyRecordingReferences=function(t){var e=this.copy();return t.set(this,e),this.children.forEach(function(o){e.add(o.copyRecordingReferences(t))}),e},Morph.prototype.updateReferences=function(t){var e,o,r,i,n=Object.keys(this),s=n.length;for(i=0;i<s;i+=1)e=n[i],o=this[e],o&&o.isMorph&&(r=t.get(o),r&&(this[e]=r))},Morph.prototype.rootForGrab=function(){return this instanceof ShadowMorph?this.parent.rootForGrab():this.parent instanceof ScrollFrameMorph?this.parent:null===this.parent||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||this.isDraggable===!0?this:this.parent.rootForGrab()},Morph.prototype.isCorrectingOutsideDrag=function(){return!0},Morph.prototype.wantsDropOf=function(t){return!(t instanceof HandleMorph||t instanceof MenuMorph||t instanceof InspectorMorph)&&this.acceptsDrops},Morph.prototype.pickUp=function(t){var e=t||this.world();this.setPosition(e.hand.position().subtract(this.extent().floorDivideBy(2))),e.hand.grab(this)},Morph.prototype.isPickedUp=function(){return null!==this.parentThatIsA(HandMorph)},Morph.prototype.situation=function(){return this.parent?{origin:this.parent,position:this.position().subtract(this.parent.position())}:null},Morph.prototype.slideBackTo=function(t,e){var o=e||5,r=t.origin.position().add(t.position),i=-(this.left()-r.x)/o,n=-(this.top()-r.y)/o,s=0,a=this.step,h=this.fps,l=this;this.fps=0,this.step=function(){l.moveBy(new Point(i,n)),s+=1,s===o&&(t.origin.add(l),t.origin.reactToDropOf&&t.origin.reactToDropOf(l),l.step=a,l.fps=h)}},Morph.prototype.nop=function(){nop()},Morph.prototype.resize=function(){this.world().activeHandle=new HandleMorph(this)},Morph.prototype.move=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move")},Morph.prototype.moveCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"moveCenter")},Morph.prototype.hint=function(t){var e,o;o=t,t?t.toString&&(o=t.toString()):o="NULL",e=new MenuMorph(this,o),e.isDraggable=!0,e.popUpCenteredAtHand(this.world())},Morph.prototype.inform=function(t){var e,o;o=t,t?t.toString&&(o=t.toString()):o="NULL",e=new MenuMorph(this,o),e.addItem("Ok"),e.isDraggable=!0,e.popUpCenteredAtHand(this.world())},Morph.prototype.prompt=function(t,e,o,r,i,n,s,a){var h,l,p,c;s&&(c=!0),h=new MenuMorph(e||null,t||"",o||null),l=new StringFieldMorph(r||"",i||100,MorphicPreferences.prompterFontSize,MorphicPreferences.prompterFontName,!1,!1,c),h.items.push(l),(s||MorphicPreferences.useSliderForInput)&&(p=new SliderMorph(n||0,s,parseFloat(r),Math.floor((s-n)/4),"horizontal"),p.alpha=1,p.color=new Color(225,225,225),p.button.color=h.borderColor,p.button.highlightColor=p.button.color.copy(),p.button.highlightColor.b+=100,p.button.pressColor=p.button.color.copy(),p.button.pressColor.b+=150,p.setHeight(MorphicPreferences.prompterSliderSize),a?p.action=function(t){l.changed(),l.text.text=Math.round(t).toString(),l.text.drawNew(),l.text.changed(),l.text.edit()}:p.action=function(t){l.changed(),l.text.text=t.toString(),l.text.drawNew(),l.text.changed()},h.items.push(p)),h.addLine(2),h.addItem("Ok",function(){return l.string()}),h.addItem("Cancel",function(){return null}),h.isDraggable=!0,h.popUpAtHand(this.world()),l.text.edit()},Morph.prototype.pickColor=function(t,e,o,r){var i,n;i=new MenuMorph(e||null,t||"",o||null),n=new ColorPickerMorph(r),i.items.push(n),i.addLine(2),i.addItem("Ok",function(){return n.getChoice()}),i.addItem("Cancel",function(){return null}),i.isDraggable=!0,i.popUpAtHand(this.world())},Morph.prototype.inspect=function(t){var e,o=this.world instanceof Function?this.world():this.root()||this.world,r=this;t&&(r=t),e=new InspectorMorph(r),e.setPosition(o.hand.position()),e.keepWithin(o),o.add(e),e.changed()},Morph.prototype.contextMenu=function(){var t;return this.customContextMenu?this.customContextMenu:(t=this.world instanceof Function?this.world():this.world,t&&t.isDevMode?this.parent===t?this.developersMenu():this.hierarchyMenu():this.userMenu()||this.parent&&this.parent.userMenu())},Morph.prototype.hierarchyMenu=function(){var t=this.allParents(),e=this.world instanceof Function?this.world():this.world,o=new MenuMorph(this,null);return t.forEach(function(t){t.developersMenu&&t!==e&&o.addItem(t.toString().slice(0,50),function(){t.developersMenu().popUpAtHand(e)})}),o},Morph.prototype.developersMenu=function(){var t=this.world instanceof Function?this.world():this.world,e=this.userMenu()||this.parent&&this.parent.userMenu(),o=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);return e&&(o.addItem("user features...",function(){e.popUpAtHand(t)}),o.addLine()),o.addItem("color...",function(){this.pickColor(o.title+"\ncolor:",this.setColor,this,this.color)},"choose another color \nfor this morph"),o.addItem("transparency...",function(){this.prompt(o.title+"\nalpha\nvalue:",this.setAlphaScaled,this,(100*this.alpha).toString(),null,1,100,!0)},"set this morph's\nalpha value"),o.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's extent"),o.addLine(),o.addItem("duplicate",function(){this.fullCopy().pickUp(this.world())},"make a copy\nand pick it up"),o.addItem("pick up","pickUp","disattach and put \ninto the hand"),o.addItem("attach...","attach","stick this morph\nto another one"),o.addItem("move...","move","show a handle\nwhich can be dragged\nto move this morph"),o.addItem("inspect...","inspect","open a window\non all properties"),o.addItem("pic...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),o.addLine(),this.isDraggable?o.addItem("lock","toggleIsDraggable","make this morph\nunmovable"):o.addItem("unlock","toggleIsDraggable","make this morph\nmovable"),o.addItem("hide","hide"),o.addItem("delete","destroy"),this instanceof WorldMorph||(o.addLine(),o.addItem("World...",function(){t.contextMenu().popUpAtHand(t)},"show the\nWorld's menu")),o},Morph.prototype.userMenu=function(){return null},Morph.prototype.setAlphaScaled=function(t){var e,o;"number"==typeof t?(o=t/100,this.alpha=Math.min(Math.max(o,.1),1)):(e=parseFloat(t),isNaN(e)||(o=e/100,this.alpha=Math.min(Math.max(o,.1),1))),this.changed()},Morph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose new parent:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){t.add(o),o.isDraggable=!1})}),t.length>0&&e.popUpAtHand(this.world())},Morph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable},Morph.prototype.colorSetters=function(){return["color"]},Morph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]},Morph.prototype.allEntryFields=function(){return this.allChildren().filter(function(t){return t.isEditable&&(t instanceof StringMorph||t instanceof TextMorph)})},Morph.prototype.nextEntryField=function(t){var e=this.allEntryFields(),o=e.indexOf(t);return o!==-1&&e.length>o+1?e[o+1]:e[0]},Morph.prototype.previousEntryField=function(t){var e=this.allEntryFields(),o=e.indexOf(t);return o!==-1?o>0?e[o-1]:e[e.length-1]:e[0]},Morph.prototype.tab=function(t){this.nextTab?this.nextTab(t):this.parent&&this.parent.tab(t)},Morph.prototype.backTab=function(t){this.previousTab?this.previousTab(t):this.parent&&this.parent.backTab(t)},Morph.prototype.escalateEvent=function(t,e){for(var o=this.parent;!o[t]&&null!==o.parent;)o=o.parent;o[t]&&o[t](e)},Morph.prototype.evaluateString=function(code){var result;try{result=eval(code),this.drawNew(),this.changed()}catch(t){this.inform(t)}return result},Morph.prototype.isTouching=function(t){var e,o=this.overlappingImage(t);return!(!o.width||!o.height)&&(e=o.getContext("2d").getImageData(1,1,o.width,o.height).data,null!==detect(e,function(t){return 0!==t}))},Morph.prototype.overlappingImage=function(t){var e=this.fullBounds(),o=t.fullBounds(),r=e.intersect(o),i=newCanvas(r.extent()),n=i.getContext("2d");return r.width()<1||r.height()<1?newCanvas(new Point(1,1)):(n.drawImage(this.fullImage(),r.origin.x-e.origin.x,r.origin.y-e.origin.y),n.globalCompositeOperation="source-in",n.drawImage(t.fullImage(),o.origin.x-r.origin.x,o.origin.y-r.origin.y),i)},ShadowMorph.prototype=new Morph,ShadowMorph.prototype.constructor=ShadowMorph,ShadowMorph.uber=Morph.prototype,ShadowMorph.prototype.topMorphAt=function(){return null},HandleMorph.prototype=new Morph,HandleMorph.prototype.constructor=HandleMorph,HandleMorph.uber=Morph.prototype,HandleMorph.prototype.init=function(t,e,o,r,i,n){var s=MorphicPreferences.handleSize;this.target=t||null,this.minExtent=new Point(e||0,o||0),this.inset=new Point(r||0,i||r||0),this.type=n||"resize",HandleMorph.uber.init.call(this),this.color=new Color(255,255,255),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(s,s))},HandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent()),this.highlightImage=newCanvas(this.extent()),this.drawOnCanvas(this.normalImage,this.color,new Color(100,100,100)),this.drawOnCanvas(this.highlightImage,new Color(100,100,255),new Color(255,255,255)),this.image=this.normalImage,this.target&&("moveCenter"===this.type?this.setCenter(this.target.center()):this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset))),this.target.add(this),this.target.changed())},HandleMorph.prototype.drawOnCanvas=function(t,e,o){var r,i,n,s,a,h=t.getContext("2d"),l=0===this.type.indexOf("move");if(h.lineWidth=1,h.lineCap="round",h.strokeStyle=e.toString(),l)for(r=this.bottomLeft().subtract(this.position()),i=r.copy(),n=this.topRight().subtract(this.position()),s=n.copy(),a=0;a<=this.height();a+=6)i.y=r.y-a,s.y=n.y-a,h.beginPath(),h.moveTo(i.x,i.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke();for(r=this.bottomLeft().subtract(this.position()),i=r.copy(),n=this.topRight().subtract(this.position()),s=n.copy(),a=0;a<=this.width();a+=6)i.x=r.x+a,s.x=n.x+a,h.beginPath(),h.moveTo(i.x,i.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke();if(h.strokeStyle=o.toString(),l)for(r=this.bottomLeft().subtract(this.position()),i=r.copy(),n=this.topRight().subtract(this.position()),s=n.copy(),a=-2;a<=this.height();a+=6)i.y=r.y-a,s.y=n.y-a,h.beginPath(),h.moveTo(i.x,i.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke();for(r=this.bottomLeft().subtract(this.position()),i=r.copy(),n=this.topRight().subtract(this.position()),s=n.copy(),a=2;a<=this.width();a+=6)i.x=r.x+a,s.x=n.x+a,h.beginPath(),h.moveTo(i.x,i.y),h.lineTo(s.x,s.y),h.closePath(),h.stroke()},HandleMorph.prototype.step=null,HandleMorph.prototype.mouseDownLeft=function(t){var e,o=this.root(),r=this;return this.target?(e="moveCenter"===this.type?t.subtract(this.center()):t.subtract(this.bounds.origin),this.step=function(){var t,i;o.hand.mouseButton?(t=o.hand.bounds.origin.copy().subtract(e),"resize"===this.type?(i=t.add(r.extent().add(r.inset)).subtract(r.target.bounds.origin),i=i.max(r.minExtent),r.target.setExtent(i),r.setPosition(r.target.bottomRight().subtract(r.extent().add(r.inset)))):"moveCenter"===this.type?r.target.setCenter(t):r.target.setPosition(t.subtract(this.target.extent()).add(this.extent()))):this.step=null},void(this.target.step||(this.target.step=function(){nop()}))):null},HandleMorph.prototype.rootForGrab=function(){return this},HandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},HandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},HandleMorph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.isDraggable=!1,o.target=t,o.drawNew(),o.noticesTransparentClick=!0})}),t.length>0&&e.popUpAtHand(this.world())};var PenMorph;PenMorph.prototype=new Morph,PenMorph.prototype.constructor=PenMorph,PenMorph.uber=Morph.prototype,PenMorph.prototype.init=function(){var t=4*MorphicPreferences.handleSize;this.isWarped=!1,this.heading=0,this.isDown=!0,this.size=1,this.wantsRedraw=!1,this.penPoint="tip",this.penBounds=null,HandleMorph.uber.init.call(this),this.setExtent(new Point(t,t))},PenMorph.prototype.changed=function(){if(this.isWarped===!1){var t=this.root();t instanceof WorldMorph&&t.broken.push(this.visibleBounds().spread()),this.parent&&this.parent.childChanged(this)}},PenMorph.prototype.drawNew=function(t){var e,o,r,i,n,s,a=t||this.heading;return this.isWarped?void(this.wantsRedraw=!0):(this.image=newCanvas(this.extent()),e=this.image.getContext("2d"),s=this.width()/2,o=this.center().subtract(this.bounds.origin),"tip"===this.penPoint?(r=o.distanceAngle(.75*s,a-180),i=o.distanceAngle(s,a+195),n=o.distanceAngle(s,a-195)):(r=o.distanceAngle(.75*s,a),i=o.distanceAngle(.33*s,a+230),n=o.distanceAngle(.33*s,a-230)),this.penBounds=new Rectangle(Math.min(o.x,r.x,i.x,n.x),Math.min(o.y,r.y,i.y,n.y),Math.max(o.x,r.x,i.x,n.x),Math.max(o.y,r.y,i.y,n.y)),e.fillStyle=this.color.toString(),e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(i.x,i.y),e.lineTo(r.x,r.y),e.lineTo(n.x,n.y),e.closePath(),e.strokeStyle="white",e.lineWidth=3,e.stroke(),e.strokeStyle="black",e.lineWidth=1,e.stroke(),void e.fill())},PenMorph.prototype.setHeading=function(t){this.heading=parseFloat(t)%360,this.drawNew(),this.changed()},PenMorph.prototype.drawLine=function(t,e){var o=this.parent.penTrails().getContext("2d"),r=t.subtract(this.parent.bounds.origin),i=e.subtract(this.parent.bounds.origin);this.isDown&&(o.lineWidth=this.size,o.strokeStyle=this.color.toString(),o.lineCap="round",o.lineJoin="round",o.beginPath(),o.moveTo(r.x,r.y),o.lineTo(i.x,i.y),o.stroke(),this.isWarped===!1&&this.world().broken.push(t.rectangle(e).expandBy(Math.max(this.size/2,1)).intersect(this.parent.visibleBounds()).spread()))},PenMorph.prototype.turn=function(t){this.setHeading(this.heading+parseFloat(t))},PenMorph.prototype.forward=function(t){var e,o=this.center(),r=parseFloat(t);e=r>=0?this.position().distanceAngle(r,this.heading):this.position().distanceAngle(Math.abs(r),this.heading-180),this.setPosition(e),this.drawLine(o,this.center())},PenMorph.prototype.down=function(){this.isDown=!0},PenMorph.prototype.up=function(){this.isDown=!1},PenMorph.prototype.clear=function(){this.parent.drawNew(),this.parent.changed()},PenMorph.prototype.startWarp=function(){this.wantsRedraw=!1,this.isWarped=!0},PenMorph.prototype.endWarp=function(){this.isWarped=!1,this.wantsRedraw&&(this.drawNew(),this.wantsRedraw=!1),this.parent.changed()},PenMorph.prototype.warp=function(t){this.startWarp(),t.call(this),this.endWarp()},PenMorph.prototype.warpOp=function(t,e){this.startWarp(),this[t].apply(this,e),this.endWarp()},PenMorph.prototype.warpSierpinski=function(t,e){this.warpOp("sierpinski",[t,e])},PenMorph.prototype.sierpinski=function(t,e){var o;if(t>e)for(o=0;o<3;o+=1)this.sierpinski(.5*t,e),this.turn(120),this.forward(t)},PenMorph.prototype.warpTree=function(t,e,o){this.warpOp("tree",[t,e,o])},PenMorph.prototype.tree=function(t,e,o){t>0&&(this.size=t,this.forward(e),this.turn(o),this.tree(t-1,.75*e,o),this.turn(o*-2),this.tree(t-1,.75*e,o),this.turn(o),this.forward(-e))};var ColorPaletteMorph;ColorPaletteMorph.prototype=new Morph,ColorPaletteMorph.prototype.constructor=ColorPaletteMorph,ColorPaletteMorph.uber=Morph.prototype,ColorPaletteMorph.prototype.init=function(t,e){ColorPaletteMorph.uber.init.call(this),this.target=t,this.targetSetter="color",this.silentSetExtent(e),this.choice=null,this.drawNew()},ColorPaletteMorph.prototype.drawNew=function(){var t,e,o,r,i,n;for(e=this.extent(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.choice=new Color,o=0;o<=e.x;o+=1)for(i=360*o/e.x,r=0;r<=e.y;r+=1)n=100-r/e.y*100,t.fillStyle="hsl("+i+",100%,"+n+"%)",t.fillRect(o,r,1,1)},ColorPaletteMorph.prototype.mouseMove=function(t){this.choice=this.getPixelColor(t),this.updateTarget()},ColorPaletteMorph.prototype.mouseDownLeft=function(t){this.choice=this.getPixelColor(t),this.updateTarget()},ColorPaletteMorph.prototype.updateTarget=function(){this.target instanceof Morph&&null!==this.choice&&(this.target[this.targetSetter]instanceof Function?this.target[this.targetSetter](this.choice):(this.target[this.targetSetter]=this.choice,this.target.drawNew(),this.target.changed()))},ColorPaletteMorph.prototype.developersMenu=function(){var t=ColorPaletteMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("set target","setTarget","choose another morph\nwhose color property\n will be controlled by this one"),t},ColorPaletteMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.push(this.world()),t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.target=t,o.setTargetSetter()})}),1===t.length?(this.target=t[0],this.setTargetSetter()):t.length>0&&e.popUpAtHand(this.world())},ColorPaletteMorph.prototype.setTargetSetter=function(){var t=this.target.colorSetters(),e=new MenuMorph(this,"choose target property:"),o=this;t.forEach(function(t){e.addItem(t,function(){o.targetSetter=t})}),1===t.length?this.targetSetter=t[0]:t.length>0&&e.popUpAtHand(this.world())};var GrayPaletteMorph;GrayPaletteMorph.prototype=new ColorPaletteMorph,GrayPaletteMorph.prototype.constructor=GrayPaletteMorph,GrayPaletteMorph.uber=ColorPaletteMorph.prototype,GrayPaletteMorph.prototype.drawNew=function(){var t,e,o;e=this.extent(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.choice=new Color,o=t.createLinearGradient(0,0,e.x,e.y),o.addColorStop(0,"black"),o.addColorStop(1,"white"),t.fillStyle=o,t.fillRect(0,0,e.x,e.y)},ColorPickerMorph.prototype=new Morph,ColorPickerMorph.prototype.constructor=ColorPickerMorph,ColorPickerMorph.uber=Morph.prototype,ColorPickerMorph.prototype.init=function(t){this.choice=t,ColorPickerMorph.uber.init.call(this),this.color=new Color(255,255,255),this.silentSetExtent(new Point(80,80)),this.drawNew()},ColorPickerMorph.prototype.drawNew=function(){ColorPickerMorph.uber.drawNew.call(this),this.buildSubmorphs()},ColorPickerMorph.prototype.buildSubmorphs=function(){var t,e,o,r;this.children.forEach(function(t){t.destroy()}),this.children=[],this.feedback=new Morph,this.feedback.color=this.choice,this.feedback.setExtent(new Point(20,20)),t=new ColorPaletteMorph(this.feedback,new Point(this.width(),50)),e=new GrayPaletteMorph(this.feedback,new Point(this.width(),5)),t.setPosition(this.bounds.origin),this.add(t),e.setPosition(t.bottomLeft()),this.add(e),o=e.left()+Math.floor((e.width()-this.feedback.width())/2),r=e.bottom()+Math.floor((this.bottom()-e.bottom()-this.feedback.height())/2),this.feedback.setPosition(new Point(o,r)),this.add(this.feedback)},ColorPickerMorph.prototype.getChoice=function(){return this.feedback.color},ColorPickerMorph.prototype.rootForGrab=function(){return this};var BlinkerMorph;BlinkerMorph.prototype=new Morph,BlinkerMorph.prototype.constructor=BlinkerMorph,BlinkerMorph.uber=Morph.prototype,BlinkerMorph.prototype.init=function(t){BlinkerMorph.uber.init.call(this),this.color=new Color(0,0,0),this.fps=t||2,this.drawNew()},BlinkerMorph.prototype.step=function(){this.toggleVisibility()};var CursorMorph;CursorMorph.prototype=new BlinkerMorph,
CursorMorph.prototype.constructor=CursorMorph,CursorMorph.uber=BlinkerMorph.prototype,CursorMorph.prototype.viewPadding=1,CursorMorph.prototype.init=function(t){var e;this.keyDownEventUsed=!1,this.target=t,this.originalContents=this.target.text,this.originalAlignment=this.target.alignment,this.slot=this.target.text.length,CursorMorph.uber.init.call(this),e=fontHeight(this.target.fontSize),this.setExtent(new Point(Math.max(Math.floor(e/20),1),e)),this.drawNew(),this.image.getContext("2d").font=this.target.font(),this.target instanceof TextMorph&&"left"!==this.target.alignment&&this.target.setAlignmentToLeft(),this.gotoSlot(this.slot),this.initializeClipboardHandler()},CursorMorph.prototype.initializeClipboardHandler=function(){var t=this;this.clipboardHandler=document.createElement("textarea"),this.clipboardHandler.style.position="absolute",this.clipboardHandler.style.right="101%",document.body.appendChild(this.clipboardHandler),this.clipboardHandler.value=this.target.selection(),this.clipboardHandler.focus(),this.clipboardHandler.select(),this.clipboardHandler.addEventListener("keypress",function(e){t.processKeyPress(e),this.value=t.target.selection(),this.select()},!1),this.clipboardHandler.addEventListener("keydown",function(e){t.processKeyDown(e),this.value=t.target.selection(),this.select(),"U+0009"!==e.key&&"Tab"!==e.key||(t.processKeyPress(e),e.preventDefault())},!1),this.clipboardHandler.addEventListener("input",function(e){""===this.value&&(t.gotoSlot(t.target.selectionStartSlot()),t.target.deleteSelection())},!1)},CursorMorph.prototype.processKeyPress=function(t){return this.keyDownEventUsed?(this.keyDownEventUsed=!1,null):40===t.keyCode||40===t.charCode?(this.insert("("),null):37===t.keyCode||37===t.charCode?(this.insert("%"),null):(t.keyCode?t.ctrlKey&&!t.altKey?this.ctrl(t.keyCode,t.shiftKey):t.metaKey?this.cmd(t.keyCode,t.shiftKey):this.insert(String.fromCharCode(t.keyCode),t.shiftKey):t.charCode&&(t.ctrlKey&&!t.altKey?this.ctrl(t.charCode,t.shiftKey):t.metaKey?this.cmd(t.charCode,t.shiftKey):this.insert(String.fromCharCode(t.charCode),t.shiftKey)),void this.target.escalateEvent("reactToKeystroke",t))},CursorMorph.prototype.processKeyDown=function(t){var e=t.shiftKey;if(this.keyDownEventUsed=!1,t.ctrlKey&&!t.altKey)return this.ctrl(t.keyCode,t.shiftKey),void this.target.escalateEvent("reactToKeystroke",t);if(t.metaKey)return this.cmd(t.keyCode,t.shiftKey),void this.target.escalateEvent("reactToKeystroke",t);switch(t.keyCode){case 37:this.goLeft(e),this.keyDownEventUsed=!0;break;case 39:this.goRight(e),this.keyDownEventUsed=!0;break;case 38:this.goUp(e),this.keyDownEventUsed=!0;break;case 40:this.goDown(e),this.keyDownEventUsed=!0;break;case 36:this.goHome(e),this.keyDownEventUsed=!0;break;case 35:this.goEnd(e),this.keyDownEventUsed=!0;break;case 46:this.deleteRight(),this.keyDownEventUsed=!0;break;case 8:this.deleteLeft(),this.keyDownEventUsed=!0;break;case 13:this.target instanceof StringMorph||e?this.accept():this.insert("\n"),this.keyDownEventUsed=!0;break;case 27:this.cancel(),this.keyDownEventUsed=!0;break;default:nop()}this.target.escalateEvent("reactToKeystroke",t)},CursorMorph.prototype.gotoSlot=function(t){var e,o,r=this.target.text.length,i=this.target.slotPosition(t);this.slot=t<0?0:t>r?r:t,this.parent&&this.target.isScrollable&&(e=this.parent.right()-this.viewPadding,o=this.parent.left()+this.viewPadding,i.x>e&&(this.target.setLeft(this.target.left()+e-i.x),i.x=e),i.x<o&&(o=Math.min(this.parent.left(),o),this.target.setLeft(this.target.left()+o-i.x),i.x=o),this.target.right()<e&&e-this.target.width()<o&&(i.x+=e-this.target.right(),this.target.setRight(e))),this.show(),this.setPosition(i),this.parent&&this.parent.parent instanceof ScrollFrameMorph&&this.target.isScrollable&&this.parent.parent.scrollCursorIntoView(this)},CursorMorph.prototype.goLeft=function(t){this.updateSelection(t),this.gotoSlot(this.slot-1),this.updateSelection(t)},CursorMorph.prototype.goRight=function(t,e){this.updateSelection(t),this.gotoSlot(this.slot+(e||1)),this.updateSelection(t)},CursorMorph.prototype.goUp=function(t){this.updateSelection(t),this.gotoSlot(this.target.upFrom(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goDown=function(t){this.updateSelection(t),this.gotoSlot(this.target.downFrom(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goHome=function(t){this.updateSelection(t),this.gotoSlot(this.target.startOfLine(this.slot)),this.updateSelection(t)},CursorMorph.prototype.goEnd=function(t){this.updateSelection(t),this.gotoSlot(this.target.endOfLine(this.slot)),this.updateSelection(t)},CursorMorph.prototype.gotoPos=function(t){this.gotoSlot(this.target.slotAt(t)),this.show()},CursorMorph.prototype.updateSelection=function(t){t?this.target.endMark||this.target.startMark?this.target.endMark!==this.slot&&(this.target.endMark=this.slot,this.target.drawNew(),this.target.changed()):(this.target.startMark=this.slot,this.target.endMark=this.slot):this.target.clearSelection()},CursorMorph.prototype.accept=function(){var t=this.root();t&&t.stopEditing(),this.escalateEvent("accept",this)},CursorMorph.prototype.cancel=function(){var t=this.root();this.undo(),t&&t.stopEditing(),this.escalateEvent("cancel",this)},CursorMorph.prototype.undo=function(){this.target.text=this.originalContents,this.target.changed(),this.target.drawNew(),this.target.changed(),this.gotoSlot(0)},CursorMorph.prototype.insert=function(t,e){var o;return"\t"===t?(this.target.escalateEvent("reactToEdit",this.target),e?this.target.backTab(this.target):this.target.tab(this.target)):void(this.target.isNumeric&&isNaN(parseFloat(t))&&!contains(["-","."],t)||(""!==this.target.selection()&&(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()),o=this.target.text,o=o.slice(0,this.slot)+t+o.slice(this.slot),this.target.text=o,this.target.drawNew(),this.target.changed(),this.goRight(!1,t.length)))},CursorMorph.prototype.ctrl=function(t,e){64===t||65===t&&e?this.insert("@"):65===t?this.target.selectAll():90===t?this.undo():123===t?this.insert("{"):125===t?this.insert("}"):91===t?this.insert("["):93===t?this.insert("]"):isNil(this.target.receiver)||(68===t?this.target.doIt():73===t?this.target.inspectIt():80===t&&this.target.showIt())},CursorMorph.prototype.cmd=function(t,e){64===t||65===t&&e?this.insert("@"):65===t?this.target.selectAll():90===t?this.undo():isNil(this.target.receiver)||(68===t?this.target.doIt():73===t?this.target.inspectIt():80===t&&this.target.showIt())},CursorMorph.prototype.deleteRight=function(){var t;""!==this.target.selection()?(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()):(t=this.target.text,this.target.changed(),t=t.slice(0,this.slot)+t.slice(this.slot+1),this.target.text=t,this.target.drawNew())},CursorMorph.prototype.deleteLeft=function(){var t;return this.target.selection()?(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()):(t=this.target.text,this.target.changed(),this.target.text=t.substring(0,this.slot-1)+t.substr(this.slot),this.target.drawNew(),void this.goLeft())},CursorMorph.prototype.destroy=function(){this.target.alignment!==this.originalAlignment&&(this.target.alignment=this.originalAlignment,this.target.drawNew(),this.target.changed()),this.destroyClipboardHandler(),CursorMorph.uber.destroy.call(this)},CursorMorph.prototype.destroyClipboardHandler=function(){var t,e,o=document.body.children;if(this.clipboardHandler)for(e=0;e<o.length;e+=1)t=o[e],t===this.clipboardHandler&&(document.body.removeChild(this.clipboardHandler),this.clipboardHandler=null)},CursorMorph.prototype.inspectKeyEvent=function(t){this.inform("Key pressed: "+String.fromCharCode(t.charCode)+"\n------------------------\ncharCode: "+t.charCode.toString()+"\nkeyCode: "+t.keyCode.toString()+"\nshiftKey: "+t.shiftKey.toString()+"\naltKey: "+t.altKey.toString()+"\nctrlKey: "+t.ctrlKey.toString()+"\ncmdKey: "+t.metaKey.toString())};var BoxMorph;BoxMorph.prototype=new Morph,BoxMorph.prototype.constructor=BoxMorph,BoxMorph.uber=Morph.prototype,BoxMorph.prototype.init=function(t,e,o){this.edge=t||4,this.border=e||(0===e?0:2),this.borderColor=o||new Color,BoxMorph.uber.init.call(this)},BoxMorph.prototype.drawNew=function(){var t;return this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),0===this.edge&&0===this.border?(BoxMorph.uber.drawNew.call(this),null):(t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),void(this.border>0&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke())))},BoxMorph.prototype.outlinePath=function(t,e,o){var r=e+o,i=this.width(),n=this.height();t.arc(r,r,e,radians(-180),radians(-90),!1),t.arc(i-r,r,e,radians(-90),radians(-0),!1),t.arc(i-r,n-r,e,radians(0),radians(90),!1),t.arc(r,n-r,e,radians(90),radians(180),!1)},BoxMorph.prototype.developersMenu=function(){var t=BoxMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("border width...",function(){this.prompt(t.title+"\nborder\nwidth:",this.setBorderWidth,this,this.border.toString(),null,0,100,!0)},"set the border's\nline size"),t.addItem("border color...",function(){this.pickColor(t.title+"\nborder color:",this.setBorderColor,this,this.borderColor)},"set the border's\nline color"),t.addItem("corner size...",function(){this.prompt(t.title+"\ncorner\nsize:",this.setCornerSize,this,this.edge.toString(),null,0,100,!0)},"set the corner's\nradius"),t},BoxMorph.prototype.setBorderWidth=function(t){var e;"number"==typeof t?this.border=Math.max(t,0):(e=parseFloat(t),isNaN(e)||(this.border=Math.max(e,0))),this.drawNew(),this.changed()},BoxMorph.prototype.setBorderColor=function(t){t&&(this.borderColor=t,this.drawNew(),this.changed())},BoxMorph.prototype.setCornerSize=function(t){var e;"number"==typeof t?this.edge=Math.max(t,0):(e=parseFloat(t),isNaN(e)||(this.edge=Math.max(e,0))),this.drawNew(),this.changed()},BoxMorph.prototype.colorSetters=function(){return["color","borderColor"]},BoxMorph.prototype.numericalSetters=function(){var t=BoxMorph.uber.numericalSetters.call(this);return t.push("setBorderWidth","setCornerSize"),t};var SpeechBubbleMorph;SpeechBubbleMorph.prototype=new BoxMorph,SpeechBubbleMorph.prototype.constructor=SpeechBubbleMorph,SpeechBubbleMorph.uber=BoxMorph.prototype,SpeechBubbleMorph.prototype.init=function(t,e,o,r,i,n,s){this.isPointingRight=!0,this.contents=t||"",this.padding=n||0,this.isThought=s||!1,this.isClickable=!1,SpeechBubbleMorph.uber.init.call(this,o||6,r||(0===r?0:1),i||new Color(140,140,140)),this.color=e||new Color(230,230,230),this.drawNew()},SpeechBubbleMorph.prototype.popUp=function(t,e,o){this.drawNew(),this.setPosition(e.subtract(new Point(0,this.height()))),this.addShadow(new Point(2,2),80),this.keepWithin(t),t.add(this),this.fullChanged(),t.hand.destroyTemporaries(),t.hand.temporaries.push(this),o?this.isClickable=!0:this.mouseEnter=function(){this.destroy()}},SpeechBubbleMorph.prototype.drawNew=function(){this.contentsMorph&&this.contentsMorph.destroy(),this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?this.contentsMorph=new TextMorph(this.contents,MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contentsMorph=new TextMorph(this.contents.toString(),MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"),this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))},SpeechBubbleMorph.prototype.outlinePath=function(t,e,o){function r(e,o,r){t.moveTo(e+r,o),t.arc(e,o,r,radians(0),radians(360))}var i,n=e+o,s=this.width(),a=this.height();t.arc(n,n,e,radians(-180),radians(-90),!1),t.arc(s-n,n,e,radians(-90),radians(-0),!1),t.arc(s-n,a-n-e,e,radians(0),radians(90),!1),this.isThought||(this.isPointingRight?(t.lineTo(n+e,a-n),t.lineTo(e/2+o,a-o)):(t.lineTo(s-(e/2+o),a-o),t.lineTo(s-(n+e),a-n))),t.arc(n,a-n-e,e,radians(90),radians(180),!1),this.isThought&&(t.lineTo(o,n),this.isPointingRight?(i=e/4,r(i+o,a-i-o,i),i=e/3.2,r(2*i+o,a-i-2*o,i),i=e/2.8,r(3*i+2*o,a-i-4*o,i)):(i=e/4,r(s-(i+o),a-i-o,i),i=e/3.2,r(s-(2*i+o),a-i-2*o,i),i=e/2.8,r(s-(3*i+2*o),a-i-4*o,i)))},SpeechBubbleMorph.prototype.shadowImage=function(t,e){var o,r,i,n,s,a=t||new Point(7,7),h=e||new Color(0,0,0);return o=this.extent(),r=this.image,i=newCanvas(o),s=i.getContext("2d"),s.drawImage(r,0,0),s.globalCompositeOperation="destination-out",s.drawImage(r,-a.x,-a.y),n=newCanvas(o),s=n.getContext("2d"),s.drawImage(i,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=h.toString(),s.fillRect(0,0,o.x,o.y),n},SpeechBubbleMorph.prototype.shadowImageBlurred=function(t,e){var o,r,i,n,s=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return o=this.extent().add(2*a),r=this.image,i=newCanvas(o),n=i.getContext("2d"),n.shadowOffsetX=s.x,n.shadowOffsetY=s.y,n.shadowBlur=a,n.shadowColor=h.toString(),n.drawImage(r,a-s.x,a-s.y),n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(r,a-s.x,a-s.y),i},SpeechBubbleMorph.prototype.fixLayout=function(){this.removeShadow(),this.drawNew(),this.addShadow(new Point(2,2),80)};var CircleBoxMorph;CircleBoxMorph.prototype=new Morph,CircleBoxMorph.prototype.constructor=CircleBoxMorph,CircleBoxMorph.uber=Morph.prototype,CircleBoxMorph.prototype.init=function(t){CircleBoxMorph.uber.init.call(this),this.orientation=t,this.autoOrient=!0,this.setExtent(new Point(20,100))},CircleBoxMorph.prototype.autoOrientation=function(){this.height()>this.width()?this.orientation="vertical":this.orientation="horizontal"},CircleBoxMorph.prototype.drawNew=function(){var t,e,o,r,i,n,s,a,h,l=this;this.autoOrient&&this.autoOrientation(),this.image=newCanvas(this.extent()),a=this.image.getContext("2d"),"vertical"===this.orientation?(t=this.width()/2,n=this.center().x,e=new Point(n,this.top()+t),o=new Point(n,this.bottom()-t),r=this.bounds.origin.add(new Point(0,t)).corner(this.bounds.corner.subtract(new Point(0,t)))):(t=this.height()/2,s=this.center().y,e=new Point(this.left()+t,s),o=new Point(this.right()-t,s),r=this.bounds.origin.add(new Point(t,0)).corner(this.bounds.corner.subtract(new Point(t,0)))),i=[e.subtract(this.bounds.origin),o.subtract(this.bounds.origin)],i.forEach(function(e){a.fillStyle=l.color.toString(),a.beginPath(),a.arc(e.x,e.y,t,0,2*Math.PI,!1),a.closePath(),a.fill()}),r=r.translateBy(this.bounds.origin.neg()),h=r.extent(),h.x>0&&h.y>0&&a.fillRect(r.origin.x,r.origin.y,r.width(),r.height())},CircleBoxMorph.prototype.developersMenu=function(){var t=CircleBoxMorph.uber.developersMenu.call(this);return t.addLine(),"vertical"===this.orientation?t.addItem("horizontal...","toggleOrientation","toggle the\norientation"):t.addItem("vertical...","toggleOrientation","toggle the\norientation"),t},CircleBoxMorph.prototype.toggleOrientation=function(){var t=this.center();this.changed(),"vertical"===this.orientation?this.orientation="horizontal":this.orientation="vertical",this.silentSetExtent(new Point(this.height(),this.width())),this.setCenter(t),this.drawNew(),this.changed()};var SliderButtonMorph;SliderButtonMorph.prototype=new CircleBoxMorph,SliderButtonMorph.prototype.constructor=SliderButtonMorph,SliderButtonMorph.uber=CircleBoxMorph.prototype,SliderButtonMorph.prototype.init=function(t){this.color=new Color(80,80,80),this.highlightColor=new Color(90,90,140),this.pressColor=new Color(80,80,160),this.is3D=!1,this.hasMiddleDip=!0,SliderButtonMorph.uber.init.call(this,t)},SliderButtonMorph.prototype.autoOrientation=function(){nop()},SliderButtonMorph.prototype.drawNew=function(){var t=this.color.copy();SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.normalImage=this.image,this.color=this.highlightColor.copy(),SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.highlightImage=this.image,this.color=this.pressColor.copy(),SliderButtonMorph.uber.drawNew.call(this),!this.is3D&&MorphicPreferences.isFlat||this.drawEdges(),this.pressImage=this.image,this.color=t,this.image=this.normalImage},SliderButtonMorph.prototype.drawEdges=function(){var t,e,o=this.image.getContext("2d"),r=this.width(),i=this.height();o.lineJoin="round",o.lineCap="round","vertical"===this.orientation?(o.lineWidth=r/3,t=o.createLinearGradient(0,0,o.lineWidth,0),t.addColorStop(0,"white"),t.addColorStop(1,this.color.toString()),o.strokeStyle=t,o.beginPath(),o.moveTo(.5*o.lineWidth,r/2),o.lineTo(.5*o.lineWidth,i-r/2),o.stroke(),t=o.createLinearGradient(r-o.lineWidth,0,r,0),t.addColorStop(0,this.color.toString()),t.addColorStop(1,"black"),o.strokeStyle=t,o.beginPath(),o.moveTo(r-.5*o.lineWidth,r/2),o.lineTo(r-.5*o.lineWidth,i-r/2),o.stroke(),this.hasMiddleDip&&(t=o.createLinearGradient(o.lineWidth,0,r-o.lineWidth,0),e=r/4,t.addColorStop(0,"black"),t.addColorStop(.35,this.color.toString()),t.addColorStop(.65,this.color.toString()),t.addColorStop(1,"white"),o.fillStyle=t,o.beginPath(),o.arc(r/2,i/2,e,radians(0),radians(360),!1),o.closePath(),o.fill())):"horizontal"===this.orientation&&(o.lineWidth=i/3,t=o.createLinearGradient(0,0,0,o.lineWidth),t.addColorStop(0,"white"),t.addColorStop(1,this.color.toString()),o.strokeStyle=t,o.beginPath(),o.moveTo(i/2,.5*o.lineWidth),o.lineTo(r-i/2,.5*o.lineWidth),o.stroke(),t=o.createLinearGradient(0,i-o.lineWidth,0,i),t.addColorStop(0,this.color.toString()),t.addColorStop(1,"black"),o.strokeStyle=t,o.beginPath(),o.moveTo(i/2,i-.5*o.lineWidth),o.lineTo(r-i/2,i-.5*o.lineWidth),o.stroke(),this.hasMiddleDip&&(t=o.createLinearGradient(0,o.lineWidth,0,i-o.lineWidth),e=i/4,t.addColorStop(0,"black"),t.addColorStop(.35,this.color.toString()),t.addColorStop(.65,this.color.toString()),t.addColorStop(1,"white"),o.fillStyle=t,o.beginPath(),o.arc(this.width()/2,this.height()/2,e,radians(0),radians(360),!1),o.closePath(),o.fill()))},SliderButtonMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},SliderButtonMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},SliderButtonMorph.prototype.mouseDownLeft=function(t){this.image=this.pressImage,this.changed(),this.escalateEvent("mouseDownLeft",t)},SliderButtonMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage,this.changed()},SliderButtonMorph.prototype.mouseMove=function(){nop()},SliderMorph.prototype=new CircleBoxMorph,SliderMorph.prototype.constructor=SliderMorph,SliderMorph.uber=CircleBoxMorph.prototype,SliderMorph.prototype.init=function(t,e,o,r,i,n){this.target=null,this.action=null,this.start=t,this.stop=e,this.value=o,this.size=r,this.offset=null,this.button=new SliderButtonMorph,this.button.isDraggable=!1,this.button.color=new Color(200,200,200),this.button.highlightColor=new Color(210,210,255),this.button.pressColor=new Color(180,180,255),SliderMorph.uber.init.call(this,i),this.add(this.button),this.alpha=.3,this.color=n||new Color(0,0,0),this.setExtent(new Point(20,100))},SliderMorph.prototype.autoOrientation=function(){nop()},SliderMorph.prototype.rangeSize=function(){return this.stop-this.start},SliderMorph.prototype.ratio=function(){return this.size/(this.rangeSize()+1)},SliderMorph.prototype.unitSize=function(){return"vertical"===this.orientation?(this.height()-this.button.height())/this.rangeSize():(this.width()-this.button.width())/this.rangeSize()},SliderMorph.prototype.drawNew=function(){var t,e,o,r;SliderMorph.uber.drawNew.call(this),this.button.orientation=this.orientation,"vertical"===this.orientation?(t=this.width()-2,e=Math.max(t,Math.round(this.height()*this.ratio())),this.button.silentSetExtent(new Point(t,e)),o=1,r=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height())):(e=this.height()-2,t=Math.max(e,Math.round(this.width()*this.ratio())),this.button.silentSetExtent(new Point(t,e)),r=1,o=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.width()-this.button.width())),this.button.setPosition(new Point(o,r).add(this.bounds.origin)),this.button.drawNew(),this.button.changed()},SliderMorph.prototype.updateValue=function(){var t;t="vertical"===this.orientation?this.button.top()-this.top():this.button.left()-this.left(),this.value=Math.round(t/this.unitSize()+this.start),this.updateTarget()},SliderMorph.prototype.updateTarget=function(){this.action&&("function"==typeof this.action?this.action.call(this.target,this.value):this.target[this.action](this.value))},SliderMorph.prototype.developersMenu=function(){var t=SliderMorph.uber.developersMenu.call(this);return t.addItem("show value...","showValue","display a dialog box\nshowing the selected number"),t.addItem("floor...",function(){this.prompt(t.title+"\nfloor:",this.setStart,this,this.start.toString(),null,0,this.stop-this.size,!0)},"set the minimum value\nwhich can be selected"),t.addItem("ceiling...",function(){this.prompt(t.title+"\nceiling:",this.setStop,this,this.stop.toString(),null,this.start+this.size,100*this.size,!0)},"set the maximum value\nwhich can be selected"),t.addItem("button size...",function(){this.prompt(t.title+"\nbutton size:",this.setSize,this,this.size.toString(),null,1,this.stop-this.start,!0)},"set the range\ncovered by\nthe slider button"),t.addLine(),t.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one"),t},SliderMorph.prototype.showValue=function(){this.inform(this.value)},SliderMorph.prototype.userSetStart=function(t){this.start=Math.max(t,this.stop)},SliderMorph.prototype.setStart=function(t,e){var o;"number"==typeof t?this.start=Math.min(t,this.stop-this.size):(o=parseFloat(t),isNaN(o)||(this.start=Math.min(o,this.stop-this.size))),this.value=Math.max(this.value,this.start),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setStop=function(t,e){var o;"number"==typeof t?this.stop=Math.max(t,this.start+this.size):(o=parseFloat(t),isNaN(o)||(this.stop=Math.max(o,this.start+this.size))),this.value=Math.min(this.value,this.stop),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setSize=function(t,e){var o;"number"==typeof t?this.size=Math.min(Math.max(t,1),this.stop-this.start):(o=parseFloat(t),isNaN(o)||(this.size=Math.min(Math.max(o,1),this.stop-this.start))),this.value=Math.min(this.value,this.stop-this.size),e||this.updateTarget(),this.drawNew(),this.changed()},SliderMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:"),o=this;t.push(this.world()),t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){o.target=t,o.setTargetSetter()})}),1===t.length?(this.target=t[0],this.setTargetSetter()):t.length>0&&e.popUpAtHand(this.world())},SliderMorph.prototype.setTargetSetter=function(){var t=this.target.numericalSetters(),e=new MenuMorph(this,"choose target property:"),o=this;t.forEach(function(t){e.addItem(t,function(){o.action=t})}),1===t.length?this.action=t[0]:t.length>0&&e.popUpAtHand(this.world())},SliderMorph.prototype.numericalSetters=function(){var t=SliderMorph.uber.numericalSetters.call(this);return t.push("setStart","setStop","setSize"),t},SliderMorph.prototype.step=null,SliderMorph.prototype.mouseDownLeft=function(t){var e,o=this;this.button.bounds.containsPoint(t)?this.offset=t.subtract(this.button.bounds.origin):this.offset=new Point,e=this.root(),this.step=function(){var t,r,i;e.hand.mouseButton?(t=e.hand.bounds.origin,"vertical"===o.orientation?(r=o.button.bounds.origin.x,i=Math.max(Math.min(t.y-o.offset.y,o.bottom()-o.button.height()),o.top())):(i=o.button.bounds.origin.y,r=Math.max(Math.min(t.x-o.offset.x,o.right()-o.button.width()),o.left())),o.button.setPosition(new Point(r,i)),o.updateValue()):this.step=null}};var MouseSensorMorph;MouseSensorMorph.prototype=new BoxMorph,MouseSensorMorph.prototype.constructor=MouseSensorMorph,MouseSensorMorph.uber=BoxMorph.prototype,MouseSensorMorph.prototype.init=function(t,e,o){MouseSensorMorph.uber.init.call(this),this.edge=t||4,this.border=e||2,this.color=new Color(255,255,255),this.borderColor=o||new Color,this.isTouched=!1,this.upStep=.05,this.downStep=.02,this.noticesTransparentClick=!1,this.drawNew()},MouseSensorMorph.prototype.touch=function(){var t=this;this.isTouched||(this.isTouched=!0,this.alpha=.6,this.step=function(){t.isTouched?t.alpha<1&&(t.alpha=t.alpha+t.upStep):t.alpha>t.downStep?t.alpha=t.alpha-t.downStep:(t.alpha=0,t.step=null),t.changed()})},MouseSensorMorph.prototype.unTouch=function(){this.isTouched=!1},MouseSensorMorph.prototype.mouseEnter=function(){this.touch()},MouseSensorMorph.prototype.mouseLeave=function(){this.unTouch()},MouseSensorMorph.prototype.mouseDownLeft=function(){this.touch()},MouseSensorMorph.prototype.mouseClickLeft=function(){this.unTouch()};var ListMorph,TriggerMorph;InspectorMorph.prototype=new BoxMorph,InspectorMorph.prototype.constructor=InspectorMorph,InspectorMorph.uber=BoxMorph.prototype,InspectorMorph.prototype.init=function(t){this.target=t,this.currentProperty=null,this.showing="attributes",this.markOwnProperties=!1,this.hasUserEditedDetails=!1,InspectorMorph.uber.init.call(this),this.silentSetExtent(new Point(20*MorphicPreferences.handleSize,20*MorphicPreferences.handleSize*2/3)),this.isDraggable=!0,this.border=1,this.edge=MorphicPreferences.isFlat?1:5,this.color=new Color(60,60,60),this.borderColor=new Color(95,95,95),this.fps=25,this.drawNew(),this.label=null,this.list=null,this.detail=null,this.work=null,this.buttonInspect=null,this.buttonClose=null,this.buttonSubset=null,this.buttonEdit=null,this.resizer=null,this.target&&this.buildPanes()},InspectorMorph.prototype.setTarget=function(t){this.target=t,this.currentProperty=null,this.buildPanes()},InspectorMorph.prototype.updateCurrentSelection=function(){var t,e,o,r=this.list.selected,i=this.detail.contents.children[0],n=this.root();return n&&n.keyboardReceiver instanceof CursorMorph&&n.keyboardReceiver.target===i?void(this.hasUserEditedDetails=!0):void(isNil(r)||this.hasUserEditedDetails||(t=this.target[r],this.currentProperty=t,e=isNil(t)?"NULL":isString(t)?t:t.toString(),i.text!==e&&(o=new TextMorph(e),o.isEditable=!0,o.enableSelecting(),o.setReceiver(this.target),this.detail.setContents(o))))},InspectorMorph.prototype.buildPanes=function(){var t,e,o,r,i=[],n=this;this.children.forEach(function(t){t!==this.work&&t.destroy()}),this.children=[],this.label=new TextMorph(this.target.toString()),this.label.fontSize=MorphicPreferences.menuFontSize,this.label.isBold=!0,this.label.color=new Color(255,255,255),this.label.drawNew(),this.add(this.label);for(t in this.target)t&&i.push(t);"attributes"===this.showing?i=i.filter(function(t){return"function"!=typeof n.target[t]}):"methods"===this.showing&&(i=i.filter(function(t){return"function"==typeof n.target[t]})),r=function(){var t,e;isObject(n.currentProperty)&&(t=n.world(),e=new InspectorMorph(n.currentProperty),e.setPosition(t.hand.position()),e.keepWithin(t),t.add(e),e.changed())},this.list=new ListMorph(this.target instanceof Array?i:i.sort(),null,this.markOwnProperties?[[new Color(0,0,180),function(t){return Object.prototype.hasOwnProperty.call(n.target,t)}]]:null,r),this.list.action=function(){n.hasUserEditedDetails=!1,n.updateCurrentSelection()},this.list.hBar.alpha=.6,this.list.vBar.alpha=.6,this.list.contents.step=null,this.add(this.list),this.detail=new ScrollFrameMorph,this.detail.acceptsDrops=!1,this.detail.contents.acceptsDrops=!1,this.detail.isTextLineWrapping=!0,this.detail.color=new Color(255,255,255),this.detail.hBar.alpha=.6,this.detail.vBar.alpha=.6,e=new TextMorph(""),e.isEditable=!0,e.enableSelecting(),e.setReceiver(this.target),this.detail.setContents(e),this.add(this.detail),null===this.work&&(this.work=new ScrollFrameMorph,this.work.acceptsDrops=!1,this.work.contents.acceptsDrops=!1,this.work.isTextLineWrapping=!0,this.work.color=new Color(255,255,255),this.work.hBar.alpha=.6,this.work.vBar.alpha=.6,o=new TextMorph(""),o.isEditable=!0,o.enableSelecting(),o.setReceiver(this.target),this.work.setContents(o)),this.add(this.work),this.buttonSubset=new TriggerMorph,this.buttonSubset.labelString="show...",this.buttonSubset.action=function(){var t;t=new MenuMorph,t.addItem("attributes",function(){n.showing="attributes",n.buildPanes()}),t.addItem("methods",function(){n.showing="methods",n.buildPanes()}),t.addItem("all",function(){n.showing="all",n.buildPanes()}),t.addLine(),t.addItem(n.markOwnProperties?"un-mark own":"mark own",function(){n.markOwnProperties=!n.markOwnProperties,n.buildPanes()},"highlight\n'own' properties"),t.popUpAtHand(n.world())},this.add(this.buttonSubset),this.buttonInspect=new TriggerMorph,this.buttonInspect.labelString="inspect...",this.buttonInspect.action=function(){var t,e,o;isObject(n.currentProperty)?(t=new MenuMorph,t.addItem("in new inspector...",function(){e=n.world(),o=new InspectorMorph(n.currentProperty),o.setPosition(e.hand.position()),o.keepWithin(e),e.add(o),o.changed()}),t.addItem("here...",function(){n.setTarget(n.currentProperty)}),t.popUpAtHand(n.world())):n.inform((null===n.currentProperty?"null":typeof n.currentProperty)+"\nis not inspectable")},this.add(this.buttonInspect),this.buttonEdit=new TriggerMorph,this.buttonEdit.labelString="edit...",this.buttonEdit.action=function(){var t;t=new MenuMorph(n),t.addItem("save","save","accept changes"),t.addLine(),t.addItem("add property...","addProperty"),t.addItem("rename...","renameProperty"),t.addItem("remove...","removeProperty"),t.popUpAtHand(n.world())},this.add(this.buttonEdit),this.buttonClose=new TriggerMorph,this.buttonClose.labelString="close",this.buttonClose.action=function(){n.destroy()},this.add(this.buttonClose),this.resizer=new HandleMorph(this,150,100,this.edge,this.edge),this.fixLayout()},InspectorMorph.prototype.fixLayout=function(){var t,e,o,r,i,n;Morph.prototype.trackChanges=!1,t=this.left()+this.edge,e=this.top()+this.edge,o=this.right()-this.edge,i=o-t,this.label.setPosition(new Point(t,e)),this.label.setWidth(i),this.label.height()>this.height()-50&&(this.silentSetHeight(this.label.height()+50),this.drawNew(),this.changed(),this.resizer.drawNew()),e=this.label.bottom()+2,i=Math.min(Math.floor(this.width()/3),this.list.listContents.width()),i-=this.edge,r=this.bottom()-2*this.edge-MorphicPreferences.handleSize,n=r-e,this.list.setPosition(new Point(t,e)),this.list.setExtent(new Point(i,n)),t=this.list.right()+this.edge,o=this.right()-this.edge,i=o-t,this.detail.setPosition(new Point(t,e)),this.detail.setExtent(new Point(i,2*n/3-this.edge)),e=this.detail.bottom()+this.edge,this.work.setPosition(new Point(t,e)),this.work.setExtent(new Point(i,n/3)),t=this.list.left(),e=this.list.bottom()+this.edge,i=this.list.width(),n=MorphicPreferences.handleSize,this.buttonSubset.setPosition(new Point(t,e)),this.buttonSubset.setExtent(new Point(i,n)),t=this.detail.left(),i=this.detail.width()-this.edge-MorphicPreferences.handleSize,i=i/3-this.edge/3,this.buttonInspect.setPosition(new Point(t,e)),this.buttonInspect.setExtent(new Point(i,n)),t=this.buttonInspect.right()+this.edge,this.buttonEdit.setPosition(new Point(t,e)),this.buttonEdit.setExtent(new Point(i,n)),t=this.buttonEdit.right()+this.edge,o=this.detail.right()-this.edge-MorphicPreferences.handleSize,i=o-t,this.buttonClose.setPosition(new Point(t,e)),this.buttonClose.setExtent(new Point(i,n)),Morph.prototype.trackChanges=!0,this.changed()},InspectorMorph.prototype.setExtent=function(t){InspectorMorph.uber.setExtent.call(this,t),
this.fixLayout()},InspectorMorph.prototype.save=function(){var t=this.detail.contents.children[0].text.toString(),e=this.list.selected;try{this.target.evaluateString("this."+e+" = "+t),this.hasUserEditedDetails=!1,this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(t){this.inform(t)}},InspectorMorph.prototype.addProperty=function(){var t=this;this.prompt("new property name:",function(e){e&&(t.target[e]=null,t.buildPanes(),t.target.drawNew&&(t.target.changed(),t.target.drawNew(),t.target.changed()))},this,"property")},InspectorMorph.prototype.renameProperty=function(){var t=this,e=this.list.selected;this.prompt("property name:",function(o){try{delete t.target[e],t.target[o]=t.currentProperty}catch(e){t.inform(e)}t.buildPanes(),t.target.drawNew&&(t.target.changed(),t.target.drawNew(),t.target.changed())},this,e)},InspectorMorph.prototype.removeProperty=function(){var t=this.list.selected;try{delete this.target[t],this.currentProperty=null,this.buildPanes(),this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(t){this.inform(t)}},InspectorMorph.prototype.step=function(){this.updateCurrentSelection();var t=this.target.toString();this.label.text!==t&&(this.label.text=t,this.label.drawNew(),this.fixLayout())},InspectorMorph.prototype.updateReferences=function(t){var e=this.list.activeIndex();InspectorMorph.uber.updateReferences.call(this,t),this.buildPanes(),this.list.activateIndex(e)};var MenuItemMorph;MenuMorph.prototype=new BoxMorph,MenuMorph.prototype.constructor=MenuMorph,MenuMorph.uber=BoxMorph.prototype,MenuMorph.prototype.init=function(t,e,o,r){this.target=t,this.title=e||null,this.environment=o||null,this.fontSize=r||null,this.items=[],this.label=null,this.world=null,this.isListContents=!1,this.hasFocus=!1,this.selection=null,MenuMorph.uber.init.call(this),this.isDraggable=!1,this.border=null,this.edge=null},MenuMorph.prototype.addItem=function(t,e,o,r,i,n,s){this.items.push([localize(t||"close"),e||nop,o,r,i||!1,n||!1,s])},MenuMorph.prototype.addLine=function(t){this.items.push([0,t||1])},MenuMorph.prototype.createLabel=function(){var t;null!==this.label&&this.label.destroy(),t=new TextMorph(localize(this.title),this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,!0,!1,"center"),t.alignment="center",t.color=new Color(255,255,255),t.backgroundColor=this.borderColor,t.drawNew(),this.label=new BoxMorph(3,0),MorphicPreferences.isFlat&&(this.label.edge=0),this.label.color=this.borderColor,this.label.borderColor=this.borderColor,this.label.setExtent(t.extent().add(4)),this.label.drawNew(),this.label.add(t),this.label.text=t},MenuMorph.prototype.drawNew=function(){var t,e,o,r,i=this,n=!1;this.children.forEach(function(t){t.destroy()}),this.children=[],this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2),this.color=new Color(255,255,255),this.borderColor=new Color(60,60,60),this.silentSetExtent(new Point(0,0)),r=2,o=this.left()+4,this.isListContents||(this.title?(this.createLabel(),this.label.setPosition(this.bounds.origin.add(4)),this.add(this.label),r=this.label.bottom()):r=this.top()+4),r+=1,this.items.forEach(function(e){n=!1,e instanceof StringFieldMorph||e instanceof ColorPickerMorph||e instanceof SliderMorph?t=e:0===e[0]?(n=!0,t=new Morph,t.color=i.borderColor,t.setHeight(e[1])):t=new MenuItemMorph(i.target,e[1],e[0],i.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,i.environment,e[2],e[3],e[4],e[5],e[6]),n&&(r+=1),t.setPosition(new Point(o,r)),i.add(t),r+=t.height(),n&&(r+=1)}),e=this.fullBounds(),this.silentSetExtent(e.extent().add(4)),this.adjustWidths(),MenuMorph.uber.drawNew.call(this)},MenuMorph.prototype.maxWidth=function(){var t=0;return this.parent instanceof FrameMorph&&this.parent.scrollFrame instanceof ScrollFrameMorph&&(t=this.parent.scrollFrame.width()),this.children.forEach(function(e){e instanceof MenuItemMorph?t=Math.max(t,e.children[0].width()+8):(e instanceof StringFieldMorph||e instanceof ColorPickerMorph||e instanceof SliderMorph)&&(t=Math.max(t,e.width()))}),this.label&&(t=Math.max(t,this.label.width())),t},MenuMorph.prototype.adjustWidths=function(){var t,e=this.maxWidth(),o=this;this.children.forEach(function(r){r.silentSetWidth(e),r instanceof MenuItemMorph?(t=r.image===r.pressImage,r.createBackgrounds(),t&&(r.image=r.pressImage)):(r.drawNew(),r===o.label&&r.text.setPosition(r.center().subtract(r.text.extent().floorDivideBy(2))))})},MenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(t){t instanceof MenuItemMorph&&(t.image=t.normalImage)}),this.changed()},MenuMorph.prototype.popup=function(t,e){this.drawNew(),this.setPosition(e),this.addShadow(new Point(2,2),80),this.keepWithin(t),t.activeMenu&&t.activeMenu.destroy(),this.items.length<1&&!this.title||(t.add(this),t.activeMenu=this,this.world=t,this.fullChanged())},MenuMorph.prototype.popUpAtHand=function(t){var e=t||this.world;this.popup(e,e.hand.position())},MenuMorph.prototype.popUpCenteredAtHand=function(t){var e=t||this.world;this.drawNew(),this.popup(e,e.hand.position().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.popUpCenteredInWorld=function(t){var e=t||this.world;this.drawNew(),this.popup(e,e.center().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.getFocus=function(){this.world.keyboardReceiver=this,this.selection=null,this.selectFirst(),this.hasFocus=!0},MenuMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:case 32:return void(this.selection&&this.selection.mouseClickLeft());case 27:return this.destroy();case 38:return this.selectUp();case 40:return this.selectDown();default:nop()}},MenuMorph.prototype.processKeyUp=function(t){nop(t)},MenuMorph.prototype.processKeyPress=function(t){nop(t)},MenuMorph.prototype.selectFirst=function(){var t;for(t=0;t<this.children.length;t+=1)if(this.children[t]instanceof MenuItemMorph)return void this.select(this.children[t])},MenuMorph.prototype.selectUp=function(){var t,e;return t=this.children.filter(function(t){return t instanceof MenuItemMorph}),this.selection?(e=t.indexOf(this.selection)-1,e<0&&(e=t.length-1),void this.select(t[e])):void(t.length&&this.select(t[0]))},MenuMorph.prototype.selectDown=function(){var t,e;return t=this.children.filter(function(t){return t instanceof MenuItemMorph}),this.selection?(e=t.indexOf(this.selection)+1,e>=t.length&&(e=0),void this.select(t[e])):void(t.length&&this.select(t[0]))},MenuMorph.prototype.select=function(t){this.unselectAllItems(),t.image=t.highlightImage,t.changed(),this.selection=t},MenuMorph.prototype.destroy=function(){this.hasFocus&&(this.world.keyboardReceiver=null),MenuMorph.uber.destroy.call(this)},StringMorph.prototype=new Morph,StringMorph.prototype.constructor=StringMorph,StringMorph.uber=Morph.prototype,StringMorph.prototype.init=function(t,e,o,r,i,n,s,a,h,l){this.text=t||(""===t?"":"StringMorph"),this.fontSize=e||12,this.fontName=l||MorphicPreferences.globalFontFamily,this.fontStyle=o||"sans-serif",this.isBold=r||!1,this.isItalic=i||!1,this.isEditable=!1,this.isNumeric=n||!1,this.isPassword=!1,this.shadowOffset=s||new Point(0,0),this.shadowColor=a||null,this.isShowingBlanks=!1,this.blanksColor=new Color(180,140,140),this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=new Color(255,255,255),this.markedBackgoundColor=new Color(60,60,120),StringMorph.uber.init.call(this,!0),this.color=h||new Color(0,0,0),this.noticesTransparentClick=!0,this.drawNew()},StringMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'},StringMorph.prototype.password=function(t,e){var o,r="";for(o=0;o<e;o+=1)r+=t;return r},StringMorph.prototype.font=function(){var t="";return this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+this.fontSize+"px "+(this.fontName?this.fontName+", ":"")+this.fontStyle},StringMorph.prototype.drawNew=function(){var t,e,o,r,i,n,s,a,h,l=this.shadowOffset||new Point,p=this.isPassword?this.password("*",this.text.length):this.text;for(this.image=newCanvas(),t=this.image.getContext("2d"),t.font=this.font(),e=Math.max(t.measureText(p).width+Math.abs(l.x),1),this.bounds.corner=this.bounds.origin.add(new Point(e,fontHeight(this.fontSize)+Math.abs(l.y))),this.image.width=e,this.image.height=this.height(),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.shadowColor&&(a=Math.max(l.x,0),h=Math.max(l.y,0),t.fillStyle=this.shadowColor.toString(),t.fillText(p,a,fontHeight(this.fontSize)+h)),a=Math.abs(Math.min(l.x,0)),h=Math.abs(Math.min(l.y,0)),t.fillStyle=this.color.toString(),this.isShowingBlanks?this.renderWithBlanks(t,a,fontHeight(this.fontSize)+h):t.fillText(p,a,fontHeight(this.fontSize)+h),o=Math.min(this.startMark,this.endMark),r=Math.max(this.startMark,this.endMark),i=o;i<r;i+=1)n=this.slotPosition(i).subtract(this.position()),s=p.charAt(i),t.fillStyle=this.markedBackgoundColor.toString(),t.fillRect(n.x,n.y,t.measureText(s).width+1+a,fontHeight(this.fontSize)+h),t.fillStyle=this.markedTextColor.toString(),t.fillText(s,n.x+a,fontHeight(this.fontSize)+h);this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},StringMorph.prototype.renderWithBlanks=function(t,e,o){function r(){t.drawImage(n,h,0),h+=i}var i=t.measureText(" ").width,n=newCanvas(new Point(i,this.height())),s=n.getContext("2d"),a=this.text.split(" "),h=e||0,l=!0;s.fillStyle=this.blanksColor.toString(),s.arc(i/2,n.height/2,i/2,radians(0),radians(360)),s.fill(),a.forEach(function(e){l||r(),l=!1,""!==e&&(t.fillText(e,h,o),h+=t.measureText(e).width)})},StringMorph.prototype.slotPosition=function(t){var e,o,r,i,n=this.isPassword?this.password("*",this.text.length):this.text,s=Math.min(Math.max(t,0),n.length),a=this.image.getContext("2d");for(e=0,i=0;i<s;i+=1)e+=a.measureText(n[i]).width;return this.pos=s,o=this.left()+e,r=this.top(),new Point(o,r)},StringMorph.prototype.slotAt=function(t){for(var e=this.isPassword?this.password("*",this.text.length):this.text,o=0,r=0,i=this.image.getContext("2d");t.x-this.left()>r;)if(r+=i.measureText(e[o]).width,o+=1,o===e.length&&i.measureText(e).width-i.measureText(e[o-1]).width/2<t.x-this.left())return o;return o-1},StringMorph.prototype.upFrom=function(t){return t},StringMorph.prototype.downFrom=function(t){return t},StringMorph.prototype.startOfLine=function(){return 0},StringMorph.prototype.endOfLine=function(){return this.text.length},StringMorph.prototype.rawHeight=function(){return this.height()/1.2},StringMorph.prototype.developersMenu=function(){var t=StringMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("edit","edit"),t.addItem("font size...",function(){this.prompt(t.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,500,!0)},"set this String's\nfont point size"),"serif"!==this.fontStyle&&t.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&t.addItem("sans-serif","setSansSerif"),this.isBold?t.addItem("normal weight","toggleWeight"):t.addItem("bold","toggleWeight"),this.isItalic?t.addItem("normal style","toggleItalic"):t.addItem("italic","toggleItalic"),this.isShowingBlanks?t.addItem("hide blanks","toggleShowBlanks"):t.addItem("show blanks","toggleShowBlanks"),this.isPassword?t.addItem("show characters","toggleIsPassword"):t.addItem("hide characters","toggleIsPassword"),t},StringMorph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable,this.isDraggable?this.disableSelecting():this.enableSelecting()},StringMorph.prototype.toggleShowBlanks=function(){this.isShowingBlanks=!this.isShowingBlanks,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.toggleIsPassword=function(){this.isPassword=!this.isPassword,this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setSerif=function(){this.fontStyle="serif",this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif",this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setFontSize=function(t){var e;"number"==typeof t?this.fontSize=Math.round(Math.min(Math.max(t,4),500)):(e=parseFloat(t),isNaN(e)||(this.fontSize=Math.round(Math.min(Math.max(e,4),500)))),this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.setText=function(t){this.text=Math.round(t).toString(),this.changed(),this.drawNew(),this.changed()},StringMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]},StringMorph.prototype.edit=function(){this.root().edit(this)},StringMorph.prototype.selection=function(){var t,e;return t=Math.min(this.startMark,this.endMark),e=Math.max(this.startMark,this.endMark),this.text.slice(t,e)},StringMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)},StringMorph.prototype.clearSelection=function(){(this.currentlySelecting||0!==this.startMark||0!==this.endMark)&&(this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.drawNew(),this.changed())},StringMorph.prototype.deleteSelection=function(){var t,e,o;o=this.text,t=Math.min(this.startMark,this.endMark),e=Math.max(this.startMark,this.endMark),this.text=o.slice(0,t)+o.slice(e),this.changed(),this.clearSelection()},StringMorph.prototype.selectAll=function(){this.isEditable&&(this.startMark=0,this.endMark=this.text.length,this.drawNew(),this.changed())},StringMorph.prototype.mouseDownLeft=function(t){this.isEditable?this.clearSelection():this.escalateEvent("mouseDownLeft",t)},StringMorph.prototype.mouseClickLeft=function(t){var e;this.isEditable?(this.currentlySelecting||this.edit(),e=this.root().cursor,e&&e.gotoPos(t),this.currentlySelecting=!0):this.escalateEvent("mouseClickLeft",t)},StringMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(t){var e=this.root().cursor,o=!!e&&e.target===this;this.clearSelection(),this.isEditable&&!this.isDraggable&&(this.edit(),this.root().cursor.gotoPos(t),this.startMark=this.slotAt(t),this.endMark=this.startMark,this.currentlySelecting=!0,o||this.escalateEvent("mouseDownLeft",t))},this.mouseMove=function(t){if(this.isEditable&&this.currentlySelecting&&!this.isDraggable){var e=this.slotAt(t);e!==this.endMark&&(this.endMark=e,this.drawNew(),this.changed())}}},StringMorph.prototype.disableSelecting=function(){this.mouseDownLeft=StringMorph.prototype.mouseDownLeft,delete this.mouseMove},TextMorph.prototype=new Morph,TextMorph.prototype.constructor=TextMorph,TextMorph.uber=Morph.prototype,TextMorph.prototype.init=function(t,e,o,r,i,n,s,a,h,l){this.text=t||(""===t?t:"TextMorph"),this.words=[],this.lines=[],this.lineSlots=[],this.fontSize=e||12,this.fontName=a||MorphicPreferences.globalFontFamily,this.fontStyle=o||"sans-serif",this.isBold=r||!1,this.isItalic=i||!1,this.alignment=n||"left",this.shadowOffset=h||new Point(0,0),this.shadowColor=l||null,this.maxWidth=s||0,this.maxLineWidth=0,this.backgroundColor=null,this.isEditable=!1,this.receiver=null,this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=new Color(255,255,255),this.markedBackgoundColor=new Color(60,60,120),TextMorph.uber.init.call(this),this.color=new Color(0,0,0),this.noticesTransparentClick=!0,this.drawNew()},TextMorph.prototype.toString=function(){return'a TextMorph("'+this.text.slice(0,30)+'...")'},TextMorph.prototype.font=StringMorph.prototype.font,TextMorph.prototype.parse=function(){var t,e,o=this,r=this.text.split("\n"),i=newCanvas(),n=i.getContext("2d"),s="",a=0;n.font=this.font(),this.maxLineWidth=0,this.lines=[],this.lineSlots=[0],this.words=[],r.forEach(function(t){o.words=o.words.concat(t.split(" ")),o.words.push("\n")}),this.words.forEach(function(r){"\n"===r?(o.lines.push(s),o.lineSlots.push(a),o.maxLineWidth=Math.max(o.maxLineWidth,n.measureText(s).width),s=""):(o.maxWidth>0?(t=s+r+" ",e=n.measureText(t).width,e>o.maxWidth?(o.lines.push(s),o.lineSlots.push(a),o.maxLineWidth=Math.max(o.maxLineWidth,n.measureText(s).width),s=r+" "):s=t):s=s+r+" ",a+=r.length+1)})},TextMorph.prototype.drawNew=function(){var t,e,o,r,i,n,s,a,h,l,p,c,d,u,g;if(this.image=newCanvas(),t=this.image.getContext("2d"),t.font=this.font(),this.parse(),s=Math.abs(this.shadowOffset.x),n=Math.abs(this.shadowOffset.y),e=this.lines.length*(fontHeight(this.fontSize)+n),0===this.maxWidth?this.bounds=this.bounds.origin.extent(new Point(this.maxLineWidth+s,e)):this.bounds=this.bounds.origin.extent(new Point(this.maxWidth+s,e)),this.image.width=this.width(),this.image.height=this.height(),t=this.image.getContext("2d"),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.backgroundColor&&(t.fillStyle=this.backgroundColor.toString(),t.fillRect(0,0,this.width(),this.height())),this.shadowColor)for(a=Math.max(this.shadowOffset.x,0),h=Math.max(this.shadowOffset.y,0),t.fillStyle=this.shadowColor.toString(),o=0;o<this.lines.length;o+=1)r=this.lines[o],i=t.measureText(r).width+s,l="right"===this.alignment?this.width()-i:"center"===this.alignment?(this.width()-i)/2:0,p=(o+1)*(fontHeight(this.fontSize)+n)-n,t.fillText(r,l+a,p+h);for(a=Math.abs(Math.min(this.shadowOffset.x,0)),h=Math.abs(Math.min(this.shadowOffset.y,0)),t.fillStyle=this.color.toString(),o=0;o<this.lines.length;o+=1)r=this.lines[o],i=t.measureText(r).width+s,l="right"===this.alignment?this.width()-i:"center"===this.alignment?(this.width()-i)/2:0,p=(o+1)*(fontHeight(this.fontSize)+n)-n,t.fillText(r,l+a,p+h);for(c=Math.min(this.startMark,this.endMark),d=Math.max(this.startMark,this.endMark),o=c;o<d;o+=1)u=this.slotPosition(o).subtract(this.position()),g=this.text.charAt(o),t.fillStyle=this.markedBackgoundColor.toString(),t.fillRect(u.x,u.y,t.measureText(g).width+1,fontHeight(this.fontSize)),t.fillStyle=this.markedTextColor.toString(),t.fillText(g,u.x,u.y+fontHeight(this.fontSize));this.parent&&this.parent.layoutChanged&&this.parent.layoutChanged()},TextMorph.prototype.setExtent=function(t){this.maxWidth=Math.max(t.x,0),this.changed(),this.drawNew()},TextMorph.prototype.columnRow=function(t){var e,o,r=0;for(e=0;e<this.lines.length;e+=1)for(r=this.lineSlots[e],o=0;o<this.lines[e].length;o+=1){if(r===t)return new Point(o,e);r+=1}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)},TextMorph.prototype.slotPosition=function(t){var e,o,r,i,n=this.columnRow(t),s=this.image.getContext("2d"),a=Math.abs(this.shadowOffset.y),h=0;for(e=n.y*(fontHeight(this.fontSize)+a),i=0;i<n.x;i+=1)h+=s.measureText(this.lines[n.y][i]).width;return o=this.left()+h,r=this.top()+e,new Point(o,r)},TextMorph.prototype.slotAt=function(t){for(var e=0,o=0,r=0,i=Math.abs(this.shadowOffset.y),n=this.image.getContext("2d");t.y-this.top()>(fontHeight(this.fontSize)+i)*o;)o+=1;for(o=Math.max(o,1);t.x-this.left()>e;)e+=n.measureText(this.lines[o-1][r]).width,r+=1;return this.lineSlots[Math.max(o-1,0)]+r-1},TextMorph.prototype.upFrom=function(t){var e,o=this.columnRow(t);return o.y<1?t:(e=this.lines[o.y-1],e.length<o.x-1?this.lineSlots[o.y-1]+e.length:this.lineSlots[o.y-1]+o.x)},TextMorph.prototype.downFrom=function(t){var e,o=this.columnRow(t);return o.y>this.lines.length-2?t:(e=this.lines[o.y+1],e.length<o.x-1?this.lineSlots[o.y+1]+e.length:this.lineSlots[o.y+1]+o.x)},TextMorph.prototype.startOfLine=function(t){return this.lineSlots[this.columnRow(t).y]},TextMorph.prototype.endOfLine=function(t){return this.startOfLine(t)+this.lines[this.columnRow(t).y].length-1},TextMorph.prototype.edit=StringMorph.prototype.edit,TextMorph.prototype.selection=StringMorph.prototype.selection,TextMorph.prototype.selectionStartSlot=StringMorph.prototype.selectionStartSlot,TextMorph.prototype.clearSelection=StringMorph.prototype.clearSelection,TextMorph.prototype.deleteSelection=StringMorph.prototype.deleteSelection,TextMorph.prototype.selectAll=StringMorph.prototype.selectAll,TextMorph.prototype.mouseDownLeft=StringMorph.prototype.mouseDownLeft,TextMorph.prototype.mouseClickLeft=StringMorph.prototype.mouseClickLeft,TextMorph.prototype.enableSelecting=StringMorph.prototype.enableSelecting,TextMorph.prototype.disableSelecting=StringMorph.prototype.disableSelecting,TextMorph.prototype.selectAllAndEdit=function(){this.edit(),this.selectAll()},TextMorph.prototype.developersMenu=function(){var t=TextMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("edit","edit"),t.addItem("font size...",function(){this.prompt(t.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,100,!0)},"set this Text's\nfont point size"),"left"!==this.alignment&&t.addItem("align left","setAlignmentToLeft"),"right"!==this.alignment&&t.addItem("align right","setAlignmentToRight"),"center"!==this.alignment&&t.addItem("align center","setAlignmentToCenter"),t.addLine(),"serif"!==this.fontStyle&&t.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&t.addItem("sans-serif","setSansSerif"),this.isBold?t.addItem("normal weight","toggleWeight"):t.addItem("bold","toggleWeight"),this.isItalic?t.addItem("normal style","toggleItalic"):t.addItem("italic","toggleItalic"),t},TextMorph.prototype.setAlignmentToLeft=function(){this.alignment="left",this.drawNew(),this.changed()},TextMorph.prototype.setAlignmentToRight=function(){this.alignment="right",this.drawNew(),this.changed()},TextMorph.prototype.setAlignmentToCenter=function(){this.alignment="center",this.drawNew(),this.changed()},TextMorph.prototype.toggleIsDraggable=StringMorph.prototype.toggleIsDraggable,TextMorph.prototype.toggleWeight=StringMorph.prototype.toggleWeight,TextMorph.prototype.toggleItalic=StringMorph.prototype.toggleItalic,TextMorph.prototype.setSerif=StringMorph.prototype.setSerif,TextMorph.prototype.setSansSerif=StringMorph.prototype.setSansSerif,TextMorph.prototype.setText=StringMorph.prototype.setText,TextMorph.prototype.setFontSize=StringMorph.prototype.setFontSize,TextMorph.prototype.numericalSetters=StringMorph.prototype.numericalSetters,TextMorph.prototype.evaluationMenu=function(){var t=new MenuMorph(this,null);return t.addItem("do it","doIt","evaluate the\nselected expression"),t.addItem("show it","showIt","evaluate the\nselected expression\nand show the result"),t.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result"),t.addLine(),t.addItem("select all","selectAllAndEdit"),t},TextMorph.prototype.setReceiver=function(t){this.receiver=t,this.customContextMenu=this.evaluationMenu()},TextMorph.prototype.doIt=function(){this.receiver.evaluateString(this.selection()),this.edit()},TextMorph.prototype.showIt=function(){var t=this.receiver.evaluateString(this.selection());null!==t&&this.inform(t)},TextMorph.prototype.inspectIt=function(){var t,e=this.receiver.evaluateString(this.selection()),o=this.world();isObject(e)&&(t=new InspectorMorph(e),t.setPosition(o.hand.position()),t.keepWithin(o),o.add(t),t.changed())},TriggerMorph.prototype=new Morph,TriggerMorph.prototype.constructor=TriggerMorph,TriggerMorph.uber=Morph.prototype,TriggerMorph.prototype.init=function(t,e,o,r,i,n,s,a,h,l,p){this.target=t||null,this.action=e||null,this.doubleClickAction=p||null,this.environment=n||null,this.labelString=o||null,this.label=null,this.hint=s||null,this.fontSize=r||MorphicPreferences.menuFontSize,this.fontStyle=i||"sans-serif",this.highlightColor=new Color(192,192,192),this.pressColor=new Color(128,128,128),this.labelColor=a||new Color(0,0,0),this.labelBold=h||!1,this.labelItalic=l||!1,TriggerMorph.uber.init.call(this),this.color=new Color(255,255,255),this.drawNew()},TriggerMorph.prototype.drawNew=function(){this.createBackgrounds(),null!==this.labelString&&this.createLabel()},TriggerMorph.prototype.createBackgrounds=function(){var t,e=this.extent();this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),t.fillStyle=this.color.toString(),t.fillRect(0,0,e.x,e.y),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),t.fillStyle=this.highlightColor.toString(),t.fillRect(0,0,e.x,e.y),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),t.fillStyle=this.pressColor.toString(),t.fillRect(0,0,e.x,e.y),this.image=this.normalImage},TriggerMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy(),this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic,!1,null,null,this.labelColor),this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2))),this.add(this.label)},TriggerMorph.prototype.trigger=function(){"function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call(),this):this.target.call(this.environment,this.action,this):"function"==typeof this.action?this.action.call(this.target):this.target[this.action]()},TriggerMorph.prototype.triggerDoubleClick=function(){this.doubleClickAction&&("function"==typeof this.target?"function"==typeof this.doubleClickAction?this.target.call(this.environment,this.doubleClickAction.call(),this):this.target.call(this.environment,this.doubleClickAction,this):"function"==typeof this.doubleClickAction?this.doubleClickAction.call(this.target):this.target[this.doubleClickAction]())},TriggerMorph.prototype.mouseEnter=function(){var t=this.hint instanceof Function?this.hint():this.hint;this.image=this.highlightImage,this.changed(),t&&this.bubbleHelp(t)},TriggerMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed(),this.hint&&this.world().hand.destroyTemporaries()},TriggerMorph.prototype.mouseDownLeft=function(){this.image=this.pressImage,this.changed()},TriggerMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage,this.changed(),this.trigger()},TriggerMorph.prototype.mouseDoubleClick=function(){this.triggerDoubleClick()},TriggerMorph.prototype.rootForGrab=function(){return this.isDraggable?TriggerMorph.uber.rootForGrab.call(this):null},TriggerMorph.prototype.bubbleHelp=function(t){var e=this;this.fps=2,this.step=function(){this.bounds.containsPoint(this.world().hand.position())&&e.popUpbubbleHelp(t),e.fps=0,delete e.step}},TriggerMorph.prototype.popUpbubbleHelp=function(t){new SpeechBubbleMorph(localize(t),null,null,1).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))};var MenuItemMorph;MenuItemMorph.prototype=new TriggerMorph,MenuItemMorph.prototype.constructor=MenuItemMorph,MenuItemMorph.uber=TriggerMorph.prototype,MenuItemMorph.prototype.createLabel=function(){var t,e,o;null!==this.label&&this.label.destroy(),isString(this.labelString)?this.label=this.createLabelString(this.labelString):this.labelString instanceof Array?(this.label=new Morph,this.label.alpha=0,t=this.createIcon(this.labelString[0]),this.label.add(t),e=this.createLabelString(this.labelString[1]),this.label.add(e),e.setCenter(t.center()),e.setLeft(t.right()+4),this.label.bounds=t.bounds.merge(e.bounds),this.label.drawNew()):this.label=this.createIcon(this.labelString),this.silentSetExtent(this.label.extent().add(new Point(8,0))),o=this.position().add(new Point(4,0)),this.label.bounds=o.extent(this.label.extent()),this.add(this.label)},MenuItemMorph.prototype.createIcon=function(t){var e,o=new Morph;return o.image=t instanceof Morph?t.fullImage():t,t instanceof Morph&&t.getShadow()&&(e=o.image,o.image=newCanvas(t.fullBounds().extent().subtract(this.shadowBlur*(useBlurredShadows?1:2))),o.image.getContext("2d").drawImage(e,0,0)),o.silentSetWidth(o.image.width),o.silentSetHeight(o.image.height),o},MenuItemMorph.prototype.createLabelString=function(t){var e=new TextMorph(t,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic);return e.setColor(this.labelColor),e},MenuItemMorph.prototype.mouseEnter=function(){this.isListItem()||(this.image=this.highlightImage,this.changed()),this.hint&&this.bubbleHelp(this.hint)},MenuItemMorph.prototype.mouseLeave=function(){this.isListItem()||(this.image=this.normalImage,this.changed()),this.hint&&this.world().hand.destroyTemporaries()},MenuItemMorph.prototype.mouseDownLeft=function(t){this.isListItem()&&(this.parent.unselectAllItems(),this.escalateEvent("mouseDownLeft",t)),this.image=this.pressImage,this.changed()},MenuItemMorph.prototype.mouseMove=function(){this.isListItem()&&this.escalateEvent("mouseMove")},MenuItemMorph.prototype.mouseClickLeft=function(){this.isListItem()||(this.parent.destroy(),this.root().activeMenu=null),this.trigger()},MenuItemMorph.prototype.isListItem=function(){return!!this.parent&&this.parent.isListContents},MenuItemMorph.prototype.isSelectedListItem=function(){return!!this.isListItem()&&this.image===this.pressImage},FrameMorph.prototype=new Morph,FrameMorph.prototype.constructor=FrameMorph,FrameMorph.uber=Morph.prototype,FrameMorph.prototype.init=function(t){this.scrollFrame=t||null,FrameMorph.uber.init.call(this),this.color=new Color(255,250,245),this.drawNew(),this.acceptsDrops=!0,this.scrollFrame&&(this.isDraggable=!1,this.noticesTransparentClick=!1,this.alpha=0)},FrameMorph.prototype.fullBounds=function(){var t=this.getShadow();return null!==t?this.bounds.merge(t.bounds):this.bounds},FrameMorph.prototype.fullImage=function(){return this.image},FrameMorph.prototype.fullDrawOn=function(t,e){var o,r;return this.isVisible?(o=e||this.fullBounds(),r=this.bounds.intersect(o),r.extent().gt(new Point(0,0))?(this.drawOn(t,r),void this.children.forEach(function(e){e instanceof ShadowMorph?e.fullDrawOn(t,o):e.fullDrawOn(t,r)})):null):null},FrameMorph.prototype.topMorphAt=function(t){var e,o;if(!this.isVisible||!this.bounds.containsPoint(t))return null;for(e=this.children.length-1;e>=0;e-=1)if(o=this.children[e].topMorphAt(t))return o;return this.noticesTransparentClick||!this.isTransparentAt(t)?this:null},FrameMorph.prototype.submorphBounds=function(){var t=null;return this.children.length>0&&(t=this.children[0].bounds,this.children.forEach(function(e){t=t.merge(e.fullBounds())})),t},FrameMorph.prototype.keepInScrollFrame=function(){return null===this.scrollFrame?null:(this.left()>this.scrollFrame.left()&&this.moveBy(new Point(this.scrollFrame.left()-this.left(),0)),this.right()<this.scrollFrame.right()&&this.moveBy(new Point(this.scrollFrame.right()-this.right(),0)),this.top()>this.scrollFrame.top()&&this.moveBy(new Point(0,this.scrollFrame.top()-this.top())),void(this.bottom()<this.scrollFrame.bottom()&&this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))))},FrameMorph.prototype.adjustBounds=function(){var t,e,o=this;return null===this.scrollFrame?null:(t=this.submorphBounds(),e=t&&!this.scrollFrame.isTextLineWrapping?t.expandBy(this.scrollFrame.padding).growBy(this.scrollFrame.growth).merge(this.scrollFrame.bounds):this.scrollFrame.bounds.copy(),this.bounds.eq(e)||(this.bounds=e,this.drawNew(),this.keepInScrollFrame()),this.scrollFrame.isTextLineWrapping&&this.children.forEach(function(t){t instanceof TextMorph&&(t.setWidth(o.width()),o.setHeight(Math.max(t.height(),o.scrollFrame.height())))}),void this.scrollFrame.adjustScrollBars())},FrameMorph.prototype.reactToDropOf=function(){this.adjustBounds()},FrameMorph.prototype.reactToGrabOf=function(){this.adjustBounds()},FrameMorph.prototype.developersMenu=function(){var t=FrameMorph.uber.developersMenu.call(this);return this.children.length>0&&(t.addLine(),t.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible")),t},FrameMorph.prototype.keepAllSubmorphsWithin=function(){var t=this;this.children.forEach(function(e){e.keepWithin(t)})},ScrollFrameMorph.prototype=new FrameMorph,ScrollFrameMorph.prototype.constructor=ScrollFrameMorph,ScrollFrameMorph.uber=FrameMorph.prototype,ScrollFrameMorph.prototype.init=function(t,e,o){var r=this;ScrollFrameMorph.uber.init.call(this),this.scrollBarSize=e||MorphicPreferences.scrollBarSize,
this.autoScrollTrigger=null,this.isScrollingByDragging=!0,this.hasVelocity=!0,this.padding=0,this.growth=0,this.isTextLineWrapping=!1,this.contents=t||new FrameMorph(this),this.add(this.contents),this.hBar=new SliderMorph(null,null,null,null,"horizontal",o),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=function(t){r.contents.setPosition(new Point(r.left()-t,r.contents.position().y))},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(null,null,null,null,"vertical",o),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(t){r.contents.setPosition(new Point(r.contents.position().x,r.top()-t))},this.vBar.isDraggable=!1,this.add(this.vBar)},ScrollFrameMorph.prototype.adjustScrollBars=function(){var t=this.width()-this.scrollBarSize,e=this.height()-this.scrollBarSize;this.changed(),this.contents.width()>this.width()+MorphicPreferences.scrollBarSize?(this.hBar.show(),this.hBar.width()!==t&&this.hBar.setWidth(t),this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height())),this.hBar.start=0,this.hBar.stop=this.contents.width()-this.width(),this.hBar.size=this.width()/this.contents.width()*this.hBar.stop,this.hBar.value=this.left()-this.contents.left(),this.hBar.drawNew()):this.hBar.hide(),this.contents.height()>this.height()+this.scrollBarSize?(this.vBar.show(),this.vBar.height()!==e&&this.vBar.setHeight(e),this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top())),this.vBar.start=0,this.vBar.stop=this.contents.height()-this.height(),this.vBar.size=this.height()/this.contents.height()*this.vBar.stop,this.vBar.value=this.top()-this.contents.top(),this.vBar.drawNew()):this.vBar.hide()},ScrollFrameMorph.prototype.addContents=function(t){this.contents.add(t),this.contents.adjustBounds()},ScrollFrameMorph.prototype.setContents=function(t){this.contents.children.forEach(function(t){t.destroy()}),this.contents.children=[],t.setPosition(this.position().add(this.padding+2)),this.addContents(t)},ScrollFrameMorph.prototype.setExtent=function(t){this.isTextLineWrapping&&this.contents.setPosition(this.position().copy()),ScrollFrameMorph.uber.setExtent.call(this,t),this.contents.adjustBounds()},ScrollFrameMorph.prototype.scrollX=function(t){var e,o=this.contents.left(),r=this.left(),i=this.contents.width(),n=this.right();e=o+t,e+i<n&&(e=n-i),e>r&&(e=r),e!==o&&this.contents.setLeft(e)},ScrollFrameMorph.prototype.scrollY=function(t){var e,o=this.contents.top(),r=this.top(),i=this.contents.height(),n=this.bottom();e=o+t,e+i<n&&(e=n-i),e>r&&(e=r),e!==o&&this.contents.setTop(e)},ScrollFrameMorph.prototype.step=function(){nop()},ScrollFrameMorph.prototype.mouseDownLeft=function(t){if(!this.isScrollingByDragging)return null;var e=this.root(),o=e.hand,r=t,i=this,n=0,s=0,a=.8;this.step=function(){var t;if(o.mouseButton&&0===o.children.length&&i.bounds.containsPoint(o.bounds.origin)){if(o.grabPosition&&o.grabPosition.distanceTo(o.position())<=MorphicPreferences.grabThreshold)return null;t=o.bounds.origin,n=t.x-r.x,0!==n&&i.scrollX(n),s=t.y-r.y,0!==s&&i.scrollY(s),r=t}else i.hasVelocity?Math.abs(n)<.5&&Math.abs(s)<.5?i.step=function(){nop()}:(n*=a,i.scrollX(Math.round(n)),s*=a,i.scrollY(Math.round(s))):i.step=function(){nop()};this.adjustScrollBars()}},ScrollFrameMorph.prototype.startAutoScrolling=function(){var t,e,o,r=this,i=3*MorphicPreferences.scrollBarSize,n=this.world();return n?(t=n.hand,this.autoScrollTrigger||(this.autoScrollTrigger=Date.now()),void(this.step=function(){o=t.bounds.origin,e=r.bounds.insetBy(i),r.bounds.containsPoint(o)&&!e.containsPoint(o)&&t.children.length>0?r.autoScroll(o):(r.step=function(){nop()},r.autoScrollTrigger=null)})):null},ScrollFrameMorph.prototype.autoScroll=function(t){var e,o;return Date.now()-this.autoScrollTrigger<500?null:(e=3*MorphicPreferences.scrollBarSize,o=this.topLeft().extent(new Point(this.width(),e)),o.containsPoint(t)&&this.scrollY(e-(t.y-this.top())),o=this.topLeft().extent(new Point(e,this.height())),o.containsPoint(t)&&this.scrollX(e-(t.x-this.left())),o=new Point(this.right()-e,this.top()).extent(new Point(e,this.height())),o.containsPoint(t)&&this.scrollX(-(e-(this.right()-t.x))),o=new Point(this.left(),this.bottom()-e).extent(new Point(this.width(),e)),o.containsPoint(t)&&this.scrollY(-(e-(this.bottom()-t.y))),void this.adjustScrollBars())},ScrollFrameMorph.prototype.scrollCursorIntoView=function(t){var e=t.target,o=e.position().subtract(this.contents.position()),r=this.top()+this.padding,i=this.bottom()-this.padding;this.contents.setExtent(e.extent().add(o).add(this.padding)),t.top()<r?(this.contents.setTop(this.contents.top()+r-t.top()),t.setTop(r)):t.bottom()>i&&(this.contents.setBottom(this.contents.bottom()+i-t.bottom()),t.setBottom(i)),this.adjustScrollBars()},ScrollFrameMorph.prototype.mouseScroll=function(t,e){t&&this.scrollY(t*MorphicPreferences.mouseScrollAmount),e&&this.scrollX(e*MorphicPreferences.mouseScrollAmount),this.adjustScrollBars()},ScrollFrameMorph.prototype.updateReferences=function(t){var e=this;ScrollFrameMorph.uber.updateReferences.call(this,t),this.hBar&&(this.hBar.action=function(t){e.contents.setPosition(new Point(e.left()-t,e.contents.position().y))}),this.vBar&&(this.vBar.action=function(t){e.contents.setPosition(new Point(e.contents.position().x,e.top()-t))})},ScrollFrameMorph.prototype.developersMenu=function(){var t=ScrollFrameMorph.uber.developersMenu.call(this);return this.isTextLineWrapping?t.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff"):t.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping"),t},ScrollFrameMorph.prototype.toggleTextLineWrapping=function(){this.isTextLineWrapping=!this.isTextLineWrapping},ListMorph.prototype=new ScrollFrameMorph,ListMorph.prototype.constructor=ListMorph,ListMorph.uber=ScrollFrameMorph.prototype,ListMorph.prototype.init=function(t,e,o,r){ListMorph.uber.init.call(this),this.contents.acceptsDrops=!1,this.color=new Color(255,255,255),this.hBar.alpha=.6,this.vBar.alpha=.6,this.elements=t||[],this.labelGetter=e,this.format=o,this.listContents=null,this.selected=null,this.active=null,this.action=null,this.doubleClickAction=r||null,this.acceptsDrops=!1,this.buildListContents()},ListMorph.prototype.buildListContents=function(){var t=this;this.listContents&&this.listContents.destroy(),this.listContents=new MenuMorph(this.select,null,this),0===this.elements.length&&(this.elements=["(empty)"]),this.elements.forEach(function(e){var o=null,r=!1,i=!1;t.format.forEach(function(t){t[1].call(null,e)&&("bold"===t[0]?r=!0:"italic"===t[0]?i=!0:o=t[0])}),t.listContents.addItem(t.labelGetter(e),e,null,o,r,i,t.doubleClickAction)}),this.listContents.setPosition(this.contents.position()),this.listContents.isListContents=!0,this.listContents.drawNew(),this.addContents(this.listContents)},ListMorph.prototype.select=function(t,e){isNil(t)||(this.selected=t,this.active=e,this.action&&this.action.call(null,t))},ListMorph.prototype.setExtent=function(t){var e=this.listContents.bounds,o=this.bounds.origin.copy().corner(this.bounds.origin.add(t));o.right()>e.right()&&o.width()<=e.width()&&this.listContents.setRight(o.right()),o.bottom()>e.bottom()&&o.height()<=e.height()&&this.listContents.setBottom(o.bottom()),ListMorph.uber.setExtent.call(this,t)},ListMorph.prototype.activeIndex=function(){return this.listContents.children.indexOf(this.active)},ListMorph.prototype.activateIndex=function(t){var e=this.listContents.children[t];e&&(e.image=e.pressImage,e.changed(),e.trigger())},StringFieldMorph.prototype=new FrameMorph,StringFieldMorph.prototype.constructor=StringFieldMorph,StringFieldMorph.uber=FrameMorph.prototype,StringFieldMorph.prototype.init=function(t,e,o,r,i,n,s){this.defaultContents=t,this.minWidth=e,this.fontSize=o,this.fontStyle=r,this.isBold=i,this.isItalic=n,this.isNumeric=s||!1,this.text=null,StringFieldMorph.uber.init.call(this),this.color=new Color(255,255,255),this.isEditable=!0,this.acceptsDrops=!1,this.drawNew()},StringFieldMorph.prototype.drawNew=function(){var t;t=this.text?this.string():this.defaultContents,this.text=null,this.children.forEach(function(t){t.destroy()}),this.children=[],this.text=new StringMorph(t,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric),this.text.isNumeric=this.isNumeric,this.text.setPosition(this.bounds.origin.copy()),this.text.isEditable=this.isEditable,this.text.isDraggable=!1,this.text.enableSelecting(),this.silentSetExtent(new Point(Math.max(this.width(),this.minWidth),this.text.height())),StringFieldMorph.uber.drawNew.call(this),this.add(this.text)},StringFieldMorph.prototype.string=function(){return this.text.text},StringFieldMorph.prototype.mouseClickLeft=function(t){this.isEditable?this.text.edit():this.escalateEvent("mouseClickLeft",t)};var BouncerMorph;BouncerMorph.prototype=new Morph,BouncerMorph.prototype.constructor=BouncerMorph,BouncerMorph.uber=Morph.prototype,BouncerMorph.prototype.init=function(t,e){BouncerMorph.uber.init.call(this),this.fps=50,this.isStopped=!1,this.type=t||"vertical","vertical"===this.type?this.direction="down":this.direction="right",this.speed=e||1},BouncerMorph.prototype.moveUp=function(){this.moveBy(new Point(0,-this.speed))},BouncerMorph.prototype.moveDown=function(){this.moveBy(new Point(0,this.speed))},BouncerMorph.prototype.moveRight=function(){this.moveBy(new Point(this.speed,0))},BouncerMorph.prototype.moveLeft=function(){this.moveBy(new Point(-this.speed,0))},BouncerMorph.prototype.step=function(){this.isStopped||("vertical"===this.type?("down"===this.direction?this.moveDown():this.moveUp(),this.fullBounds().top()<this.parent.top()&&"up"===this.direction&&(this.direction="down"),this.fullBounds().bottom()>this.parent.bottom()&&"down"===this.direction&&(this.direction="up")):"horizontal"===this.type&&("right"===this.direction?this.moveRight():this.moveLeft(),this.fullBounds().left()<this.parent.left()&&"left"===this.direction&&(this.direction="right"),this.fullBounds().right()>this.parent.right()&&"right"===this.direction&&(this.direction="left")))},HandMorph.prototype=new Morph,HandMorph.prototype.constructor=HandMorph,HandMorph.uber=Morph.prototype,HandMorph.prototype.init=function(t){HandMorph.uber.init.call(this,!0),this.bounds=new Rectangle,this.world=t,this.mouseButton=null,this.mouseOverList=[],this.morphToGrab=null,this.grabPosition=null,this.grabOrigin=null,this.temporaries=[],this.touchHoldTimeout=null,this.contextMenuEnabled=!1},HandMorph.prototype.changed=function(){var t;null!==this.world&&(t=this.fullBounds(),t.extent().eq(new Point)||this.world.broken.push(t.spread()))},HandMorph.prototype.fullChanged=HandMorph.prototype.changed,HandMorph.prototype.morphAtPointer=function(){return this.world.topMorphAt(this.bounds.origin)||this.world},HandMorph.prototype.allMorphsAtPointer=function(){var t=this.world.allChildren(),e=this;return t.filter(function(t){return t.isVisible&&t.visibleBounds().containsPoint(e.bounds.origin)})},HandMorph.prototype.dropTargetFor=function(t){for(var e=this.morphAtPointer();!e.wantsDropOf(t);)e=e.parent;return e},HandMorph.prototype.grab=function(t){var e=t.parent;return t instanceof WorldMorph?null:void(0===this.children.length&&(this.world.stopEditing(),this.grabOrigin=t.situation(),t.addShadow(),t.prepareToBeGrabbed&&t.prepareToBeGrabbed(this),t.cachedFullImage=t.fullImageClassic(),t.cachedFullBounds=t.fullBounds(),this.add(t),this.changed(),e&&e.reactToGrabOf&&e.reactToGrabOf(t)))},HandMorph.prototype.drop=function(){var t,e;0!==this.children.length&&(e=this.children[0],t=this.dropTargetFor(e),this.changed(),t.add(e),e.cachedFullImage=null,e.cachedFullBounds=null,e.changed(),e.removeShadow(),this.children=[],this.setExtent(new Point),e.justDropped&&e.justDropped(this),t.reactToDropOf&&t.reactToDropOf(e,this))},HandMorph.prototype.processMouseDown=function(t){var e,o;if(this.destroyTemporaries(),this.contextMenuEnabled=!0,this.morphToGrab=null,this.grabPosition=null,0!==this.children.length)this.drop(),this.mouseButton=null;else{for(e=this.morphAtPointer(),this.world.activeMenu&&(contains(e.allParents(),this.world.activeMenu)?clearInterval(this.touchHoldTimeout):this.world.activeMenu.destroy()),this.world.activeHandle&&e!==this.world.activeHandle&&this.world.activeHandle.destroy(),this.world.cursor&&e!==this.world.cursor.target&&this.world.stopEditing(),e.mouseMove||(this.morphToGrab=e.rootForGrab(),this.grabPosition=this.bounds.origin.copy()),2===t.button||t.ctrlKey?(this.mouseButton="right",o="mouseDownRight"):(this.mouseButton="left",o="mouseDownLeft");!e[o];)e=e.parent;e[o](this.bounds.origin)}},HandMorph.prototype.processTouchStart=function(t){var e=this;MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),1===t.touches.length&&(this.touchHoldTimeout=setInterval(function(){e.processMouseDown({button:2}),e.processMouseUp({button:2}),t.preventDefault(),clearInterval(e.touchHoldTimeout)},400),this.processMouseMove(t.touches[0]),this.processMouseDown({button:0}),t.preventDefault())},HandMorph.prototype.processTouchMove=function(t){if(MorphicPreferences.isTouchDevice=!0,1===t.touches.length){var e=t.touches[0];this.processMouseMove(e),clearInterval(this.touchHoldTimeout)}},HandMorph.prototype.processTouchEnd=function(t){MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),nop(t),this.processMouseUp({button:0})},HandMorph.prototype.processMouseUp=function(){var t,e,o,r=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{if("left"===this.mouseButton)o="mouseClickLeft";else if(o="mouseClickRight",this.mouseButton&&this.contextMenuEnabled){for(t=r,e=t.contextMenu();!e&&t.parent;)t=t.parent,e=t.contextMenu();e&&e.popUpAtHand(this.world)}for(;!r[o];)r=r.parent;r[o](this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processDoubleClick=function(){var t=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{for(;t&&!t.mouseDoubleClick;)t=t.parent;t&&t.mouseDoubleClick(this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processMouseMove=function(t){var e,o,r,i,n=getDocumentPositionOf(this.world.worldCanvas),s=this;e=new Point(t.pageX-n.x,t.pageY-n.y),this.setPosition(e),o=this.morphAtPointer().allParents(),!this.children.length&&this.mouseButton&&(i=this.morphAtPointer(),r=i.rootForGrab(),i.mouseMove&&(i.mouseMove(e,this.mouseButton),"right"===this.mouseButton&&(this.contextMenuEnabled=!1)),"left"===this.mouseButton&&this.morphToGrab&&this.grabPosition.distanceTo(this.bounds.origin)>MorphicPreferences.grabThreshold&&(this.setPosition(this.grabPosition),this.morphToGrab.isDraggable?(r=this.morphToGrab,this.grab(r)):this.morphToGrab.isTemplate&&(r=this.morphToGrab.fullCopy(),r.isTemplate=!1,r.isDraggable=!0,r.reactToTemplateCopy&&r.reactToTemplateCopy(),this.grab(r),this.grabOrigin=this.morphToGrab.situation()),this.setPosition(e))),this.mouseOverList.forEach(function(t){contains(o,t)||(t.mouseLeave&&t.mouseLeave(),t.mouseLeaveDragging&&s.mouseButton&&t.mouseLeaveDragging())}),o.forEach(function(t){contains(s.mouseOverList,t)||(t.mouseEnter&&t.mouseEnter(),t.mouseEnterDragging&&s.mouseButton&&t.mouseEnterDragging()),s.children.length>0&&t instanceof ScrollFrameMorph&&(t.bounds.insetBy(3*MorphicPreferences.scrollBarSize).containsPoint(s.bounds.origin)||t.startAutoScrolling())}),this.mouseOverList=o},HandMorph.prototype.processMouseScroll=function(t){for(var e=this.morphAtPointer();e&&!e.mouseScroll;)e=e.parent;e&&e.mouseScroll(t.detail/-3||(Object.prototype.hasOwnProperty.call(t,"wheelDeltaY")?t.wheelDeltaY/120:t.wheelDelta/120),t.wheelDeltaX/120||0)},HandMorph.prototype.processDrop=function(t){function e(t){for(var e=new Image,o=new FileReader;!g.droppedSVG;)g=g.parent;e.onload=function(){g.droppedSVG(e,t.name)},o=new FileReader,o.onloadend=function(t){e.src=t.target.result},o.readAsDataURL(t)}function o(t){for(var e=new Image,o=new FileReader;!g.droppedImage;)g=g.parent;e.onload=function(){l=newCanvas(new Point(e.width,e.height),!0),l.getContext("2d").drawImage(e,0,0),g.droppedImage(l,t.name)},o=new FileReader,o.onloadend=function(t){e.src=t.target.result},o.readAsDataURL(t)}function r(t){for(var e=new Audio,o=new FileReader;!g.droppedAudio;)g=g.parent;o.onloadend=function(o){e.src=o.target.result,g.droppedAudio(e,t.name)},o.readAsDataURL(t)}function i(t){for(var e=new FileReader;!g.droppedText;)g=g.parent;e.onloadend=function(e){g.droppedText(e.target.result,t.name)},e.readAsText(t)}function n(t){for(var e=new FileReader;!g.droppedBinary;)g=g.parent;e.onloadend=function(e){g.droppedBinary(e.target.result,t.name)},e.readAsArrayBuffer(t)}function s(t){var e,o,r="",i=t.indexOf('<img src="');if(i===-1)return null;for(i+=10,e=i;e<t.length;e+=1){if(o=t[e],'"'===o)return r;r=r.concat(o)}return null}var a,h,l,p,c=t instanceof FileList?t:t.target.files||t.dataTransfer.files,d=t.dataTransfer?t.dataTransfer.getData("URL"):null,u=t.dataTransfer?t.dataTransfer.getData("Text/HTML"):null,g=this.morphAtPointer(),f=new Image;if(c.length>0)for(p=0;p<c.length;p+=1)a=c[p],a.type.indexOf("svg")===-1||MorphicPreferences.rasterizeSVGs?0===a.type.indexOf("image")?o(a):0===a.type.indexOf("audio")?r(a):0===a.type.indexOf("text")?i(a):n(a):e(a);else if(d){if(contains(["gif","png","jpg","jpeg","bmp"],d.slice(d.lastIndexOf(".")+1).toLowerCase())){for(;!g.droppedImage;)g=g.parent;f=new Image,f.onload=function(){l=newCanvas(new Point(f.width,f.height),!0),l.getContext("2d").drawImage(f,0,0),g.droppedImage(l)},f.src=d}}else if(u){for(;!g.droppedImage;)g=g.parent;f=new Image,f.onload=function(){l=newCanvas(new Point(f.width,f.height),!0),l.getContext("2d").drawImage(f,0,0),g.droppedImage(l)},h=s(u),h&&(f.src=h)}},HandMorph.prototype.destroyTemporaries=function(){var t=this;this.temporaries.forEach(function(e){e.isClickable&&e.bounds.containsPoint(t.position())||(e.destroy(),t.temporaries.splice(t.temporaries.indexOf(e),1))})},WorldMorph.prototype=new FrameMorph,WorldMorph.prototype.constructor=WorldMorph,WorldMorph.uber=FrameMorph.prototype,WorldMorph.prototype.init=function(t,e){for(WorldMorph.uber.init.call(this),this.color=new Color(205,205,205),this.alpha=1,this.bounds=new Rectangle(0,0,t.width,t.height),this.drawNew(),this.isVisible=!0,this.isDraggable=!1,this.currentKey=null,this.worldCanvas=t,this.noticesTransparentClick=!0,this.stamp=Date.now();this.stamp===Date.now();)nop();this.stamp=Date.now(),this.useFillPage=e,void 0===this.useFillPage&&(this.useFillPage=!0),this.isDevMode=!1,this.broken=[],this.hand=new HandMorph(this),this.keyboardReceiver=null,this.lastEditedText=null,this.cursor=null,this.activeMenu=null,this.activeHandle=null,this.virtualKeyboard=null,this.initEventListeners()},WorldMorph.prototype.brokenFor=function(t){var e=t.fullBounds();return this.broken.filter(function(t){return t.intersects(e)})},WorldMorph.prototype.fullDrawOn=function(t,e){WorldMorph.uber.fullDrawOn.call(this,t,e),this.hand.fullDrawOn(t,e)},WorldMorph.prototype.updateBroken=function(){var t=this;this.condenseDamages(),this.broken.forEach(function(e){e.extent().gt(new Point(0,0))&&t.fullDrawOn(t.worldCanvas,e)}),this.broken=[]},WorldMorph.prototype.condenseDamages=function(){function t(t){var e,o=[];return t.forEach(function(t){e=detect(o,function(e){return e.isNearTo(t,20)}),e?e.mergeWith(t):o.push(t)}),o}for(var e=!0,o=this.broken.length;e;)this.broken=t(this.broken),e=this.broken.length<o,o=this.broken.length},WorldMorph.prototype.doOneCycle=function(){this.stepFrame(),this.updateBroken()},WorldMorph.prototype.fillPage=function(){var t=window.innerHeight,e=window.innerWidth,o=this;this.worldCanvas.style.position="absolute",this.worldCanvas.style.left="0px",this.worldCanvas.style.right="0px",this.worldCanvas.style.width="100%",this.worldCanvas.style.height="100%",document.documentElement.scrollTop&&(t=document.documentElement.clientHeight),document.documentElement.scrollLeft&&(e=document.documentElement.clientWidth),this.worldCanvas.width!==e&&(this.worldCanvas.width=e,this.setWidth(e)),this.worldCanvas.height!==t&&(this.worldCanvas.height=t,this.setHeight(t)),this.children.forEach(function(t){t.reactToWorldResize&&t.reactToWorldResize(o.bounds.copy())})},WorldMorph.prototype.getGlobalPixelColor=function(t){var e=this.worldCanvas.getContext("2d").getImageData(t.x,t.y,1,1).data;return new Color(e[0],e[1],e[2])},WorldMorph.prototype.initVirtualKeyboard=function(){var t=this;this.virtualKeyboard&&(document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null),MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard=document.createElement("input"),this.virtualKeyboard.type="text",this.virtualKeyboard.style.color="transparent",this.virtualKeyboard.style.backgroundColor="transparent",this.virtualKeyboard.style.border="none",this.virtualKeyboard.style.outline="none",this.virtualKeyboard.style.position="absolute",this.virtualKeyboard.style.top="0px",this.virtualKeyboard.style.left="0px",this.virtualKeyboard.style.width="0px",this.virtualKeyboard.style.height="0px",this.virtualKeyboard.autocapitalize="none",document.body.appendChild(this.virtualKeyboard),this.virtualKeyboard.addEventListener("keydown",function(e){t.currentKey=e.keyCode,t.keyboardReceiver&&t.keyboardReceiver.processKeyDown(e),8===e.keyCode&&e.preventDefault(),9===e.keyCode&&(t.keyboardReceiver&&t.keyboardReceiver.processKeyPress(e),e.preventDefault())},!1),this.virtualKeyboard.addEventListener("keyup",function(e){t.currentKey=null,t.keyboardReceiver&&t.keyboardReceiver.processKeyUp&&t.keyboardReceiver.processKeyUp(e),e.preventDefault()},!1),this.virtualKeyboard.addEventListener("keypress",function(e){t.keyboardReceiver&&t.keyboardReceiver.processKeyPress(e),e.preventDefault()},!1))},WorldMorph.prototype.initEventListeners=function(){var t=this.worldCanvas,e=this;e.useFillPage?e.fillPage():this.changed(),t.addEventListener("mousedown",function(o){o.preventDefault(),t.focus(),e.hand.processMouseDown(o)},!1),t.addEventListener("touchstart",function(t){e.hand.processTouchStart(t)},!1),t.addEventListener("mouseup",function(t){t.preventDefault(),e.hand.processMouseUp(t)},!1),t.addEventListener("dblclick",function(t){t.preventDefault(),e.hand.processDoubleClick(t)},!1),t.addEventListener("touchend",function(t){e.hand.processTouchEnd(t)},!1),t.addEventListener("mousemove",function(t){e.hand.processMouseMove(t)},!1),t.addEventListener("touchmove",function(t){e.hand.processTouchMove(t)},!1),t.addEventListener("contextmenu",function(t){t.preventDefault()},!1),t.addEventListener("keydown",function(t){e.currentKey=t.keyCode,e.keyboardReceiver&&e.keyboardReceiver.processKeyDown(t),8===t.keyCode&&t.preventDefault(),9===t.keyCode&&(e.keyboardReceiver&&e.keyboardReceiver.processKeyPress(t),t.preventDefault()),(t.ctrlKey&&!t.altKey||t.metaKey)&&86!==t.keyCode&&t.preventDefault()},!1),t.addEventListener("keyup",function(t){e.currentKey=null,e.keyboardReceiver&&e.keyboardReceiver.processKeyUp&&e.keyboardReceiver.processKeyUp(t),t.preventDefault()},!1),t.addEventListener("keypress",function(t){e.keyboardReceiver&&e.keyboardReceiver.processKeyPress(t),t.preventDefault()},!1),t.addEventListener("mousewheel",function(t){e.hand.processMouseScroll(t),t.preventDefault()},!1),t.addEventListener("DOMMouseScroll",function(t){e.hand.processMouseScroll(t),t.preventDefault()},!1),document.body.addEventListener("paste",function(t){var o=t.clipboardData.getData("Text");o&&e.cursor&&e.cursor.insert(o)},!1),window.addEventListener("dragover",function(t){t.preventDefault()},!1),window.addEventListener("drop",function(t){e.hand.processDrop(t),t.preventDefault()},!1),window.addEventListener("resize",function(){e.useFillPage&&e.fillPage()},!1),window.onbeforeunload=function(t){var e=t||window.event,o="Are you sure you want to leave?";return e&&(e.returnValue=o),o}},WorldMorph.prototype.mouseDownLeft=function(){nop()},WorldMorph.prototype.mouseClickLeft=function(){nop()},WorldMorph.prototype.mouseDownRight=function(){nop()},WorldMorph.prototype.mouseClickRight=function(){nop()},WorldMorph.prototype.wantsDropOf=function(){return this.acceptsDrops},WorldMorph.prototype.droppedImage=function(){return null},WorldMorph.prototype.droppedSVG=function(){return null},WorldMorph.prototype.nextTab=function(t){var e=this.nextEntryField(t);e&&(t.clearSelection(),e.selectAll(),e.edit())},WorldMorph.prototype.previousTab=function(t){var e=this.previousEntryField(t);e&&(t.clearSelection(),e.selectAll(),e.edit())},WorldMorph.prototype.contextMenu=function(){var t;return t=this.isDevMode?new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]):new MenuMorph(this,"Morphic"),this.isDevMode&&(t.addItem("demo...","userCreateMorph","sample morphs"),t.addLine(),t.addItem("hide all...","hideAll"),t.addItem("show all...","showAllHiddens"),t.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"),t.addItem("inspect...","inspect","open a window on\nall properties"),t.addItem("screenshot...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),t.addLine(),t.addItem("restore display","changed","redraw the\nscreen once"),t.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizings"),useBlurredShadows?t.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers"):t.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers"),t.addItem("color...",function(){this.pickColor(t.title+"\ncolor:",this.setColor,this,this.color)},"choose the World's\nbackground color"),MorphicPreferences===standardSettings?t.addItem("touch screen settings","togglePreferences","bigger menu fonts\nand sliders"):t.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders"),t.addLine()),this.isDevMode?t.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus"):t.addItem("development mode...","toggleDevMode"),t.addItem("about morphic.js...","about"),t},WorldMorph.prototype.userCreateMorph=function(){function t(t){t.isDraggable=!0,t.pickUp(r)}var e,o,r=this;e=new MenuMorph(this,"make a morph"),e.addItem("rectangle",function(){t(new Morph)}),e.addItem("box",function(){t(new BoxMorph)}),e.addItem("circle box",function(){t(new CircleBoxMorph)}),e.addLine(),e.addItem("slider",function(){t(new SliderMorph)}),e.addItem("frame",function(){o=new FrameMorph,o.setExtent(new Point(350,250)),t(o)}),e.addItem("scroll frame",function(){o=new ScrollFrameMorph,o.contents.acceptsDrops=!0,o.contents.adjustBounds(),o.setExtent(new Point(350,250)),t(o)}),e.addItem("handle",function(){t(new HandleMorph)}),e.addLine(),e.addItem("string",function(){o=new StringMorph("Hello, World!"),o.isEditable=!0,t(o)}),e.addItem("text",function(){o=new TextMorph("Ich wei nicht, was soll es bedeuten, dass ich so traurig bin, ein Mrchen aus uralten Zeiten, das kommt mir nicht aus dem Sinn. Die Luft ist khl und es dunkelt, und ruhig fliet der Rhein; der Gipfel des Berges funkelt im Abendsonnenschein. Die schnste Jungfrau sitzet dort oben wunderbar, ihr gold'nes Geschmeide blitzet, sie kmmt ihr goldenes Haar, sie kmmt es mit goldenem Kamme, und singt ein Lied dabei; das hat eine wundersame, gewalt'ge Melodei. Den Schiffer im kleinen Schiffe, ergreift es mit wildem Weh; er schaut nicht die Felsenriffe, er schaut nur hinauf in die Hh'. Ich glaube, die Wellen verschlingen am Ende Schiffer und Kahn, und das hat mit ihrem Singen, die Loreley getan."),o.isEditable=!0,o.maxWidth=300,o.drawNew(),t(o)}),e.addItem("speech bubble",function(){o=new SpeechBubbleMorph("Hello, World!"),t(o)}),e.addLine(),e.addItem("gray scale palette",function(){t(new GrayPaletteMorph)}),e.addItem("color palette",function(){t(new ColorPaletteMorph)}),e.addItem("color picker",function(){t(new ColorPickerMorph)}),e.addLine(),e.addItem("sensor demo",function(){o=new MouseSensorMorph,o.setColor(new Color(230,200,100)),o.edge=35,o.border=15,o.borderColor=new Color(200,100,50),o.alpha=.2,o.setExtent(new Point(100,100)),t(o)}),e.addItem("animation demo",function(){var e,o,r,i,n;e=new BouncerMorph,e.setPosition(new Point(50,20)),e.setExtent(new Point(300,200)),e.alpha=.9,e.speed=3,o=new BouncerMorph,o.setColor(new Color(50,50,50)),o.setPosition(new Point(80,80)),o.setExtent(new Point(80,250)),o.type="horizontal",o.direction="right",o.alpha=.9,o.speed=5,r=new BouncerMorph,r.setColor(new Color(20,20,20)),r.setPosition(new Point(90,140)),r.setExtent(new Point(40,30)),r.type="horizontal",r.direction="right",r.speed=3,i=new BouncerMorph,i.setColor(new Color(200,20,20)),i.setPosition(new Point(90,140)),i.setExtent(new Point(20,20)),i.type="vertical",i.direction="up",i.speed=8,n=new BouncerMorph,n.setColor(new Color(20,200,20)),n.setPosition(new Point(120,140)),n.setExtent(new Point(20,20)),n.type="vertical",n.direction="down",n.speed=4,o.add(i),o.add(r),e.add(n),e.add(o),t(e)}),e.addItem("pen",function(){t(new PenMorph)}),r.customMorphs&&(e.addLine(),r.customMorphs().forEach(function(o){e.addItem(o.toString(),function(){t(o)})})),e.popUpAtHand(this)},WorldMorph.prototype.toggleDevMode=function(){this.isDevMode=!this.isDevMode},WorldMorph.prototype.hideAll=function(){this.children.forEach(function(t){t.hide()})},WorldMorph.prototype.showAllHiddens=function(){this.forAllChildren(function(t){t.isVisible||t.show()})},WorldMorph.prototype.about=function(){var t,e="";for(t in modules)Object.prototype.hasOwnProperty.call(modules,t)&&(e+="\n"+t+" ("+modules[t]+")");""!==e&&(e="\n\nmodules:\n\nmorphic ("+morphicVersion+")"+e),this.inform("morphic.js\n\na lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\n\nwritten by Jens Mnig\njens@moenig.org"+e)},WorldMorph.prototype.edit=function(t){var e=getDocumentPositionOf(this.worldCanvas);return t.isEditable?(this.cursor&&this.cursor.destroy(),this.lastEditedText&&this.lastEditedText.clearSelection(),this.cursor=new CursorMorph(t),t.parent.add(this.cursor),this.keyboardReceiver=this.cursor,this.initVirtualKeyboard(),MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard.style.top=this.cursor.top()+e.y+"px",this.virtualKeyboard.style.left=this.cursor.left()+e.x+"px",this.virtualKeyboard.focus()),void(MorphicPreferences.useSliderForInput&&(t.parentThatIsA(MenuMorph)||this.slide(t)))):null},WorldMorph.prototype.slide=function(t){var e,o,r=parseFloat(t.text);isNaN(r)&&(r=0),e=new MenuMorph,o=new SliderMorph(r-25,r+25,r,10,"horizontal"),o.alpha=1,o.color=new Color(225,225,225),o.button.color=e.borderColor,o.button.highlightColor=o.button.color.copy(),o.button.highlightColor.b+=100,o.button.pressColor=o.button.color.copy(),o.button.pressColor.b+=150,o.silentSetHeight(MorphicPreferences.scrollBarSize),o.silentSetWidth(10*MorphicPreferences.menuFontSize),o.drawNew(),o.action=function(e){t.changed(),t.text=Math.round(e).toString(),t.drawNew(),t.changed(),t.escalateEvent("reactToSliderEdit",t)},e.items.push(o),e.popup(this,t.bottomLeft().add(new Point(0,5)))},WorldMorph.prototype.stopEditing=function(){this.cursor&&(this.lastEditedText=this.cursor.target,this.cursor.destroy(),this.cursor=null,this.lastEditedText.escalateEvent("reactToEdit",this.lastEditedText)),this.keyboardReceiver=null,this.virtualKeyboard&&(this.virtualKeyboard.blur(),document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null),this.worldCanvas.focus()},WorldMorph.prototype.toggleBlurredShadows=function(){useBlurredShadows=!useBlurredShadows},WorldMorph.prototype.togglePreferences=function(){MorphicPreferences=MorphicPreferences===standardSettings?touchScreenSettings:standardSettings},modules.locale="2016-July-14";var Localizer,SnapTranslator=new Localizer;Localizer.prototype.translate=function(t){return Object.prototype.hasOwnProperty.call(this.dict[this.language],t)?this.dict[this.language][t]:t},Localizer.prototype.languages=function(){var t,e=[];for(t in this.dict)Object.prototype.hasOwnProperty.call(this.dict,t)&&e.push(t);
return e.sort()},Localizer.prototype.languageName=function(t){return this.dict[t].language_name||t},Localizer.prototype.credits=function(){var t="",e=this;return this.languages().forEach(function(o){t=t+"\n"+e.languageName(o)+" ("+o+") - "+e.dict[o].language_translator+" - "+e.dict[o].last_changed}),t},Localizer.prototype.unload=function(){var t,e=["language_name","language_translator","last_changed"],o=this;this.languages().forEach(function(r){var i;if("en"!==r){t=o.dict[r];for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&!contains(e,i)&&delete t[i]}})},SnapTranslator.dict.en={language_name:"English",language_translator:"Jens Mnig","translator_e-mail":"jens@moenig.org",last_changed:"2015-12-22",any:"random","file menu import hint":"load an exported project file\nor block library, a costume\nor a sound","settings menu prefer empty slots hint":"check to focus on empty slots\nwhen dragging & dropping reporters","costumes tab help":"import a picture from another web page or from\na file on your computer by dropping it here\n","block deletion dialog text":"Are you sure you want to delete this\ncustom block and all its instances?","download to disk text":"This item could not be opened in a new tab.\nIt has been saved to your browser's downloads folder.","unable to export text":"This item could not be exported from Snap!.\nIt's likely that your project may contain a lot of media (sounds and images) or that you are using an older browser.Please try using a recent version of Chrome, Firefox, or Safari."},SnapTranslator.dict.de={language_name:"Deutsch",language_translator:"Jens Mnig","translator_e-mail":"jens@moenig.org",last_changed:"2016-07-12"},SnapTranslator.dict.it={language_name:"Italiano",language_translator:"Stefano Federici, Alberto Firpo, Massimo Ghisalberti","translator_e-mail":"s_federici@yahoo.com, albertofirpo12@gmail.com, zairik@gmail.com",last_changed:"2016-05-10"},SnapTranslator.dict.ja={language_name:"",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2012-04-02"},SnapTranslator.dict.ja_HIRA={language_name:"",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2012-04-02"},SnapTranslator.dict.ko={language_name:"",language_translator:"Yunjae Jang","translator_e-mail":"janggoons@gmail.com",last_changed:"2015-01-21"},SnapTranslator.dict.pt={language_name:"Portugus",language_translator:"Manuel Menezes de Sequeira","translator_e-mail":"mmsequeira@gmail.com",last_changed:"2016-01-08"},SnapTranslator.dict.cs={language_name:"esky",language_translator:"Michal Moc, Jan Tomsa","translator_e-mail":"info@iguru.eu, jan.tomsa.1976@gmail.com",last_changed:"2015-11-16"},SnapTranslator.dict.zh={language_name:"",language_translator:"/","translator_e-mail":"ubertao@qq.com/djh@rhjxx.cn",last_changed:"2016-05-09"},SnapTranslator.dict.eo={language_name:"Esperanto",language_translator:"Sebastian Cyprych","translator_e-mail":"scy(e)epf.pl",last_changed:"2012-11-11"},SnapTranslator.dict.fr={language_name:"Franais",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2016-02-24"},SnapTranslator.dict.si={language_name:"Slovenina",language_translator:"Sasa Divjak, Gorazd Breskvar","translator_e-mail":"sasa.divjak@fri.uni-lj.si",last_changed:"2016-04-22"},SnapTranslator.dict.ru={language_name:"",language_translator:"Svetlana Ptashnaya,  ","translator_e-mail":"svetlanap@berkeley.edu, tema@school830.ru",last_changed:"2016-05-25"},SnapTranslator.dict.es={language_name:"Espaol",language_translator:"Vctor Manuel Muratalla Morales","translator_e-mail":"victor.muratalla@yahoo.com",last_changed:"2013-03-25"},SnapTranslator.dict.nl={language_name:"Nederlands",language_translator:"Frank Sierens, Sjoerd Dirk Meijer","translator_e-mail":"frank.sierens@telenet.be, sjoerddirk@fromScratchEd.nl",last_changed:"2015-12-15"},SnapTranslator.dict.pl={language_name:"Polski",language_translator:"Witek Kranas","translator_e-mail":"witek@oeiizk.waw.pl",last_changed:"2015-09-23"},SnapTranslator.dict.tw={language_name:"",language_translator:"cch","translator_e-mail":"cchuang2009@gmail.com",last_changed:"2013-8-14"},SnapTranslator.dict.no={language_name:"Norsk",language_translator:"Olav A Marschall","translator_e-mail":"mattebananer@gmail.com",last_changed:"2013-09-16"},SnapTranslator.dict.dk={language_name:"Dansk",language_translator:"FAB","translator_e-mail":"fab@nielsen.mail.dk",last_changed:"2013-09-16"},SnapTranslator.dict.el={language_name:"",language_translator:"Ino Samaras","translator_e-mail":"ino.samaras@berkeley.edu",last_changed:"2013-09-16"},SnapTranslator.dict.ca={language_name:"Catal",language_translator:"Bernat Romagosa Carrasquer, Joan Guilln i Pelegay","translator_e-mail":"bernat@arduino.org, jguille2@xtec.cat",last_changed:"2016-07-07"},SnapTranslator.dict.fi={language_name:"suomi",language_translator:"Jouni K. Seppnen","translator_e-mail":"jks@iki.fi",last_changed:"2014-04-18"},SnapTranslator.dict.sv={language_name:"svenska",language_translator:"Erik A. Olsson","translator_e-mail":"eolsson@gmail.com",last_changed:"2016-06-09"},SnapTranslator.dict.pt_BR={language_name:"Portugus do Brasil",language_translator:"Aldo von Wangenheim","translator_e-mail":"awangenh@inf.ufsc.br",last_changed:"2014-04-20"},SnapTranslator.dict.bn={language_name:"",language_translator:"Dr. Mokter Hossain","translator_e-mail":"mokter@gmail.com",last_changed:"2014-07-02"},SnapTranslator.dict.kn={language_name:"",language_translator:"Vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2014-12-02"},SnapTranslator.dict.ml={language_name:"Malayalam",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},SnapTranslator.dict.ta={language_name:"Tamil",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},SnapTranslator.dict.te={language_name:"Telagu",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},SnapTranslator.dict.tr={language_name:"Trke",language_translator:"Hakan Atas","translator_e-mail":"hakanatas@gmail.com",last_changed:"2015-7-27"},SnapTranslator.dict.hu={language_name:"Magyar",language_translator:"Makny Gyrgy","translator_e-mail":"makany.gyorgy@gmail.com",last_changed:"2015-07-27"},SnapTranslator.dict.ia={language_name:"Interlingua",language_translator:"Ken Dickey","translator_e-mail":"Ken.Dickey@whidbey.com",last_changed:"2015-08-09"},SnapTranslator.dict.hr={language_name:"Hrvatski",language_translator:"eljko Hrvoj","translator_e-mail":"zeljko.hrvoj@zg.t-com.hr",last_changed:"2015-09-15"},SnapTranslator.dict.bg={language_name:"",language_translator:"Ivan Savov","translator_e-mail":"ivan.savov@gmail.com",last_changed:"2015-11-16"},SnapTranslator.dict.ro={language_name:"Romn",language_translator:"Cristian Macarascu","translator_e-mail":"",last_changed:"2015-10-24"},SnapTranslator.dict.ar={language_name:"",language_translator:" ","translator_e-mail":"tarekgalal46@hotmail.com",last_changed:"2016-02-24"},SnapTranslator.dict.id={language_name:"Bahasa Indonesia",language_translator:"Alexander Raphael Liu","translator_e-mail":"raphaxander@gmail.com",last_changed:"2016-5-2"},SnapTranslator.dict.et={language_name:"Eesti",language_translator:"Hasso Tepper","translator_e-mail":"hasso.tepper@gmail.com",last_changed:"2016-05-03"},modules.widgets="2016-July-19";var PushButtonMorph,ToggleButtonMorph,TabMorph,ToggleMorph,ToggleElementMorph,DialogBoxMorph,AlignmentMorph,InputFieldMorph;PushButtonMorph.prototype=new TriggerMorph,PushButtonMorph.prototype.constructor=PushButtonMorph,PushButtonMorph.uber=TriggerMorph.prototype,PushButtonMorph.prototype.fontSize=10,PushButtonMorph.prototype.fontStyle="sans-serif",PushButtonMorph.prototype.labelColor=new Color(0,0,0),PushButtonMorph.prototype.labelShadowColor=new Color(255,255,255),PushButtonMorph.prototype.labelShadowOffset=new Point(1,1),PushButtonMorph.prototype.color=new Color(220,220,220),PushButtonMorph.prototype.pressColor=new Color(115,180,240),PushButtonMorph.prototype.highlightColor=PushButtonMorph.prototype.pressColor.lighter(50),PushButtonMorph.prototype.outlineColor=new Color(30,30,30),PushButtonMorph.prototype.outlineGradient=!1,PushButtonMorph.prototype.contrast=60,PushButtonMorph.prototype.edge=2,PushButtonMorph.prototype.corner=5,PushButtonMorph.prototype.outline=1.00001,PushButtonMorph.prototype.padding=3,PushButtonMorph.prototype.init=function(t,e,o,r,i,n){this.is3D=!1,this.target=t||null,this.action=e||null,this.environment=r||null,this.labelString=o||null,this.label=null,this.labelMinExtent=new Point(0,0),this.hint=i||null,this.template=n||null,TriggerMorph.uber.init.call(this),this.color=PushButtonMorph.prototype.color,this.drawNew(),this.fixLayout()},PushButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var t=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(Math.max(this.label.width(),this.labelMinExtent.x)+t,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+t)),this.label.setCenter(this.center())}},PushButtonMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this),this.label&&this.label.setCenter(this.center().add(1))},PushButtonMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this),this.label&&this.label.setCenter(this.center())},PushButtonMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this),this.label&&this.label.setCenter(this.center())},PushButtonMorph.prototype.outlinePath=BoxMorph.prototype.outlinePath,PushButtonMorph.prototype.drawOutline=function(t){var e,o=MorphicPreferences.isFlat&&!this.is3D;return!this.outline||o?null:(this.outlineGradient?(e=t.createLinearGradient(0,0,0,this.height()),e.addColorStop(0,this.outlineColor.darker().toString()),e.addColorStop(1,"white")):e=this.outlineColor.toString(),t.fillStyle=e,t.beginPath(),this.outlinePath(t,o?0:this.corner,0),t.closePath(),void t.fill())},PushButtonMorph.prototype.drawBackground=function(t,e){var o=MorphicPreferences.isFlat&&!this.is3D;t.fillStyle=e.toString(),t.beginPath(),this.outlinePath(t,o?0:Math.max(this.corner-this.outline,0),this.outline),t.closePath(),t.fill(),t.lineWidth=this.outline},PushButtonMorph.prototype.drawEdges=function(t,e,o,r){if(!MorphicPreferences.isFlat||this.is3D){var i,n=Math.max(this.corner,this.outline+this.edge),s=this.width(),a=this.height();i=t.createLinearGradient(0,this.outline,0,this.outline+this.edge),i.addColorStop(0,o.toString()),i.addColorStop(1,e.toString()),t.strokeStyle=i,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(n,this.outline+this.edge/2),t.lineTo(s-n,this.outline+this.edge/2),t.stroke(),i=t.createRadialGradient(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge,0),this.corner,this.corner,Math.max(this.corner-this.outline,0)),i.addColorStop(0,e.toString()),i.addColorStop(1,o.toString()),t.strokeStyle=i,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(180),radians(270),!1),t.stroke(),i=t.createLinearGradient(this.outline,0,this.outline+this.edge,0),i.addColorStop(0,o.toString()),i.addColorStop(1,e.toString()),t.strokeStyle=i,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(this.outline+this.edge/2,n),t.lineTo(this.outline+this.edge/2,a-n),t.stroke(),i=t.createLinearGradient(0,a-this.outline,0,a-this.outline-this.edge),i.addColorStop(0,r.toString()),i.addColorStop(1,e.toString()),t.strokeStyle=i,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(n,a-this.outline-this.edge/2),t.lineTo(s-n,a-this.outline-this.edge/2),t.stroke(),i=t.createRadialGradient(s-this.corner,a-this.corner,Math.max(this.corner-this.outline-this.edge,0),s-this.corner,a-this.corner,Math.max(this.corner-this.outline,0)),i.addColorStop(0,e.toString()),i.addColorStop(1,r.toString()),t.strokeStyle=i,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(s-this.corner,a-this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(0),radians(90),!1),t.stroke(),i=t.createLinearGradient(s-this.outline,0,s-this.outline-this.edge,0),i.addColorStop(0,r.toString()),i.addColorStop(1,e.toString()),t.strokeStyle=i,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(s-this.outline-this.edge/2,n),t.lineTo(s-this.outline-this.edge/2,a-n),t.stroke()}},PushButtonMorph.prototype.createBackgrounds=function(){var t,e=this.extent();return this.template?(this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null):(this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.color),this.drawEdges(t,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.highlightColor),this.drawEdges(t,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast)),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.darker(this.contrast),this.pressColor.lighter(this.contrast)),void(this.image=this.normalImage))},PushButtonMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;null!==this.label&&this.label.destroy(),this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),t&&(this.label.shadowOffset=this.labelShadowOffset,this.label.shadowColor=this.labelShadowColor),this.label.color=this.labelColor,this.label.drawNew()):this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.add(this.label)},ToggleButtonMorph.prototype=new PushButtonMorph,ToggleButtonMorph.prototype.constructor=ToggleButtonMorph,ToggleButtonMorph.uber=PushButtonMorph.prototype,ToggleButtonMorph.prototype.contrast=30,ToggleButtonMorph.prototype.init=function(t,e,o,r,i,n,s,a,h,l,p){this.state=!1,this.query=i||function(){return!0},this.minWidth=h||null,this.hasPreview=l||!1,this.isPicture=p||!1,this.trueStateLabel=null,ToggleButtonMorph.uber.init.call(this,e,o,r,n,s,a),t&&(this.color=t[0],this.highlightColor=t[1],this.pressColor=t[2]),this.refresh(),this.drawNew()},ToggleButtonMorph.prototype.mouseEnter=function(){var t=this.hint instanceof Function?this.hint():this.hint;this.state||(this.image=this.highlightImage,this.changed()),t&&this.bubbleHelp(t)},ToggleButtonMorph.prototype.mouseLeave=function(){this.state||(this.image=this.normalImage,this.changed()),this.hint&&this.world().hand.destroyTemporaries()},ToggleButtonMorph.prototype.mouseDownLeft=function(){this.state||(this.image=this.pressImage,this.changed())},ToggleButtonMorph.prototype.mouseClickLeft=function(){this.state||(this.image=this.highlightImage,this.changed()),this.trigger()},ToggleButtonMorph.prototype.trigger=function(){ToggleButtonMorph.uber.trigger.call(this),this.refresh()},ToggleButtonMorph.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?(this.image=this.pressImage,this.trueStateLabel&&(this.label.hide(),this.trueStateLabel.show())):(this.image=this.normalImage,this.trueStateLabel&&(this.label.show(),this.trueStateLabel.hide())),this.changed()},ToggleButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var t=Math.max(this.label.width(),this.labelMinExtent.x),e=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(this.minWidth?Math.max(this.minWidth,t)+e:t+e,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+e)),this.label.setCenter(this.center()),this.trueStateLabel&&this.trueStateLabel.setCenter(this.center()),this.minWidth&&this.label.setLeft(this.left()+this.outline+this.edge+this.corner+this.padding)}},ToggleButtonMorph.prototype.createBackgrounds=function(){var t,e=this.extent();return this.template?(this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null):(this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.color),this.drawEdges(t,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.highlightColor),this.drawEdges(t,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast)),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40)),void(this.image=this.normalImage))},ToggleButtonMorph.prototype.drawEdges=function(t,e,o,r){var i;if(ToggleButtonMorph.uber.drawEdges.call(this,t,e,o,r),this.hasPreview){if(MorphicPreferences.isFlat&&!this.is3D)return t.fillStyle=this.pressColor.toString(),void t.fillRect(this.outline,this.outline,this.corner,this.height()-2*this.outline);i=t.createLinearGradient(0,0,this.corner,0),i.addColorStop(0,this.pressColor.lighter(40).toString()),i.addColorStop(1,this.pressColor.darker(40).toString()),t.fillStyle=i,t.beginPath(),this.previewPath(t,Math.max(this.corner-this.outline,0),this.outline),t.closePath(),t.fill()}},ToggleButtonMorph.prototype.previewPath=function(t,e,o){var r=e+o,i=this.height();t.arc(r,r,e,radians(-180),radians(-90),!1),t.arc(r,i-r,e,radians(90),radians(180),!1)},ToggleButtonMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D,e=new Point;null!==this.label&&this.label.destroy(),null!==this.trueStateLabel&&this.trueStateLabel.destroy(),this.labelString instanceof Array&&2===this.labelString.length?this.labelString[0]instanceof SymbolMorph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy(),this.isPicture||(this.label.shadowOffset=t?this.labelShadowOffset:e,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew(),this.trueStateLabel.shadowOffset=t?this.labelShadowOffset:e,this.trueStateLabel.shadowColor=this.labelShadowColor,this.trueStateLabel.color=this.labelColor,this.trueStateLabel.drawNew())):this.labelString[0]instanceof Morph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy()):(this.label=new StringMorph(localize(this.labelString[0]),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.trueStateLabel=new StringMorph(localize(this.labelString[1]),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor)):this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),this.isPicture||(this.label.shadowOffset=t?this.labelShadowOffset:e,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew())):this.labelString instanceof Morph?this.label=this.labelString.fullCopy():this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:e,this.labelShadowColor,this.labelColor),this.add(this.label),this.trueStateLabel&&this.add(this.trueStateLabel)},ToggleButtonMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},ToggleButtonMorph.prototype.show=function(){this.isVisible=!0,this.changed()},TabMorph.prototype=new ToggleButtonMorph,TabMorph.prototype.constructor=TabMorph,TabMorph.uber=ToggleButtonMorph.prototype,TabMorph.prototype.fixLayout=function(){null!==this.label&&(this.setExtent(new Point(this.label.width()+2*this.padding+3*this.corner+2*this.edge,(this.label instanceof StringMorph?this.label.rawHeight():this.label.height())+2*this.padding+this.edge)),this.label.setCenter(this.center()))},TabMorph.prototype.refresh=function(){this.state&&this.parent&&this.parent.add(this),TabMorph.uber.refresh.call(this)},TabMorph.prototype.drawBackground=function(t,e){var o=this.width(),r=this.height(),i=this.corner;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,r),t.bezierCurveTo(i,r,i,0,2*i,0),t.lineTo(o-2*i,0),t.bezierCurveTo(o-i,0,o-i,r,o,r),t.closePath(),t.fill()},TabMorph.prototype.drawOutline=function(){nop()},TabMorph.prototype.drawEdges=function(t,e,o,r){if(!MorphicPreferences.isFlat||this.is3D){var i,n=this.width(),s=this.height(),a=this.corner,h=this.edge,l=h/2;nop(e),i=t.createLinearGradient(0,0,n,0),i.addColorStop(0,o.toString()),i.addColorStop(1,r.toString()),t.strokeStyle=i,t.lineCap="round",t.lineWidth=h,t.beginPath(),t.moveTo(0,s+l),t.bezierCurveTo(a,s,a,0,2*a,l),t.lineTo(n-2*a,l),t.bezierCurveTo(n-a,0,n-a,s,n,s+l),t.stroke()}},ToggleMorph.prototype=new PushButtonMorph,ToggleMorph.prototype.constructor=ToggleMorph,ToggleMorph.uber=PushButtonMorph.prototype,ToggleMorph.prototype.init=function(t,e,o,r,i,n,s,a,h,l){this.padding=1,t=t||"checkbox",this.corner="checkbox"===t?0:fontHeight(this.fontSize)/2+this.outline+this.padding,this.state=!1,this.query=i||function(){return!0},this.tick=null,this.captionString=r||null,this.labelAlignment="right",this.element=h||null,this.builder=l||null,this.toggleElement=null,ToggleMorph.uber.init.call(this,e,o,"checkbox"===t?"":"",n,s,a),this.refresh(),this.drawNew()},ToggleMorph.prototype.fixLayout=function(){var t,e=2*this.padding+2*this.outline;null!==this.tick&&(this.silentSetHeight(this.tick.rawHeight()+e),this.silentSetWidth(this.tick.width()+e),this.setExtent(new Point(Math.max(this.width(),this.height()),Math.max(this.width(),this.height()))),this.tick.setCenter(this.center())),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&"right"===this.labelAlignment&&(t=this.top()+(this.height()-this.toggleElement.height())/2,this.toggleElement.setPosition(new Point(this.right()+e,t))),null!==this.label&&(t=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.toggleElement?this.toggleElement instanceof ToggleElementMorph?this.toggleElement.right():this.toggleElement.right()+e:this.right()+e,t)):this.label.setPosition(new Point(this.left()-this.label.width()-e,t)))},ToggleMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;null===this.label&&this.captionString&&(this.label=new TextMorph(localize(this.captionString),this.fontSize,this.fontStyle,!0),this.add(this.label)),null===this.tick&&(this.tick=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?new Point(1,1):null,new Color(240,240,240)),this.add(this.tick)),null===this.toggleElement&&this.element&&(this.element instanceof Morph?this.toggleElement=new ToggleElementMorph(this.target,this.action,this.element,this.query,this.environment,this.hint,this.builder):this.element instanceof HTMLCanvasElement&&(this.toggleElement=new Morph,this.toggleElement.silentSetExtent(new Point(this.element.width,this.element.height)),this.toggleElement.image=this.element),this.add(this.toggleElement))},ToggleMorph.prototype.trigger=function(){ToggleMorph.uber.trigger.call(this),this.refresh()},ToggleMorph.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&this.toggleElement.refresh&&this.toggleElement.refresh()},ToggleMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this),this.tick&&this.tick.setCenter(this.center().add(1))},ToggleMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this),this.tick&&this.tick.setCenter(this.center())},ToggleMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this),this.tick&&this.tick.setCenter(this.center())},ToggleMorph.prototype.hide=ToggleButtonMorph.prototype.hide,ToggleMorph.prototype.show=ToggleButtonMorph.prototype.show,ToggleElementMorph.prototype=new TriggerMorph,ToggleElementMorph.prototype.constructor=ToggleElementMorph,ToggleElementMorph.uber=TriggerMorph.prototype,ToggleElementMorph.prototype.contrast=50,ToggleElementMorph.prototype.shadowOffset=new Point(2,2),ToggleElementMorph.prototype.shadowAlpha=.6,ToggleElementMorph.prototype.fontSize=10,ToggleElementMorph.prototype.inactiveColor=new Color(180,180,180),ToggleElementMorph.prototype.init=function(t,e,o,r,i,n,s,a){this.target=t||null,this.action=e||null,this.element=o,this.query=r||function(){return!0},this.environment=i||null,this.hint=n||null,this.builder=s||"nop",this.captionString=a||null,this.labelAlignment="right",this.state=!1,TriggerMorph.uber.init.call(this),this.color=o.color,this.createLabel()},ToggleElementMorph.prototype.createBackgrounds=function(){var t=!MorphicPreferences.isFlat||this.is3D;this.color=this.element.color,this.element.removeShadow(),this.element[this.builder](),t&&this.element.addShadow(this.shadowOffset,this.shadowAlpha),this.silentSetExtent(this.element.fullBounds().extent()),this.pressImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.inactiveColor),this.element[this.builder](this.contrast),t&&this.element.addShadow(this.shadowOffset,0),this.normalImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.color.lighter(this.contrast)),this.element[this.builder](this.contrast),t&&this.element.addShadow(this.shadowOffset,this.shadowAlpha),this.highlightImage=this.element.fullImage(),this.element.removeShadow(),this.element.setColor(this.color),this.element[this.builder](),this.image=this.normalImage},ToggleElementMorph.prototype.setColor=function(t){this.element.setColor(t),this.createBackgrounds(),this.refresh()},ToggleElementMorph.prototype.createLabel=function(){var t;this.captionString&&(this.label=new StringMorph(this.captionString,this.fontSize,this.fontStyle,!0),this.add(this.label),t=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.right(),t)):this.label.setPosition(new Point(this.left()-this.label.width(),t)))},ToggleElementMorph.prototype.trigger=ToggleButtonMorph.prototype.trigger,ToggleElementMorph.prototype.refresh=ToggleButtonMorph.prototype.refresh,ToggleElementMorph.prototype.mouseEnter=ToggleButtonMorph.prototype.mouseEnter,ToggleElementMorph.prototype.mouseLeave=ToggleButtonMorph.prototype.mouseLeave,ToggleElementMorph.prototype.mouseDownLeft=ToggleButtonMorph.prototype.mouseDownLeft,ToggleElementMorph.prototype.mouseClickLeft=ToggleButtonMorph.prototype.mouseClickLeft,DialogBoxMorph.prototype=new Morph,DialogBoxMorph.prototype.constructor=DialogBoxMorph,DialogBoxMorph.uber=Morph.prototype,DialogBoxMorph.prototype.fontSize=12,DialogBoxMorph.prototype.titleFontSize=14,DialogBoxMorph.prototype.fontStyle="sans-serif",DialogBoxMorph.prototype.color=PushButtonMorph.prototype.color,DialogBoxMorph.prototype.titleTextColor=new Color(255,255,255),DialogBoxMorph.prototype.titleBarColor=PushButtonMorph.prototype.pressColor,DialogBoxMorph.prototype.contrast=40,DialogBoxMorph.prototype.corner=12,DialogBoxMorph.prototype.padding=14,DialogBoxMorph.prototype.titlePadding=6,DialogBoxMorph.prototype.buttonContrast=50,DialogBoxMorph.prototype.buttonFontSize=12,DialogBoxMorph.prototype.buttonCorner=12,DialogBoxMorph.prototype.buttonEdge=6,DialogBoxMorph.prototype.buttonPadding=0,DialogBoxMorph.prototype.buttonOutline=3,DialogBoxMorph.prototype.buttonOutlineColor=PushButtonMorph.prototype.color,DialogBoxMorph.prototype.buttonOutlineGradient=!0,DialogBoxMorph.prototype.instances={},DialogBoxMorph.prototype.init=function(t,e,o){this.is3D=!1,this.target=t||null,this.action=e||null,this.environment=o||null,this.key=null,this.labelString=null,this.label=null,this.head=null,this.body=null,this.buttons=null,DialogBoxMorph.uber.init.call(this),this.isDraggable=!0,this.color=PushButtonMorph.prototype.color,this.createLabel(),this.createButtons(),this.setExtent(new Point(300,150))},DialogBoxMorph.prototype.inform=function(t,e,o,r){var i=new TextMorph(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="inform"+t+e),this.labelString=t,this.createLabel(),r&&this.setPicture(r),e&&this.addBody(i),this.addButton("ok","OK"),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.askYesNo=function(t,e,o,r){var i=new TextMorph(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="decide"+t+e),this.labelString=t,this.createLabel(),r&&this.setPicture(r),this.addBody(i),this.addButton("ok","Yes"),this.addButton("cancel","No"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.prompt=function(t,e,o,r,i,n,s,a,h,l){var p,c,d=new InputFieldMorph(e,s||!1,i||null,!!i&&(n||!1));d.setWidth(250),s?(r&&(c=new AlignmentMorph("column",this.padding),r.setPosition(c.position()),c.add(r)),isNil(a)||isNil(h)||(p=new SliderMorph(100*a,100*h,100*parseFloat(e),(h-a)/10*100,"horizontal"),p.alpha=1,p.color=this.color.lighter(50),p.setHeight(.7*d.height()),p.setWidth(d.width()),p.action=function(t){l&&l(t/100),d.setContents(t/100),d.edit()},c||(c=new AlignmentMorph("column",this.padding)),c.add(p)),c&&(c.fixLayout(),this.setPicture(c),c.fixLayout())):r&&this.setPicture(r),this.reactToChoice=function(t){p&&(p.value=100*t,p.drawNew(),p.changed()),l&&l(t)},d.reactToKeystroke=function(){var t=d.getValue();p&&(t=Math.max(t,a),p.value=100*t,p.drawNew(),p.changed()),l&&l(t)},this.labelString=t,this.createLabel(),this.key||(this.key="prompt"+t+e),this.addBody(d),d.drawNew(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o)},DialogBoxMorph.prototype.promptCode=function(t,e,o,r,i){function n(t){return new TextMorph(localize(t),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}var s=new ScrollFrameMorph,a=new TextMorph(e||""),h=new AlignmentMorph("column",this.padding),l=r?Math.max(r.width,400):400;this.getInput=function(){return a.text},s.padding=6,s.setWidth(l),s.acceptsDrops=!1,s.contents.acceptsDrops=!1,a.fontName="monospace",a.fontStyle="monospace",a.fontSize=11,a.setPosition(s.topLeft().add(s.padding)),a.enableSelecting(),a.isEditable=!0,s.setHeight(l/4),s.fixLayout=nop,s.edge=InputFieldMorph.prototype.edge,s.fontSize=InputFieldMorph.prototype.fontSize,s.typeInPadding=InputFieldMorph.prototype.typeInPadding,s.contrast=InputFieldMorph.prototype.contrast,s.drawNew=InputFieldMorph.prototype.drawNew,s.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,s.addContents(a),a.drawNew(),r&&this.setPicture(r),this.labelString=t,this.createLabel(),this.key||(this.key="promptCode"+t+e),h.setColor(this.color),h.add(s),i&&h.add(n(i)),h.fixLayout(),this.addBody(h),s.drawNew(),h.drawNew(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o),a.edit()},DialogBoxMorph.prototype.promptVector=function(t,e,o,r,i,n,s,a){function h(t){return new TextMorph(localize(t),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}var l=new AlignmentMorph("row",4),p=new InputFieldMorph(e.x.toString(),!0),c=new InputFieldMorph(e.y.toString(),!0),d=new AlignmentMorph("column",2),u=new AlignmentMorph("column",2),g=new AlignmentMorph("column",2),f=new AlignmentMorph("column",this.padding);
g.alignment="left",g.setColor(this.color),f.setColor(this.color),d.alignment="left",d.setColor(this.color),u.alignment="left",u.setColor(this.color),d.add(h(r)),d.add(p),u.add(h(i)),u.add(c),l.add(d),l.add(u),g.add(l),a&&f.add(h(a)),f.add(g),l.fixLayout(),d.fixLayout(),u.fixLayout(),g.fixLayout(),f.fixLayout(),this.labelString=t,this.createLabel(),s&&this.setPicture(s),this.addBody(f),l.drawNew(),d.drawNew(),p.drawNew(),u.drawNew(),c.drawNew(),f.fixLayout(),this.addButton("ok","OK"),o instanceof Point&&this.addButton(function(){p.setContents(o.x.toString()),c.setContents(o.y.toString())},"Default"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.edit=function(){p.edit()},this.getInput=function(){return new Point(p.getValue(),c.getValue())},this.key||(this.key="vector"+t),this.popUp(n)},DialogBoxMorph.prototype.promptCredentials=function(t,e,o,r,i,n,s,a,h,l){function p(t){return new TextMorph(localize(t),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}function c(t,e){var o=new PushButtonMorph(R,function(){window.open(e)},"  "+localize(t)+"  ");return o.fontSize=10,o.corner=R.buttonCorner,o.edge=R.buttonEdge,o.outline=R.buttonOutline,o.outlineColor=R.buttonOutlineColor,o.outlineGradient=R.buttonOutlineGradient,o.padding=R.buttonPadding,o.contrast=R.buttonContrast,o.drawNew(),o.fixLayout(),o}function d(){var t,e,o=(new Date).getFullYear()+(new Date).getMonth()/12,r=+f.getValue()||0,i=g.getValue();return i instanceof Array&&(i=i[0]),isNaN(r)&&(r=0),t=["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(i),isNaN(t)&&(t=0),e=r+t/12,o-e}function u(){function t(t,e){var o=new SpeechBubbleMorph(localize(e));o.isPointingRight=!1,o.drawNew(),o.popUp(a,t.leftCenter().subtract(new Point(o.width()+2,0))),t.edit&&t.edit()}var o,r,i=b.getValue();if("login"===e?o=[M,w]:"signup"===e?o=[M,g,f,b]:"changePassword"===e?o=[C,w,S]:"resetPassword"===e&&(o=[M]),r=detect(o,function(t){return!t.getValue()}))return t(r,"please fill out\nthis field"),!1;if("signup"===e){if(M.getValue().length<4)return t(M,"User name must be four\ncharacters or longer"),!1;if(i.indexOf(" ")>-1||i.indexOf("@")===-1||i.indexOf(".")===-1)return t(b,"please provide a valid\nemail address"),!1}if("changePassword"===e){if(w.getValue().length<6)return t(w,"password must be six\ncharacters or longer"),!1;if(w.getValue()!==S.getValue())return t(S,"passwords do\nnot match"),!1}return!("signup"===e&&!v)||(t(y,"please agree to\nthe TOS"),!1)}var g,f,m,y,M=new InputFieldMorph,b=new InputFieldMorph,w=new InputFieldMorph,S=new InputFieldMorph,C=new InputFieldMorph,v=!1,x=new AlignmentMorph("row",4),k=new AlignmentMorph("column",2),B=new AlignmentMorph("column",2),P=new AlignmentMorph("column",2),T=new AlignmentMorph("row",4),I=new AlignmentMorph("column",this.padding),L={},E=(new Date).getFullYear(),D=E-20,R=this;for(g=new InputFieldMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0),E;E>D;E-=1)L[E.toString()+" "]=E;L[D+" "+localize("or before")]="< "+E,f=new InputFieldMorph(null,!1,L,!0),P.alignment="left",P.setColor(this.color),I.setColor(this.color),k.alignment="left",k.setColor(this.color),B.alignment="left",B.setColor(this.color),M.setWidth(200),g.setWidth(100),f.contents().minWidth=80,f.setWidth(80),b.setWidth(200),w.setWidth(200),S.setWidth(200),C.setWidth(200),w.contents().text.toggleIsPassword(),S.contents().text.toggleIsPassword(),C.contents().text.toggleIsPassword(),"login"===e&&(P.add(p("User name:")),P.add(M)),"signup"===e&&(P.add(p("User name:")),P.add(M),k.add(p("Birth date:")),k.add(g),B.add(p("year:")),B.add(f),x.add(k),x.add(B),P.add(x),m=p("foo"),P.add(m),P.add(b)),"login"===e&&(P.add(p("Password:")),P.add(w)),"changePassword"===e&&(P.add(p("Old password:")),P.add(C),P.add(p("New password:")),P.add(w),P.add(p("Repeat new password:")),P.add(S)),"resetPassword"===e&&(P.add(p("User name:")),P.add(M)),l&&I.add(p(l)),I.add(P),(o||i)&&I.add(T),o&&T.add(c(r,o)),i&&T.add(c(n,i)),s&&(y=new ToggleMorph("checkbox",this,function(){v=!v},s,function(){return v}),y.edge=this.buttonEdge/2,y.outline=this.buttonOutline/2,y.outlineColor=this.buttonOutlineColor,y.outlineGradient=this.buttonOutlineGradient,y.contrast=this.buttonContrast,y.drawNew(),y.fixLayout(),I.add(y)),x.fixLayout(),k.fixLayout(),B.fixLayout(),P.fixLayout(),T.fixLayout(),I.fixLayout(),this.labelString=t,this.createLabel(),h&&this.setPicture(h),this.addBody(I),M.drawNew(),x.drawNew(),k.drawNew(),g.drawNew(),B.drawNew(),f.drawNew(),w.drawNew(),S.drawNew(),C.drawNew(),b.drawNew(),I.fixLayout(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.accept=function(){u()&&DialogBoxMorph.prototype.accept.call(R)},this.edit=function(){"changePassword"===e?C.edit():M.edit()},this.getInput=function(){return{username:M.getValue(),email:b.getValue(),oldpassword:C.getValue(),password:w.getValue(),choice:v}},this.reactToChoice=function(){"signup"===e&&(m.changed(),m.text=d()<=13?"E-mail address of parent or guardian:":"E-mail address:",m.text=localize(m.text),m.drawNew(),m.changed())},this.reactToChoice(),this.key||(this.key="credentials"+t+e),this.popUp(a)},DialogBoxMorph.prototype.accept=function(){this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),this.destroy()},DialogBoxMorph.prototype.withKey=function(t){return this.key=t,this},DialogBoxMorph.prototype.popUp=function(t){t&&(this.key&&(this.instances[t.stamp]?(this.instances[t.stamp][this.key]&&this.instances[t.stamp][this.key].destroy(),this.instances[t.stamp][this.key]=this):(this.instances[t.stamp]={},this.instances[t.stamp][this.key]=this)),t.add(this),t.keyboardReceiver=this,this.setCenter(t.center()),this.edit())},DialogBoxMorph.prototype.destroy=function(){DialogBoxMorph.uber.destroy.call(this),this.key&&delete this.instances[this.key]},DialogBoxMorph.prototype.ok=function(){this.accept()},DialogBoxMorph.prototype.cancel=function(){this.destroy()},DialogBoxMorph.prototype.edit=function(){this.children.forEach(function(t){if(t.edit)return t.edit()})},DialogBoxMorph.prototype.getInput=function(){return this.body instanceof InputFieldMorph?this.body.getValue():null},DialogBoxMorph.prototype.justDropped=function(t){t.world.keyboardReceiver=this,this.edit()},DialogBoxMorph.prototype.destroy=function(){var t=this.world();t.keyboardReceiver=null,t.hand.destroyTemporaries(),DialogBoxMorph.uber.destroy.call(this)},DialogBoxMorph.prototype.normalizeSpaces=function(t){var e,o,r="",i=!1;for(e=0;e<t.length;e+=1)o=t[e]," "===o?i&&(r+=o,i=!1):(r+=o,i=!0);return r.trim()},DialogBoxMorph.prototype.createLabel=function(){var t=!MorphicPreferences.isFlat||this.is3D;this.label&&this.label.destroy(),this.labelString&&(this.label=new StringMorph(localize(this.labelString),this.titleFontSize,this.fontStyle,!0,!1,!1,t?new Point(2,1):null,this.titleBarColor.darker(this.contrast)),this.label.color=this.titleTextColor,this.label.drawNew(),this.add(this.label))},DialogBoxMorph.prototype.createButtons=function(){this.buttons&&this.buttons.destroy(),this.buttons=new AlignmentMorph("row",this.padding),this.add(this.buttons)},DialogBoxMorph.prototype.addButton=function(t,e){var o=new PushButtonMorph(this,t||"ok","  "+localize(e||"OK")+"  ");return o.fontSize=this.buttonFontSize,o.corner=this.buttonCorner,o.edge=this.buttonEdge,o.outline=this.buttonOutline,o.outlineColor=this.buttonOutlineColor,o.outlineGradient=this.buttonOutlineGradient,o.padding=this.buttonPadding,o.contrast=this.buttonContrast,o.drawNew(),o.fixLayout(),this.buttons.add(o),o},DialogBoxMorph.prototype.setPicture=function(t){var e;t instanceof Morph?e=t:(e=new Morph,e.image=t,e.silentSetWidth(t.width),e.silentSetHeight(t.height)),this.addHead(e)},DialogBoxMorph.prototype.addHead=function(t){this.head&&this.head.destroy(),this.head=t,this.add(this.head)},DialogBoxMorph.prototype.addBody=function(t){this.body&&this.body.destroy(),this.body=t,this.add(this.body)},DialogBoxMorph.prototype.addShadow=function(){nop()},DialogBoxMorph.prototype.removeShadow=function(){nop()},DialogBoxMorph.prototype.fixLayout=function(){var t,e=fontHeight(this.titleFontSize)+2*this.titlePadding;this.head&&(this.head.setPosition(this.position().add(new Point(this.padding,e+this.padding))),this.silentSetWidth(this.head.width()+2*this.padding),this.silentSetHeight(this.head.height()+2*this.padding+e)),this.body&&(this.head?(this.body.setPosition(this.head.bottomLeft().add(new Point(0,this.padding))),this.silentSetWidth(Math.max(this.width(),this.body.width()+2*this.padding)),this.silentSetHeight(this.height()+this.body.height()+this.padding),t=this.width(),this.head.setLeft(this.left()+Math.round((t-this.head.width())/2)),this.body.setLeft(this.left()+Math.round((t-this.body.width())/2))):(this.body.setPosition(this.position().add(new Point(this.padding,e+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+e))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(e-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.buttons.width()+2*this.padding)),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},DialogBoxMorph.prototype.shadowImage=function(t,e){var o,r,i,n,s,a=t||new Point(7,7),h=e||new Color(0,0,0);return o=this.extent(),r=this.image,i=newCanvas(o),s=i.getContext("2d"),s.drawImage(r,0,0),s.globalCompositeOperation="destination-out",s.drawImage(r,-a.x,-a.y),n=newCanvas(o),s=n.getContext("2d"),s.drawImage(i,0,0),s.globalCompositeOperation="source-atop",s.fillStyle=h.toString(),s.fillRect(0,0,o.x,o.y),n},DialogBoxMorph.prototype.shadowImageBlurred=function(t,e){var o,r,i,n,s=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return o=this.extent().add(2*a),r=this.image,i=newCanvas(o),n=i.getContext("2d"),n.shadowOffsetX=s.x,n.shadowOffsetY=s.y,n.shadowBlur=a,n.shadowColor=h.toString(),n.drawImage(r,a-s.x,a-s.y),n.shadowOffsetX=0,n.shadowOffsetY=0,n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(r,a-s.x,a-s.y),i},DialogBoxMorph.prototype.processKeyPress=function(){nop()},DialogBoxMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:this.ok();break;case 27:this.cancel();break;default:nop()}},DialogBoxMorph.prototype.drawNew=function(){this.fullChanged(),Morph.prototype.trackChanges=!1,DialogBoxMorph.uber.removeShadow.call(this),this.fixLayout();var t,e,o,r,i=this.width(),n=this.height(),s=Math.floor(fontHeight(this.titleFontSize)+2*this.titlePadding),a=this.corner/2,h=MorphicPreferences.isFlat&&!this.is3D;return this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),h?t.fillStyle=this.titleBarColor.toString():(e=t.createLinearGradient(0,0,0,s),e.addColorStop(0,this.titleBarColor.lighter(this.contrast/2).toString()),e.addColorStop(1,this.titleBarColor.darker(this.contrast).toString()),t.fillStyle=e),t.beginPath(),this.outlinePathTitle(t,h?0:this.corner),t.closePath(),t.fill(),t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePathBody(t,h?0:this.corner),t.closePath(),t.fill(),h?(DialogBoxMorph.uber.addShadow.call(this),Morph.prototype.trackChanges=!0,void this.fullChanged()):(e=t.createLinearGradient(0,n-this.corner,0,n),e.addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineWidth=this.corner,t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner,n-a),t.lineTo(this.corner+1,n-a),t.stroke(),e=t.createLinearGradient(0,n-this.corner,0,n),e.addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineWidth=this.corner,t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner,n-a),t.lineTo(i-this.corner,n-a),t.stroke(),e=t.createLinearGradient(i-this.corner,0,i,0),e.addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast).toString()),t.lineWidth=this.corner,t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(i-a,s),t.lineTo(i-a,n-this.corner),t.stroke(),o=i-this.corner,r=n-this.corner,e=t.createRadialGradient(o,r,0,o,r,this.corner),e.addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.arc(o,r,a,radians(90),radians(0),!0),t.stroke(),e=t.createLinearGradient(0,0,this.corner,0),e.addColorStop(0,this.color.lighter(this.contrast).toString()),e.addColorStop(1,this.color.toString()),t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(a,s),t.lineTo(a,n-2*this.corner),t.stroke(),e=t.createLinearGradient(0,0,this.corner,0),e.addColorStop(0,this.color.lighter(this.contrast).toString()),e.addColorStop(1,this.color.toString()),t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(a,n-2*this.corner),t.lineTo(a,n-this.corner-a),t.stroke(),DialogBoxMorph.uber.addShadow.call(this),Morph.prototype.trackChanges=!0,void this.fullChanged())},DialogBoxMorph.prototype.outlinePathTitle=function(t,e){var o=this.width(),r=Math.ceil(fontHeight(this.titleFontSize))+2*this.titlePadding;t.arc(e,e,e,radians(-180),radians(-90),!1),t.arc(o-e,e,e,radians(-90),radians(-0),!1),t.lineTo(o,r),t.lineTo(0,r)},DialogBoxMorph.prototype.outlinePathBody=function(t,e){var o=this.width(),r=this.height(),i=Math.floor(fontHeight(this.titleFontSize))+2*this.titlePadding;t.moveTo(0,i),t.lineTo(o,i),t.arc(o-e,r-e,e,radians(0),radians(90),!1),t.arc(e,r-e,e,radians(90),radians(180),!1)},AlignmentMorph.prototype=new Morph,AlignmentMorph.prototype.constructor=AlignmentMorph,AlignmentMorph.uber=Morph.prototype,AlignmentMorph.prototype.init=function(t,e){this.orientation=t||"row",this.alignment="center",this.padding=e||0,this.respectHiddens=!1,AlignmentMorph.uber.init.call(this)},AlignmentMorph.prototype.drawNew=function(){this.image=newCanvas(new Point(1,1)),this.fixLayout()},AlignmentMorph.prototype.fixLayout=function(){var t,e=this,o=null;return 0===this.children.length?null:(this.children.forEach(function(r){var i,n=r.fullBounds();(r.isVisible||e.respectHiddens)&&(o?(i=o.fullBounds(),"row"===e.orientation?r.setPosition(i.topRight().add(new Point(e.padding,(i.height()-n.height())/2))):r.setPosition(i.bottomLeft().add(new Point("center"===e.alignment?(i.width()-n.width())/2:0,e.padding))),n=r.fullBounds(),t=t.merge(n)):t=n,o=r)}),void(this.bounds=t))},InputFieldMorph.prototype=new Morph,InputFieldMorph.prototype.constructor=InputFieldMorph,InputFieldMorph.uber=Morph.prototype,InputFieldMorph.prototype.edge=2,InputFieldMorph.prototype.fontSize=12,InputFieldMorph.prototype.typeInPadding=2,InputFieldMorph.prototype.contrast=65,InputFieldMorph.prototype.init=function(t,e,o,r){var i=new StringFieldMorph(t||""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));this.choices=o||null,this.isReadOnly=r||!1,this.isNumeric=e||!1,i.alpha=0,i.fontSize=this.fontSize,i.drawNew(),this.oldContentsExtent=i.extent(),this.isNumeric=e||!1,InputFieldMorph.uber.init.call(this),this.color=new Color(255,255,255),this.add(i),this.add(n),i.isDraggable=!1,this.drawNew()},InputFieldMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof StringFieldMorph})},InputFieldMorph.prototype.arrow=function(){return detect(this.children,function(t){return t instanceof ArrowMorph})},InputFieldMorph.prototype.setChoice=function(t){this.setContents(t),this.escalateEvent("reactToChoice",t)},InputFieldMorph.prototype.setContents=function(t){var e=this.contents();return e.text.text=t,void 0===t?null:(null===t?e.text.text="":t.toString&&(e.text.text=t.toString()),e.drawNew(),void e.changed())},InputFieldMorph.prototype.edit=function(){var t=this.contents();t.text.edit(),t.text.selectAll()},InputFieldMorph.prototype.setIsNumeric=function(t){var e;this.isNumeric=t,this.contents().isNumeric=t,this.contents().text.isNumeric=t,e=this.getValue(),this.isNumeric&&(e=parseFloat(e),isNaN(e)&&(e=null)),this.setContents(e)},InputFieldMorph.prototype.dropDownMenu=function(){var t,e=this.choices,o=new MenuMorph(this.setChoice,null,this,this.fontSize);if(e instanceof Function?e=e.call(this):isString(e)&&(e=this[e]()),!e)return null;if(o.addItem(" ",null),e instanceof Array)e.forEach(function(t){o.addItem(t[0],t[1])});else for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&("~"===t[0]?o.addLine():o.addItem(t,e[t]));return o.items.length>0?void o.popUpAtHand(this.world()):null},InputFieldMorph.prototype.fixLayout=function(){var t=this.contents(),e=this.arrow();return t?(t.isNumeric=this.isNumeric,t.isEditable=!this.isReadOnly,this.choices?(e.setSize(this.fontSize),e.show()):(e.setSize(0),e.hide()),this.silentSetHeight(t.height()+2*this.edge+2*this.typeInPadding),this.silentSetWidth(Math.max(t.minWidth+2*this.edge+2*this.typeInPadding,this.width())),t.setWidth(this.width()-this.edge-this.typeInPadding-(this.choices?e.width()+this.typeInPadding:0)),t.silentSetPosition(new Point(this.edge,this.edge).add(this.typeInPadding).add(this.position())),void e.silentSetPosition(new Point(this.right()-e.width()-this.edge,t.top()))):null},InputFieldMorph.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.escalateEvent("mouseClickLeft",t)},InputFieldMorph.prototype.getValue=function(){var t,e=this.contents();return this.isNumeric&&(t=parseFloat(e.text),!isNaN(t))?t:this.normalizeSpaces(e.string())},InputFieldMorph.prototype.normalizeSpaces=DialogBoxMorph.prototype.normalizeSpaces,InputFieldMorph.prototype.drawNew=function(){var t,e;this.fixLayout(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),this.parent?(this.parent.color.eq(new Color(255,255,255))?this.color=this.parent.color.darker(.1*this.contrast):this.color=this.parent.color.lighter(.75*this.contrast),e=this.parent.color):e=new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),this.drawRectBorder(t)},InputFieldMorph.prototype.drawRectBorder=function(t){var e,o=.5*this.edge;MorphicPreferences.isFlat&&!this.is3D||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetY=o,t.shadowBlur=4*this.edge,t.shadowColor=this.cachedClrDark,e=t.createLinearGradient(0,0,0,this.edge),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,o),t.lineTo(this.width()-this.edge-o,o),t.stroke(),t.shadowOffsetY=0,e=t.createLinearGradient(0,0,this.edge,0),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o,this.edge),t.lineTo(o,this.height()-this.edge-o),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,e=t.createLinearGradient(0,this.height()-this.edge,0,this.height()),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,this.height()-o),t.lineTo(this.width()-this.edge,this.height()-o),t.stroke(),e=t.createLinearGradient(this.width()-this.edge,0,this.width(),0),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-o,this.edge),t.lineTo(this.width()-o,this.height()-this.edge),t.stroke())},modules.blocks="2016-July-15";var SyntaxElementMorph,BlockMorph,CommandBlockMorph,ReporterBlockMorph,ScriptsMorph,ArgMorph,CommandSlotMorph,CSlotMorph,InputSlotMorph,BooleanSlotMorph,ArrowMorph,ColorSlotMorph,HatBlockMorph,BlockHighlightMorph,MultiArgMorph,TemplateSlotMorph,FunctionSlotMorph,ReporterSlotMorph,RingMorph,RingCommandSlotMorph,RingReporterSlotMorph,SymbolMorph,CommentMorph,ArgLabelMorph,TextSlotMorph,ScriptFocusMorph;WorldMorph.prototype.customMorphs=function(){return[]},SyntaxElementMorph.prototype=new Morph,SyntaxElementMorph.prototype.constructor=SyntaxElementMorph,SyntaxElementMorph.uber=Morph.prototype,SyntaxElementMorph.prototype.setScale=function(t){var e=Math.min(Math.max(t,1),25);this.scale=e,this.corner=3*e,this.rounding=9*e,this.edge=1.000001*e,this.inset=6*e,this.hatHeight=12*e,this.hatWidth=70*e,this.rfBorder=3*e,this.minWidth=0,this.dent=8*e,this.bottomPadding=3*e,this.cSlotPadding=4*e,this.typeInPadding=e,this.labelPadding=4*e,this.labelFontName="Verdana",this.labelFontStyle="sans-serif",this.fontSize=10*e,this.embossing=new Point(-1*Math.max(e/2,1),-1*Math.max(e/2,1)),this.labelWidth=450*e,this.labelWordWrap=!0,this.dynamicInputLabels=!0,this.feedbackColor=new Color(255,255,255),this.feedbackMinHeight=5,this.minSnapDistance=20,this.reporterDropFeedbackPadding=10*e,this.contrast=65,this.labelContrast=25,this.activeHighlight=new Color(153,255,213),this.errorHighlight=new Color(173,15,0),this.activeBlur=20,this.activeBorder=4,this.rfColor=new Color(120,120,120)},SyntaxElementMorph.prototype.setScale(1),SyntaxElementMorph.prototype.isCachingInputs=!1,SyntaxElementMorph.prototype.init=function(t){this.cachedClr=null,this.cachedClrBright=null,this.cachedClrDark=null,this.isStatic=!1,SyntaxElementMorph.uber.init.call(this,t),this.defaults=[],this.cachedInputs=null},SyntaxElementMorph.prototype.parts=function(){var t=null;return this.nextBlock&&(t=this.nextBlock()),this.children.filter(function(e){return!(e===t||e instanceof ShadowMorph||e instanceof BlockHighlightMorph)})},SyntaxElementMorph.prototype.inputs=function(){return!isNil(this.cachedInputs)&&this.isCachingInputs||(this.cachedInputs=this.parts().filter(function(t){return t instanceof SyntaxElementMorph})),this.cachedInputs},SyntaxElementMorph.prototype.debugCachedInputs=function(){var t,e;if(isNil(this.cachedInputs)||(t=this.parts().filter(function(t){return t instanceof SyntaxElementMorph})),this.cachedInputs.length!==t.length)throw new Error("cached inputs size do not match: "+this.constructor.name);for(e=0;e<t.length;e+=1)if(this.cachedInputs[e]!==t[e])throw new Error("cached input does not match: "+this.constructor.name+" #"+e+" "+this.cachedInputs[e].constructor.name+" != "+t[e].constructor.name)},SyntaxElementMorph.prototype.allInputs=function(){var t=this;return this.allChildren().slice(0).reverse().filter(function(e){return e instanceof ArgMorph||e instanceof ReporterBlockMorph&&e!==t})},SyntaxElementMorph.prototype.allEmptySlots=function(){var t=[];return this instanceof RingMorph||"reportJSFunction"===this.selector||this.children.forEach(function(e){e.isEmptySlot&&e.isEmptySlot()?t.push(e):e.allEmptySlots&&(t=t.concat(e.allEmptySlots()))}),t},SyntaxElementMorph.prototype.tagExitBlocks=function(t,e){"doReport"===this.selector?this.partOfCustomCommand=e:"doStopThis"===this.selector?this.exitTag=t:this instanceof RingMorph||this.children.forEach(function(o){o.tagExitBlocks&&o.tagExitBlocks(t,e)})},SyntaxElementMorph.prototype.replaceInput=function(t,e){var o=this.parentThatIsA(ScriptsMorph),r=e,i=this.children.indexOf(t),n=0;return i===-1&&e instanceof MultiArgMorph&&this.children.forEach(function(e){e instanceof ArgLabelMorph&&e.argMorph()===t&&(i=n),n+=1}),i===-1||null===o?null:(t.cachedSlotSpec&&(t.cachedSlotSpec=null),e.cachedSlotSpec&&(e.cachedSlotSpec=null),this.startLayout(),e.parent&&e.parent.removeChild(e),t instanceof MultiArgMorph&&(t.inputs().forEach(function(e){t.replaceInput(e,new InputSlotMorph)}),this.dynamicInputLabels&&(r=new ArgLabelMorph(e))),r.parent=this,this.children[i]=r,t instanceof ReporterBlockMorph&&(t instanceof RingMorph&&!(t instanceof RingMorph&&t.contents())||(o.add(t),t.moveBy(r.extent()),t.fixBlockColor())),r instanceof MultiArgMorph||r instanceof ArgLabelMorph||r.constructor===CommandSlotMorph?(r.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(r.drawNew(),this.fixLayout()),this.cachedInputs=null,void this.endLayout())},SyntaxElementMorph.prototype.silentReplaceInput=function(t,e){var o,r=this.children.indexOf(t);r!==-1&&(t.cachedSlotSpec&&(t.cachedSlotSpec=null),e.cachedSlotSpec&&(e.cachedSlotSpec=null),e.parent&&e.parent.removeChild(e),o=t instanceof MultiArgMorph&&this.dynamicInputLabels?new ArgLabelMorph(e):e,o.parent=this,this.children[r]=o,o instanceof MultiArgMorph||o instanceof ArgLabelMorph||o.constructor===CommandSlotMorph?(o.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(o.drawNew(),this.fixLayout()),this.cachedInputs=null)},SyntaxElementMorph.prototype.revertToDefaultInput=function(t,e){var o=this.parts().indexOf(t),r=this.inputs().indexOf(t),i=new InputSlotMorph;o!==-1&&(this instanceof BlockMorph?(i=this.labelPart(this.parseSpec(this.blockSpec)[o]),i instanceof InputSlotMorph&&this.definition&&(i.setChoices.apply(i,this.definition.inputOptionsOfIdx(r)),i.setContents(this.definition.defaultValueOfInputIdx(r)))):this instanceof MultiArgMorph?i=this.labelPart(this.slotSpec):this instanceof ReporterSlotMorph&&(i=this.emptySlot())),e||r!==-1&&(i instanceof MultiArgMorph?(i.setContents(this.defaults),i.defaults=this.defaults):isNil(this.defaults[r])||i.setContents(this.defaults[r])),this.silentReplaceInput(t,i),i instanceof MultiArgMorph?i.refresh():i instanceof RingMorph&&i.fixBlockColor(),this.cachedInputs=null},SyntaxElementMorph.prototype.isLocked=function(){return this.isStatic},SyntaxElementMorph.prototype.topBlock=function(){return this.parent&&this.parent.topBlock?this.parent.topBlock():this},SyntaxElementMorph.prototype.getVarNamesDict=function(){var t,e,o=this.parentThatIsA(BlockMorph),r=[];return o?(t=o.receiver(),o.allParents().forEach(function(t){t instanceof PrototypeHatBlockMorph?(r.push.apply(r,t.variableNames()),r.push.apply(r,t.inputs()[0].inputFragmentNames())):t instanceof BlockMorph&&t.inputs().forEach(function(t){t instanceof TemplateSlotMorph?r.push(t.contents()):t instanceof MultiArgMorph&&t.children.forEach(function(t){t instanceof TemplateSlotMorph&&r.push(t.contents())})})}),t?(e=t.variables.allNamesDict(),r.forEach(function(t){e[t]=t}),e):{}):{}},SyntaxElementMorph.prototype.reactToGrabOf=function(t){var e,o=this.topBlock();t instanceof CommandBlockMorph&&(e=this.parentThatIsA(CommandSlotMorph),e&&(this.startLayout(),e.fixLayout(),this.endLayout())),o&&(o.allComments().forEach(function(t){t.align(o)}),o.getHighlight()&&o.addHighlight(o.removeHighlight()))},SyntaxElementMorph.prototype.bright=function(){return this.color.lighter(this.contrast).toString()},SyntaxElementMorph.prototype.dark=function(){return this.color.darker(this.contrast).toString()},SyntaxElementMorph.prototype.setColor=function(t,e){t&&(this.color.eq(t)||(this.color=t,e||this.drawNew(),this.children.forEach(function(t){(!e||t instanceof TemplateSlotMorph)&&(t.drawNew(),t.changed())}),this.changed()))},SyntaxElementMorph.prototype.setLabelColor=function(t,e,o){this.children.forEach(function(r){r instanceof StringMorph&&!r.isProtectedLabel?(r.shadowOffset=o||r.shadowOffset,r.shadowColor=e||r.shadowColor,r.setColor(t)):(r instanceof MultiArgMorph||r instanceof ArgLabelMorph||r instanceof SymbolMorph&&!r.isProtectedLabel||r instanceof InputSlotMorph&&r.isReadOnly)&&r.setLabelColor(t,e,o)})},SyntaxElementMorph.prototype.fixBlockColor=function(t,e){this.children.forEach(function(o){o instanceof SyntaxElementMorph&&o.fixBlockColor(t,e)})},SyntaxElementMorph.prototype.labelPart=function(t){var e,o;if("%"===t[0]&&t.length>1&&("reportGetVar"!==this.selector||"%turtleOutline"===t&&this.isObjInputFragment())){if(t.length>5&&"%mult"===t.slice(0,5))return e=new MultiArgMorph(t.slice(5)),e.addInput(),e;switch(t){case"%imgsource":e=new InputSlotMorph(null,!1,{"pen trails":["pen trails"],"stage image":["stage image"]},!0),e.setContents(["pen trails"]);break;case"%inputs":e=new MultiArgMorph("%s","with inputs"),e.isStatic=!1,e.canBeEmpty=!1;break;case"%scriptVars":e=new MultiArgMorph("%t",null,1,t),e.canBeEmpty=!1;break;case"%blockVars":e=new MultiArgMorph("%t","block variables",0,t),e.canBeEmpty=!1;break;case"%parms":e=new MultiArgMorph("%t","Input Names:",0,t),e.canBeEmpty=!1;break;case"%ringparms":e=new MultiArgMorph("%t","input names:",0,t);break;case"%cmdRing":e=new RingMorph,e.color=SpriteMorph.prototype.blockColor.other,e.selector="reifyScript",e.setSpec("%rc %ringparms"),e.isDraggable=!0;break;case"%repRing":e=new RingMorph,e.color=SpriteMorph.prototype.blockColor.other,e.selector="reifyReporter",e.setSpec("%rr %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%predRing":e=new RingMorph(!0),e.color=SpriteMorph.prototype.blockColor.other,e.selector="reifyPredicate",e.setSpec("%rp %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%words":e=new MultiArgMorph("%s",null,0),e.addInput(),e.addInput(),e.isStatic=!1;break;case"%exp":e=new MultiArgMorph("%s",null,0),e.addInput(),e.isStatic=!0,e.canBeEmpty=!1;break;case"%br":e=new Morph,e.setExtent(new Point(0,0)),e.isBlockLabelBreak=!0,e.getSpec=function(){return"%br"};break;case"%inputName":e=new ReporterBlockMorph,e.category="variables",e.color=SpriteMorph.prototype.blockColor.variables,e.setSpec(localize("Input name"));break;case"%s":e=new InputSlotMorph;break;case"%anyUE":e=new InputSlotMorph,e.isUnevaluated=!0;break;case"%txt":e=new InputSlotMorph,e.minWidth=1.7*e.height(),e.fixLayout();break;case"%mlt":e=new TextSlotMorph,e.fixLayout();break;case"%code":e=new TextSlotMorph,e.contents().fontName="monospace",e.contents().fontStyle="monospace",e.fixLayout();break;case"%obj":e=new ArgMorph("object");break;case"%n":e=new InputSlotMorph(null,!0);break;case"%dir":e=new InputSlotMorph(null,!0,{"(90) right":90,"(-90) left":-90,"(0) up":"0","(180) down":180}),e.setContents(90);break;case"%inst":e=new InputSlotMorph(null,!0,{"(1) Acoustic Grand":1,"(2) Bright Acoustic":2,"(3) Electric Grand":3,"(4) Honky Tonk":4,"(5) Electric Piano 1":5,"(6) Electric Piano 2":6,"(7) Harpsichord":7}),e.setContents(1);break;case"%month":e=new InputSlotMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);break;case"%interaction":e=new InputSlotMorph(null,!1,{clicked:["clicked"],pressed:["pressed"],dropped:["dropped"],"mouse-entered":["mouse-entered"],"mouse-departed":["mouse-departed"]},!0),e.isStatic=!0;break;case"%dates":e=new InputSlotMorph(null,!1,{year:["year"],month:["month"],date:["date"],"day of week":["day of week"],hour:["hour"],minute:["minute"],second:["second"],"time in milliseconds":["time in milliseconds"]},!0),e.setContents(["date"]);break;case"%delim":e=new InputSlotMorph(null,!1,{letter:["letter"],whitespace:["whitespace"],line:["line"],tab:["tab"],cr:["cr"]},!1);break;case"%ida":e=new InputSlotMorph(null,!0,{1:1,last:["last"],"~":null,all:["all"]}),e.setContents(1);break;case"%idx":e=new InputSlotMorph(null,!0,{1:1,last:["last"],any:["any"]}),e.setContents(1);break;case"%spr":e=new InputSlotMorph(null,!1,"objectsMenu",!0);break;case"%col":e=new InputSlotMorph(null,!1,"collidablesMenu",!0);break;case"%dst":e=new InputSlotMorph(null,!1,"distancesMenu",!0);break;case"%cln":e=new InputSlotMorph(null,!1,"clonablesMenu",!0);break;case"%get":e=new InputSlotMorph(null,!1,"gettablesMenu",!0),e.isStatic=!0;break;case"%cst":e=new InputSlotMorph(null,!1,"costumesMenu",!0);break;case"%eff":e=new InputSlotMorph(null,!1,{color:["color"],fisheye:["fisheye"],whirl:["whirl"],
pixelate:["pixelate"],mosaic:["mosaic"],duplicate:["duplicate"],negative:["negative"],comic:["comic"],confetti:["confetti"],saturation:["saturation"],brightness:["brightness"],ghost:["ghost"]},!0),e.setContents(["ghost"]);break;case"%snd":e=new InputSlotMorph(null,!1,"soundsMenu",!0);break;case"%key":e=new InputSlotMorph(null,!1,{"any key":["any key"],"up arrow":["up arrow"],"down arrow":["down arrow"],"right arrow":["right arrow"],"left arrow":["left arrow"],space:["space"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"]},!0),e.setContents(["space"]);break;case"%keyHat":e=this.labelPart("%key"),e.isStatic=!0;break;case"%msg":e=new InputSlotMorph(null,!1,"messagesMenu",!0);break;case"%msgHat":e=new InputSlotMorph(null,!1,"messagesReceivedMenu",!0),e.isStatic=!0;break;case"%att":e=new InputSlotMorph(null,!1,"attributesMenu",!0);break;case"%fun":e=new InputSlotMorph(null,!1,{abs:["abs"],ceiling:["ceiling"],floor:["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],log:["log"],"e^":["e^"],"10^":["10^"]},!0),e.setContents(["sqrt"]);break;case"%txtfun":e=new InputSlotMorph(null,!1,{"encode URI":["encode URI"],"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],"hex sha512 hash":["hex sha512 hash"]},!0),e.setContents(["encode URI"]);break;case"%stopChoices":e=new InputSlotMorph(null,!1,{all:["all"],"this script":["this script"],"this block":["this block"]},!0),e.setContents(["all"]),e.isStatic=!0;break;case"%stopOthersChoices":e=new InputSlotMorph(null,!1,{"all but this script":["all but this script"],"other scripts in sprite":["other scripts in sprite"]},!0),e.setContents(["all but this script"]),e.isStatic=!0;break;case"%typ":e=new InputSlotMorph(null,!1,"typesMenu",!0),e.setContents(["number"]);break;case"%var":e=new InputSlotMorph(null,!1,"getVarNamesDict",!0),e.isStatic=!0;break;case"%shd":e=new InputSlotMorph(null,!1,"shadowedVariablesMenu",!0),e.isStatic=!0;break;case"%lst":e=new InputSlotMorph(null,!1,{list1:"list1",list2:"list2",list3:"list3"},!0);break;case"%codeKind":e=new InputSlotMorph(null,!1,{code:["code"],header:["header"]},!0),e.setContents(["code"]);break;case"%l":e=new ArgMorph("list");break;case"%b":e=new BooleanSlotMorph;break;case"%boolUE":e=new BooleanSlotMorph,e.isUnevaluated=!0;break;case"%bool":e=new BooleanSlotMorph(!0),e.isStatic=!0;break;case"%cmd":e=new CommandSlotMorph;break;case"%rc":e=new RingCommandSlotMorph,e.isStatic=!0;break;case"%rr":e=new RingReporterSlotMorph,e.isStatic=!0;break;case"%rp":e=new RingReporterSlotMorph(!0),e.isStatic=!0;break;case"%c":e=new CSlotMorph,e.isStatic=!0;break;case"%cs":e=new CSlotMorph;break;case"%cl":e=new CSlotMorph,e.isStatic=!0,e.isLambda=!0;break;case"%clr":e=new ColorSlotMorph,e.isStatic=!0;break;case"%t":e=new TemplateSlotMorph("a");break;case"%upvar":e=new TemplateSlotMorph("");break;case"%f":e=new FunctionSlotMorph;break;case"%r":e=new ReporterSlotMorph;break;case"%p":e=new ReporterSlotMorph(!0);break;case"%codeListPart":e=new InputSlotMorph(null,!1,{list:["list"],item:["item"],delimiter:["delimiter"]},!0);break;case"%codeListKind":e=new InputSlotMorph(null,!1,{collection:["collection"],variables:["variables"],parameters:["parameters"]},!0);break;case"%turtle":e=new SymbolMorph("turtle"),e.size=1.2*this.fontSize,e.color=new Color(255,255,255),e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%turtleOutline":e=new SymbolMorph("turtleOutline"),e.size=this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%clockwise":e=new SymbolMorph("turnRight"),e.size=1.5*this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%counterclockwise":e=new SymbolMorph("turnLeft"),e.size=1.5*this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%greenflag":e=new SymbolMorph("flag"),e.size=1.5*this.fontSize,e.color=new Color(0,200,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%stop":e=new SymbolMorph("octagon"),e.size=1.5*this.fontSize,e.color=new Color(200,0,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%pause":e=new SymbolMorph("pause"),e.size=this.fontSize,e.color=new Color(255,220,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;default:nop()}}else if("$"===t[0]&&t.length>1&&"reportGetVar"!==this.selector){if(o=t.slice(1).split("-"),!contains(SymbolMorph.prototype.names,o[0]))return e=new StringMorph(t),e.fontName=this.labelFontName,e.fontStyle=this.labelFontStyle,e.fontSize=this.fontSize,e.color=new Color(255,255,255),e.isBold=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew(),e;e=new SymbolMorph(o[0]),e.size=this.fontSize*(+o[1]||1.2),e.color=new Color(0===+o[2]?0:+o[2]||255,0===+o[3]?0:+o[3]||255,0===+o[4]?0:+o[4]||255),e.isProtectedLabel=o.length>2,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew()}else e=new StringMorph(t,this.fontSize,this.labelFontStyle,!0,!1,!1,MorphicPreferences.isFlat?new Point:this.embossing,this.color.darker(this.labelContrast),new Color(255,255,255),this.labelFontName);return e},SyntaxElementMorph.prototype.isObjInputFragment=function(){return"reportGetVar"===this.selector&&"%t"===this.getSlotSpec()&&"%obj"===this.parent.fragment.type},SyntaxElementMorph.prototype.fixLayout=function(t){var e,o,r,i,n,s=this.parts(),a=this,h=0,l=0,p=0,c=this.minWidth,d=[],u=[],g=this.isPrototype?1:Math.floor(fontHeight(this.fontSize)/3),f=this.extent();if(c+=this instanceof MultiArgMorph&&"%c"!==this.slotSpec?this.arrows().width():this instanceof ReporterBlockMorph?2*this.rounding+2*this.edge:4*this.corner+2*this.edge+3*this.inset+this.dent,this.nextBlock&&(e=this.nextBlock()),s.forEach(function(t){t instanceof CSlotMorph||"%c"===t.slotSpec?d.length>0?(u.push(d),u.push([t]),d=[],h=0):u.push([t]):t instanceof BlockHighlightMorph?nop():(t.isVisible&&(h+=t.fullBounds().width()+g),(h>a.labelWidth||t.isBlockLabelBreak)&&d.length>0&&(u.push(d),d=[],h=t.fullBounds().width()+g),d.push(t),t.isBlockLabelBreak&&(h=0))}),d.length>0&&u.push(d),this instanceof CommandBlockMorph?(o=this.top()+this.corner+this.edge,this instanceof HatBlockMorph&&(o+=this.hatHeight)):this instanceof ReporterBlockMorph?o=this.top()+2*this.edge:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(o=this.top()),u.forEach(function(t){h=a.left()+a.edge+a.labelPadding,a instanceof RingMorph?h=a.left()+g:a.isPredicate?h=a.left()+a.rounding:(a instanceof MultiArgMorph||a instanceof ArgLabelMorph)&&(h=a.left()),o+=l,l=0,t.forEach(function(t){t instanceof CSlotMorph?(h-=a.labelPadding,a.isPredicate&&(h=a.left()+a.rounding),t.setColor(a.color),t.setPosition(new Point(h,o)),l=t.height()):(t.setPosition(new Point(h,o)),t.isBlockLabelBreak||("%c"===t.slotSpec?h+=t.width():t.isVisible&&(h+=t.fullBounds().width()+g)),p=Math.max(p,h),l=Math.max(l,t instanceof StringMorph?t.rawHeight():t.height()))}),t.forEach(function(t){t.moveBy(new Point(0,Math.floor((l-t.height())/2)))})}),o+=l,this.children.some(function(t){return t instanceof CSlotMorph})&&(n=this.bottomPadding,this instanceof ReporterBlockMorph&&!this.isPredicate&&(n=Math.max(this.bottomPadding,this.rounding-this.bottomPadding)),o+=n),this instanceof CommandBlockMorph?r=o-this.top()+2*this.corner:this instanceof ReporterBlockMorph?r=o-this.top()+2*this.edge:(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)&&(r=o-this.top()),this.isPredicate?c=Math.max(c,p-this.left()+this.rounding):this instanceof MultiArgMorph||this instanceof ArgLabelMorph?c=Math.max(c,p-this.left()-g):(c=Math.max(c,p-this.left()+this.labelPadding-this.edge),s[s.length-1]instanceof MultiArgMorph&&1===u.length&&(c-=g),this instanceof HatBlockMorph&&(c=Math.max(c,1.5*this.hatWidth))),this.silentSetExtent(new Point(c,r)),s.forEach(function(t){t instanceof CSlotMorph&&(a.isPredicate?t.setWidth(c-2*a.rounding):t.setWidth(c-a.edge))}),t||this.drawNew(),e&&e.setPosition(new Point(this.left(),this.bottom()-this.corner)),this instanceof CommandBlockMorph){if(this.height()!==f.y&&(i=this.parentThatIsA(CommandSlotMorph),i&&i.fixLayout()),this.width()!==f.x&&(i=this.parentThatIsAnyOf([ReporterBlockMorph,CommandSlotMorph,RingCommandSlotMorph]),i&&i.fixLayout()),i)return}else if(this instanceof ReporterBlockMorph&&this.parent&&this.parent.fixLayout)return this.parent.fixLayout();this.fixHighlight()},SyntaxElementMorph.prototype.fixHighlight=function(){var t=this.topBlock();t.getHighlight&&t.getHighlight()&&t.addHighlight(t.removeHighlight())},SyntaxElementMorph.prototype.evaluate=function(){return null},SyntaxElementMorph.prototype.isEmptySlot=function(){return!1},SyntaxElementMorph.prototype.showBubble=function(t,e){var o,r,i,n,s=!1,a=this.parentThatIsA(IDE_Morph),h=this.receiver(),l=this,p=this.rightCenter().add(new Point(2,0)),c=this.parentThatIsA(ScrollFrameMorph),d=this.world();return void 0!==t&&d?(t instanceof ListWatcherMorph?(n=t,n.update(!0),n.step=t.update,n.isDraggable=!1,n.expand(this.parentThatIsA(ScrollFrameMorph).extent()),s=!0):t instanceof TableFrameMorph?(n=t,n.isDraggable=!1,n.expand(this.parentThatIsA(ScrollFrameMorph).extent()),s=!0):t instanceof Morph?isSnapObject(t)?(i=t.thumbnail(new Point(40,40)),n=new Morph,n.silentSetWidth(i.width),n.silentSetHeight(i.height),n.image=i,n.version=t.version,n.step=function(){this.version!==t.version&&(i=t.thumbnail(new Point(40,40)),this.image=i,this.version=t.version,this.changed())}):(i=t.fullImage(),n=new Morph,n.silentSetWidth(i.width),n.silentSetHeight(i.height),n.image=i):t instanceof Costume?(i=t.thumbnail(new Point(40,40)),n=new Morph,n.silentSetWidth(i.width),n.silentSetHeight(i.height),n.image=i):t instanceof Context?(i=t.image(),n=new Morph,n.silentSetWidth(i.width),n.silentSetHeight(i.height),n.image=i):"boolean"==typeof t?n=SpriteMorph.prototype.booleanMorph.call(null,t):isString(t)?(r=t.length>500?t.slice(0,500)+"...":t,n=new TextMorph(r,this.fontSize)):null===t?n=new TextMorph("",this.fontSize):0===t?n=new TextMorph("0",this.fontSize):t.toString&&(n=new TextMorph(t.toString(),this.fontSize)),a&&a.currentSprite!==h&&(l=h instanceof StageMorph?a.corral.stageIcon:detect(a.corral.frame.contents.children,function(t){return t.object===h}),p=l.center()),o=new SpeechBubbleMorph(n,null,Math.max(this.rounding-2,6),0),o.popUp(d,p,s),e&&this.exportPictureWithResult(o),void(l instanceof SpriteIconMorph?o.keepWithin(a.corral):c&&o.keepWithin(c))):null},SyntaxElementMorph.prototype.exportPictureWithResult=function(t){var e=this.parentThatIsA(IDE_Morph),o=this.fullImage(),r=t.fullImageClassic(),i=Math.max(0,r.height-o.height),n=newCanvas(new Point(o.width+r.width+2,o.height+i)),s=n.getContext("2d");s.drawImage(o,0,n.height-o.height),s.drawImage(r,o.width+2,0),e.saveCanvasAs(n,e.projetName||localize("Untitled")+" "+localize("script pic"),!0)},SyntaxElementMorph.prototype.mappedCode=function(t){var e=this.evaluate();return e instanceof BlockMorph?e.mappedCode(t):e},SyntaxElementMorph.prototype.startLayout=function(){this.topBlock().fullChanged(),Morph.prototype.trackChanges=!1},SyntaxElementMorph.prototype.endLayout=function(){Morph.prototype.trackChanges=!0,this.topBlock().fullChanged()},BlockMorph.prototype=new SyntaxElementMorph,BlockMorph.prototype.constructor=BlockMorph,BlockMorph.uber=SyntaxElementMorph.prototype,BlockMorph.prototype.isCachingInputs=!0,BlockMorph.prototype.zebraContrast=40,BlockMorph.prototype.snapSound=null,BlockMorph.prototype.toggleSnapSound=function(){null!==this.snapSound?this.snapSound=null:(BlockMorph.prototype.snapSound=document.createElement("audio"),BlockMorph.prototype.snapSound.src="click.wav"),CommentMorph.prototype.snapSound=BlockMorph.prototype.snapSound},BlockMorph.prototype.init=function(t){this.selector=null,this.blockSpec="",this.comment=null,this.instantiationSpec=null,this.category=null,BlockMorph.uber.init.call(this,t),this.color=new Color(0,17,173),this.cashedInputs=null},BlockMorph.prototype.receiver=function(){for(var t=this.parent;t;){if(t.owner)return t.owner;t=t.parent}return null},BlockMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'},BlockMorph.prototype.parseSpec=function(t){function e(t){"%"===t[0]&&t.length>1?(""!==i&&(r.push(i),i=""),r.push(t)):""!==i?i+=" "+t:i=t}var o,r=[],i="";return o=isString(t)?t.split(" "):[],0===o.length&&(o=[t]),this.labelWordWrap?o:(o.forEach(function(t){e(t)}),""!==i&&r.push(i),r)},BlockMorph.prototype.setSpec=function(t,e){var o,r=this,i=-1;t&&(this.parts().forEach(function(t){t.destroy()}),this.isPrototype&&this.add(this.placeHolder()),this.parseSpec(t).forEach(function(t){"%"===t[0]&&(i+=1),o=r.labelPart(t),r.add(o),o instanceof CommandSlotMorph||o instanceof StringMorph||o.drawNew(),o instanceof RingMorph&&o.fixBlockColor(),(o instanceof MultiArgMorph||o.constructor===CommandSlotMorph||o.constructor===RingCommandSlotMorph)&&o.fixLayout(),r.isPrototype&&r.add(r.placeHolder()),o instanceof InputSlotMorph&&r.definition&&o.setChoices.apply(o,r.definition.inputOptionsOfIdx(i))}),this.blockSpec=t,this.fixLayout(e),this.cachedInputs=null)},BlockMorph.prototype.userSetSpec=function(t){var e=this.topBlock();e.fullChanged(),this.setSpec(t),e.fullChanged()},BlockMorph.prototype.buildSpec=function(){var t=this;this.blockSpec="",this.parts().forEach(function(e){e instanceof StringMorph?t.blockSpec+=e.text:e instanceof ArgMorph?t.blockSpec+=e.getSpec():e.isBlockLabelBreak?t.blockSpec+=e.getSpec():t.blockSpec+="[undefined]",t.blockSpec+=" "}),this.blockSpec=this.blockSpec.trim()},BlockMorph.prototype.rebuild=function(t){this.setSpec(this.blockSpec),t&&this.inputs().forEach(function(e){e instanceof ReporterBlockMorph&&(e.setColor(e.color.lighter(t)),e.setSpec(e.blockSpec))})},BlockMorph.prototype.userMenu=function(){function t(t,e,o,r,n){var s=" ",a=" ";i.addItem((o?s:a)+localize(t),e,o?r:n)}var e,o,r,i=new MenuMorph(this),n=this.world(),s=this,a=16===n.currentKey,h=this.activeProcess(),l=h&&h.context&&h.context.outerContext?h.context.outerContext.variables.names():[];return i.addItem("help...","showHelp"),a&&(o=this.topBlock(),o instanceof ReporterBlockMorph&&i.addItem("script pic with result...",function(){o.ExportResultPic()},"open a new window\nwith a picture of both\nthis script and its result",new Color(100,0,0))),this.isTemplate?(this.parent instanceof SyntaxElementMorph||("reportGetVar"===this.selector?t("transient","toggleTransientVariable",s.isTransientVariable(),"uncheck to save contents\nin the project","check to prevent contents\nfrom being saved"):"evaluateCustomBlock"!==this.selector&&i.addItem("hide","hidePrimitive"),StageMorph.prototype.enableCodeMapping&&(i.addLine(),i.addItem("header mapping...","mapToHeader"),i.addItem("code mapping...","mapToCode"))),i):(i.addLine(),"reportGetVar"===this.selector?(r=this.fullCopy(),r.addShadow(),i.addItem("rename...",function(){new DialogBoxMorph(s,s.setSpec,s).prompt("Variable name",s.blockSpec,n,r.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(s))})):SpriteMorph.prototype.blockAlternatives[this.selector]?i.addItem("relabel...",function(){s.relabel(SpriteMorph.prototype.blockAlternatives[s.selector])}):this.definition&&this.alternatives&&(e=this.alternatives(),e.length>0&&i.addItem("relabel...",function(){s.relabel(e)})),i.addItem("duplicate",function(){var t=s.fullCopy(),e=s.parentThatIsA(IDE_Morph);t.pickUp(n),e&&(n.hand.grabOrigin={origin:e.palette,position:e.palette.center()})},"make a copy\nand pick it up"),this instanceof CommandBlockMorph&&this.nextBlock()&&i.addItem((h?this.fullCopy():this).thumbnail(.5,60),function(){var t=s.fullCopy(),e=t.nextBlock(),o=s.parentThatIsA(IDE_Morph);e&&e.destroy(),t.pickUp(n),o&&(n.hand.grabOrigin={origin:o.palette,position:o.palette.center()})},"only duplicate this block"),i.addItem("delete","userDestroy"),i.addItem("script pic...",function(){var t=s.parentThatIsA(IDE_Morph)||s.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph);t.saveCanvasAs(s.topBlock().scriptPic(),t.projetName||localize("Untitled")+" "+localize("script pic"),!0)},"open a new window\nwith a picture of this script"),h?(l.length&&(i.addLine(),l.forEach(function(t){i.addItem(t+"...",function(){h.doShowVar(t)})})),i):this.parentThatIsA(RingMorph)?(i.addLine(),i.addItem("unringify","unringify"),i.addItem("ringify","ringify"),i):this.parent instanceof ReporterSlotMorph||this.parent instanceof CommandSlotMorph||this instanceof HatBlockMorph||this instanceof CommandBlockMorph&&this.topBlock()instanceof HatBlockMorph?i:(i.addLine(),i.addItem("ringify","ringify"),StageMorph.prototype.enableCodeMapping&&(i.addLine(),i.addItem("header mapping...","mapToHeader"),i.addItem("code mapping...","mapToCode")),i))},BlockMorph.prototype.developersMenu=function(){var t=BlockMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("delete block","deleteBlock"),t.addItem("spec...",function(){new DialogBoxMorph(this,this.userSetSpec,this).prompt(t.title+"\nspec",this.blockSpec,this.world())}),t},BlockMorph.prototype.hidePrimitive=function(){var t,e,o=this.parentThatIsA(IDE_Morph);o&&(StageMorph.prototype.hiddenPrimitives[this.selector]=!0,t={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"},e=t[this.selector]||this.category,"lists"===e&&(e="variables"),o.flushBlocksCache(e),o.refreshPalette())},BlockMorph.prototype.isTransientVariable=function(){var t=this.receiver().variables.silentFind(this.blockSpec);return!!t&&t.vars[this.blockSpec].isTransient},BlockMorph.prototype.toggleTransientVariable=function(){var t=this.receiver().variables.silentFind(this.blockSpec);t&&(t.vars[this.blockSpec].isTransient=!t.vars[this.blockSpec].isTransient)},BlockMorph.prototype.deleteBlock=function(){var t,e,o=this.parentThatIsA(ScriptsMorph),r=this.nextBlock?this.nextBlock():null;o&&(r&&o.add(r),this.inputs().forEach(function(t){t instanceof BlockMorph&&o.add(t)})),this instanceof ReporterBlockMorph?this.parent instanceof BlockMorph&&this.parent.revertToDefaultInput(this):this.parent?this.parent.fixLayout&&(t=this.parentThatIsA(ArgMorph)):e=!0,this.destroy(),e&&(this.isCorpse=!0),t&&t.fixLayout()},BlockMorph.prototype.ringify=function(){var t=new RingMorph,e=this.topBlock(),o=e.fullBounds().center();return null===this.parent?null:(e.fullChanged(),this.parent instanceof SyntaxElementMorph?this instanceof ReporterBlockMorph?(this.parent.silentReplaceInput(this,t),t.embed(this)):e&&(e.parent.add(t),t.embed(e),t.setCenter(o)):(this.parent.add(t),t.embed(this),t.setCenter(o)),this.fixBlockColor(null,!0),void e.fullChanged())},BlockMorph.prototype.unringify=function(){var t,e,o=this.parentThatIsA(RingMorph),r=this.topBlock(),i=this.parentThatIsA(ScriptsMorph);return null===o?null:(t=o.contents(),e=o.center(),r.fullChanged(),o.parent instanceof SyntaxElementMorph?t instanceof ReporterBlockMorph?o.parent.silentReplaceInput(o,t):i&&(i.add(t),t.setFullCenter(e),t.moveBy(20),o.parent.revertToDefaultInput(o)):(o.parent.add(t),t.setFullCenter(e),o.destroy()),this.fixBlockColor(null,!0),void r.fullChanged())},BlockMorph.prototype.relabel=function(t){var e=new MenuMorph(this),o=this.inputs(),r=this;t.forEach(function(t){var i=SpriteMorph.prototype.blockForSelector(t);i.restoreInputs(o),i.fixBlockColor(null,!0),i.addShadow(new Point(3,3)),e.addItem(i,function(){r.setSelector(t)})}),e.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))},BlockMorph.prototype.setSelector=function(t){var e,o=this.inputs();e=SpriteMorph.prototype.blocks[t],this.setCategory(e.category),this.selector=t,this.setSpec(localize(e.spec)),this.restoreInputs(o),this.fixLabelColor()},BlockMorph.prototype.restoreInputs=function(t){var e,o,r=0,i=this;this.inputs().forEach(function(n){e=t[r],e instanceof ReporterBlockMorph?i.silentReplaceInput(n,e.fullCopy()):e&&n instanceof InputSlotMorph?e.contents&&n.setContents(e.contents().text):e instanceof CSlotMorph&&n instanceof CSlotMorph&&(o=e.nestedBlock(),o&&n.nestedBlock(o.fullCopy())),r+=1}),this.cachedInputs=null},BlockMorph.prototype.showHelp=function(){var t,e,o,r,i,n=this,s=this.parentThatIsA(IDE_Morph),a=new Image,h="evaluateCustomBlock"===this.selector,l=h?this.definition.helpSpec():this.selector;s||(t=this.parentThatIsA(BlockEditorMorph),t&&(s=t.target.parentThatIsA(IDE_Morph))),a.onload=function(){e=newCanvas(new Point(a.width,a.height),!0),i=e.getContext("2d"),i.drawImage(a,0,0),(new DialogBoxMorph).inform("Help",null,n.world(),e)},h&&this.definition.comment?(r=this.fullCopy(),r.addShadow(),o=this.definition.comment.fullCopy(),o.contents.parse(),e="",o.contents.lines.forEach(function(t){e=e+"\n"+t}),(new DialogBoxMorph).inform("Help",e.substr(1),n.world(),r.fullImage())):a.src=s.resourceURL("help",l+".png")},BlockMorph.prototype.mapToHeader=function(){var t,e,o="reify"===this.selector.substr(0,5)?"reify":this.selector,r=this.codeDefinitionHeader(),i=this;r.addShadow(new Point(3,3)),e=r.fullImageClassic(),t=this.definition?"Enter code that corresponds to the block's definition. Use the formal parameter\nnames as shown and <body> to reference the definition body's generated text code.":"Enter code that corresponds to the block's definition. Choose your own\nformal parameter names (ignoring the ones shown).",new DialogBoxMorph(this,function(t){"evaluateCustomBlock"===o?i.definition.codeHeader=t:StageMorph.prototype.codeHeaders[o]=t},this).promptCode("Header mapping","evaluateCustomBlock"===o?this.definition.codeHeader||"":StageMorph.prototype.codeHeaders[o]||"",this.world(),e,t)},BlockMorph.prototype.mapToCode=function(){var t,e="reify"===this.selector.substr(0,5)?"reify":this.selector,o=this.codeMappingHeader(),r=this;o.addShadow(new Point(3,3)),t=o.fullImageClassic(),new DialogBoxMorph(this,function(t){"evaluateCustomBlock"===e?r.definition.codeMapping=t:StageMorph.prototype.codeMappings[e]=t},this).promptCode("Code mapping","evaluateCustomBlock"===e?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[e]||"",this.world(),t,"Enter code that corresponds to the block's operation (usually a single\nfunction invocation). Use <#n> to reference actual arguments as shown.")},BlockMorph.prototype.mapHeader=function(t,e){var o=e||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.definition?this.definition.codeHeader=t:StageMorph.prototype.codeHeaders[o]=t)},BlockMorph.prototype.mapCode=function(t,e){var o=e||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.definition?this.definition.codeMapping=t:StageMorph.prototype.codeMappings[o]=t)},BlockMorph.prototype.mappedCode=function(t){var e,o,r,i,n,s,a,h="reify"===this.selector.substr(0,5)?"reify":this.selector,l=1,p=this.definition?this.definition.spec:h,c=t||{},d=[];return e="reportGetVar"===h?this.blockSpec:this.definition?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[h]||"","reportGetVar"===h||c.hasOwnProperty(p)||(c[p]=null,this.definition?(r=this.definition.codeHeader||"",r.indexOf("<body")!==-1&&(s="",this.definition.body&&(s=this.definition.body.expression.mappedCode(c)),a=s.split("\n"),n=r.split("\n"),n.forEach(function(t,e){var o,r="";0===t.trimLeft().indexOf("<body")&&(o=t.indexOf("<body"),r=t.slice(0,o)),n[e]=t.replace(new RegExp("<body>"),a.join("\n"+r)),n[e]=n[e].replace(new RegExp("<body>","g"),a.join("\n"))}),r=n.join("\n")),c[p]=r):c[p]=StageMorph.prototype.codeHeaders[p]),o=e.split("\n"),this.inputs().forEach(function(t){d.push(t.mappedCode(c).toString())}),d.forEach(function(t){var e=t.split("\n"),r="<#"+l+">",i=new RegExp(r,"g");o.forEach(function(t,n){var s,a="";0===t.trimLeft().indexOf(r)&&(s=t.indexOf(r),a=t.slice(0,s)),o[n]=t.replace(new RegExp(r),e.join("\n"+a)),o[n]=o[n].replace(i,e.join("\n"))}),l+=1}),e=o.join("\n"),this.nextBlock&&this.nextBlock()&&(e+="\n"+this.nextBlock().mappedCode(c)),!t&&(i=[],Object.keys(c).forEach(function(t){c[t]&&i.push(c[t])}),i.length)?i.join("\n\n")+"\n\n"+e:e},BlockMorph.prototype.codeDefinitionHeader=function(){var t=this.definition?new PrototypeHatBlockMorph(this.definition):SpriteMorph.prototype.blockForSelector(this.selector),e=new HatBlockMorph,o=1;return this.definition?t:(t.inputs().forEach(function(e){var r=new TemplateSlotMorph("#"+o);t.silentReplaceInput(e,r),o+=1}),t.isPrototype=!0,e.setCategory("control"),e.setSpec("%s"),e.silentReplaceInput(e.inputs()[0],t),"control"===this.category&&e.alternateBlockColor(),e)},BlockMorph.prototype.codeMappingHeader=function(){var t=this.definition?this.definition.blockInstance():SpriteMorph.prototype.blockForSelector(this.selector),e=new HatBlockMorph,o=1;return t.inputs().forEach(function(e){var r=new TemplateSlotMorph("<#"+o+">");t.silentReplaceInput(e,r),o+=1}),t.isPrototype=!0,e.setCategory("control"),e.setSpec("%s"),e.silentReplaceInput(e.inputs()[0],t),"control"===this.category&&e.alternateBlockColor(),e},BlockMorph.prototype.eraseHoles=function(t){var e,o,r=this,i=this instanceof RingMorph,n=.5*this.edge,s=this.parts().filter(function(t){return t.isHole});this.isPredicate&&s.length>0&&(o=this.width()-this.rounding,t.clearRect(o,0,this.width(),this.height()),e=t.createLinearGradient(o-this.edge,0,this.width(),0),e.addColorStop(0,this.color.toString()),e.addColorStop(1,this.dark()),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,this.edge+n),t.lineTo(o-n,this.height()-this.edge-n),t.stroke()),s.forEach(function(e){var o=e.width(),n=Math.floor(e.height())-2;t.clearRect(e.bounds.origin.x-r.bounds.origin.x+1,e.bounds.origin.y-r.bounds.origin.y+1,i?o-2:o+1,n)})},BlockMorph.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),e=this.highlight(t?t.color:this.activeHighlight,this.activeBlur,this.activeBorder),this.addBack(e),this.fullChanged(),o&&this.hide(),e},BlockMorph.prototype.addErrorHighlight=function(){var t,e=!this.isVisible;return e&&this.show(),this.removeHighlight(),t=this.highlight(this.errorHighlight,this.activeBlur,this.activeBorder),this.addBack(t),this.fullChanged(),e&&this.hide(),t},BlockMorph.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},BlockMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},BlockMorph.prototype.highlight=function(t,e,o){var r=new BlockHighlightMorph,i=this.fullBounds(),n=useBlurredShadows&&!MorphicPreferences.isFlat?e:o;return r.setExtent(i.extent().add(2*n)),r.color=t,r.image=useBlurredShadows&&!MorphicPreferences.isFlat?this.highlightImageBlurred(t,e):this.highlightImage(t,o),r.setPosition(i.origin.subtract(new Point(n,n))),r},BlockMorph.prototype.highlightImage=function(t,e){var o,r,i,n,s;return o=this.fullBounds().extent(),r=this.fullImage(),i=newCanvas(o.add(2*e)),n=i.getContext("2d"),n.drawImage(r,0,0),n.drawImage(r,e,0),n.drawImage(r,2*e,0),n.drawImage(r,2*e,e),n.drawImage(r,2*e,2*e),n.drawImage(r,e,2*e),n.drawImage(r,0,2*e),n.drawImage(r,0,e),n.globalCompositeOperation="destination-out",n.drawImage(r,e,e),s=newCanvas(o.add(2*e)),n=s.getContext("2d"),n.drawImage(i,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=t.toString(),n.fillRect(0,0,s.width,s.height),s},BlockMorph.prototype.highlightImageBlurred=function(t,e){var o,r,i,n;return o=this.fullBounds().extent(),r=this.fullImage(),i=newCanvas(o.add(2*e)),n=i.getContext("2d"),n.shadowBlur=e,n.shadowColor=t.toString(),n.drawImage(r,e,e),n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(r,e,e),i},BlockMorph.prototype.getHighlight=function(){var t;return t=this.children.slice(0).reverse().filter(function(t){return t instanceof BlockHighlightMorph}),0!==t.length?t[0]:null},BlockMorph.prototype.outline=function(t,e){var o=new BlockHighlightMorph,r=this.fullBounds(),i=e;return o.setExtent(r.extent().add(2*i)),o.color=t,o.image=this.highlightImage(t,e),o.setPosition(r.origin.subtract(new Point(i,i))),o},BlockMorph.prototype.fixBlockColor=function(t,e){var o,r,i=t;if(this.zebraContrast||e){if(!this.zebraContrast&&e)return this.forceNormalColoring();i||this.parent&&(this.isPrototype?i=null:this instanceof ReporterBlockMorph?i=this.parent.parentThatIsA(BlockMorph):(r=this.parentThatIsA(CommandSlotMorph),r&&(i=r.parentThatIsA(BlockMorph)))),i?i.category===this.category?i.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor():(o=SpriteMorph.prototype.blockColor[this.category],this.color.eq(o)||this.alternateBlockColor()),e&&this.fixChildrensBlockColor(!0)}},BlockMorph.prototype.forceNormalColoring=function(){var t=SpriteMorph.prototype.blockColor[this.category];this.setColor(t,!0),this.setLabelColor(new Color(255,255,255),t.darker(this.labelContrast),new Point(-1,-1)),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.alternateBlockColor=function(){var t=SpriteMorph.prototype.blockColor[this.category];this.color.eq(t)?this.setColor(this.zebraContrast<0?t.darker(Math.abs(this.zebraContrast)):t.lighter(this.zebraContrast),this.hasLabels()):this.setColor(t,this.hasLabels()),this.fixLabelColor(),this.fixChildrensBlockColor(!0)},BlockMorph.prototype.ghost=function(){this.setColor(SpriteMorph.prototype.blockColor[this.category].lighter(35))},BlockMorph.prototype.fixLabelColor=function(){if(this.zebraContrast>0&&this.category){var t=SpriteMorph.prototype.blockColor[this.category];this.color.eq(t)?this.setLabelColor(new Color(255,255,255),t.darker(this.labelContrast),MorphicPreferences.isFlat?null:new Point(-1,-1)):this.setLabelColor(new Color(0,0,0),t.lighter(this.zebraContrast).lighter(2*this.labelContrast),MorphicPreferences.isFlat?null:new Point(1,1))}},BlockMorph.prototype.fixChildrensBlockColor=function(t){var e=this;this.children.forEach(function(o){o instanceof CommandBlockMorph?o.fixBlockColor(null,t):o instanceof SyntaxElementMorph&&(o.fixBlockColor(e,t),o instanceof BooleanSlotMorph&&o.drawNew())})},BlockMorph.prototype.setCategory=function(t){this.category=t,this.startLayout(),this.fixBlockColor(),this.endLayout()},BlockMorph.prototype.hasLabels=function(){return this.children.some(function(t){return t instanceof StringMorph})},BlockMorph.prototype.fullCopy=function(t){if(t){if(!this.hasBlockVars())return copy(this);t=!1}var e=BlockMorph.uber.fullCopy.call(this);return e.removeHighlight(),e.isDraggable=!0,this.instantiationSpec&&e.setSpec(this.instantiationSpec),e.allChildren().filter(function(t){return t instanceof SyntaxElementMorph&&(t.cachedInputs=null,t.definition&&t.initializeVariables()),!isNil(t.comment)}).forEach(function(t){var e=t.comment.fullCopy();t.comment=e,e.block=t}),e.cachedInputs=null,
e},BlockMorph.prototype.reactToTemplateCopy=function(){this.forceNormalColoring()},BlockMorph.prototype.hasBlockVars=function(){return this.anyChild(function(t){return t.definition&&t.definition.variableNames.length})},BlockMorph.prototype.mouseClickLeft=function(){var t,e=this.topBlock(),o=e.receiver(),r=16===this.world().currentKey;return r&&!this.isTemplate?this.focus():e instanceof PrototypeHatBlockMorph?e.mouseClickLeft():void(o&&(t=o.parentThatIsA(StageMorph),t&&t.threads.toggleProcess(e)))},BlockMorph.prototype.focus=function(){var t,e=this.parentThatIsA(ScriptsMorph),o=this.world();e&&ScriptsMorph.prototype.enableKeyboard&&(e.focus&&e.focus.stopEditing(),o.stopEditing(),t=new ScriptFocusMorph(e,this),e.focus=t,t.getFocus(o),this instanceof HatBlockMorph&&t.nextCommand())},BlockMorph.prototype.activeProcess=function(){var t,e=this.topBlock(),o=e.receiver();return e instanceof PrototypeHatBlockMorph?null:o&&(t=o.parentThatIsA(StageMorph))?t.threads.findProcess(e):null},BlockMorph.prototype.thumbnail=function(t,e){var o,r,i,n,s=this.nextBlock(),a=12;return s&&(s.isVisible=!1),o=this.fullBounds().extent(),r=newCanvas(new Point(e?Math.min(o.x*t,e):o.x*t,o.y*t)),i=r.getContext("2d"),i.scale(t,t),i.drawImage(this.fullImage(),0,0),e&&o.x*t>e&&(n=i.createLinearGradient(r.width/t-a,0,r.width/t,0),n.addColorStop(0,"transparent"),n.addColorStop(1,"black"),i.globalCompositeOperation="destination-out",i.fillStyle=n,i.fillRect(r.width/t-a,0,r.width/t,r.height/t)),s&&(s.isVisible=!0),r},BlockMorph.prototype.scriptPic=function(){var t=this.fullImage(),e=this.stackFullBounds(),o=newCanvas(e.extent()),r=o.getContext("2d");return this.allComments().forEach(function(t){r.drawImage(t.fullImageClassic(),t.fullBounds().left()-e.left(),t.top()-e.top())}),r.drawImage(t,0,0),o},BlockMorph.prototype.rootForGrab=function(){return this},BlockMorph.prototype.wantsDropOf=function(t){return(t instanceof ArgMorph||t instanceof StringMorph||t instanceof TextMorph)&&!this.isTemplate},BlockMorph.prototype.reactToDropOf=function(t){t.isDraggable=!1,t instanceof InputSlotMorph?t.drawNew():t instanceof MultiArgMorph&&t.fixLayout(),this.fixLayout(),this.buildSpec()},BlockMorph.prototype.situation=function(){var t=this.parentThatIsA(ScriptsMorph);return t?{origin:t,position:this.position().subtract(t.position())}:BlockMorph.uber.situation.call(this)},BlockMorph.prototype.prepareToBeGrabbed=function(t){var e=this;this.allComments().forEach(function(o){o.startFollowing(e,t.world)})},BlockMorph.prototype.justDropped=function(){this.alpha=1,this.allComments().forEach(function(t){t.stopFollowing()})},BlockMorph.prototype.allComments=function(){return this.allChildren().filter(function(t){return!isNil(t.comment)}).map(function(t){return t.comment})},BlockMorph.prototype.destroy=function(){this.allComments().forEach(function(t){t.destroy()}),(!this.parent||!this.parent.topBlock&&this.activeProcess())&&this.activeProcess().stop(),BlockMorph.uber.destroy.call(this)},BlockMorph.prototype.stackHeight=function(){var t=this.fullBounds(),e=Math.max(this.allComments().map(function(t){return t.bottom()}))||this.bottom();return Math.max(t.bottom(),e)-t.top()},BlockMorph.prototype.stackFullBounds=function(){var t=this.fullBounds();return this.allComments().forEach(function(e){t.mergeWith(e.bounds)}),t},BlockMorph.prototype.stackWidth=function(){var t=this.fullBounds(),e=Math.max(this.allComments().map(function(t){return t.right()}))||this.right();return Math.max(t.right(),e)-t.left()},BlockMorph.prototype.snap=function(){var t,e,o,r=this.topBlock();r.allComments().forEach(function(t){t.align(r)}),this.getHighlight()&&this!==r&&this.removeHighlight(),r.getHighlight()&&r.addHighlight(r.removeHighlight()),"receiveCondition"===this.selector&&(t=r.receiver(),t&&(e=t.parentThatIsA(StageMorph),e&&(e.enableCustomHatBlocks=!0,e.threads.pauseCustomHatBlocks=!1,o=e.parentThatIsA(IDE_Morph),o&&o.controlBar.stopButton.refresh())))},CommandBlockMorph.prototype=new BlockMorph,CommandBlockMorph.prototype.constructor=CommandBlockMorph,CommandBlockMorph.uber=BlockMorph.prototype,CommandBlockMorph.prototype.init=function(t){CommandBlockMorph.uber.init.call(this,t),this.setExtent(new Point(200,100),t),this.partOfCustomCommand=!1,this.exitTag=null},CommandBlockMorph.prototype.blockSequence=function(){var t=this.nextBlock(),e=[this];return t&&(e=e.concat(t.blockSequence())),e},CommandBlockMorph.prototype.bottomBlock=function(){return this.nextBlock()?this.nextBlock().bottomBlock():this},CommandBlockMorph.prototype.nextBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof CommandBlockMorph&&!t.isPrototype});var e=this.nextBlock(),o=this.parentThatIsA(CommandSlotMorph);this.add(t),e&&t.bottomBlock().nextBlock(e),t.setPosition(new Point(this.left(),this.bottom()-this.corner)),o&&o.fixLayout()},CommandBlockMorph.prototype.topAttachPoint=function(){return new Point(this.dentCenter(),this.top())},CommandBlockMorph.prototype.bottomAttachPoint=function(){return new Point(this.dentCenter(),this.bottom())},CommandBlockMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset},CommandBlockMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandBlockMorph.prototype.attachTargets=function(){var t=[];return this instanceof HatBlockMorph||this.parent instanceof SyntaxElementMorph||t.push({point:this.topAttachPoint(),element:this,loc:"top",type:"block"}),this.isStop()||t.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"}),t},CommandBlockMorph.prototype.allAttachTargets=function(t){var e,o=this,r=t||this.parent,i=[];return this instanceof HatBlockMorph&&t.rejectsHats?i:(e=r.children.filter(function(t){return t!==o&&t instanceof SyntaxElementMorph&&!t.isTemplate}),e.forEach(function(t){t.forAllChildren(function(t){t.attachTargets&&t.attachTargets().forEach(function(t){i.push(t)})})}),i)},CommandBlockMorph.prototype.closestAttachTarget=function(t){var e,o=t||this.parent,r=this.bottomBlock(),i=null,n=Math.max(2*this.corner+this.dent,this.minSnapDistance),s=[],a=1e3;return this instanceof HatBlockMorph||s.push({point:this.topAttachPoint(),loc:"top"}),r.isStop()||s.push({point:r.bottomAttachPoint(),loc:"bottom"}),this.allAttachTargets(o).forEach(function(t){s.forEach(function(o){o.loc!==t.loc&&(e=o.point.distanceTo(t.point),e<n&&e<a&&(a=e,i=t))})}),i},CommandBlockMorph.prototype.snap=function(){var t,e,o,r=this.closestAttachTarget(),i=this.parentThatIsA(ScriptsMorph);return i.clearDropHistory(),i.lastDroppedBlock=this,null===r?(this.startLayout(),this.fixBlockColor(),this.endLayout(),void CommandBlockMorph.uber.snap.call(this)):(i.lastDropTarget=r,this.startLayout(),"bottom"===r.loc?("slot"===r.type?(this.removeHighlight(),i.lastNextBlock=r.element.nestedBlock(),r.element.nestedBlock(this)):(i.lastNextBlock=r.element.nextBlock(),r.element.nextBlock(this)),this.isStop()&&(t=this.nextBlock(),t&&(i.add(t),t.moveBy(this.extent().floorDivideBy(2)),o=this.parentThatIsA(CommandSlotMorph),o&&o.fixLayout()))):"top"===r.loc&&(r.element.removeHighlight(),e=this.bottomBlock().bottom()-this.bottom(),this.setBottom(r.element.top()+this.corner-e),this.setLeft(r.element.left()),this.bottomBlock().nextBlock(r.element)),this.fixBlockColor(),this.endLayout(),CommandBlockMorph.uber.snap.call(this),void(this.snapSound&&this.snapSound.play()))},CommandBlockMorph.prototype.isStop=function(){return["doStopThis","doStop","doStopBlock","doStopAll","doForever","doReport","removeClone"].indexOf(this.selector)>-1},CommandBlockMorph.prototype.userDestroy=function(){if(this.nextBlock())return void this.userDestroyJustThis();var t=this.parentThatIsA(CSlotMorph);this.destroy(),t&&t.fixLayout()},CommandBlockMorph.prototype.userDestroyJustThis=function(){var t,e,o=this.parentThatIsA(ScriptsMorph),r=this.parentThatIsA(CommandSlotMorph),i=this.nextBlock(),n=this.parentThatIsA(CSlotMorph);this.topBlock().fullChanged(),this.parent&&(t=this.parent.parentThatIsA(CommandBlockMorph)),t&&t.nextBlock()===this?e=t:r&&r.nestedBlock()===this&&(e=r),this.destroy(),i?e instanceof CommandSlotMorph?e.nestedBlock(i):e instanceof CommandBlockMorph?e.nextBlock(i):o.add(i):n&&n.fixLayout()},CommandBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.drawTop(t),this.drawBody(t),this.drawBottom(t),MorphicPreferences.isFlat?nop():(this.drawTopDentEdge(t,0,0),this.drawBottomDentEdge(t,0,this.height()-this.corner),this.drawLeftEdge(t),this.drawRightEdge(t),this.drawTopLeftEdge(t),this.drawBottomRightEdge(t)),this.eraseHoles(t)},CommandBlockMorph.prototype.drawBody=function(t){t.fillRect(0,Math.floor(this.corner),this.width(),this.height()-Math.floor(3*this.corner)+1)},CommandBlockMorph.prototype.drawTop=function(t){t.beginPath(),t.arc(this.corner,this.corner,this.corner,radians(-180),radians(-90),!1),this.drawDent(t,0,0),t.arc(this.width()-this.corner,this.corner,this.corner,radians(-90),radians(-0),!1),t.closePath(),t.fill()},CommandBlockMorph.prototype.drawBottom=function(t){var e=this.height()-2*this.corner;t.beginPath(),t.arc(this.corner,e,this.corner,radians(180),radians(90),!0),this.isStop()||this.drawDent(t,0,this.height()-this.corner),t.arc(this.width()-this.corner,e,this.corner,radians(90),radians(0),!0),t.closePath(),t.fill()},CommandBlockMorph.prototype.drawDent=function(t,e,o){var r=e+2*this.corner+this.inset;t.lineTo(e+this.corner+this.inset,o),t.lineTo(r,o+this.corner),t.lineTo(r+this.dent,o+this.corner),t.lineTo(e+3*this.corner+this.inset+this.dent,o),t.lineTo(this.width()-this.corner,o)},CommandBlockMorph.prototype.drawTopDentEdge=function(t,e,o){var r,i,n,s,a=.5*this.edge,h=e+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",r=t.createLinearGradient(0,o,0,o+this.edge),r.addColorStop(0,this.cachedClrBright),r.addColorStop(1,this.cachedClr),t.strokeStyle=r,t.beginPath(),t.moveTo(this.corner,o+a),t.lineTo(e+this.corner+this.inset,o+a),t.stroke(),t.strokeStyle=r,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent+a,o+a),t.lineTo(this.width()-this.corner,o+a),t.stroke(),s=e+this.corner+this.inset,n=t.createLinearGradient(s-this.edge,o+this.edge,s,o),n.addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrBright),t.strokeStyle=n,t.beginPath(),t.moveTo(e+this.corner+this.inset,o+a),t.lineTo(h,o+this.corner+a),t.stroke(),i=t.createLinearGradient(0,o+this.corner,0,o+this.corner+this.edge),i.addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(h,o+this.corner+a),t.lineTo(h+this.dent,o+this.corner+a),t.stroke()},CommandBlockMorph.prototype.drawBottomDentEdge=function(t,e,o){var r,i,n,s=.5*this.edge,a=e+2*this.corner+this.inset;return t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",r=t.createLinearGradient(0,o-this.edge,0,o),r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(this.corner,o-s),this.isStop()?t.lineTo(this.width()-this.corner,o-s):t.lineTo(e+this.corner+this.inset-s,o-s),t.stroke(),this.isStop()?null:(i=t.createLinearGradient(0,o+this.corner-this.edge,0,o+this.corner),i.addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(a+s,o+this.corner-s),t.lineTo(a+this.dent,o+this.corner-s),t.stroke(),n=t.createLinearGradient(e+a+this.dent-this.edge,o+this.corner-this.edge,e+a+this.dent,o+this.corner),n.addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrDark),t.strokeStyle=n,t.beginPath(),t.moveTo(e+a+this.dent,o+this.corner-s),t.lineTo(e+3*this.corner+this.inset+this.dent,o-s),t.stroke(),t.strokeStyle=r,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent,o-s),t.lineTo(this.width()-this.corner,o-s),void t.stroke())},CommandBlockMorph.prototype.drawFlatBottomDentEdge=function(t){this.isStop()||(t.fillStyle=this.color.darker(this.contrast/2).toString(),t.beginPath(),this.drawDent(t,0,this.height()-this.corner),t.closePath(),t.fill())},CommandBlockMorph.prototype.drawLeftEdge=function(t){var e=.5*this.edge,o=t.createLinearGradient(0,0,this.edge,0);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.corner),t.lineTo(e,this.height()-2*this.corner-e),t.stroke()},CommandBlockMorph.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,r=this.width();e=t.createLinearGradient(r-this.edge,0,r,0),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(r-o,this.corner+o),t.lineTo(r-o,this.height()-2*this.corner),t.stroke()},CommandBlockMorph.prototype.drawTopLeftEdge=function(t){var e,o=.5*this.edge;e=t.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(this.corner,this.corner,this.corner-o,radians(-180),radians(-90),!1),t.stroke()},CommandBlockMorph.prototype.drawBottomRightEdge=function(t){var e,o=.5*this.edge,r=this.width()-this.corner,i=this.height()-2*this.corner;e=t.createRadialGradient(r,i,this.corner,r,i,this.corner-this.edge),e.addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(r,i,this.corner-o,radians(90),radians(0),!0),t.stroke()},HatBlockMorph.prototype=new CommandBlockMorph,HatBlockMorph.prototype.constructor=HatBlockMorph,HatBlockMorph.uber=CommandBlockMorph.prototype,HatBlockMorph.prototype.init=function(){HatBlockMorph.uber.init.call(this,!0),this.setExtent(new Point(300,150))},HatBlockMorph.prototype.blockSequence=function(){var t=HatBlockMorph.uber.blockSequence.call(this);return t.shift(),t},HatBlockMorph.prototype.drawTop=function(t){var e=this.hatWidth,o=this.hatHeight,r=(4*o*o+e*e)/(8*o),i=degrees(4*Math.atan(2*o/e)),n=i/2,s=Math.min(1.7*e,this.width()-this.corner);t.beginPath(),t.moveTo(0,o+this.corner),t.arc(e/2,r,r,radians(-n-90),radians(-90),!1),t.bezierCurveTo(e,0,e,o,s,o),t.arc(this.width()-this.corner,o+this.corner,this.corner,radians(-90),radians(-0),!1),t.closePath(),t.fill()},HatBlockMorph.prototype.drawBody=function(t){t.fillRect(0,this.hatHeight+Math.floor(this.corner)-1,this.width(),this.height()-Math.floor(3*this.corner)-this.hatHeight+2)},HatBlockMorph.prototype.drawLeftEdge=function(t){var e=.5*this.edge,o=t.createLinearGradient(0,0,this.edge,0);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.hatHeight+e),t.lineTo(e,this.height()-2*this.corner-e),t.stroke()},HatBlockMorph.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,r=this.width();e=t.createLinearGradient(r-this.edge,0,r,0),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(r-o,this.corner+this.hatHeight+o),t.lineTo(r-o,this.height()-2*this.corner),t.stroke()},HatBlockMorph.prototype.drawTopDentEdge=function(){return null},HatBlockMorph.prototype.drawTopLeftEdge=function(t){var e,o=.5*this.edge,r=this.hatWidth,i=this.hatHeight,n=(4*i*i+r*r)/(8*i),s=degrees(4*Math.atan(2*i/r)),a=s/2,h=Math.min(1.7*r,this.width()-this.corner);e=t.createRadialGradient(r/2,n,n-this.edge,r/2,n,n),e.addColorStop(1,this.cachedClrBright),e.addColorStop(0,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(Math.round(r/2),n,n-o,radians(-a-90),radians(-90),!1),t.moveTo(r/2,o),t.bezierCurveTo(r,o,r,i+o,h,i+o),t.lineTo(this.width()-this.corner,i+o),t.stroke()},ReporterBlockMorph.prototype=new BlockMorph,ReporterBlockMorph.prototype.constructor=ReporterBlockMorph,ReporterBlockMorph.uber=BlockMorph.prototype,ReporterBlockMorph.prototype.init=function(t,e){ReporterBlockMorph.uber.init.call(this,e),this.isPredicate=t||!1,this.setExtent(new Point(200,80),e),this.cachedSlotSpec=null},ReporterBlockMorph.prototype.snap=function(t){var e,o,r=this.parent;return this.cachedSlotSpec=null,r instanceof ScriptsMorph?(r.clearDropHistory(),r.lastDroppedBlock=this,o=r.closestInput(this,t),null!==o&&(r.lastReplacedInput=o,r.lastDropTarget=o.parent,o instanceof MultiArgMorph?(r.lastPreservedBlocks=o.inputs(),r.lastReplacedInput=o.fullCopy()):o instanceof CommandSlotMorph&&(r.lastReplacedInput=o,e=o.nestedBlock(),e&&(e=e.fullCopy(),r.add(e),e.moveBy(e.extent()),e.fixBlockColor(),r.lastPreservedBlocks=[e])),o.parent.replaceInput(o,this),this.snapSound&&this.snapSound.play()),this.startLayout(),this.fixBlockColor(),this.endLayout(),void ReporterBlockMorph.uber.snap.call(this)):null},ReporterBlockMorph.prototype.prepareToBeGrabbed=function(t){var e=this.position();nop(t),(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)&&(this.parent.revertToDefaultInput(this),this.setPosition(e)),ReporterBlockMorph.uber.prepareToBeGrabbed.call(this,t),this.alpha=.85,this.cachedSlotSpec=null},ReporterBlockMorph.prototype.blockSequence=function(){return this},ReporterBlockMorph.prototype.isUnevaluated=function(){var t=this.getSlotSpec();return"%anyUE"===t||"%boolUE"===t||"%f"===t},ReporterBlockMorph.prototype.isLocked=function(){return this.isStatic||"%t"===this.getSlotSpec()},ReporterBlockMorph.prototype.getSlotSpec=function(){return this.cachedSlotSpec||(this.cachedSlotSpec=this.determineSlotSpec()),this.cachedSlotSpec},ReporterBlockMorph.prototype.determineSlotSpec=function(){var t,e;return this.parent instanceof BlockMorph&&(t=this.parent.parts().filter(function(t){return!(t instanceof BlockHighlightMorph)}),e=t.indexOf(this),e!==-1&&this.parent.blockSpec)?this.parseSpec(this.parent.blockSpec)[e]:this.parent instanceof MultiArgMorph?this.parent.slotSpec:this.parent instanceof TemplateSlotMorph?this.parent.getSpec():null},ReporterBlockMorph.prototype.mouseClickLeft=function(t){var e;return this.parent instanceof BlockInputFragmentMorph?this.parent.mouseClickLeft():void(this.parent instanceof TemplateSlotMorph?(e=this.parent.parent&&this.parent.parent.parent&&this.parent.parent.parent instanceof RingMorph?"Input name":"%blockVars"===this.parent.parent.elementSpec?"Block variable name":"Script variable name",new DialogBoxMorph(this,this.userSetSpec,this).prompt(e,this.blockSpec,this.world())):ReporterBlockMorph.uber.mouseClickLeft.call(this,t))},ReporterBlockMorph.prototype.ExportResultPic=function(){var t,e=this.topBlock(),o=e.receiver();e===this&&o&&(t=o.parentThatIsA(StageMorph),t&&(t.threads.stopProcess(e),t.threads.startProcess(e,!1,!0)))},ReporterBlockMorph.prototype.userDestroy=function(){this.topBlock().fullChanged(),this.prepareToBeGrabbed(this.world().hand),this.destroy()},ReporterBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.isPredicate?this.drawDiamond(t):this.drawRounded(t),this.eraseHoles(t)},ReporterBlockMorph.prototype.drawRounded=function(t){var e,o=this.height(),r=Math.min(this.rounding,o/2),i=this.width(),n=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.arc(r,r,r,radians(-180),radians(-90),!1),t.arc(i-r,r,r,radians(-90),radians(-0),!1),t.arc(i-r,o-r,r,radians(0),radians(90),!1),t.arc(r,o-r,r,radians(90),radians(180),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",e=t.createRadialGradient(r,o-r,r-this.edge,r,o-r,r+this.edge),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(r,o-r,r-n,radians(90),radians(180),!1),t.stroke(),e=t.createRadialGradient(i-r,r,r-this.edge,i-r,r,r+this.edge),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(i-r,r,r-n,radians(-90),radians(0),!1),t.stroke(),e=t.createLinearGradient(0,0,0,this.edge),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,n),t.lineTo(i-r+n,n),t.stroke(),e=t.createRadialGradient(r,r,r-this.edge,r,r,r),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(r,r,r-n,radians(180),radians(270),!1),t.stroke(),e=t.createRadialGradient(i-r,o-r,r-this.edge,i-r,o-r,r),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(i-r,o-r,r-n,radians(0),radians(90),!1),t.stroke(),e=t.createLinearGradient(0,o-this.edge,0,o),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,o-n),t.lineTo(i-r+n,o-n),t.stroke(),e=t.createLinearGradient(0,0,this.edge,0),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,r),t.lineTo(n,o-r),t.stroke(),e=t.createLinearGradient(i-this.edge,0,i,0),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,r+n),t.lineTo(i-n,o-r),t.stroke())},ReporterBlockMorph.prototype.drawDiamond=function(t){var e,o=this.width(),r=this.height(),i=Math.floor(r/2),n=this.rounding,s=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,i),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,i),t.lineTo(o-n,r),t.lineTo(n,r),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",e=t.createLinearGradient(-n,0,n,0),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(s,i),t.lineTo(n,r-s),t.closePath(),t.stroke(),e=t.createLinearGradient(o-n,0,o+n,0),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o-s,i),t.lineTo(o-n,s),t.closePath(),t.stroke(),e=t.createLinearGradient(0,0,n,0),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,i),t.lineTo(n,s),t.closePath(),t.stroke(),e=t.createLinearGradient(0,0,0,this.edge),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.closePath(),t.stroke(),e=t.createLinearGradient(o-n,0,o,0),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,r-s),t.lineTo(o-s,i),t.closePath(),t.stroke(),e=t.createLinearGradient(0,r-this.edge,0,r),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,r-s),t.lineTo(o-n-s,r-s),t.closePath(),t.stroke())},RingMorph.prototype=new ReporterBlockMorph,RingMorph.prototype.constructor=RingMorph,RingMorph.uber=ReporterBlockMorph.prototype,RingMorph.prototype.isCachingInputs=!1,RingMorph.prototype.init=function(){RingMorph.uber.init.call(this),this.category="other",this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.setExtent(new Point(200,80))},RingMorph.prototype.rootForGrab=function(){return this.isDraggable?this:BlockMorph.uber.rootForGrab.call(this)},RingMorph.prototype.embed=function(t,e){var o;this.color=SpriteMorph.prototype.blockColor.other,this.isDraggable=!0,t instanceof CommandBlockMorph?(this.isStatic=!1,this.setSpec("%rc %ringparms"),this.selector="reifyScript",o=this.parts()[0],o.nestedBlock(t)):t.isPredicate?(this.isStatic=!0,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate",o=this.parts()[0],o.silentReplaceInput(o.contents(),t)):t instanceof BooleanSlotMorph?(this.isStatic=!1,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate",o=this.parts()[0],o.silentReplaceInput(o.contents(),t)):(this.isStatic=!1,this.setSpec("%rr %ringparms"),this.selector="reifyReporter",o=this.parts()[0],o.silentReplaceInput(o.contents(),t)),o=this.parts()[1],e&&e.forEach(function(t){o.addInput(t)}),this.fixBlockColor(null,!0)},RingMorph.prototype.vanishForSimilar=function(){var t=this.parts()[0],e=t.nestedBlock();return e&&this.parent instanceof SyntaxElementMorph?this.parent instanceof RingReporterSlotMorph||this.parent instanceof RingCommandSlotMorph?null:void(("reportGetVar"===e.selector||e instanceof RingMorph)&&this.parent.silentReplaceInput(this,e)):null},RingMorph.prototype.contents=function(){return this.parts()[0].nestedBlock()},RingMorph.prototype.inputNames=function(){return this.parts()[1].evaluate()},RingMorph.prototype.dataType=function(){switch(this.selector){case"reifyScript":return"command";case"reifyPredicate":return"predicate";default:return"reporter"}},RingMorph.prototype.fixBlockColor=function(t,e){var o=this.parts()[0];RingMorph.uber.fixBlockColor.call(this,t,e),o.fixLayout()},ScriptsMorph.prototype=new FrameMorph,ScriptsMorph.prototype.constructor=ScriptsMorph,ScriptsMorph.uber=FrameMorph.prototype,ScriptsMorph.prototype.cleanUpMargin=20,ScriptsMorph.prototype.cleanUpSpacing=15,ScriptsMorph.prototype.isPreferringEmptySlots=!0,ScriptsMorph.prototype.enableKeyboard=!0,ScriptsMorph.prototype.init=function(t){this.owner=t||null,this.feedbackColor=SyntaxElementMorph.prototype.feedbackColor,this.feedbackMorph=new BoxMorph,this.rejectsHats=!1,this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null,this.focus=null,ScriptsMorph.uber.init.call(this),this.setColor(new Color(70,70,70)),this.noticesTransparentClick=!0},ScriptsMorph.prototype.fullCopy=function(t){var e,o=new ScriptsMorph,r=this.position();return this.focus&&this.focus.stopEditing(),this.children.forEach(function(i){i.block||(e=i.fullCopy(t),o.add(e),t||(e.setPosition(i.position().subtract(r)),e instanceof BlockMorph&&e.allComments().forEach(function(t){t.align(e)})))}),t||o.adjustBounds(),o},ScriptsMorph.prototype.step=function(){var t,e=this.world(),o=e.hand;return this.feedbackMorph.parent&&(this.feedbackMorph.destroy(),this.feedbackMorph.parent=null),this.focus&&(!e.keyboardReceiver||e.keyboardReceiver instanceof StageMorph)&&this.focus.getFocus(e),0===o.children.length?null:this.bounds.containsPoint(o.bounds.origin)?(t=o.children[0],(t instanceof BlockMorph||t instanceof CommentMorph)&&contains(o.morphAtPointer().allParents(),this)?void(t instanceof CommentMorph?this.showCommentDropFeedback(t,o):t instanceof ReporterBlockMorph?this.showReporterDropFeedback(t,o):this.showCommandDropFeedback(t)):null):null},ScriptsMorph.prototype.showReporterDropFeedback=function(t,e){var o=this.closestInput(t,e);return null===o?null:(this.feedbackMorph.bounds=o.fullBounds().expandBy(Math.max(2*t.edge,t.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),o instanceof MultiArgMorph?(this.feedbackMorph.color=SpriteMorph.prototype.blockColor.lists.copy(),this.feedbackMorph.borderColor=SpriteMorph.prototype.blockColor.lists):(this.feedbackMorph.color=this.feedbackColor.copy(),this.feedbackMorph.borderColor=this.feedbackColor),this.feedbackMorph.color.a=.5,this.feedbackMorph.drawNew(),void this.feedbackMorph.changed())},ScriptsMorph.prototype.showCommandDropFeedback=function(t){var e,o;return(o=t.closestAttachTarget(this))?(this.add(this.feedbackMorph),this.feedbackMorph.border=0,this.feedbackMorph.edge=0,this.feedbackMorph.alpha=1,this.feedbackMorph.setExtent(new Point(o.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.feedbackMorph.color=this.feedbackColor,this.feedbackMorph.drawNew(),this.feedbackMorph.changed(),e=o.point.y,"bottom"===o.loc&&("block"===o.type?o.element.nextBlock()&&(e-=SyntaxElementMorph.prototype.corner):"slot"===o.type&&o.element.nestedBlock()&&(e-=SyntaxElementMorph.prototype.corner)),void this.feedbackMorph.setPosition(new Point(o.element.left(),e))):null},ScriptsMorph.prototype.showCommentDropFeedback=function(t,e){var o=this.closestBlock(t,e);return o?(this.feedbackMorph.bounds=o.bounds.expandBy(Math.max(2*BlockMorph.prototype.edge,BlockMorph.prototype.reporterDropFeedbackPadding)),this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding,this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.add(this.feedbackMorph),this.feedbackMorph.color=t.color.copy(),this.feedbackMorph.color.a=.25,this.feedbackMorph.borderColor=t.titleBar.color,this.feedbackMorph.drawNew(),void this.feedbackMorph.changed()):null},ScriptsMorph.prototype.closestInput=function(t,e){function o(t,e){return!(t instanceof MultiArgMorph)||(e?t.arrows().bounds.containsPoint(e):t.arrows().bounds.intersects(s))}var r,i,n,s=t.fullBoundsNoShadow(),a=this.children.filter(function(t){return t instanceof BlockMorph&&t.fullBounds().intersects(s)}),h=t.allInputs();if(n=[],a.forEach(function(t){n=n.concat(t.allInputs())}),0===n.length)return null;if(this.isPreferringEmptySlots){if(e&&(r=e.position(),i=detect(n,function(t){return(t instanceof InputSlotMorph||t instanceof ArgMorph&&!(t instanceof CommandSlotMorph)&&!(t instanceof MultiArgMorph)||t instanceof RingMorph&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.containsPoint(r)&&!contains(h,t)})))return i;if(i=detect(n,function(t){return(t instanceof InputSlotMorph||t instanceof ArgMorph||t instanceof RingMorph&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.intersects(s)&&!contains(h,t)&&o(t)}))return i}return e&&(r=e.position(),i=detect(n,function(e){return e!==t&&!e.isLocked()&&e.bounds.containsPoint(r)&&!(e.parent instanceof PrototypeHatBlockMorph)&&!contains(h,e)}))?i:detect(n,function(e){return e!==t&&!e.isLocked()&&e.fullBounds().intersects(s)&&!(e.parent instanceof PrototypeHatBlockMorph)&&!contains(h,e)})},ScriptsMorph.prototype.closestBlock=function(t,e){var o,r,i,n=t.bounds,s=this.children.filter(function(t){return t instanceof BlockMorph&&t.fullBounds().intersects(n)});return i=[],s.forEach(function(t){i=i.concat(t.allChildren().slice(0).reverse().filter(function(t){return t instanceof BlockMorph&&!t.isTemplate}))}),0===i.length?null:e&&(o=e.position(),r=detect(i,function(t){return!t.comment&&!t.isPrototype&&t.bounds.containsPoint(o)}))?r:detect(i,function(t){return!t.comment&&!t.isPrototype&&t.bounds.intersects(n)})},ScriptsMorph.prototype.userMenu=function(){var t,e=new MenuMorph(this),o=this.parentThatIsA(IDE_Morph),r=this,i=this.owner,n=i.parentThatIsA(StageMorph);return o||(t=this.parentThatIsA(BlockEditorMorph),t&&(o=t.target.parentThatIsA(IDE_Morph))),e.addItem("clean up","cleanUp","arrange scripts\nvertically"),e.addItem("add comment","addComment"),this.lastDroppedBlock&&e.addItem("undrop","undrop","undo the last\nblock drop\nin this pane"),e.addItem("scripts pic...","exportScriptsPicture","open a new window\nwith a picture of all scripts"),o&&(e.addLine(),e.addItem("make a block...",function(){new BlockDialogMorph(null,function(t){""!==t.spec&&(t.isGlobal?n.globalBlocks.push(t):i.customBlocks.push(t),o.flushPaletteCache(),o.refreshPalette(),new BlockEditorMorph(t,i).popUp())},r).prompt("Make a block",null,r.world())})),e},ScriptsMorph.prototype.cleanUp=function(){var t=this.topLeft(),e=this.cleanUpMargin,o=this;this.children.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}).forEach(function(r){r instanceof CommentMorph&&r.block||(r.setPosition(t.add(new Point(o.cleanUpMargin,e))),r instanceof BlockMorph&&r.allComments().forEach(function(t){t.align(r,!0)}),e+=r.stackHeight()+o.cleanUpSpacing);
}),this.parent&&this.setPosition(this.parent.topLeft()),this.adjustBounds()},ScriptsMorph.prototype.exportScriptsPicture=function(){var t=this.scriptsPicture(),e=this.world().children[0];t&&e.saveCanvasAs(t,e.projetName||localize("Untitled")+" "+localize("script pic"),!0)},ScriptsMorph.prototype.scriptsPicture=function(){var t,e,o;if(0!==this.children.length)return t=this.children[0].fullBounds(),this.children.forEach(function(e){e.isVisible&&(t=t.merge(e.fullBounds()))}),e=newCanvas(t.extent()),o=e.getContext("2d"),this.children.forEach(function(e){var r=e.fullBounds().origin;e.isVisible&&o.drawImage(e.fullImageClassic(),r.x-t.origin.x,r.y-t.origin.y)}),e},ScriptsMorph.prototype.addComment=function(){(new CommentMorph).pickUp(this.world())},ScriptsMorph.prototype.undrop=function(){this.lastDroppedBlock&&(this.lastDroppedBlock instanceof CommandBlockMorph?(this.lastNextBlock&&this.add(this.lastNextBlock),this.lastDropTarget&&("bottom"===this.lastDropTarget.loc?"slot"===this.lastDropTarget.type?this.lastNextBlock&&this.lastDropTarget.element.nestedBlock(this.lastNextBlock):this.lastNextBlock&&this.lastDropTarget.element.nextBlock(this.lastNextBlock):"top"===this.lastDropTarget.loc&&this.add(this.lastDropTarget.element))):this.lastDropTarget&&(this.lastDropTarget.replaceInput(this.lastDroppedBlock,this.lastReplacedInput),this.lastDropTarget.fixBlockColor(null,!0),this.lastPreservedBlocks&&this.lastPreservedBlocks.forEach(function(t){t.destroy()})),this.lastDroppedBlock.pickUp(this.world()),this.clearDropHistory())};ScriptsMorph.prototype.clearDropHistory=function(){this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null};ScriptsMorph.prototype.sortedElements=function(){var t=this.children.filter(function(t){return!(t instanceof CommentMorph)||!t.block});return t.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}),t},ScriptsMorph.prototype.fixMultiArgs=function(){var t=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.forAllChildren(function(t){t instanceof MultiArgMorph&&t.fixLayout()}),Morph.prototype.trackChanges=t},ScriptsMorph.prototype.wantsDropOf=function(t){return t instanceof HatBlockMorph?!this.rejectsHats:t instanceof SyntaxElementMorph||t instanceof CommentMorph},ScriptsMorph.prototype.reactToDropOf=function(t,e){(t instanceof BlockMorph||t instanceof CommentMorph)&&t.snap(e),this.adjustBounds()},ScriptsMorph.prototype.mouseClickLeft=function(t){var e=16===this.world().currentKey;return e?this.edit(t):void(this.focus&&this.focus.stopEditing())},ScriptsMorph.prototype.edit=function(t){var e=this.world();this.focus&&this.focus.stopEditing(),e.stopEditing(),ScriptsMorph.prototype.enableKeyboard&&(this.focus=new ScriptFocusMorph(this,this,t),this.focus.getFocus(e))},ArgMorph.prototype=new SyntaxElementMorph,ArgMorph.prototype.constructor=ArgMorph,ArgMorph.uber=SyntaxElementMorph.prototype,ArgMorph.prototype.init=function(t,e){this.type=t||null,this.isHole=!1,ArgMorph.uber.init.call(this,e),this.color=new Color(0,17,173),this.setExtent(new Point(50,50),e)},ArgMorph.prototype.executeOnSliderEdit=!1,ArgMorph.prototype.reactToSliderEdit=function(){var t,e,o,r;if(this.executeOnSliderEdit&&(t=this.parentThatIsA(BlockMorph))){if(e=t.topBlock(),o=e.receiver(),e instanceof PrototypeHatBlockMorph)return;o&&(r=o.parentThatIsA(StageMorph),r&&r.isThreadSafe?r.threads.startProcess(e,r.isThreadSafe):e.mouseClickLeft())}},ArgMorph.prototype.justDropped=function(){this instanceof CommandSlotMorph||(this.drawNew(),this.changed())},ArgMorph.prototype.getSpec=function(){return"%s"},ArgMorph.prototype.drawNew=function(){"list"===this.type?(this.image=this.listIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):"object"===this.type?(this.image=this.objectIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):ArgMorph.uber.drawNew.call(this)},ArgMorph.prototype.listIcon=function(){var t,e,o,r,i=new Morph,n=new CellMorph,s=new CellMorph;return i.color=new Color(255,255,255),s.setPosition(n.bottomLeft().add(new Point(0,this.fontSize/3))),n.add(s),n.setPosition(i.position().add(this.fontSize)),i.add(n),i.bounds.corner=s.bounds.corner.add(this.fontSize),i.drawNew(),t=i.fullImage(),r=(this.fontSize+this.edge)/t.height,e=newCanvas(new Point(Math.ceil(t.width*r)+1,Math.ceil(t.height*r)+1)),o=e.getContext("2d"),o.fillStyle="black",o.fillRect(0,0,e.width,e.height),o.scale(r,r),o.drawImage(t,1/r,1/r),e},ArgMorph.prototype.objectIcon=function(){return this.labelPart("%turtle").image},ArgMorph.prototype.isEmptySlot=function(){return null!==this.type},CommandSlotMorph.prototype=new ArgMorph,CommandSlotMorph.prototype.constructor=CommandSlotMorph,CommandSlotMorph.uber=ArgMorph.prototype,CommandSlotMorph.prototype.init=function(t){CommandSlotMorph.uber.init.call(this,null,!0),this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),t)},CommandSlotMorph.prototype.getSpec=function(){return"%cmd"},CommandSlotMorph.prototype.topBlock=function(){return this.parent.topBlock?this.parent.topBlock():this.nestedBlock()},CommandSlotMorph.prototype.nestedBlock=function(t){if(!t)return detect(this.children,function(t){return t instanceof CommandBlockMorph});var e=this.nestedBlock();this.add(t),e&&t.bottomBlock().nextBlock(e),this.fixLayout()},CommandSlotMorph.prototype.slotAttachPoint=function(){return new Point(this.dentCenter(),this.top()+2*this.corner)},CommandSlotMorph.prototype.dentLeft=function(){return this.left()+this.corner+2*this.inset},CommandSlotMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},CommandSlotMorph.prototype.attachTargets=function(){var t=[];return t.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"}),t},CommandSlotMorph.prototype.fixLayout=function(){var t=this.nestedBlock();this.parent&&(this.color.eq(this.parent.color)||this.setColor(this.parent.color)),t?(t.setPosition(new Point(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder)),this.setWidth(t.fullBounds().width()+2*(this.edge+this.rfBorder)),this.setHeight(t.fullBounds().height()+this.edge+2*this.rfBorder-(this.corner-this.edge))):(this.setHeight(4*this.corner),this.setWidth(4*this.corner+this.inset+this.dent)),this.parent.fixLayout&&this.parent.fixLayout()},CommandSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},CommandSlotMorph.prototype.isEmptySlot=function(){return!this.isStatic&&null===this.nestedBlock()},CommandSlotMorph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose new parent:"),o=this;t.forEach(function(t){e.addItem(t.toString().slice(0,50),function(){t.add(o),o.isDraggable=!1,t.fixLayout&&t.fixLayout()})}),t.length>0&&e.popUpAtHand(this.world())},CommandSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,t.fillRect(0,0,this.width(),this.height()),t.fillStyle=this.rfColor.toString(),this.drawFlat(t),MorphicPreferences.isFlat||this.drawEdges(t)},CommandSlotMorph.prototype.drawFlat=function(t){var e=null!==this.nestedBlock(),o=e?this.inset:this.inset/2,r=e?this.dent:this.dent/2,i=2*this.corner+o,n=this.edge,s=e?this.rfBorder:0,a=this.height()-this.corner-n;t.beginPath(),t.arc(this.corner+n,this.corner+n,this.corner,radians(-180),radians(-90),!1),t.lineTo(this.corner+o+n+2*s,n),t.lineTo(i+n+2*s,this.corner+n),t.lineTo(i+n+2*s+(r-2*s),this.corner+n),t.lineTo(i+n+2*s+(r-2*s)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(this.width()-this.corner-n,this.corner+n,this.corner,radians(-90),radians(-0),!1),t.arc(this.width()-this.corner-n,a,this.corner,radians(0),radians(90),!1),t.arc(this.corner+n,a,this.corner,radians(90),radians(180),!1),t.closePath(),t.fill()},CommandSlotMorph.prototype.drawEdges=function(t){var e,o,r,i,n=null!==this.nestedBlock(),s=n?this.inset:this.inset/2,a=n?this.dent:this.dent/2,h=2*this.corner+s,l=this.edge,p=n?this.rfBorder:0,c=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",e=t.createLinearGradient(0,this.height(),0,this.height()-this.edge),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner+l,this.height()-c),t.lineTo(this.width()-this.corner-l,this.height()-c),t.stroke(),e=t.createRadialGradient(this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner,this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner+l),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.width()-(this.corner+l),this.height()-(this.corner+l),this.corner+c,radians(0),radians(90),!1),t.stroke(),e=t.createLinearGradient(this.width(),0,this.width()-this.edge,0),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-c,this.height()-this.corner-this.edge),t.lineTo(this.width()-c,l+this.corner),t.stroke(),t.shadowOffsetY=c,t.shadowBlur=this.edge,t.shadowColor=this.rfColor.darker(80).toString(),e=t.createLinearGradient(0,0,l,0),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(c,l+this.corner),t.lineTo(c,this.height()-l-this.corner),t.stroke(),e=t.createRadialGradient(this.corner+l,this.corner+l,this.corner,this.corner+l,this.corner+l,this.corner+l),e.addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.corner+l,this.corner+l,this.corner+c,radians(-180),radians(-90),!1),t.stroke(),o=t.createLinearGradient(0,0,0,this.edge),o.addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(this.corner+l,c),t.lineTo(this.corner+s+l+2*p-c,c),t.stroke(),r=t.createLinearGradient(0,this.corner,0,this.corner+l),r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(h+l+2*p+c,this.corner+c),t.lineTo(h+l+2*p+(a-2*p),this.corner+c),t.stroke(),i=t.createLinearGradient(h+l+2*p+(a-2*p)-c,this.corner,h+l+2*p+(a-2*p)+.7*c,this.corner+c+.7*c),i.addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(h+l+2*p+(a-2*p),this.corner+c),t.lineTo(h+l+2*p+(a-2*p)+this.corner,c),t.stroke(),t.strokeStyle=o,t.beginPath(),t.moveTo(h+l+2*p+(a-2*p)+this.corner,c),t.lineTo(this.width()-this.corner-l,c),t.stroke()},RingCommandSlotMorph.prototype=new CommandSlotMorph,RingCommandSlotMorph.prototype.constructor=RingCommandSlotMorph,RingCommandSlotMorph.uber=CommandSlotMorph.prototype,RingCommandSlotMorph.prototype.rfBorder=0,RingCommandSlotMorph.prototype.edge=RingMorph.prototype.edge,RingCommandSlotMorph.prototype.init=function(t){RingCommandSlotMorph.uber.init.call(this,t),this.isHole=!0,this.noticesTransparentClick=!0,this.color=new Color(0,17,173),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast},RingCommandSlotMorph.prototype.getSpec=function(){return"%rc"},RingCommandSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.drawFlat(t),MorphicPreferences.isFlat||this.drawEdges(t)},RingCommandSlotMorph.prototype.drawFlat=function(t){var e=null!==this.nestedBlock(),o=e?this.inset:this.inset/2,r=e?this.dent:this.dent/2,i=2*this.corner+o,n=this.edge,s=this.width(),a=this.height(),h=e?this.rfBorder:0,l=a-this.corner-n;t.beginPath(),t.moveTo(0,a/2),t.lineTo(n,a/2),t.arc(this.corner+n,this.corner+n,this.corner,radians(-180),radians(-90),!1),t.lineTo(this.corner+o+n+2*h,n),t.lineTo(i+n+2*h,this.corner+n),t.lineTo(i+n+2*h+(r-2*h),this.corner+n),t.lineTo(i+n+2*h+(r-2*h)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(s-this.corner-n,this.corner+n,this.corner,radians(-90),radians(-0),!1),t.lineTo(s-this.edge,a/2),t.lineTo(s,a/2),t.lineTo(s,0),t.lineTo(0,0),t.closePath(),t.fill(),t.beginPath(),t.moveTo(s,a/2),t.lineTo(s-n,a/2),t.arc(this.width()-this.corner-n,l,this.corner,radians(0),radians(90),!1),t.arc(this.corner+n,l,this.corner,radians(90),radians(180),!1),t.lineTo(n,a/2),t.lineTo(0,a/2),t.lineTo(0,a),t.lineTo(s,a),t.closePath(),t.fill()},CSlotMorph.prototype=new CommandSlotMorph,CSlotMorph.prototype.constructor=CSlotMorph,CSlotMorph.uber=CommandSlotMorph.prototype,CSlotMorph.prototype.init=function(t){CommandSlotMorph.uber.init.call(this,null,!0),this.isHole=!0,this.isLambda=!1,this.color=new Color(0,17,173),this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),t)},CSlotMorph.prototype.getSpec=function(){return"%c"},CSlotMorph.prototype.mappedCode=function(t){var e=StageMorph.prototype.codeMappings.reify||"<#1>",o=e.split("\n"),r=this.nestedBlock(),i=r?r.mappedCode(t):"",n=i.toString().split("\n"),s=new RegExp("<#1>","g");return o.forEach(function(t,e){var r,i="";0===t.trimLeft().indexOf("<#1>")&&(r=t.indexOf("<#1>"),i=t.slice(0,r)),o[e]=t.replace(new RegExp("<#1>"),n.join("\n"+i)),o[e]=o[e].replace(s,n.join("\n"))}),o.join("\n")},CSlotMorph.prototype.fixLayout=function(){var t=this.nestedBlock();t?(t.setPosition(new Point(this.left()+this.inset,this.top()+this.corner)),this.setHeight(t.fullBounds().height()+this.corner),this.setWidth(t.fullBounds().width()+2*this.cSlotPadding)):(this.setHeight(4*this.corner+this.cSlotPadding),this.setWidth(4*this.corner+2*this.inset+this.dent+2*this.cSlotPadding)),this.parent.fixLayout&&this.parent.fixLayout()},CSlotMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.drawFlat(t),MorphicPreferences.isFlat||(this.drawTopRightEdge(t),this.drawTopEdge(t,this.inset,this.corner),this.drawTopLeftEdge(t),this.drawBottomEdge(t),this.drawRightEdge(t))},CSlotMorph.prototype.drawFlat=function(t){t.beginPath(),t.moveTo(0,0),t.lineTo(this.width(),0),t.arc(this.width()-this.corner,0,this.corner,radians(90),radians(0),!0),t.lineTo(this.width()-this.corner,this.corner),t.lineTo(2*this.inset+3*this.corner+this.dent,this.corner),t.lineTo(2*this.inset+2*this.corner+this.dent,2*this.corner),t.lineTo(2*this.inset+2*this.corner,2*this.corner),t.lineTo(2*this.inset+this.corner,this.corner),t.lineTo(this.inset+this.corner,this.corner),t.arc(this.inset+this.corner,2*this.corner,this.corner,radians(270),radians(180),!0),t.lineTo(this.inset,this.height()-2*this.corner),t.arc(this.inset+this.corner,this.height()-2*this.corner,this.corner,radians(180),radians(90),!0),t.lineTo(this.width()-this.corner,this.height()-this.corner),t.arc(this.width()-this.corner,this.height(),this.corner,radians(-90),radians(-0),!1),t.lineTo(0,this.height()),t.closePath(),t.fill()},CSlotMorph.prototype.drawTopRightEdge=function(t){var e,o=.5*this.edge,r=this.width()-this.corner,i=0;e=t.createRadialGradient(r,i,this.corner,r,i,this.corner-this.edge),e.addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(r,i,this.corner-o,radians(90),radians(0),!0),t.stroke()},CSlotMorph.prototype.drawTopEdge=function(t,e,o){var r,i,n,s=.5*this.edge,a=e+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",r=t.createLinearGradient(0,o-this.edge,0,o),r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(e+this.corner,o-s),t.lineTo(e+this.corner+this.inset-s,o-s),t.stroke(),i=t.createLinearGradient(0,o+this.corner-this.edge,0,o+this.corner),i.addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(a+s,o+this.corner-s),t.lineTo(a+this.dent,o+this.corner-s),t.stroke(),n=t.createLinearGradient(e+this.inset+2*this.corner+this.dent-s,o+this.corner-s-s,e+this.inset+2*this.corner+this.dent+.7*s,o+this.corner-s+.7*s),n.addColorStop(0,this.cachedClr),n.addColorStop(1,this.cachedClrDark),t.strokeStyle=n,t.beginPath(),t.moveTo(e+this.inset+2*this.corner+this.dent,o+this.corner-s),t.lineTo(e+3*this.corner+this.inset+this.dent,o-s),t.stroke(),t.strokeStyle=r,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent,o-s),t.lineTo(this.width()-this.corner,o-s),t.stroke()},CSlotMorph.prototype.drawTopLeftEdge=function(t){var e,o=.5*this.edge;e=t.createRadialGradient(this.corner+this.inset,2*this.corner,this.corner,this.corner+this.inset,2*this.corner,this.corner+this.edge),e.addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(this.corner+this.inset,2*this.corner,this.corner+o,radians(-180),radians(-90),!1),t.stroke()},CSlotMorph.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,r=this.inset;e=t.createLinearGradient(r-this.edge,0,r,0),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(r-o,2*this.corner),t.lineTo(r-o,this.height()-2*this.corner),t.stroke()},CSlotMorph.prototype.drawBottomEdge=function(t){var e,o,r=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",o=t.createRadialGradient(this.corner+this.inset,this.height()-2*this.corner,this.corner,this.corner+this.inset,this.height()-2*this.corner,this.corner+this.edge),o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.arc(this.corner+this.inset,this.height()-2*this.corner,this.corner+r,radians(180),radians(90),!0),t.stroke(),e=t.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.inset+this.corner,this.height()-this.corner+r),t.lineTo(this.width()-this.corner,this.height()-this.corner+r),t.stroke()},InputSlotMorph.prototype=new ArgMorph,InputSlotMorph.prototype.constructor=InputSlotMorph,InputSlotMorph.uber=ArgMorph.prototype,InputSlotMorph.prototype.init=function(t,e,o,r){var i=new StringMorph(""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));i.fontSize=this.fontSize,i.isShowingBlanks=!0,i.drawNew(),this.isUnevaluated=!1,this.choices=o||null,this.oldContentsExtent=i.extent(),this.isNumeric=e||!1,this.isReadOnly=r||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this,null,!0),this.color=new Color(255,255,255),this.add(i),this.add(n),i.isEditable=!0,i.isDraggable=!1,i.enableSelecting(),this.setContents(t)},InputSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%n":"%s"},InputSlotMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof StringMorph})},InputSlotMorph.prototype.arrow=function(){return detect(this.children,function(t){return t instanceof ArrowMorph})},InputSlotMorph.prototype.setContents=function(t){var e=this.contents(),o=t,r=o instanceof Array;if(r)o=localize(o[0]),e.isItalic=!this.isReadOnly;else if(e.isItalic=!1,null!==this.choices&&this.choices[o]instanceof Array)return this.setContents(this.choices[o]);e.text=o,isNil(o)?e.text="":o.toString&&(e.text=o.toString()),e.drawNew(),this.isReadOnly&&this.parent instanceof BlockMorph&&this.parent.fixLabelColor(),this.constant=r?t:null},InputSlotMorph.prototype.dropDownMenu=function(t){var e,o=this.choices,r=new MenuMorph(this.setContents,null,this,this.fontSize);if(o instanceof Function?o=o.call(this):isString(o)&&(o=this[o]()),!o)return null;r.addItem(" ",null);for(e in o)Object.prototype.hasOwnProperty.call(o,e)&&("~"===e[0]?r.addLine():r.addItem(e,o[e]));return r.items.length>0?void(t?(r.popup(this.world(),this.bottomLeft()),r.getFocus()):r.popUpAtHand(this.world())):null},InputSlotMorph.prototype.messagesMenu=function(){var t={},e=this.parentThatIsA(BlockMorph).receiver(),o=e.parentThatIsA(StageMorph),r=this,i=[];return o.children.concat(o).forEach(function(t){isSnapObject(t)&&(i=i.concat(t.allMessageNames()))}),i.forEach(function(e){t[e]=e}),i.length>0&&(t["~"]=null),t["new..."]=function(){new DialogBoxMorph(r,r.setContents,r).prompt("Message name",null,r.world())},t},InputSlotMorph.prototype.messagesReceivedMenu=function(){var t={"any message":["any message"]},e=this.parentThatIsA(BlockMorph).receiver(),o=e.parentThatIsA(StageMorph),r=this,i=[];return o.children.concat(o).forEach(function(t){isSnapObject(t)&&(i=i.concat(t.allMessageNames()))}),i.forEach(function(e){t[e]=e}),t["~"]=null,t["new..."]=function(){new DialogBoxMorph(r,r.setContents,r).prompt("Message name",null,r.world())},t},InputSlotMorph.prototype.collidablesMenu=function(){var t={"mouse-pointer":["mouse-pointer"],edge:["edge"],"pen trails":["pen trails"]},e=this.parentThatIsA(BlockMorph).receiver(),o=e.parentThatIsA(StageMorph),r=[];return o.children.forEach(function(t){t instanceof SpriteMorph&&!t.isClone&&t.name!==e.name&&(r=r.concat(t.name))}),r.length>0&&(t["~"]=null,r.forEach(function(e){t[e]=e})),t},InputSlotMorph.prototype.distancesMenu=function(){var t={"mouse-pointer":["mouse-pointer"]},e=this.parentThatIsA(BlockMorph).receiver(),o=e.parentThatIsA(StageMorph),r=[];return o.children.forEach(function(t){t instanceof SpriteMorph&&t.name!==e.name&&(r=r.concat(t.name))}),r.length>0&&(t["~"]=null,r.forEach(function(e){t[e]=e})),t},InputSlotMorph.prototype.clonablesMenu=function(){var t={},e=this.parentThatIsA(BlockMorph).receiver(),o=e.parentThatIsA(StageMorph),r=[];return e instanceof SpriteMorph&&(t.myself=["myself"]),o.children.forEach(function(t){t instanceof SpriteMorph&&!t.isClone&&(r=r.concat(t.name))}),r.length>0&&(t["~"]=null,r.forEach(function(e){t[e]=e})),t},InputSlotMorph.prototype.objectsMenu=function(){var t=this.parentThatIsA(BlockMorph).receiver(),e=t.parentThatIsA(StageMorph),o={},r=[];return o[e.name]=e.name,e.children.forEach(function(t){t instanceof SpriteMorph&&r.push(t.name)}),r.length>0&&(o["~"]=null,r.forEach(function(t){o[t]=t})),o},InputSlotMorph.prototype.typesMenu=function(){var t={number:["number"],text:["text"],Boolean:["Boolean"],list:["list"]};return SpriteMorph.prototype.enableFirstClass&&(t.sprite=["sprite"]),t.command=["command"],t.reporter=["reporter"],t.predicate=["predicate"],t},InputSlotMorph.prototype.gettablesMenu=function(){var t={neighbors:["neighbors"],self:["self"],"other sprites":["other sprites"],clones:["clones"],"other clones":["other clones"]};return SpriteMorph.prototype.enableNesting&&(t.parts=["parts"],t.anchor=["anchor"]),t.stage=["stage"],StageMorph.prototype.enableInheritance&&(t.children=["children"],t.parent=["parent"]),t.name=["name"],t["dangling?"]=["dangling?"],t["rotation x"]=["rotation x"],t["rotation y"]=["rotation y"],t["center x"]=["center x"],t["center y"]=["center y"],t},InputSlotMorph.prototype.attributesMenu=function(){var t,e=this.parentThatIsA(BlockMorph),o=e.inputs()[1].evaluate(),r=e.receiver(),i=r.parentThatIsA(StageMorph),n={},s=[];return(t=o===i.name?i:detect(i.children,function(t){return t.name===o}))?(n=t instanceof SpriteMorph?{"x position":["x position"],"y position":["y position"],direction:["direction"],"costume #":["costume #"],"costume name":["costume name"],size:["size"]}:{"costume #":["costume #"],"costume name":["costume name"]},s=t.variables.names(),s.length>0&&(n["~"]=null,s.forEach(function(t){n[t]=t})),n):n},InputSlotMorph.prototype.costumesMenu=function(){var t,e=this.parentThatIsA(BlockMorph).receiver(),o=[];return t=e instanceof SpriteMorph?{Turtle:["Turtle"]}:{Empty:["Empty"]},e.costumes.asArray().forEach(function(t){o=o.concat(t.name)}),o.length>0&&(t["~"]=null,o.forEach(function(e){t[e]=e})),t},InputSlotMorph.prototype.soundsMenu=function(){var t=this.parentThatIsA(BlockMorph).receiver(),e=[],o={};return t.sounds.asArray().forEach(function(t){e=e.concat(t.name)}),e.length>0&&e.forEach(function(t){o[t]=t}),o},InputSlotMorph.prototype.setChoices=function(t,e){var o=this.contents();this.choices=t,this.isReadOnly=e||!1,this.parent instanceof BlockMorph&&(this.parent.fixLabelColor(),e||(o.shadowOffset=new Point,o.shadowColor=null,o.setColor(new Color(0,0,0)))),this.fixLayout()},InputSlotMorph.prototype.shadowedVariablesMenu=function(){var t,e=this.parentThatIsA(BlockMorph),o={};return e?(t=e.receiver(),t&&t.inheritedVariableNames(!0).forEach(function(t){o[t]=t}),o):o},InputSlotMorph.prototype.fixLayout=function(){var t,e,o,r=this.contents(),i=this.arrow();r.isNumeric=this.isNumeric,r.isEditable=!this.isReadOnly,this.isReadOnly?(r.disableSelecting(),r.color=new Color(254,254,254)):(r.enableSelecting(),r.color=new Color(0,0,0)),this.choices?(i.setSize(this.fontSize),i.show()):i.hide(),o=i.isVisible?i.width():0,e=r.height()+2*this.edge,t=this.isNumeric?r.width()+Math.floor(.5*o)+e+2*this.typeInPadding:Math.max(r.width()+o+2*this.edge+2*this.typeInPadding,r.rawHeight?r.rawHeight()+o:fontHeight(r.fontSize)/1.3+o,this.minWidth),this.setExtent(new Point(t,e)),this.isNumeric?r.setPosition(new Point(Math.floor(e/2),this.edge).add(new Point(this.typeInPadding,0)).add(this.position())):r.setPosition(new Point(this.edge,this.edge).add(new Point(this.typeInPadding,0)).add(this.position())),i.isVisible&&i.setPosition(new Point(this.right()-o-this.edge,r.top())),this.parent&&this.parent.fixLayout&&(this.world()?(this.startLayout(),this.parent.fixLayout(),this.endLayout()):this.parent.fixLayout())},InputSlotMorph.prototype.mouseDownLeft=function(t){this.isReadOnly||this.arrow().bounds.containsPoint(t)?this.escalateEvent("mouseDownLeft",t):(this.contents().edit(),this.contents().selectAll())},InputSlotMorph.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():(this.contents().edit(),this.contents().selectAll())},InputSlotMorph.prototype.reactToKeystroke=function(){var t;this.constant&&(t=this.contents(),this.constant=null,t.isItalic=!1,t.drawNew())},InputSlotMorph.prototype.reactToEdit=function(){this.contents().clearSelection()},InputSlotMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return!StageMorph.prototype.enableCodeMapping||this.isNumeric?this.parent.userMenu():(t.addItem("code string mapping...","mapToCode"),t)},InputSlotMorph.prototype.mapToCode=function(){new DialogBoxMorph(this,function(t){StageMorph.prototype.codeMappings.string=t},this).promptCode("Code mapping - String <#1>",StageMorph.prototype.codeMappings.string||"",this.world())},InputSlotMorph.prototype.mappedCode=function(){var t=StageMorph.prototype.codeMappings.string||"<#1>",e=this.parentThatIsA(BlockMorph),o=this.evaluate();return this.isNumeric?o:isNaN(parseFloat(o))&&isString(o)?e&&contains(["doSetVar","doChangeVar","doShowVar","doHideVar"],e.selector)?o:t.replace(/<#1>/g,o):o},InputSlotMorph.prototype.evaluate=function(){var t,e=this.contents();return this.constant?this.constant:this.isNumeric&&(t=parseFloat(e.text||"0"),!isNaN(t))?t:e.text},InputSlotMorph.prototype.isEmptySlot=function(){return""===this.contents().text},InputSlotMorph.prototype.drawNew=function(){var t,e,o;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?this.parent.color:new Color(120,120,120),t.fillStyle=this.color.toString(),this.isReadOnly&&(t.fillStyle=e.darker().toString()),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.isNumeric?(o=(this.height()-2*this.edge)/2,t.beginPath(),t.arc(o+this.edge,o+this.edge,o,radians(90),radians(-90),!1),t.arc(this.width()-o-this.edge,o+this.edge,o,radians(-90),radians(90),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||this.drawRoundBorder(t)):(t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(t))},InputSlotMorph.prototype.drawRectBorder=function(t){var e,o=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetY=o,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),e=t.createLinearGradient(0,0,0,this.edge),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,o),t.lineTo(this.width()-this.edge-o,o),t.stroke(),t.shadowOffsetY=0,e=t.createLinearGradient(0,0,this.edge,0),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(o,this.edge),t.lineTo(o,this.height()-this.edge-o),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,e=t.createLinearGradient(0,this.height()-this.edge,0,this.height()),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,this.height()-o),t.lineTo(this.width()-this.edge,this.height()-o),t.stroke(),e=t.createLinearGradient(this.width()-this.edge,0,this.width(),0),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-o,this.edge),t.lineTo(this.width()-o,this.height()-this.edge),t.stroke()},InputSlotMorph.prototype.drawRoundBorder=function(t){var e,o,r,i=.5*this.edge,n=(this.height()-2*this.edge)/2;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",e=n+this.edge,o=this.width()-n-this.edge,o>e&&(t.shadowOffsetX=i,t.shadowOffsetY=i,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),r=t.createLinearGradient(0,0,0,this.edge),r.addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(e,i),t.lineTo(o,i),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0),r=t.createLinearGradient(0,this.height()-this.edge,0,this.height()),r.addColorStop(0,this.cachedClrBright),r.addColorStop(1,this.cachedClr),t.strokeStyle=r,t.beginPath(),t.moveTo(n+this.edge,this.height()-i),t.lineTo(this.width()-n-this.edge,this.height()-i),t.stroke(),n=this.height()/2,t.shadowOffsetX=i,t.shadowOffsetY=i,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),r=t.createRadialGradient(n,n,n-this.edge,n,n,n),r.addColorStop(1,this.cachedClr),r.addColorStop(0,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.arc(n,n,n-i,radians(180),radians(270),!1),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,r=t.createRadialGradient(this.width()-n,n,n-this.edge,this.width()-n,n,n),r.addColorStop(1,this.cachedClr),r.addColorStop(0,this.cachedClrBright),t.strokeStyle=r,t.beginPath(),t.arc(this.width()-n,n,n-i,radians(0),radians(90),!1),t.stroke()},TemplateSlotMorph.prototype=new ArgMorph,TemplateSlotMorph.prototype.constructor=TemplateSlotMorph,TemplateSlotMorph.uber=ArgMorph.prototype,TemplateSlotMorph.prototype.init=function(t){var e=new ReporterBlockMorph;this.labelString=t||"",e.isDraggable=!1,e.isTemplate=!0,void 0!==modules.objects?(e.color=SpriteMorph.prototype.blockColor.variables,e.category="variables"):(e.color=new Color(243,118,29),e.category=null),e.setSpec(this.labelString),e.selector="reportGetVar",TemplateSlotMorph.uber.init.call(this),this.add(e),this.fixLayout(),this.isDraggable=!1,this.isStatic=!0},TemplateSlotMorph.prototype.getSpec=function(){return"%t"},TemplateSlotMorph.prototype.template=function(){return this.children[0]},TemplateSlotMorph.prototype.contents=function(){return this.template().blockSpec},TemplateSlotMorph.prototype.setContents=function(t){var e=this.template();e.setSpec(t),e.fixBlockColor(),e.fixLabelColor()},TemplateSlotMorph.prototype.evaluate=function(){return this.contents()},TemplateSlotMorph.prototype.fixLayout=function(){var t=this.template();this.setExtent(t.extent().add(2*this.edge+2)),t.setPosition(this.position().add(this.edge+1)),
this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},TemplateSlotMorph.prototype.drawNew=function(){var t;this.parent instanceof Morph&&(this.color=this.parent.color.copy()),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.drawRounded(t)},TemplateSlotMorph.prototype.drawRounded=ReporterBlockMorph.prototype.drawRounded,BooleanSlotMorph.prototype=new ArgMorph,BooleanSlotMorph.prototype.constructor=BooleanSlotMorph,BooleanSlotMorph.uber=ArgMorph.prototype,BooleanSlotMorph.prototype.init=function(t){this.value="boolean"==typeof t?t:null,this.isUnevaluated=!1,BooleanSlotMorph.uber.init.call(this)},BooleanSlotMorph.prototype.getSpec=function(){return this.isUnevaluated?"%boolUE":"%b"},BooleanSlotMorph.prototype.evaluate=function(){return this.value},BooleanSlotMorph.prototype.isEmptySlot=function(){return null===this.value},BooleanSlotMorph.prototype.setContents=function(t,e){this.value="boolean"==typeof t?t:null,e||(this.drawNew(),this.changed())},BooleanSlotMorph.prototype.toggleValue=function(){var t=this.parentThatIsA(IDE_Morph);if(this.isStatic)this.setContents(!this.value,!0);else switch(this.value){case!0:this.value=!1;break;case!1:this.value=null;break;default:this.value=!0}return t&&!t.isAnimating?(this.drawNew(),void this.changed()):(this.drawNew(3),this.changed(),void this.nextSteps([function(){this.drawNew(2),this.changed()},function(){this.drawNew(1),this.changed()},function(){this.drawNew(),this.changed()}]))},BooleanSlotMorph.prototype.mouseClickLeft=function(){this.toggleValue(),isNil(this.value)||this.reactToSliderEdit()},BooleanSlotMorph.prototype.mouseEnter=function(){if(!this.isStatic){if(this.value===!1){var t=this.value;return this.value=null,this.drawNew(3),this.changed(),void(this.value=t)}this.drawNew(1),this.changed()}},BooleanSlotMorph.prototype.mouseLeave=function(){this.isStatic||(this.drawNew(),this.changed())},BooleanSlotMorph.prototype.drawNew=function(t){var e,o,r=this.isStatic?this.textLabel():null;r?(o=r.height+3*this.edge,this.silentSetExtent(new Point(r.width+1.5*o+2*this.edge,o))):this.silentSetExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge)),this.color=this.parent?this.parent.color:new Color(200,200,200),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),e=this.image.getContext("2d"),this.drawDiamond(e,t),this.drawLabel(e,r),this.drawKnob(e,t)},BooleanSlotMorph.prototype.drawDiamond=function(t,e){var o,r=this.width(),i=this.height(),n=i/2,s=r/2,a=this.edge/2;switch(this.value){case!0:t.fillStyle="rgb(0, 200, 0)";break;case!1:t.fillStyle="rgb(200, 0, 0)";break;default:t.fillStyle=this.color.darker(25).toString()}e&&!this.isEmptySlot()?(t.fillStyle="rgb(0, 200, 0)",t.beginPath(),t.moveTo(0,n),t.lineTo(n,0),t.lineTo(s,0),t.lineTo(s,i),t.lineTo(n,i),t.closePath(),t.fill(),t.fillStyle="rgb(200, 0, 0)",t.beginPath(),t.moveTo(s,0),t.lineTo(r-n,0),t.lineTo(r,n),t.lineTo(r-n,i),t.lineTo(s,i),t.closePath(),t.fill()):(t.beginPath(),t.moveTo(0,n),t.lineTo(n,0),t.lineTo(r-n,0),t.lineTo(r,n),t.lineTo(r-n,i),t.lineTo(n,i),t.closePath(),t.fill()),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.shadowOffsetX=a,t.shadowBlur=a,t.shadowColor="black",o=t.createLinearGradient(0,n,.6*this.edge,n+.6*this.edge),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(a,n),t.lineTo(n,a),t.closePath(),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=a,t.shadowBlur=this.edge,o=t.createLinearGradient(0,0,0,this.edge),o.addColorStop(1,this.cachedClrDark),o.addColorStop(0,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(n,a),t.lineTo(r-n,a),t.closePath(),t.stroke(),t.shadowOffsetY=0,t.shadowBlur=0,o=t.createLinearGradient(r-n-.6*this.edge,i-.6*this.edge,r-n,i),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(r-n,i-a),t.lineTo(r-a,n),t.closePath(),t.stroke(),o=t.createLinearGradient(0,i-this.edge,0,i),o.addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(n,i-a),t.lineTo(r-n-a,i-a),t.closePath(),t.stroke())},BooleanSlotMorph.prototype.drawLabel=function(t,e){var o,r=this.width(),i=this.height()/2-this.edge,n=i/2,s=this.edge/2,a=this.height()/2;if(!this.isEmptySlot()){if(e)return a=(this.height()-e.height)/2,o=this.value?this.height()/2:this.width()-this.height()/2-e.width,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor=this.value?"rgb(0, 100, 0)":"rgb(100, 0, 0)"),void t.drawImage(e,o,a);o=i+2*this.edge+s,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor="rgb(0, 100, 0)"),t.strokeStyle="white",t.lineWidth=this.edge+s,t.lineCap="round",t.lineJoin="miter",t.beginPath(),t.moveTo(o-n,a),t.lineTo(o,a+n),t.lineTo(o+n,n+this.edge),t.stroke(),o=r-a-2*this.edge,MorphicPreferences.isFlat||(t.shadowOffsetX=-s,t.shadowOffsetY=-s,t.shadowBlur=s,t.shadowColor="rgb(100, 0, 0)"),t.strokeStyle="white",t.lineWidth=this.edge,t.lineCap="butt",t.beginPath(),t.moveTo(o-n,a-n),t.lineTo(o+n,a+n),t.moveTo(o-n,a+n),t.lineTo(o+n,a-n),t.stroke()}},BooleanSlotMorph.prototype.drawKnob=function(t,e){var o,r,i=this.width(),n=this.height()/2,s=this.edge/2,a=(this.width()-this.height())/4*(e||0),h=n,l=PushButtonMorph.prototype.outline/2,p=PushButtonMorph.prototype.outlineColor,c=PushButtonMorph.prototype.color,d=PushButtonMorph.prototype.contrast,u=c.lighter(d),g=c.darker(d);switch(this.value){case!1:r=n+a,MorphicPreferences.isFlat||(t.shadowOffsetX=s,t.shadowOffsetY=0,t.shadowBlur=s,t.shadowColor="black");break;case!0:r=i-n-a,MorphicPreferences.isFlat||(t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0);break;default:if(!e)return;r=n,MorphicPreferences.isFlat||(t.shadowOffsetX=s,t.shadowOffsetY=0,t.shadowBlur=s,t.shadowColor="black"),t.globalAlpha=.2*((e||0)+1)}t.fillStyle=c.toString(),t.beginPath(),t.arc(r,h,n,radians(0),radians(360)),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.shadowOffsetX=0,t.shadowBlur=0,t.shadowColor="black",t.lineWidth=l,t.strokeStyle=p.toString(),t.beginPath(),t.arc(r,h,n-l/2,radians(0),radians(360)),t.stroke(),o=t.createRadialGradient(r,h,n-l-this.edge,r,h,n-l),o.addColorStop(1,u.toString()),o.addColorStop(0,c.toString()),t.strokeStyle=o,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(r,h,n-l-this.edge/2,radians(180),radians(270),!1),t.stroke(),o=t.createRadialGradient(r,h,n-l-this.edge,r,h,n-l),o.addColorStop(1,g.toString()),o.addColorStop(0,c.toString()),t.strokeStyle=o,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(r,h,n-l-this.edge/2,radians(0),radians(90),!1),t.stroke())},BooleanSlotMorph.prototype.textLabel=function(){if(this.isEmptySlot())return null;var t,e,o,r,i,n;return t=new StringMorph(localize("true"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255)).image,e=new StringMorph(localize("false"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255)).image,o=newCanvas(new Point(Math.max(t.width,e.width),Math.max(t.height,e.height))),r=this.value?t:e,i=(o.width-r.width)/2,n=(o.height-r.height)/2,o.getContext("2d").drawImage(r,i,n),o},ArrowMorph.prototype=new Morph,ArrowMorph.prototype.constructor=ArrowMorph,ArrowMorph.uber=Morph.prototype,ArrowMorph.prototype.init=function(t,e,o,r){this.direction=t||"down",this.size=e||(0===e?0:50),this.padding=o||0,ArrowMorph.uber.init.call(this,!0),this.color=r||new Color(0,0,0),this.setExtent(new Point(this.size,this.size))},ArrowMorph.prototype.setSize=function(t){var e=Math.max(t,1);this.size=t,this.setExtent(new Point(e,e))},ArrowMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var t=this.image.getContext("2d"),e=this.padding,o=this.height(),r=Math.floor(o/2),i=this.width(),n=Math.floor(i/2);t.fillStyle=this.color.toString(),t.beginPath(),"down"===this.direction?(t.moveTo(e,r),t.lineTo(i-e,r),t.lineTo(n,o-e)):"up"===this.direction?(t.moveTo(e,r),t.lineTo(i-e,r),t.lineTo(n,e)):"left"===this.direction?(t.moveTo(e,r),t.lineTo(n,e),t.lineTo(n,o-e)):(t.moveTo(n,e),t.lineTo(i-e,r),t.lineTo(n,o-e)),t.closePath(),t.fill()},TextSlotMorph.prototype=new InputSlotMorph,TextSlotMorph.prototype.constructor=TextSlotMorph,TextSlotMorph.uber=InputSlotMorph.prototype,TextSlotMorph.prototype.init=function(t,e,o,r){var i=new TextMorph(""),n=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));i.fontSize=this.fontSize,i.drawNew(),this.isUnevaluated=!1,this.choices=o||null,this.oldContentsExtent=i.extent(),this.isNumeric=e||!1,this.isReadOnly=r||!1,this.minWidth=0,this.constant=null,InputSlotMorph.uber.init.call(this,null,null,null,null,!0),this.color=new Color(255,255,255),this.add(i),this.add(n),i.isEditable=!0,i.isDraggable=!1,i.enableSelecting(),this.setContents(t)},TextSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%mln":"%mlt"},TextSlotMorph.prototype.contents=function(){return detect(this.children,function(t){return t instanceof TextMorph})},TextSlotMorph.prototype.layoutChanged=function(){this.fixLayout()},SymbolMorph.prototype=new Morph,SymbolMorph.prototype.constructor=SymbolMorph,SymbolMorph.uber=Morph.prototype,SymbolMorph.prototype.names=["square","pointRight","gears","file","fullScreen","normalScreen","smallStage","normalStage","turtle","stage","turtleOutline","pause","flag","octagon","cloud","cloudOutline","cloudGradient","turnRight","turnLeft","storage","poster","flash","brush","rectangle","rectangleSolid","circle","circleSolid","line","crosshairs","paintbucket","eraser","pipette","speechBubble","speechBubbleOutline","arrowUp","arrowUpOutline","arrowLeft","arrowLeftOutline","arrowDown","arrowDownOutline","arrowRight","arrowRightOutline","robot"],SymbolMorph.prototype.init=function(t,e,o,r,i){this.isProtectedLabel=!1,this.isReadOnly=!0,this.name=t||"square",this.size=e||(0===e?0:50),this.shadowOffset=r||new Point(0,0),this.shadowColor=i||null,SymbolMorph.uber.init.call(this,!0),this.color=o||new Color(0,0,0),this.drawNew()},SymbolMorph.prototype.setLabelColor=function(t,e,o){this.shadowOffset=o,this.shadowColor=e,this.setColor(t)},SymbolMorph.prototype.drawNew=function(){var t,e,o,r,i;this.image=newCanvas(new Point(this.symbolWidth()+Math.abs(this.shadowOffset.x),this.size+Math.abs(this.shadowOffset.y))),this.silentSetWidth(this.image.width),this.silentSetHeight(this.image.height),t=this.image.getContext("2d"),r=this.shadowOffset.x<0?0:this.shadowOffset.x,i=this.shadowOffset.y<0?0:this.shadowOffset.y,e=this.shadowOffset.x<0?Math.abs(this.shadowOffset.x):0,o=this.shadowOffset.y<0?Math.abs(this.shadowOffset.y):0,this.shadowColor&&t.drawImage(this.symbolCanvasColored(this.shadowColor),r,i),t.drawImage(this.symbolCanvasColored(this.color),e,o)},SymbolMorph.prototype.symbolCanvasColored=function(t){if(this.name instanceof Costume)return this.name.thumbnail(new Point(this.symbolWidth(),this.size));var e=newCanvas(new Point(this.symbolWidth(),this.size));switch(this.name){case"square":return this.drawSymbolStop(e,t);case"pointRight":return this.drawSymbolPointRight(e,t);case"gears":return this.drawSymbolGears(e,t);case"file":return this.drawSymbolFile(e,t);case"fullScreen":return this.drawSymbolFullScreen(e,t);case"normalScreen":return this.drawSymbolNormalScreen(e,t);case"smallStage":return this.drawSymbolSmallStage(e,t);case"normalStage":return this.drawSymbolNormalStage(e,t);case"turtle":return this.drawSymbolTurtle(e,t);case"stage":return this.drawSymbolStop(e,t);case"turtleOutline":return this.drawSymbolTurtleOutline(e,t);case"pause":return this.drawSymbolPause(e,t);case"flag":return this.drawSymbolFlag(e,t);case"octagon":return this.drawSymbolOctagon(e,t);case"cloud":return this.drawSymbolCloud(e,t);case"cloudOutline":return this.drawSymbolCloudOutline(e,t);case"cloudGradient":return this.drawSymbolCloudGradient(e,t);case"turnRight":return this.drawSymbolTurnRight(e,t);case"turnLeft":return this.drawSymbolTurnLeft(e,t);case"storage":return this.drawSymbolStorage(e,t);case"poster":return this.drawSymbolPoster(e,t);case"flash":return this.drawSymbolFlash(e,t);case"brush":return this.drawSymbolBrush(e,t);case"rectangle":return this.drawSymbolRectangle(e,t);case"rectangleSolid":return this.drawSymbolRectangleSolid(e,t);case"circle":return this.drawSymbolCircle(e,t);case"circleSolid":return this.drawSymbolCircleSolid(e,t);case"line":return this.drawSymbolLine(e,t);case"crosshairs":return this.drawSymbolCrosshairs(e,t);case"paintbucket":return this.drawSymbolPaintbucket(e,t);case"eraser":return this.drawSymbolEraser(e,t);case"pipette":return this.drawSymbolPipette(e,t);case"speechBubble":return this.drawSymbolSpeechBubble(e,t);case"speechBubbleOutline":return this.drawSymbolSpeechBubbleOutline(e,t);case"arrowUp":return this.drawSymbolArrowUp(e,t);case"arrowUpOutline":return this.drawSymbolArrowUpOutline(e,t);case"arrowLeft":return this.drawSymbolArrowLeft(e,t);case"arrowLeftOutline":return this.drawSymbolArrowLeftOutline(e,t);case"arrowDown":return this.drawSymbolArrowDown(e,t);case"arrowDownOutline":return this.drawSymbolArrowDownOutline(e,t);case"arrowRight":return this.drawSymbolArrowRight(e,t);case"arrowRightOutline":return this.drawSymbolArrowRightOutline(e,t);case"robot":return this.drawSymbolRobot(e,t);default:return e}},SymbolMorph.prototype.symbolWidth=function(){var t=this.size;if(this.name instanceof Costume)return t/this.name.height()*this.name.width();switch(this.name){case"pointRight":return Math.sqrt(t*t-Math.pow(t/2,2));case"flash":case"file":return.8*t;case"smallStage":case"normalStage":return 1.2*t;case"turtle":case"turtleOutline":case"stage":return 1.3*t;case"cloud":case"cloudGradient":case"cloudOutline":return 1.6*t;case"turnRight":case"turnLeft":return t/3*2;default:return t}},SymbolMorph.prototype.drawSymbolStop=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.fillRect(0,0,t.width,t.height),t},SymbolMorph.prototype.drawSymbolPointRight=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,Math.round(t.height/2)),o.lineTo(0,t.height),o.lineTo(0,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolGears=function(t,e){var o=t.getContext("2d"),r=t.width,i=r/2,n=r/6;return o.strokeStyle=e.toString(),o.lineWidth=t.width/7,o.beginPath(),o.arc(i,i,r,radians(0),radians(360),!0),o.arc(i,i,1.5*n,radians(0),radians(360),!1),o.closePath(),o.clip(),o.moveTo(0,i),o.lineTo(r,i),o.stroke(),o.moveTo(i,0),o.lineTo(i,r),o.stroke(),o.moveTo(n,n),o.lineTo(r-n,r-n),o.stroke(),o.moveTo(r-n,n),o.lineTo(n,r-n),o.stroke(),t},SymbolMorph.prototype.drawSymbolFile=function(t,e){var o=t.getContext("2d"),r=Math.min(t.width,t.height)/2;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(r,0),o.lineTo(r,r),o.lineTo(t.width,r),o.lineTo(t.width,t.height),o.lineTo(0,t.height),o.closePath(),o.fill(),o.fillStyle=e.darker(25).toString(),o.beginPath(),o.moveTo(r,0),o.lineTo(t.width,r),o.lineTo(r,r),o.lineTo(r,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolFullScreen=function(t,e){var o=t.getContext("2d"),r=t.height,i=t.width/2,n=t.width/20,s=t.width/2;return o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(i-n,i+n),o.lineTo(0,r),o.stroke(),o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(i+n,i-n),o.lineTo(r,0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,r),o.lineTo(0,r-s),o.lineTo(s,r),o.closePath(),o.fill(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r,0),o.lineTo(r-s,0),o.lineTo(r,s),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolNormalScreen=function(t,e){var o=t.getContext("2d"),r=t.height,i=t.width/2,n=t.width/20,s=t.width;return o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(i-3*n,i+3*n),o.lineTo(0,r),o.stroke(),o.strokeStyle=e.toString(),o.lineWidth=t.width/5,o.moveTo(i+3*n,i-3*n),o.lineTo(r,0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i+n,i-n),o.lineTo(s,i-n),o.lineTo(i+n,0),o.closePath(),o.fill(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i-n,i+n),o.lineTo(0,i+n),o.lineTo(i-n,s),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolSmallStage=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=r/2,s=i/2;return o.fillStyle=e.darker(40).toString(),o.fillRect(0,0,r,i),o.fillStyle=e.toString(),o.fillRect(n,0,n,s),t},SymbolMorph.prototype.drawSymbolNormalStage=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=r/2,s=i/2;return o.fillStyle=e.toString(),o.fillRect(0,0,r,i),o.fillStyle=e.darker(25).toString(),o.fillRect(n,0,n,s),t},SymbolMorph.prototype.drawSymbolTurtle=function(t,e){var o=t.getContext("2d");return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,t.height/2),o.lineTo(0,t.height),o.lineTo(t.height/2,t.height/2),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolTurtleOutline=function(t,e){var o=t.getContext("2d");return o.strokeStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(t.width,t.height/2),o.lineTo(0,t.height),o.lineTo(t.height/2,t.height/2),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolPause=function(t,e){var o=t.getContext("2d"),r=t.width/5;return o.fillStyle=e.toString(),o.fillRect(0,0,2*r,t.height),o.fillRect(3*r,0,2*r,t.height),t},SymbolMorph.prototype.drawSymbolFlag=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/12,1),n=t.height;return o.lineWidth=i,o.strokeStyle=e.toString(),o.beginPath(),o.moveTo(i/2,0),o.lineTo(i/2,t.height),o.stroke(),o.lineWidth=n/2,o.beginPath(),o.moveTo(0,n/4),o.bezierCurveTo(.8*r,n/4,.1*r,.5*n,r,.5*n),o.stroke(),t},SymbolMorph.prototype.drawSymbolOctagon=function(t,e){var o=t.getContext("2d"),r=t.width,i=(r-.383*r)/2;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i,0),o.lineTo(r-i,0),o.lineTo(r,i),o.lineTo(r,r-i),o.lineTo(r-i,r),o.lineTo(i,r),o.lineTo(0,r-i),o.lineTo(0,i),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCloud=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=2*i/5,s=i/4,a=3*i/10,h=i/5;return o.fillStyle=e.toString(),o.beginPath(),o.arc(s,i-s,s,radians(90),radians(259),!1),o.arc(r/20*5,i/9*4,h,radians(165),radians(300),!1),o.arc(r/20*11,n,n,radians(200),radians(357),!1),o.arc(r-a,i-a,a,radians(269),radians(90),!1),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCloudGradient=function(t,e){var o,r=t.getContext("2d"),i=t.width,n=t.height,s=2*n/5,a=n/4,h=3*n/10,l=n/5;return o=r.createRadialGradient(0,0,0,0,0,i),o.addColorStop(0,e.lighter(25).toString()),o.addColorStop(1,e.darker(25).toString()),r.fillStyle=o,r.beginPath(),r.arc(a,n-a,a,radians(90),radians(259),!1),r.arc(i/20*5,n/9*4,l,radians(165),radians(300),!1),r.arc(i/20*11,s,s,radians(200),radians(357),!1),r.arc(i-h,n-h,h,radians(269),radians(90),!1),r.closePath(),r.fill(),t},SymbolMorph.prototype.drawSymbolCloudOutline=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=2*i/5,s=i/4,a=3*i/10,h=i/5;return o.strokeStyle=e.toString(),o.beginPath(),o.arc(s+1,i-s-1,s,radians(90),radians(259),!1),o.arc(r/20*5,i/9*4,h,radians(165),radians(300),!1),o.arc(r/20*11,n+1,n,radians(200),radians(357),!1),o.arc(r-a-1,i-a-1,a,radians(269),radians(90),!1),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolTurnRight=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/10,1),n=r/2;return o.lineWidth=i,o.strokeStyle=e.toString(),o.beginPath(),o.arc(n,2*n,n-i/2,radians(0),radians(-90),!1),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(r,n),o.lineTo(n,0),o.lineTo(n,2*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolTurnLeft=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/10,1),n=r/2;return o.lineWidth=i,o.strokeStyle=e.toString(),o.beginPath(),o.arc(n,2*n,n-i/2,radians(180),radians(-90),!0),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,n),o.lineTo(n,0),o.lineTo(n,2*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolStorage=function(t,e){function o(t,o){r.fillStyle=e.toString(),r.beginPath(),r.arc(i/2,t-n,s,radians(60),radians(120),!1),r.lineTo(0,t-2*a),r.arc(i/2,t-n-2*a,s,radians(120),radians(60),!0),r.closePath(),r.fill(),r.fillStyle=e.darker(25).toString(),r.beginPath(),o&&r.arc(i/2,t-n-2*a,s,radians(120),radians(60),!0),r.arc(i/2,t+6*a+1,s,radians(60),radians(120),!0),r.closePath(),o?r.fill():r.stroke()}var r=t.getContext("2d"),i=t.width,n=t.height,s=t.height,a=t.height/11;return r.strokeStyle=e.toString(),o(n),o(n-3*a),o(n-6*a,!1),t},SymbolMorph.prototype.drawSymbolPoster=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=.75*i,s=t.height/5;return o.fillStyle=e.toString(),o.strokeStyle=e.toString(),o.lineWidth=r/15,o.moveTo(r/2,i/3),o.lineTo(r/6,i),o.stroke(),o.moveTo(r/2,i/3),o.lineTo(r/2,i),o.stroke(),o.moveTo(r/2,i/3),o.lineTo(5*r/6,i),o.stroke(),o.fillRect(0,0,r,n),o.clearRect(0,n,r,r/20),o.clearRect(r-s,n-s,s+1,s+1),o.fillStyle=e.darker(25).toString(),o.beginPath(),o.moveTo(r,n-s),o.lineTo(r-s,n-s),o.lineTo(r-s,n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolFlash=function(t,e){var o=t.getContext("2d"),r=t.width,i=r/3,n=t.height,s=n/3,a=s/3;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(i,0),o.lineTo(0,s),o.lineTo(i,s),o.lineTo(0,2*s),o.lineTo(i,2*s),o.lineTo(0,n),o.lineTo(r,2*s-a),o.lineTo(2*i,2*s-a),o.lineTo(r,s-a),o.lineTo(2*i,s-a),o.lineTo(r,0),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolBrush=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=Math.max(r/30,.5);return o.fillStyle=e.toString(),o.lineWidth=2*n,o.beginPath(),o.moveTo(r/8*3,i/2),o.quadraticCurveTo(0,i/2,n,i-n),o.quadraticCurveTo(r/2,i,r/2,i/8*5),o.closePath(),o.fill(),o.lineJoin="round",o.lineCap="round",o.strokeStyle=e.toString(),o.moveTo(r/8*3,i/2),o.lineTo(.75*r,n),o.quadraticCurveTo(r,0,r-n,.25*i),o.stroke(),o.moveTo(r/2,i/8*5),o.lineTo(r-n,.25*i),o.stroke(),t},SymbolMorph.prototype.drawSymbolRectangle=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.width,n=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*n,o.beginPath(),o.moveTo(n,n),o.lineTo(r-n,n),o.lineTo(r-n,i-n),o.lineTo(n,i-n),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolRectangleSolid=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.width;return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(0,0),o.lineTo(r,0),o.lineTo(r,i),o.lineTo(0,i),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolCircle=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*i,o.arc(r/2,r/2,r/2-i,radians(0),radians(360),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolCircleSolid=function(t,e){var o=t.getContext("2d"),r=t.width;return o.fillStyle=e.toString(),o.arc(r/2,r/2,r/2,radians(0),radians(360),!1),o.fill(),t},SymbolMorph.prototype.drawSymbolLine=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*n,o.lineCap="round",o.moveTo(n,n),o.lineTo(r-n,i-n),o.stroke(),t},SymbolMorph.prototype.drawSymbolCrosshairs=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=.5;return o.strokeStyle=e.toString(),o.lineWidth=2*n,o.moveTo(n,i/2),o.lineTo(r-n,i/2),o.stroke(),o.moveTo(r/2,n),o.lineTo(r/2,i-n),o.stroke(),o.moveTo(r/2,i/2),o.arc(r/2,r/2,r/3-n,radians(0),radians(360),!1),o.stroke(),t},SymbolMorph.prototype.drawSymbolPaintbucket=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=t.width/5,s=Math.max(r/30,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(2*n,n),o.lineTo(4*n,3*n),o.lineTo(3*n,4*n),o.quadraticCurveTo(2*n,i,n,4*n),o.quadraticCurveTo(0,3*n,n,2*n),o.closePath(),o.stroke(),o.lineWidth=s,o.moveTo(2*n,2.5*n),o.arc(2*n,2.5*n,s,radians(0),radians(360),!1),o.stroke(),o.moveTo(2*n,2.5*n),o.lineTo(2*n,n/2+s),o.stroke(),o.arc(1.5*n,n/2+s,n/2,radians(0),radians(180),!0),o.stroke(),o.moveTo(n,n/2+s),o.lineTo(n,2*n),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(3.5*n,3.5*n),o.quadraticCurveTo(r,3.5*n,r-s,i),o.lineTo(r,i),o.quadraticCurveTo(r,2*n,2.5*n,1.5*n),o.lineTo(4*n,3*n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolEraser=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=t.width/4,s=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(3*n,s),o.lineTo(s,3*n),o.quadraticCurveTo(n,i,2*n,3*n),o.lineTo(r-s,n),o.closePath(),o.stroke(),o.fillStyle=e.toString(),o.beginPath(),o.moveTo(3*n,0),o.lineTo(1.5*n,1.5*n),o.lineTo(2.5*n,2.5*n),o.lineTo(r,n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolPipette=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=t.width/4,s=n/2,a=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*a,o.beginPath(),o.moveTo(a,i-a),o.quadraticCurveTo(s,i-s,s,i-n),o.lineTo(2*n,1.5*n),o.stroke(),o.beginPath(),o.moveTo(a,i-a),o.quadraticCurveTo(s,i-s,n,i-s),o.lineTo(2.5*n,2*n),o.stroke(),o.fillStyle=e.toString(),o.arc(3*n,n,n-a,radians(0),radians(360),!1),o.fill(),o.beginPath(),o.moveTo(2*n,n),o.lineTo(3*n,2*n),o.stroke(),t},SymbolMorph.prototype.drawSymbolSpeechBubble=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=t.width/3,s=Math.max(r/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(n,2*n),o.quadraticCurveTo(s,2*n,s,n),o.quadraticCurveTo(s,s,n,s),o.lineTo(2*n,s),o.quadraticCurveTo(r-s,s,r-s,n),o.quadraticCurveTo(r-s,2*n,2*n,2*n),o.lineTo(n/2,i-s),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolSpeechBubbleOutline=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=t.width/3,s=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(n,2*n),o.quadraticCurveTo(s,2*n,s,n),o.quadraticCurveTo(s,s,n,s),o.lineTo(2*n,s),o.quadraticCurveTo(r-s,s,r-s,n),o.quadraticCurveTo(r-s,2*n,2*n,2*n),o.lineTo(n/2,i-s),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolArrowUp=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=t.width/2,s=Math.max(r/20,.5);return o.fillStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(s,n),o.lineTo(n,s),o.lineTo(r-s,n),o.lineTo(.65*r,n),o.lineTo(.65*r,i-s),o.lineTo(.35*r,i-s),o.lineTo(.35*r,n),o.closePath(),o.fill(),t},SymbolMorph.prototype.drawSymbolArrowUpOutline=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=t.width/2,s=Math.max(r/20,.5);return o.strokeStyle=e.toString(),o.lineWidth=2*s,o.beginPath(),o.moveTo(s,n),o.lineTo(n,s),o.lineTo(r-s,n),o.lineTo(.65*r,n),o.lineTo(.65*r,i-s),o.lineTo(.35*r,i-s),o.lineTo(.35*r,n),o.closePath(),o.stroke(),t},SymbolMorph.prototype.drawSymbolArrowDown=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(r,r),o.rotate(radians(180)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowDownOutline=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(r,r),o.rotate(radians(180)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowLeft=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(0,r),o.rotate(radians(-90)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowLeftOutline=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(0,r),o.rotate(radians(-90)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowRight=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(r,0),o.rotate(radians(90)),this.drawSymbolArrowUp(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolArrowRightOutline=function(t,e){var o=t.getContext("2d"),r=t.width;return o.save(),o.translate(r,0),o.rotate(radians(90)),this.drawSymbolArrowUpOutline(t,e),o.restore(),t},SymbolMorph.prototype.drawSymbolRobot=function(t,e){var o=t.getContext("2d"),r=t.width,i=t.height,n=t.width/6,s=n/2,a=Math.max(r/20,.5);return o.fillStyle=e.toString(),o.beginPath(),o.moveTo(n+a,n),o.lineTo(2*n,n),o.lineTo(2.5*n,1.5*n),o.lineTo(3.5*n,1.5*n),o.lineTo(4*n,n),o.lineTo(5*n-a,n),o.lineTo(4*n,3*n),o.lineTo(4*n,4*n-a),o.lineTo(2*n,4*n-a),o.lineTo(2*n,3*n),o.closePath(),o.fill(),o.beginPath(),o.moveTo(2.75*n,n+a),o.lineTo(2.4*n,n),o.lineTo(2.2*n,0),o.lineTo(3.8*n,0),o.lineTo(3.6*n,n),o.lineTo(3.25*n,n+a),o.closePath(),o.fill(),o.beginPath(),o.moveTo(2.5*n,4*n),o.lineTo(n,4*n),o.lineTo(s+a,i),o.lineTo(2*n,i),o.closePath(),o.fill(),o.beginPath(),o.moveTo(3.5*n,4*n),o.lineTo(5*n,4*n),o.lineTo(r-(s+a),i),o.lineTo(4*n,i),o.closePath(),o.fill(),o.beginPath(),o.moveTo(n,n),o.lineTo(a,1.5*n),o.lineTo(a,3.25*n),o.lineTo(1.5*n,3.5*n),o.closePath(),o.fill(),o.beginPath(),o.moveTo(5*n,n),o.lineTo(r-a,1.5*n),o.lineTo(r-a,3.25*n),o.lineTo(4.5*n,3.5*n),o.closePath(),o.fill(),t},ColorSlotMorph.prototype=new ArgMorph,ColorSlotMorph.prototype.constructor=ColorSlotMorph,ColorSlotMorph.uber=ArgMorph.prototype,ColorSlotMorph.prototype.init=function(t){ColorSlotMorph.uber.init.call(this,null,!0),this.setColor(t||new Color(145,26,68))},ColorSlotMorph.prototype.getSpec=function(){return"%clr"},ColorSlotMorph.prototype.getUserColor=function(){var t=this,e=this.world(),o=e.hand,r=getDocumentPositionOf(e.worldCanvas),i=o.processMouseMove,n=o.processMouseDown,s=o.processMouseUp,a=new ColorPaletteMorph(null,new Point(16*this.fontSize,10*this.fontSize));e.add(a),a.setPosition(this.bottomLeft().add(new Point(0,this.edge))),o.processMouseMove=function(i){o.setPosition(new Point(i.pageX-r.x,i.pageY-r.y)),t.setColor(e.getGlobalPixelColor(o.position()))},o.processMouseDown=nop,o.processMouseUp=function(){a.destroy(),o.processMouseMove=i,o.processMouseDown=n,o.processMouseUp=s}},ColorSlotMorph.prototype.mouseClickLeft=function(){this.getUserColor()},ColorSlotMorph.prototype.evaluate=function(){return this.color},ColorSlotMorph.prototype.drawNew=function(){var t,e,o;o=this.fontSize+2*this.edge+2*this.typeInPadding,this.silentSetExtent(new Point(o,o)),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?this.parent.color:new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(t)},ColorSlotMorph.prototype.drawRectBorder=InputSlotMorph.prototype.drawRectBorder,BlockHighlightMorph.prototype=new Morph,BlockHighlightMorph.prototype.constructor=BlockHighlightMorph,BlockHighlightMorph.uber=Morph.prototype;MultiArgMorph.prototype=new ArgMorph;MultiArgMorph.prototype.constructor=MultiArgMorph,MultiArgMorph.uber=ArgMorph.prototype,MultiArgMorph.prototype.init=function(t,e,o,r,i,n,s,a,h){var l,p,c,d,u=new FrameMorph;for(this.slotSpec=t||"%s",this.labelText=localize(e||""),this.minInputs=o||0,this.elementSpec=r||null,this.labelColor=n||null,this.shadowColor=s||null,this.shadowOffset=a||null,this.canBeEmpty=!0,MultiArgMorph.uber.init.call(this,null,!0),this.alpha=h===!1?1:0,u.alpha=h===!1?1:0,u.noticesTransparentClick=!0,this.noticesTransparentclick=!0,l=this.labelPart(this.labelText),this.add(l),l.hide(),p=new ArrowMorph("left",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),i),c=new ArrowMorph("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),i),u.add(p),u.add(c),u.drawNew(),u.acceptsDrops=!1,this.add(u),d=0;d<this.minInputs;d+=1)this.addInput()},MultiArgMorph.prototype.label=function(){return this.children[0]},MultiArgMorph.prototype.arrows=function(){return this.children[this.children.length-1]},MultiArgMorph.prototype.getSpec=function(){return"%mult"+this.slotSpec},MultiArgMorph.prototype.setContents=function(t){var e,o=this.inputs();for(e=0;e<t.length;e+=1)null!==t[e]&&o[e]&&o[e].setContents(t[e])},MultiArgMorph.prototype.hide=function(){
this.isVisible=!1,this.changed()},MultiArgMorph.prototype.show=function(){this.isVisible=!0,this.changed()},MultiArgMorph.prototype.setLabelColor=function(t,e,o){this.textColor=t,this.shadowColor=e,this.shadowOffset=o,MultiArgMorph.uber.setLabelColor.call(this,t,e,o)},MultiArgMorph.prototype.fixLayout=function(){if("%t"===this.slotSpec&&(this.isStatic=!0),this.parent){var t,e,o=this.label();this.color=this.parent.color,t=this.shadowColor||this.parent.color.darker(this.labelContrast),e=this.shadowOffset||o.shadowOffset,this.arrows().color=this.color,""!==this.labelText&&(o.shadowColor.eq(t)||(o.shadowColor=t,o.shadowOffset=e,o.drawNew()))}this.fixArrowsLayout(),MultiArgMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},MultiArgMorph.prototype.fixArrowsLayout=function(){var t=this.label(),e=this.arrows(),o=e.children[0],r=e.children[1],i=new Point(r.width()/2,r.height());this.inputs().length<this.minInputs+1?(t.hide(),o.hide(),r.setPosition(e.position().subtract(new Point(i.x,0))),e.setExtent(i)):(""!==this.labelText&&t.show(),o.show(),r.setPosition(o.topCenter()),e.bounds.corner=r.bottomRight().copy()),e.drawNew()},MultiArgMorph.prototype.refresh=function(){this.inputs().forEach(function(t){t.drawNew()})},MultiArgMorph.prototype.drawNew=function(){MultiArgMorph.uber.drawNew.call(this),this.refresh()},MultiArgMorph.prototype.addInput=function(t){var e,o,r=this.labelPart(this.slotSpec),i=this.children.length-1;if(t)r.setContents(t);else if("%scriptVars"===this.elementSpec||"%blockVars"===this.elementSpec){for(o="",e=i;e>0;)o=String.fromCharCode(97+(e-1)%26)+o,e=Math.floor((e-1)/26);r.setContents(o)}else contains(["%parms","%ringparms"],this.elementSpec)&&r.setContents("#"+i);r.parent=this,this.children.splice(i,0,r),r.drawNew(),this.fixLayout()},MultiArgMorph.prototype.removeInput=function(){var t,e;this.children.length>1&&(t=this.children[this.children.length-2],this.removeChild(t),t instanceof BlockMorph&&(e=this.parentThatIsA(ScriptsMorph),e&&e.add(t))),this.fixLayout()},MultiArgMorph.prototype.mouseClickLeft=function(t){if(!this.parentThatIsA(ScriptsMorph))return void this.escalateEvent("mouseClickLeft",t);var e,o=this.arrows(),r=o.children[0],i=o.children[1],n=16===this.world().currentKey?3:1;if(this.startLayout(),i.bounds.containsPoint(t))for(e=0;e<n;e+=1)i.isVisible&&this.addInput();else if(r.bounds.containsPoint(t))for(e=0;e<n;e+=1)r.isVisible&&this.removeInput();else this.escalateEvent("mouseClickLeft",t);this.endLayout()},MultiArgMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this.parentThatIsA(BlockMorph),o="",r=this;return StageMorph.prototype.enableCodeMapping?(e&&(e instanceof RingMorph?o="parms_":"doDeclareVariables"===e.selector&&(o="tempvars_")),t.addItem("code list mapping...",function(){r.mapCodeList(o)}),t.addItem("code item mapping...",function(){r.mapCodeItem(o)}),t.addItem("code delimiter mapping...",function(){r.mapCodeDelimiter(o)}),t):this.parent.userMenu()},MultiArgMorph.prototype.mapCodeDelimiter=function(t){this.mapToCode(t+"delim","list item delimiter")},MultiArgMorph.prototype.mapCodeList=function(t){this.mapToCode(t+"list","list contents <#1>")},MultiArgMorph.prototype.mapCodeItem=function(t){this.mapToCode(t+"item","list item <#1>")},MultiArgMorph.prototype.mapToCode=function(t,e){new DialogBoxMorph(this,function(e){StageMorph.prototype.codeMappings[t]=e},this).promptCode("Code mapping - "+e,StageMorph.prototype.codeMappings[t]||"",this.world())},MultiArgMorph.prototype.mappedCode=function(t){var e,o,r,i=this.parentThatIsA(BlockMorph),n="",s="",a=0,h=[];return i&&(i instanceof RingMorph?n="parms_":"doDeclareVariables"===i.selector&&(n="tempvars_")),e=StageMorph.prototype.codeMappings[n+"list"]||"<#1>",o=StageMorph.prototype.codeMappings[n+"item"]||"<#1>",r=StageMorph.prototype.codeMappings[n+"delim"]||" ",this.inputs().forEach(function(e){h.push(o.replace(/<#1>/g,e.mappedCode(t)))}),h.forEach(function(t){a&&(s+=r),s+=t,a+=1}),e=e.replace(/<#1>/g,s)},MultiArgMorph.prototype.evaluate=function(){var t=[];return this.inputs().forEach(function(e){t.push(e.evaluate())}),t},MultiArgMorph.prototype.isEmptySlot=function(){return!!this.canBeEmpty&&0===this.inputs().length},ArgLabelMorph.prototype=new ArgMorph,ArgLabelMorph.prototype.constructor=ArgLabelMorph,ArgLabelMorph.uber=ArgMorph.prototype,ArgLabelMorph.prototype.init=function(t,e){var o;this.labelText=localize(e||"input list:"),ArgLabelMorph.uber.init.call(this,null,!0),this.isStatic=!0,this.alpha=0,this.noticesTransparentclick=!0,o=this.labelPart(this.labelText),this.add(o),this.add(t)},ArgLabelMorph.prototype.label=function(){return this.children[0]},ArgLabelMorph.prototype.argMorph=function(){return this.children[1]},ArgLabelMorph.prototype.fixLayout=function(){var t,e,o=this.label();this.parent&&(this.color=this.parent.color,e=o.shadowOffset||new Point,t=e.x<0?this.parent.color.darker(this.labelContrast):this.parent.color.lighter(this.labelContrast),""!==this.labelText&&(o.shadowColor.eq(t)||(o.shadowColor=t,o.shadowOffset=e,o.drawNew()))),ArgLabelMorph.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},ArgLabelMorph.prototype.refresh=function(){this.inputs().forEach(function(t){t.drawNew()})},ArgLabelMorph.prototype.drawNew=function(){ArgLabelMorph.uber.drawNew.call(this),this.refresh()},ArgLabelMorph.prototype.setLabelColor=function(t,e,o){if(""!==this.labelText){var r=this.label();r.color=t,r.shadowColor=e,r.shadowOffset=o,r.drawNew()}},ArgLabelMorph.prototype.reactToGrabOf=function(){this.parent instanceof SyntaxElementMorph&&this.parent.revertToDefaultInput(this)},ArgLabelMorph.prototype.evaluate=function(){return this.argMorph().evaluate()},ArgLabelMorph.prototype.isEmptySlot=function(){return!1},FunctionSlotMorph.prototype=new ArgMorph,FunctionSlotMorph.prototype.constructor=FunctionSlotMorph,FunctionSlotMorph.uber=ArgMorph.prototype,FunctionSlotMorph.prototype.init=function(t,e){FunctionSlotMorph.uber.init.call(this,null,!0),this.isPredicate=t||!1,this.color=this.rfColor,this.setExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge),e)},FunctionSlotMorph.prototype.getSpec=function(){return"%f"},FunctionSlotMorph.prototype.drawNew=function(){var t,e;this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),e=this.parent?this.parent.color:new Color(120,120,120),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.isPredicate?this.drawDiamond(t):this.drawRounded(t)},FunctionSlotMorph.prototype.drawRounded=function(t){var e,o=this.height(),r=Math.min(this.rounding,o/2),i=this.width(),n=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.arc(r,r,r,radians(-180),radians(-90),!1),t.arc(i-r,r,r,radians(-90),radians(-0),!1),t.arc(i-r,o-r,r,radians(0),radians(90),!1),t.arc(r,o-r,r,radians(90),radians(180),!1),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r,o-r,r-n,radians(90),radians(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(i-r,r,r-n,radians(-90),radians(0),!1),t.stroke(),t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),e=t.createLinearGradient(0,0,0,this.edge),e.addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,n),t.lineTo(i-r+n,n),t.stroke(),e=t.createRadialGradient(r,r,r-this.edge,r,r,r),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(r,r,r-n,radians(180),radians(270),!1),t.stroke(),e=t.createLinearGradient(0,0,this.edge,0),e.addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,r),t.lineTo(n,o-r),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,e=t.createRadialGradient(i-r,o-r,r-this.edge,i-r,o-r,r),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(i-r,o-r,r-n,radians(0),radians(90),!1),t.stroke(),e=t.createLinearGradient(0,o-this.edge,0,o),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,o-n),t.lineTo(i-r+n,o-n),t.stroke(),e=t.createLinearGradient(i-this.edge,0,i,0),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,r+n),t.lineTo(i-n,o-r),t.stroke())},FunctionSlotMorph.prototype.drawDiamond=function(t){var e,o=this.width(),r=this.height(),i=Math.floor(r/2),n=Math.min(this.rounding,i),s=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.moveTo(0,i),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,i),t.lineTo(o-n,r),t.lineTo(n,r),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(s,i),t.lineTo(n,r-s),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(o-s,i),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=s,t.shadowOffsetY=s,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),e=t.createLinearGradient(0,0,n,0),e.addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,i),t.lineTo(n,s),t.stroke(),e=t.createLinearGradient(0,0,0,this.edge),e.addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,e=t.createLinearGradient(o-n,0,o,0),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,r-s),t.lineTo(o-s,i),t.stroke(),e=t.createLinearGradient(0,r-this.edge,0,r),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,r-s),t.lineTo(o-n-s,r-s),t.stroke())},ReporterSlotMorph.prototype=new FunctionSlotMorph,ReporterSlotMorph.prototype.constructor=ReporterSlotMorph,ReporterSlotMorph.uber=FunctionSlotMorph.prototype,ReporterSlotMorph.prototype.init=function(t){ReporterSlotMorph.uber.init.call(this,t,!0),this.add(this.emptySlot()),this.fixLayout()},ReporterSlotMorph.prototype.emptySlot=function(){var t=new ArgMorph,e=2*this.rfBorder+2*this.edge;return t.color=this.rfColor,t.alpha=0,t.setExtent(new Point(2*(this.fontSize+2*this.edge)-e,this.fontSize+2*this.edge-e)),t},ReporterSlotMorph.prototype.getSpec=function(){return"%r"},ReporterSlotMorph.prototype.contents=function(){return this.children[0]},ReporterSlotMorph.prototype.nestedBlock=function(){var t=this.contents();return t instanceof ReporterBlockMorph?t:null},ReporterSlotMorph.prototype.evaluate=function(){return this.nestedBlock()},ReporterSlotMorph.prototype.isEmptySlot=function(){return null===this.nestedBlock()},ReporterSlotMorph.prototype.fixLayout=function(){var t=this.contents();this.setExtent(t.extent().add(2*this.edge+2*this.rfBorder)),t.setCenter(this.center()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},RingReporterSlotMorph.prototype=new ReporterSlotMorph,RingReporterSlotMorph.prototype.constructor=RingReporterSlotMorph,RingReporterSlotMorph.uber=ReporterSlotMorph.prototype,RingReporterSlotMorph.prototype.rfBorder=RingCommandSlotMorph.prototype.rfBorder,RingReporterSlotMorph.prototype.edge=RingCommandSlotMorph.prototype.edge,RingReporterSlotMorph.prototype.init=function(t){RingReporterSlotMorph.uber.init.call(this,t,!0),this.alpha=RingMorph.prototype.alpha,this.contrast=RingMorph.prototype.contrast,this.isHole=!0},RingReporterSlotMorph.prototype.getSpec=function(){return"%rr"},RingReporterSlotMorph.prototype.replaceInput=function(t,e){RingReporterSlotMorph.uber.replaceInput.call(this,t,e),this.parent instanceof RingMorph&&this.parent.vanishForSimilar()},RingReporterSlotMorph.prototype.drawRounded=function(t){var e,o=this.height(),r=Math.min(this.rounding,o/2),i=this.width(),n=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,o/2),t.arc(r,r,r,radians(-180),radians(-90),!1),t.arc(i-r,r,r,radians(-90),radians(-0),!1),t.lineTo(i,o/2),t.lineTo(i,0),t.lineTo(0,0),t.closePath(),t.fill(),t.beginPath(),t.moveTo(i,o/2),t.arc(i-r,o-r,r,radians(0),radians(90),!1),t.arc(r,o-r,r,radians(90),radians(180),!1),t.lineTo(0,o/2),t.lineTo(0,o),t.lineTo(i,o),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r,o-r,r-n,radians(90),radians(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(i-r,r,r-n,radians(-90),radians(0),!1),t.stroke(),t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),e=t.createLinearGradient(0,0,0,this.edge),e.addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,n),t.lineTo(i-r+n,n),t.stroke(),e=t.createRadialGradient(r,r,r-this.edge,r,r,r),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(r,r,r-n,radians(180),radians(270),!1),t.stroke(),e=t.createLinearGradient(0,0,this.edge,0),e.addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,r),t.lineTo(n,o-r),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,e=t.createRadialGradient(i-r,o-r,r-this.edge,i-r,o-r,r),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(i-r,o-r,r-n,radians(0),radians(90),!1),t.stroke(),e=t.createLinearGradient(0,o-this.edge,0,o),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,o-n),t.lineTo(i-r+n,o-n),t.stroke(),e=t.createLinearGradient(i-this.edge,0,i,0),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,r+n),t.lineTo(i-n,o-r),t.stroke())},RingReporterSlotMorph.prototype.drawDiamond=function(t){var e,o=this.width(),r=this.height(),i=Math.floor(r/2),n=Math.min(this.rounding,i),s=this.edge/2;t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,0),t.lineTo(0,i),t.lineTo(n,0),t.lineTo(o-n,0),t.lineTo(o,i),t.lineTo(o,0),t.closePath(),t.fill(),t.moveTo(o,i),t.lineTo(o-n,r),t.lineTo(n,r),t.lineTo(0,i),t.lineTo(0,r),t.lineTo(o,r),t.closePath(),t.fill(),MorphicPreferences.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(s,i),t.lineTo(n,r-s),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(o-s,i),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=s,t.shadowOffsetY=s,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString(),e=t.createLinearGradient(0,0,n,0),e.addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s,i),t.lineTo(n,s),t.stroke(),e=t.createLinearGradient(0,0,0,this.edge),e.addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(o-n,s),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,e=t.createLinearGradient(o-n,0,o,0),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(o-n,r-s),t.lineTo(o-s,i),t.stroke(),e=t.createLinearGradient(0,r-this.edge,0,r),e.addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(n+s,r-s),t.lineTo(o-n-s,r-s),t.stroke())},CommentMorph.prototype=new BoxMorph,CommentMorph.prototype.constructor=CommentMorph,CommentMorph.uber=BoxMorph.prototype,CommentMorph.prototype.refreshScale=function(){CommentMorph.prototype.fontSize=SyntaxElementMorph.prototype.fontSize,CommentMorph.prototype.padding=5*SyntaxElementMorph.prototype.scale,CommentMorph.prototype.rounding=8*SyntaxElementMorph.prototype.scale},CommentMorph.prototype.refreshScale(),CommentMorph.prototype.init=function(t){var e=this,o=SyntaxElementMorph.prototype.scale;this.block=null,this.stickyOffset=null,this.isCollapsed=!1,this.titleBar=new BoxMorph(this.rounding,1.000001*o,new Color(255,255,180)),this.titleBar.color=new Color(255,255,180),this.titleBar.setHeight(fontHeight(this.fontSize)+this.padding),this.title=null,this.arrow=new ArrowMorph("down",this.fontSize),this.arrow.noticesTransparentClick=!0,this.arrow.mouseClickLeft=function(){e.toggleExpand()},this.contents=new TextMorph(t||localize("add comment here..."),this.fontSize),this.contents.isEditable=!0,this.contents.enableSelecting(),this.contents.maxWidth=90*o,this.contents.drawNew(),this.handle=new HandleMorph(this.contents,80,2*this.fontSize,-2,-2),this.handle.setExtent(new Point(11*o,11*o)),this.anchor=null,CommentMorph.uber.init.call(this,this.rounding,1.000001*o,new Color(255,255,180)),this.color=new Color(255,255,220),this.isDraggable=!0,this.add(this.titleBar),this.add(this.arrow),this.add(this.contents),this.add(this.handle),this.fixLayout()},CommentMorph.prototype.fullCopy=function(){var t=new CommentMorph(this.contents.text);return t.isCollapsed=this.isCollapsed,t.setTextWidth(this.textWidth()),t},CommentMorph.prototype.setTextWidth=function(t){this.contents.maxWidth=t,this.contents.drawNew(),this.fixLayout()},CommentMorph.prototype.textWidth=function(){return this.contents.maxWidth},CommentMorph.prototype.text=function(){return this.contents.text},CommentMorph.prototype.toggleExpand=function(){this.isCollapsed=!this.isCollapsed,this.fixLayout(),this.align()},CommentMorph.prototype.layoutChanged=function(){this.fixLayout(),this.align()},CommentMorph.prototype.fixLayout=function(){var t,e=this.contents.width()+2*this.padding,o=this,r=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.title&&(this.title.destroy(),this.title=null),this.isCollapsed?(this.contents.hide(),this.title=new FrameMorph,this.title.alpha=0,this.title.acceptsDrops=!1,t=new StringMorph(this.contents.text,this.fontSize,null,!0),t.rootForGrab=function(){return o},this.title.add(t),this.title.setHeight(t.height()),this.title.setWidth(e-this.arrow.width()-2*this.padding-this.rounding),this.add(this.title)):this.contents.show(),this.titleBar.setWidth(e),this.contents.setLeft(this.titleBar.left()+this.padding),this.contents.setTop(this.titleBar.bottom()+this.padding),this.arrow.direction=this.isCollapsed?"right":"down",this.arrow.drawNew(),this.arrow.setCenter(this.titleBar.center()),this.arrow.setLeft(this.titleBar.left()+this.padding),this.title&&this.title.setPosition(this.arrow.topRight().add(new Point(this.padding,0))),Morph.prototype.trackChanges=r,this.changed(),this.silentSetHeight(this.titleBar.height()+(this.isCollapsed?0:this.padding+this.contents.height()+this.padding)),this.silentSetWidth(this.titleBar.width()),this.drawNew(),this.handle.drawNew(),this.changed()},CommentMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this;return t.addItem("duplicate",function(){e.fullCopy().pickUp(e.world())},"make a copy\nand pick it up"),t.addItem("delete","destroy"),t.addItem("comment pic...",function(){var t=e.parentThatIsA(IDE_Morph);t.saveCanvasAs(e.fullImageClassic(),t.projetName||localize("Untitled")+" "+localize("comment pic"),!0)},"open a new window\nwith a picture of this comment"),t},CommentMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},CommentMorph.prototype.show=function(){this.isVisible=!0,this.changed()},CommentMorph.prototype.prepareToBeGrabbed=function(){this.block&&(this.block.comment=null,this.block=null),this.anchor&&(this.anchor.destroy(),this.anchor=null,this.removeShadow(),this.addShadow())},CommentMorph.prototype.snap=function(t){var e,o=this.parent;return o instanceof ScriptsMorph?(o.clearDropHistory(),o.lastDroppedBlock=this,e=o.closestBlock(this,t),null!==e&&(e.comment=this,this.block=e,this.snapSound&&this.snapSound.play()),void this.align()):null},CommentMorph.prototype.align=function(t,e){if(this.block){var o,r,i,n,s=t||this.block.topBlock(),a=s.parentThatIsA(ScriptsMorph);this.setTop(this.block.top()+this.block.corner),r=this.top(),i=this.bottom(),o=s.allChildren().filter(function(t){return t instanceof BlockMorph&&t.bottom()>r&&t.top()<i}),n=Math.max.apply(null,o.map(function(t){return t.right()})),this.setLeft(n+5),!e&&a&&a.addBack(this),this.anchor||(this.anchor=new Morph,this.anchor.color=this.titleBar.color),this.anchor.silentSetPosition(new Point(this.block.right(),this.top()+this.edge)),this.anchor.bounds.corner=new Point(this.left(),this.top()+this.edge+1),this.anchor.drawNew(),this.addBack(this.anchor),this.anchor.changed()}},CommentMorph.prototype.startFollowing=function(t,e){this.align(t),e.add(this),this.addShadow(),this.stickyOffset=this.position().subtract(this.block.position()),this.step=function(){this.setPosition(this.block.position().add(this.stickyOffset))}},CommentMorph.prototype.stopFollowing=function(){this.removeShadow(),delete this.step},CommentMorph.prototype.destroy=function(){this.block&&(this.block.comment=null),CommentMorph.uber.destroy.call(this)},CommentMorph.prototype.stackHeight=function(){return this.height()},ScriptFocusMorph.prototype=new BoxMorph,ScriptFocusMorph.prototype.constructor=ScriptFocusMorph,ScriptFocusMorph.uber=BoxMorph.prototype,ScriptFocusMorph.prototype.init=function(t,e,o){this.editor=t,this.element=e,this.atEnd=!1,ScriptFocusMorph.uber.init.call(this),this.element instanceof ScriptsMorph&&this.setPosition(o)},ScriptFocusMorph.prototype.getFocus=function(t){t||(t=this.world()),t&&t.keyboardReceiver!==this&&t.stopEditing(),t.keyboardReceiver=this,this.fixLayout()},ScriptFocusMorph.prototype.fixLayout=function(){this.changed(),this.element instanceof CommandBlockMorph||this.element instanceof CommandSlotMorph||this.element instanceof ScriptsMorph?this.manifestStatement():this.manifestExpression(),this.editor.add(this),this.scrollIntoView(),this.changed()},ScriptFocusMorph.prototype.manifestStatement=function(){var t=this.element instanceof ScriptsMorph,e=this.element.top();this.border=0,this.edge=0,this.alpha=1,this.color=this.editor.feedbackColor,this.setExtent(new Point(t?SyntaxElementMorph.prototype.hatWidth:this.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.element instanceof CommandSlotMorph?e+=SyntaxElementMorph.prototype.corner:this.atEnd&&(e=this.element.bottom()),t||this.setPosition(new Point(this.element.left(),e)),this.fps=2,this.show(),this.step=function(){this.toggleVisibility()}},ScriptFocusMorph.prototype.manifestExpression=function(){this.edge=SyntaxElementMorph.prototype.rounding,this.border=Math.max(SyntaxElementMorph.prototype.edge,3),this.color=this.editor.feedbackColor.copy(),this.color.a=.5,this.borderColor=this.editor.feedbackColor,this.bounds=this.element.fullBounds().expandBy(Math.max(2*SyntaxElementMorph.prototype.edge,SyntaxElementMorph.prototype.reporterDropFeedbackPadding)),this.drawNew(),delete this.fps,delete this.step,this.show()},ScriptFocusMorph.prototype.trigger=function(){var t=this.element;return t instanceof MultiArgMorph?void(t.arrows().children[1].isVisible&&(t.addInput(),this.fixLayout())):t.parent instanceof TemplateSlotMorph?void t.mouseClickLeft():t instanceof BooleanSlotMorph?void t.toggleValue():void(t instanceof InputSlotMorph&&(t.isReadOnly?t.choices&&(t.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):(delete this.fps,delete this.step,this.hide(),this.world().onNextStep=function(){t.contents().edit(),t.contents().selectAll()})))},ScriptFocusMorph.prototype.menu=function(){var t=this.element;t instanceof InputSlotMorph&&t.choices?(t.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):this.insertVariableGetter()},ScriptFocusMorph.prototype.deleteLastElement=function(){var t=this.element;t.parent instanceof ScriptsMorph?(this.atEnd||t instanceof ReporterBlockMorph)&&(t.destroy(),this.element=this.editor,this.atEnd=!1):t instanceof MultiArgMorph?t.arrows().children[0].isVisible&&t.removeInput():t instanceof BooleanSlotMorph?t.isStatic||t.setContents(null):t instanceof ReporterBlockMorph?t.isTemplate||(this.lastElement(),t.prepareToBeGrabbed(),t.destroy()):t instanceof CommandBlockMorph&&(this.atEnd?(this.element=t.parent,t.userDestroy()):t.parent instanceof CommandBlockMorph&&t.parent.userDestroy()),this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.insertBlock=function(t){var e,o,r;t.isTemplate=!1,t.isDraggable=!0,t.snapSound&&t.snapSound.play(),this.element instanceof ScriptsMorph?(this.editor.add(t),this.element=t,t instanceof CommandBlockMorph?(t.setLeft(this.left()),t.isStop()?t.setTop(this.top()):(t.setBottom(this.top()),this.atEnd=!0)):(t.setCenter(this.center()),t.setLeft(this.left()))):this.element instanceof CommandBlockMorph?this.atEnd?(this.element.nextBlock(t),this.element=t,this.fixLayout()):(e=this.element.parent,e instanceof ScriptsMorph?(t.setLeft(this.element.left()),t.setBottom(this.element.top()+this.element.corner),this.editor.add(t),t.nextBlock(this.element),this.fixLayout()):e instanceof CommandSlotMorph?e.nestedBlock(t):e instanceof CommandBlockMorph&&e.nextBlock(t)):this.element instanceof CommandSlotMorph?(this.element.nestedBlock(t),this.element=t,this.atEnd=!0):(e=this.element.parent,e instanceof ScriptsMorph?(this.editor.add(t),t.setPosition(this.element.position()),this.element.destroy()):e.replaceInput(this.element,t),this.element=t),t.fixBlockColor(),this.editor.adjustBounds(),this.fixLayout(),"receiveCondition"===t.selector&&this.editor.owner&&(o=this.editor.owner.parentThatIsA(StageMorph),o&&(o.enableCustomHatBlocks=!0,o.threads.pauseCustomHatBlocks=!1,r=o.parentThatIsA(IDE_Morph),r&&r.controlBar.stopButton.refresh()))},ScriptFocusMorph.prototype.insertVariableGetter=function(){var t,e=this.blockTypes(),o=this,r=new MenuMorph;e&&contains(e,"reporter")&&(t=InputSlotMorph.prototype.getVarNamesDict.call(this.element),Object.keys(t).forEach(function(t){var e=SpriteMorph.prototype.variableBlock(t);e.addShadow(new Point(3,3)),r.addItem(e,function(){e.removeShadow(),o.insertBlock(e)})}),r.items.length>0&&(r.popup(this.world(),this.element.bottomLeft()),r.getFocus()))},ScriptFocusMorph.prototype.stopEditing=function(){this.editor.focus=null,this.world().keyboardReceiver=null,this.destroy()},ScriptFocusMorph.prototype.lastElement=function(){var t,e=this.items();return e.length?(this.atEnd?(this.element=e[e.length-1],this.atEnd=!1):(t=e.indexOf(this.element)-1,t<0&&(t=e.length-1),this.element=e[t]),this.element instanceof CommandSlotMorph&&this.element.nestedBlock()?this.lastElement():this.element instanceof HatBlockMorph&&(e.length>1?this.lastElement():this.atEnd=!0),void this.fixLayout()):void this.shiftScript(new Point(-50,0))},ScriptFocusMorph.prototype.nextElement=function(){var t,e,o=this.items();return o.length?(t=o.indexOf(this.element)+1,t>=o.length&&(t=0),this.atEnd=!1,this.element=o[t],this.element instanceof CommandSlotMorph?(e=this.element.nestedBlock(),e&&(this.element=e)):this.element instanceof HatBlockMorph&&(1===o.length?this.atEnd=!0:this.nextElement()),void this.fixLayout()):void this.shiftScript(new Point(50,0))},ScriptFocusMorph.prototype.lastCommand=function(){var t,e=this.element.parentThatIsA(CommandBlockMorph);return e?(this.element instanceof CommandBlockMorph?this.atEnd?this.atEnd=!1:(t=e.parent.parentThatIsA(CommandBlockMorph),t?this.element=t:(t=e.topBlock().bottomBlock(),t&&(this.element=t,this.atEnd=!0))):(this.element=e,this.atEnd=!1),this.element instanceof HatBlockMorph&&!this.atEnd&&this.lastCommand(),void this.fixLayout()):void(this.element instanceof ScriptsMorph&&this.shiftScript(new Point(0,-50)))},ScriptFocusMorph.prototype.nextCommand=function(){var t,e,o,r=this.element;if(r instanceof ScriptsMorph)return void this.shiftScript(new Point(0,50));for(;!(r instanceof CommandBlockMorph);)if(r=r.parent,r instanceof ScriptsMorph)return;this.atEnd?(o=r.parentThatIsA(CommandSlotMorph),o?(this.element=o.parentThatIsA(CommandBlockMorph),this.atEnd=!1,this.nextCommand()):(t=r.topBlock().parentThatIsA(CommandBlockMorph),t&&(this.element=t,this.atEnd=!1,this.element instanceof HatBlockMorph&&this.nextCommand()))):(e=r.nextBlock(),e?this.element=e:(this.element=r,this.atEnd=!0)),this.fixLayout()},ScriptFocusMorph.prototype.nextScript=function(){var t,e=this.sortedScripts();if(!(e.length<1))return this.element instanceof ScriptsMorph&&(this.element=e[0]),t=e.indexOf(this.element.topBlock())+1,t>=e.length&&(t=0),this.element=e[t],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof HatBlockMorph?this.nextElement():void this.fixLayout()},ScriptFocusMorph.prototype.lastScript=function(){var t,e=this.sortedScripts();if(!(e.length<1))return this.element instanceof ScriptsMorph&&(this.element=e[0]),t=e.indexOf(this.element.topBlock())-1,t<0&&(t=e.length-1),this.element=e[t],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof HatBlockMorph?this.nextElement():void this.fixLayout()},ScriptFocusMorph.prototype.shiftScript=function(t){var e;this.element instanceof ScriptsMorph?this.moveBy(t):(e=this.element.topBlock(),!e||e instanceof PrototypeHatBlockMorph||e.moveBy(t)),this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.newScript=function(){var t=this.position();this.element instanceof ScriptsMorph||(t=this.element.topBlock().fullBounds().bottomLeft().add(new Point(0,50))),this.setPosition(t),this.element=this.editor,this.editor.adjustBounds(),this.fixLayout()},ScriptFocusMorph.prototype.runScript=function(){this.element instanceof ScriptsMorph||this.element.topBlock().mouseClickLeft()},ScriptFocusMorph.prototype.items=function(){if(this.element instanceof ScriptsMorph)return[];var t=this.element.topBlock();return t.allChildren().filter(function(t){return t instanceof SyntaxElementMorph&&!(t instanceof TemplateSlotMorph)&&(!t.isStatic||t.choices||t instanceof BooleanSlotMorph||t instanceof RingMorph||t instanceof MultiArgMorph||t instanceof CommandSlotMorph)})},ScriptFocusMorph.prototype.sortedScripts=function(){var t=this.editor.children.filter(function(t){return t instanceof BlockMorph});return t.sort(function(t,e){return t instanceof PrototypeHatBlockMorph?0:t.top()-e.top()}),t},ScriptFocusMorph.prototype.blockTypes=function(){return this.element.isTemplate?null:this.element instanceof ScriptsMorph?["hat","command","reporter","predicate","ring"]:this.element instanceof HatBlockMorph||this.element instanceof CommandSlotMorph?["command"]:this.element instanceof CommandBlockMorph?this.atEnd&&this.element.isStop()?null:this.element.parent instanceof ScriptsMorph?["hat","command"]:["command"]:this.element instanceof ReporterBlockMorph?"%n"===this.element.getSlotSpec()?["reporter"]:["reporter","predicate","ring"]:"%n"===this.element.getSpec()?["reporter"]:this.element.isStatic?null:["reporter","predicate","ring"]},ScriptFocusMorph.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.reactToKeyEvent)},ScriptFocusMorph.prototype.processKeyUp=function(t){nop(t)},ScriptFocusMorph.prototype.processKeyPress=function(t){nop(t)},ScriptFocusMorph.prototype.processKeyEvent=function(t,e){var o,r,i;switch(this.world().hand.destroyTemporaries(),t.keyCode){case 8:o="backspace";break;case 9:o="tab";break;case 13:o="enter";break;case 16:case 17:case 18:return;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=String.fromCharCode(t.keyCode||t.charCode)}r=t.ctrlKey||t.metaKey?"ctrl ":"",i=t.shiftKey?"shift ":"",o=r+i+o,e.call(this,o)},ScriptFocusMorph.prototype.reactToKeyEvent=function(t){var e,o,r=t.toLowerCase(),i=50;switch(r){case"esc":return this.stopEditing();case"enter":return this.trigger();case"shift enter":return this.newScript();case"ctrl shift enter":return this.runScript();case"space":return this.menu();case"left arrow":
return this.lastElement();case"shift left arrow":return this.shiftScript(new Point(-i,0));case"right arrow":return this.nextElement();case"shift right arrow":return this.shiftScript(new Point(i,0));case"up arrow":return this.lastCommand();case"shift up arrow":return this.shiftScript(new Point(0,-i));case"down arrow":return this.nextCommand();case"shift down arrow":return this.shiftScript(new Point(0,i));case"tab":return this.nextScript();case"shift tab":return this.lastScript();case"backspace":return this.deleteLastElement();default:e=this.blockTypes(),this.element instanceof ScriptsMorph||!e||!contains(e,"reporter")||(o=Object.keys(this.element.getVarNamesDict())),e&&(delete this.fps,delete this.step,this.show(),this.editor.owner.searchBlocks(t,e,o,this))}},modules.threads="2016-August-12";var ThreadManager,Process,Context,VariableFrame;ThreadManager.prototype.pauseCustomHatBlocks=!1,ThreadManager.prototype.toggleProcess=function(t){var e=this.findProcess(t);return e?void e.stop():this.startProcess(t,null,null,null,!0)},ThreadManager.prototype.startProcess=function(t,e,o,r,i,n){var s,a=this.findProcess(t),h=t.topBlock();if(a){if(e)return a;a.stop(),this.removeTerminatedProcesses()}return s=new Process(t.topBlock(),r,n),s.exportResult=o,s.isClicked=i||!1,s.homeContext.receiver.isClone||h.addHighlight(),this.processes.push(s),n&&s.runStep(),s},ThreadManager.prototype.stopAll=function(t){this.processes.forEach(function(e){e!==t&&e.stop()})},ThreadManager.prototype.stopAllForReceiver=function(t,e){this.processes.forEach(function(o){o.homeContext.receiver===t&&o!==e&&(o.stop(),t.isClone&&(o.isDead=!0))})},ThreadManager.prototype.stopProcess=function(t){var e=this.findProcess(t);e&&e.stop()},ThreadManager.prototype.pauseAll=function(t){this.processes.forEach(function(t){t.pause()}),t&&t.pauseAllActiveSounds()},ThreadManager.prototype.isPaused=function(){return null!==detect(this.processes,function(t){return t.isPaused})},ThreadManager.prototype.resumeAll=function(t){this.processes.forEach(function(t){t.resume()}),t&&t.resumeAllActiveSounds()},ThreadManager.prototype.step=function(){this.processes.forEach(function(t){t.homeContext.receiver.isPickedUp()||t.isDead||t.runStep()}),this.removeTerminatedProcesses()},ThreadManager.prototype.removeTerminatedProcesses=function(){var t=[];this.processes.forEach(function(e){var o;!e.isRunning()&&!e.errorFlag||e.isDead?(e.topBlock instanceof BlockMorph&&e.topBlock.removeHighlight(),e.prompter&&(e.prompter.destroy(),e.homeContext.receiver.stopTalking&&e.homeContext.receiver.stopTalking()),(e.topBlock instanceof ReporterBlockMorph||e.isShowingResult)&&(o=e.homeContext.inputs[0],e.onComplete instanceof Function?e.onComplete(o):o instanceof List?e.topBlock.showBubble(o.isTable()?new TableFrameMorph(new TableMorph(o,10)):new ListWatcherMorph(o),e.exportResult):e.topBlock.showBubble(o,e.exportResult))):t.push(e)}),this.processes=t},ThreadManager.prototype.findProcess=function(t){var e=t.topBlock();return detect(this.processes,function(t){return t.topBlock===e})},ThreadManager.prototype.doWhen=function(t,e){if(!this.pauseCustomHatBlocks){var o,r=t.inputs()[0];if(t.removeHighlight()&&(o=t.world(),o&&o.hand.destroyTemporaries()),!e&&t&&!this.findProcess(t))try{invoke(r,null,t.receiver(),50,"the predicate takes\ntoo long for a\ncustom hat block",!0)===!0&&this.startProcess(t)}catch(e){t.addErrorHighlight(),t.showBubble(e.name+"\n"+e.message)}}},Process.prototype={},Process.prototype.constructor=Process,Process.prototype.timeout=500,Process.prototype.isCatchingErrors=!0,Process.prototype.enableLiveCoding=!1,Process.prototype.isRunning=function(){return null!==this.context&&!this.readyToTerminate},Process.prototype.runStep=function(t){if(this.isPaused)return this.pauseStep();for(this.readyToYield=!1;!this.readyToYield&&this.context&&Date.now()-this.lastYield<this.timeout;){if(this.isPaused)return this.pauseStep();if(t&&Date.now()>t)return void(this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp());this.evaluateContext()}if(this.lastYield=Date.now(),this.isFirstStep=!1,this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&(this.homeContext.receiver.endWarp(),this.homeContext.receiver.startWarp()),this.readyToTerminate){for(;this.context;)this.popContext();this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()}},Process.prototype.stop=function(){this.readyToYield=!0,this.readyToTerminate=!0,this.errorFlag=!1,this.context&&this.context.stopMusic()},Process.prototype.pause=function(){this.isPaused=!0,this.context&&this.context.startTime&&(this.pauseOffset=Date.now()-this.context.startTime)},Process.prototype.resume=function(){this.isPaused=!1,this.pauseOffset=null},Process.prototype.pauseStep=function(){this.lastYield=Date.now(),this.context&&this.context.startTime&&(this.context.startTime=this.lastYield-this.pauseOffset)},Process.prototype.evaluateContext=function(){var t=this.context.expression;return this.frameCount+=1,"exit"===this.context.tag&&this.expectReport(),t instanceof Array?this.evaluateSequence(t):t instanceof MultiArgMorph?this.evaluateMultiSlot(t,t.inputs().length):t instanceof ArgLabelMorph?this.evaluateArgLabel(t):t instanceof ArgMorph||t.bindingID?this.evaluateInput(t):t instanceof BlockMorph?this.evaluateBlock(t,t.inputs().length):isString(t)?this[t]():void this.popContext()},Process.prototype.evaluateBlock=function(t,e){var o=t.selector;if("reportOr"===o||"reportAnd"===o||"doReport"===o)return this[o](t);var r=this.context.receiver||this.topBlock.receiver(),i=this.context.inputs;if(e>i.length)this.evaluateNextInput(t);else if(this[o]&&(r=this),this.isCatchingErrors)try{this.returnValueToParentContext(r[o].apply(r,i)),this.popContext()}catch(e){this.handleError(e,t)}else this.returnValueToParentContext(r[o].apply(r,i)),this.popContext()},Process.prototype.reportOr=function(t){var e=this.context.inputs;e.length<1?this.evaluateNextInput(t):e[0]?(this.returnValueToParentContext(!0),this.popContext()):e.length<2?this.evaluateNextInput(t):(this.returnValueToParentContext(e[1]===!0),this.popContext())},Process.prototype.reportAnd=function(t){var e=this.context.inputs;e.length<1?this.evaluateNextInput(t):e[0]?e.length<2?this.evaluateNextInput(t):(this.returnValueToParentContext(e[1]===!0),this.popContext()):(this.returnValueToParentContext(!1),this.popContext())},Process.prototype.doReport=function(t){var e=this.context.outerContext;if(this.isClicked&&t.topBlock()===this.topBlock&&(this.isShowingResult=!0),this.context.expression.partOfCustomCommand)this.doStopCustomBlock(),this.popContext();else{for(;this.context&&"exit"!==this.context.tag;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.context&&("expectReport"===this.context.expression?this.popContext():this.context.tag=null)}this.pushContext(t.inputs()[0],e)},Process.prototype.evaluateMultiSlot=function(t,e){var o,r=this.context.inputs;if(t.bindingID){if(this.isCatchingErrors)try{o=this.context.variables.getVar(t.bindingID)}catch(e){this.handleError(e,t)}else o=this.context.variables.getVar(t.bindingID);this.returnValueToParentContext(o),this.popContext()}else e>r.length?this.evaluateNextInput(t):(this.returnValueToParentContext(new List(r)),this.popContext())},Process.prototype.evaluateArgLabel=function(t){var e=this.context.inputs;e.length<1?this.evaluateNextInput(t):(this.returnValueToParentContext(e[0]),this.popContext())},Process.prototype.evaluateInput=function(t){var e;if(t.bindingID)if(this.isCatchingErrors)try{e=this.context.variables.getVar(t.bindingID)}catch(e){this.handleError(e,t)}else e=this.context.variables.getVar(t.bindingID);else e=t.evaluate(),e&&(t.constructor===CommandSlotMorph||t.constructor===ReporterSlotMorph||t instanceof CSlotMorph&&(!t.isStatic||t.isLambda))&&(e=this.reify(e,new List));this.returnValueToParentContext(e),this.popContext()},Process.prototype.evaluateSequence=function(t){var e=this.context.pc,o=this.context.outerContext,r=this.context.isCustomBlock;e===t.length-1?(this.context=new Context(this.context.parentContext,t[e],this.context.outerContext,this.context.receiver),this.context.isCustomBlock=r):e>=t.length?this.popContext():(this.context.pc+=1,this.pushContext(t[e],o))},Process.prototype.evaluateNextInput=function(t){var e=this.context.inputs.length,o=t.inputs(),r=o[e],i=this.context.expression.selector,n=this.context.outerContext;r.isUnevaluated&&(r.isUnevaluated===!0||r.isUnevaluated())?"reify"===i||"reportScript"===i?this.context.addInput(r):this.context.addInput(this.reify(r,new List)):this.pushContext(r,n)},Process.prototype.doYield=function(){this.popContext(),this.isAtomic||(this.readyToYield=!0)},Process.prototype.expectReport=function(){this.handleError(new Error("reporter didn't report"))},Process.prototype.handleError=function(t,e){var o=e;this.stop(),this.errorFlag=!0,this.topBlock.addErrorHighlight(),(isNil(o)||isNil(o.world()))&&(o=this.topBlock),o.showBubble((o===e?"":"Inside: ")+t.name+"\n"+t.message,this.exportResult)},Process.prototype.errorObsolete=function(){throw new Error("a custom block definition is missing")},Process.prototype.reify=function(t,e,o){var r=new Context(null,null,this.context?this.context.outerContext:null),i=0;return t?(r.expression=this.enableLiveCoding?t:t.fullCopy(),r.expression.show(),o||(r.expression.allEmptySlots().forEach(function(t){i+=1,t instanceof MultiArgMorph?t.bindingID=["arguments"]:t.bindingID=i}),r.emptySlots=i)):r.expression=this.enableLiveCoding?[this.context.expression]:[this.context.expression.fullCopy()],r.inputs=e.asArray(),r.receiver=this.context?this.context.receiver:t.receiver(),r},Process.prototype.reportScript=function(t,e){return this.reify(e,t)},Process.prototype.reifyScript=function(t,e){return this.reify(t,e)},Process.prototype.reifyReporter=function(t,e){return this.reify(t,e)},Process.prototype.reifyPredicate=function(t,e){return this.reify(t,e)},Process.prototype.reportJSFunction=function(t,e){return Function.apply(null,t.asArray().concat([e]))},Process.prototype.doRun=function(t,e){return this.evaluate(t,e,!0)},Process.prototype.evaluate=function(t,e,o){if(!t)return null;if(t instanceof Function)return t.apply(this.blockReceiver(),e.asArray().concat([this]));if(t.isContinuation)return this.runContinuation(t,e);if(!(t instanceof Context))throw new Error("expecting a ring but getting "+t);var r,i,n,s,a=new Context(null,null,t.outerContext),h=this.context.parentContext,l=e.asArray();if(a.receiver||(a.receiver=t.receiver),i=new Context(this.context.parentContext,t.expression,a,t.receiver),this.context.parentContext=i,t.expression instanceof ReporterBlockMorph&&(this.readyToYield=Date.now()-this.lastYield>this.timeout),l.length>0){for(n=0;n<t.inputs.length;n+=1)s=0,isNil(l[n])||(s=l[n]),a.variables.addVar(t.inputs[n],s);if(0===t.inputs.length)if(a.variables.addVar(["arguments"],e),1===l.length)for(n=1;n<=t.emptySlots;n+=1)a.variables.addVar(n,l[0]);else if(l.length===t.emptySlots)for(n=1;n<=l.length;n+=1)a.variables.addVar(n,l[n-1]);else if(1!==t.emptySlots)throw new Error(localize("expecting")+" "+t.emptySlots+" "+localize("input(s), but getting")+" "+l.length)}i.expression instanceof CommandBlockMorph&&(i.expression=i.expression.blockSequence(),o||(h?h.tag="exit":(r=new Context(i.parentContext,"expectReport",a,a.receiver),r.tag="exit",i.parentContext=r)))},Process.prototype.fork=function(t,e){var o=new Process,r=this.homeContext.receiver.parentThatIsA(StageMorph);o.initializeFor(t,e),r.threads.processes.push(o)},Process.prototype.initializeFor=function(t,e){if(t.isContinuation)throw new Error("continuations cannot be forked");if(!(t instanceof Context))throw new Error("expecting a ring but getting "+t);var o,r,i,n=new Context(null,null,t.outerContext),s=new Context(null,t.expression,n),a=e.asArray();if(a.length>0){for(o=0;o<t.inputs.length;o+=1)r=0,isNil(a[o])||(r=a[o]),n.variables.addVar(t.inputs[o],r);if(0===t.inputs.length)if(n.variables.addVar(["arguments"],e),1===a.length)for(o=1;o<=t.emptySlots;o+=1)n.variables.addVar(o,a[0]);else if(a.length===t.emptySlots)for(o=1;o<=a.length;o+=1)n.variables.addVar(o,a[o-1]);else if(1!==t.emptySlots)throw new Error(localize("expecting")+" "+t.emptySlots+" "+localize("input(s), but getting")+" "+a.length)}s.expression instanceof CommandBlockMorph&&(s.expression=s.expression.blockSequence(),i=new Context(s.parentContext,"expectReport",n,n.receiver),i.tag="exit",s.parentContext=i),this.homeContext=new Context,this.homeContext.receiver=t.outerContext.receiver,this.topBlock=t.expression,this.context=s},Process.prototype.doStopBlock=function(){var t=this.context.expression.exitTag;if(isNil(t))return this.doStopCustomBlock();for(;this.context&&(isNil(this.context.tag)||this.context.tag>t);)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.pushContext()},Process.prototype.doStopCustomBlock=function(){for(;this.context&&!this.context.isCustomBlock;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext()},Process.prototype.doCallCC=function(t,e){this.evaluate(t,new List([this.context.continuation()]),!e)},Process.prototype.reportCallCC=function(t){this.doCallCC(t,!0)},Process.prototype.runContinuation=function(t,e){var o=e.asArray();this.context.parentContext=t.copyForContinuationCall(),1===o.length&&this.context.parentContext.outerContext.variables.addVar(1,o[0])},Process.prototype.evaluateCustomBlock=function(){var t,e,o,r,i,n=this.context.parentContext,s=this.context.expression.definition.body,a=this.context.expression.definition.declarations,h=new List(this.context.inputs),l=h.asArray();if(!s)return null;if(this.procedureCount+=1,i=new Context,i.receiver=this.context.receiver,i.variables.parentFrame=this.context.expression.variables,this.context.expression.definition.variableNames.length?this.context.expression.variables.parentFrame=i.receiver?i.receiver.variables:null:i.variables.parentFrame=i.receiver?i.receiver.variables:null,t=new Context(this.context.parentContext,s.expression,i,i.receiver),t.isCustomBlock=!0,this.context.parentContext=t,l.length>0)for(o=0;o<s.inputs.length;o+=1)r=0,isNil(l[o])||(r=l[o]),i.variables.addVar(s.inputs[o],r),"%upvar"===a[s.inputs[o]][0]&&(this.context.outerContext.variables.vars[r]=i.variables.vars[s.inputs[o]]);"command"!==this.context.expression.definition.type?(n?n.tag="exit":(e=new Context(t.parentContext,"expectReport",i,i.receiver),e.tag="exit",t.parentContext=e),this.readyToYield=Date.now()-this.lastYield>this.timeout):(t.expression.tagExitBlocks(this.procedureCount,!0),n&&!n.tag&&(n.tag=this.procedureCount),this.isAtomic||(this.readyToYield=!0)),t.expression=t.expression.blockSequence()},Process.prototype.doDeclareVariables=function(t){var e=this.context.outerContext.variables;t.asArray().forEach(function(t){e.addVar(t)})},Process.prototype.doSetVar=function(t,e){var o,r=this.context.variables,i=t;return i instanceof Context?(o=this.blockReceiver(),"reportGetVar"===i.expression.selector?void i.variables.setVar(i.expression.blockSpec,e,o):void this.doSet(i,e)):void r.setVar(i,e,this.blockReceiver())},Process.prototype.doChangeVar=function(t,e){var o=this.context.variables,r=t;return r instanceof Context&&"reportGetVar"===r.expression.selector?void r.variables.changeVar(r.expression.blockSpec,e,this.blockReceiver()):void o.changeVar(r,e,this.blockReceiver())},Process.prototype.reportGetVar=function(){return this.context.variables.getVar(this.context.expression.blockSpec)},Process.prototype.doShowVar=function(t){var e,o,r,i,n,s,a=this.context.variables,h=t;if(h instanceof Context&&"reportGetVar"===h.expression.selector&&(h=h.expression.blockSpec),this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph))){if(r=a.silentFind(h),!r)return;if(o=detect(e.children,function(t){return t instanceof WatcherMorph&&t.target===r&&t.getter===h}),null!==o)return o.show(),void o.fixLayout();s=contains(this.homeContext.receiver.globalVariables().names(),t),i=s||r.owner?h:h+" "+localize("(temporary)"),o=new WatcherMorph(i,SpriteMorph.prototype.blockColor.variables,r,h),o.setPosition(e.position().add(10)),n=e.watchers(o.left()),n.length>0&&o.setTop(n[n.length-1].bottom()),e.add(o),o.fixLayout()}},Process.prototype.doHideVar=function(t){var e,o,r,i=this.context.variables,n=t;return n instanceof Context&&"reportGetVar"===n.expression.selector&&(n=n.expression.blockSpec),n?void(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph),e&&(r=i.find(n),o=detect(e.children,function(t){return t instanceof WatcherMorph&&t.target===r&&t.getter===n}),null!==o&&(o.isTemporary()?o.destroy():o.hide())))):void this.doRemoveTemporaries()},Process.prototype.doRemoveTemporaries=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&t.watchers().forEach(function(t){t.isTemporary()&&t.destroy()}))},Process.prototype.doDeleteAttr=function(t){var e=t,o=this.blockReceiver();e instanceof Context&&"reportGetVar"===e.expression.selector&&(e=e.expression.blockSpec),contains(o.inheritedVariableNames(!0),e)&&o.deleteVariable(e)},Process.prototype.reportNewList=function(t){return t},Process.prototype.reportCONS=function(t,e){return(new List).cons(t,e)},Process.prototype.reportCDR=function(t){return t.cdr()},Process.prototype.doAddToList=function(t,e){e.add(t)},Process.prototype.doDeleteFromList=function(t,e){var o=t;if("all"===this.inputOption(t))return e.clear();if(""===t)return null;if("last"===this.inputOption(t))o=e.length();else if(isNaN(+this.inputOption(t)))return null;e.remove(o)},Process.prototype.doInsertInList=function(t,e,o){var r=e;return""===e?null:("any"===this.inputOption(e)&&(r=this.reportRandom(1,o.length()+1)),"last"===this.inputOption(e)&&(r=o.length()+1),void o.add(t,r))},Process.prototype.doReplaceInList=function(t,e,o){var r=t;return""===t?null:("any"===this.inputOption(t)&&(r=this.reportRandom(1,e.length())),"last"===this.inputOption(t)&&(r=e.length()),void e.put(o,r))},Process.prototype.reportListItem=function(t,e){var o=t;return""===t?"":("any"===this.inputOption(t)&&(o=this.reportRandom(1,e.length())),"last"===this.inputOption(t)&&(o=e.length()),e.at(o))},Process.prototype.reportListLength=function(t){return t.length()},Process.prototype.reportListContainsItem=function(t,e){return t.contains(e)},Process.prototype.doShowTable=function(t){this.assertType(t,"list"),new TableDialogMorph(t).popUp(this.blockReceiver().world())},Process.prototype.doIf=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]&&t[1]&&(this.pushContext(t[1].blockSequence(),e),this.context.isCustomBlock=o),this.pushContext()},Process.prototype.doIfElse=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]?t[1]&&this.pushContext(t[1].blockSequence(),e):t[2]?this.pushContext(t[2].blockSequence(),e):this.pushContext("doYield"),this.context&&(this.context.isCustomBlock=o),this.pushContext()},Process.prototype.doStop=function(){this.stop()},Process.prototype.doStopAll=function(){var t,e;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&(t.threads.resumeAll(t),t.keysPressed={},t.threads.stopAll(),t.stopAllActiveSounds(),t.children.forEach(function(t){t.stopTalking&&t.stopTalking()}),t.removeAllClones()),e=t.parentThatIsA(IDE_Morph),e&&e.controlBar.pauseButton.refresh())},Process.prototype.doStopThis=function(t){switch(this.inputOption(t)){case"all":this.doStopAll();break;case"this script":this.doStop();break;case"this block":this.doStopBlock();break;default:nop()}},Process.prototype.doStopOthers=function(t){var e;if(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph)))switch(this.inputOption(t)){case"all but this script":e.threads.stopAll(this);break;case"other scripts in sprite":e.threads.stopAllForReceiver(this.homeContext.receiver,this);break;default:nop()}},Process.prototype.doWarp=function(t){var e,o=this.context.outerContext,r=this.context.isCustomBlock;this.popContext(),t&&(this.homeContext.receiver&&(this.homeContext.receiver.startWarp&&this.homeContext.receiver.startWarp(),e=this.homeContext.receiver.parentThatIsA(StageMorph),e&&(e.fps=0)),this.pushContext("doYield"),this.context.isCustomBlock=r,this.isAtomic||this.pushContext("doStopWarping"),this.pushContext(t.blockSequence(),o),this.isAtomic=!0),this.pushContext()},Process.prototype.doStopWarping=function(){var t;this.popContext(),this.isAtomic=!1,this.homeContext.receiver&&(this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp(),t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&(t.fps=t.frameRate))},Process.prototype.reportIsFastTracking=function(){var t;return!(!this.homeContext.receiver||!(t=this.homeContext.receiver.parentThatIsA(IDE_Morph)))&&t.stage.isFastTracked},Process.prototype.doSetFastTracking=function(t){var e;this.reportIsA(t,"Boolean")&&this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(IDE_Morph),e&&(t?e.startFastTracking():e.stopFastTracking()))},Process.prototype.doPauseAll=function(){var t,e;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&t.threads.pauseAll(t),e=t.parentThatIsA(IDE_Morph),e&&e.controlBar.pauseButton.refresh())},Process.prototype.doForever=function(t){this.context.inputs=[],this.pushContext("doYield"),t&&this.pushContext(t.blockSequence()),this.pushContext()},Process.prototype.doRepeat=function(t,e){var o=this.context.expression,r=this.context.outerContext,i=this.context.isCustomBlock;return t<1?null:(this.popContext(),this.pushContext(o,r),this.context.isCustomBlock=i,this.context.addInput(t-1),this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),void this.pushContext())},Process.prototype.doUntil=function(t,e){return t?(this.popContext(),this.pushContext("doYield"),null):(this.context.inputs=[],this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),void this.pushContext())},Process.prototype.doWaitUntil=function(t){return t?(this.popContext(),this.pushContext("doYield"),null):(this.context.inputs=[],this.pushContext("doYield"),void this.pushContext())},Process.prototype.reportMap=function(t,e){var o;if(e.isLinked){if(this.context.inputs.length<3&&(this.context.addInput(new List),this.context.inputs[2].isLinked=!0,this.context.addInput(this.context.inputs[2]),this.context.addInput(e)),0===this.context.inputs[4].length())return this.context.inputs[3].rest=e.cons(this.context.inputs[5]),void this.returnValueToParentContext(this.context.inputs[2].cdr());this.context.inputs.length>5&&(this.context.inputs[3].rest=e.cons(this.context.inputs[5]),this.context.inputs[3]=this.context.inputs[3].rest,this.context.inputs.splice(5)),o=this.context.inputs[4].at(1),this.context.inputs[4]=this.context.inputs[4].cdr(),this.pushContext(),this.evaluate(t,new List([o]))}else{if(this.context.inputs.length-2===e.length())return void this.returnValueToParentContext(new List(this.context.inputs.slice(2)));o=e.at(this.context.inputs.length-1),this.pushContext(),this.evaluate(t,new List([o]))}},Process.prototype.doForEach=function(t,e,o){isNil(this.context.inputs[3])&&(this.context.inputs[3]=1);var r=this.context.inputs[3];this.context.outerContext.variables.addVar(t),this.context.outerContext.variables.setVar(t,e.at(r)),r>e.length()||(this.context.inputs[3]+=1,this.pushContext("doYield"),this.pushContext(),this.evaluate(o,new List,!0))},Process.prototype.doWait=function(t){return this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime>=1e3*t?null:(this.pushContext("doYield"),void this.pushContext())},Process.prototype.doGlide=function(t,e,o){return this.context.startTime||(this.context.startTime=Date.now(),this.context.startValue=new Point(this.blockReceiver().xPosition(),this.blockReceiver().yPosition())),Date.now()-this.context.startTime>=1e3*t?(this.blockReceiver().gotoXY(e,o),null):(this.blockReceiver().glide(1e3*t,e,o,Date.now()-this.context.startTime,this.context.startValue),this.pushContext("doYield"),void this.pushContext())},Process.prototype.doSayFor=function(t,e){return this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().bubble(t)),Date.now()-this.context.startTime>=1e3*e?(this.blockReceiver().stopTalking(),null):(this.pushContext("doYield"),void this.pushContext())},Process.prototype.doThinkFor=function(t,e){return this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().doThink(t)),Date.now()-this.context.startTime>=1e3*e?(this.blockReceiver().stopTalking(),null):(this.pushContext("doYield"),void this.pushContext())},Process.prototype.blockReceiver=function(){return this.context?this.context.receiver||this.homeContext.receiver:this.homeContext.receiver},Process.prototype.doPlaySoundUntilDone=function(t){var e=this.blockReceiver();return null===this.context.activeAudio&&(this.context.activeAudio=e.playSound(t)),this.context.activeAudio.ended||this.context.activeAudio.terminated?null:(this.pushContext("doYield"),void this.pushContext())},Process.prototype.doStopAllSounds=function(){var t=this.homeContext.receiver.parentThatIsA(StageMorph);t&&(t.threads.processes.forEach(function(t){t.context&&(t.context.stopMusic(),t.context.activeAudio&&t.popContext())}),t.stopAllActiveSounds())},Process.prototype.doAsk=function(t){var e,o=this.homeContext.receiver.parentThatIsA(StageMorph),r=this.blockReceiver(),i=r instanceof StageMorph,n=r instanceof SpriteMorph&&!r.isVisible;if(o.keysPressed={},this.prompter){if(this.prompter.isDone)return o.lastAnswer=this.prompter.inputField.getValue(),this.prompter.destroy(),this.prompter=null,i||r.stopTalking(),null}else e=detect(o.children,function(t){return t instanceof StagePrompterMorph}),e||(i||n||r.bubble(t,!1,!0),this.prompter=new StagePrompterMorph(i||n?t:null),o.scale<1?this.prompter.setWidth(o.width()-10):this.prompter.setWidth(o.dimensions.x-20),this.prompter.fixLayout(),this.prompter.setCenter(o.center()),this.prompter.setBottom(o.bottom()-this.prompter.border),o.add(this.prompter),this.prompter.inputField.edit(),o.changed());this.pushContext("doYield"),this.pushContext()},Process.prototype.reportLastAnswer=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).lastAnswer},Process.prototype.reportURL=function(t){var e;if(this.httpRequest){if(4===this.httpRequest.readyState)return e=this.httpRequest.responseText,this.httpRequest=null,e}else this.httpRequest=new XMLHttpRequest,this.httpRequest.open("GET","http://"+t,!0),this.httpRequest.send(null);this.pushContext("doYield"),this.pushContext()},Process.prototype.doBroadcast=function(t){var e,o,r,i=this.homeContext.receiver.parentThatIsA(StageMorph),n=t,s=this,a=[],h=[];if(t instanceof List&&2===t.length())if(e=this.blockReceiver(),n=t.at(1),o=t.at(2),isSnapObject(o))r=[o];else if(isString(o))r=o===i.name?[i]:[this.getOtherObject(o,e,i)];else{if(!(o instanceof List))return;r=o.itemsArray().map(function(t){return s.getOtherObject(t,e,i)})}else r=i.children.concat(i);return""!==n&&(i.lastMessage=t,r.forEach(function(t){isSnapObject(t)&&(a=a.concat(t.allHatBlocksFor(n)))}),a.forEach(function(t){h.push(i.threads.startProcess(t,i.isThreadSafe))})),h},Process.prototype.doBroadcastAndWait=function(t){return this.context.activeSends||(this.context.activeSends=this.doBroadcast(t)),this.context.activeSends=this.context.activeSends.filter(function(t){return t.isRunning()}),0===this.context.activeSends.length?null:(this.pushContext("doYield"),void this.pushContext())},Process.prototype.getLastMessage=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getLastMessage():""},Process.prototype.reportIsA=function(t,e){return this.reportTypeOf(t)===this.inputOption(e)},Process.prototype.assertType=function(t,e){var o=this.reportTypeOf(t);if(o===e)return!0;if(e instanceof Array&&contains(e,o))return!0;throw new Error("expecting "+e+" but getting "+o)},Process.prototype.assertAlive=function(t){if(t&&t.isCorpse)throw new Error("cannot operate on a deleted sprite")},Process.prototype.reportTypeOf=function(t){var e;return null===t||void 0===t?"nothing":t===!0||t===!1?"Boolean":isNaN(+t)?isString(t)?"text":t instanceof List?"list":t instanceof SpriteMorph?"sprite":t instanceof StageMorph?"stage":t instanceof Context?t.expression instanceof RingMorph?t.expression.dataType():t.expression instanceof ReporterBlockMorph?t.expression.isPredicate?"predicate":"reporter":t.expression instanceof Array?(e=t.expression[t.pc||0],e.isPredicate?"predicate":e instanceof RingMorph?e.dataType():e instanceof ReporterBlockMorph?"reporter":e instanceof CommandBlockMorph?"command":"reporter"):t.expression instanceof CommandBlockMorph?"command":"reporter":"undefined":"number"},Process.prototype.reportSum=function(t,e){return+t+ +e},Process.prototype.reportDifference=function(t,e){return+t-+e},Process.prototype.reportProduct=function(t,e){return+t*+e},Process.prototype.reportQuotient=function(t,e){return+t/+e},Process.prototype.reportModulus=function(t,e){var o=+t,r=+e;return(o%r+r)%r},Process.prototype.reportRandom=function(t,e){var o=+t,r=+e;return o%1!==0||r%1!==0?Math.random()*(r-o)+o:Math.floor(Math.random()*(r-o+1))+o},Process.prototype.reportLessThan=function(t,e){var o=+t,r=+e;return(isNaN(o)||isNaN(r))&&(o=t,r=e),o<r},Process.prototype.reportNot=function(t){return!t},Process.prototype.reportGreaterThan=function(t,e){var o=+t,r=+e;return(isNaN(o)||isNaN(r))&&(o=t,r=e),o>r},Process.prototype.reportEquals=function(t,e){return snapEquals(t,e)},Process.prototype.reportIsIdentical=function(t,e){function o(){Object.prototype.hasOwnProperty.call(t,r)&&delete t[r],Object.prototype.hasOwnProperty.call(e,r)&&delete e[r]}var r="idTag";return this.isImmutable(t)||this.isImmutable(e)?snapEquals(t,e):(o(),t[r]=Date.now(),e[r]===t[r]?(o(),!0):(o(),!1))},Process.prototype.isImmutable=function(t){var e=this.reportTypeOf(t);return"nothing"===e||"Boolean"===e||"text"===e||"number"===e||"undefined"===e},Process.prototype.reportBoolean=function(t){return t},Process.prototype.reportRound=function(t){return Math.round(+t)},Process.prototype.reportMonadic=function(t,e){var o=+e,r=0;switch(this.inputOption(t)){case"abs":r=Math.abs(o);break;case"ceiling":r=Math.ceil(o);break;case"floor":r=Math.floor(o);break;case"sqrt":r=Math.sqrt(o);break;case"sin":r=Math.sin(radians(o));break;case"cos":r=Math.cos(radians(o));break;case"tan":r=Math.tan(radians(o));break;case"asin":r=degrees(Math.asin(o));break;case"acos":r=degrees(Math.acos(o));break;case"atan":r=degrees(Math.atan(o));break;case"ln":r=Math.log(o);break;case"log":r=Math.log(o)/Math.LN10;break;case"e^":r=Math.exp(o);break;case"10^":r=Math.pow(10,o);break;default:nop()}return r},Process.prototype.reportTextFunction=function(t,e){var o=(isNil(e)?"":e).toString(),r="";switch(this.inputOption(t)){case"encode URI":r=encodeURI(o);break;case"decode URI":r=decodeURI(o);break;case"encode URI component":r=encodeURIComponent(o);break;case"decode URI component":r=decodeURIComponent(o);break;case"XML escape":r=(new XML_Element).escape(o);break;case"XML unescape":r=(new XML_Element).unescape(o);break;case"hex sha512 hash":r=hex_sha512(o);break;default:nop()}return r},Process.prototype.reportJoin=function(t,e){var o=(isNil(t)?"":t).toString(),r=(isNil(e)?"":e).toString();return o.concat(r)},Process.prototype.reportJoinWords=function(t){return t instanceof List?t.asText():(t||"").toString()},Process.prototype.reportLetter=function(t,e){if(e instanceof List)return"";var o=+(t||0),r=isNil(e)?"":e.toString();return r[o-1]||""},Process.prototype.reportStringSize=function(t){return t instanceof List?t.length():isNil(t)?0:t.toString().length},Process.prototype.reportUnicode=function(t){var e=(t||"").toString()[0];return e?e.charCodeAt(0):0},Process.prototype.reportUnicodeAsLetter=function(t){
var e=+(t||0);return String.fromCharCode(e)},Process.prototype.reportTextSplit=function(t,e){var o,r,i=["text","number"],n=this.reportTypeOf(t),s=this.reportTypeOf(this.inputOption(e));if(!contains(i,n))throw new Error("expecting text instead of a "+n);if(!contains(i,s))throw new Error("expecting a text delimiter instead of a "+s);switch(o=isNil(t)?"":t.toString(),this.inputOption(e)){case"line":r=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case"tab":r="\t";break;case"cr":r="\r";break;case"whitespace":o=o.trim(),r=/\s+/;break;case"letter":r="";break;default:r=isNil(e)?"":e.toString()}return new List(o.split(r))},Process.prototype.alert=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.world(),e.isDevMode&&alert("Snap! "+t.asArray()))},Process.prototype.log=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.world(),e.isDevMode&&console.log("Snap! "+t.asArray()))},Process.prototype.getOtherObject=function(t,e,o){if(isSnapObject(t))return t;var r=isNil(o)?e.parentThatIsA(StageMorph):o,i=null;return r&&(i=detect(r.children,function(e){return e.name===t}),i||(i=detect(r.world().hand.children,function(e){return e instanceof SpriteMorph&&e.name===t}))),i},Process.prototype.getObjectsNamed=function(t,e,o){function r(e){return e instanceof SpriteMorph&&e.isClone?e.cloneOriginName===t:e.name===t}var i=isNil(o)?e.parentThatIsA(StageMorph):o,n=[];return i&&(n=i.children.filter(r),n.length||(n=i.world().hand.children.filter(r))),n},Process.prototype.doFaceTowards=function(t){var e,o=this.blockReceiver();o&&("mouse-pointer"===this.inputOption(t)?o.faceToXY(this.reportMouseX(),this.reportMouseY()):(e=this.getOtherObject(t,this.homeContext.receiver),e&&o.faceToXY(e.xPosition(),e.yPosition())))},Process.prototype.doGotoObject=function(t){var e,o=this.blockReceiver();o&&("mouse-pointer"===this.inputOption(t)?o.gotoXY(this.reportMouseX(),this.reportMouseY()):(e=this.getOtherObject(t,this.homeContext.receiver),e&&o.gotoXY(e.xPosition(),e.yPosition())))},Process.prototype.createClone=function(t){var e,o=this.blockReceiver();t&&o&&("myself"===this.inputOption(t)?o.createClone(!this.isFirstStep):(e=this.getOtherObject(t,o),e&&e.createClone(!this.isFirstStep)))},Process.prototype.reportTouchingObject=function(t){var e=this.blockReceiver();return!!e&&this.objectTouchingObject(e,t)},Process.prototype.objectTouchingObject=function(t,e){var o,r,i,n,s=this;if("mouse-pointer"===this.inputOption(e)){if(n=t.world().hand.position(),t.bounds.containsPoint(n)&&!t.isTransparentAt(n))return!0}else if(r=t.parentThatIsA(StageMorph)){if("edge"===this.inputOption(e)&&(i=t.bounds,!t.costume&&t.penBounds&&(i=t.penBounds.translateBy(t.position())),!r.bounds.containsRectangle(i)))return!0;if("pen trails"===this.inputOption(e)&&t.isTouching(r.penTrailsMorph()))return!0;if(isSnapObject(e))return t.isTouching(e);if(o=e instanceof List?e.itemsArray():this.getObjectsNamed(e,t,r),o.some(function(e){return t.isTouching(e)}))return!0}return t.parts.some(function(t){return s.objectTouchingObject(t,e)})},Process.prototype.reportTouchingColor=function(t){var e,o=this.blockReceiver();return!(!o||!(e=o.parentThatIsA(StageMorph)))&&(!!o.isTouching(e.colorFiltered(t,o))||o.parts.some(function(o){return o.isTouching(e.colorFiltered(t,o))}))},Process.prototype.reportColorIsTouchingColor=function(t,e){var o,r=this.blockReceiver();return!(!r||!(o=r.parentThatIsA(StageMorph)))&&(!!r.colorFiltered(t).isTouching(o.colorFiltered(e,r))||r.parts.some(function(r){return r.colorFiltered(t).isTouching(o.colorFiltered(e,r))}))},Process.prototype.reportDistanceTo=function(t){var e,o,r,i,n=this.blockReceiver();return n?(r=n.rotationCenter(),i=r,"mouse-pointer"===this.inputOption(t)&&(i=n.world().hand.position()),o=n.parentThatIsA(StageMorph),e=this.getOtherObject(t,n,o),e&&(i=e.rotationCenter()),r.distanceTo(i)/o.scale):0},Process.prototype.reportAttributeOf=function(t,e){var o,r,i=this.blockReceiver();if(i&&(this.assertAlive(i),r=i.parentThatIsA(StageMorph),o=r.name===e?r:this.getOtherObject(e,i,r))){if(this.assertAlive(o),t instanceof Context)return this.reportContextFor(t,o);if(isString(t))return o.variables.getVar(t);switch(this.inputOption(t)){case"x position":return o.xPosition?o.xPosition():"";case"y position":return o.yPosition?o.yPosition():"";case"direction":return o.direction?o.direction():"";case"costume #":return o.getCostumeIdx();case"costume name":return o.costume?o.costume.name:localize(o instanceof SpriteMorph?"Turtle":"Empty");case"size":return o.getScale?o.getScale():""}}return""},Process.prototype.reportGet=function(t){var e,o,r,i=this.blockReceiver();if(i)switch(this.inputOption(t)){case"self":return i;case"other sprites":return o=i.parentThatIsA(StageMorph),new List(o.children.filter(function(t){return t instanceof SpriteMorph&&t!==i}));case"parts":return new List(i.parts||[]);case"anchor":return i.anchor||"";case"parent":return i.exemplar||"";case"children":return new List(i.specimens?i.specimens():[]);case"clones":return o=i.parentThatIsA(StageMorph),r=i.name||i.cloneOriginName,new List(o.children.filter(function(t){return t.isClone&&t!==i&&t.cloneOriginName===r}));case"other clones":return i.isClone?this.reportGet(["clones"]):new List;case"neighbors":return o=i.parentThatIsA(StageMorph),e=i.bounds.expandBy(new Point(i.width(),i.height())),new List(o.children.filter(function(t){return t instanceof SpriteMorph&&t!==i&&t.bounds.intersects(e)}));case"dangling?":return!i.rotatesWithAnchor;case"rotation x":return i.xPosition();case"rotation y":return i.yPosition();case"center x":return i.xCenter();case"center y":return i.yCenter();case"name":return i.name;case"stage":return i.parentThatIsA(StageMorph)}return""},Process.prototype.doSet=function(t,e){var o,r;if(t instanceof Context){if(r=this.blockReceiver(),this.assertAlive(r),!(t instanceof Context)||"reportGet"!==t.expression.selector)throw new Error(localize("unsupported attribute"));switch(o=t.expression.inputs()[0].evaluate(),o instanceof Array&&(o=o[0]),o){case"anchor":if(this.assertType(r,"sprite"),e instanceof SpriteMorph){if(!r.enableNesting||contains(r.allParts(),e))throw new Error(localize("unable to nest\n(disabled or circular?)"));e.attachPart(r)}else r.detachFromAnchor();break;case"parent":this.assertType(r,"sprite"),e=e instanceof SpriteMorph?e:null,r.setExemplar(e);break;case"dangling?":this.assertType(r,"sprite"),this.assertType(e,"Boolean"),r.rotatesWithAnchor=!e,r.version=Date.now();break;case"rotation x":this.assertType(r,"sprite"),this.assertType(e,"number"),r.setRotationX(e);break;case"rotation y":this.assertType(r,"sprite"),this.assertType(e,"number"),r.setRotationY(e);break;default:throw new Error('"'+localize(o)+'" '+localize("is read-only"))}}},Process.prototype.reportContextFor=function(t,e){var o=copy(t);return o.receiver=e,o.outerContext&&(o.outerContext=copy(o.outerContext),o.outerContext.variables=copy(o.outerContext.variables),o.outerContext.receiver=e,o.outerContext.variables.parentFrame=e.variables),o},Process.prototype.reportMouseX=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&(e=t.world()))?(e.hand.position().x-t.center().x)/t.scale:0},Process.prototype.reportMouseY=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&(e=t.world()))?(t.center().y-e.hand.position().y)/t.scale:0},Process.prototype.reportMouseDown=function(){var t;return!(!this.homeContext.receiver||!(t=this.homeContext.receiver.world()))&&"left"===t.hand.mouseButton},Process.prototype.reportKeyPressed=function(t){var e;return!(!this.homeContext.receiver||!(e=this.homeContext.receiver.parentThatIsA(StageMorph)))&&("any key"===this.inputOption(t)?Object.keys(e.keysPressed).length>0:void 0!==e.keysPressed[t])},Process.prototype.doResetTimer=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph),t&&t.resetTimer())},Process.prototype.reportTimer=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getTimer():0},Process.prototype.reportDate=function(t){var e,o,r,i=this.inputOption(t),n={year:"getFullYear",month:"getMonth",date:"getDate","day of week":"getDay",hour:"getHours",minute:"getMinutes",second:"getSeconds","time in milliseconds":"getTime"};return n[i]?(e=new Date,o=n[i],r=e[o](),"month"!==i&&"day of week"!==i||(r+=1),r):""},Process.prototype.doMapCodeOrHeader=function(t,e,o){if("code"===this.inputOption(e))return this.doMapCode(t,o);if("header"===this.inputOption(e))return this.doMapHeader(t,o);throw new Error(" '"+e+"'\nis not a valid option")},Process.prototype.doMapHeader=function(t,e){if(t instanceof Context&&t.expression instanceof SyntaxElementMorph)return t.expression.mapHeader(e||"")},Process.prototype.doMapCode=function(t,e){if(t instanceof Context&&t.expression instanceof SyntaxElementMorph)return t.expression.mapCode(e||"")},Process.prototype.doMapStringCode=function(t){StageMorph.prototype.codeMappings.string=t||"<#1>"},Process.prototype.doMapListCode=function(t,e,o){var r="",i="delim";"parameters"===this.inputOption(e)?r="parms_":"variables"===this.inputOption(e)&&(r="tempvars_"),"list"===this.inputOption(t)?i="list":"item"===this.inputOption(t)&&(i="item"),StageMorph.prototype.codeMappings[r+i]=o||""},Process.prototype.reportMappedCode=function(t){return t instanceof Context&&t.expression instanceof SyntaxElementMorph?t.expression.mappedCode():""},Process.prototype.doRest=function(t){var e=this.reportTempo();this.doWait(60/e*t)},Process.prototype.reportTempo=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(StageMorph))?t.getTempo():0},Process.prototype.doChangeTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph),e&&e.changeTempo(t))},Process.prototype.doSetTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(StageMorph),e&&e.setTempo(t))},Process.prototype.doPlayNote=function(t,e){var o=this.reportTempo();this.doPlayNoteForSecs(parseFloat(t||"0"),60/o*parseFloat(e||"0"))},Process.prototype.doPlayNoteForSecs=function(t,e){return this.context.startTime||(this.context.startTime=Date.now(),this.context.activeNote=new Note(t),this.context.activeNote.play()),Date.now()-this.context.startTime>=1e3*e?(this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null):(this.pushContext("doYield"),void this.pushContext())},Process.prototype.inputOption=function(t){return t instanceof Array?t[0]:t},Process.prototype.pushContext=function(t,e){this.context=new Context(this.context,t,e||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver)},Process.prototype.popContext=function(){this.context&&this.context.stopMusic(),this.context=this.context?this.context.parentContext:null},Process.prototype.returnValueToParentContext=function(t){if(void 0!==t){var e=this.context?this.context.parentContext||this.homeContext:this.homeContext;e.addInput(t)}},Process.prototype.reportStackSize=function(){return this.context?this.context.stackSize():0},Process.prototype.reportFrameCount=function(){return this.frameCount},Context.prototype.toString=function(){var t=this.expression;return t instanceof Array&&t.length>0&&(t="["+t[0]+"]"),"Context >> "+t+" "+this.variables},Context.prototype.image=function(){var t,e,o=new RingMorph;return this.expression instanceof Morph?(t=this.expression.fullCopy(),this.isContinuation&&(e=detect(t.allInputs(),function(t){return 1===t.bindingID}),e&&t.revertToDefaultInput(e,!0)),o.embed(t,this.inputs),o.fullImage()):this.expression instanceof Array?(t=this.expression[this.pc].fullCopy(),t instanceof RingMorph&&!t.contents()?t.fullImage():(o.embed(t,this.isContinuation?[]:this.inputs),o.fullImage())):(o.color=SpriteMorph.prototype.blockColor.other,o.setSpec("%rc %ringparms"),this.isContinuation||this.inputs.forEach(function(t){o.parts()[1].addInput(t)}),o.fullImage())},Context.prototype.continuation=function(){var t;if(this.expression instanceof Array)t=this;else{if(!this.parentContext)return new Context(null,"doStop");t=this.parentContext}return t=t.copyForContinuation(),t.tag=null,t.isContinuation=!0,t},Context.prototype.copyForContinuation=function(){var t=copy(this),e=t,o=!(this.expression instanceof Array||isString(this.expression));if(o)for(e.prepareContinuationForBinding();e.parentContext;)e.parentContext=copy(e.parentContext),e=e.parentContext,e.inputs=[];return t},Context.prototype.copyForContinuationCall=function(){var t=copy(this),e=t,o=!(this.expression instanceof Array||isString(this.expression));if(o)for(this.expression=this.expression.fullCopy(),this.inputs=[];e.parentContext;)e.parentContext=copy(e.parentContext),e=e.parentContext,e.inputs=[];return t},Context.prototype.prepareContinuationForBinding=function(){var t,e=this.inputs.length;this.expression=this.expression.fullCopy(),t=this.expression.inputs()[e],t&&(this.inputs=[],t.bindingID=1,this.emptySlots=1)},Context.prototype.addInput=function(t){this.inputs.push(t)},Context.prototype.stopMusic=function(){this.activeNote&&(this.activeNote.stop(),this.activeNote=null)},Context.prototype.stackSize=function(){return this.parentContext?1+this.parentContext.stackSize():1},Variable.prototype.toString=function(){return"transient "},Variable.prototype.copy=function(){return new Variable(this.value,this.isTransient)},VariableFrame.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}"},VariableFrame.prototype.copy=function(){var t=new VariableFrame(this.parentFrame),e=this;return this.names().forEach(function(o){t.addVar(o,e.getVar(o))}),t},VariableFrame.prototype.deepCopy=function(){var t;return t=new VariableFrame(this.parentFrame?this.parentFrame.deepCopy():this.parentFrame),t.vars=copy(this.vars),t},VariableFrame.prototype.find=function(t){var e=this.silentFind(t);if(e)return e;throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.silentFind=function(t){return void 0!==this.vars[t]?this:this.parentFrame?this.parentFrame.silentFind(t):null},VariableFrame.prototype.setVar=function(t,e,o){var r=this.find(t);r&&(o instanceof SpriteMorph&&r.owner instanceof SpriteMorph&&o!==r.owner?o.shadowVar(t,e):r.vars[t].value=e)},VariableFrame.prototype.changeVar=function(t,e,o){var r,i,n=this.find(t);n&&(r=parseFloat(n.vars[t].value),i=isNaN(r)?e:r+parseFloat(e),o instanceof SpriteMorph&&n.owner instanceof SpriteMorph&&o!==n.owner?o.shadowVar(t,i):n.vars[t].value=i)},VariableFrame.prototype.getVar=function(t){var e,o=this.silentFind(t);if(o)return e=o.vars[t].value,0===e?0:e!==!1&&(""===e?"":e||0);if("number"==typeof t)return"";throw new Error(localize("a variable of name '")+t+localize("'\ndoes not exist in this context"))},VariableFrame.prototype.addVar=function(t,e){this.vars[t]=new Variable(0===e?0:e!==!1&&(""===e?"":e||0))},VariableFrame.prototype.deleteVar=function(t){var e=this.find(t);e&&delete e.vars[t]},VariableFrame.prototype.names=function(){var t,e=[];for(t in this.vars)Object.prototype.hasOwnProperty.call(this.vars,t)&&e.push(t);return e},VariableFrame.prototype.allNamesDict=function(){function t(t,e){var o;for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=o)}for(var e={},o=this;o;)t(o.vars,e),o=o.parentFrame;return e},VariableFrame.prototype.allNames=function(){var t,e=[],o=this.allNamesDict();for(t in o)Object.prototype.hasOwnProperty.call(o,t)&&e.push(t);return e},modules.objects="2016-July-19";var SpriteMorph,StageMorph,SpriteBubbleMorph,Costume,SVG_Costume,CostumeEditorMorph,Sound,Note,CellMorph,WatcherMorph,StagePrompterMorph,Note,SpriteHighlightMorph;SpriteMorph.prototype=new PenMorph,SpriteMorph.prototype.constructor=SpriteMorph,SpriteMorph.uber=PenMorph.prototype,SpriteMorph.prototype.categories=["motion","control","looks","sensing","sound","operators","pen","variables","lists","other"],SpriteMorph.prototype.blockColor={motion:new Color(74,108,212),looks:new Color(143,86,227),sound:new Color(207,74,217),pen:new Color(0,161,120),control:new Color(230,168,34),sensing:new Color(4,148,220),operators:new Color(98,194,19),variables:new Color(243,118,29),lists:new Color(217,77,17),other:new Color(150,150,150)},SpriteMorph.prototype.paletteColor=new Color(55,55,55),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),SpriteMorph.prototype.isCachingPrimitives=!0,SpriteMorph.prototype.enableNesting=!0,SpriteMorph.prototype.enableFirstClass=!0,SpriteMorph.prototype.useFlatLineEnds=!1,SpriteMorph.prototype.highlightColor=new Color(250,200,130),SpriteMorph.prototype.highlightBorder=8,SpriteMorph.prototype.bubbleColor=new Color(255,255,255),SpriteMorph.prototype.bubbleFontSize=14,SpriteMorph.prototype.bubbleFontIsBold=!0,SpriteMorph.prototype.bubbleCorner=10,SpriteMorph.prototype.bubbleBorder=3,SpriteMorph.prototype.bubbleBorderColor=new Color(190,190,190),SpriteMorph.prototype.bubbleMaxTextWidth=130,SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype.blocks={forward:{only:SpriteMorph,type:"command",category:"motion",spec:"move %n steps",defaults:[10]},turn:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %clockwise %n degrees",defaults:[15]},turnLeft:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %counterclockwise %n degrees",defaults:[15]},setHeading:{only:SpriteMorph,type:"command",category:"motion",spec:"point in direction %dir"},doFaceTowards:{only:SpriteMorph,type:"command",category:"motion",spec:"point towards %dst"},gotoXY:{only:SpriteMorph,type:"command",category:"motion",spec:"go to x: %n y: %n",defaults:[0,0]},doGotoObject:{only:SpriteMorph,type:"command",category:"motion",spec:"go to %dst"},doGlide:{only:SpriteMorph,type:"command",category:"motion",spec:"glide %n secs to x: %n y: %n",defaults:[1,0,0]},changeXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change x by %n",defaults:[10]},setXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set x to %n",defaults:[0]},changeYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change y by %n",defaults:[10]},setYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set y to %n",defaults:[0]},bounceOffEdge:{only:SpriteMorph,type:"command",category:"motion",spec:"if on edge, bounce"},xPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"x position"},yPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"y position"},direction:{only:SpriteMorph,type:"reporter",category:"motion",spec:"direction"},doSwitchToCostume:{type:"command",category:"looks",spec:"switch to costume %cst"},doWearNextCostume:{type:"command",category:"looks",spec:"next costume"},getCostumeIdx:{type:"reporter",category:"looks",spec:"costume #"},doSayFor:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s for %n secs",defaults:[localize("Hello!"),2]},bubble:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s",defaults:[localize("Hello!")]},doThinkFor:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s for %n secs",defaults:[localize("Hmm..."),2]},doThink:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s",defaults:[localize("Hmm...")]},changeEffect:{type:"command",category:"looks",spec:"change %eff effect by %n",defaults:[null,25]},setEffect:{type:"command",category:"looks",spec:"set %eff effect to %n",defaults:[null,0]},clearEffects:{type:"command",category:"looks",spec:"clear graphic effects"},changeScale:{only:SpriteMorph,type:"command",category:"looks",spec:"change size by %n",defaults:[10]},setScale:{only:SpriteMorph,type:"command",category:"looks",spec:"set size to %n %",defaults:[100]},getScale:{only:SpriteMorph,type:"reporter",category:"looks",spec:"size"},show:{only:SpriteMorph,type:"command",category:"looks",spec:"show"},hide:{only:SpriteMorph,type:"command",category:"looks",spec:"hide"},comeToFront:{only:SpriteMorph,type:"command",category:"looks",spec:"go to front"},goBack:{only:SpriteMorph,type:"command",category:"looks",spec:"go back %n layers",defaults:[1]},doScreenshot:{type:"command",category:"looks",spec:"save %imgsource as costume named %s",defaults:[["pen trails"],localize("screenshot")]},reportCostumes:{dev:!0,type:"reporter",category:"looks",spec:"wardrobe"},alert:{dev:!0,type:"command",category:"looks",spec:"alert %mult%s"},log:{dev:!0,type:"command",category:"looks",spec:"console log %mult%s"},playSound:{type:"command",category:"sound",spec:"play sound %snd"},doPlaySoundUntilDone:{type:"command",category:"sound",spec:"play sound %snd until done"},doStopAllSounds:{type:"command",category:"sound",spec:"stop all sounds"},doRest:{type:"command",category:"sound",spec:"rest for %n beats",defaults:[.2]},doPlayNote:{type:"command",category:"sound",spec:"play note %n for %n beats",defaults:[60,.5]},doChangeTempo:{type:"command",category:"sound",spec:"change tempo by %n",defaults:[20]},doSetTempo:{type:"command",category:"sound",spec:"set tempo to %n bpm",defaults:[60]},getTempo:{type:"reporter",category:"sound",spec:"tempo"},reportSounds:{dev:!0,type:"reporter",category:"sound",spec:"jukebox"},clear:{type:"command",category:"pen",spec:"clear"},down:{only:SpriteMorph,type:"command",category:"pen",spec:"pen down"},up:{only:SpriteMorph,type:"command",category:"pen",spec:"pen up"},setColor:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %clr"},changeHue:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen color by %n",defaults:[10]},setHue:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %n",defaults:[0]},changeBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen shade by %n",defaults:[10]},setBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen shade to %n",defaults:[100]},changeSize:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen size by %n",defaults:[1]},setSize:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen size to %n",defaults:[1]},doStamp:{only:SpriteMorph,type:"command",category:"pen",spec:"stamp"},floodFill:{only:SpriteMorph,type:"command",category:"pen",spec:"fill"},receiveGo:{type:"hat",category:"control",spec:"when %greenflag clicked"},receiveKey:{type:"hat",category:"control",spec:"when %keyHat key pressed"},receiveInteraction:{type:"hat",category:"control",spec:"when I am %interaction",defaults:["clicked"]},receiveMessage:{type:"hat",category:"control",spec:"when I receive %msgHat"},receiveCondition:{type:"hat",category:"control",spec:"when %b"},doBroadcast:{type:"command",category:"control",spec:"broadcast %msg"},doBroadcastAndWait:{type:"command",category:"control",spec:"broadcast %msg and wait"},getLastMessage:{type:"reporter",category:"control",spec:"message"},doWait:{type:"command",category:"control",spec:"wait %n secs",defaults:[1]},doWaitUntil:{type:"command",category:"control",spec:"wait until %b"},doForever:{type:"command",category:"control",spec:"forever %c"},doRepeat:{type:"command",category:"control",spec:"repeat %n %c",defaults:[10]},doUntil:{type:"command",category:"control",spec:"repeat until %b %c"},doIf:{type:"command",category:"control",spec:"if %b %c"},doIfElse:{type:"command",category:"control",spec:"if %b %c else %c"},doStopThis:{type:"command",category:"control",spec:"stop %stopChoices"},doStopOthers:{type:"command",category:"control",spec:"stop %stopOthersChoices"},doRun:{type:"command",category:"control",spec:"run %cmdRing %inputs"},fork:{type:"command",category:"control",spec:"launch %cmdRing %inputs"},evaluate:{type:"reporter",category:"control",spec:"call %repRing %inputs"},doReport:{type:"command",category:"control",spec:"report %s"},doCallCC:{type:"command",category:"control",spec:"run %cmdRing w/continuation"},reportCallCC:{type:"reporter",category:"control",spec:"call %cmdRing w/continuation"},doWarp:{type:"command",category:"other",spec:"warp %c"},receiveOnClone:{type:"hat",category:"control",spec:"when I start as a clone"},createClone:{type:"command",category:"control",spec:"create a clone of %cln"},removeClone:{type:"command",category:"control",spec:"delete this clone"},doPauseAll:{type:"command",category:"control",spec:"pause all %pause"},reportTouchingObject:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %col ?"},reportTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %clr ?"},reportColorIsTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"color %clr is touching %clr ?"},colorFiltered:{dev:!0,type:"reporter",category:"sensing",spec:"filtered for %clr"},reportStackSize:{dev:!0,type:"reporter",category:"sensing",spec:"stack size"},reportFrameCount:{dev:!0,type:"reporter",category:"sensing",spec:"frames"},reportThreadCount:{dev:!0,type:"reporter",category:"sensing",spec:"processes"},doAsk:{type:"command",category:"sensing",spec:"ask %s and wait",defaults:[localize("what's your name?")]},reportLastAnswer:{dev:!0,type:"reporter",category:"sensing",spec:"answer"},getLastAnswer:{type:"reporter",category:"sensing",spec:"answer"},reportMouseX:{type:"reporter",category:"sensing",spec:"mouse x"},reportMouseY:{type:"reporter",category:"sensing",spec:"mouse y"},reportMouseDown:{type:"predicate",category:"sensing",spec:"mouse down?"},reportKeyPressed:{type:"predicate",category:"sensing",spec:"key %key pressed?"},reportDistanceTo:{type:"reporter",category:"sensing",spec:"distance to %dst"},doResetTimer:{type:"command",category:"sensing",spec:"reset timer"},reportTimer:{dev:!0,type:"reporter",category:"sensing",spec:"timer"},getTimer:{type:"reporter",category:"sensing",spec:"timer"},reportAttributeOf:{type:"reporter",category:"sensing",spec:"%att of %spr",defaults:[["costume #"]]},reportURL:{type:"reporter",category:"sensing",spec:"http:// %s",defaults:["snap.berkeley.edu"]},reportIsFastTracking:{type:"predicate",category:"sensing",spec:"turbo mode?"},doSetFastTracking:{type:"command",category:"sensing",spec:"set turbo mode to %b"},reportDate:{type:"reporter",category:"sensing",spec:"current %dates"},reportGet:{type:"reporter",category:"sensing",spec:"my %get",defaults:[["neighbors"]]},reifyScript:{type:"ring",category:"other",spec:"%rc %ringparms",alias:"command ring lambda"},reifyReporter:{type:"ring",category:"other",spec:"%rr %ringparms",alias:"reporter ring lambda"},reifyPredicate:{type:"ring",category:"other",spec:"%rp %ringparms",alias:"predicate ring lambda"},reportSum:{type:"reporter",category:"operators",spec:"%n + %n"},reportDifference:{type:"reporter",category:"operators",spec:"%n  %n",alias:"-"},reportProduct:{type:"reporter",category:"operators",spec:"%n  %n",alias:"*"},reportQuotient:{type:"reporter",category:"operators",spec:"%n / %n"},reportRound:{type:"reporter",category:"operators",spec:"round %n"},reportMonadic:{type:"reporter",category:"operators",spec:"%fun of %n",defaults:[null,10]},reportModulus:{type:"reporter",category:"operators",spec:"%n mod %n"},reportRandom:{type:"reporter",category:"operators",spec:"pick random %n to %n",defaults:[1,10]},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},reportAnd:{type:"predicate",category:"operators",spec:"%b and %b"},reportOr:{type:"predicate",category:"operators",spec:"%b or %b"},reportNot:{type:"predicate",category:"operators",spec:"not %b"},reportBoolean:{type:"predicate",category:"operators",spec:"%bool",alias:"true boolean"},reportFalse:{type:"predicate",category:"operators",spec:"%bool",defaults:[!1],alias:"false boolean"},reportJoinWords:{type:"reporter",category:"operators",spec:"join %words",defaults:[localize("hello")+" ",localize("world")]},reportLetter:{type:"reporter",category:"operators",spec:"letter %n of %s",defaults:[1,localize("world")]},reportStringSize:{type:"reporter",category:"operators",spec:"length of %s",defaults:[localize("world")]},reportUnicode:{type:"reporter",category:"operators",spec:"unicode of %s",defaults:["a"]},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"unicode %n as letter",defaults:[65]},reportIsA:{type:"predicate",category:"operators",spec:"is %s a %typ ?",defaults:[5]},reportIsIdentical:{type:"predicate",category:"operators",spec:"is %s identical to %s ?"},reportTextSplit:{type:"reporter",category:"operators",spec:"split %s by %delim",defaults:[localize("hello")+" "+localize("world")," "]},reportJSFunction:{type:"reporter",category:"operators",spec:"JavaScript function ( %mult%s ) { %code }"},reportTypeOf:{dev:!0,type:"reporter",category:"operators",spec:"type of %s",defaults:[5]},reportTextFunction:{dev:!0,type:"reporter",category:"operators",spec:"%txtfun of %s",defaults:[null,"Abelson & Sussman"]},doSetVar:{type:"command",category:"variables",spec:"set %var to %s",defaults:[null,0]},doChangeVar:{type:"command",category:"variables",spec:"change %var by %n",defaults:[null,1]},doShowVar:{type:"command",category:"variables",spec:"show variable %var"},doHideVar:{type:"command",category:"variables",spec:"hide variable %var"},doDeclareVariables:{type:"command",category:"other",spec:"script variables %scriptVars"},doDeleteAttr:{type:"command",category:"variables",spec:"delete %shd"},reportNewList:{type:"reporter",category:"lists",spec:"list %exp"},reportCONS:{type:"reporter",category:"lists",spec:"%s in front of %l"},reportListItem:{type:"reporter",category:"lists",spec:"item %idx of %l",defaults:[1]},reportCDR:{type:"reporter",category:"lists",spec:"all but first of %l"},reportListLength:{type:"reporter",category:"lists",spec:"length of %l"},reportListContainsItem:{type:"predicate",category:"lists",spec:"%l contains %s",defaults:[null,localize("thing")]},doAddToList:{type:"command",category:"lists",spec:"add %s to %l",defaults:[localize("thing")]},doDeleteFromList:{type:"command",category:"lists",spec:"delete %ida of %l",defaults:[1]},doInsertInList:{type:"command",category:"lists",spec:"insert %s at %idx of %l",defaults:[localize("thing"),1]},doReplaceInList:{type:"command",category:"lists",spec:"replace item %idx of %l with %s",defaults:[1,null,localize("thing")]},reportMap:{dev:!0,type:"reporter",category:"lists",spec:"map %repRing over %l"},doForEach:{dev:!0,type:"command",category:"lists",spec:"for %upvar in %l %cl",defaults:[localize("each item")]},doShowTable:{dev:!0,type:"command",category:"lists",spec:"show table %l"},doMapCodeOrHeader:{type:"command",category:"other",spec:"map %cmdRing to %codeKind %code"},doMapStringCode:{type:"command",category:"other",spec:"map String to code %code",defaults:["<#1>"]},doMapListCode:{type:"command",category:"other",spec:"map %codeListPart of %codeListKind to code %code"},reportMappedCode:{type:"reporter",category:"other",spec:"code of %cmdRing"}}},SpriteMorph.prototype.initBlocks(),SpriteMorph.prototype.initBlockMigrations=function(){SpriteMorph.prototype.blockMigrations={doStopAll:{selector:"doStopThis",inputs:[["all"]]},doStop:{selector:"doStopThis",inputs:[["this script"]]},doStopBlock:{selector:"doStopThis",inputs:[["this block"]]},receiveClick:{selector:"receiveInteraction",inputs:[["clicked"]]},reportTrue:{selector:"reportBoolean",inputs:[!0]},reportFalse:{selector:"reportBoolean",inputs:[!1]}}},SpriteMorph.prototype.initBlockMigrations(),SpriteMorph.prototype.blockAlternatives={turn:["turnLeft"],turnLeft:["turn"],changeXPosition:["changeYPosition","setXPosition","setYPosition"],setXPosition:["setYPosition","changeXPosition","changeYPosition"],changeYPosition:["changeXPosition","setYPosition","setXPosition"],setYPosition:["setXPosition","changeYPosition","changeXPosition"],xPosition:["yPosition"],yPosition:["xPosition"],doSayFor:["doThinkFor","bubble","doThink","doAsk"],doThinkFor:["doSayFor","doThink","bubble","doAsk"],
bubble:["doThink","doAsk","doSayFor","doThinkFor"],doThink:["bubble","doAsk","doSayFor","doThinkFor"],show:["hide"],hide:["show"],changeEffect:["setEffect"],setEffect:["changeEffect"],changeScale:["setScale"],setScale:["changeScale"],playSound:["doPlaySoundUntilDone"],doPlaySoundUntilDone:["playSound"],doChangeTempo:["doSetTempo"],doSetTempo:["doChangeTempo"],clear:["down","up","doStamp"],down:["up","clear","doStamp"],up:["down","clear","doStamp"],doStamp:["clear","down","up"],changeHue:["setHue","changeBrightness","setBrightness"],setHue:["changeHue","changeBrightness","setBrightness"],changeBrightness:["setBrightness","setHue","changeHue"],setBrightness:["changeBrightness","setHue","changeHue"],changeSize:["setSize"],setSize:["changeSize"],doBroadcast:["doBroadcastAndWait"],doBroadcastAndWait:["doBroadcast"],doIf:["doIfElse","doUntil"],doIfElse:["doIf","doUntil"],doRepeat:["doUntil"],doUntil:["doRepeat","doIf"],doAsk:["bubble","doThink","doSayFor","doThinkFor"],getLastAnswer:["getTimer"],getTimer:["getLastAnswer"],reportMouseX:["reportMouseY"],reportMouseY:["reportMouseX"],reportSum:["reportDifference","reportProduct","reportQuotient"],reportDifference:["reportSum","reportProduct","reportQuotient"],reportProduct:["reportDifference","reportSum","reportQuotient"],reportQuotient:["reportDifference","reportProduct","reportSum"],reportLessThan:["reportEquals","reportGreaterThan"],reportEquals:["reportLessThan","reportGreaterThan"],reportGreaterThan:["reportEquals","reportLessThan"],reportAnd:["reportOr"],reportOr:["reportAnd"],doSetVar:["doChangeVar"],doChangeVar:["doSetVar"],doShowVar:["doHideVar"],doHideVar:["doShowVar"]},SpriteMorph.prototype.init=function(t){this.name=localize("Sprite"),this.variables=new VariableFrame(t||null,this),this.scripts=new ScriptsMorph(this),this.customBlocks=[],this.costumes=new List,this.costume=null,this.sounds=new List,this.normalExtent=new Point(60,60),this.scale=1,this.rotationStyle=1,this.version=Date.now(),this.isClone=!1,this.isCorpse=!1,this.cloneOriginName="",this.parts=[],this.anchor=null,this.nestingScale=1,this.rotatesWithAnchor=!0,this.layers=null,this.blocksCache={},this.paletteCache={},this.rotationOffset=new Point,this.idx=0,this.wasWarped=!1,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},this.exemplar=null,SpriteMorph.uber.init.call(this),this.isDraggable=!0,this.isDown=!1,this.heading=90,this.changed(),this.drawNew(),this.changed()},SpriteMorph.prototype.fullCopy=function(t){var e,o,r=SpriteMorph.uber.fullCopy.call(this),i=this,n=[];r.stopTalking(),r.color=this.color.copy(),r.blocksCache={},r.paletteCache={},r.scripts=this.scripts.fullCopy(t),r.scripts.owner=r,r.variables=this.variables.copy(),r.variables.owner=r,r.customBlocks=[],t||this.customBlocks.forEach(function(t){e=t.copyAndBindTo(r),r.customBlocks.push(e),r.allBlockInstances(t).forEach(function(t){t.definition=e})}),this.costumes.asArray().forEach(function(e){var o=t?e:e.copy();n.push(o),e===i.costume&&(r.costume=o)}),r.costumes=new List(n),n=[],this.sounds.asArray().forEach(function(t){n.push(t)}),r.sounds=new List(n),r.nestingScale=1,r.rotatesWithAnchor=!0,r.anchor=null,r.parts=[],this.parts.forEach(function(e){var o=e.fullCopy(t);o.nestingScale=e.nestingScale,o.rotatesWithAnchor=e.rotatesWithAnchor,r.attachPart(o)}),r.graphicsValues={};for(o in this.graphicsValues)this.graphicsValues.hasOwnProperty(o)&&(r.graphicsValues[o]=this.graphicsValues[o]);return r},SpriteMorph.prototype.appearIn=function(t){this.isClone||(this.name=t.newSpriteName(this.name),t.corral.addSprite(this),t.sprites.add(this)),t.stage.add(this),this.parts.forEach(function(e){e.appearIn(t)})},SpriteMorph.prototype.setName=function(t){this.name=t||this.name,this.version=Date.now()},SpriteMorph.prototype.drawNew=function(){var t,e,o,r,i,n,s,a,h,l,p,c,d,u,g=this,f=[];if(this.isWarped)return void(this.wantsRedraw=!0);if(t=this.center(),r=this.costume&&"function"==typeof this.costume.loaded,s=this.parent instanceof StageMorph?this.parent.scale:1,e=this.rotationStyle?this.heading:90,2===this.rotationStyle&&(e=90,(this.heading>180&&this.heading<360||this.heading<0&&this.heading>-180)&&(o=!0)),this.costume&&!r)n=o?this.costume.flipped():this.costume,f=n.bounds().corners().map(function(t){return t.rotateBy(radians(e-90),g.costume.center())}),h=f[0],p=f[0],f.forEach(function(t){h=h.min(t),p=p.max(t)}),c=h.corner(p).extent().multiplyBy(this.scale*s),l=new Point(0,0).rotateBy(radians(-(e-90)),n.center()).subtract(h),this.image=newCanvas(c,!0),this.silentSetExtent(c),d=this.image.getContext("2d"),d.scale(this.scale*s,this.scale*s),d.translate(l.x,l.y),d.rotate(radians(e-90)),d.drawImage(n.contents,0,0),this.image=this.applyGraphicsEffects(this.image),this.setCenter(t,!0),this.rotationOffset=l.translateBy(n.rotationCenter).rotateBy(radians(-(e-90)),l).scaleBy(this.scale*s);else if(e=o?-90:e,a=Math.min(Math.max(this.normalExtent.x*this.scale*s,5),1e3),this.silentSetExtent(new Point(a,a)),this.image=newCanvas(this.extent(),!0),this.setCenter(t,!0),SpriteMorph.uber.drawNew.call(this,e),this.rotationOffset=this.extent().divideBy(2),this.image=this.applyGraphicsEffects(this.image),r)return i=this.costume,u=setInterval(function(){g.wearCostume(i),clearInterval(u)},100),g.wearCostume(null);this.version=Date.now()},SpriteMorph.prototype.endWarp=function(){if(this.isWarped=!1,this.wantsRedraw){var t=this.xPosition(),e=this.yPosition();this.drawNew(),this.silentGotoXY(t,e,!0),this.wantsRedraw=!1}this.parent.changed()},SpriteMorph.prototype.rotationCenter=function(){return this.position().add(this.rotationOffset)},SpriteMorph.prototype.colorFiltered=function(t){var e,o,r,i,n,s=new Morph,a=this.extent();for(o=normalizeCanvas(this.image,!0).getContext("2d").getImageData(0,0,a.x,a.y),s.image=newCanvas(a,!0),s.bounds=this.bounds.copy(),e=s.image.getContext("2d"),n=e.createImageData(a.x,a.y),i=0;i<a.x*a.y*4;i+=4)r=new Color(o.data[i],o.data[i+1],o.data[i+2]),r.eq(t)&&(n.data[i]=o.data[i],n.data[i+1]=o.data[i+1],n.data[i+2]=o.data[i+2],n.data[i+3]=255);return e.putImageData(n,0,0),s},SpriteMorph.prototype.blockForSelector=function(t,e){var o,r,i,n,s,a;if(o=this.blockMigrations[t],r=this.blocks[o?o.selector:t],!r)return null;if(i="command"===r.type?new CommandBlockMorph:"hat"===r.type?new HatBlockMorph:"ring"===r.type?new RingMorph:new ReporterBlockMorph("predicate"===r.type),i.color=this.blockColor[r.category],i.category=r.category,i.selector=o?o.selector:t,contains(["reifyReporter","reifyPredicate"],i.selector)&&(i.isStatic=!0),i.setSpec(localize(r.spec)),e&&r.defaults||o&&o.inputs)if(n=o?o.inputs:r.defaults,i.defaults=n,s=i.inputs(),s[0]instanceof MultiArgMorph)s[0].setContents(n),s[0].defaults=n;else for(a=0;a<n.length;a+=1)null!==n[a]&&s[a].setContents(n[a]);return i},SpriteMorph.prototype.variableBlock=function(t){var e=new ReporterBlockMorph(!1);return e.selector="reportGetVar",e.color=this.blockColor.variables,e.category="variables",e.setSpec(t),e.isDraggable=!0,e},SpriteMorph.prototype.blockTemplates=function(t){function e(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function o(t){var e=SpriteMorph.prototype.variableBlock(t);return e.isDraggable=!1,e.isTemplate=!0,contains(u,t)&&e.ghost(),e}function r(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){c.toggleWatcher(t,localize(e.spec),c.blockColor[e.category])},null,function(){return c.showingWatcher(t)},null)}function i(t){return new ToggleMorph("checkbox",this,function(){c.toggleVariableWatcher(t)},null,function(){return c.showingVariableWatcher(t)},null)}function n(){var t=new MenuMorph(this);return t.addItem("help...","showHelp"),t}function s(t){var e;t&&(c.isVariableNameInUse(t[0],t[1])?c.inform("that name is already in use"):(e=c.parentThatIsA(IDE_Morph),c.addVariable(t[0],t[1]),c.showingVariableWatcher(t[0])||c.toggleVariableWatcher(t[0],t[1]),e.flushBlocksCache("variables"),e.refreshPalette()))}var a,h,l,p=[],c=this,d=t||"motion",u=this.inheritedVariableNames();return"motion"===d?(p.push(e("forward")),p.push(e("turn")),p.push(e("turnLeft")),p.push("-"),p.push(e("setHeading")),p.push(e("doFaceTowards")),p.push("-"),p.push(e("gotoXY")),p.push(e("doGotoObject")),p.push(e("doGlide")),p.push("-"),p.push(e("changeXPosition")),p.push(e("setXPosition")),p.push(e("changeYPosition")),p.push(e("setYPosition")),p.push("-"),p.push(e("bounceOffEdge")),p.push("-"),p.push(r("xPosition")),p.push(e("xPosition")),p.push(r("yPosition")),p.push(e("yPosition")),p.push(r("direction")),p.push(e("direction"))):"looks"===d?(p.push(e("doSwitchToCostume")),p.push(e("doWearNextCostume")),p.push(r("getCostumeIdx")),p.push(e("getCostumeIdx")),p.push("-"),p.push(e("doSayFor")),p.push(e("bubble")),p.push(e("doThinkFor")),p.push(e("doThink")),p.push("-"),p.push(e("changeEffect")),p.push(e("setEffect")),p.push(e("clearEffects")),p.push("-"),p.push(e("changeScale")),p.push(e("setScale")),p.push(r("getScale")),p.push(e("getScale")),p.push("-"),p.push(e("show")),p.push(e("hide")),p.push("-"),p.push(e("comeToFront")),p.push(e("goBack")),this.world().isDevMode&&(p.push("-"),l=new TextMorph(localize("development mode \ndebugging primitives:")),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("reportCostumes")),p.push("-"),p.push(e("log")),p.push(e("alert")),p.push("-"),p.push(e("doScreenshot")))):"sound"===d?(p.push(e("playSound")),p.push(e("doPlaySoundUntilDone")),p.push(e("doStopAllSounds")),p.push("-"),p.push(e("doRest")),p.push("-"),p.push(e("doPlayNote")),p.push("-"),p.push(e("doChangeTempo")),p.push(e("doSetTempo")),p.push(r("getTempo")),p.push(e("getTempo")),this.world().isDevMode&&(p.push("-"),l=new TextMorph(localize("development mode \ndebugging primitives:")),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("reportSounds")))):"pen"===d?(p.push(e("clear")),p.push("-"),p.push(e("down")),p.push(e("up")),p.push("-"),p.push(e("setColor")),p.push(e("changeHue")),p.push(e("setHue")),p.push("-"),p.push(e("changeBrightness")),p.push(e("setBrightness")),p.push("-"),p.push(e("changeSize")),p.push(e("setSize")),p.push("-"),p.push(e("doStamp")),p.push(e("floodFill"))):"control"===d?(p.push(e("receiveGo")),p.push(e("receiveKey")),p.push(e("receiveInteraction")),p.push(e("receiveCondition")),p.push(e("receiveMessage")),p.push("-"),p.push(e("doBroadcast")),p.push(e("doBroadcastAndWait")),p.push(r("getLastMessage")),p.push(e("getLastMessage")),p.push("-"),p.push(e("doWarp")),p.push("-"),p.push(e("doWait")),p.push(e("doWaitUntil")),p.push("-"),p.push(e("doForever")),p.push(e("doRepeat")),p.push(e("doUntil")),p.push("-"),p.push(e("doIf")),p.push(e("doIfElse")),p.push("-"),p.push(e("doReport")),p.push("-"),p.push(e("doStopThis")),p.push(e("doStopOthers")),p.push("-"),p.push(e("doRun")),p.push(e("fork")),p.push(e("evaluate")),p.push("-"),p.push(e("doCallCC")),p.push(e("reportCallCC")),p.push("-"),p.push(e("receiveOnClone")),p.push(e("createClone")),p.push(e("removeClone")),p.push("-"),p.push(e("doPauseAll"))):"sensing"===d?(p.push(e("reportTouchingObject")),p.push(e("reportTouchingColor")),p.push(e("reportColorIsTouchingColor")),p.push("-"),p.push(e("doAsk")),p.push(r("getLastAnswer")),p.push(e("getLastAnswer")),p.push("-"),p.push(r("reportMouseX")),p.push(e("reportMouseX")),p.push(r("reportMouseY")),p.push(e("reportMouseY")),p.push(e("reportMouseDown")),p.push("-"),p.push(e("reportKeyPressed")),p.push("-"),p.push(e("reportDistanceTo")),p.push("-"),p.push(e("doResetTimer")),p.push(r("getTimer")),p.push(e("getTimer")),p.push("-"),p.push(e("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&p.push(e("reportGet")),p.push("-"),p.push(e("reportURL")),p.push("-"),p.push(e("reportIsFastTracking")),p.push(e("doSetFastTracking")),p.push("-"),p.push(e("reportDate")),this.world().isDevMode&&(p.push("-"),l=new TextMorph(localize("development mode \ndebugging primitives:")),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(r("reportThreadCount")),p.push(e("reportThreadCount")),p.push(e("colorFiltered")),p.push(e("reportStackSize")),p.push(e("reportFrameCount")))):"operators"===d?(p.push(e("reifyScript")),p.push(e("reifyReporter")),p.push(e("reifyPredicate")),p.push("#"),p.push("-"),p.push(e("reportSum")),p.push(e("reportDifference")),p.push(e("reportProduct")),p.push(e("reportQuotient")),p.push("-"),p.push(e("reportModulus")),p.push(e("reportRound")),p.push(e("reportMonadic")),p.push(e("reportRandom")),p.push("-"),p.push(e("reportLessThan")),p.push(e("reportEquals")),p.push(e("reportGreaterThan")),p.push("-"),p.push(e("reportAnd")),p.push(e("reportOr")),p.push(e("reportNot")),p.push(e("reportBoolean")),p.push("-"),p.push(e("reportJoinWords")),p.push(e("reportTextSplit")),p.push(e("reportLetter")),p.push(e("reportStringSize")),p.push("-"),p.push(e("reportUnicode")),p.push(e("reportUnicodeAsLetter")),p.push("-"),p.push(e("reportIsA")),p.push(e("reportIsIdentical")),p.push("-"),p.push(e("reportJSFunction")),this.world().isDevMode&&(p.push("-"),l=new TextMorph(localize("development mode \ndebugging primitives:")),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("reportTypeOf")),p.push(e("reportTextFunction")))):"variables"===d&&(h=new PushButtonMorph(null,function(){new VariableDialogMorph(null,s,c).prompt("Variable name",null,c.world())},"Make a variable"),h.userMenu=n,h.selector="addVariable",h.showHelp=BlockMorph.prototype.showHelp,p.push(h),this.deletableVariableNames().length>0&&(h=new PushButtonMorph(null,function(){var t=new MenuMorph(c.deleteVariable,null,c);c.deletableVariableNames().forEach(function(e){t.addItem(e,e)}),t.popUpAtHand(c.world())},"Delete a variable"),h.userMenu=n,h.selector="deleteVariable",h.showHelp=BlockMorph.prototype.showHelp,p.push(h)),p.push("-"),a=this.variables.allNames(),a.length>0&&(a.forEach(function(t){p.push(i(t)),p.push(o(t))}),p.push("-")),p.push(e("doSetVar")),p.push(e("doChangeVar")),p.push(e("doShowVar")),p.push(e("doHideVar")),p.push(e("doDeclareVariables")),StageMorph.prototype.enableInheritance&&(p.push("-"),p.push(e("doDeleteAttr"))),p.push("="),p.push(e("reportNewList")),p.push("-"),p.push(e("reportCONS")),p.push(e("reportListItem")),p.push(e("reportCDR")),p.push("-"),p.push(e("reportListLength")),p.push(e("reportListContainsItem")),p.push("-"),p.push(e("doAddToList")),p.push(e("doDeleteFromList")),p.push(e("doInsertInList")),p.push(e("doReplaceInList")),this.world().isDevMode&&(p.push("-"),l=new TextMorph(localize("development mode \ndebugging primitives:")),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("reportMap")),p.push("-"),p.push(e("doForEach")),p.push(e("doShowTable"))),p.push("="),StageMorph.prototype.enableCodeMapping&&(p.push(e("doMapCodeOrHeader")),p.push(e("doMapStringCode")),p.push(e("doMapListCode")),p.push("-"),p.push(e("reportMappedCode")),p.push("=")),h=new PushButtonMorph(null,function(){var t=c.parentThatIsA(IDE_Morph),e=c.parentThatIsA(StageMorph);new BlockDialogMorph(null,function(o){""!==o.spec&&(o.isGlobal?e.globalBlocks.push(o):c.customBlocks.push(o),t.flushPaletteCache(),t.refreshPalette(),new BlockEditorMorph(o,c).popUp())},c).prompt("Make a block",null,c.world())},"Make a block"),h.userMenu=n,h.selector="addCustomBlock",h.showHelp=BlockMorph.prototype.showHelp,p.push(h)),p},SpriteMorph.prototype.palette=function(t){return this.paletteCache[t]||(this.paletteCache[t]=this.freshPalette(t)),this.paletteCache[t]},SpriteMorph.prototype.freshPalette=function(t){var e,o=new ScrollFrameMorph(null,null,this.sliderColor),r=SyntaxElementMorph.prototype.fontSize,i=0,n=5,s=0,a=!1,h=this,l=this.parentThatIsA(StageMorph),p=Morph.prototype.trackChanges;return Morph.prototype.trackChanges=!1,o.owner=this,o.padding=r/2,o.color=this.paletteColor,o.growth=new Point(0,MorphicPreferences.scrollBarSize),o.userMenu=function(){function e(){var e=SpriteMorph.prototype.blocks,o=StageMorph.prototype.hiddenPrimitives;return Object.keys(o).some(function(o){return!isNil(e[o])&&(e[o].category===t||contains(s[t]||[],o))})}function r(){return o.contents.children.some(function(t){return contains(Object.keys(SpriteMorph.prototype.blocks),t.selector)})}var i=new MenuMorph,n=this.parentThatIsA(IDE_Morph),s={operators:["reifyScript","reifyReporter","reifyPredicate"],control:["doWarp"],variables:["doDeclareVariables","reportNewList","reportCONS","reportListItem","reportCDR","reportListLength","reportListContainsItem","doAddToList","doDeleteFromList","doInsertInList","doReplaceInList"]};return i.addItem("find blocks...",function(){h.searchBlocks()}),r()&&i.addItem("hide primitives",function(){var e=SpriteMorph.prototype.blocks;Object.keys(e).forEach(function(o){e[o].category===t&&(StageMorph.prototype.hiddenPrimitives[o]=!0)}),(s[t]||[]).forEach(function(t){StageMorph.prototype.hiddenPrimitives[t]=!0}),n.flushBlocksCache(t),n.refreshPalette()}),e()&&i.addItem("show primitives",function(){var e=StageMorph.prototype.hiddenPrimitives,o=SpriteMorph.prototype.blocks;Object.keys(e).forEach(function(e){o[e]&&o[e].category===t&&delete StageMorph.prototype.hiddenPrimitives[e]}),(s[t]||[]).forEach(function(t){delete StageMorph.prototype.hiddenPrimitives[t]}),n.flushBlocksCache(t),n.refreshPalette()}),i},e=this.blocksCache[t],e||(e=h.blockTemplates(t),this.isCachingPrimitives&&(h.blocksCache[t]=e)),e.forEach(function(t){if(null!==t)if("-"===t){if(a)return;n+=.8*r,a=!0}else if("="===t){if(a)return;n+=1.6*r,a=!0}else"#"===t?(i=0,n=s):(a=!1,0===i&&(n+=.3*r),t.setPosition(new Point(i,n)),o.addContents(t),t instanceof ToggleMorph||t instanceof RingMorph?(i=t.right()+r/2,s=t.bottom()):(i=0,n+=t.height()))}),l&&(n+=1.6*r,l.globalBlocks.forEach(function(e){var s;(e.category===t||"variables"===t&&contains(["lists","other"],e.category))&&(s=e.templateInstance(),n+=.3*r,s.setPosition(new Point(i,n)),o.addContents(s),i=0,n+=s.height())})),n+=1.6*r,this.customBlocks.forEach(function(e){var s;(e.category===t||"variables"===t&&contains(["lists","other"],e.category))&&(s=e.templateInstance(),n+=.3*r,s.setPosition(new Point(i,n)),o.addContents(s),i=0,n+=s.height())}),o.scrollX(o.padding),o.scrollY(o.padding),Morph.prototype.trackChanges=p,o},SpriteMorph.prototype.blocksMatching=function(t,e,o,r){function i(t){var e=BlockMorph.prototype.parseSpec(t),o=e.filter(function(t){return 0!==t.indexOf("%")});return o.join(" ")}function n(t,e,o){for(var r=String(t);r.length<e;)r=o+r;return r}function s(t,o){var r,i=" "+t,s=i.indexOf(o);return s===-1?-1:(r=" "===i.charAt(s-1),e&&!r?-1:(r?"1":"2")+n(s,4,"0"))}function a(t){var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}var h,l=[],p=this,c=t.toLowerCase(),d=this.parentThatIsA(StageMorph);return o&&o.length||(o=["hat","command","reporter","predicate","ring"]),r||(r=[]),r.forEach(function(t){var e=s(i(t.toLowerCase()),c);e!==-1&&l.push([p.variableBlock(t),e+"1"])}),[this.customBlocks,d.globalBlocks].forEach(function(t){t.forEach(function(t){if(contains(o,t.type)){var e=localize(t.blockSpec()).toLowerCase(),r=s(i(e),c);r!==-1&&l.push([t.templateInstance(),r+"2"])}})}),h=SpriteMorph.prototype.blocks,Object.keys(h).forEach(function(t){if(!StageMorph.prototype.hiddenPrimitives[t]&&contains(o,h[t].type)){var e=h[t],r=localize(e.alias||e.spec).toLowerCase(),n=s(i(r),c);n===-1||e.dev||e.only&&e.only!==p.constructor||l.push([a(t),n+"3"])}}),l.sort(function(t,e){return t[1]<e[1]?-1:1}),l.map(function(t){return t[0]})},SpriteMorph.prototype.searchBlocks=function(t,e,o,r){function i(){a&&a.destroy(),s&&r&&(a=s.outline(MorphicPreferences.isFlat?new Color(150,200,255):new Color(255,255,255),2),u.contents.add(a),a.scrollIntoView())}function n(t){var e=Morph.prototype.trackChanges,o=u.contents.left()+5,n=d.bottom()+l;g=t,s=null,t.length&&r&&(s=t[0]),Morph.prototype.trackChanges=!1,u.contents.children=[u.contents.children[0]],t.forEach(function(t){t.setPosition(new Point(o,n)),u.addContents(t),n+=t.height(),n+=.3*l}),Morph.prototype.trackChanges=e,i(),u.changed()}var s,a,h=this,l=SyntaxElementMorph.prototype.fontSize,p=this.parentThatIsA(IDE_Morph),c="",d=new InputFieldMorph(t||""),u=p.createPalette("forSearch"),g=[];u.owner=this,u.color=h.paletteColor,u.contents.color=h.paletteColor,u.addContents(d),d.drawNew(),d.setWidth(p.logo.width()-30),d.contrast=90,d.setPosition(u.contents.topLeft().add(new Point(10,10))),d.drawNew(),u.accept=function(){var t;r?(d.cancel(),s&&r.insertBlock(s)):(t=d.getValue(),t.length>0&&n(h.blocksMatching(t)))},u.reactToKeystroke=function(t){var a,l,p=t?t.keyCode:0;switch(p){case 38:if(!r||!s)return;return l=g.indexOf(s)-1,l<0&&(l=g.length-1),s=g[l],void i();case 40:if(!r||!s)return;return l=g.indexOf(s)+1,l>=g.length&&(l=0),s=g[l],void i();default:a=d.getValue(),a!==c&&(c=a,n(h.blocksMatching(a,a.length<2,e,o)))}},d.cancel=function(){p.refreshPalette(),p.palette.adjustScrollBars()},p.fixLayout("refreshPalette"),d.edit(),t&&u.reactToKeystroke()},SpriteMorph.prototype.addVariable=function(t,e){var o=this.parentThatIsA(IDE_Morph);e?(this.globalVariables().addVar(t),o&&o.flushBlocksCache("variables")):(this.variables.addVar(t),this.blocksCache.variables=null)},SpriteMorph.prototype.deleteVariable=function(t){var e=this.parentThatIsA(IDE_Morph);contains(this.inheritedVariableNames(!0),t)||this.deleteVariableWatcher(t),this.variables.deleteVar(t),e&&(e.flushBlocksCache("variables"),e.refreshPalette())},SpriteMorph.prototype.addCostume=function(t){t.name||(t.name="costume"+(this.costumes.length()+1)),this.costumes.add(t)},SpriteMorph.prototype.wearCostume=function(t){var e=this.xPosition?this.xPosition():null,o=this.yPosition?this.yPosition():null,r=this.isWarped;r&&this.endWarp(),this.changed(),this.costume=t,this.drawNew(),this.changed(),r&&this.startWarp(),null!==e&&this.silentGotoXY(e,o,!0),this.positionTalkBubble&&this.positionTalkBubble(),this.version=Date.now()},SpriteMorph.prototype.getCostumeIdx=function(){return this.costumes.asArray().indexOf(this.costume)+1},SpriteMorph.prototype.doWearNextCostume=function(){var t,e=this.costumes.asArray();e.length>1&&(t=e.indexOf(this.costume),t>-1&&(t+=1,t>e.length-1&&(t=0),this.wearCostume(e[t])))},SpriteMorph.prototype.doWearPreviousCostume=function(){var t,e=this.costumes.asArray();e.length>1&&(t=e.indexOf(this.costume),t>-1&&(t-=1,t<0&&(t=e.length-1),this.wearCostume(e[t])))},SpriteMorph.prototype.doSwitchToCostume=function(t){if(t instanceof Costume)return void this.wearCostume(t);var e,o,r=this.costumes.asArray();if(contains([localize("Turtle"),localize("Empty")],t instanceof Array?t[0]:null))o=null;else{if(t===-1)return void this.doWearPreviousCostume();o=detect(r,function(e){return e.name===t}),null===o&&(e=parseFloat(t),o=0===e?null:r[e-1]||null)}this.wearCostume(o)},SpriteMorph.prototype.reportCostumes=function(){return this.costumes},SpriteMorph.prototype.addSound=function(t,e){this.sounds.add(new Sound(t,e))},SpriteMorph.prototype.playSound=function(t){var e,o=this.parentThatIsA(StageMorph),r=detect(this.sounds.asArray(),function(e){return e.name===t});if(r)return e=r.play(),o&&(o.activeSounds.push(e),o.activeSounds=o.activeSounds.filter(function(t){return!t.ended&&!t.terminated})),e},SpriteMorph.prototype.reportSounds=function(){return this.sounds},SpriteMorph.prototype.userMenu=function(){var t=this.parentThatIsA(IDE_Morph),e=new MenuMorph(this);return t&&t.isAppMode?e:(this.isClone||e.addItem("duplicate","duplicate"),e.addItem("delete","remove"),e.addItem("move","moveCenter"),this.isClone||e.addItem("edit","edit"),e.addLine(),this.anchor&&e.addItem(localize("detach from")+" "+this.anchor.name,"detachFromAnchor"),this.parts.length&&e.addItem("detach all parts","detachAllParts"),e.addItem("export...","exportSprite"),e)},SpriteMorph.prototype.exportSprite=function(){if(!this.isClone){var t=this.parentThatIsA(IDE_Morph);t&&t.exportSprite(this)}},SpriteMorph.prototype.edit=function(){var t=this.parentThatIsA(IDE_Morph);t&&!t.isAppMode&&t.selectSprite(this)},SpriteMorph.prototype.showOnStage=function(){var t=this.parentThatIsA(StageMorph);t&&(this.keepWithin(t),t.add(this)),this.show()},SpriteMorph.prototype.duplicate=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.duplicateSprite(this)},SpriteMorph.prototype.remove=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.removeSprite(this)},SpriteMorph.prototype.createClone=function(t){var e=this.parentThatIsA(StageMorph);e&&e.cloneCount<=2e3&&this.fullCopy(!0).clonify(e,t)},SpriteMorph.prototype.clonify=function(t,e){var o;this.parts.forEach(function(e){e.clonify(t)}),t.cloneCount+=1,this.cloneOriginName=this.isClone?this.cloneOriginName:this.name,this.isClone=!0,this.name="",t.add(this),o=this.allHatBlocksFor("__clone__init__"),o.forEach(function(o){t.threads.startProcess(o,t.isThreadSafe,null,null,null,e)}),this.endWarp()},SpriteMorph.prototype.removeClone=function(){this.isClone&&(this.parent.threads.stopAllForReceiver(this),this.corpsify(),this.destroy(),this.parent.cloneCount-=1)},SpriteMorph.prototype.corpsify=function(){this.isCorpse=!0,this.version=Date.now()},SpriteMorph.prototype.hide=function(){SpriteMorph.uber.hide.call(this),this.parts.forEach(function(t){t.hide()})},SpriteMorph.prototype.show=function(){SpriteMorph.uber.show.call(this),this.parts.forEach(function(t){t.show()})},SpriteMorph.prototype.setColor=function(t){var e=this.xPosition(),o=this.yPosition();this.color.eq(t)||(this.color=t.copy(),this.drawNew(),this.gotoXY(e,o))},SpriteMorph.prototype.getHue=function(){return 100*this.color.hsv()[0]},SpriteMorph.prototype.setHue=function(t){var e=this.color.hsv(),o=this.xPosition(),r=this.yPosition();e[0]=Math.max(Math.min(+t||0,100),0)/100,e[1]=1,this.color.set_hsv.apply(this.color,e),this.costume||(this.drawNew(),this.changed()),this.gotoXY(o,r)},SpriteMorph.prototype.changeHue=function(t){this.setHue(this.getHue()+(+t||0))},SpriteMorph.prototype.getBrightness=function(){return 100*this.color.hsv()[2]},SpriteMorph.prototype.setBrightness=function(t){var e=this.color.hsv(),o=this.xPosition(),r=this.yPosition();e[1]=1,e[2]=Math.max(Math.min(+t||0,100),0)/100,this.color.set_hsv.apply(this.color,e),this.costume||(this.drawNew(),this.changed()),this.gotoXY(o,r)},SpriteMorph.prototype.changeBrightness=function(t){this.setBrightness(this.getBrightness()+(+t||0))},SpriteMorph.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())},SpriteMorph.prototype.goBack=function(t){var e,o=+t||0;return this.parent?(e=this.parent.children.indexOf(this),e<o?null:(this.parent.removeChild(this),this.parent.children.splice(e-o,null,this),void this.parent.changed())):null},SpriteMorph.prototype.overlappingImage=function(t){var e=this.bounds.intersect(t.bounds),o=newCanvas(e.extent(),!0),r=o.getContext("2d");return e.width()<1||e.height()<1?newCanvas(new Point(1,1),!0):(r.drawImage(this.image,this.left()-e.left(),this.top()-e.top()),r.globalCompositeOperation="source-in",r.drawImage(t.image,t.left()-e.left(),t.top()-e.top()),o)},SpriteMorph.prototype.doStamp=function(){var t=this.parent,e=t.penTrails().getContext("2d"),o=this.isWarped;o&&this.endWarp(),e.save(),e.scale(1/t.scale,1/t.scale),e.drawImage(this.image,this.left()-t.left(),this.top()-t.top()),e.restore(),this.changed(),o&&this.startWarp()},SpriteMorph.prototype.clear=function(){this.parent.clearPenTrails()},SpriteMorph.prototype.setSize=function(t){isNaN(t)||(this.size=Math.min(Math.max(+t,1e-4),1e3))},SpriteMorph.prototype.changeSize=function(t){this.setSize(this.size+(+t||0))},SpriteMorph.prototype.getScale=function(){return 100*this.scale},SpriteMorph.prototype.setScale=function(t){var e,o,r=this.xPosition(),i=this.yPosition(),n=this.isWarped;n&&this.endWarp(),e=(+t||0)/100,o=e/this.nestingScale,this.nestingScale=e,this.scale=Math.max(e,.01),this.changed(),this.drawNew(),this.changed(),n&&this.startWarp(),this.silentGotoXY(r,i,!0),this.positionTalkBubble(),this.parts.forEach(function(t){var e=t.xPosition()-r,n=t.yPosition()-i;t.setScale(100*t.scale*o),t.silentGotoXY(r+e*o,i+n*o)})},SpriteMorph.prototype.changeScale=function(t){this.setScale(this.getScale()+(+t||0))},SpriteMorph.prototype.graphicsChanged=function(){var t=this;return Object.keys(this.graphicsValues).some(function(e){return t.graphicsValues[e]<0||t.graphicsValues[e]>0})},SpriteMorph.prototype.applyGraphicsEffects=function(t){function e(t,e){var o,r,i,n,s,a,h,l,c,d,u,g,f,m,y,M,b;for(a=t.width,h=t.height,o=t.data,r=p.createImageData(a,h),i=r.data,n=a/2,s=h/2,e=Math.max(0,(e+100)/100),c=0;c<h;c++)for(l=0;l<a;l++)d=(l-n)/n,u=(c-s)/s,g=Math.pow(Math.sqrt(d*d+u*u),e),g<=1?(f=Math.atan2(u,d),m=Math.floor(n+g*Math.cos(f)*n),y=Math.floor(s+g*Math.sin(f)*s)):(m=l,y=c),M=4*(c*a+l),b=4*(y*a+m),i[M]=o[b],i[M+1]=o[b+1],i[M+2]=o[b+2],i[M+3]=o[b+3];return r}function o(t,e){var o,r,i,n,s,a,h,l,c,d,u,g,f,m,y,M,b,w,S,C,v,x,k,B,P;for(n=t.width,s=t.height,o=t.data,r=p.createImageData(n,s),i=r.data,a=n/2,h=s/2,d=Math.min(a,h),n<s?(u=s/n,g=1):(u=1,g=n/s),f=-radians(e),m=d*d,c=0;c<s;c++)for(l=0;l<n;l++)y=u*(l-a),M=g*(c-h),b=y*y+M*M,b<m?(w=1-Math.sqrt(b)/d,S=f*(w*w),B=Math.sin(S),P=Math.cos(S),C=Math.floor((P*y-B*M)/u+a),v=Math.floor((B*y+P*M)/g+h)):(C=l,v=c),x=4*(c*n+l),k=4*(v*n+C),i[x]=o[k],i[x+1]=o[k+1],i[x+2]=o[k+2],i[x+3]=o[k+3];return r}function r(t,e){var o,r,i,n,s,a,h,l,c,d,u;for(n=t.width,s=t.height,o=t.data,r=p.createImageData(n,s),i=r.data,e=Math.floor(Math.abs(e/10)+1),h=0;h<s;h++)for(a=0;a<n;a++)l=Math.floor(a/e)*e,c=Math.floor(h/e)*e,d=4*(h*n+a),u=4*(c*n+l),i[d]=o[u],i[d+1]=o[u+1],i[d+2]=o[u+2],i[d+3]=o[u+3];return r}function i(t,e){var o,r,i,n,s,a;for(o=t.data,n=p.createImageData(t.width,t.height),s=n.data,e=Math.round((Math.abs(e)+10)/10),e=Math.max(0,Math.min(e,Math.min(t.width,t.height))),r=0,i=o.length;r<i;r+=4)a=r*e%i,s[r]=o[a],s[r+1]=o[a+1],s[r+2]=o[a+2],s[r+3]=o[a+3];return n}function n(t,e){var o,r;for(o=t.data,r=0;r<o.length;r+=4)o[r]=o[r*e],o[r+1]=o[r*e+1],o[r+2]=o[r*e+2],o[r+3]=o[r*e+3];return t}function s(t,e,o,r){var i,n,s,a,h,l,p,c,d,u,g,f,m,y,M,b,w,S,C,v;for(i=t.data,n=0,s=i.length;n<s;n+=4)a=i[n],h=i[n+1],l=i[n+2],p=Math.max(a,h,l),c=Math.min(a,h,l),d=p-c,0===d?u=g=0:(p===a?u=60*(h-l)/d:p===h?u=120+60*(l-a)/d:p===l&&(u=240+60*(a-h)/d),g=(p-c)/p),u<0&&(u+=360),f=p/255,u=(u+360*e/200)%360,g=Math.max(0,Math.min(g+o/100,1)),f=Math.max(0,Math.min(f+r/100,1)),m=Math.floor(u/60),y=u/60-m,M=f*(1-g),b=f*(1-g*y),w=f*(1-g*(1-y)),0===m||6===m?(S=f,C=w,v=M):1===m?(S=b,C=f,v=M):2===m?(S=M,C=f,v=w):3===m?(S=M,C=b,v=f):4===m?(S=w,C=M,v=f):5===m&&(S=f,C=M,v=b),i[n]=255*S,i[n+1]=255*C,i[n+2]=255*v;return t}function a(t,e){var o,r,i,n,s,a;for(o=t.data,r=0,i=o.length;r<i;r+=4)n=255-o[r],s=255-o[r+1],a=255-o[r+2],o[r]<n?o[r]+=e:o[r]>n&&(o[r]-=e),o[r+1]<s?o[r+1]+=e:o[r+1]>s&&(o[r+1]-=e),o[r+2]<a?o[r+2]+=e:o[r+2]>a&&(o[r+2]-=e);return t}function h(t,e){var o,r,i;for(o=t.data,r=0,i=o.length;r<i;r+=4)o[r]+=127*Math.sin(r*e)+128,o[r+1]+=127*Math.sin(r*e)+128,o[r+2]+=127*Math.sin(r*e)+128;return t}function l(t,e){var o,r,i;for(o=t.data,r=0,i=o.length;r<i;r+=1)o[r]=127*Math.sin(e*o[r])+o[r];return t}var p,c;return this.graphicsChanged()&&(p=t.getContext("2d"),c=p.getImageData(0,0,t.width,t.height),this.graphicsValues.fisheye&&(c=e(c,this.graphicsValues.fisheye)),this.graphicsValues.whirl&&(c=o(c,this.graphicsValues.whirl)),this.graphicsValues.pixelate&&(c=r(c,this.graphicsValues.pixelate)),this.graphicsValues.mosaic&&(c=i(c,this.graphicsValues.mosaic)),this.graphicsValues.duplicate&&(c=n(c,this.graphicsValues.duplicate)),(this.graphicsValues.color||this.graphicsValues.saturation||this.graphicsValues.brightness)&&(c=s(c,this.graphicsValues.color,this.graphicsValues.saturation,this.graphicsValues.brightness)),this.graphicsValues.negative&&(c=a(c,this.graphicsValues.negative)),this.graphicsValues.comic&&(c=h(c,this.graphicsValues.comic)),this.graphicsValues.confetti&&(c=l(c,this.graphicsValues.confetti)),p.putImageData(c,0,0)),
t},SpriteMorph.prototype.setEffect=function(t,e){var o=t instanceof Array?t[0]:null;"ghost"===o?this.alpha=1-Math.min(Math.max(+e||0,0),100)/100:this.graphicsValues[o]=+e,this.drawNew(),this.changed()},SpriteMorph.prototype.getGhostEffect=function(){return 100*(1-this.alpha)},SpriteMorph.prototype.changeEffect=function(t,e){var o=t instanceof Array?t[0]:null;"ghost"===o?this.setEffect(t,this.getGhostEffect()+(+e||0)):this.setEffect(t,+this.graphicsValues[o]+ +e)},SpriteMorph.prototype.clearEffects=function(){var t;for(t in this.graphicsValues)this.graphicsValues.hasOwnProperty(t)&&this.setEffect([t],0);this.setEffect(["ghost"],0)},SpriteMorph.prototype.stopTalking=function(){var t=this.talkBubble();t&&t.destroy()},SpriteMorph.prototype.doThink=function(t){this.bubble(t,!0)},SpriteMorph.prototype.bubble=function(t,e,o){var r,i=this.parentThatIsA(StageMorph);this.stopTalking(),""===t||isNil(t)||(r=new SpriteBubbleMorph(t,i,e,o),this.add(r),this.positionTalkBubble())},SpriteMorph.prototype.talkBubble=function(){return detect(this.children,function(t){return t instanceof SpeechBubbleMorph})},SpriteMorph.prototype.positionTalkBubble=function(){var t=this.parentThatIsA(StageMorph),e=t?t.scale:1,o=this.talkBubble(),r=this.center().y;if(!o)return null;for(o.show(),o.isPointingRight||(o.isPointingRight=!0,o.drawNew(),o.changed()),o.setLeft(this.right()),o.setBottom(this.top());!this.isTouching(o)&&o.bottom()<r;)o.silentMoveBy(new Point(-1,1).scaleBy(e));return t?(o.right()>t.right()&&(o.isPointingRight=!1,o.drawNew(),o.setRight(this.center().x)),o.keepWithin(t),void o.changed()):null},SpriteMorph.prototype.prepareToBeGrabbed=function(t){this.removeShadow(),this.recordLayers(),!this.bounds.containsPoint(t.position())&&this.isCorrectingOutsideDrag()&&this.setCenter(t.position()),this.addShadow()},SpriteMorph.prototype.isCorrectingOutsideDrag=function(){return!this.parts.length},SpriteMorph.prototype.justDropped=function(){var t=this.parentThatIsA(StageMorph);t&&(t.enableCustomHatBlocks=!0),this.restoreLayers(),this.positionTalkBubble(),this.receiveUserInteraction("dropped")},SpriteMorph.prototype.drawLine=function(t,e){var o=this.parent.bounds.origin,r=this.parent.scale,i=this.parent.penTrails().getContext("2d"),n=t.subtract(o).divideBy(r),s=e.subtract(o).divideBy(r),a=n.multiplyBy(r).add(o),h=s.multiplyBy(r).add(o),l=a.rectangle(h).expandBy(Math.max(this.size*r/2,1)).intersect(this.parent.visibleBounds()).spread();this.isDown&&(i.lineWidth=this.size,i.strokeStyle=this.color.toString(),this.useFlatLineEnds?(i.lineCap="butt",i.lineJoin="miter"):(i.lineCap="round",i.lineJoin="round"),i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(s.x,s.y),i.stroke(),this.isWarped===!1&&this.world().broken.push(l))},SpriteMorph.prototype.floodFill=function(){function t(t){var e=4*t;return[l[e],l[e+1],l[e+2],l[e+3]]}function e(t){return t[0]===r[0]&&t[1]===r[1]&&t[2]===r[2]&&t[3]===r[3]}if(this.parent.bounds.containsPoint(this.rotationCenter())){var o,r,i=normalizeCanvas(this.parent.penTrails()),n=i.width,s=i.height,a=i.getContext("2d"),h=a.getImageData(0,0,n,s),l=h.data,p=[(s/2-Math.round(this.yPosition()))*n+Math.round(this.xPosition()+n/2)];if(r=t(p[0]),r[0]!==Math.round(this.color.r)||r[1]!==Math.round(this.color.g)||r[2]!==Math.round(this.color.b)||r[3]!==Math.round(255*this.color.a)){for(;p.length>0;)o=p.pop(),e(t(o))&&(o%n>1&&(p.push(o+1),p.push(o-1)),o>0&&o<s*n&&(p.push(o+n),p.push(o-n))),l[4*o]=Math.round(this.color.r),l[4*o+1]=Math.round(this.color.g),l[4*o+2]=Math.round(this.color.b),l[4*o+3]=Math.round(255*this.color.a);a.putImageData(h,0,0),this.parent.changed()}}},SpriteMorph.prototype.moveBy=function(t,e){var o=this.isDown&&!e&&this.parent?this.rotationCenter():null;SpriteMorph.uber.moveBy.call(this,t),o&&this.drawLine(o,this.rotationCenter()),e||this.parts.forEach(function(e){e.moveBy(t)})},SpriteMorph.prototype.silentMoveBy=function(t,e){SpriteMorph.uber.silentMoveBy.call(this,t),!e&&this.parent instanceof HandMorph&&this.parts.forEach(function(e){e.moveBy(t)})},SpriteMorph.prototype.rootForGrab=function(){return this.anchor?this.anchor.rootForGrab():SpriteMorph.uber.rootForGrab.call(this)},SpriteMorph.prototype.slideBackTo=function(t,e){var o=e||5,r=t.origin.position().add(t.position),i=-(this.left()-r.x)/o,n=-(this.top()-r.y)/o,s=0,a=this.step,h=this.fps,l=this;this.fps=0,this.step=function(){l.moveBy(new Point(i,n)),s+=1,s===o&&(t.origin.add(l),t.origin.reactToDropOf&&t.origin.reactToDropOf(l),l.step=a,l.fps=h)}},SpriteMorph.prototype.setCenter=function(t,e){var o=t.subtract(this.center());this.moveBy(o,e)},SpriteMorph.prototype.nestingBounds=function(){var t=this.bounds;return!this.costume&&this.penBounds&&(t=this.penBounds.translateBy(this.position())),this.parts.forEach(function(e){e.isVisible&&(t=t.merge(e.nestingBounds()))}),t},SpriteMorph.prototype.setPosition=function(t,e){var o=t.subtract(this.topLeft());0===o.x&&0===o.y||this.moveBy(o,e)},SpriteMorph.prototype.forward=function(t){var e,o=t*this.parent.scale||0;e=o>=0?this.position().distanceAngle(o,this.heading):this.position().distanceAngle(Math.abs(o),this.heading-180),this.setPosition(e),this.positionTalkBubble()},SpriteMorph.prototype.setHeading=function(t){var e=this.xPosition(),o=this.yPosition(),r=+t||0,i=r-this.heading;this.rotationStyle?(this.changed(),SpriteMorph.uber.setHeading.call(this,r),this.silentGotoXY(e,o,!0),this.positionTalkBubble()):this.heading=parseFloat(t)%360,this.parts.forEach(function(t){var r=new Point(t.xPosition(),t.yPosition()),n=r.rotateBy(radians(i),new Point(e,o));t.rotatesWithAnchor&&t.turn(i),t.gotoXY(n.x,n.y)})},SpriteMorph.prototype.faceToXY=function(t,e){var o=(t-this.xPosition())*this.parent.scale,r=(e-this.yPosition())*this.parent.scale,i=Math.abs(o)<.001?r<0?90:270:Math.round((o>=0?0:180)-57.2957795131*Math.atan(r/o));this.setHeading(i+90)},SpriteMorph.prototype.turn=function(t){this.setHeading(this.heading+(+t||0))},SpriteMorph.prototype.turnLeft=function(t){this.setHeading(this.heading-(+t||0))},SpriteMorph.prototype.xPosition=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.rotationCenter().x-t.center().x)/t.scale:this.rotationCenter().x},SpriteMorph.prototype.yPosition=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.rotationCenter().y)/t.scale:this.rotationCenter().y},SpriteMorph.prototype.direction=function(){return this.heading},SpriteMorph.prototype.penSize=function(){return this.size},SpriteMorph.prototype.gotoXY=function(t,e,o){var r,i,n,s=this.parentThatIsA(StageMorph);s&&(r=s.center().x+(+t||0)*s.scale,i=s.center().y-(+e||0)*s.scale,n=this.costume?new Point(r,i).subtract(this.rotationOffset):new Point(r,i).subtract(this.extent().divideBy(2)),this.setPosition(n,o),this.positionTalkBubble())},SpriteMorph.prototype.silentGotoXY=function(t,e,o){var r=this.isDown;this.isDown=!1,this.gotoXY(t,e,o),this.isDown=r},SpriteMorph.prototype.setXPosition=function(t){this.gotoXY(+t||0,this.yPosition())},SpriteMorph.prototype.changeXPosition=function(t){this.setXPosition(this.xPosition()+(+t||0))},SpriteMorph.prototype.setYPosition=function(t){this.gotoXY(this.xPosition(),+t||0)},SpriteMorph.prototype.changeYPosition=function(t){this.setYPosition(this.yPosition()+(+t||0))},SpriteMorph.prototype.glide=function(t,e,o,r,i){var n,s,a;s=new Point(e,o),n=Math.max(Math.min(r/t,1),0),a=i.add(s.subtract(i).multiplyBy(n)),this.gotoXY(a.x,a.y)},SpriteMorph.prototype.bounceOffEdge=function(){var t,e,o=this.parentThatIsA(StageMorph),r=this.nestingBounds();return o?o.bounds.containsRectangle(r)?null:(t=Math.cos(radians(this.heading-90)),e=-Math.sin(radians(this.heading-90)),r.left()<o.left()&&(t=Math.abs(t)),r.right()>o.right()&&(t=-Math.abs(t)),r.top()<o.top()&&(e=-Math.abs(e)),r.bottom()>o.bottom()&&(e=Math.abs(e)),this.setHeading(degrees(Math.atan2(-e,t))+90),this.setPosition(this.position().add(r.amountToTranslateWithin(o.bounds))),void this.positionTalkBubble()):null},SpriteMorph.prototype.setRotationX=function(t){this.setRotationCenter(new Point(t,this.yPosition()))},SpriteMorph.prototype.setRotationY=function(t){this.setRotationCenter(new Point(this.xPosition(),t))},SpriteMorph.prototype.setRotationCenter=function(t){var e,o;if(!this.costume)throw new Error("setting the rotation center requires a costume");e=t.subtract(new Point(this.xPosition(),this.yPosition())).divideBy(this.scale).rotateBy(radians(90-this.heading)),o=this.costume.rotationCenter.add(new Point(e.x,-e.y)),this.costume.rotationCenter=o,this.drawNew()},SpriteMorph.prototype.xCenter=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.center().x-t.center().x)/t.scale:this.center().x},SpriteMorph.prototype.yCenter=function(){var t=this.parentThatIsA(StageMorph);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.center().y)/t.scale:this.center().y},SpriteMorph.prototype.allMessageNames=function(){var t=[];return this.scripts.allChildren().forEach(function(e){var o;e.selector&&contains(["receiveMessage","doBroadcast","doBroadcastAndWait"],e.selector)&&(o=e.inputs()[0].evaluate(),isString(o)&&""!==o&&(contains(t,o)||t.push(o)))}),t},SpriteMorph.prototype.allHatBlocksFor=function(t){return"number"==typeof t&&(t=t.toString()),this.scripts.children.filter(function(e){var o;if(e.selector){if("receiveMessage"===e.selector)return o=e.inputs()[0].evaluate(),o===t||o instanceof Array&&"__shout__go__"!==t&&"__clone__init__"!==t;if("receiveGo"===e.selector)return"__shout__go__"===t;if("receiveOnClone"===e.selector)return"__clone__init__"===t}return!1})},SpriteMorph.prototype.allHatBlocksForKey=function(t){return this.scripts.children.filter(function(e){if(e.selector&&"receiveKey"===e.selector){var o=e.inputs()[0].evaluate()[0];return o===t||"any key"===o}return!1})},SpriteMorph.prototype.allHatBlocksForInteraction=function(t){return this.scripts.children.filter(function(e){return!(!e.selector||"receiveInteraction"!==e.selector)&&e.inputs()[0].evaluate()[0]===t})},SpriteMorph.prototype.allGenericHatBlocks=function(){return this.scripts.children.filter(function(t){return!!t.selector&&"receiveCondition"===t.selector})},SpriteMorph.prototype.mouseClickLeft=function(){return this.receiveUserInteraction("clicked")},SpriteMorph.prototype.mouseEnter=function(){return this.receiveUserInteraction("mouse-entered")},SpriteMorph.prototype.mouseDownLeft=function(){return this.receiveUserInteraction("pressed")},SpriteMorph.prototype.receiveUserInteraction=function(t){var e,o=this.parentThatIsA(StageMorph),r=[];if(o)return e=this.allHatBlocksForInteraction(t),e.forEach(function(t){r.push(o.threads.startProcess(t,o.isThreadSafe))}),r},SpriteMorph.prototype.mouseDoubleClick=function(){this.isClone||this.edit()},SpriteMorph.prototype.getTimer=function(){var t=this.parentThatIsA(StageMorph);return t?t.getTimer():0},SpriteMorph.prototype.getTempo=function(){var t=this.parentThatIsA(StageMorph);return t?t.getTempo():0},SpriteMorph.prototype.getLastMessage=function(){var t=this.parentThatIsA(StageMorph);return t?t.getLastMessage():""},SpriteMorph.prototype.getLastAnswer=function(){return this.parentThatIsA(StageMorph).lastAnswer},SpriteMorph.prototype.reportMouseX=function(){var t=this.parentThatIsA(StageMorph);return t?t.reportMouseX():0},SpriteMorph.prototype.reportMouseY=function(){var t=this.parentThatIsA(StageMorph);return t?t.reportMouseY():0},SpriteMorph.prototype.reportThreadCount=function(){var t=this.parentThatIsA(StageMorph);return t?t.threads.processes.length:0},SpriteMorph.prototype.findVariableWatcher=function(t){var e=this.parentThatIsA(StageMorph),o=this.globalVariables(),r=this;return null===e?null:detect(e.children,function(e){return e instanceof WatcherMorph&&(e.target===r.variables||e.target===o)&&e.getter===t})},SpriteMorph.prototype.toggleVariableWatcher=function(t,e){var o,r,i=this.parentThatIsA(StageMorph),n=this.globalVariables();return null===i?null:(o=this.findVariableWatcher(t),null!==o?void(o.isVisible?o.hide():(o.show(),o.fixLayout(),o.keepWithin(i))):(isNil(e)&&(e=contains(n.names(),t)),o=new WatcherMorph(t,this.blockColor.variables,e?n:this.variables,t),o.setPosition(i.position().add(10)),r=i.watchers(o.left()),r.length>0&&o.setTop(r[r.length-1].bottom()),i.add(o),o.fixLayout(),void o.keepWithin(i)))},SpriteMorph.prototype.showingVariableWatcher=function(t){var e,o=this.parentThatIsA(StageMorph);return null!==o&&(e=this.findVariableWatcher(t),!!e&&e.isVisible)},SpriteMorph.prototype.deleteVariableWatcher=function(t){var e,o=this.parentThatIsA(StageMorph);return null===o?null:(e=this.findVariableWatcher(t),void(null!==e&&e.destroy()))},SpriteMorph.prototype.toggleWatcher=function(t,e,o){var r,i,n=this.parentThatIsA(StageMorph);if(n){if(r=this.watcherFor(n,t))return void(r.isVisible?r.hide():(r.show(),r.fixLayout(),r.keepWithin(n)));r=new WatcherMorph(e,o,WatcherMorph.prototype.isGlobal(t)?n:this,t),r.setPosition(n.position().add(10)),i=n.watchers(r.left()),i.length>0&&r.setTop(i[i.length-1].bottom()),n.add(r),r.fixLayout(),r.keepWithin(n)}},SpriteMorph.prototype.showingWatcher=function(t){var e,o=this.parentThatIsA(StageMorph);return null!==o&&(e=this.watcherFor(o,t),!!e&&e.isVisible)},SpriteMorph.prototype.watcherFor=function(t,e){var o=this;return detect(t.children,function(r){return r instanceof WatcherMorph&&r.getter===e&&r.target===(r.isGlobal(e)?t:o)})},SpriteMorph.prototype.deleteAllBlockInstances=function(t){this.allBlockInstances(t).forEach(function(t){t.deleteBlock()}),this.customBlocks.forEach(function(t){t.body&&t.body.expression.isCorpse&&(t.body=null)})},SpriteMorph.prototype.allBlockInstances=function(t){var e,o,r,i=[];return t.isGlobal?(e=this.parentThatIsA(StageMorph),o=e.children.filter(function(t){return t instanceof SpriteMorph}),o.push(e),o.forEach(function(e){i=i.concat(e.allLocalBlockInstances(t))}),r=[],e.globalBlocks.forEach(function(e){e.body&&e.body.expression.allChildren().forEach(function(e){e.definition&&e.definition===t&&r.push(e)})}),i.concat(r)):this.allLocalBlockInstances(t)},SpriteMorph.prototype.allLocalBlockInstances=function(t){var e,o,r,i,n;return e=this.scripts.allChildren().filter(function(e){return e.definition&&e.definition===t}),o=[],this.customBlocks.forEach(function(e){e.body&&e.body.expression.allChildren().forEach(function(e){e.definition&&e.definition===t&&o.push(e)})}),r=this.allEditorBlockInstances(t),i=this.paletteBlockInstance(t),n=e.concat(o).concat(r),i&&n.push(i),n},SpriteMorph.prototype.allEditorBlockInstances=function(t){var e=[],o=this.world();return o?(this.world().children.forEach(function(o){o instanceof BlockEditorMorph&&o.body.contents.allChildren().forEach(function(o){o.isPrototype||o instanceof PrototypeHatBlockMorph||o.definition!==t||e.push(o)})}),e):[]},SpriteMorph.prototype.paletteBlockInstance=function(t){var e=this.parentThatIsA(IDE_Morph);return e?detect(e.palette.contents.children,function(e){return e.definition===t}):null},SpriteMorph.prototype.usesBlockInstance=function(t,e,o,r){var i,n=detect(this.scripts.allChildren(),function(e){return e.definition&&e.definition===t});return!!n||(!!(t.isGlobal&&!o&&(i=[],this.parentThatIsA(StageMorph).globalBlocks.forEach(function(o){e&&t===o||r&&contains(r,o)||o.body&&o.body.expression.allChildren().forEach(function(e){e.definition&&e.definition===t&&i.push(e)})}),i.length>0))||(i=[],this.customBlocks.forEach(function(e){e.body&&e.body.expression.allChildren().forEach(function(e){e.definition&&e.definition===t&&i.push(e)})}),i.length>0))},SpriteMorph.prototype.doubleDefinitionsFor=function(t){var e,o,r,i=t.blockSpec();if(t.isGlobal){if(r=this.parentThatIsA(StageMorph),!r)return[];e=r.globalBlocks}else e=this.customBlocks;return o=e.indexOf(t),o===-1?[]:e.filter(function(t,e){return t.blockSpec()===i&&e!==o})},SpriteMorph.prototype.replaceDoubleDefinitionsFor=function(t){var e,o,r=this.doubleDefinitionsFor(t),i=this;r.forEach(function(e){i.allBlockInstances(e).forEach(function(e){e.definition=t,e.refresh()})}),t.isGlobal?(e=this.parentThatIsA(StageMorph),e.globalBlocks=e.globalBlocks.filter(function(t){return!contains(r,t)})):this.customBlocks=this.customBlocks.filter(function(t){return!contains(r,t)}),o=this.parentThatIsA(IDE_Morph),o&&(o.flushPaletteCache(),o.refreshPalette())},SpriteMorph.prototype.chooseExemplar=function(){var t,e=this.parentThatIsA(StageMorph),o=this,r=e.children.filter(function(t){return t instanceof SpriteMorph&&!contains(t.allExemplars(),o)});t=new MenuMorph(function(t){o.setExemplar(t)},localize("current parent")+":\n"+(this.exemplar?this.exemplar.name:localize("none"))),r.forEach(function(e){t.addItem(e.name,e)}),t.addLine(),t.addItem(localize("none"),null),t.popUpAtHand(this.world())},SpriteMorph.prototype.setExemplar=function(t){var e=this.parentThatIsA(IDE_Morph);this.exemplar=t,isNil(t)?this.variables.parentFrame=this.globalVariables():this.variables.parentFrame=t.variables,e&&(e.flushBlocksCache("variables"),e.refreshPalette())},SpriteMorph.prototype.allExemplars=function(){for(var t=[],e=this;!isNil(e);)t.push(e),e=e.exemplar;return t},SpriteMorph.prototype.specimens=function(){var t=this;return this.siblings().filter(function(e){return e instanceof SpriteMorph&&e.exemplar===t})},SpriteMorph.prototype.allSpecimens=function(){var t=this;return this.siblings().filter(function(e){return e instanceof SpriteMorph&&contains(e.allExemplars(),t)})},SpriteMorph.prototype.isVariableNameInUse=function(t,e){return e?contains(this.variables.allNames(),t):!!contains(this.variables.names(),t)||contains(this.globalVariables().names(),t)},SpriteMorph.prototype.globalVariables=function(){for(var t=this.variables.parentFrame;t.owner;)t=t.parentFrame;return t},SpriteMorph.prototype.shadowVar=function(t,e){var o=this.parentThatIsA(IDE_Morph);this.variables.addVar(t,e),o&&(o.flushBlocksCache("variables"),o.refreshPalette())},SpriteMorph.prototype.inheritedVariableNames=function(t){function e(e){return t?contains(r,e):!contains(r,e)}for(var o=[],r=this.variables.names(),i=this.variables.parentFrame;i.owner instanceof SpriteMorph;)o.push.apply(o,i.names().filter(e)),i=i.parentFrame;return o},SpriteMorph.prototype.deletableVariableNames=function(){var t=this.variables.names(),e=this.inheritedVariableNames();return t.concat(this.globalVariables().names().filter(function(o){return!contains(t,o)&&!contains(e,o)}))},SpriteMorph.prototype.thumbnail=function(t){function e(e,o,r){var i=Math.min(t.x,t.y)/10;a.strokeStyle=e,a.globalAlpha=o,a.compositeOperation="lighter",a.lineWidth=r||1,a.moveTo(i,i),a.lineTo(s.width-i,s.height-i),a.moveTo(i,s.height-i),a.lineTo(s.width-i,i),a.stroke()}var o=this.image,r=Math.min(t.x/o.width,t.y/o.height),i=(t.x-o.width*r)/2,n=(t.y-o.height*r)/2,s=newCanvas(t),a=s.getContext("2d");return a.save(),this.isCorpse&&(a.globalAlpha=.3),o.width&&o.height&&(a.scale(r,r),a.drawImage(o,Math.floor(i/r),Math.floor(n/r))),this.isCorpse&&(a.restore(),e("white",.8,6),e("black",.8,1)),s},SpriteMorph.prototype.fullThumbnail=function(t){var e=this.thumbnail(t),o=e.getContext("2d"),r=t.divideBy(3),i=0;for(o.restore(),this.anchor&&o.drawImage(this.anchor.thumbnail(r),0,0),i=0;i<3;i+=1)this.parts[i]&&o.drawImage(this.parts[i].thumbnail(r),i*r.x,t.y-r.y);return e},SpriteMorph.prototype.booleanMorph=function(t){var e=new BooleanSlotMorph(t);return e.isStatic=!0,e.drawNew(),e},SpriteMorph.prototype.attachPart=function(t){var e=Date.now();t.anchor&&t.anchor.detachPart(t),this.parts.push(t),this.version=e,t.anchor=this,this.allParts().forEach(function(t){t.nestingScale=t.scale}),t.version=e},SpriteMorph.prototype.detachPart=function(t){var e,o=this.parts.indexOf(t);o!==-1&&(e=Date.now(),this.parts.splice(o,1),this.version=e,t.anchor=null,t.version=e)},SpriteMorph.prototype.detachAllParts=function(){var t=Date.now();this.parts.forEach(function(e){e.anchor=null,e.version=t}),this.parts=[],this.version=t},SpriteMorph.prototype.detachFromAnchor=function(){this.anchor&&this.anchor.detachPart(this)},SpriteMorph.prototype.allParts=function(){var t=[this];return this.parts.forEach(function(e){t=t.concat(e.allParts())}),t},SpriteMorph.prototype.allAnchors=function(){var t=[this];return null!==this.anchor&&(t=t.concat(this.anchor.allAnchors())),t},SpriteMorph.prototype.recordLayers=function(){var t=this.parentThatIsA(StageMorph);return t?(this.layers=this.allParts(),this.layers.forEach(function(t){var e=t.talkBubble();e&&e.hide()}),void this.layers.sort(function(e,o){return t.children.indexOf(e)<t.children.indexOf(o)?-1:1})):void(this.layerCache=null)},SpriteMorph.prototype.restoreLayers=function(){this.layers&&this.layers.length>1&&this.layers.forEach(function(t){t.comeToFront(),t.positionTalkBubble()}),this.layers=null},SpriteMorph.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),e=this.highlight(t?t.color:this.highlightColor,this.highlightBorder),this.addBack(e),this.fullChanged(),o&&this.hide(),e},SpriteMorph.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},SpriteMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},SpriteMorph.prototype.highlight=function(t,e){var o,r=new SpriteHighlightMorph,i=this.bounds,n=e;return r.setExtent(i.extent().add(2*n)),r.color=t,r.image=this.highlightImage(t,e),o=r.image.getContext("2d"),o.drawImage(this.highlightImage(new Color(255,255,255),4),e-4,e-4),o.drawImage(this.highlightImage(new Color(50,50,50),2),e-2,e-2),o.drawImage(this.highlightImage(new Color(255,255,255),1),e-1,e-1),r.setPosition(i.origin.subtract(new Point(n,n))),r},SpriteMorph.prototype.highlightImage=function(t,e){var o,r,i,n,s;return o=this.extent(),r=this.image,i=newCanvas(o.add(2*e)),n=i.getContext("2d"),n.drawImage(r,0,0),n.drawImage(r,e,0),n.drawImage(r,2*e,0),n.drawImage(r,2*e,e),n.drawImage(r,2*e,2*e),n.drawImage(r,e,2*e),n.drawImage(r,0,2*e),n.drawImage(r,0,e),n.globalCompositeOperation="destination-out",n.drawImage(r,e,e),s=newCanvas(o.add(2*e)),n=s.getContext("2d"),n.drawImage(i,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=t.toString(),n.fillRect(0,0,s.width,s.height),s},SpriteMorph.prototype.getHighlight=function(){var t;return t=this.children.slice(0).reverse().filter(function(t){return t instanceof SpriteHighlightMorph}),0!==t.length?t[0]:null},SpriteMorph.prototype.mouseEnterDragging=function(){var t;this.enableNesting&&(t=this.world().hand.children[0],this.wantsDropOf(t)&&this.addHighlight())},SpriteMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed"),this.enableNesting&&this.removeHighlight()},SpriteMorph.prototype.wantsDropOf=function(t){return this.enableNesting&&t instanceof SpriteIconMorph&&!contains(t.object.allParts(),this)},SpriteMorph.prototype.reactToDropOf=function(t,e){this.removeHighlight(),this.attachPart(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},SpriteMorph.prototype.newCostumeName=function(t,e){for(var o=t.indexOf("("),r=o<0?t:t.substring(0,o),i=1,n=r,s=this.costumes.asArray().filter(function(t){return t!==e}).map(function(t){return t.name});contains(s,n);)i+=1,n=r+"("+i+")";return n},SpriteMorph.prototype.doScreenshot=function(t,e){var o,r,i=this.parentThatIsA(StageMorph);e=this.newCostumeName(e),void 0!==t[0]&&("pen trails"===t[0]?(o=i.trailsCanvas,r=new Costume(o,e).copy()):"stage image"===t[0]&&(o=i.fullImageClassic(),r=new Costume(o,e)),this.addCostume(r))},SpriteHighlightMorph.prototype=new Morph,SpriteHighlightMorph.prototype.constructor=SpriteHighlightMorph,SpriteHighlightMorph.uber=Morph.prototype,StageMorph.prototype=new FrameMorph,StageMorph.prototype.constructor=StageMorph,StageMorph.uber=FrameMorph.prototype,StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.frameRate=0;StageMorph.prototype.isCachingPrimitives=SpriteMorph.prototype.isCachingPrimitives;StageMorph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,StageMorph.prototype.enableSublistIDs=!1,StageMorph.prototype.init=function(t){this.name=localize("Stage"),this.threads=new ThreadManager,this.variables=new VariableFrame(t||null,this),this.scripts=new ScriptsMorph(this),this.customBlocks=[],this.globalBlocks=[],this.costumes=new List,this.costume=null,this.sounds=new List,this.version=Date.now(),this.isFastTracked=!1,this.enableCustomHatBlocks=!0,this.cloneCount=0,this.timerStart=Date.now(),this.tempo=60,this.lastMessage="",this.watcherUpdateFrequency=2,this.lastWatcherUpdate=Date.now(),this.scale=1,this.keysPressed={},this.blocksCache={},this.paletteCache={},this.lastAnswer="",this.activeSounds=[],this.trailsCanvas=null,this.isThreadSafe=!1,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},StageMorph.uber.init.call(this),this.acceptsDrops=!1,this.setColor(new Color(255,255,255)),this.fps=this.frameRate},StageMorph.prototype.setScale=function(t){var e,o,r=t/this.scale,i=this.position(),n=Morph.prototype.trackChanges,s=this;1!==r&&(Morph.prototype.trackChanges=!1,this.scale=t,this.setExtent(this.dimensions.multiplyBy(t)),this.children.forEach(function(n){e=n.position().subtract(i),n.drawNew(),n.setPosition(e.multiplyBy(r).add(i),!0),n instanceof SpriteMorph?(o=n.talkBubble(),o&&(o.setScale(t),n.positionTalkBubble())):n instanceof StagePrompterMorph&&(s.scale<1?n.setWidth(s.width()-10):n.setWidth(s.dimensions.x-20),n.fixLayout(),n.setCenter(s.center()),n.setBottom(s.bottom()))}),Morph.prototype.trackChanges=n,this.changed())},StageMorph.prototype.drawNew=function(){var t;StageMorph.uber.drawNew.call(this),this.costume&&(t=this.image.getContext("2d"),t.scale(this.scale,this.scale),t.drawImage(this.costume.contents,(this.width()/this.scale-this.costume.width())/2,(this.height()/this.scale-this.costume.height())/2),this.image=this.applyGraphicsEffects(this.image)),this.version=Date.now()},StageMorph.prototype.drawOn=function(t,e){var o,r,i,n,s,a,h,l,p,c,d;if(!this.isVisible)return null;if(o=e||this.bounds,r=o.intersect(this.bounds),r.extent().gt(new Point(0,0))){if(i=this.position().neg(),n=r.copy().translateBy(i),s=t.getContext("2d"),s.globalAlpha=this.alpha,l=n.left(),p=n.top(),a=Math.min(n.width(),this.image.width-l),h=Math.min(n.height(),this.image.height-p),a<1||h<1)return null;s.drawImage(this.image,l,p,a,h,r.left(),r.top(),a,h),c=a/this.scale,d=h/this.scale,s.save(),s.scale(this.scale,this.scale);try{s.drawImage(this.penTrails(),l/this.scale,p/this.scale,c,d,r.left()/this.scale,r.top()/this.scale,c,d)}catch(t){s.restore(),s.drawImage(this.penTrails(),0,0,this.dimensions.x,this.dimensions.y,this.left(),this.top(),this.dimensions.x*this.scale,this.dimensions.y*this.scale)}s.restore()}},StageMorph.prototype.clearPenTrails=function(){this.trailsCanvas=newCanvas(this.dimensions),this.changed()},StageMorph.prototype.penTrails=function(){return this.trailsCanvas||(this.trailsCanvas=newCanvas(this.dimensions)),this.trailsCanvas},StageMorph.prototype.penTrailsMorph=function(){var t,e=new Morph,o=this.penTrails();return e.bounds=this.bounds.copy(),e.image=newCanvas(this.extent()),t=e.image.getContext("2d"),t.drawImage(o,0,0,o.width,o.height,0,0,this.image.width,this.image.height),e},StageMorph.prototype.colorFiltered=function(t,e){var o,r,i,n,s,a=new Morph,h=this.extent(),l=this.thumbnail(h,e);for(r=normalizeCanvas(l,!0).getContext("2d").getImageData(0,0,h.x,h.y),a.bounds=this.bounds.copy(),a.image=newCanvas(h,!0),o=a.image.getContext("2d"),s=o.createImageData(h.x,h.y),n=0;n<h.x*h.y*4;n+=4)i=new Color(r.data[n],r.data[n+1],r.data[n+2]),i.eq(t)&&(s.data[n]=r.data[n],s.data[n+1]=r.data[n+1],s.data[n+2]=r.data[n+2],s.data[n+3]=255);return o.putImageData(s,0,0),a},StageMorph.prototype.watchers=function(t){return this.children.filter(function(e){return e instanceof WatcherMorph&&(t?e.left()===t:e.isVisible)})},StageMorph.prototype.resetTimer=function(){this.timerStart=Date.now()},StageMorph.prototype.getTimer=function(){var t=Math.floor((Date.now()-this.timerStart)/100);return t/10},StageMorph.prototype.setTempo=function(t){this.tempo=Math.max(20,+t||0)},StageMorph.prototype.changeTempo=function(t){this.setTempo(this.getTempo()+(+t||0))},StageMorph.prototype.getTempo=function(){return+this.tempo},StageMorph.prototype.getLastMessage=function(){return this.lastMessage||""},StageMorph.prototype.reportMouseX=function(){var t=this.world();return t?(t.hand.position().x-this.center().x)/this.scale:0},StageMorph.prototype.reportMouseY=function(){var t=this.world();return t?(this.center().y-t.hand.position().y)/this.scale:0},StageMorph.prototype.wantsDropOf=function(t){return t instanceof SpriteMorph||t instanceof WatcherMorph||t instanceof ListWatcherMorph||t instanceof SpriteIconMorph},StageMorph.prototype.reactToDropOf=function(t,e){t instanceof SpriteIconMorph&&(t.object.anchor&&t.object.anchor.detachPart(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin))},StageMorph.prototype.step=function(){var t,e,o,r=this.world();if(null===r.keyboardReceiver&&(r.keyboardReceiver=this),null===r.currentKey&&(this.keyPressed=null),this.enableCustomHatBlocks&&this.stepGenericConditions(),this.isFastTracked&&this.threads.processes.length){for(this.children.forEach(function(t){t instanceof SpriteMorph&&(t.wasWarped=t.isWarped,t.isWarped||t.startWarp())});Date.now()-this.lastTime<100;)this.threads.step();this.children.forEach(function(t){t instanceof SpriteMorph&&(t.wasWarped||t.endWarp())}),this.changed()}else this.threads.step();t=Date.now(),e=t-this.lastWatcherUpdate,o=1e3/this.watcherUpdateFrequency-e,o<1&&(this.watchers().forEach(function(t){t.update()}),this.lastWatcherUpdate=Date.now())},StageMorph.prototype.stepGenericConditions=function(t){var e,o=[],r=this;return this.children.concat(this).forEach(function(t){(t instanceof SpriteMorph||t instanceof StageMorph)&&(o=o.concat(t.allGenericHatBlocks()))}),o.length?void o.forEach(function(e){r.threads.doWhen(e,t)}):(this.enableCustomHatBlocks=!1,e=this.parentThatIsA(IDE_Morph),void(e&&e.controlBar.stopButton.refresh()))},StageMorph.prototype.developersMenu=function(){var t=this,e=StageMorph.uber.developersMenu.call(this);return e.addItem("stop",function(){t.threads.stopAll()},"terminate all running threads"),e},StageMorph.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.fireKeyEvent)},StageMorph.prototype.processKeyUp=function(t){this.processKeyEvent(t,this.removePressedKey)},StageMorph.prototype.processKeyEvent=function(t,e){var o;switch(t.keyCode){case 13:o="enter",t.ctrlKey||t.metaKey?o="ctrl enter":t.shiftKey&&(o="shift enter");break;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=String.fromCharCode(t.keyCode||t.charCode),(t.ctrlKey||t.metaKey)&&(o="ctrl "+(t.shiftKey?"shift ":"")+o)}e.call(this,o)},StageMorph.prototype.fireKeyEvent=function(t){var e=t.toLowerCase(),o=[],r=[],i=this.parentThatIsA(IDE_Morph),n=this;return this.keysPressed[e]=!0,"ctrl enter"===e?this.fireGreenFlagEvent():"shift enter"===e?this.editScripts():"ctrl f"===e?void(i.isAppMode||i.currentSprite.searchBlocks()):"ctrl n"===e?void(i.isAppMode||i.createNewProject()):"ctrl o"===e?void(i.isAppMode||i.openProjectsBrowser()):"ctrl s"===e?void(i.isAppMode||i.save()):"ctrl shift s"!==e?"esc"===e?this.fireStopAllEvent():(this.children.concat(this).forEach(function(t){isSnapObject(t)&&(o=o.concat(t.allHatBlocksForKey(e)))}),o.forEach(function(t){r.push(n.threads.startProcess(t,n.isThreadSafe))}),r):i.isAppMode?void 0:i.saveProjectsBrowser()},StageMorph.prototype.removePressedKey=function(t){
delete this.keysPressed[t.toLowerCase()]},StageMorph.prototype.processKeyPress=function(t){nop(t)},StageMorph.prototype.inspectKeyEvent=CursorMorph.prototype.inspectKeyEvent,StageMorph.prototype.fireGreenFlagEvent=function(){var t=[],e=[],o=this.parentThatIsA(IDE_Morph),r=this;return this.children.concat(this).forEach(function(t){isSnapObject(t)&&(e=e.concat(t.allHatBlocksFor("__shout__go__")))}),e.forEach(function(e){t.push(r.threads.startProcess(e,r.isThreadSafe))}),o&&o.controlBar.pauseButton.refresh(),t},StageMorph.prototype.fireStopAllEvent=function(){var t=this.parentThatIsA(IDE_Morph);this.threads.resumeAll(this.stage),this.keysPressed={},this.threads.stopAll(),this.stopAllActiveSounds(),this.children.forEach(function(t){t.stopTalking&&t.stopTalking()}),this.removeAllClones(),t&&t.nextSteps([nop,function(){t.controlBar.pauseButton.refresh()}])},StageMorph.prototype.removeAllClones=function(){var t=this,e=this.children.filter(function(t){return t.isClone});e.forEach(function(e){t.threads.stopAllForReceiver(e),e.detachFromAnchor(),e.corpsify(),e.destroy()}),this.cloneCount=0},StageMorph.prototype.editScripts=function(){var t,e,o=this.parentThatIsA(IDE_Morph);!o.isAppMode&&ScriptsMorph.prototype.enableKeyboard&&(t=this.parentThatIsA(IDE_Morph).currentSprite.scripts,t.edit(t.position()),e=t.focus.sortedScripts(),e.length?(t.focus.element=e[0],t.focus.element instanceof HatBlockMorph&&t.focus.nextCommand()):t.focus.moveBy(new Point(50,50)),t.focus.fixLayout())},StageMorph.prototype.blockTemplates=function(t){function e(t){if(p.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function o(t){var e=SpriteMorph.prototype.variableBlock(t);return e.isDraggable=!1,e.isTemplate=!0,e}function r(t){if(p.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){p.toggleWatcher(t,localize(e.spec),p.blockColor[e.category])},null,function(){return p.showingWatcher(t)},null)}function i(t){return new ToggleMorph("checkbox",this,function(){p.toggleVariableWatcher(t)},null,function(){return p.showingVariableWatcher(t)},null)}function n(t){t&&(p.isVariableNameInUse(t[0])?p.inform("that name is already in use"):(p.addVariable(t[0],t[1]),p.toggleVariableWatcher(t[0],t[1]),p.blocksCache[c]=null,p.paletteCache[c]=null,p.parentThatIsA(IDE_Morph).refreshPalette()))}var s,a,h,l=[],p=this,c=t||"motion";return"motion"===c?(h=new TextMorph(localize("Stage selected:\nno motion primitives")),h.fontSize=9,h.setColor(this.paletteTextColor),l.push(h)):"looks"===c?(l.push(e("doSwitchToCostume")),l.push(e("doWearNextCostume")),l.push(r("getCostumeIdx")),l.push(e("getCostumeIdx")),l.push("-"),l.push(e("changeEffect")),l.push(e("setEffect")),l.push(e("clearEffects")),l.push("-"),l.push(e("show")),l.push(e("hide")),this.world().isDevMode&&(l.push("-"),h=new TextMorph(localize("development mode \ndebugging primitives:")),h.fontSize=9,h.setColor(this.paletteTextColor),l.push(h),l.push("-"),l.push(e("reportCostumes")),l.push("-"),l.push(e("log")),l.push(e("alert")),l.push("-"),l.push(e("doScreenshot")))):"sound"===c?(l.push(e("playSound")),l.push(e("doPlaySoundUntilDone")),l.push(e("doStopAllSounds")),l.push("-"),l.push(e("doRest")),l.push("-"),l.push(e("doPlayNote")),l.push("-"),l.push(e("doChangeTempo")),l.push(e("doSetTempo")),l.push(r("getTempo")),l.push(e("getTempo")),this.world().isDevMode&&(l.push("-"),h=new TextMorph(localize("development mode \ndebugging primitives:")),h.fontSize=9,h.setColor(this.paletteTextColor),l.push(h),l.push("-"),l.push(e("reportSounds")))):"pen"===c?l.push(e("clear")):"control"===c?(l.push(e("receiveGo")),l.push(e("receiveKey")),l.push(e("receiveInteraction")),l.push(e("receiveCondition")),l.push(e("receiveMessage")),l.push("-"),l.push(e("doBroadcast")),l.push(e("doBroadcastAndWait")),l.push(r("getLastMessage")),l.push(e("getLastMessage")),l.push("-"),l.push(e("doWarp")),l.push("-"),l.push(e("doWait")),l.push(e("doWaitUntil")),l.push("-"),l.push(e("doForever")),l.push(e("doRepeat")),l.push(e("doUntil")),l.push("-"),l.push(e("doIf")),l.push(e("doIfElse")),l.push("-"),l.push(e("doReport")),l.push("-"),l.push(e("doStopThis")),l.push(e("doStopOthers")),l.push("-"),l.push(e("doRun")),l.push(e("fork")),l.push(e("evaluate")),l.push("-"),l.push(e("doCallCC")),l.push(e("reportCallCC")),l.push("-"),l.push(e("createClone")),l.push("-"),l.push(e("doPauseAll"))):"sensing"===c?(l.push(e("doAsk")),l.push(r("getLastAnswer")),l.push(e("getLastAnswer")),l.push("-"),l.push(r("reportMouseX")),l.push(e("reportMouseX")),l.push(r("reportMouseY")),l.push(e("reportMouseY")),l.push(e("reportMouseDown")),l.push("-"),l.push(e("reportKeyPressed")),l.push("-"),l.push(e("doResetTimer")),l.push(r("getTimer")),l.push(e("getTimer")),l.push("-"),l.push(e("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&l.push(e("reportGet")),l.push("-"),l.push(e("reportURL")),l.push("-"),l.push(e("reportIsFastTracking")),l.push(e("doSetFastTracking")),l.push("-"),l.push(e("reportDate")),this.world().isDevMode&&(l.push("-"),h=new TextMorph(localize("development mode \ndebugging primitives:")),h.fontSize=9,h.setColor(this.paletteTextColor),l.push(h),l.push("-"),l.push(r("reportThreadCount")),l.push(e("reportThreadCount")),l.push(e("colorFiltered")),l.push(e("reportStackSize")),l.push(e("reportFrameCount")))):"operators"===c?(l.push(e("reifyScript")),l.push(e("reifyReporter")),l.push(e("reifyPredicate")),l.push("#"),l.push("-"),l.push(e("reportSum")),l.push(e("reportDifference")),l.push(e("reportProduct")),l.push(e("reportQuotient")),l.push("-"),l.push(e("reportModulus")),l.push(e("reportRound")),l.push(e("reportMonadic")),l.push(e("reportRandom")),l.push("-"),l.push(e("reportLessThan")),l.push(e("reportEquals")),l.push(e("reportGreaterThan")),l.push("-"),l.push(e("reportAnd")),l.push(e("reportOr")),l.push(e("reportNot")),l.push(e("reportBoolean")),l.push("-"),l.push(e("reportJoinWords")),l.push(e("reportTextSplit")),l.push(e("reportLetter")),l.push(e("reportStringSize")),l.push("-"),l.push(e("reportUnicode")),l.push(e("reportUnicodeAsLetter")),l.push("-"),l.push(e("reportIsA")),l.push(e("reportIsIdentical")),l.push("-"),l.push(e("reportJSFunction")),this.world().isDevMode&&(l.push("-"),h=new TextMorph("development mode \ndebugging primitives:"),h.fontSize=9,h.setColor(this.paletteTextColor),l.push(h),l.push("-"),l.push(e("reportTypeOf")),l.push(e("reportTextFunction")))):"variables"===c&&(a=new PushButtonMorph(null,function(){new VariableDialogMorph(null,n,p).prompt("Variable name",null,p.world())},"Make a variable"),l.push(a),this.variables.allNames().length>0&&(a=new PushButtonMorph(null,function(){var t=new MenuMorph(p.deleteVariable,null,p);p.variables.allNames().forEach(function(e){t.addItem(e,e)}),t.popUpAtHand(p.world())},"Delete a variable"),l.push(a)),l.push("-"),s=this.variables.allNames(),s.length>0&&(s.forEach(function(t){l.push(i(t)),l.push(o(t))}),l.push("-")),l.push(e("doSetVar")),l.push(e("doChangeVar")),l.push(e("doShowVar")),l.push(e("doHideVar")),l.push(e("doDeclareVariables")),l.push("="),l.push(e("reportNewList")),l.push("-"),l.push(e("reportCONS")),l.push(e("reportListItem")),l.push(e("reportCDR")),l.push("-"),l.push(e("reportListLength")),l.push(e("reportListContainsItem")),l.push("-"),l.push(e("doAddToList")),l.push(e("doDeleteFromList")),l.push(e("doInsertInList")),l.push(e("doReplaceInList")),this.world().isDevMode&&(l.push("-"),h=new TextMorph(localize("development mode \ndebugging primitives:")),h.fontSize=9,h.setColor(this.paletteTextColor),l.push(h),l.push("-"),l.push(e("reportMap")),l.push("-"),l.push(e("doForEach")),l.push(e("doShowTable"))),l.push("="),StageMorph.prototype.enableCodeMapping&&(l.push(e("doMapCodeOrHeader")),l.push(e("doMapStringCode")),l.push(e("doMapListCode")),l.push("-"),l.push(e("reportMappedCode")),l.push("=")),a=new PushButtonMorph(null,function(){var t=p.parentThatIsA(IDE_Morph);new BlockDialogMorph(null,function(e){""!==e.spec&&(e.isGlobal?p.globalBlocks.push(e):p.customBlocks.push(e),t.flushPaletteCache(),t.refreshPalette(),new BlockEditorMorph(e,p).popUp())},p).prompt("Make a block",null,p.world())},"Make a block"),l.push(a)),l},StageMorph.prototype.clear=function(){this.clearPenTrails()},StageMorph.prototype.userMenu=function(){var t=this.parentThatIsA(IDE_Morph),e=new MenuMorph(this),o=16===this.world().currentKey,r=this;return t&&t.isAppMode?e:(e.addItem("edit","edit"),e.addItem("show all","showAll"),e.addItem("pic...",function(){t.saveCanvasAs(r.fullImageClassic(),r.name,!0)},"open a new window\nwith a picture of the stage"),o&&(e.addLine(),e.addItem("turn pen trails into new costume...",function(){var e=new Costume(r.trailsCanvas,Date.now().toString()).copy();t.currentSprite.addCostume(e),t.currentSprite.wearCostume(e),t.hasChangedMedia=!0},"turn all pen trails and stamps\ninto a new costume for the\ncurrently selected sprite",new Color(100,0,0))),e)},StageMorph.prototype.showAll=function(){var t=this;this.children.forEach(function(e){e instanceof SpriteMorph?e.anchor||(e.show(),e.keepWithin(t)):(e.show(),e.keepWithin(t),e.fixLayout&&e.fixLayout())})},StageMorph.prototype.edit=SpriteMorph.prototype.edit,StageMorph.prototype.thumbnail=function(t,e){var o,r,i=this,n=this.image,s=Math.min(t.x/n.width,t.y/n.height),a=newCanvas(t),h=a.getContext("2d");return h.scale(s,s),h.drawImage(n,0,0),h.drawImage(this.penTrails(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale),this.children.forEach(function(t){t.isVisible&&t!==e&&(o=t.fullBounds(),r=t.fullImage(),r.width&&r.height&&h.drawImage(t.fullImage(),o.origin.x-i.bounds.origin.x,o.origin.y-i.bounds.origin.y))}),a},StageMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},StageMorph.prototype.show=function(){this.isVisible=!0,this.changed()},StageMorph.prototype.createClone=nop,StageMorph.prototype.categories=SpriteMorph.prototype.categories,StageMorph.prototype.blockColor=SpriteMorph.prototype.blockColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,StageMorph.prototype.setName=SpriteMorph.prototype.setName,StageMorph.prototype.palette=SpriteMorph.prototype.palette,StageMorph.prototype.freshPalette=SpriteMorph.prototype.freshPalette,StageMorph.prototype.blocksMatching=SpriteMorph.prototype.blocksMatching,StageMorph.prototype.searchBlocks=SpriteMorph.prototype.searchBlocks,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.addVariable=SpriteMorph.prototype.addVariable,StageMorph.prototype.deleteVariable=SpriteMorph.prototype.deleteVariable,StageMorph.prototype.doScreenshot=SpriteMorph.prototype.doScreenshot,StageMorph.prototype.newCostumeName=SpriteMorph.prototype.newCostumeName,StageMorph.prototype.blockForSelector=SpriteMorph.prototype.blockForSelector,StageMorph.prototype.findVariableWatcher=SpriteMorph.prototype.findVariableWatcher,StageMorph.prototype.toggleVariableWatcher=SpriteMorph.prototype.toggleVariableWatcher,StageMorph.prototype.showingVariableWatcher=SpriteMorph.prototype.showingVariableWatcher,StageMorph.prototype.deleteVariableWatcher=SpriteMorph.prototype.deleteVariableWatcher,StageMorph.prototype.addCostume=SpriteMorph.prototype.addCostume,StageMorph.prototype.wearCostume=SpriteMorph.prototype.wearCostume,StageMorph.prototype.getCostumeIdx=SpriteMorph.prototype.getCostumeIdx,StageMorph.prototype.doWearNextCostume=SpriteMorph.prototype.doWearNextCostume,StageMorph.prototype.doWearPreviousCostume=SpriteMorph.prototype.doWearPreviousCostume,StageMorph.prototype.doSwitchToCostume=SpriteMorph.prototype.doSwitchToCostume,StageMorph.prototype.reportCostumes=SpriteMorph.prototype.reportCostumes,StageMorph.prototype.graphicsChanged=SpriteMorph.prototype.graphicsChanged,StageMorph.prototype.applyGraphicsEffects=SpriteMorph.prototype.applyGraphicsEffects,StageMorph.prototype.setEffect=SpriteMorph.prototype.setEffect,StageMorph.prototype.getGhostEffect=SpriteMorph.prototype.getGhostEffect,StageMorph.prototype.changeEffect=SpriteMorph.prototype.changeEffect,StageMorph.prototype.clearEffects=SpriteMorph.prototype.clearEffects,StageMorph.prototype.addSound=SpriteMorph.prototype.addSound,StageMorph.prototype.playSound=SpriteMorph.prototype.playSound,StageMorph.prototype.stopAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.pause()}),this.activeSounds=[]},StageMorph.prototype.pauseAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.pause()})},StageMorph.prototype.resumeAllActiveSounds=function(){this.activeSounds.forEach(function(t){t.play()})},StageMorph.prototype.reportSounds=SpriteMorph.prototype.reportSounds,StageMorph.prototype.toggleWatcher=SpriteMorph.prototype.toggleWatcher,StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher,StageMorph.prototype.watcherFor=SpriteMorph.prototype.watcherFor,StageMorph.prototype.getLastAnswer=SpriteMorph.prototype.getLastAnswer,StageMorph.prototype.reportThreadCount=SpriteMorph.prototype.reportThreadCount,StageMorph.prototype.allMessageNames=SpriteMorph.prototype.allMessageNames,StageMorph.prototype.allHatBlocksFor=SpriteMorph.prototype.allHatBlocksFor,StageMorph.prototype.allHatBlocksForKey=SpriteMorph.prototype.allHatBlocksForKey,StageMorph.prototype.allHatBlocksForInteraction=SpriteMorph.prototype.allHatBlocksForInteraction,StageMorph.prototype.allGenericHatBlocks=SpriteMorph.prototype.allGenericHatBlocks,StageMorph.prototype.mouseClickLeft=SpriteMorph.prototype.mouseClickLeft,StageMorph.prototype.mouseEnter=SpriteMorph.prototype.mouseEnter,StageMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed")},StageMorph.prototype.mouseDownLeft=SpriteMorph.prototype.mouseDownLeft,StageMorph.prototype.receiveUserInteraction=SpriteMorph.prototype.receiveUserInteraction,StageMorph.prototype.deleteAllBlockInstances=SpriteMorph.prototype.deleteAllBlockInstances,StageMorph.prototype.allBlockInstances=SpriteMorph.prototype.allBlockInstances,StageMorph.prototype.allLocalBlockInstances=SpriteMorph.prototype.allLocalBlockInstances,StageMorph.prototype.allEditorBlockInstances=SpriteMorph.prototype.allEditorBlockInstances,StageMorph.prototype.paletteBlockInstance=SpriteMorph.prototype.paletteBlockInstance,StageMorph.prototype.usesBlockInstance=SpriteMorph.prototype.usesBlockInstance,StageMorph.prototype.doubleDefinitionsFor=SpriteMorph.prototype.doubleDefinitionsFor,StageMorph.prototype.replaceDoubleDefinitionsFor=SpriteMorph.prototype.replaceDoubleDefinitionsFor,StageMorph.prototype.isVariableNameInUse=SpriteMorph.prototype.isVariableNameInUse,StageMorph.prototype.globalVariables=SpriteMorph.prototype.globalVariables,StageMorph.prototype.inheritedVariableNames=function(){return[]},SpriteBubbleMorph.prototype=new SpeechBubbleMorph,SpriteBubbleMorph.prototype.constructor=SpriteBubbleMorph,SpriteBubbleMorph.uber=SpeechBubbleMorph.prototype,SpriteBubbleMorph.prototype.init=function(t,e,o,r){var i=SpriteMorph.prototype;this.stage=e,this.scale=e?e.scale:1,this.data=t,this.isQuestion=r,SpriteBubbleMorph.uber.init.call(this,this.dataAsMorph(t),i.bubbleColor,null,null,r?i.blockColor.sensing:i.bubbleBorderColor,null,o)},SpriteBubbleMorph.prototype.dataAsMorph=function(t,e){var o,r,i,n,s,a,h=SpriteMorph.prototype;return t instanceof Morph?isSnapObject(t)?(n=t.thumbnail(new Point(40,40)),o=new Morph,o.silentSetWidth(n.width),o.silentSetHeight(n.height),o.image=n,o.version=t.version,o.step=function(){this.version!==t.version&&(n=t.thumbnail(new Point(40,40)),this.image=n,this.version=t.version,this.changed())}):o=t:isString(t)?(i=!0,o=new TextMorph(t,h.bubbleFontSize*this.scale,null,h.bubbleFontIsBold,!1,"center")):"boolean"==typeof t?(n=h.booleanMorph(t).fullImage(),o=new Morph,o.silentSetWidth(n.width),o.silentSetHeight(n.height),o.image=n):t instanceof Costume?(n=t.thumbnail(new Point(40,40)),o=new Morph,o.silentSetWidth(n.width),o.silentSetHeight(n.height),o.image=n):t instanceof HTMLCanvasElement?(o=new Morph,o.silentSetWidth(t.width),o.silentSetHeight(t.height),o.image=t):t instanceof List?(r=e&&this.contentsMorph?this.contentsMorph instanceof ListWatcherMorph:t.isTable(),r?(o=new TableFrameMorph(new TableMorph(t,10)),this.stage&&o.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding)))):(o=new ListWatcherMorph(t),o.update(!0),o.step=o.update,this.stage&&o.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding)))),o.isDraggable=!1):t instanceof Context?(n=t.image(),o=new Morph,o.silentSetWidth(n.width),o.silentSetHeight(n.height),o.image=n):o=new TextMorph(t.toString(),h.bubbleFontSize*this.scale,null,h.bubbleFontIsBold,!1,"center"),o instanceof TextMorph?(a=Math.max(o.width(),2*h.bubbleCorner*this.scale),i&&(a=Math.min(a,h.bubbleMaxTextWidth*this.scale)),o.setWidth(a)):t instanceof List||(s=newCanvas(o.extent().multiplyBy(this.scale)),s.getContext("2d").drawImage(o.image,0,0,s.width,s.height),o.image=s,o.bounds=o.bounds.scaleBy(this.scale)),o},SpriteBubbleMorph.prototype.setScale=function(t){this.scale=t,this.changed(),this.drawNew(),this.changed()},SpriteBubbleMorph.prototype.drawNew=function(t){var e=SpriteMorph.prototype;this.edge=e.bubbleCorner*this.scale,this.border=e.bubbleBorder*this.scale,this.padding=e.bubbleCorner/2*this.scale,this.contentsMorph&&this.contentsMorph.destroy(),this.contentsMorph=this.dataAsMorph(this.data,t),this.add(this.contentsMorph),this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))},SpriteBubbleMorph.prototype.fixLayout=function(){var t=SpriteMorph.prototype;this.changed(),this.edge=t.bubbleCorner*this.scale,this.border=t.bubbleBorder*this.scale,this.padding=t.bubbleCorner/2*this.scale,this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),SpeechBubbleMorph.uber.drawNew.call(this),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1))),this.changed()},Costume.prototype.maxExtent=function(){return StageMorph.prototype.dimensions},Costume.prototype.toString=function(){return"a Costume("+this.name+")"},Costume.prototype.extent=function(){return new Point(this.contents.width,this.contents.height)},Costume.prototype.center=function(){return this.extent().divideBy(2)},Costume.prototype.width=function(){return this.contents.width},Costume.prototype.height=function(){return this.contents.height},Costume.prototype.bounds=function(){return new Rectangle(0,0,this.width(),this.height())},Costume.prototype.shrinkWrap=function(){var t=this.boundingBox(),e=t.extent(),o=newCanvas(e,!0),r=o.getContext("2d");r.drawImage(this.contents,t.origin.x,t.origin.y,e.x,e.y,0,0,e.x,e.y),this.rotationCenter=this.rotationCenter.subtract(t.origin),this.contents=o,this.version=Date.now()},Costume.prototype.canvasBoundingBox=function(t){function e(t,e){return c.data[e*h*4+4*t+3]}function o(){for(a=0;a<=h;a+=1)for(s=0;s<=l;s+=1)if(e(a,s))return a;return 0}function r(){for(s=0;s<=l;s+=1)for(a=0;a<=l;a+=1)if(e(a,s))return s;return 0}function i(){for(a=h;a>=0;a-=1)for(s=l;s>=0;s-=1)if(e(a,s))return Math.min(a+1,h);return h}function n(){for(s=l;s>=0;s-=1)for(a=h;a>=0;a-=1)if(e(a,s))return Math.min(s+1,l);return l}var s,a,h=t.width,l=t.height,p=t.getContext("2d"),c=p.getImageData(0,0,h,l);return new Rectangle(o(),r(),i(),n())},Costume.prototype.boundingBox=function(){return this.canvasBoundingBox(this.contents)},Costume.prototype.copy=function(){var t,e,o=newCanvas(this.extent(),!0);return e=o.getContext("2d"),e.drawImage(this.contents,0,0),t=new Costume(o,this.name?copy(this.name):null),t.rotationCenter=this.rotationCenter.copy(),t},Costume.prototype.flipped=function(){var t,e=newCanvas(this.extent(),!0),o=e.getContext("2d");return o.translate(this.width(),0),o.scale(-1,1),o.drawImage(this.contents,0,0),t=new Costume(e,new Point(this.width()-this.rotationCenter.x,this.rotationCenter.y))},Costume.prototype.edit=function(t,e,o,r,i){var n=this,s=new PaintEditorMorph;s.oncancel=r||nop,s.openIn(t,o?newCanvas(StageMorph.prototype.dimensions,!0):this.contents,o?null:this.rotationCenter,function(o,r){n.contents=o,n.rotationCenter=r,e.currentSprite instanceof SpriteMorph&&n.shrinkWrap(),n.version=Date.now(),t.changed(),e&&(e.currentSprite.wearCostume(n),e.hasChangedMedia=!0),(i||nop)()})},Costume.prototype.editRotationPointOnly=function(t){var e,o,r,i=new CostumeEditorMorph(this);e=function(){i.accept()},o=new DialogBoxMorph(this,e),r=new TextMorph(localize("click or drag crosshairs to move the rotation center"),o.fontSize,o.fontStyle,!0,!1,"center",null,null,new Point(1,1),new Color(255,255,255)),o.labelString="Costume Editor",o.createLabel(),o.setPicture(i),o.addBody(r),o.addButton("ok","Ok"),o.addButton("cancel","Cancel"),o.fixLayout(),o.drawNew(),o.fixLayout(),o.popUp(t)},Costume.prototype.shrinkToFit=function(t){(t.x<this.width()||t.y<this.height())&&(this.contents=this.thumbnail(t))},Costume.prototype.thumbnail=function(t){var e=this.contents,o=Math.min(t.x/e.width,t.y/e.height),r=(t.x-e.width*o)/2,i=(t.y-e.height*o)/2,n=newCanvas(t),s=n.getContext("2d");return e&&e.width+e.height!==0?(s.scale(o,o),s.drawImage(e,Math.floor(r/o),Math.floor(i/o)),n):n},Costume.prototype.isTainted=function(){try{this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height)}catch(t){return!0}return!1},SVG_Costume.prototype=new Costume,SVG_Costume.prototype.constructor=SVG_Costume,SVG_Costume.uber=Costume.prototype,SVG_Costume.prototype.toString=function(){return"an SVG_Costume("+this.name+")"},SVG_Costume.prototype.copy=function(){var t,e=new Image;return e.src=this.contents.src,t=new SVG_Costume(e,this.name?copy(this.name):null),t.rotationCenter=this.rotationCenter.copy(),t},SVG_Costume.prototype.shrinkToFit=function(t){nop(t)},CostumeEditorMorph.prototype=new Morph,CostumeEditorMorph.prototype.constructor=CostumeEditorMorph,CostumeEditorMorph.uber=Morph.prototype,CostumeEditorMorph.prototype.size=Costume.prototype.maxExtent(),CostumeEditorMorph.prototype.init=function(t){this.costume=t||new Costume,this.rotationCenter=this.costume.rotationCenter.copy(),this.margin=new Point(0,0),CostumeEditorMorph.uber.init.call(this),this.noticesTransparentClick=!0},CostumeEditorMorph.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy(),this.costume.version=Date.now()},CostumeEditorMorph.prototype.drawNew=function(){var t,e;this.margin=this.size.subtract(this.costume.extent()).divideBy(2),t=this.rotationCenter.add(this.margin),this.silentSetExtent(this.size),this.image=newCanvas(this.extent()),this.cachedTexture||(this.cachedTexture=this.createTexture()),this.drawCachedTexture(),e=this.image.getContext("2d"),e.drawImage(this.costume.contents,this.margin.x,this.margin.y),e.globalAlpha=.5,e.fillStyle="white",e.beginPath(),e.arc(t.x,t.y,20,radians(0),radians(360),!1),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.arc(t.x,t.y,10,radians(0),radians(360),!1),e.stroke(),e.beginPath(),e.moveTo(0,t.y),e.lineTo(this.costume.width()+2*this.margin.x,t.y),e.stroke(),e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x,this.costume.height()+2*this.margin.y),e.stroke()},CostumeEditorMorph.prototype.createTexture=function(){var t=5,e=newCanvas(new Point(2*t,2*t)),o=e.getContext("2d"),r=new Color(230,230,230);return o.fillStyle="white",o.fillRect(0,0,2*t,2*t),o.fillStyle=r.toString(),o.fillRect(0,0,t,t),o.fillRect(t,t,t,t),e},CostumeEditorMorph.prototype.mouseDownLeft=function(t){this.rotationCenter=t.subtract(this.position().add(this.margin)),this.drawNew(),this.changed()},CostumeEditorMorph.prototype.mouseMove=CostumeEditorMorph.prototype.mouseDownLeft,Sound.prototype.play=function(){var t=document.createElement("audio");return t.src=this.audio.src,t.play(),t},Sound.prototype.copy=function(){var t,e=document.createElement("audio");return e.src=this.audio.src,t=new Sound(e,this.name?copy(this.name):null)},Sound.prototype.toDataURL=function(){return this.audio.src},Note.prototype.audioContext=null,Note.prototype.gainNode=null,Note.prototype.setupContext=function(){if(!this.audioContext){var t=function(){var t=window.AudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext||window.webkitAudioContext;return t.prototype.hasOwnProperty("createGain")||(t.prototype.createGain=t.prototype.createGainNode),t}();if(!t)throw new Error("Web Audio API is not supported\nin this browser");Note.prototype.audioContext=new t,Note.prototype.gainNode=Note.prototype.audioContext.createGain(),Note.prototype.gainNode.gain.value=.25}},Note.prototype.play=function(){this.oscillator=this.audioContext.createOscillator(),this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn),this.oscillator.stop||(this.oscillator.stop=this.oscillator.noteOff),this.oscillator.type="sine",this.oscillator.frequency.value=440*Math.pow(2,(this.pitch-69)/12),this.oscillator.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination),this.oscillator.start(0)},Note.prototype.stop=function(){this.oscillator&&(this.oscillator.stop(0),this.oscillator=null)},CellMorph.prototype=new BoxMorph,CellMorph.prototype.constructor=CellMorph,CellMorph.uber=BoxMorph.prototype,CellMorph.prototype.init=function(t,e,o,r){this.contents=0===t?0:t!==!1&&(t||""),this.isEditable=!isNil(o),this.idx=o||null,this.parentCell=r||null,CellMorph.uber.init.call(this,SyntaxElementMorph.prototype.corner,1.000001,new Color(255,255,255)),this.color=e||new Color(255,140,0),this.isBig=!1,this.version=null,this.drawNew()},CellMorph.prototype.big=function(){this.isBig=!0,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.normal=function(){this.isBig=!1,this.changed(),this.drawNew(),this.changed()},CellMorph.prototype.isCircular=function(t){return!!this.parentCell&&(t instanceof List?this.contents===t||this.parentCell.isCircular(t):this.parentCell.isCircular(this.contents))},CellMorph.prototype.fixLayout=function(){var t;this.changed(),this.drawNew(),this.changed(),this.parent&&this.parent.fixLayout?this.parent.fixLayout():(t=this.parentThatIsA(ListWatcherMorph),t&&t.fixLayout())},CellMorph.prototype.update=function(){isSnapObject(this.contents)&&this.version!==this.contents.version&&this.drawNew()},CellMorph.prototype.drawNew=function(t,e){var o,r,i,n=SyntaxElementMorph.prototype.fontSize,s=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents,a=this.contentsMorph instanceof TableFrameMorph&&this.contentsMorph.tableMorph.table===this.contents;return this.isBig&&(n=1.5*n),(t||this.contentsMorph&&!s&&!a)&&(this.contentsMorph.destroy(),this.version=null),(t||!s&&!a)&&(this.contents instanceof Morph?isSnapObject(this.contents)?(i=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(i.width),this.contentsMorph.silentSetHeight(i.height),this.contentsMorph.image=i,this.version=this.contents.version):this.contentsMorph=this.contents:isString(this.contents)?(r=this.contents.length>500?this.contents.slice(0,500)+"...":this.contents,this.contentsMorph=new TextMorph(r,n,null,!0,!1,"left"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))):"boolean"==typeof this.contents?(i=SpriteMorph.prototype.booleanMorph.call(null,this.contents).fullImage(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(i.width),this.contentsMorph.silentSetHeight(i.height),this.contentsMorph.image=i):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contents instanceof Context?(i=this.contents.image(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(i.width),this.contentsMorph.silentSetHeight(i.height),this.contentsMorph.image=i):this.contents instanceof Costume?(i=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(i.width),this.contentsMorph.silentSetHeight(i.height),this.contentsMorph.image=i):this.contents instanceof List?("table"===e||!t&&this.contents.isTable()?(this.contentsMorph=new TableFrameMorph(new TableMorph(this.contents,10)),this.contentsMorph.expand(new Point(200,150))):this.isCircular()?(this.contentsMorph=new TextMorph("(...)",n,null,!1,!0,"center"),this.contentsMorph.setColor(new Color(255,255,255))):this.contentsMorph=new ListWatcherMorph(this.contents,this),this.contentsMorph.isDraggable=!1):(this.contentsMorph=new TextMorph(isNil(this.contents)?"":this.contents.toString(),n,null,!0,!1,"center"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))),this.add(this.contentsMorph)),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:3.5*SyntaxElementMorph.prototype.fontSize)),this.image=newCanvas(this.extent()),o=this.image.getContext("2d"),0===this.edge&&0===this.border?(BoxMorph.uber.drawNew.call(this),null):(o.fillStyle=this.color.toString(),o.beginPath(),this.outlinePath(o,Math.max(this.edge-this.border,0),this.border),o.closePath(),o.fill(),this.border>0&&!MorphicPreferences.isFlat&&(o.lineWidth=this.border,o.strokeStyle=this.borderColor.toString(),o.beginPath(),this.outlinePath(o,this.edge,this.border/2),o.closePath(),o.stroke(),o.shadowOffsetX=this.border,o.shadowOffsetY=this.border,o.shadowBlur=this.border,o.shadowColor=this.color.darker(80).toString(),this.drawShadow(o,this.edge,this.border/2)),void((t||!s&&!a)&&this.contentsMorph.setCenter(this.center())))},CellMorph.prototype.drawShadow=function(t,e,o){var r=e+o,i=this.width(),n=this.height();t.beginPath(),t.moveTo(0,n-r),t.lineTo(0,r),t.stroke(),t.beginPath(),t.arc(r,r,e,radians(-180),radians(-90),!1),t.stroke(),t.beginPath(),t.moveTo(r,0),t.lineTo(i-r,0),t.stroke()},CellMorph.prototype.layoutChanged=function(){var t,e=SyntaxElementMorph.prototype.fontSize,o=this.parentThatIsA(ListWatcherMorph);return this.isBig&&(e=1.5*e),this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border),this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:2*this.height())),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),0===this.edge&&0===this.border?(BoxMorph.uber.drawNew.call(this),null):(t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),this.border>0&&!MorphicPreferences.isFlat&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke(),t.shadowOffsetX=this.border,t.shadowOffsetY=this.border,t.shadowBlur=this.border,t.shadowColor=this.color.darker(80).toString(),this.drawShadow(t,this.edge,this.border/2)),this.contentsMorph.setCenter(this.center()),void(o&&o.fixLayout()))},CellMorph.prototype.reactToEdit=function(t){var e;isNil(this.idx)||(e=this.parentThatIsA(ListWatcherMorph),e&&e.list.put(t.text,this.idx))},CellMorph.prototype.mouseClickLeft=function(t){this.isEditable&&this.contentsMorph instanceof TextMorph?this.contentsMorph.selectAllAndEdit():this.escalateEvent("mouseClickLeft",t)},CellMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables&&this.currentValue instanceof List?new TableDialogMorph(this.contents).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t);
},WatcherMorph.prototype=new BoxMorph,WatcherMorph.prototype.constructor=WatcherMorph,WatcherMorph.uber=BoxMorph.prototype,WatcherMorph.prototype.init=function(t,e,o,r,i){this.labelText=t||"",this.version=null,this.objName="",WatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120)),this.color=new Color(220,220,220),this.readoutColor=e,this.style="normal",this.target=o||null,this.getter=r||null,this.currentValue=null,this.labelMorph=null,this.sliderMorph=null,this.cellMorph=null,this.isDraggable=!0,this.fixLayout(),this.update(),i&&this.hide()},WatcherMorph.prototype.isTemporary=function(){var t=this.parentThatIsA(StageMorph);return this.target instanceof VariableFrame&&((!t||this.target!==t.variables.parentFrame)&&null===this.target.owner)},WatcherMorph.prototype.object=function(){return this.target instanceof VariableFrame?this.target.owner:this.target},WatcherMorph.prototype.isGlobal=function(t){return contains(["getLastAnswer","getLastMessage","getTempo","getTimer","reportMouseX","reportMouseY","reportThreadCount"],t)},WatcherMorph.prototype.setSliderMin=function(t,e){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,e),this.sliderMorph.setStart(t,e),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,e))},WatcherMorph.prototype.setSliderMax=function(t,e){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,e),this.sliderMorph.setStop(t,e),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,e))},WatcherMorph.prototype.update=function(){var t,e,o;if(this.target&&this.getter){if(this.updateLabel(),this.target instanceof VariableFrame)if(t=this.target.vars[this.getter]?this.target.vars[this.getter].value:void 0,void 0===t&&this.target.owner){if(e=this.target.owner,!contains(e.inheritedVariableNames(),this.getter))return void this.destroy();t=this.target.getVar(this.getter),this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables.lighter(35))}else this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables);else t=this.target[this.getter]();""===t||isNil(t)||(o=+t,"boolean"==typeof t||isNaN(o)||(t=Math.round(1e9*t)/1e9)),t!==this.currentValue&&(this.changed(),this.cellMorph.contents=t,this.cellMorph.drawNew(),isNaN(t)||(this.sliderMorph.value=t,this.sliderMorph.drawNew()),this.fixLayout(),this.currentValue=t)}this.cellMorph.contentsMorph instanceof ListWatcherMorph?this.cellMorph.contentsMorph.update():isSnapObject(this.cellMorph.contents)&&this.cellMorph.update()},WatcherMorph.prototype.updateLabel=function(){var t=this.object();t&&!this.isGlobal(this.getter)&&t.version!==this.version&&(this.objName=t.name?t.name+" ":" ",this.labelMorph&&(this.labelMorph.destroy(),this.labelMorph=null,this.fixLayout()))},WatcherMorph.prototype.fixLayout=function(){var t,e=SyntaxElementMorph.prototype.fontSize,o=this;return this.changed(),null===this.labelMorph&&(this.labelMorph=new StringMorph(this.objName+this.labelText,e,null,!0,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.add(this.labelMorph)),null===this.cellMorph&&(this.cellMorph=new CellMorph("",this.readoutColor),this.add(this.cellMorph)),null===this.sliderMorph&&(this.sliderMorph=new SliderMorph(0,100,0,20,"horizontal"),this.sliderMorph.alpha=1,this.sliderMorph.button.color=this.color.darker(),this.sliderMorph.color=this.color.lighter(60),this.sliderMorph.button.highlightColor=this.color.darker(),this.sliderMorph.button.highlightColor.b+=50,this.sliderMorph.button.pressColor=this.color.darker(),this.sliderMorph.button.pressColor.b+=100,this.sliderMorph.setHeight(e),this.sliderMorph.action=function(t){o.target.setVar(o.getter,Math.round(t),o.target.owner)},this.add(this.sliderMorph)),t=this.cellMorph.contents instanceof List,t&&(this.style="normal"),"large"===this.style?(this.labelMorph.hide(),this.sliderMorph.hide(),this.cellMorph.big(),this.cellMorph.setPosition(this.position()),void this.setExtent(this.cellMorph.extent().subtract(1))):(this.labelMorph.show(),this.sliderMorph.show(),this.cellMorph.normal(),this.labelMorph.setPosition(this.position().add(new Point(this.edge,this.border+SyntaxElementMorph.prototype.typeInPadding))),t?this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new Point(0,SyntaxElementMorph.prototype.typeInPadding))):(this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(e/3,0))),this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)),"slider"===this.style?(this.sliderMorph.silentSetPosition(new Point(this.labelMorph.left(),this.cellMorph.bottom()+SyntaxElementMorph.prototype.typeInPadding)),this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left()),this.silentSetHeight(this.cellMorph.height()+this.sliderMorph.height()+2*this.border+3*SyntaxElementMorph.prototype.typeInPadding)):(this.sliderMorph.hide(),this.bounds.corner.y=this.cellMorph.bottom()+this.border+SyntaxElementMorph.prototype.typeInPadding),this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+SyntaxElementMorph.prototype.typeInPadding,this.drawNew(),void this.changed())},WatcherMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables&&this.currentValue instanceof List?new TableDialogMorph(this.currentValue).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},WatcherMorph.prototype.userMenu=function(){function t(t){var e=o.parentThatIsA(StageMorph),i=o.currentValue.outerContext.variables;r.addItem(t+"...",function(){var o,r=detect(e.children,function(e){return e instanceof WatcherMorph&&e.target===i&&e.getter===t});return null!==r?(r.show(),void r.fixLayout()):(r=new WatcherMorph(t+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,i,t),r.setPosition(e.position().add(10)),o=e.watchers(r.left()),o.length>0&&r.setTop(o[o.length-1].bottom()),e.add(r),void r.fixLayout())})}var e,o=this,r=new MenuMorph(this),i="",n="";return r.addItem(("normal"===this.style?i:n)+" "+localize("normal"),"styleNormal"),r.addItem(("large"===this.style?i:n)+" "+localize("large"),"styleLarge"),this.target instanceof VariableFrame&&(r.addItem(("slider"===this.style?i:n)+" "+localize("slider"),"styleSlider"),r.addLine(),r.addItem("slider min...","userSetSliderMin"),r.addItem("slider max...","userSetSliderMax"),r.addLine(),r.addItem("import...",function(){var t=document.createElement("input"),e=o.parentThatIsA(IDE_Morph);e.filePicker&&(document.body.removeChild(e.filePicker),e.filePicker=null),t.type="file",t.style.color="transparent",t.style.backgroundColor="transparent",t.style.border="none",t.style.outline="none",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="0px",t.style.height="0px",t.addEventListener("change",function(){function r(t){e.inform("Unable to import",'Snap! can only import "text" files.\nYou selected a file of type "'+t+'".')}function i(t){var e=new FileReader;e.onloadend=function(t){o.target.setVar(o.getter,t.target.result)},0===t.type.indexOf("text")?e.readAsText(t):r(t.type)}var n;document.body.removeChild(t),e.filePicker=null,t.files.length>0&&(n=t.files[t.files.length-1],i(n))},!1),document.body.appendChild(t),e.filePicker=t,t.click()}),!this.currentValue||!isString(this.currentValue)&&isNaN(+this.currentValue)?this.currentValue instanceof Context&&(e=this.currentValue.outerContext.variables.names(),e.length&&(r.addLine(),e.forEach(function(e){t(e)}))):r.addItem("export...",function(){var t=o.parentThatIsA(IDE_Morph);t.saveFileAs(o.currentValue.toString(),"text/plain;charset=utf-8",o.getter)})),r},WatcherMorph.prototype.setStyle=function(t){this.style=t,this.fixLayout()},WatcherMorph.prototype.styleNormal=function(){this.setStyle("normal")},WatcherMorph.prototype.styleLarge=function(){this.setStyle("large")},WatcherMorph.prototype.styleSlider=function(){this.setStyle("slider")},WatcherMorph.prototype.userSetSliderMin=function(){new DialogBoxMorph(this,this.setSliderMin,this).prompt("Slider minimum value",this.sliderMorph.start.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.userSetSliderMax=function(){new DialogBoxMorph(this,this.setSliderMax,this).prompt("Slider maximum value",this.sliderMorph.stop.toString(),this.world(),null,null,null,!0)},WatcherMorph.prototype.drawNew=function(){var t,e;return this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),MorphicPreferences.isFlat||0===this.edge&&0===this.border?void BoxMorph.uber.drawNew.call(this):(e=t.createLinearGradient(0,0,0,this.height()),e.addColorStop(0,this.color.lighter().toString()),e.addColorStop(1,this.color.darker().toString()),t.fillStyle=e,t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),void(this.border>0&&(e=t.createLinearGradient(0,0,0,this.height()),e.addColorStop(0,this.borderColor.lighter().toString()),e.addColorStop(1,this.borderColor.darker().toString()),t.lineWidth=this.border,t.strokeStyle=e,t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke())))},StagePrompterMorph.prototype=new BoxMorph,StagePrompterMorph.prototype.constructor=StagePrompterMorph;StagePrompterMorph.uber=BoxMorph.prototype;StagePrompterMorph.prototype.init=function(t){var e=this;this.isDone=!1,t?this.label=new StringMorph(t,SpriteMorph.prototype.bubbleFontSize,null,SpriteMorph.prototype.bubbleFontIsBold,!1,"left"):this.label=null,this.inputField=new InputFieldMorph,this.button=new PushButtonMorph(null,function(){e.accept()},""),StagePrompterMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,SpriteMorph.prototype.bubbleBorder,SpriteMorph.prototype.blockColor.sensing),this.color=new Color(255,255,255),this.label&&this.add(this.label),this.add(this.inputField),this.add(this.button),this.setWidth(StageMorph.prototype.dimensions.x-20),this.fixLayout()},StagePrompterMorph.prototype.fixLayout=function(){var t=0;this.label&&(this.label.setPosition(new Point(this.left()+this.edge,this.top()+this.edge)),t=this.label.bottom()-this.top()),this.inputField.setPosition(new Point(this.left()+this.edge,this.top()+t+this.edge)),this.inputField.setWidth(this.width()-2*this.edge-this.button.width()-this.border),this.button.setCenter(this.inputField.center()),this.button.setLeft(this.inputField.right()+this.border),this.setHeight(this.inputField.bottom()-this.top()+this.edge)},StagePrompterMorph.prototype.mouseClickLeft=function(){this.inputField.edit()},StagePrompterMorph.prototype.accept=function(){this.isDone=!0},modules.gui="2016-August-12";var IDE_Morph,ProjectDialogMorph,SpriteIconMorph,CostumeIconMorph,TurtleIconMorph,WardrobeMorph,SoundIconMorph,JukeboxMorph,StageHandleMorph,PaletteHandleMorph;IDE_Morph.prototype=new Morph,IDE_Morph.prototype.constructor=IDE_Morph,IDE_Morph.uber=Morph.prototype,IDE_Morph.prototype.setDefaultDesign=function(){MorphicPreferences.isFlat=!1,SpriteMorph.prototype.paletteColor=new Color(55,55,55),SpriteMorph.prototype.paletteTextColor=new Color(230,230,230),StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30),IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(40,40,40),IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(8),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(255,255,255),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.darker(40),IDE_Morph.prototype.groupColor.darker(60),IDE_Morph.prototype.groupColor],IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors,IDE_Morph.prototype.appModeColor=new Color,IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),IDE_Morph.prototype.padding=5,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.setFlatDesign=function(){MorphicPreferences.isFlat=!0,SpriteMorph.prototype.paletteColor=new Color(255,255,255),SpriteMorph.prototype.paletteTextColor=new Color(70,70,70),StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor,StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor,IDE_Morph.prototype.buttonContrast=30,IDE_Morph.prototype.backgroundColor=new Color(200,200,200),IDE_Morph.prototype.frameColor=new Color(255,255,255),IDE_Morph.prototype.groupColor=new Color(230,230,230),IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor,IDE_Morph.prototype.buttonLabelColor=new Color(70,70,70),IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.lighter(60),IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor],IDE_Morph.prototype.rotationStyleColors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor.darker(30)],IDE_Morph.prototype.appModeColor=IDE_Morph.prototype.frameColor,IDE_Morph.prototype.scriptsPaneTexture=null,IDE_Morph.prototype.padding=1,SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor,TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor},IDE_Morph.prototype.scriptsTexture=function(){var t,e=newCanvas(new Point(100,100)),o=e.getContext("2d");for(t=0;t<100;t+=4)o.fillStyle=this.frameColor.toString(),o.fillRect(t,0,1,100),o.fillStyle=this.groupColor.lighter(6).toString(),o.fillRect(t+1,0,1,100),o.fillRect(t+3,0,1,100),o.fillStyle=this.groupColor.toString(),o.fillRect(t+2,0,1,100);return e},IDE_Morph.prototype.setDefaultDesign(),IDE_Morph.prototype.init=function(t){MorphicPreferences.globalFontFamily="Helvetica, Arial",this.userLanguage=null,this.projectsInURLs=!1,this.applySavedSettings(),this.cloudMsg=null,this.source="local",this.serializer=new SnapSerializer,this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),this.currentCategory="motion",this.currentTab="scripts",this.projectName="",this.projectNotes="",this.logoURL=this.resourceURL("snap_logo_sm.png"),this.logo=null,this.controlBar=null,this.categories=null,this.palette=null,this.paletteHandle=null,this.spriteBar=null,this.spriteEditor=null,this.stage=null,this.stageHandle=null,this.corralBar=null,this.corral=null,this.isAutoFill=void 0===t||t,this.isAppMode=!1,this.isSmallStage=!1,this.filePicker=null,this.hasChangedMedia=!1,this.isAnimating=!0,this.paletteWidth=200,this.stageRatio=1,this.loadNewProject=!1,this.shield=null,IDE_Morph.uber.init.call(this),this.color=this.backgroundColor},IDE_Morph.prototype.openIn=function(t){function e(t){try{var e=new XMLHttpRequest;if(e.open("GET",t,!1),e.send(),200===e.status)return e.responseText;throw new Error("unable to retrieve "+t)}catch(t){return n.showMessage("unable to retrieve project"),""}}function o(){var t;"#open:"===location.hash.substr(0,6)?(r=location.hash.substr(6),("%"===r.charAt(0)||r.search(/\%(?:[0-9a-f]{2})/i)>-1)&&(r=decodeURIComponent(r)),contains(["project","blocks","sprites","snapdata"].map(function(t){return r.substr(0,8).indexOf(t)}),1)?this.droppedText(r):this.droppedText(e(r))):"#run:"===location.hash.substr(0,5)?(r=location.hash.substr(5),("%"===r.charAt(0)||r.search(/\%(?:[0-9a-f]{2})/i)>-1)&&(r=decodeURIComponent(r)),"<project>"===r.substr(0,8)?this.rawOpenProjectString(r):this.rawOpenProjectString(e(r)),this.toggleAppMode(!0),this.runScripts()):"#present:"===location.hash.substr(0,9)?(this.shield=new Morph,this.shield.color=this.color,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),n.showMessage("Fetching project\nfrom the cloud..."),t=SnapCloud.parseDict(location.hash.substr(9)),t.Username=t.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(t),function(e){var o;n.nextSteps([function(){o=n.showMessage("Opening project...")},function(){nop()},function(){0===e.indexOf("<snapdata")?n.rawOpenCloudDataString(e):0===e.indexOf("<project")&&n.rawOpenProjectString(e),n.hasChangedMedia=!0},function(){n.shield.destroy(),n.shield=null,o.destroy(),t.editMode?n.toggleAppMode(!1):n.toggleAppMode(!0),t.noRun||n.runScripts(),t.hideControls&&(n.controlBar.hide(),window.onbeforeunload=function(){nop()})}])},this.cloudError())):"#cloud:"===location.hash.substr(0,7)?(this.shield=new Morph,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),n.showMessage("Fetching project\nfrom the cloud..."),t=SnapCloud.parseDict(location.hash.substr(7)),t.Username=t.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(t),function(t){var e;n.nextSteps([function(){e=n.showMessage("Opening project...")},function(){nop()},function(){0===t.indexOf("<snapdata")?n.rawOpenCloudDataString(t):0===t.indexOf("<project")&&n.rawOpenProjectString(t),n.hasChangedMedia=!0},function(){n.shield.destroy(),n.shield=null,e.destroy(),n.toggleAppMode(!1)}])},this.cloudError())):"#lang:"===location.hash.substr(0,6)?(s=location.hash.substr(6),this.setLanguage(s),this.loadNewProject=!0):"#signup"===location.hash.substr(0,7)&&this.createCloudAccount()}var r,i,n=this,s=null;localStorage&&(i=localStorage["-snap-user"],i&&(i=SnapCloud.parseResponse(i)[0],i&&(SnapCloud.username=i.username||null,SnapCloud.password=i.password||null,SnapCloud.username&&(this.source="cloud")))),this.buildPanes(),t.add(this),t.userMenu=this.userMenu,SnapCloud.message=function(e){var o,r=new MenuMorph(null,e);r.popUpCenteredInWorld(t),o=setInterval(function(){r.destroy(),clearInterval(o)},2e3)},t.reactToDropOf=function(e){e instanceof DialogBoxMorph||(t.hand.grabOrigin?e.slideBackTo(t.hand.grabOrigin):t.hand.grab(e))},this.reactToWorldResize(t.bounds),this.userLanguage?(this.loadNewProject=!0,this.setLanguage(this.userLanguage,o)):o.call(this)},IDE_Morph.prototype.buildPanes=function(){this.createLogo(),this.createControlBar(),this.createCategories(),this.createPalette(),this.createStage(),this.createSpriteBar(),this.createSpriteEditor(),this.createCorralBar(),this.createCorral()},IDE_Morph.prototype.createLogo=function(){var t=this;this.logo&&this.logo.destroy(),this.logo=new Morph,this.logo.texture=this.logoURL,this.logo.drawNew=function(){this.image=newCanvas(this.extent());var e=this.image.getContext("2d"),o=e.createLinearGradient(0,0,this.width(),0);o.addColorStop(0,"black"),o.addColorStop(.5,t.frameColor.toString()),e.fillStyle=MorphicPreferences.isFlat?t.frameColor.toString():o,e.fillRect(0,0,this.width(),this.height()),this.texture&&this.drawTexture(this.texture)},this.logo.drawCachedTexture=function(){var t=this.image.getContext("2d");t.drawImage(this.cachedTexture,5,Math.round((this.height()-this.cachedTexture.height)/2)),this.changed()},this.logo.mouseClickLeft=function(){t.snapMenu()},this.logo.color=new Color,this.logo.setExtent(new Point(200,28)),this.add(this.logo)},IDE_Morph.prototype.createControlBar=function(){var t,e,o,r,i,n,s,a,h,l,p=5,c=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)],d=this;this.controlBar&&this.controlBar.destroy(),this.controlBar=new Morph,this.controlBar.color=this.frameColor,this.controlBar.setHeight(this.logo.height()),this.controlBar.mouseClickLeft=function(){this.world().fillPage()},this.add(this.controlBar),t=new ToggleButtonMorph(null,d,"toggleStageSize",[new SymbolMorph("smallStage",14),new SymbolMorph("normalStage",14)],function(){return d.isSmallStage}),t.corner=12,t.color=c[0],t.highlightColor=c[1],t.pressColor=c[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=c[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),s=t,this.controlBar.add(s),this.controlBar.stageSizeButton=t,t=new ToggleButtonMorph(null,d,"toggleAppMode",[new SymbolMorph("fullScreen",14),new SymbolMorph("normalScreen",14)],function(){return d.isAppMode}),t.corner=12,t.color=c[0],t.highlightColor=c[1],t.pressColor=c[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=c[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),a=t,this.controlBar.add(a),this.controlBar.appModeButton=a,t=new ToggleButtonMorph(null,this,"stopAllScripts",[new SymbolMorph("octagon",14),new SymbolMorph("square",14)],function(){return!d.stage||d.stage.enableCustomHatBlocks&&d.stage.threads.pauseCustomHatBlocks}),t.corner=12,t.color=c[0],t.highlightColor=c[1],t.pressColor=c[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=c[1],t.labelColor=new Color(200,0,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),e=t,this.controlBar.add(e),this.controlBar.stopButton=e,t=new ToggleButtonMorph(null,this,"togglePauseResume",[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)],function(){return d.isPaused()}),t.corner=12,t.color=c[0],t.highlightColor=c[1],t.pressColor=c[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=c[1],t.labelColor=new Color(255,220,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),t.refresh(),o=t,this.controlBar.add(o),this.controlBar.pauseButton=o,t=new PushButtonMorph(this,"pressStart",new SymbolMorph("flag",14)),t.corner=12,t.color=c[0],t.highlightColor=c[1],t.pressColor=c[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=c[1],t.labelColor=new Color(0,200,0),t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),r=t,this.controlBar.add(r),this.controlBar.startButton=r,t=new PushButtonMorph(this,"projectMenu",new SymbolMorph("file",14)),t.corner=12,t.color=c[0],t.highlightColor=c[1],t.pressColor=c[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=c[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),i=t,this.controlBar.add(i),this.controlBar.projectButton=i,t=new PushButtonMorph(this,"settingsMenu",new SymbolMorph("gears",14)),t.corner=12,t.color=c[0],t.highlightColor=c[1],t.pressColor=c[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=c[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),n=t,this.controlBar.add(n),this.controlBar.settingsButton=n,t=new PushButtonMorph(this,"cloudMenu",new SymbolMorph("cloud",11)),t.corner=12,t.color=c[0],t.highlightColor=c[1],t.pressColor=c[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=c[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.fixLayout(),h=t,this.controlBar.add(h),this.controlBar.cloudButton=h,this.controlBar.fixLayout=function(){l=this.right()-p,[e,o,r].forEach(function(t){t.setCenter(d.controlBar.center()),t.setRight(l),l-=t.width(),l-=p}),l=Math.min(r.left()-(3*p+2*s.width()),d.right()-StageMorph.prototype.dimensions.x*(d.isSmallStage?d.stageRatio:1)),[s,a].forEach(function(t){l+=p,t.setCenter(d.controlBar.center()),t.setLeft(l),l+=t.width()}),n.setCenter(d.controlBar.center()),n.setLeft(this.left()),h.setCenter(d.controlBar.center()),h.setRight(n.left()-p),i.setCenter(d.controlBar.center()),i.setRight(h.left()-p),this.updateLabel()},this.controlBar.updateLabel=function(){var t=d.world().isDevMode?" - "+localize("development mode"):"";this.label&&this.label.destroy(),d.isAppMode||(this.label=new StringMorph((d.projectName||localize("untitled"))+t,14,"sans-serif",!0,!1,!1,MorphicPreferences.isFlat?null:new Point(2,1),d.frameColor.darker(d.buttonContrast)),this.label.color=d.buttonLabelColor,this.label.drawNew(),this.add(this.label),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+p))}},IDE_Morph.prototype.createCategories=function(){function t(t){var e,r=75,i=[o.frameColor,o.frameColor.darker(50),SpriteMorph.prototype.blockColor[t]];return e=new ToggleButtonMorph(i,o,function(){o.currentCategory=t,o.categories.children.forEach(function(t){t.refresh()}),o.refreshPalette(!0)},t[0].toUpperCase().concat(t.slice(1)),function(){return o.currentCategory===t},null,null,null,r,!0),e.corner=8,e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=i[1],e.labelColor=o.buttonLabelColor,e.fixLayout(),e.refresh(),o.categories.add(e),e}function e(){var t,e,r=o.categories.children[0].width(),i=o.categories.children[0].height(),n=3,s=Math.ceil(o.categories.children.length/2),a=(200-n-2*r)/3,h=2,l=o.categories.left(),p=o.categories.top(),c=0;o.categories.children.forEach(function(o){c+=1,t=Math.ceil(c/2),e=2-c%2,o.setPosition(new Point(l+(e*a+(e-1)*r),p+(t*h+(t-1)*i+n)))}),o.categories.setHeight((s+1)*h+s*i+2*n)}var o=this;this.categories&&this.categories.destroy(),this.categories=new Morph,this.categories.color=this.groupColor,this.categories.silentSetWidth(this.paletteWidth),SpriteMorph.prototype.categories.forEach(function(e){contains(["lists","other"],e)||t(e)}),e(),this.add(this.categories)},IDE_Morph.prototype.createPalette=function(t){var e=this;return this.palette&&this.palette.destroy(),t?this.palette=new ScrollFrameMorph(null,null,this.currentSprite.sliderColor):this.palette=this.currentSprite.palette(this.currentCategory),this.palette.isDraggable=!1,this.palette.acceptsDrops=!0,this.palette.contents.acceptsDrops=!1,this.palette.reactToDropOf=function(t){t instanceof DialogBoxMorph?e.world().add(t):t instanceof SpriteMorph?e.removeSprite(t):t instanceof SpriteIconMorph?(t.destroy(),e.removeSprite(t.object)):t instanceof CostumeIconMorph?(e.currentSprite.wearCostume(null),t.destroy()):t.destroy()},this.palette.setWidth(this.logo.width()),this.add(this.palette),this.palette},IDE_Morph.prototype.createPaletteHandle=function(){this.paletteHandle&&this.paletteHandle.destroy(),this.paletteHandle=new PaletteHandleMorph(this.categories),this.add(this.paletteHandle)},IDE_Morph.prototype.createStage=function(){this.stage&&this.stage.destroy(),StageMorph.prototype.frameRate=0,this.stage=new StageMorph(this.globalVariables),this.stage.setExtent(this.stage.dimensions),this.currentSprite instanceof SpriteMorph&&(this.currentSprite.setPosition(this.stage.center().subtract(this.currentSprite.extent().divideBy(2))),this.stage.add(this.currentSprite)),this.add(this.stage)},IDE_Morph.prototype.createStageHandle=function(){this.stageHandle&&this.stageHandle.destroy(),this.stageHandle=new StageHandleMorph(this.stage),this.add(this.stageHandle)},IDE_Morph.prototype.createSpriteBar=function(){function t(t){var e,o=d.rotationStyleColors;return e=new ToggleButtonMorph(o,d,function(){d.currentSprite instanceof SpriteMorph&&(d.currentSprite.rotationStyle=t,d.currentSprite.changed(),d.currentSprite.drawNew(),d.currentSprite.changed()),n.forEach(function(t){t.refresh()})},p[t],function(){return d.currentSprite instanceof SpriteMorph&&d.currentSprite.rotationStyle===t},null,localize(c[t])),e.corner=8,e.labelMinExtent=new Point(11,11),e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=o[1],e.labelColor=d.buttonLabelColor,e.fixLayout(),e.refresh(),n.push(e),e.setPosition(d.spriteBar.position().add(2)),e.setTop(e.top()+(n.length-1)*(e.height()+2)),d.spriteBar.add(e),d.currentSprite instanceof StageMorph&&e.hide(),e}var e,o,r,i,n=[],s=new Point(45,45),a=15,h=this.tabColors,l=new AlignmentMorph("row",2*-a),p=["","",""],c=["don't rotate","can rotate","only face left/right"],d=this;this.spriteBar&&this.spriteBar.destroy(),this.spriteBar=new Morph,this.spriteBar.color=this.frameColor,this.add(this.spriteBar),t(1),t(2),t(0),this.rotationStyleButtons=n,r=new Morph,r.setExtent(s),r.image=this.currentSprite.thumbnail(s),r.setPosition(n[0].topRight().add(new Point(5,3))),this.spriteBar.add(r),r.fps=3,r.step=function(){r.version!==d.currentSprite.version&&(r.image=d.currentSprite.thumbnail(s),r.changed(),r.version=d.currentSprite.version)},e=new InputFieldMorph(this.currentSprite.name),e.setWidth(100),e.contrast=90,e.setPosition(r.topRight().add(new Point(10,3))),this.spriteBar.add(e),e.drawNew(),e.accept=function(){var t=e.getValue();d.currentSprite.setName(d.newSpriteName(t,d.currentSprite)),e.setContents(d.currentSprite.name)},this.spriteBar.reactToEdit=e.accept,o=new ToggleMorph("checkbox",null,function(){d.currentSprite.isDraggable=!d.currentSprite.isDraggable},localize("draggable"),function(){return d.currentSprite.isDraggable}),o.label.isBold=!1,o.label.setColor(this.buttonLabelColor),o.color=h[2],o.highlightColor=h[0],o.pressColor=h[1],o.tick.shadowOffset=MorphicPreferences.isFlat?new Point:new Point(-1,-1),o.tick.shadowColor=new Color,o.tick.color=this.buttonLabelColor,o.tick.isBold=!1,o.tick.drawNew(),o.setPosition(e.bottomLeft().add(2)),o.drawNew(),this.spriteBar.add(o),this.currentSprite instanceof StageMorph&&o.hide(),l.tabTo=function(t){var e;d.currentTab=t,this.children.forEach(function(t){t.refresh(),t.state&&(e=t)}),e.refresh(),d.createSpriteEditor(),d.fixLayout("tabEditor")},i=new TabMorph(h,null,function(){l.tabTo("scripts")},localize("Scripts"),function(){return"scripts"===d.currentTab}),i.padding=3,i.corner=a,i.edge=1,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=h[1],i.labelColor=this.buttonLabelColor,i.drawNew(),i.fixLayout(),l.add(i),i=new TabMorph(h,null,function(){l.tabTo("costumes")},localize("Costumes"),function(){return"costumes"===d.currentTab}),i.padding=3,i.corner=a,i.edge=1,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=h[1],i.labelColor=this.buttonLabelColor,i.drawNew(),i.fixLayout(),l.add(i),i=new TabMorph(h,null,function(){l.tabTo("sounds")},localize("Sounds"),function(){return"sounds"===d.currentTab}),i.padding=3,i.corner=a,i.edge=1,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=h[1],i.labelColor=this.buttonLabelColor,i.drawNew(),i.fixLayout(),l.add(i),l.fixLayout(),l.children.forEach(function(t){t.refresh()}),this.spriteBar.tabBar=l,this.spriteBar.add(this.spriteBar.tabBar),this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left()),this.tabBar.setBottom(this.bottom())}},IDE_Morph.prototype.createSpriteEditor=function(){var t=this.currentSprite.scripts,e=this;this.spriteEditor&&this.spriteEditor.destroy(),"scripts"===this.currentTab?(t.isDraggable=!1,t.color=this.groupColor,t.cachedTexture=this.scriptsPaneTexture,this.spriteEditor=new ScrollFrameMorph(t,null,this.sliderColor),this.spriteEditor.padding=10,this.spriteEditor.growth=50,this.spriteEditor.isDraggable=!1,this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!0,t.scrollFrame=this.spriteEditor,this.add(this.spriteEditor),this.spriteEditor.scrollX(this.spriteEditor.padding),this.spriteEditor.scrollY(this.spriteEditor.padding)):"costumes"===this.currentTab?(this.spriteEditor=new WardrobeMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):"sounds"===this.currentTab?(this.spriteEditor=new JukeboxMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):(this.spriteEditor=new Morph,this.spriteEditor.color=this.groupColor,this.spriteEditor.acceptsDrops=!0,this.spriteEditor.reactToDropOf=function(t){
t instanceof DialogBoxMorph?e.world().add(t):t instanceof SpriteMorph?e.removeSprite(t):t.destroy()},this.add(this.spriteEditor))},IDE_Morph.prototype.createCorralBar=function(){var t,e,o=5,r=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)];this.corralBar&&this.corralBar.destroy(),this.corralBar=new Morph,this.corralBar.color=this.frameColor,this.corralBar.setHeight(this.logo.height()),this.add(this.corralBar),t=new PushButtonMorph(this,"addNewSprite",new SymbolMorph("turtle",14)),t.corner=12,t.color=r[0],t.highlightColor=r[1],t.pressColor=r[2],t.labelMinExtent=new Point(36,18),t.padding=0,t.labelShadowOffset=new Point(-1,-1),t.labelShadowColor=r[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.drawNew(),t.hint="add a new Turtle sprite",t.fixLayout(),t.setCenter(this.corralBar.center()),t.setLeft(this.corralBar.left()+o),this.corralBar.add(t),e=new PushButtonMorph(this,"paintNewSprite",new SymbolMorph("brush",15)),e.corner=12,e.color=r[0],e.highlightColor=r[1],e.pressColor=r[2],e.labelMinExtent=new Point(36,18),e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=r[1],e.labelColor=this.buttonLabelColor,e.contrast=this.buttonContrast,e.drawNew(),e.hint="paint a new sprite",e.fixLayout(),e.setCenter(this.corralBar.center()),e.setLeft(this.corralBar.left()+o+t.width()+o),this.corralBar.add(e)},IDE_Morph.prototype.createCorral=function(){var t,e,o=5,r=this;this.createStageHandle(),this.createPaletteHandle(),this.corral&&this.corral.destroy(),this.corral=new Morph,this.corral.color=this.groupColor,this.add(this.corral),this.corral.stageIcon=new SpriteIconMorph(this.stage),this.corral.stageIcon.isDraggable=!1,this.corral.add(this.corral.stageIcon),t=new ScrollFrameMorph(null,null,this.sliderColor),t.acceptsDrops=!1,t.contents.acceptsDrops=!1,t.contents.wantsDropOf=function(t){return t instanceof SpriteIconMorph},t.contents.reactToDropOf=function(t){r.corral.reactToDropOf(t)},t.alpha=0,this.sprites.asArray().forEach(function(o){o.isClone||(e=new SpriteIconMorph(o,e),t.contents.add(e))}),this.corral.frame=t,this.corral.add(t),this.corral.fixLayout=function(){this.stageIcon.setCenter(this.center()),this.stageIcon.setLeft(this.left()+o),this.frame.setLeft(this.stageIcon.right()+o),this.frame.setExtent(new Point(this.right()-this.frame.left(),this.height())),this.arrangeIcons(),this.refresh()},this.corral.arrangeIcons=function(){var t=this.frame.left(),e=this.frame.top(),o=this.frame.right(),r=this.frame.left();this.frame.contents.children.forEach(function(i){var n=i.width();t+n>o&&(t=r,e+=i.height()),i.setPosition(new Point(t,e)),t+=n}),this.frame.contents.adjustBounds()},this.corral.addSprite=function(t){this.frame.contents.add(new SpriteIconMorph(t)),this.fixLayout()},this.corral.refresh=function(){this.stageIcon.refresh(),this.frame.contents.children.forEach(function(t){t.refresh()})},this.corral.wantsDropOf=function(t){return t instanceof SpriteIconMorph},this.corral.reactToDropOf=function(t){var e=1,o=t.position();t.destroy(),this.frame.contents.children.forEach(function(t){(o.gt(t.position())||o.y>t.bottom())&&(e+=1)}),r.sprites.add(t.object,e),r.createCorral(),r.fixLayout()}},IDE_Morph.prototype.fixLayout=function(t){var e,o=this.padding;Morph.prototype.trackChanges=!1,"refreshPalette"!==t&&(this.controlBar.setPosition(this.logo.topRight()),this.controlBar.setWidth(this.right()-this.controlBar.left()),this.controlBar.fixLayout(),this.categories.setLeft(this.logo.left()),this.categories.setTop(this.logo.bottom()),this.categories.setWidth(this.paletteWidth)),this.palette.setLeft(this.logo.left()),this.palette.setTop(this.categories.bottom()),this.palette.setHeight(this.bottom()-this.palette.top()),this.palette.setWidth(this.paletteWidth),"refreshPalette"!==t&&(this.isAppMode?(this.stage.setScale(Math.floor(10*Math.min((this.width()-2*o)/this.stage.dimensions.x,(this.height()-2*this.controlBar.height()-2*o)/this.stage.dimensions.y))/10),this.stage.setCenter(this.center())):(this.stage.setScale(this.isSmallStage?this.stageRatio:1),this.stage.setTop(this.logo.bottom()+o),this.stage.setRight(this.right()),e=this.width()-this.stage.width()-this.spriteBar.tabBar.width()-2*this.padding,this.paletteWidth>e&&(this.paletteWidth=e,this.fixLayout()),this.stageHandle.fixLayout(),this.paletteHandle.fixLayout()),this.spriteBar.setLeft(this.paletteWidth+o),this.spriteBar.setTop(this.logo.bottom()+o),this.spriteBar.setExtent(new Point(Math.max(0,this.stage.left()-o-this.spriteBar.left()),this.categories.bottom()-this.spriteBar.top()-o)),this.spriteBar.fixLayout(),this.spriteEditor.isVisible&&(this.spriteEditor.setPosition(this.spriteBar.bottomLeft()),this.spriteEditor.setExtent(new Point(this.spriteBar.width(),this.bottom()-this.spriteEditor.top()))),this.corralBar.setLeft(this.stage.left()),this.corralBar.setTop(this.stage.bottom()+o),this.corralBar.setWidth(this.stage.width()),contains(["selectSprite","tabEditor"],t)||(this.corral.setPosition(this.corralBar.bottomLeft()),this.corral.setWidth(this.stage.width()),this.corral.setHeight(this.bottom()-this.corral.top()),this.corral.fixLayout())),Morph.prototype.trackChanges=!0,this.changed()},IDE_Morph.prototype.setProjectName=function(t){this.projectName=t.replace(/['"]/g,""),this.hasChangedMedia=!0,this.controlBar.updateLabel()},IDE_Morph.prototype.setExtent=function(t){var e,o,r,i,n,s,a,h=new Point(430,110);e=this.isAppMode?StageMorph.prototype.dimensions.add(this.controlBar.height()+10):this.stageRatio>1?h.add(StageMorph.prototype.dimensions):h.add(StageMorph.prototype.dimensions.multiplyBy(this.stageRatio)),o=t.max(e),r=o.x-(200+this.spriteBar.tabBar.width()+2*this.padding),i=3*SpriteIconMorph.prototype.thumbSize.x,n=o.y-3.5*SpriteIconMorph.prototype.thumbSize.y,s=i/this.stage.dimensions.x,a=Math.min(r/this.stage.dimensions.x,n/this.stage.dimensions.y),this.stageRatio=Math.min(a,Math.max(s,this.stageRatio)),IDE_Morph.uber.setExtent.call(this,o),this.fixLayout()},IDE_Morph.prototype.reactToWorldResize=function(t){this.isAutoFill&&(this.setPosition(t.origin),this.setExtent(t.extent())),this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null)},IDE_Morph.prototype.droppedImage=function(t,e){var o=new Costume(t,this.currentSprite.newCostumeName(e?e.split(".")[0]:""));return o.isTainted()?void this.inform("Unable to import this image","The picture you wish to import has been\ntainted by a restrictive cross-origin policy\nmaking it unusable for costumes in Snap!. \n\nTry downloading this picture first to your\ncomputer, and import it from there."):(this.currentSprite.addCostume(o),this.currentSprite.wearCostume(o),this.spriteBar.tabBar.tabTo("costumes"),void(this.hasChangedMedia=!0))},IDE_Morph.prototype.droppedSVG=function(t,e){var o=new SVG_Costume(t,e.split(".")[0]);this.currentSprite.addCostume(o),this.currentSprite.wearCostume(o),this.spriteBar.tabBar.tabTo("costumes"),this.hasChangedMedia=!0},IDE_Morph.prototype.droppedAudio=function(t,e){this.currentSprite.addSound(t,e.split(".")[0]),this.spriteBar.tabBar.tabTo("sounds"),this.hasChangedMedia=!0},IDE_Morph.prototype.droppedText=function(t,e){var o=e?e.split(".")[0]:"";return 0===t.indexOf("<project")?(location.hash="",this.openProjectString(t)):0===t.indexOf("<snapdata")?(location.hash="",this.openCloudDataString(t)):0===t.indexOf("<blocks")?this.openBlocksString(t,o,!0):0===t.indexOf("<sprites")?this.openSpritesString(t):0===t.indexOf("<media")?this.openMediaString(t):void 0},IDE_Morph.prototype.droppedBinary=function(t,e){function o(t,e){var o=new sb.Reader,r=e.split(".")[0];o.onload=function(t){i.droppedText((new sb.XMLWriter).write(r,t))},o.readYPR(new Uint8Array(t))}var r=document.getElementById("ypr"),i=this,n=e.substring(e.length-3);"ypr"===n.toLowerCase()&&(r?o(t,e):(r=document.createElement("script"),r.id="ypr",r.onload=function(){o(t,e)},document.head.appendChild(r),r.src="ypr.js"))},IDE_Morph.prototype.refreshPalette=function(t){var e=this.palette.contents.top();this.createPalette(),this.fixLayout("refreshPalette"),t||this.palette.contents.setTop(e)},IDE_Morph.prototype.pressStart=function(){16===this.world().currentKey?this.toggleFastTracking():(this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.runScripts())},IDE_Morph.prototype.toggleFastTracking=function(){this.stage.isFastTracked?this.stopFastTracking():this.startFastTracking()},IDE_Morph.prototype.toggleVariableFrameRate=function(){StageMorph.prototype.frameRate?(StageMorph.prototype.frameRate=0,this.stage.fps=0):(StageMorph.prototype.frameRate=30,this.stage.fps=30)},IDE_Morph.prototype.startFastTracking=function(){this.stage.isFastTracked=!0,this.stage.fps=0,this.controlBar.startButton.labelString=new SymbolMorph("flash",14),this.controlBar.startButton.drawNew(),this.controlBar.startButton.fixLayout()},IDE_Morph.prototype.stopFastTracking=function(){this.stage.isFastTracked=!1,this.stage.fps=this.stage.frameRate,this.controlBar.startButton.labelString=new SymbolMorph("flag",14),this.controlBar.startButton.drawNew(),this.controlBar.startButton.fixLayout()},IDE_Morph.prototype.runScripts=function(){this.stage.fireGreenFlagEvent()},IDE_Morph.prototype.togglePauseResume=function(){this.stage.threads.isPaused()?this.stage.threads.resumeAll(this.stage):this.stage.threads.pauseAll(this.stage),this.controlBar.pauseButton.refresh()},IDE_Morph.prototype.isPaused=function(){return!!this.stage&&this.stage.threads.isPaused()},IDE_Morph.prototype.stopAllScripts=function(){this.stage.enableCustomHatBlocks?this.stage.threads.pauseCustomHatBlocks=!this.stage.threads.pauseCustomHatBlocks:this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.stage.fireStopAllEvent()},IDE_Morph.prototype.selectSprite=function(t){this.currentSprite&&this.currentSprite.scripts.focus&&this.currentSprite.scripts.focus.stopEditing(),this.currentSprite=t,this.createPalette(),this.createSpriteBar(),this.createSpriteEditor(),this.corral.refresh(),this.fixLayout("selectSprite"),this.currentSprite.scripts.fixMultiArgs()},IDE_Morph.prototype.toggleRetina=function(){isRetinaEnabled()?disableRetinaSupport():enableRetinaSupport(),this.world().fillPage(),IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture(),this.stage.clearPenTrails(),this.drawNew(),this.refreshIDE()},IDE_Morph.prototype.defaultDesign=function(){this.setDefaultDesign(),this.refreshIDE(),this.removeSetting("design")},IDE_Morph.prototype.flatDesign=function(){this.setFlatDesign(),this.refreshIDE(),this.saveSetting("design","flat")},IDE_Morph.prototype.refreshIDE=function(){var t;if(Process.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else t=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.buildPanes(),this.fixLayout(),this.loadNewProject?this.newProject():this.openProjectString(t)},IDE_Morph.prototype.applySavedSettings=function(){var t=this.getSetting("design"),e=this.getSetting("zoom"),o=this.getSetting("language"),r=this.getSetting("click"),i=this.getSetting("longform"),n=this.getSetting("longurls"),s=this.getSetting("plainprototype"),a=this.getSetting("keyboard"),h=this.getSetting("tables"),l=this.getSetting("tableLines");"flat"===t?this.setFlatDesign():this.setDefaultDesign(),e&&(SyntaxElementMorph.prototype.setScale(Math.min(e,12)),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks()),o&&"en"!==o?this.userLanguage=o:this.userLanguage=null,r&&!BlockMorph.prototype.snapSound&&BlockMorph.prototype.toggleSnapSound(),i&&(InputSlotDialogMorph.prototype.isLaunchingExpanded=!0),n?this.projectsInURLs=!0:this.projectsInURLs=!1,"false"===a?ScriptsMorph.prototype.enableKeyboard=!1:ScriptsMorph.prototype.enableKeyboard=!0,"false"===h?List.prototype.enableTables=!1:List.prototype.enableTables=!0,l?TableMorph.prototype.highContrast=!0:TableMorph.prototype.highContrast=!1,s&&(BlockLabelPlaceHolderMorph.prototype.plainLabel=!0)},IDE_Morph.prototype.saveSetting=function(t,e){localStorage&&(localStorage["-snap-setting-"+t]=e)},IDE_Morph.prototype.getSetting=function(t){return localStorage?localStorage["-snap-setting-"+t]:null},IDE_Morph.prototype.removeSetting=function(t){localStorage&&delete localStorage["-snap-setting-"+t]},IDE_Morph.prototype.addNewSprite=function(){var t=new SpriteMorph(this.globalVariables),e=Process.prototype.reportRandom;t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),this.stage.add(t),t.setHue(e.call(this,0,100)),t.setBrightness(e.call(this,50,100)),t.turn(e.call(this,1,360)),t.setXPosition(e.call(this,-220,220)),t.setYPosition(e.call(this,-160,160)),this.sprites.add(t),this.corral.addSprite(t),this.selectSprite(t)},IDE_Morph.prototype.paintNewSprite=function(){var t=new SpriteMorph(this.globalVariables),e=new Costume,o=this;t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),this.stage.add(t),this.sprites.add(t),this.corral.addSprite(t),this.selectSprite(t),e.edit(this.world(),this,!0,function(){o.removeSprite(t)},function(){t.addCostume(e),t.wearCostume(e)})},IDE_Morph.prototype.duplicateSprite=function(t){var e=t.fullCopy();e.setPosition(this.world().hand.position()),e.appearIn(this),e.keepWithin(this.stage),this.selectSprite(e)},IDE_Morph.prototype.removeSprite=function(t){var e,o=this;t.parts.forEach(function(t){o.removeSprite(t)}),e=this.sprites.asArray().indexOf(t)+1,this.stage.threads.stopAllForReceiver(t),t.corpsify(),t.destroy(),this.stage.watchers().forEach(function(e){e.object()===t&&e.destroy()}),e>0&&this.sprites.remove(e),this.createCorral(),this.fixLayout(),this.currentSprite=detect(this.stage.children,function(t){return t instanceof SpriteMorph})||this.stage,this.selectSprite(this.currentSprite)},IDE_Morph.prototype.newSpriteName=function(t,e){for(var o=t.indexOf("("),r=o<0?t:t.substring(0,o),i=1,n=r,s=this.sprites.asArray().concat(this.stage).filter(function(t){return t!==e}).map(function(t){return t.name});contains(s,n);)i+=1,n=r+"("+i+")";return n},IDE_Morph.prototype.userMenu=function(){var t=new MenuMorph(this);return t},IDE_Morph.prototype.snapMenu=function(){var t,e=this,o=this.world();t=new MenuMorph(this),t.addItem("About...","aboutSnap"),t.addLine(),t.addItem("Reference manual",function(){var t=e.resourceURL("help","SnapManual.pdf");window.open(t,"SnapReferenceManual")}),t.addItem("Snap! website",function(){window.open("http://snap.berkeley.edu/","SnapWebsite")}),t.addItem("Download source",function(){window.open("http://snap.berkeley.edu/snapsource/snap.zip","SnapSource")}),o.isDevMode?(t.addLine(),t.addItem("Switch back to user mode","switchToUserMode","disable deep-Morphic\ncontext menus\nand show user-friendly ones",new Color(0,100,0))):16===o.currentKey&&(t.addLine(),t.addItem("Switch to dev mode","switchToDevMode","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!",new Color(100,0,0))),t.popup(o,this.logo.bottomLeft())},IDE_Morph.prototype.cloudMenu=function(){var t,e=this,o=this.world(),r=this.controlBar.cloudButton.bottomLeft(),i=16===o.currentKey;t=new MenuMorph(this),i&&(t.addItem("url...","setCloudURL",null,new Color(100,0,0)),t.addLine()),SnapCloud.username?(t.addItem(localize("Logout")+" "+SnapCloud.username,"logout"),t.addItem("Change Password...","changeCloudPassword")):(t.addItem("Login...","initializeCloud"),t.addItem("Signup...","createCloudAccount"),t.addItem("Reset Password...","resetCloudPassword")),i&&(t.addLine(),t.addItem("export project media only...",function(){e.projectName?e.exportProjectMedia(e.projectName):e.prompt("Export Project As...",function(t){e.exportProjectMedia(t)},null,"exportProject")},null,this.hasChangedMedia?new Color(100,0,0):new Color(0,100,0)),t.addItem("export project without media...",function(){e.projectName?e.exportProjectNoMedia(e.projectName):e.prompt("Export Project As...",function(t){e.exportProjectNoMedia(t)},null,"exportProject")},null,new Color(100,0,0)),t.addItem("export project as cloud data...",function(){e.projectName?e.exportProjectAsCloudData(e.projectName):e.prompt("Export Project As...",function(t){e.exportProjectAsCloudData(t)},null,"exportProject")},null,new Color(100,0,0)),t.addLine(),t.addItem("open shared project from cloud...",function(){e.prompt("Author name",function(t){e.prompt("Project name...",function(o){var r="Username="+encodeURIComponent(t.toLowerCase())+"&ProjectName="+encodeURIComponent(o);e.showMessage("Fetching project\nfrom the cloud..."),SnapCloud.getPublicProject(r,function(t){var o;Process.prototype.isCatchingErrors||window.open("data:text/xml,"+t),e.nextSteps([function(){o=e.showMessage("Opening project...")},function(){nop()},function(){e.rawOpenCloudDataString(t)},function(){o.destroy()}])},e.cloudError())},null,"project")},null,"project")},null,new Color(100,0,0))),t.popup(o,r)},IDE_Morph.prototype.settingsMenu=function(){function t(t,o,r,i,n,a){var h=" ",l=" ";a&&!s||e.addItem((r?h:l)+localize(t),o,r?i:n,a?new Color(100,0,0):null)}var e,o=this.stage,r=this.world(),i=this,n=this.controlBar.settingsButton.bottomLeft(),s=16===r.currentKey;e=new MenuMorph(this),e.addItem("Language...","languageMenu"),e.addItem("Zoom blocks...","userSetBlocksScale"),e.addItem("Stage size...","userSetStageSize"),s&&e.addItem("Dragging threshold...","userSetDragThreshold","specify the distance the hand has to move\nbefore it picks up an object",new Color(100,0,0)),e.addLine(),isRetinaSupported()&&t("Retina display support","toggleRetina",isRetinaEnabled(),"uncheck for lower resolution,\nsaves computing resources","check for higher resolution,\nuses more computing resources"),t("Blurred shadows","toggleBlurredShadows",useBlurredShadows,"uncheck to use solid drop\nshadows and highlights","check to use blurred drop\nshadows and highlights",!0),t("Zebra coloring","toggleZebraColoring",BlockMorph.prototype.zebraContrast,"uncheck to disable alternating\ncolors for nested block","check to enable alternating\ncolors for nested blocks",!0),t("Dynamic input labels","toggleDynamicInputLabels",SyntaxElementMorph.prototype.dynamicInputLabels,"uncheck to disable dynamic\nlabels for variadic inputs","check to enable dynamic\nlabels for variadic inputs",!0),t("Prefer empty slot drops","togglePreferEmptySlotDrops",ScriptsMorph.prototype.isPreferringEmptySlots,"uncheck to allow dropped\nreporters to kick out others","settings menu prefer empty slots hint",!0),t("Long form input dialog","toggleLongFormInputDialog",InputSlotDialogMorph.prototype.isLaunchingExpanded,"uncheck to use the input\ndialog in short form","check to always show slot\ntypes in the input dialog"),t("Plain prototype labels","togglePlainPrototypeLabels",BlockLabelPlaceHolderMorph.prototype.plainLabel,"uncheck to always show (+) symbols\nin block prototype labels","check to hide (+) symbols\nin block prototype labels"),t("Virtual keyboard","toggleVirtualKeyboard",MorphicPreferences.useVirtualKeyboard,"uncheck to disable\nvirtual keyboard support\nfor mobile devices","check to enable\nvirtual keyboard support\nfor mobile devices",!0),t("Input sliders","toggleInputSliders",MorphicPreferences.useSliderForInput,"uncheck to disable\ninput sliders for\nentry fields","check to enable\ninput sliders for\nentry fields"),MorphicPreferences.useSliderForInput&&t("Execute on slider change","toggleSliderExecute",ArgMorph.prototype.executeOnSliderEdit,"uncheck to supress\nrunning scripts\nwhen moving the slider","check to run\nthe edited script\nwhen moving the slider"),t("Clicking sound",function(){BlockMorph.prototype.toggleSnapSound(),BlockMorph.prototype.snapSound?i.saveSetting("click",!0):i.removeSetting("click")},BlockMorph.prototype.snapSound,"uncheck to turn\nblock clicking\nsound off","check to turn\nblock clicking\nsound on"),t("Animations",function(){i.isAnimating=!i.isAnimating},i.isAnimating,"uncheck to disable\nIDE animations","check to enable\nIDE animations",!0),t("Turbo mode","toggleFastTracking",this.stage.isFastTracked,"uncheck to run scripts\nat normal speed","check to prioritize\nscript execution"),t("Cache Inputs",function(){BlockMorph.prototype.isCachingInputs=!BlockMorph.prototype.isCachingInputs},BlockMorph.prototype.isCachingInputs,"uncheck to stop caching\ninputs (for debugging the evaluator)","check to cache inputs\nboosts recursion",!0),t("Rasterize SVGs",function(){MorphicPreferences.rasterizeSVGs=!MorphicPreferences.rasterizeSVGs},MorphicPreferences.rasterizeSVGs,"uncheck for smooth\nscaling of vector costumes","check to rasterize\nSVGs on import",!0),t("Flat design",function(){return MorphicPreferences.isFlat?i.defaultDesign():void i.flatDesign()},MorphicPreferences.isFlat,"uncheck for default\nGUI design","check for alternative\nGUI design",!1),t("Project URLs",function(){i.projectsInURLs=!i.projectsInURLs,i.projectsInURLs?i.saveSetting("longurls",!0):i.removeSetting("longurls")},i.projectsInURLs,"uncheck to disable\nproject data in URLs","check to enable\nproject data in URLs",!0),t("Sprite Nesting",function(){SpriteMorph.prototype.enableNesting=!SpriteMorph.prototype.enableNesting},SpriteMorph.prototype.enableNesting,"uncheck to disable\nsprite composition","check to enable\nsprite composition",!0),t("First-Class Sprites",function(){SpriteMorph.prototype.enableFirstClass=!SpriteMorph.prototype.enableFirstClass,i.currentSprite.blocksCache.sensing=null,i.currentSprite.paletteCache.sensing=null,i.refreshPalette()},SpriteMorph.prototype.enableFirstClass,"uncheck to disable support\nfor first-class sprites","check to enable support\n for first-class sprite",!0),t("Keyboard Editing",function(){ScriptsMorph.prototype.enableKeyboard=!ScriptsMorph.prototype.enableKeyboard,ScriptsMorph.prototype.enableKeyboard?i.removeSetting("keyboard"):i.saveSetting("keyboard",!1)},ScriptsMorph.prototype.enableKeyboard,"uncheck to disable\nkeyboard editing support","check to enable\nkeyboard editing support",!1),t("Table support",function(){List.prototype.enableTables=!List.prototype.enableTables,List.prototype.enableTables?i.removeSetting("tables"):i.saveSetting("tables",!1)},List.prototype.enableTables,"uncheck to disable\nmulti-column list views","check for multi-column\nlist view support",!1),List.prototype.enableTables&&t("Table lines",function(){TableMorph.prototype.highContrast=!TableMorph.prototype.highContrast,TableMorph.prototype.highContrast?i.saveSetting("tableLines",!0):i.removeSetting("tableLines")},TableMorph.prototype.highContrast,"uncheck for less contrast\nmulti-column list views","check for higher contrast\ntable views",!1),t("Live coding support",function(){Process.prototype.enableLiveCoding=!Process.prototype.enableLiveCoding},Process.prototype.enableLiveCoding,"EXPERIMENTAL! uncheck to disable live\ncustom control structures","EXPERIMENTAL! check to enable\n live custom control structures",!0),e.addLine(),t("Thread safe scripts",function(){o.isThreadSafe=!o.isThreadSafe},this.stage.isThreadSafe,"uncheck to allow\nscript reentrance","check to disallow\nscript reentrance"),t("Prefer smooth animations","toggleVariableFrameRate",StageMorph.prototype.frameRate,"uncheck for greater speed\nat variable frame rates","check for smooth, predictable\nanimations across computers"),t("Flat line ends",function(){SpriteMorph.prototype.useFlatLineEnds=!SpriteMorph.prototype.useFlatLineEnds},SpriteMorph.prototype.useFlatLineEnds,"uncheck for round ends of lines","check for flat ends of lines"),t("Codification support",function(){StageMorph.prototype.enableCodeMapping=!StageMorph.prototype.enableCodeMapping,i.currentSprite.blocksCache.variables=null,i.currentSprite.paletteCache.variables=null,i.refreshPalette()},StageMorph.prototype.enableCodeMapping,"uncheck to disable\nblock to text mapping features","check for block\nto text mapping features",!1),t("Inheritance support",function(){StageMorph.prototype.enableInheritance=!StageMorph.prototype.enableInheritance,i.currentSprite.blocksCache.variables=null,i.currentSprite.paletteCache.variables=null,i.refreshPalette()},StageMorph.prototype.enableInheritance,"uncheck to disable\nsprite inheritance features","check for sprite\ninheritance features",!1),t("Persist linked sublist IDs",function(){StageMorph.prototype.enableSublistIDs=!StageMorph.prototype.enableSublistIDs},StageMorph.prototype.enableSublistIDs,"uncheck to disable\nsaving linked sublist identities","check to enable\nsaving linked sublist identities",!0),e.popup(r,n)},IDE_Morph.prototype.projectMenu=function(){function t(t,e){return function(){var n=this.getMediaList(t),s=new MenuMorph(o,localize("Import")+" "+localize(t));n.forEach(function(t){s.addItem(t.name,function(){e(t.file,t.name)},t.help)}),s.popup(r,i)}}var e,o=this,r=this.world(),i=this.controlBar.projectButton.bottomLeft(),n=this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds",s=16===r.currentKey;e=new MenuMorph(this),e.addItem("Project notes...","editProjectNotes"),e.addLine(),e.addItem("New","createNewProject"),e.addItem("Open...","openProjectsBrowser"),e.addItem("Save","save"),e.addItem("Save As...","saveProjectsBrowser"),e.addLine(),e.addItem("Import...",function(){var t=document.createElement("input");o.filePicker&&(document.body.removeChild(o.filePicker),o.filePicker=null),t.type="file",t.style.color="transparent",t.style.backgroundColor="transparent",t.style.border="none",t.style.outline="none",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="0px",t.style.height="0px",t.addEventListener("change",function(){document.body.removeChild(t),o.filePicker=null,r.hand.processDrop(t.files)},!1),document.body.appendChild(t),o.filePicker=t,t.click()},"file menu import hint"),s&&e.addItem(localize("Export project...")+" "+localize("(in a new window)"),function(){o.projectName?o.exportProject(o.projectName,s):o.prompt("Export Project As...",function(t){o.exportProject(t,!1,!0)},null,"exportProject")},"show project data as XML\nin a new browser window",new Color(100,0,0)),e.addItem(s?"Export project as plain text...":"Export project...",function(){o.projectName?o.exportProject(o.projectName,s):o.prompt("Export Project As...",function(t){o.exportProject(t,s)},null,"exportProject")},"save project data as XML\nto your downloads folder",s?new Color(100,0,0):null),this.stage.globalBlocks.length&&(e.addItem("Export blocks...",function(){o.exportGlobalBlocks()},"show global custom block definitions as XML\nin a new browser window"),e.addItem("Unused blocks...",function(){o.removeUnusedBlocks()},"find unused global custom blocks\nand remove their definitions")),e.addItem("Export summary...",function(){o.exportProjectSummary()},"open a new browser browser window\n with a summary of this project"),s&&(e.addItem("Export summary with drop-shadows...",function(){o.exportProjectSummary(!0)},"open a new browser browser window\nwith a summary of this project\nwith drop-shadows on all pictures.\nnot supported by all browsers",new Color(100,0,0)),e.addItem("Export all scripts as pic...",function(){o.exportScriptsPicture()},"show a picture of all scripts\nand block definitions",new Color(100,0,0))),e.addLine(),e.addItem("Import tools",function(){o.droppedText(o.getURL(o.resourceURL("tools.xml")),"tools")},"load the official library of\npowerful blocks"),e.addItem("Libraries...",t("libraries",function(t,e){var r=o.resourceURL("libraries",t);o.droppedText(o.getURL(r),e)}),"Select categories of additional blocks to add to this project."),e.addItem(localize(n)+"...",function(){o.importMedia(n)},"Select a costume from the media library"),e.addItem(localize("Sounds")+"...",t("Sounds",function(t,e){var r=o.resourceURL("Sounds",t),i=new Audio;i.src=r,i.load(),o.droppedAudio(i,e)}),"Select a sound from the media library"),e.popup(r,i)},IDE_Morph.prototype.resourceURL=function(){var t=Array.prototype.slice.call(arguments,0);return t.join("/")},IDE_Morph.prototype.getMediaList=function(t){var e,o;return e=this.resourceURL(t,t.toUpperCase()),o=this.parseResourceFile(this.getURL(e)),o.sort(function(t,e){return t.name.toLowerCase()<e.name.toLowerCase()?-1:1}),o},IDE_Morph.prototype.parseResourceFile=function(t){var e,o=[],r="//",i="\t";return t=t.split(/\n|\r\n/),t.map(function(t){return t.trim()}).filter(function(t){return t.length>0&&t[0]!==r}).forEach(function(t){e=t.split(i),e=e.map(function(t){return t.trim()}),e.length<2||o.push({file:e[0],name:e[1],help:e.length>2?e[2]:""})}),o},IDE_Morph.prototype.importMedia=function(t){var e,o=(new DialogBoxMorph).withKey("import"+t),r=new ScrollFrameMorph,i=null,n=new SymbolMorph("turtle",60),s=this.getMediaList(t),a=this,h=this.world();r.acceptsDrops=!1,r.contents.acceptsDrops=!1,r.color=a.groupColor,r.fixLayout=nop,o.labelString=t,o.createLabel(),o.addBody(r),o.addButton("ok","Import"),o.addButton("cancel","Cancel"),o.ok=function(){i&&a.droppedImage(i.object.contents,i.labelString)},o.fixLayout=function(){var t,e,o=fontHeight(this.titleFontSize)+2*this.titlePadding,i=0,n=0;this.buttons.fixLayout(),this.body.setPosition(this.position().add(new Point(this.padding,o+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-o-this.buttons.height())),t=this.body.position(),e=this.body.width(),r.contents.children.forEach(function(o){o.setPosition(t.add(new Point(i,n))),i+=o.width(),i+o.width()>e&&(i=0,n+=o.height())}),r.contents.adjustBounds(),this.label.setCenter(this.center()),this.label.setTop(this.top()+(o-this.label.height())/2),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)},s.forEach(function(e){var s=a.resourceURL(t,e.file),h=new Image,l=new CostumeIconMorph(new Costume(n.image,e.name));l.isDraggable=!1,l.userMenu=nop,l.action=function(){if(i!==l){var t=i;i=l,t&&t.refresh()}},l.doubleClickAction=o.ok,l.query=function(){return l===i},r.addContents(l),h.onload=function(){var t=newCanvas(new Point(h.width,h.height),!0);t.getContext("2d").drawImage(h,0,0),l.object=new Costume(t,e.name),l.refresh()},h.src=s}),o.popUp(h),o.setExtent(new Point(400,300)),o.setCenter(h.center()),o.drawNew(),e=new HandleMorph(o,300,280,o.corner,o.corner)},IDE_Morph.prototype.aboutSnap=function(){var t,e,o,r,i,n,s,a,h,l,p,c,d="",u=this.world();e="Snap! 4.0.8.7\nBuild Your Own Blocks\n\nCopyright  2016 Jens Mnig and Brian Harvey\njens@moenig.org, bh@cs.berkeley.edu\n\nSnap! is developed by the University of California, Berkeley\n          with support from the National Science Foundation (NSF), MioSoft,          \nthe Communications Design Group (CDG) at SAP Labs, and the\nHuman Advancement Research Community (HARC) at YC Research.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see http://snap.berkeley.edu\nand http://scratch.mit.edu",o=localize("License")+"\n\nSnap! is free software: you can redistribute it and/or modify\nit under the terms of the GNU Affero General Public License as\npublished by the Free Software Foundation, either version 3 of\nthe License, or (at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\nGNU Affero General Public License for more details.\n\nYou should have received a copy of the\nGNU Affero General Public License along with this program.\nIf not, see http://www.gnu.org/licenses/",r=localize("Contributors")+'\n\nNathan Dinsmore: Saving/Loading, Snap-Logo Design, \ncountless bugfixes and optimizations\nKartik Chandra: Paint Editor\nMichael Ball: Time/Date UI, many bugfixes\nBartosz Leper: Retina Display Support\n"Ava" Yuan Yuan, Dylan Servilla: Graphic Effects\nKyle Hotchkiss: Block search design\nIan Reynolds: UI Design, Event Bindings, Sound primitives\nIvan Motyashov: Initial Squeak Porting\nDavide Della Casa: Morphic Optimizations\nAchal Dave: Web Audio\nJoe Otto: Morphic Testing and Debugging';for(n in modules)Object.prototype.hasOwnProperty.call(modules,n)&&(d+="\n"+n+" ("+modules[n]+")");
""!==d&&(d=localize("current module versions:")+" \n\nmorphic ("+morphicVersion+")"+d),i=localize("Translations")+"\n"+SnapTranslator.credits(),t=new DialogBoxMorph,t.inform("About Snap",e,u),s=t.buttons.children[0],c=t.addButton(function(){t.body.text=i,t.body.drawNew(),s.show(),a.show(),h.hide(),l.hide(),p.hide(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(u.center())},"Translators..."),a=t.addButton(function(){t.body.text=e,t.body.drawNew(),s.show(),a.hide(),h.show(),l.show(),p.show(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(u.center())},"Back..."),a.hide(),p=t.addButton(function(){t.body.text=o,t.body.drawNew(),s.show(),a.show(),h.hide(),l.hide(),p.hide(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(u.center())},"License..."),h=t.addButton(function(){t.body.text=d,t.body.drawNew(),s.show(),a.show(),h.hide(),l.hide(),p.hide(),c.hide(),t.fixLayout(),t.drawNew(),t.setCenter(u.center())},"Modules..."),l=t.addButton(function(){t.body.text=r,t.body.drawNew(),s.show(),a.show(),c.show(),h.hide(),l.hide(),p.hide(),t.fixLayout(),t.drawNew(),t.setCenter(u.center())},"Credits..."),c.hide(),t.fixLayout(),t.drawNew()},IDE_Morph.prototype.editProjectNotes=function(){var t=(new DialogBoxMorph).withKey("projectNotes"),e=new ScrollFrameMorph,o=new TextMorph(this.projectNotes||""),r=t.ok,i=this,n=250,s=this.world();e.padding=6,e.setWidth(n),e.acceptsDrops=!1,e.contents.acceptsDrops=!1,o.setWidth(n-2*e.padding),o.setPosition(e.topLeft().add(e.padding)),o.enableSelecting(),o.isEditable=!0,e.setHeight(n),e.fixLayout=nop,e.edge=InputFieldMorph.prototype.edge,e.fontSize=InputFieldMorph.prototype.fontSize,e.typeInPadding=InputFieldMorph.prototype.typeInPadding,e.contrast=InputFieldMorph.prototype.contrast,e.drawNew=InputFieldMorph.prototype.drawNew,e.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,e.addContents(o),o.drawNew(),t.ok=function(){i.projectNotes=o.text,r.call(this)},t.justDropped=function(){o.edit()},t.labelString="Project Notes",t.createLabel(),t.addBody(e),e.drawNew(),t.addButton("ok","OK"),t.addButton("cancel","Cancel"),t.fixLayout(),t.drawNew(),t.popUp(s),t.setCenter(s.center()),o.edit()},IDE_Morph.prototype.newProject=function(){this.source=SnapCloud.username?"cloud":"local",this.stage&&this.stage.destroy(),"#lang:"!==location.hash.substr(0,6)&&(location.hash=""),this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,StageMorph.prototype.enableSublistIDs=!1,SpriteMorph.prototype.useFlatLineEnds=!1,Process.prototype.enableLiveCoding=!1,this.setProjectName(""),this.projectNotes="",this.createStage(),this.add(this.stage),this.createCorral(),this.selectSprite(this.stage.children[0]),this.fixLayout()},IDE_Morph.prototype.save=function(){"examples"===this.source&&(this.source="local"),this.projectName?"local"===this.source?this.saveProject(this.projectName):this.saveProjectToCloud(this.projectName):this.saveProjectsBrowser()},IDE_Morph.prototype.saveProject=function(t){var e=this;this.nextSteps([function(){e.showMessage("Saving...")},function(){e.rawSaveProject(t)}])},IDE_Morph.prototype.rawSaveProject=function(t){var e;if(t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{localStorage["-snap-project-"+t]=e=this.serializer.serialize(this.stage),this.setURL("#open:"+e),this.showMessage("Saved!",1)}catch(t){this.showMessage("Save failed: "+t)}else localStorage["-snap-project-"+t]=e=this.serializer.serialize(this.stage),this.setURL("#open:"+e),this.showMessage("Saved!",1)},IDE_Morph.prototype.exportProject=function(t,e,o){var r,i,n;if(t){this.setProjectName(t),n="plain,";try{r=this.showMessage("Exporting"),i=this.serializer.serialize(this.stage),this.setURL("#open:"+n+encodeURIComponent(i)),this.saveXMLAs(i,t,o),r.destroy(),this.showMessage("Exported!",1)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.showMessage("Export failed: "+t)}}},IDE_Morph.prototype.exportGlobalBlocks=function(){this.stage.globalBlocks.length>0?new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks).popUp(this.world()):this.inform("Export blocks","this project doesn't have any\ncustom global blocks yet")},IDE_Morph.prototype.removeUnusedBlocks=function(){function t(){return r.filter(function(t){return!contains(i,t)&&o.every(function(e,o){return!e.usesBlockInstance(t,!0,o,i)})})}for(var e,o=this.sprites.asArray().concat([this.stage]),r=this.stage.globalBlocks,i=[],n=!1;!n;)e=t(),e.length?i=i.concat(e):n=!0;i.length>0?new BlockRemovalDialogMorph(i,this.stage).popUp(this.world()):this.inform("Remove unused blocks","there are currently no unused\nglobal custom blocks in this project")},IDE_Morph.prototype.exportSprite=function(t){var e=this.serializer.serialize(t.allParts());e='<sprites app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+e+"</sprites>",this.saveXMLAs(e,t.name)},IDE_Morph.prototype.exportScriptsPicture=function(){var t,e,o=[],r=20,i=0,n=0,s=0;this.sprites.asArray().forEach(function(t){o.push(t.image),o.push(t.scripts.scriptsPicture()),t.customBlocks.forEach(function(t){o.push(t.scriptsPicture())})}),o.push(this.stage.image),o.push(this.stage.scripts.scriptsPicture()),this.stage.customBlocks.forEach(function(t){o.push(t.scriptsPicture())}),this.stage.globalBlocks.forEach(function(t){o.push(t.scriptsPicture())}),o=o.filter(function(t){return!isNil(t)}),o.forEach(function(t){i=Math.max(i,t.width),n+=t.height,n+=r}),n-=r,t=newCanvas(new Point(i,n)),e=t.getContext("2d"),o.forEach(function(t){e.drawImage(t,0,s),s+=r,s+=t.height}),this.saveCanvasAs(t,this.projectName||localize("Untitled"),!0)},IDE_Morph.prototype.exportProjectSummary=function(t){function e(t,e,o){return e||(e=p),new XML_Element(t,o,e)}function o(t,e,o){return e||(e="p"),o||(o=p),new XML_Element(e,t,o)}function r(t,o,r){o||(o=p);var i=r?null:e("p",o),n=e("img",i||o);return n.attributes.src=t.toDataURL(),n}function i(t){var i,n=t.names().sort(),s=!0;n.length&&(o(localize("Variables"),"h3"),n.forEach(function(o){var n,a,h,l;s&&(i=e("ul"),s=!1),h=e("li",i),n=new WatcherMorph(o,SpriteMorph.prototype.blockColor.variables,t,o),a=n.cellMorph.contentsMorph,a instanceof ListWatcherMorph&&a.expand(),l=r(n.fullImageClassic(),h),l.attributes.class="script"}))}function n(t){t.length&&(o(localize("Blocks"),"h3"),SpriteMorph.prototype.categories.forEach(function(i){var n,s=!0;t.forEach(function(t){var a,h;t.category===i&&(s&&(o(localize(i[0].toUpperCase().concat(i.slice(1))),"h4"),n=e("ul"),s=!1),a=e("li",n),h=r(t.templateInstance().scriptPic(),a),h.attributes.class="script",t.sortedElements().forEach(function(t){var e=r(t instanceof BlockMorph?t.scriptPic():t.fullImageClassic(),a);e.attributes.class="script"}))})}))}var s,a,h,l,p,c,d,u,g,f=this.stage;c=this.projectName||localize("untitled"),s=new XML_Element("html"),a=e("head",s),h=e("meta",a),h.attributes["http-equiv"]="Content-Type",h.attributes.content="text/html; charset=UTF-8",l=t?"img {vertical-align: top;filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-webkit-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-ms-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}":"img {vertical-align: top;}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}.sprite {border: 1px solid lightgray;}",e("style",a,l),o(c,"title",a),p=e("body",s),o(c,"h1"),0===location.hash.indexOf("#present:")?(o(location.toString(),"a",p).attributes.href=location.toString(),r(f.thumbnail(f.dimensions)).attributes.class="sprite",o(this.serializer.app,"h4")):(o(this.serializer.app,"h4"),r(f.thumbnail(f.dimensions)).attributes.class="sprite"),d=Process.prototype.reportTextSplit(this.projectNotes,"line"),d.asArray().forEach(function(t){o(t)}),o(localize("Contents"),"h4"),u=e("ul"),this.sprites.asArray().concat([f]).forEach(function(t){var s,a,h=e("li",u),l=t.scripts.sortedElements(),p=t.costumes.length();e("hr"),r(t.thumbnail(new Point(40,40)),h,!0).attributes.class="toc",o(t.name,"a",h).attributes.href="#"+t.name,o(t.name,"h2").attributes.id=t.name,s=r(t.thumbnail(t.extent().divideBy(f.scale))),s.attributes.class="sprite",t instanceof SpriteMorph&&(t.exemplar&&(r(t.exemplar.thumbnail(new Point(40,40)),o(localize("Kind of")+" "+t.exemplar.name),!0).attributes.class="toc"),t.anchor&&(r(t.anchor.thumbnail(new Point(40,40)),o(localize("Part of")+" "+t.anchor.name),!0).attributes.class="toc"),t.parts.length&&(o(localize("Parts"),"h3"),a=e("ul"),t.parts.forEach(function(t){var o=e("li",a,t.name);r(t.thumbnail(new Point(40,40)),o,!0).attributes.class="toc"}))),(p>1||t.getCostumeIdx()!==p)&&(o(localize("Costumes"),"h3"),a=e("ol"),t.costumes.asArray().forEach(function(t){var o=e("li",a,t.name);r(t.thumbnail(new Point(40,40)),o,!0).attributes.class="toc"})),t.sounds.length()&&(o(localize("Sounds"),"h3"),a=e("ol"),t.sounds.asArray().forEach(function(t){o(t.name,"li",a)})),i(t.variables),l.length&&(o(localize("Scripts"),"h3"),l.forEach(function(t){var e=r(t instanceof BlockMorph?t.scriptPic():t.fullImageClassic());e.attributes.class="script"})),n(t.customBlocks)}),g=f.globalVariables(),(Object.keys(g.vars).length||f.globalBlocks.length)&&(e("hr"),o(localize("For all Sprites"),"a",e("li",u)).attributes.href="#global",o(localize("For all Sprites"),"h2").attributes.id="global",i(g),n(f.globalBlocks)),this.saveFileAs("<!DOCTYPE html>"+s.toString(),"text/html;charset=utf-8,",c,!0)},IDE_Morph.prototype.openProjectString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening project...")},function(){nop()},function(){o.rawOpenProjectString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenProjectString=function(t){if(this.toggleAppMode(!1),this.spriteBar.tabBar.tabTo("scripts"),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,StageMorph.prototype.enableSublistIDs=!1,Process.prototype.enableLiveCoding=!1,Process.prototype.isCatchingErrors)try{this.serializer.openProject(this.serializer.load(t,this),this)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.openProject(this.serializer.load(t,this),this);this.stopFastTracking()},IDE_Morph.prototype.openCloudDataString=function(t){var e,o=this,r=Math.round(t.length/1024);this.nextSteps([function(){e=o.showMessage("Opening project\n"+r+" KB...")},function(){nop()},function(){o.rawOpenCloudDataString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenCloudDataString=function(t){var e;if(StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,StageMorph.prototype.enableSublistIDs=!1,Process.prototype.enableLiveCoding=!1,Process.prototype.isCatchingErrors)try{e=this.serializer.parse(t),this.serializer.loadMediaModel(e.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(e.childNamed("project"),this),this)}catch(t){this.showMessage("Load failed: "+t)}else e=this.serializer.parse(t),this.serializer.loadMediaModel(e.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(e.childNamed("project"),this),this);this.stopFastTracking()},IDE_Morph.prototype.openBlocksString=function(t,e,o){var r,i=this;this.nextSteps([function(){r=i.showMessage("Opening blocks...")},function(){nop()},function(){i.rawOpenBlocksString(t,e,o)},function(){r.destroy()}])},IDE_Morph.prototype.rawOpenBlocksString=function(t,e,o){var r,i=this;if(Process.prototype.isCatchingErrors)try{r=this.serializer.loadBlocks(t,i.stage)}catch(t){this.showMessage("Load failed: "+t)}else r=this.serializer.loadBlocks(t,i.stage);o?(r.forEach(function(t){t.receiver=i.stage,i.stage.globalBlocks.push(t),i.stage.replaceDoubleDefinitionsFor(t)}),this.flushPaletteCache(),this.refreshPalette(),this.showMessage("Imported Blocks Module"+(e?": "+e:"")+".",2)):new BlockImportDialogMorph(r,this.stage,e).popUp()},IDE_Morph.prototype.openSpritesString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening sprite...")},function(){nop()},function(){o.rawOpenSpritesString(t)},function(){e.destroy()}])},IDE_Morph.prototype.rawOpenSpritesString=function(t){if(Process.prototype.isCatchingErrors)try{this.serializer.loadSprites(t,this)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.loadSprites(t,this)},IDE_Morph.prototype.openMediaString=function(t){if(Process.prototype.isCatchingErrors)try{this.serializer.loadMedia(t)}catch(t){this.showMessage("Load failed: "+t)}else this.serializer.loadMedia(t);this.showMessage("Imported Media Module.",2)},IDE_Morph.prototype.openProject=function(t){var e;t&&(this.showMessage("opening project\n"+t),this.setProjectName(t),e=localStorage["-snap-project-"+t],this.openProjectString(e),this.setURL("#open:"+e))},IDE_Morph.prototype.setURL=function(t){this.projectsInURLs&&(location.hash=t)},IDE_Morph.prototype.saveFileAs=function(t,e,o,r){function i(t){var e=2e6,o=navigator.userAgent.indexOf("Chrome")!==-1;return o&&t.length>e}function n(t,e){var o,r=t,i=t.split(","),n=0===t.indexOf("data:");if(n&&i[0].indexOf("base64")>-1)for(t=atob(i[1]),r=new Uint8Array(t.length),o=t.length;o--;)r[o]=t.charCodeAt(o);return new Blob([r],{type:e})}function s(t){var o=0===t.indexOf("data:");return o?t:"data:"+e+","+encodeURIComponent(t)}var a,h,l,p=!1,c=this.world();a=e.split("/")[1].split(";")[0],a="."+("plain"===a?"txt":a);try{p=!!new Blob}catch(t){}r?(h=t instanceof Blob?URL.createObjectURL(t):s(t),i(h)?(this.showMessage("download to disk text"),this.saveFileAs(t,e,o)):(window.open(h,o),t instanceof Blob&&URL.revokeObjectURL(h))):p?(t instanceof Blob||(t=n(t,e)),saveAs(t,o+a,!1)):(l=new DialogBoxMorph,l.inform(localize("Could not export")+" "+o,"unable to export text",c),l.fixLayout(),l.drawNew())},IDE_Morph.prototype.saveCanvasAs=function(t,e,o){this.saveFileAs(t.toDataURL(),"image/png",e,o)},IDE_Morph.prototype.saveXMLAs=function(t,e,o){this.saveFileAs(t,"text/xml;chartset=utf-8",e,o)},IDE_Morph.prototype.switchToUserMode=function(){var t=this.world();t.isDevMode=!1,Process.prototype.isCatchingErrors=!0,this.controlBar.updateLabel(),this.isAutoFill=!0,this.isDraggable=!1,this.reactToWorldResize(t.bounds.copy()),this.siblings().forEach(function(e){e instanceof DialogBoxMorph?t.add(e):e.destroy()}),this.flushBlocksCache(),this.refreshPalette(),t.reactToDropOf=function(e){e instanceof DialogBoxMorph||(t.hand.grabOrigin?e.slideBackTo(t.hand.grabOrigin):t.hand.grab(e))},this.showMessage("entering user mode",1)},IDE_Morph.prototype.switchToDevMode=function(){var t=this.world();t.isDevMode=!0,Process.prototype.isCatchingErrors=!1,this.controlBar.updateLabel(),this.isAutoFill=!1,this.isDraggable=!0,this.setExtent(t.extent().subtract(100)),this.setPosition(t.position().add(20)),this.flushBlocksCache(),this.refreshPalette(),delete t.reactToDropOf,this.showMessage("entering development mode.\n\nerror catching is turned off,\nuse the browser's web console\nto see error messages.")},IDE_Morph.prototype.flushBlocksCache=function(t){t?(this.stage.blocksCache[t]=null,this.stage.children.forEach(function(e){e instanceof SpriteMorph&&(e.blocksCache[t]=null)})):(this.stage.blocksCache={},this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.blocksCache={})})),this.flushPaletteCache(t)},IDE_Morph.prototype.flushPaletteCache=function(t){t?(this.stage.paletteCache[t]=null,this.stage.children.forEach(function(e){e instanceof SpriteMorph&&(e.paletteCache[t]=null)})):(this.stage.paletteCache={},this.stage.children.forEach(function(t){t instanceof SpriteMorph&&(t.paletteCache={})}))},IDE_Morph.prototype.toggleZebraColoring=function(){var t=[];BlockMorph.prototype.zebraContrast?BlockMorph.prototype.zebraContrast=0:BlockMorph.prototype.zebraContrast=40,this.stage.children.concat(this.stage).forEach(function(e){isSnapObject(e)&&(t=t.concat(e.scripts.children.filter(function(t){return t instanceof BlockMorph})))}),t.forEach(function(t){t.fixBlockColor(null,!0)})},IDE_Morph.prototype.toggleDynamicInputLabels=function(){var t;if(SyntaxElementMorph.prototype.dynamicInputLabels=!SyntaxElementMorph.prototype.dynamicInputLabels,Process.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else t=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.openProjectString(t)},IDE_Morph.prototype.toggleBlurredShadows=function(){window.useBlurredShadows=!useBlurredShadows},IDE_Morph.prototype.toggleLongFormInputDialog=function(){InputSlotDialogMorph.prototype.isLaunchingExpanded=!InputSlotDialogMorph.prototype.isLaunchingExpanded,InputSlotDialogMorph.prototype.isLaunchingExpanded?this.saveSetting("longform",!0):this.removeSetting("longform")},IDE_Morph.prototype.togglePlainPrototypeLabels=function(){BlockLabelPlaceHolderMorph.prototype.plainLabel=!BlockLabelPlaceHolderMorph.prototype.plainLabel,BlockLabelPlaceHolderMorph.prototype.plainLabel?this.saveSetting("plainprototype",!0):this.removeSetting("plainprototype")},IDE_Morph.prototype.togglePreferEmptySlotDrops=function(){ScriptsMorph.prototype.isPreferringEmptySlots=!ScriptsMorph.prototype.isPreferringEmptySlots},IDE_Morph.prototype.toggleVirtualKeyboard=function(){MorphicPreferences.useVirtualKeyboard=!MorphicPreferences.useVirtualKeyboard},IDE_Morph.prototype.toggleInputSliders=function(){MorphicPreferences.useSliderForInput=!MorphicPreferences.useSliderForInput},IDE_Morph.prototype.toggleSliderExecute=function(){ArgMorph.prototype.executeOnSliderEdit=!ArgMorph.prototype.executeOnSliderEdit},IDE_Morph.prototype.toggleAppMode=function(t){var e=this.world(),o=[this.logo,this.controlBar.cloudButton,this.controlBar.projectButton,this.controlBar.settingsButton,this.controlBar.stageSizeButton,this.paletteHandle,this.stageHandle,this.corral,this.corralBar,this.spriteEditor,this.spriteBar,this.palette,this.categories];this.isAppMode=isNil(t)?!this.isAppMode:t,Morph.prototype.trackChanges=!1,this.isAppMode?(this.setColor(this.appModeColor),this.controlBar.setColor(this.color),this.controlBar.appModeButton.refresh(),o.forEach(function(t){t.hide()}),e.children.forEach(function(t){t instanceof DialogBoxMorph&&t.hide()}),e.keyboardReceiver instanceof ScriptFocusMorph&&e.keyboardReceiver.stopEditing()):(this.setColor(this.backgroundColor),this.controlBar.setColor(this.frameColor),o.forEach(function(t){t.show()}),this.stage.setScale(1),e.children.forEach(function(t){t instanceof DialogBoxMorph&&t.show()}),e.allChildren().filter(function(t){return t instanceof ScrollFrameMorph}).forEach(function(t){t.adjustScrollBars()}),this.currentSprite===this.stage&&this.spriteBar.children.forEach(function(t){t instanceof PushButtonMorph&&t.hide()})),this.setExtent(this.world().extent())},IDE_Morph.prototype.toggleStageSize=function(t,e){function o(){i.isSmallStage=isNil(t)?!i.isSmallStage:t}function r(t){var e=1,o=5;i.fps=30,i.isSmallStage=!0,i.step=function(){var r;e>=o?(i.stageRatio=t,delete i.step,i.fps=0,i.isSmallStage=1!==t,i.controlBar.stageSizeButton.refresh()):(e+=1,r=(t-i.stageRatio)/2,i.stageRatio+=r),i.setExtent(s.extent())}}var i=this,n=e||.5,s=this.world(),a=16===s.currentKey,h=18===s.currentKey;a?(n=3*SpriteIconMorph.prototype.thumbSize.x/this.stage.dimensions.x,this.isSmallStage&&n!==this.stageRatio||o()):h?(n=this.width()/2/this.stage.dimensions.x,this.isSmallStage&&n!==this.stageRatio||o()):o(),this.isAnimating?r(this.isSmallStage?n:1):(this.isSmallStage&&(this.stageRatio=n),this.setExtent(s.extent()))},IDE_Morph.prototype.setPaletteWidth=function(t){var e=1,o=this.isAnimating?5:1,r=this.world(),i=this;t=Math.max(t,200),this.fps=30,this.step=function(){var n;e>=o?(i.paletteWidth=t,delete i.step,i.fps=0):(e+=1,n=(i.paletteWidth-t)/2,i.paletteWidth-=n),i.setExtent(r.extent())}},IDE_Morph.prototype.createNewProject=function(){var t=this;this.confirm("Replace the current project with a new one?","New Project",function(){t.newProject()})},IDE_Morph.prototype.openProjectsBrowser=function(){new ProjectDialogMorph(this,"open").popUp()},IDE_Morph.prototype.saveProjectsBrowser=function(){"examples"===this.source&&(this.source="local"),new ProjectDialogMorph(this,"save").popUp()},IDE_Morph.prototype.languageMenu=function(){var t=new MenuMorph(this),e=this.world(),o=this.controlBar.settingsButton.bottomLeft(),r=this;SnapTranslator.languages().forEach(function(e){t.addItem((SnapTranslator.language===e?" ":"    ")+SnapTranslator.languageName(e),function(){r.loadNewProject=!1,r.setLanguage(e)})}),t.popup(e,o)},IDE_Morph.prototype.setLanguage=function(t,e){var o=document.getElementById("language"),r=this.resourceURL("lang-"+t+".js"),i=this;return SnapTranslator.unload(),o&&document.head.removeChild(o),"en"===t?this.reflectLanguage("en",e):(o=document.createElement("script"),o.id="language",o.onload=function(){i.reflectLanguage(t,e)},document.head.appendChild(o),void(o.src=r))},IDE_Morph.prototype.reflectLanguage=function(t,e){var o,r=location.hash;if(SnapTranslator.language=t,!this.loadNewProject)if(Process.prototype.isCatchingErrors)try{o=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else o=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.loadNewProject?(this.newProject(),location.hash=r):this.openProjectString(o),this.saveSetting("language",t),e&&e.call(this)},IDE_Morph.prototype.userSetBlocksScale=function(){var t,e,o,r,i,n=this;t=new CommandBlockMorph,t.color=SpriteMorph.prototype.blockColor.motion,t.setSpec(localize("build")),e=new CommandBlockMorph,e.color=SpriteMorph.prototype.blockColor.sound,e.setSpec(localize("your own")),t.nextBlock(e),e=new CommandBlockMorph,e.color=SpriteMorph.prototype.blockColor.operators,e.setSpec(localize("blocks")),t.bottomBlock().nextBlock(e),r=new FrameMorph,r.acceptsDrops=!1,r.color=IDE_Morph.prototype.groupColor,r.cachedTexture=this.scriptsPaneTexture,r.setExtent(new Point(250,180)),t.setPosition(r.position().add(10)),r.add(t),o=new Morph,o.alpha=0,o.setExtent(r.extent()),o.setPosition(r.position()),r.add(o),i=function(e){t.blockSequence().forEach(function(t){t.setScale(e),t.drawNew(),t.setSpec(t.blockSpec)}),t.changed()},new DialogBoxMorph(null,function(t){n.setBlocksScale(Math.min(t,12))}).withKey("zoomBlocks").prompt("Zoom blocks",SyntaxElementMorph.prototype.scale.toString(),this.world(),r,{"normal (1x)":1,"demo (1.2x)":1.2,"presentation (1.4x)":1.4,"big (2x)":2,"huge (4x)":4,"giant (8x)":8,"monstrous (10x)":10},!1,!0,1,12,i)},IDE_Morph.prototype.setBlocksScale=function(t){var e;if(Process.prototype.isCatchingErrors)try{e=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else e=this.serializer.serialize(this.stage);SyntaxElementMorph.prototype.setScale(t),CommentMorph.prototype.refreshScale(),SpriteMorph.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.openProjectString(e),this.saveSetting("zoom",t)},IDE_Morph.prototype.userSetStageSize=function(){new DialogBoxMorph(this,this.setStageExtent,this).promptVector("Stage size",StageMorph.prototype.dimensions,new Point(480,360),"Stage width","Stage height",this.world(),null,null)},IDE_Morph.prototype.setStageExtent=function(t){function e(){o.step=function(){var t=i.subtract(StageMorph.prototype.dimensions).divideBy(2);t.abs().lt(new Point(5,5))?(StageMorph.prototype.dimensions=i,delete o.step):StageMorph.prototype.dimensions=StageMorph.prototype.dimensions.add(t),o.stage.setExtent(StageMorph.prototype.dimensions),o.stage.clearPenTrails(),o.fixLayout(),this.setExtent(r.extent())}}var o=this,r=this.world(),i=t.max(new Point(480,180));this.stageRatio=1,this.isSmallStage=!1,this.controlBar.stageSizeButton.refresh(),this.setExtent(r.extent()),this.isAnimating?e():(StageMorph.prototype.dimensions=i,this.stage.setExtent(StageMorph.prototype.dimensions),this.stage.clearPenTrails(),this.fixLayout(),this.setExtent(r.extent()))},IDE_Morph.prototype.userSetDragThreshold=function(){new DialogBoxMorph(this,function(t){MorphicPreferences.grabThreshold=Math.min(Math.max(+t,0),200)},this).prompt("Dragging threshold",MorphicPreferences.grabThreshold.toString(),this.world(),null,null,null,!0)},IDE_Morph.prototype.initializeCloud=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(e){var o,r=hex_sha512(e.password);SnapCloud.login(e.username,r,function(){e.choice&&(o=SnapCloud.encodeDict({username:e.username,password:r}),localStorage["-snap-user"]=o),t.source="cloud",t.showMessage("now connected.",2)},t.cloudError())}).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.createCloudAccount=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(o){SnapCloud.signup(o.username,o.email,function(o,r){(new DialogBoxMorph).inform(r,o+".\n\nAn e-mail with your password\nhas been sent to the address provided",e,t.cloudIcon(null,new Color(0,180,0)))},t.cloudError())}).withKey("cloudsignup").promptCredentials("Sign up","signup","http://snap.berkeley.edu/tos.html","Terms of Service...","http://snap.berkeley.edu/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.resetCloudPassword=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(o){SnapCloud.resetPassword(o.username,function(o,r){(new DialogBoxMorph).inform(r,o+".\n\nAn e-mail with a link to\nreset your password\nhas been sent to the address provided",e,t.cloudIcon(null,new Color(0,180,0)))},t.cloudError())}).withKey("cloudresetpassword").promptCredentials("Reset password","resetPassword",null,null,null,null,null,e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.changeCloudPassword=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(e){SnapCloud.changePassword(e.oldpassword,e.password,function(){t.logout(),t.showMessage("password has been changed.",2)},t.cloudError())}).withKey("cloudpassword").promptCredentials("Change Password","changePassword",null,null,null,null,null,e,t.cloudIcon(),t.cloudMsg)},IDE_Morph.prototype.logout=function(){var t=this;delete localStorage["-snap-user"],SnapCloud.logout(function(){SnapCloud.clear(),t.showMessage("disconnected.",2)},function(){SnapCloud.clear(),t.showMessage("disconnected.",2)})},IDE_Morph.prototype.saveProjectToCloud=function(t){var e=this;t&&(this.showMessage("Saving project\nto the cloud..."),this.setProjectName(t),SnapCloud.saveProject(this,function(){e.showMessage("saved.",2)},this.cloudError()))},IDE_Morph.prototype.exportProjectMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t){this.setProjectName(t);try{e=this.showMessage("Exporting"),o=this.serializer.mediaXML(t),this.saveXMLAs(o,this.projectName+" media"),e.destroy(),this.showMessage("Exported!",1)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}}this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectNoMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1)}catch(t){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}else e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.exportProjectAsCloudData=function(t){var e,o,r,i;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),Process.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),r=this.serializer.mediaXML(t),i="<snapdata>"+o+r+"</snapdata>",this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1)}catch(t){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}else e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),r=this.serializer.mediaXML(t),i="<snapdata>"+o+r+"</snapdata>",this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},IDE_Morph.prototype.cloudAcknowledge=function(){var t=this;return function(e,o){nop(e),(new DialogBoxMorph).inform("Cloud Connection","Successfully connected to:\nhttp://"+o,t.world(),t.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudResponse=function(){var t=this;return function(e,o){var r=e;r.length>50&&(r=r.substring(0,50)+"..."),(new DialogBoxMorph).inform("Snap!Cloud","http://"+o+":\n\nresponds:\n"+r,t.world(),t.cloudIcon(null,new Color(0,180,0)))}},IDE_Morph.prototype.cloudError=function(){var t=this;return function(e,o){var r=e,i=null;return t.shield&&(t.shield.destroy(),t.shield=null),i?void t.showMessage(i):(r.length>50&&(r=r.substring(0,50)+"..."),void(new DialogBoxMorph).inform("Snap!Cloud",(o?o+"\n":"")+r,t.world(),t.cloudIcon(null,new Color(180,0,0))))}},IDE_Morph.prototype.cloudIcon=function(t,e){var o=e||DialogBoxMorph.prototype.titleBarColor,r=MorphicPreferences.isFlat,i=new SymbolMorph(r?"cloud":"cloudGradient",t||50,o,r?null:new Point(-1,-1),o.darker(50));return r||i.addShadow(new Point(1,1),1,o.lighter(95)),i},IDE_Morph.prototype.setCloudURL=function(){new DialogBoxMorph(null,function(t){SnapCloud.url=t}).withKey("cloudURL").prompt("Cloud URL",SnapCloud.url,this.world(),null,{"Snap!Cloud":"https://snap.apps.miosoft.com/SnapCloud"})},IDE_Morph.prototype.getURL=function(t){var e=new XMLHttpRequest,o=this;try{if(e.open("GET",t,!1),e.send(),200===e.status)return e.responseText;throw new Error("unable to retrieve "+t)}catch(t){return void o.showMessage(t.message)}},IDE_Morph.prototype.showMessage=function(t,e){var o,r=new MenuMorph(null,t);return r.popUpCenteredInWorld(this.world()),e&&(o=setInterval(function(){r.destroy(),clearInterval(o)},1e3*e)),r},IDE_Morph.prototype.inform=function(t,e){(new DialogBoxMorph).inform(t,localize(e),this.world())},IDE_Morph.prototype.confirm=function(t,e,o){new DialogBoxMorph(null,o).askYesNo(e,localize(t),this.world())},IDE_Morph.prototype.prompt=function(t,e,o,r){new DialogBoxMorph(null,e).withKey(r).prompt(t,"",this.world(),null,o)},ProjectDialogMorph.prototype=new DialogBoxMorph,ProjectDialogMorph.prototype.constructor=ProjectDialogMorph,ProjectDialogMorph.uber=DialogBoxMorph.prototype,ProjectDialogMorph.prototype.init=function(t,e){var o=this;this.ide=t,this.task=e||"open",this.source=t.source||"local",this.projectList=[],this.handle=null,this.srcBar=null,this.nameField=null,this.listField=null,this.preview=null,this.notesText=null,this.notesField=null,this.deleteButton=null,this.shareButton=null,this.unshareButton=null,ProjectDialogMorph.uber.init.call(this,this,null,null),this.labelString="save"===this.task?"Save Project":"Open Project",this.createLabel(),this.key="project"+e,this.buildContents(),this.onNextStep=function(){o.setSource(o.source)}},ProjectDialogMorph.prototype.buildContents=function(){var t,e;this.addBody(new Morph),this.body.color=this.color,this.srcBar=new AlignmentMorph("column",this.padding/2),
this.ide.cloudMsg&&(e=new TextMorph(this.ide.cloudMsg,10,null,!1,null,null,null,null,new Point(1,1),new Color(255,255,255)),e.refresh=nop,this.srcBar.add(e)),this.addSourceButton("cloud",localize("Cloud"),"cloud"),this.addSourceButton("local",localize("Browser"),"storage"),"open"===this.task&&this.addSourceButton("examples",localize("Examples"),"poster"),this.srcBar.fixLayout(),this.body.add(this.srcBar),"save"===this.task&&(this.nameField=new InputFieldMorph(this.ide.projectName),this.body.add(this.nameField)),this.listField=new ListMorph([]),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.body.add(this.listField),this.preview=new Morph,this.preview.fixLayout=nop,this.preview.edge=InputFieldMorph.prototype.edge,this.preview.fontSize=InputFieldMorph.prototype.fontSize,this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.preview.contrast=InputFieldMorph.prototype.contrast,this.preview.drawNew=function(){InputFieldMorph.prototype.drawNew.call(this),this.texture&&this.drawTexture(this.texture)},this.preview.drawCachedTexture=function(){var t=this.image.getContext("2d");t.drawImage(this.cachedTexture,this.edge,this.edge),this.changed()},this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.preview.setExtent(this.ide.serializer.thumbnailSize.add(2*this.preview.edge)),this.body.add(this.preview),this.preview.drawNew(),"save"===this.task&&(t=this.ide.stage.thumbnail(SnapSerializer.prototype.thumbnailSize),this.preview.texture=null,this.preview.cachedTexture=t,this.preview.drawCachedTexture()),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,"open"===this.task?this.notesText=new TextMorph(""):(this.notesText=new TextMorph(this.ide.projectNotes),this.notesText.isEditable=!0,this.notesText.enableSelecting()),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setWidth(this.preview.width()),this.body.add(this.notesField),"open"===this.task?(this.addButton("openProject","Open"),this.action="openProject"):(this.addButton("saveProject","Save"),this.action="saveProject"),this.shareButton=this.addButton("shareProject","Share"),this.unshareButton=this.addButton("unshareProject","Unshare"),this.shareButton.hide(),this.unshareButton.hide(),this.deleteButton=this.addButton("deleteProject","Delete"),this.addButton("cancel","Cancel"),e?this.setExtent(new Point(455,335).add(e.extent())):this.setExtent(new Point(455,335)),this.fixLayout()},ProjectDialogMorph.prototype.popUp=function(t){var e=t||this.ide.world();e&&(ProjectDialogMorph.uber.popUp.call(this,e),this.handle=new HandleMorph(this,350,300,this.corner,this.corner))},ProjectDialogMorph.prototype.addSourceButton=function(t,e,o){var r,i=this,n=new StringMorph(e,10,null,!0,null,null,new Point(1,1),new Color(255,255,255)),s=new StringMorph(e,10,null,!0,null,null,new Point(-1,-1),this.titleBarColor.darker(50),new Color(255,255,255)),a=new Morph,h=new Morph;n.add(new SymbolMorph(o,24,this.titleBarColor.darker(20),new Point(1,1),this.titleBarColor.darker(50))),n.children[0].setCenter(n.center()),n.children[0].setBottom(n.top()-this.padding/2),a.image=n.fullImage(),a.bounds=n.fullBounds(),s.add(new SymbolMorph(o,24,new Color(255,255,255),new Point(-1,-1),this.titleBarColor.darker(50))),s.children[0].setCenter(s.center()),s.children[0].setBottom(s.top()-this.padding/2),h.image=s.fullImage(),h.bounds=s.fullBounds(),r=new ToggleButtonMorph(null,i,function(){i.setSource(t)},[a,h],function(){return i.source===t}),r.corner=this.buttonCorner,r.edge=this.buttonEdge,r.outline=this.buttonOutline,r.outlineColor=this.buttonOutlineColor,r.outlineGradient=this.buttonOutlineGradient,r.labelMinExtent=new Point(60,0),r.padding=this.buttonPadding,r.contrast=this.buttonContrast,r.pressColor=this.titleBarColor.darker(20),r.drawNew(),r.fixLayout(),r.refresh(),this.srcBar.add(r)},ProjectDialogMorph.prototype.fixListFieldItemColors=function(){var t=this;this.listField.contents.children[0].alpha=0,this.listField.contents.children[0].children.forEach(function(e){e.pressColor=t.titleBarColor.darker(20),e.color=new Color(0,0,0,0),e.noticesTransparentClick=!0})},ProjectDialogMorph.prototype.setSource=function(t){var e,o=this;switch(this.source=t,this.srcBar.children.forEach(function(t){t.refresh()}),this.source){case"cloud":return e=o.ide.showMessage("Updating\nproject list..."),this.projectList=[],void SnapCloud.getProjectList(function(t){"cloud"===o.source&&o.installCloudProjectList(t),e.destroy()},function(t,r){e.destroy(),o.ide.cloudError().call(null,t,r)});case"examples":this.projectList=this.getExamplesProjectList();break;case"local":this.projectList=this.getLocalProjectList()}this.listField.destroy(),this.listField=new ListMorph(this.projectList,this.projectList.length>0?function(t){return t.name}:null,null,function(){o.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,"local"===this.source?this.listField.action=function(t){var e,r;void 0!==t&&(o.nameField&&o.nameField.setContents(t.name||""),"open"===o.task&&(e=localStorage["-snap-project-"+t.name],r=o.ide.serializer.parse(e),o.notesText.text=r.childNamed("notes").contents||"",o.notesText.drawNew(),o.notesField.contents.adjustBounds(),o.preview.texture=r.childNamed("thumbnail").contents||null,o.preview.cachedTexture=null,o.preview.drawNew()),o.edit())}:this.listField.action=function(t){var e,r;void 0!==t&&(o.nameField&&o.nameField.setContents(t.name||""),e=o.ide.getURL(o.ide.resourceURL("Examples",t.file)),r=o.ide.serializer.parse(e),o.notesText.text=r.childNamed("notes").contents||"",o.notesText.drawNew(),o.notesField.contents.adjustBounds(),o.preview.texture=r.childNamed("thumbnail").contents||null,o.preview.cachedTexture=null,o.preview.drawNew(),o.edit())},this.body.add(this.listField),this.shareButton.hide(),this.unshareButton.hide(),"local"===this.source?this.deleteButton.show():this.deleteButton.hide(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.getLocalProjectList=function(){var t,e,o,r=[];for(t in localStorage)Object.prototype.hasOwnProperty.call(localStorage,t)&&"-snap-project-"===t.substr(0,14)&&(e=t.substr(14),o={name:e,thumb:null,notes:null},r.push(o));return r.sort(function(t,e){return t.name.toLowerCase()<e.name.toLowerCase()?-1:1}),r},ProjectDialogMorph.prototype.getExamplesProjectList=function(){return this.ide.getMediaList("Examples")},ProjectDialogMorph.prototype.installCloudProjectList=function(t){var e=this;this.projectList=t||[],this.projectList.sort(function(t,e){return t.ProjectName.toLowerCase()<e.ProjectName.toLowerCase()?-1:1}),this.listField.destroy(),this.listField=new ListMorph(this.projectList,this.projectList.length>0?function(t){return t.ProjectName}:null,[["bold",function(t){return"true"===t.Public}]],function(){e.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.listField.action=function(t){void 0!==t&&(e.nameField&&e.nameField.setContents(t.ProjectName||""),"open"===e.task&&(e.notesText.text=t.Notes||"",e.notesText.drawNew(),e.notesField.contents.adjustBounds(),e.preview.texture=t.Thumbnail||null,e.preview.cachedTexture=null,e.preview.drawNew(),new SpeechBubbleMorph(new TextMorph(localize("last changed")+"\n"+t.Updated,null,null,null,null,"center")).popUp(e.world(),e.preview.rightCenter().add(new Point(2,0)))),"true"===t.Public?(e.shareButton.hide(),e.unshareButton.show()):(e.unshareButton.hide(),e.shareButton.show()),e.buttons.fixLayout(),e.fixLayout(),e.edit())},this.body.add(this.listField),this.shareButton.show(),this.unshareButton.hide(),this.deleteButton.show(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},ProjectDialogMorph.prototype.clearDetails=function(){this.notesText.text="",this.notesText.drawNew(),this.notesField.contents.adjustBounds(),this.preview.texture=null,this.preview.cachedTexture=null,this.preview.drawNew()},ProjectDialogMorph.prototype.openProject=function(){var t,e=this.listField.selected;e&&(this.ide.source=this.source,"cloud"===this.source?this.openCloudProject(e):"examples"===this.source?(t=this.ide.getURL(this.ide.resourceURL("Examples",e.file)),this.ide.openProjectString(t),this.destroy()):(this.ide.openProject(e.name),this.destroy()))},ProjectDialogMorph.prototype.openCloudProject=function(t){var e=this;e.ide.nextSteps([function(){e.ide.showMessage("Fetching project\nfrom the cloud...")},function(){e.rawOpenCloudProject(t)}])},ProjectDialogMorph.prototype.rawOpenCloudProject=function(t){var e=this;SnapCloud.reconnect(function(){SnapCloud.callService("getRawProject",function(o){SnapCloud.disconnect(),e.ide.source="cloud",e.ide.droppedText(o),"true"===t.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(t.ProjectName))},e.ide.cloudError(),[t.ProjectName])},e.ide.cloudError()),this.destroy()},ProjectDialogMorph.prototype.saveProject=function(){var t=this.nameField.contents().text.text,e=this.notesText.text,o=this;this.ide.projectNotes=e||this.ide.projectNotes,t&&("cloud"===this.source?detect(this.projectList,function(e){return e.ProjectName===t})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+t+'"?',"Replace Project",function(){o.ide.setProjectName(t),o.saveCloudProject()}):(this.ide.setProjectName(t),o.saveCloudProject()):detect(this.projectList,function(e){return e.name===t})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+t+'"?',"Replace Project",function(){o.ide.setProjectName(t),o.ide.source="local",o.ide.saveProject(t),o.destroy()}):(this.ide.setProjectName(t),o.ide.source="local",this.ide.saveProject(t),this.destroy()))},ProjectDialogMorph.prototype.saveCloudProject=function(){var t=this;this.ide.showMessage("Saving project\nto the cloud..."),SnapCloud.saveProject(this.ide,function(){t.ide.source="cloud",t.ide.showMessage("saved.",2)},this.ide.cloudError()),this.destroy()},ProjectDialogMorph.prototype.deleteProject=function(){var t,e,o,r=this;"cloud"===this.source?(t=this.listField.selected,t&&this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+t.ProjectName+'"?',"Delete Project",function(){SnapCloud.reconnect(function(){SnapCloud.callService("deleteProject",function(){SnapCloud.disconnect(),r.ide.hasChangedMedia=!0,e=r.projectList.indexOf(t),r.projectList.splice(e,1),r.installCloudProjectList(r.projectList)},r.ide.cloudError(),[t.ProjectName])},r.ide.cloudError())})):this.listField.selected&&(o=this.listField.selected.name,this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+o+'"?',"Delete Project",function(){delete localStorage["-snap-project-"+o],r.setSource(r.source)}))},ProjectDialogMorph.prototype.shareProject=function(){var t=this,e=this.ide,o=this.listField.selected,r=this.listField.active;o&&this.ide.confirm(localize("Are you sure you want to publish")+'\n"'+o.ProjectName+'"?',"Share Project",function(){t.ide.showMessage("sharing\nproject..."),SnapCloud.reconnect(function(){if(SnapCloud.callService("publishProject",function(){SnapCloud.disconnect(),o.Public="true",t.unshareButton.show(),t.shareButton.hide(),r.label.isBold=!0,r.label.drawNew(),r.label.changed(),t.buttons.fixLayout(),t.drawNew(),t.ide.showMessage("shared.",2)},t.ide.cloudError(),[o.ProjectName]),o.ProjectName===e.projectName){var i=SnapCloud.username,n="Username="+encodeURIComponent(i.toLowerCase())+"&ProjectName="+encodeURIComponent(o.ProjectName);location.hash="present:"+n}},t.ide.cloudError())})},ProjectDialogMorph.prototype.unshareProject=function(){var t=this,e=this.ide,o=this.listField.selected,r=this.listField.active;o&&this.ide.confirm(localize("Are you sure you want to unpublish")+'\n"'+o.ProjectName+'"?',"Unshare Project",function(){t.ide.showMessage("unsharing\nproject..."),SnapCloud.reconnect(function(){SnapCloud.callService("unpublishProject",function(){SnapCloud.disconnect(),o.Public="false",t.shareButton.show(),t.unshareButton.hide(),r.label.isBold=!1,r.label.drawNew(),r.label.changed(),t.buttons.fixLayout(),t.drawNew(),t.ide.showMessage("unshared.",2)},t.ide.cloudError(),[o.ProjectName]),o.ProjectName===e.projectName&&(location.hash="")},t.ide.cloudError())})},ProjectDialogMorph.prototype.edit=function(){this.nameField&&this.nameField.edit()},ProjectDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,o=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.buttons&&this.buttons.children.length>0&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.srcBar.setPosition(this.body.position()),this.nameField&&(this.nameField.setWidth(this.body.width()-this.srcBar.width()-6*this.padding),this.nameField.setLeft(this.srcBar.right()+3*this.padding),this.nameField.setTop(this.srcBar.top()),this.nameField.drawNew()),this.listField.setLeft(this.srcBar.right()+this.padding),this.listField.setWidth(this.body.width()-this.srcBar.width()-this.preview.width()-this.padding-e),this.listField.contents.children[0].adjustWidths(),this.nameField?(this.listField.setTop(this.nameField.bottom()+this.padding),this.listField.setHeight(this.body.height()-this.nameField.height()-this.padding)):(this.listField.setTop(this.body.top()),this.listField.setHeight(this.body.height())),this.preview.setRight(this.body.right()),this.nameField?this.preview.setTop(this.nameField.bottom()+this.padding):this.preview.setTop(this.body.top()),this.notesField.setTop(this.preview.bottom()+e),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-e)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),Morph.prototype.trackChanges=o,this.changed()},SpriteIconMorph.prototype=new ToggleButtonMorph,SpriteIconMorph.prototype.constructor=SpriteIconMorph,SpriteIconMorph.uber=ToggleButtonMorph.prototype,SpriteIconMorph.prototype.thumbSize=new Point(40,40),SpriteIconMorph.prototype.labelShadowOffset=null,SpriteIconMorph.prototype.labelShadowColor=null,SpriteIconMorph.prototype.labelColor=new Color(255,255,255),SpriteIconMorph.prototype.fontSize=9,SpriteIconMorph.prototype.init=function(t,e){var o,r,i,n,s=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),r=function(){var t=s.parentThatIsA(IDE_Morph);t&&t.selectSprite(s.object)},i=function(){var t=s.parentThatIsA(IDE_Morph);return!!t&&t.currentSprite===s.object},n=function(){return t.exemplar?localize("parent:\n"+t.exemplar.name):null},this.object=t||new SpriteMorph,this.version=this.object.version,this.thumbnail=null,this.rotationButton=null,SpriteIconMorph.uber.init.call(this,o,null,r,this.object.name,i,null,n,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},SpriteIconMorph.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.object instanceof SpriteMorph?(this.thumbnail.image=this.object.fullThumbnail(this.thumbSize),this.createRotationButton()):this.thumbnail.image=this.object.thumbnail(this.thumbSize),this.add(this.thumbnail)},SpriteIconMorph.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new StringMorph(this.object.name,this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},SpriteIconMorph.prototype.createRotationButton=function(){var t,e=this;this.rotationButton&&(this.rotationButton.destroy(),this.roationButton=null),this.object.anchor&&(t=new ToggleButtonMorph(null,null,function(){e.object.rotatesWithAnchor=!e.object.rotatesWithAnchor},["",""],function(){return e.object.rotatesWithAnchor}),t.corner=8,t.labelMinExtent=new Point(11,11),t.padding=0,t.pressColor=t.color,t.drawNew(),t.fixLayout(),t.refresh(),t.changed(),this.rotationButton=t,this.add(this.rotationButton))},SpriteIconMorph.prototype.step=function(){this.version!==this.object.version&&(this.createThumbnail(),this.createLabel(),this.fixLayout(),this.version=this.object.version,this.refresh())},SpriteIconMorph.prototype.fixLayout=function(){return this.thumbnail&&this.label?(this.setWidth(this.thumbnail.width()+2*this.outline+2*this.edge+2*this.padding),this.setHeight(this.thumbnail.height()+2*this.outline+2*this.edge+3*this.padding+this.label.height()),this.thumbnail.setCenter(this.center()),this.thumbnail.setTop(this.top()+this.outline+this.edge+this.padding),this.rotationButton&&(this.rotationButton.setTop(this.top()),this.rotationButton.setRight(this.right())),this.label.setWidth(Math.min(this.label.children[0].width(),this.thumbnail.width())),this.label.setCenter(this.center()),void this.label.setTop(this.thumbnail.bottom()+this.padding)):null},SpriteIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this),e=this;return this.object instanceof StageMorph?(t.addItem("pic...",function(){var t=e.parentThatIsA(IDE_Morph);t.saveCanvasAs(e.object.fullImageClassic(),this.object.name,!0)},"open a new window\nwith a picture of the stage"),t):this.object instanceof SpriteMorph?(t.addItem("show","showSpriteOnStage"),t.addLine(),t.addItem("duplicate","duplicateSprite"),t.addItem("delete","removeSprite"),t.addLine(),StageMorph.prototype.enableInheritance&&t.addItem("parent...","chooseExemplar"),this.object.anchor&&t.addItem(localize("detach from")+" "+this.object.anchor.name,function(){e.object.detachFromAnchor()}),this.object.parts.length&&t.addItem("detach all parts",function(){e.object.detachAllParts()}),t.addItem("export...","exportSprite"),t):null},SpriteIconMorph.prototype.duplicateSprite=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.duplicateSprite(this.object)},SpriteIconMorph.prototype.removeSprite=function(){var t=this.parentThatIsA(IDE_Morph);t&&t.removeSprite(this.object)},SpriteIconMorph.prototype.exportSprite=function(){this.object.exportSprite()},SpriteIconMorph.prototype.chooseExemplar=function(){this.object.chooseExemplar()},SpriteIconMorph.prototype.showSpriteOnStage=function(){this.object.showOnStage()},SpriteIconMorph.prototype.createBackgrounds=function(){var t,e=this.extent();return this.template?(this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null):(this.normalImage=newCanvas(e),t=this.normalImage.getContext("2d"),this.drawBackground(t,this.color),this.highlightImage=newCanvas(e),t=this.highlightImage.getContext("2d"),this.drawBackground(t,this.highlightColor),this.pressImage=newCanvas(e),t=this.pressImage.getContext("2d"),this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.lighter(this.contrast),this.pressColor.darker(this.contrast)),void(this.image=this.normalImage))},SpriteIconMorph.prototype.prepareToBeGrabbed=function(){var t,e=this.parentThatIsA(IDE_Morph);this.mouseClickLeft(),this.alpha=.85,e&&(t=e.sprites.asArray().indexOf(this.object),e.sprites.remove(t+1),e.createCorral(),e.fixLayout())},SpriteIconMorph.prototype.justDropped=function(){this.alpha=1},SpriteIconMorph.prototype.wantsDropOf=function(t){return t instanceof BlockMorph||t instanceof CostumeIconMorph||t instanceof SoundIconMorph},SpriteIconMorph.prototype.reactToDropOf=function(t,e){t instanceof BlockMorph?this.copyStack(t):t instanceof CostumeIconMorph?this.copyCostume(t.object):t instanceof SoundIconMorph&&this.copySound(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},SpriteIconMorph.prototype.copyStack=function(t){var e=t.fullCopy(),o=Math.max(this.object.scripts.children.map(function(t){return t.fullBounds().bottom()}).concat([this.object.scripts.top()]));e.setPosition(new Point(this.object.scripts.left()+20,o+20)),this.object.scripts.add(e),e.allComments().forEach(function(t){t.align(e)}),this.object.scripts.adjustBounds(),e.allChildren().forEach(function(t){t.definition&&!t.definition.isGlobal&&t.deleteBlock()})},SpriteIconMorph.prototype.copyCostume=function(t){var e=t.copy();e.name=this.object.newCostumeName(e.name),this.object.addCostume(e),this.object.wearCostume(e)},SpriteIconMorph.prototype.copySound=function(t){var e=t.copy();this.object.addSound(e.audio,e.name)},CostumeIconMorph.prototype=new ToggleButtonMorph,CostumeIconMorph.prototype.constructor=CostumeIconMorph,CostumeIconMorph.uber=ToggleButtonMorph.prototype,CostumeIconMorph.prototype.thumbSize=new Point(80,60),CostumeIconMorph.prototype.labelShadowOffset=null,CostumeIconMorph.prototype.labelShadowColor=null,CostumeIconMorph.prototype.labelColor=new Color(255,255,255),CostumeIconMorph.prototype.fontSize=9,CostumeIconMorph.prototype.init=function(t,e){var o,r,i,n=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),r=function(){var t=n.parentThatIsA(IDE_Morph),e=n.parentThatIsA(WardrobeMorph);t&&t.currentSprite.wearCostume(n.object),e&&e.updateSelection()},i=function(){var t=n.parentThatIsA(IDE_Morph);return!!t&&t.currentSprite.costume===n.object},this.object=t||new Costume,this.version=this.object.version,this.thumbnail=null,CostumeIconMorph.uber.init.call(this,o,null,r,this.object.name,i,null,null,e),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},CostumeIconMorph.prototype.createThumbnail=SpriteIconMorph.prototype.createThumbnail,CostumeIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,CostumeIconMorph.prototype.step=SpriteIconMorph.prototype.step,CostumeIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,CostumeIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.object instanceof Costume?(t.addItem("edit","editCostume"),16===this.world().currentKey&&t.addItem("edit rotation point only...","editRotationPointOnly",null,new Color(100,0,0)),t.addItem("rename","renameCostume"),t.addLine(),t.addItem("duplicate","duplicateCostume"),t.addItem("delete","removeCostume"),t.addLine(),t.addItem("export","exportCostume"),t):null};CostumeIconMorph.prototype.editCostume=function(){this.object instanceof SVG_Costume?this.object.editRotationPointOnly(this.world()):this.object.edit(this.world(),this.parentThatIsA(IDE_Morph),!1)};CostumeIconMorph.prototype.editRotationPointOnly=function(){var t=this.parentThatIsA(IDE_Morph);this.object.editRotationPointOnly(this.world()),t.hasChangedMedia=!0},CostumeIconMorph.prototype.renameCostume=function(){var t=this.object,e=this.parentThatIsA(WardrobeMorph),o=this.parentThatIsA(IDE_Morph);new DialogBoxMorph(null,function(r){r&&r!==t.name&&(t.name=e.sprite.newCostumeName(r,t),t.version=Date.now(),o.hasChangedMedia=!0)}).prompt("rename costume",t.name,this.world())},CostumeIconMorph.prototype.duplicateCostume=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parentThatIsA(IDE_Morph),o=this.object.copy();o.name=t.sprite.newCostumeName(o.name),t.sprite.addCostume(o),t.updateList(),e&&e.currentSprite.wearCostume(o)},CostumeIconMorph.prototype.removeCostume=function(){var t=this.parentThatIsA(WardrobeMorph),e=this.parent.children.indexOf(this),o=this.parentThatIsA(IDE_Morph);t.removeCostumeAt(e-2),o.currentSprite.costume===this.object&&o.currentSprite.wearCostume(null)},CostumeIconMorph.prototype.exportCostume=function(){var t=this.parentThatIsA(IDE_Morph);this.object instanceof SVG_Costume?t.saveFileAs(this.object.contents.src,"text/svg",this.object.name):t.saveCanvasAs(this.object.contents,this.object.name,!0)},CostumeIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,CostumeIconMorph.prototype.prepareToBeGrabbed=function(){this.mouseClickLeft(),this.removeCostume()},TurtleIconMorph.prototype=new ToggleButtonMorph,TurtleIconMorph.prototype.constructor=TurtleIconMorph,TurtleIconMorph.uber=ToggleButtonMorph.prototype,TurtleIconMorph.prototype.thumbSize=new Point(80,60),TurtleIconMorph.prototype.labelShadowOffset=null,TurtleIconMorph.prototype.labelShadowColor=null,TurtleIconMorph.prototype.labelColor=new Color(255,255,255),TurtleIconMorph.prototype.fontSize=9,TurtleIconMorph.prototype.init=function(t,e){var o,r,i,n=this;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),r=function(){var t=n.parentThatIsA(IDE_Morph),e=n.parentThatIsA(WardrobeMorph);t&&t.currentSprite.wearCostume(null),e&&e.updateSelection()},i=function(){var t=n.parentThatIsA(IDE_Morph);return!!t&&null===t.currentSprite.costume},this.object=t,this.version=this.object.version,this.thumbnail=null,TurtleIconMorph.uber.init.call(this,o,null,r,"default",i,null,null,e),this.isDraggable=!1,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout()},TurtleIconMorph.prototype.createThumbnail=function(){var t=MorphicPreferences.isFlat;this.thumbnail&&this.thumbnail.destroy(),this.object instanceof SpriteMorph?this.thumbnail=new SymbolMorph("turtle",this.thumbSize.y,this.labelColor,t?null:new Point(-1,-1),new Color(0,0,0)):this.thumbnail=new SymbolMorph("stage",this.thumbSize.y,this.labelColor,t?null:new Point(-1,-1),new Color(0,0,0)),this.add(this.thumbnail)},TurtleIconMorph.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new StringMorph(localize(this.object instanceof SpriteMorph?"Turtle":"Empty"),this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new FrameMorph,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},TurtleIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,TurtleIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,TurtleIconMorph.prototype.userMenu=function(){var t=this,e=new MenuMorph(this,"pen"),o="",r="";return this.object instanceof StageMorph?null:(e.addItem(("tip"===this.object.penPoint?o:r)+" "+localize("tip"),function(){t.object.penPoint="tip",t.object.changed(),t.object.drawNew(),t.object.changed()}),e.addItem(("middle"===this.object.penPoint?o:r)+" "+localize("middle"),function(){t.object.penPoint="middle",t.object.changed(),t.object.drawNew(),t.object.changed()}),e)},WardrobeMorph.prototype=new ScrollFrameMorph,WardrobeMorph.prototype.constructor=WardrobeMorph,WardrobeMorph.uber=ScrollFrameMorph.prototype,WardrobeMorph.prototype.init=function(t,e){this.sprite=t||new SpriteMorph,this.costumesVersion=null,this.spriteVersion=null,WardrobeMorph.uber.init.call(this,null,null,e),this.fps=2,this.updateList()},WardrobeMorph.prototype.updateList=function(){var t,e,o,r,i=this,n=this.left()+5,s=this.top()+5,a=4,h=Morph.prototype.trackChanges,l=this.contents.position();this.changed(),h=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(t){i.reactToDropOf(t)},this.addBack(this.contents),t=new TurtleIconMorph(this.sprite),t.setPosition(new Point(n,s)),i.addContents(t),s=t.bottom()+a,r=new PushButtonMorph(this,"paintNew",new SymbolMorph("brush",15)),r.padding=0,r.corner=12,r.color=IDE_Morph.prototype.groupColor,r.highlightColor=IDE_Morph.prototype.frameColor.darker(50),r.pressColor=r.highlightColor,r.labelMinExtent=new Point(36,18),r.labelShadowOffset=new Point(-1,-1),r.labelShadowColor=r.highlightColor,r.labelColor=TurtleIconMorph.prototype.labelColor,r.contrast=this.buttonContrast,r.drawNew(),r.hint="Paint a new costume",r.setPosition(new Point(n,s)),r.fixLayout(),r.setCenter(t.center()),r.setLeft(t.right()+4*a),this.addContents(r),o=new TextMorph(localize("costumes tab help")),o.fontSize=9,o.setColor(SpriteMorph.prototype.paletteTextColor),o.setPosition(new Point(n,s)),this.addContents(o),s=o.bottom()+a,this.sprite.costumes.asArray().forEach(function(o){e=t=new CostumeIconMorph(o,e),t.setPosition(new Point(n,s)),i.addContents(t),s=t.bottom()+a}),this.costumesVersion=this.sprite.costumes.lastChanged,this.contents.setPosition(l),this.adjustScrollBars(),Morph.prototype.trackChanges=h,this.changed(),this.updateSelection()},WardrobeMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(t){t.refresh&&t.refresh()}),this.spriteVersion=this.sprite.version},WardrobeMorph.prototype.step=function(){this.costumesVersion!==this.sprite.costumes.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},WardrobeMorph.prototype.removeCostumeAt=function(t){this.sprite.costumes.remove(t),this.updateList()},WardrobeMorph.prototype.paintNew=function(){var t=new Costume(newCanvas(null,!0),this.sprite.newCostumeName(localize("Untitled"))),e=this.parentThatIsA(IDE_Morph),o=this;t.edit(this.world(),e,!0,null,function(){o.sprite.addCostume(t),o.updateList(),e&&e.currentSprite.wearCostume(t)})},WardrobeMorph.prototype.wantsDropOf=function(t){return t instanceof CostumeIconMorph},WardrobeMorph.prototype.reactToDropOf=function(t){var e=0,o=t.object,r=t.top();t.destroy(),this.contents.children.forEach(function(t){t instanceof CostumeIconMorph&&t.top()<r-4&&(e+=1)}),this.sprite.costumes.add(o,e+1),this.updateList(),t.mouseClickLeft()},SoundIconMorph.prototype=new ToggleButtonMorph,SoundIconMorph.prototype.constructor=SoundIconMorph,SoundIconMorph.uber=ToggleButtonMorph.prototype,SoundIconMorph.prototype.thumbSize=new Point(80,60),SoundIconMorph.prototype.labelShadowOffset=null,SoundIconMorph.prototype.labelShadowColor=null,SoundIconMorph.prototype.labelColor=new Color(255,255,255),SoundIconMorph.prototype.fontSize=9,SoundIconMorph.prototype.init=function(t,e){var o,r,i;e||(o=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]),r=function(){nop()},i=function(){return!1},this.object=t,this.version=this.object.version,this.thumbnail=null,SoundIconMorph.uber.init.call(this,o,null,r,this.object.name,i,null,null,e),
this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},SoundIconMorph.prototype.createThumbnail=function(){var t;this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new Morph,this.thumbnail.setExtent(this.thumbSize),this.add(this.thumbnail),t=new StringMorph(this.createInfo(),"16","",!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,new Color(200,200,200)),this.thumbnail.add(t),t.setCenter(new Point(40,15)),this.button=new PushButtonMorph(this,"toggleAudioPlaying",this.object.previewAudio?"Stop":"Play"),this.button.drawNew(),this.button.hint="Play sound",this.button.fixLayout(),this.thumbnail.add(this.button),this.button.setCenter(new Point(40,40))},SoundIconMorph.prototype.createInfo=function(){var t=Math.round(this.object.audio.duration||0),e=t%60;return Math.floor(t/60).toString()+":"+(e<10?"0":"")+e.toString()},SoundIconMorph.prototype.toggleAudioPlaying=function(){var t=this;this.object.previewAudio?(this.button.labelString="Play",this.button.hint="Play sound",this.object.previewAudio.pause(),this.object.previewAudio.terminated=!0,this.object.previewAudio=null):(this.button.labelString="Stop",this.button.hint="Stop sound",this.object.previewAudio=this.object.play(),this.object.previewAudio.addEventListener("ended",function(){t.audioHasEnded()},!1)),this.button.createLabel()},SoundIconMorph.prototype.audioHasEnded=function(){this.button.trigger(),this.button.mouseLeave()},SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout,SoundIconMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.object instanceof Sound?(t.addItem("rename","renameSound"),t.addItem("delete","removeSound"),t):null},SoundIconMorph.prototype.renameSound=function(){var t=this.object,e=this.parentThatIsA(IDE_Morph),o=this;new DialogBoxMorph(null,function(r){r&&r!==t.name&&(t.name=r,t.version=Date.now(),o.createLabel(),o.fixLayout(),e.hasChangedMedia=!0)}).prompt("rename sound",t.name,this.world())},SoundIconMorph.prototype.removeSound=function(){var t=this.parentThatIsA(JukeboxMorph),e=this.parent.children.indexOf(this);t.removeSound(e)},SoundIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds,SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel,SoundIconMorph.prototype.prepareToBeGrabbed=function(){this.removeSound()},JukeboxMorph.prototype=new ScrollFrameMorph,JukeboxMorph.prototype.constructor=JukeboxMorph,JukeboxMorph.uber=ScrollFrameMorph.prototype,JukeboxMorph.prototype.init=function(t,e){this.sprite=t||new SpriteMorph,this.costumesVersion=null,this.spriteVersion=null,JukeboxMorph.uber.init.call(this,null,null,e),this.acceptsDrops=!1,this.fps=2,this.updateList()},JukeboxMorph.prototype.updateList=function(){var t,e,o,r=this,i=this.left()+5,n=this.top()+5,s=4,a=Morph.prototype.trackChanges;this.changed(),a=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=function(t){r.reactToDropOf(t)},this.addBack(this.contents),o=new TextMorph(localize("import a sound from your computer\nby dragging it into here")),o.fontSize=9,o.setColor(SpriteMorph.prototype.paletteTextColor),o.setPosition(new Point(i,n)),this.addContents(o),n=o.bottom()+s,this.sprite.sounds.asArray().forEach(function(o){e=t=new SoundIconMorph(o,e),t.setPosition(new Point(i,n)),r.addContents(t),n=t.bottom()+s}),Morph.prototype.trackChanges=a,this.changed(),this.updateSelection()},JukeboxMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(t){t.refresh&&t.refresh()}),this.spriteVersion=this.sprite.version},JukeboxMorph.prototype.removeSound=function(t){this.sprite.sounds.remove(t),this.updateList()},JukeboxMorph.prototype.wantsDropOf=function(t){return t instanceof SoundIconMorph},JukeboxMorph.prototype.reactToDropOf=function(t){var e=0,o=t.object,r=t.top();t.destroy(),this.contents.children.forEach(function(t){t.top()<r-4&&(e+=1)}),this.sprite.sounds.add(o,e),this.updateList()},StageHandleMorph.prototype=new Morph,StageHandleMorph.prototype.constructor=StageHandleMorph,StageHandleMorph.uber=Morph.prototype,StageHandleMorph.prototype.init=function(t){this.target=t||null,HandleMorph.uber.init.call(this),this.color=MorphicPreferences.isFlat?IDE_Morph.prototype.groupColor:new Color(190,190,190),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(12,50))},StageHandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent()),this.highlightImage=newCanvas(this.extent()),this.drawOnCanvas(this.normalImage,this.color),this.drawOnCanvas(this.highlightImage,MorphicPreferences.isFlat?new Color(245,245,255):new Color(100,100,255),this.color),this.image=this.normalImage,this.fixLayout()},StageHandleMorph.prototype.drawOnCanvas=function(t,e,o){var r,i,n,s=t.getContext("2d"),a=t.height/8,h=t.width/6,l=h/2;for(s.lineWidth=h,s.lineCap="round",i=t.height/2,s.strokeStyle=e.toString(),r=t.width/12,n=0;n<3;n+=1)n>0&&(s.beginPath(),s.moveTo(r,i-(a-l)),s.lineTo(r,i+(a-l)),s.stroke()),r+=2*h,a*=2;if(o)for(s.strokeStyle=o.toString(),r=t.width/12+h,a=t.height/8,n=0;n<3;n+=1)n>0&&(s.beginPath(),s.moveTo(r,i-(a-l)),s.lineTo(r,i+(a-l)),s.stroke()),r+=2*h,a*=2},StageHandleMorph.prototype.fixLayout=function(){if(this.target){var t=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10),this.setRight(this.target.left()),t&&t.add(this)}},StageHandleMorph.prototype.step=null,StageHandleMorph.prototype.mouseDownLeft=function(t){var e=this.world(),o=this.right()-t.x,r=this,i=this.target.parentThatIsA(IDE_Morph);return this.target?(i.isSmallStage=!0,i.controlBar.stageSizeButton.refresh(),void(this.step=function(){var t,n;e.hand.mouseButton?(t=e.hand.bounds.origin.x+o,n=r.target.right()-t,i.stageRatio=n/r.target.dimensions.x,i.setExtent(e.extent())):(this.step=null,i.isSmallStage=1!==i.stageRatio,i.controlBar.stageSizeButton.refresh())})):null},StageHandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage,this.changed()},StageHandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage,this.changed()},StageHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).toggleStageSize(!0,1)},PaletteHandleMorph.prototype=new Morph,PaletteHandleMorph.prototype.constructor=PaletteHandleMorph,PaletteHandleMorph.uber=Morph.prototype,PaletteHandleMorph.prototype.init=function(t){this.target=t||null,HandleMorph.uber.init.call(this),this.color=MorphicPreferences.isFlat?new Color(255,255,255):new Color(190,190,190),this.isDraggable=!1,this.noticesTransparentClick=!0,this.setExtent(new Point(12,50))},PaletteHandleMorph.prototype.drawNew=StageHandleMorph.prototype.drawNew,PaletteHandleMorph.prototype.drawOnCanvas=StageHandleMorph.prototype.drawOnCanvas,PaletteHandleMorph.prototype.fixLayout=function(){if(this.target){var t=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10),this.setRight(this.target.right()),t&&t.add(this)}},PaletteHandleMorph.prototype.step=null,PaletteHandleMorph.prototype.mouseDownLeft=function(t){var e=this.world(),o=this.right()-t.x,r=this.target.parentThatIsA(IDE_Morph);return this.target?void(this.step=function(){var t;e.hand.mouseButton?(t=e.hand.bounds.origin.x+o,r.paletteWidth=Math.min(Math.max(200,t),r.stageHandle.left()-r.spriteBar.tabBar.width()),r.setExtent(e.extent())):this.step=null}):null},PaletteHandleMorph.prototype.mouseEnter=StageHandleMorph.prototype.mouseEnter,PaletteHandleMorph.prototype.mouseLeave=StageHandleMorph.prototype.mouseLeave,PaletteHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).setPaletteWidth(200)},modules.paint="2016-July-14";var PaintEditorMorph,PaintCanvasMorph,PaintColorPickerMorph;PaintEditorMorph.prototype=new DialogBoxMorph,PaintEditorMorph.prototype.constructor=PaintEditorMorph,PaintEditorMorph.uber=DialogBoxMorph.prototype,PaintEditorMorph.prototype.padding=10,PaintEditorMorph.prototype.init=function(){this.paper=null,this.oncancel=null,PaintEditorMorph.uber.init.call(this),this.labelString="Paint Editor",this.createLabel(),this.buildContents()},PaintEditorMorph.prototype.buildContents=function(){var t=this;this.paper=new PaintCanvasMorph(function(){return t.shift}),this.paper.setExtent(StageMorph.prototype.dimensions),this.addBody(new AlignmentMorph("row",this.padding)),this.controls=new AlignmentMorph("column",this.padding/2),this.controls.alignment="left",this.edits=new AlignmentMorph("row",this.padding/2),this.buildEdits(),this.controls.add(this.edits),this.body.color=this.color,this.body.add(this.controls),this.body.add(this.paper),this.toolbox=new BoxMorph,this.toolbox.color=SpriteMorph.prototype.paletteColor.lighter(8),this.toolbox.borderColor=this.toolbox.color.lighter(40),MorphicPreferences.isFlat&&(this.toolbox.edge=0),this.buildToolbox(),this.controls.add(this.toolbox),this.scaleBox=new AlignmentMorph("row",this.padding/2),this.buildScaleBox(),this.controls.add(this.scaleBox),this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null},this.populatePropertiesMenu(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.refreshToolButtons(),this.fixLayout(),this.drawNew()},PaintEditorMorph.prototype.buildToolbox=function(){var t={brush:"Paintbrush tool\n(free draw)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: vertical/horizontal)",rectangleSolid:"Filled Rectangle\n(shift: square)",circleSolid:"Filled Ellipse\n(shift: circle)",paintbucket:"Fill a region",pipette:"Pipette tool\n(pick a color anywhere)"},e=this,o=this.toolbox.left(),r=this.toolbox.top(),i=2,n=5,s=0,a=0;Object.keys(t).forEach(function(n){var h=e.toolButton(n,t[n]);h.setPosition(new Point(o+s,r+a)),s+=h.width()+i,"crosshairs"===n&&(s=0,a+=h.height()+i,e.paper.drawcrosshair()),e.toolbox[n]=h,e.toolbox.add(h)}),this.toolbox.bounds=this.toolbox.fullBounds().expandBy(2*n),this.toolbox.drawNew()},PaintEditorMorph.prototype.buildEdits=function(){var t=this.paper;this.edits.add(this.pushButton("undo",function(){t.undo()})),this.edits.add(this.pushButton("clear",function(){t.clearCanvas()})),this.edits.fixLayout()},PaintEditorMorph.prototype.buildScaleBox=function(){var t=this.paper;this.scaleBox.add(this.pushButton("grow",function(){t.scale(.05,.05)})),this.scaleBox.add(this.pushButton("shrink",function(){t.scale(-.05,-.05)})),this.scaleBox.add(this.pushButton("flip ",function(){t.scale(-2,0)})),this.scaleBox.add(this.pushButton("flip ",function(){t.scale(0,-2)})),this.scaleBox.fixLayout()},PaintEditorMorph.prototype.openIn=function(t,e,o,r){this.oldim=e,this.callback=r||nop,this.processKeyUp=function(){this.shift=!1,this.propertiesControls.constrain.refresh()},this.processKeyDown=function(){this.shift=16===this.world().currentKey,this.propertiesControls.constrain.refresh()},this.oldim&&(this.paper.automaticCrosshairs=isNil(o),this.paper.centermerge(this.oldim,this.paper.paper),this.paper.rotationCenter=(o||new Point(0,0)).add(new Point((this.paper.paper.width-this.oldim.width)/2,(this.paper.paper.height-this.oldim.height)/2)),this.paper.drawNew()),this.key="paint",this.popUp(t)},PaintEditorMorph.prototype.fixLayout=function(){var t=Morph.prototype.trackChanges;this.changed(),t=Morph.prototype.trackChanges,Morph.prototype.trackChanges=!1,this.paper&&(this.paper.buildContents(),this.paper.drawNew()),this.controls&&this.controls.fixLayout(),this.body&&this.body.fixLayout(),PaintEditorMorph.uber.fixLayout.call(this),Morph.prototype.trackChanges=t,this.changed()},PaintEditorMorph.prototype.refreshToolButtons=function(){this.toolbox.children.forEach(function(t){t.refresh()})},PaintEditorMorph.prototype.ok=function(){this.paper.updateAutomaticCenter(),this.callback(this.paper.paper,this.paper.rotationCenter),this.destroy()},PaintEditorMorph.prototype.cancel=function(){this.oncancel&&this.oncancel(),this.destroy()},PaintEditorMorph.prototype.populatePropertiesMenu=function(){var t=this.controls,e=this,o=this.propertiesControls,r=new AlignmentMorph("row",this.padding);o.primaryColorViewer=new Morph,o.primaryColorViewer.setExtent(new Point(180,50)),o.primaryColorViewer.color=new Color(0,0,0),o.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(t){var r,i,n=newCanvas(o.primaryColorViewer.extent()),s=n.getContext("2d");if(e.paper.settings.primarycolor=t,"transparent"===t)for(r=0;r<180;r+=5)for(i=0;i<15;i+=5)s.fillStyle=(i+r)/5%2===0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",s.fillRect(r,i,5,5);else s.fillStyle=t.toString(),s.fillRect(0,0,180,15);s.strokeStyle="black",s.lineWidth=Math.min(e.paper.settings.linewidth,20),s.beginPath(),s.lineCap="round",s.moveTo(20,30),s.lineTo(160,30),s.stroke(),o.primaryColorViewer.image=n,o.primaryColorViewer.changed()}),o.colorpicker.action(new Color(0,0,0)),o.penSizeSlider=new SliderMorph(0,20,5,5),o.penSizeSlider.orientation="horizontal",o.penSizeSlider.setHeight(15),o.penSizeSlider.setWidth(150),o.penSizeSlider.action=function(t){o.penSizeField&&o.penSizeField.setContents(t),e.paper.settings.linewidth=t,o.colorpicker.action(e.paper.settings.primarycolor)},o.penSizeField=new InputFieldMorph("5",!0,null,!1),o.penSizeField.contents().minWidth=20,o.penSizeField.setWidth(25),o.penSizeField.accept=function(){var t=parseFloat(o.penSizeField.getValue());o.penSizeSlider.value=t,o.penSizeSlider.drawNew(),o.penSizeSlider.updateValue(),this.setContents(t),e.paper.settings.linewidth=t,this.world().keyboardReceiver=e,o.colorpicker.action(e.paper.settings.primarycolor)},r.add(o.penSizeSlider),r.add(o.penSizeField),r.color=e.color,r.fixLayout(),o.penSizeField.drawNew(),o.constrain=new ToggleMorph("checkbox",this,function(){e.shift=!e.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return e.shift}),t.add(o.colorpicker),t.add(o.primaryColorViewer),t.add(new TextMorph(localize("Brush size"))),t.add(r),t.add(o.constrain)},PaintEditorMorph.prototype.toolButton=function(t,e){var o,r=this;return o=new ToggleButtonMorph(null,this,function(){r.paper.currentTool=t,r.paper.toolChanged(t),r.refreshToolButtons(),"pipette"===t&&r.getUserColor()},new SymbolMorph(t,18),function(){return r.paper.currentTool===t}),o.hint=e,o.drawNew(),o.fixLayout(),o},PaintEditorMorph.prototype.pushButton=function(t,e,o){return new PushButtonMorph(this,e,t,null,o)},PaintEditorMorph.prototype.getUserColor=function(){var t=this,e=this.world(),o=e.hand,r=getDocumentPositionOf(e.worldCanvas),i=o.processMouseMove,n=o.processMouseDown,s=o.processMouseUp;o.processMouseMove=function(i){var n;o.setPosition(new Point(i.pageX-r.x,i.pageY-r.y)),n=e.getGlobalPixelColor(o.position()),n.a=255,t.propertiesControls.colorpicker.action(n)},o.processMouseDown=nop,o.processMouseUp=function(){t.paper.currentTool="brush",t.paper.toolChanged("brush"),t.refreshToolButtons(),o.processMouseMove=i,o.processMouseDown=n,o.processMouseUp=s}},PaintColorPickerMorph.prototype=new Morph,PaintColorPickerMorph.prototype.constructor=PaintColorPickerMorph,PaintColorPickerMorph.uber=Morph.prototype,PaintColorPickerMorph.prototype.init=function(t,e){this.setExtent(t||new Point(200,100)),this.action=e||nop,this.drawNew()},PaintColorPickerMorph.prototype.drawNew=function(){var t,e,o=0,r=0,i=newCanvas(this.extent()),n=i.getContext("2d");for(o=0;o<this.width();o+=1)for(r=0;r<this.height()-20;r+=1)n.fillStyle="hsl("+360*o/this.width()+",100%,"+100*r/(this.height()-20)+"%)",n.fillRect(o,r,1,1);for(o=0;o<this.width();o+=1)e=Math.floor(255*o/this.width()),n.fillStyle="rgb("+e+", "+e+", "+e+")",n.fillRect(o,this.height()-20,1,10);for(t=["black","white","gray"],o=0;o<t.length;o+=1)n.fillStyle=t[o],n.fillRect(o*this.width()/t.length,this.height()-10,this.width()/t.length,10);for(o=2*this.width()/3;o<this.width();o+=2)for(r=this.height()-10;r<this.height();r+=2)(o+r)/2%2===0&&(n.fillStyle="#DDD",n.fillRect(o,r,2,2));this.image=i},PaintColorPickerMorph.prototype.mouseDownLeft=function(t){t.subtract(this.position()).x>2*this.width()/3&&t.subtract(this.position()).y>this.height()-10?this.action("transparent"):this.action(this.getPixelColor(t))},PaintColorPickerMorph.prototype.mouseMove=PaintColorPickerMorph.prototype.mouseDownLeft,PaintCanvasMorph.prototype=new Morph,PaintCanvasMorph.prototype.constructor=PaintCanvasMorph,PaintCanvasMorph.uber=Morph.prototype,PaintCanvasMorph.prototype.init=function(t){this.rotationCenter=new Point(240,180),this.dragRect=null,this.previousDragPoint=null,this.currentTool="brush",this.dragRect=new Rectangle,this.mask=newCanvas(this.extent(),!0),this.paper=newCanvas(this.extent(),!0),this.erasermask=newCanvas(this.extent(),!0),this.background=newCanvas(this.extent()),this.settings={primarycolor:new Color(0,0,0,255),secondarycolor:new Color(0,0,0,255),linewidth:3},this.brushBuffer=[],this.undoBuffer=[],this.isShiftPressed=t||function(){var t=this.world().currentKey;return 16===t},this.automaticCrosshairs=!0,this.noticesTransparentClick=!0,this.buildContents()},PaintCanvasMorph.prototype.calculateCanvasCenter=function(t){var e=Costume.prototype.canvasBoundingBox(t);return null===e?null:new Point((e.origin.x+e.corner.x)/2,(e.origin.y+e.corner.y)/2)},PaintCanvasMorph.prototype.updateAutomaticCenter=function(){if(this.automaticCrosshairs){var t=this.calculateCanvasCenter(this.paper);null!==t&&(this.rotationCenter=t)}},PaintCanvasMorph.prototype.scale=function(t,e){this.updateAutomaticCenter(),this.mask=newCanvas(this.extent(),!0);var o=newCanvas(this.extent(),!0);o.getContext("2d").save(),o.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y),o.getContext("2d").scale(1+t,1+e),o.getContext("2d").drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y),o.getContext("2d").restore(),this.paper=o,this.drawNew(),this.changed()},PaintCanvasMorph.prototype.cacheUndo=function(){var t=newCanvas(this.extent(),!0);this.merge(this.paper,t),this.undoBuffer.push(t)},PaintCanvasMorph.prototype.undo=function(){this.undoBuffer.length>0&&(this.paper=newCanvas(this.extent(),!0),this.mask.width=this.mask.width+1-1,this.merge(this.undoBuffer.pop(),this.paper),this.drawNew(),this.changed())},PaintCanvasMorph.prototype.merge=function(t,e){e.getContext("2d").drawImage(t,0,0)},PaintCanvasMorph.prototype.centermerge=function(t,e){e.getContext("2d").drawImage(t,(e.width-t.width)/2,(e.height-t.height)/2)},PaintCanvasMorph.prototype.clearCanvas=function(){this.buildContents(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.toolChanged=function(t){this.mask=newCanvas(this.extent(),!0),"crosshairs"===t&&(this.updateAutomaticCenter(),this.drawcrosshair()),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.drawcrosshair=function(t){var e=t||this.mask.getContext("2d"),o=this.rotationCenter;e.lineWidth=1,e.strokeStyle="black",e.clearRect(0,0,this.mask.width,this.mask.height),e.globalAlpha=.5,e.fillStyle="white",e.beginPath(),e.arc(o.x,o.y,20,radians(0),radians(360),!1),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.arc(o.x,o.y,10,radians(0),radians(360),!1),e.stroke(),e.beginPath(),e.moveTo(0,o.y),e.lineTo(this.mask.width,o.y),e.stroke(),e.beginPath(),e.moveTo(o.x,0),e.lineTo(o.x,this.mask.height),e.stroke(),this.drawNew(),this.changed()},PaintCanvasMorph.prototype.floodfill=function(t){var e,o,r,i,n=this.paper.width,s=this.paper.height,a=this.paper.getContext("2d"),h=a.getImageData(0,0,n,s),l=h.data,p=[Math.round(t.y)*n+t.x];if(o=function(t){var e=4*t;return[l[e],l[e+1],l[e+2],l[e+3]]},r=o(p[0]),i=function(t){return t[0]===r[0]&&t[1]===r[1]&&t[2]===r[2]&&t[3]===r[3]},(0!==r[3]||"transparent"!==this.settings.primarycolor)&&!(r[0]===this.settings.primarycolor.r&&r[1]===this.settings.primarycolor.g&&r[2]===this.settings.primarycolor.b&&r[3]===this.settings.primarycolor.a||0===r[3]&&0===this.settings.primarycolor.a)){for(;p.length>0;)e=p.pop(),i(o(e))&&(e%n>1&&(p.push(e+1),p.push(e-1)),e>0&&e<s*n&&(p.push(e+n),p.push(e-n))),"transparent"===this.settings.primarycolor?l[4*e+3]=0:(l[4*e]=this.settings.primarycolor.r,l[4*e+1]=this.settings.primarycolor.g,l[4*e+2]=this.settings.primarycolor.b,l[4*e+3]=255*this.settings.primarycolor.a);a.putImageData(h,0,0),this.drawNew(),this.changed()}},PaintCanvasMorph.prototype.mouseDownLeft=function(t){return this.cacheUndo(),this.dragRect.origin=t.subtract(this.bounds.origin),this.dragRect.corner=t.subtract(this.bounds.origin),this.previousDragPoint=this.dragRect.corner.copy(),"crosshairs"===this.currentTool?(this.rotationCenter=t.subtract(this.bounds.origin),void this.drawcrosshair()):"paintbucket"===this.currentTool?this.floodfill(t.subtract(this.bounds.origin)):void("transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool&&(this.erasermask=newCanvas(this.extent(),!0),this.merge(this.paper,this.erasermask)))},PaintCanvasMorph.prototype.mouseMove=function(t){function e(){return Math.max(Math.abs(c),Math.abs(d))*(c/Math.abs(c))}function o(){return Math.max(Math.abs(c),Math.abs(d))*(d/Math.abs(d))}if("paintbucket"!==this.currentTool){var r,i=t.subtract(this.bounds.origin),n=this.mask.getContext("2d"),s=this.paper.getContext("2d"),a=this.dragRect.origin.x,h=this.dragRect.origin.y,l=i.x,p=i.y,c=(l-a)/2,d=(p-h)/2,u=this.paper.width;switch(n.save(),this.brushBuffer.push([l,p]),n.lineWidth=this.settings.linewidth,n.clearRect(0,0,this.bounds.width(),this.bounds.height()),this.dragRect.corner=i.subtract(this.dragRect.origin),"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool?(this.merge(this.erasermask,this.mask),s.clearRect(0,0,this.bounds.width(),this.bounds.height()),n.globalCompositeOperation="destination-out"):(n.fillStyle=this.settings.primarycolor.toString(),n.strokeStyle=this.settings.primarycolor.toString()),this.currentTool){case"rectangle":this.isShiftPressed()?n.strokeRect(a,h,2*e(),2*o()):n.strokeRect(a,h,2*c,2*d);break;case"rectangleSolid":this.isShiftPressed()?n.fillRect(a,h,2*e(),2*o()):n.fillRect(a,h,2*c,2*d);break;case"brush":for(n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),r=0;r<this.brushBuffer.length;r+=1)n.lineTo(this.brushBuffer[r][0],this.brushBuffer[r][1]);n.stroke();break;case"line":n.beginPath(),n.moveTo(a,h),this.isShiftPressed()?Math.abs(d)>Math.abs(c)?n.lineTo(a,p):n.lineTo(l,h):n.lineTo(l,p),n.stroke();break;case"circle":case"circleSolid":if(n.beginPath(),this.isShiftPressed())n.arc(a,h,new Point(a,h).distanceTo(new Point(l,p)),0,2*Math.PI,!1);else{for(r=0;r<u;r+=1)n.lineTo(r,2*d*Math.sqrt(2-Math.pow((r-a)/(2*c),2))+h);for(r=u;r>0;r-=1)n.lineTo(r,-1*(2*d)*Math.sqrt(2-Math.pow((r-a)/(2*c),2))+h)}n.closePath(),"circleSolid"===this.currentTool?n.fill():"circle"===this.currentTool&&n.stroke();break;case"crosshairs":this.automaticCrosshairs=!1,this.rotationCenter=i.copy(),this.drawcrosshair(n);break;case"eraser":for(this.merge(this.paper,this.mask),n.save(),n.globalCompositeOperation="destination-out",n.beginPath(),n.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),r=0;r<this.brushBuffer.length;r+=1)n.lineTo(this.brushBuffer[r][0],this.brushBuffer[r][1]);n.stroke(),n.restore(),this.paper=newCanvas(this.extent(),!0),this.merge(this.mask,this.paper);break;default:nop()}this.previousDragPoint=i,this.drawNew(),this.changed(),n.restore()}},PaintCanvasMorph.prototype.mouseClickLeft=function(){"crosshairs"!==this.currentTool&&this.merge(this.mask,this.paper),this.brushBuffer=[]},PaintCanvasMorph.prototype.mouseLeaveDragging=PaintCanvasMorph.prototype.mouseClickLeft,PaintCanvasMorph.prototype.buildContents=function(){this.background=newCanvas(this.extent()),this.paper=newCanvas(this.extent(),!0),this.mask=newCanvas(this.extent(),!0),this.erasermask=newCanvas(this.extent(),!0);var t,e,o=this.background.getContext("2d");for(t=0;t<this.background.width;t+=5)for(e=0;e<this.background.height;e+=5)(t+e)/5%2===1?o.fillStyle="rgba(255, 255, 255, 1)":o.fillStyle="rgba(255, 255, 255, 0.3)",o.fillRect(t,e,5,5)},PaintCanvasMorph.prototype.drawNew=function(){var t=newCanvas(this.extent(),!0);this.merge(this.background,t),this.merge(this.paper,t),this.merge(this.mask,t),this.image=t,this.drawFrame()},PaintCanvasMorph.prototype.drawFrame=function(){var t,e;t=this.image.getContext("2d"),this.parent?(this.color=this.parent.color.lighter(.75*this.contrast),e=this.parent.color):e=new Color(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.drawRectBorder(t)},PaintCanvasMorph.prototype.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,PaintCanvasMorph.prototype.edge=InputFieldMorph.prototype.edge,PaintCanvasMorph.prototype.fontSize=InputFieldMorph.prototype.fontSize,PaintCanvasMorph.prototype.typeInPadding=InputFieldMorph.prototype.typeInPadding,PaintCanvasMorph.prototype.contrast=InputFieldMorph.prototype.contrast,modules.lists="2016-July-14";var List,ListWatcherMorph;List.prototype.enableTables=!1,List.prototype.toString=function(){return"a List ["+this.length+" elements]"},List.prototype.changed=function(){this.lastChanged=Date.now()},List.prototype.cons=function(t,e){var o=new List;if(!(e instanceof List||isNil(e)))throw new Error("cdr isn't a list: "+e);return o.first=isNil(t)?null:t,o.rest=e||null,o.isLinked=!0,o},List.prototype.cdr=function(){var t,e;if(this.isLinked)return this.rest||new List;if(this.contents.length<2)return new List;for(t=new List,e=this.contents.length;e>1;e-=1)t=this.cons(this.at(e),t);return t},List.prototype.add=function(t,e){var o=e||this.length()+1,r=isNil(t)?null:t;this.becomeArray(),this.contents.splice(o-1,0,r),this.changed()},List.prototype.put=function(t,e){var o=0===t?0:t!==!1&&(t||null);this.becomeArray(),this.contents[e-1]=o,this.changed()},List.prototype.remove=function(t){this.becomeArray(),this.contents.splice(t-1,1),this.changed()},List.prototype.clear=function(){this.contents=[],this.first=null,this.rest=null,this.isLinked=!1,this.changed()},List.prototype.length=function(){if(this.isLinked){for(var t=this,e=0;t&&t.isLinked;)e+=1,t=t.rest;return e+(t?t.contents.length:0)}return this.contents.length},List.prototype.at=function(t){for(var e,o=+t,r=this;r.isLinked;){if(!(o>1))return r.first;r=r.rest,o-=1}return e=r.contents[o-1],isNil(e)?"":e},List.prototype.contains=function(t){for(var e=this;e.isLinked;){if(snapEquals(e.first,t))return!0;e=e.rest}return e.contents.some(function(e){return snapEquals(e,t)})},List.prototype.isTable=function(){return this.enableTables&&(this.length()>100||this.cols()>1)},List.prototype.get=function(t,e){var o,r,i;return t?e?(o=this.at(e),o instanceof List?(r=o.length(),i=this.cols(),t>r?null:1===i&&r>1?[o]:t>=i&&r>i?new Variable(o.at(t)):o.at(t)):1===t&&e<=this.rows()?[o]:null):1===this.cols()?localize("items"):this.colName(t):e?e>this.rows()?null:this.rowName(e):[this.length()]},List.prototype.rows=function(){return this.length()},List.prototype.cols=function(){var t=this.at(1);return t instanceof List?t.length():1},List.prototype.colName=function(t){return t>this.cols()?null:String.fromCharCode(64+(t%26||26)).repeat(Math.floor((t-1)/26)+1)},List.prototype.rowName=function(t){return t},List.prototype.columnNames=function(){return[]},List.prototype.version=function(t,e){var o,r,i=Math.min(t+e,this.length()),n=this.lastChanged;for(r=t;r<=i;r+=1)o=this.at(r),n=Math.max(n,o.lastChanged?o.lastChanged:0);return n},List.prototype.asArray=function(){return this.becomeArray(),this.contents},List.prototype.itemsArray=function(){if(this.isLinked){for(var t,e=this,o=[];e&&e.isLinked;)o.push(e.first),e=e.rest;if(e)for(t=1;t<=e.contents.length;t+=1)o.push(e.at(t));return o}return this.contents},List.prototype.asText=function(){for(var t,e,o,r="",i=this;i.isLinked;)e=i.first,e instanceof List?r=r.concat(e.asText()):(e=isNil(e)?"":e.toString(),r=r.concat(e)),i=i.rest;for(t=i.length(),o=1;o<=t;o+=1)e=i.at(o),e instanceof List?r=r.concat(e.asText()):(e=isNil(e)?"":e.toString(),r=r.concat(e));return r},List.prototype.becomeArray=function(){this.isLinked&&(this.contents=this.itemsArray(),this.isLinked=!1,this.first=null,this.rest=null)},List.prototype.becomeLinked=function(){var t,e,o=this;if(!this.isLinked){for(e=this.length(),t=0;t<e;t+=1)o.first=this.contents[t],t<e-1&&(o.rest=new List,o.isLinked=!0,o=o.rest);this.contents=[],this.isLinked=!0}},List.prototype.equalTo=function(t){var e,o,r,i=this,n=t;if(!(t instanceof List))return!1;for(;i.isLinked&&n.isLinked;){if(!snapEquals(i.first,n.first))return!1;i=i.rest,n=n.rest}for(n.isLinked&&(e=n,n=i,i=e),o=0;i.isLinked;){if(!snapEquals(i.first,n.contents[o]))return!1;i=i.rest,o+=1}if(e=0,i.contents.length!==n.contents.length-o)return!1;for(r=i.contents.length;r>0;){if(r-=1,!snapEquals(i.contents[e],n.contents[o]))return!1;e+=1,o+=1}return!0},ListWatcherMorph.prototype=new BoxMorph,ListWatcherMorph.prototype.constructor=ListWatcherMorph,ListWatcherMorph.uber=BoxMorph.prototype,ListWatcherMorph.prototype.cellColor=SpriteMorph.prototype.blockColor.lists,ListWatcherMorph.prototype.init=function(t,e){var o=this;this.list=t||new List,this.start=1,this.range=100,this.lastUpdated=Date.now(),this.lastCell=null,this.parentCell=e||null,this.label=new StringMorph(localize("length: ")+this.list.length(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.label.mouseClickLeft=function(){o.startIndexMenu()},this.frame=new ScrollFrameMorph(null,10),this.frame.alpha=0,this.frame.acceptsDrops=!1,this.frame.contents.acceptsDrops=!1,this.handle=new HandleMorph(this,80,70,3,3),this.handle.setExtent(new Point(13,13)),this.arrow=new ArrowMorph("down",SyntaxElementMorph.prototype.fontSize),this.arrow.mouseClickLeft=function(){o.startIndexMenu()},this.arrow.setRight(this.handle.right()),this.arrow.setBottom(this.handle.top()),this.handle.add(this.arrow),this.plusButton=new PushButtonMorph(this.list,"add","+"),this.plusButton.padding=0,this.plusButton.edge=0,this.plusButton.outlineColor=this.color,this.plusButton.drawNew(),this.plusButton.fixLayout(),ListWatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120)),this.color=new Color(220,220,220),this.isDraggable=!1,this.setExtent(new Point(80,70).multiplyBy(SyntaxElementMorph.prototype.scale)),this.add(this.label),this.add(this.frame),this.add(this.plusButton),this.add(this.handle),this.handle.drawNew(),this.update(),this.fixLayout()},ListWatcherMorph.prototype.update=function(t){var e,o,r,i,n,s,a,h,l,p,c=1e3;if(this.frame.contents.children.forEach(function(t){t instanceof CellMorph&&(t.contentsMorph instanceof ListWatcherMorph?t.contentsMorph.update():isSnapObject(t.contents)&&t.update())}),this.lastUpdated===this.list.lastChanged&&!t)return null;for(this.updateLength(!0),this.start=Math.max(Math.min(this.start,Math.floor((this.list.length()-1)/this.range)*this.range+1),1),l=Math.min(this.start+this.range-1,this.list.length()),r=Math.min(3*(l-this.start+1),this.frame.contents.children.length),e=0;e<r;e+=3)o=this.start+e/3,n=this.frame.contents.children[e],a=this.frame.contents.children[e+1],h=this.frame.contents.children[e+2],s=this.list.at(o),n.contents!==s&&(n.contents=s,n.drawNew(),this.lastCell&&n.setLeft(this.lastCell.left())),this.lastCell=n,a.text!==o.toString()&&(a.text=o.toString(),a.drawNew()),h.action=o;for(i=3*(l-this.start+1);this.frame.contents.children.length>i;)this.frame.contents.children[i].destroy();if(r=i,e=this.frame.contents.children.length,p=Date.now(),r>e+1)for(e;e<r;e+=3){if(Date.now()-p>c)return this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),null;o=this.start+e/3,a=new StringMorph(o.toString(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),
n=new CellMorph(this.list.at(o),this.cellColor,o,this.parentCell),h=new PushButtonMorph(this.list.remove,o,"-",this.list),h.padding=1,h.edge=0,h.corner=1,h.outlineColor=this.color.darker(),h.drawNew(),h.fixLayout(),this.frame.contents.add(n),this.lastCell?n.setPosition(this.lastCell.bottomLeft()):n.setTop(this.frame.contents.top()),this.lastCell=n,a.setCenter(n.center()),a.setRight(n.left()-2),this.frame.contents.add(a),this.frame.contents.add(h)}this.lastCell=null,this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),this.updateLength(),this.lastUpdated=this.list.lastChanged},ListWatcherMorph.prototype.updateLength=function(t){this.label.text=localize("length: ")+this.list.length(),t?this.label.color=new Color(0,0,100):this.label.color=new Color(0,0,0),this.label.drawNew(),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3)},ListWatcherMorph.prototype.startIndexMenu=function(){var t,e,o=this,r=Math.ceil(this.list.length()/this.range),i=new MenuMorph(function(t){o.setStartIndex(t)},null,o);for(i.addItem("1...",1),t=1;t<r;t+=1)e=100*t+1,i.addItem(e+"...",e);i.popUpAtHand(this.world())},ListWatcherMorph.prototype.setStartIndex=function(t){this.start=t,this.list.changed()},ListWatcherMorph.prototype.fixLayout=function(){this.label&&(Morph.prototype.trackChanges=!1,this.frame&&(this.arrangeCells(),this.frame.silentSetPosition(this.position().add(3)),this.frame.bounds.corner=this.bounds.corner.subtract(new Point(3,17)),this.frame.drawNew(),this.frame.contents.adjustBounds()),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3),this.plusButton.setLeft(this.left()+3),this.plusButton.setBottom(this.bottom()-3),Morph.prototype.trackChanges=!0,this.changed(),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())},ListWatcherMorph.prototype.arrangeCells=function(){var t,e,o,r,i,n=this.frame.contents.children.length;for(t=0;t<n;t+=3)e=this.frame.contents.children[t],o=this.frame.contents.children[t+1],r=this.frame.contents.children[t+2],i&&e.setTop(i.bottom()),o&&(o.setTop(e.center().y-o.height()/2),o.setRight(e.left()-2)),r&&(r.setCenter(e.center()),r.setLeft(e.right()+2)),i=e;this.frame.contents.adjustBounds()},ListWatcherMorph.prototype.expand=function(t){var e=this.frame.contents.extent(),o=new Point(e.x+6,e.y+this.label.height()+6);t&&(o=o.min(t)),this.setExtent(o),this.handle.setRight(this.right()-3),this.handle.setBottom(this.bottom()-3)},ListWatcherMorph.prototype.userMenu=function(){if(!List.prototype.enableTables)return this.escalateEvent("userMenu");var t=new MenuMorph(this),e=this;return t.addItem("table view...","showTableView"),t.addLine(),t.addItem("open in dialog...",function(){new TableDialogMorph(e.list).popUp(e.world())}),t},ListWatcherMorph.prototype.showTableView=function(){var t=this.parentThatIsAnyOf([SpriteBubbleMorph,SpeechBubbleMorph,CellMorph]);t&&(t instanceof SpriteBubbleMorph?(t.changed(),t.drawNew(!0)):t instanceof SpeechBubbleMorph?(t.contents=new TableFrameMorph(new TableMorph(this.list,10)),t.contents.expand(this.extent()),t.drawNew(!0)):(t.drawNew(!0,"table"),t.contentsMorph.expand(this.extent())),t.fixLayout())},ListWatcherMorph.prototype.mouseDoubleClick=function(t){List.prototype.enableTables?new TableDialogMorph(this.list).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},ListWatcherMorph.prototype.show=function(){ListWatcherMorph.uber.show.call(this),this.frame.contents.adjustBounds()},ListWatcherMorph.prototype.drawNew=function(){WatcherMorph.prototype.drawNew.call(this),this.fixLayout()},modules.byob="2016-July-14";var CustomBlockDefinition,CustomCommandBlockMorph,CustomReporterBlockMorph,BlockDialogMorph,BlockEditorMorph,PrototypeHatBlockMorph,BlockLabelFragment,BlockLabelFragmentMorph,BlockInputFragmentMorph,BlockLabelPlaceHolderMorph,InputSlotDialogMorph,VariableDialogMorph,JaggedBlockMorph,BlockExportDialogMorph,BlockImportDialogMorph,BlockRemovalDialogMorph;CustomBlockDefinition.prototype.blockInstance=function(){var t;return t="command"===this.type?new CustomCommandBlockMorph(this):new CustomReporterBlockMorph(this,"predicate"===this.type),t.isDraggable=!0,t},CustomBlockDefinition.prototype.templateInstance=function(){var t;return t=this.blockInstance(),t.refreshDefaults(),t.isDraggable=!1,t.isTemplate=!0,t},CustomBlockDefinition.prototype.prototypeInstance=function(){var t,e,o=this;return t="command"===this.type?new CustomCommandBlockMorph(this,!0):new CustomReporterBlockMorph(this,"predicate"===this.type,!0),t.parts().forEach(function(t){t instanceof BlockInputFragmentMorph&&(e=o.declarations[t.fragment.labelString],e&&(t.fragment.type=e[0],t.fragment.defaultValue=e[1],t.fragment.options=e[2],t.fragment.isReadOnly=e[3]||!1))}),t},CustomBlockDefinition.prototype.copyAndBindTo=function(t){var e=copy(this);return e.receiver=t,e.declarations=copy(this.declarations),e.body&&(e.body=Process.prototype.reify.call(null,this.body.expression,new List(this.inputNames())),e.body.outerContext=null),e},CustomBlockDefinition.prototype.blockSpec=function(){var t,e=this,o=[],r=this.parseSpec(this.spec);return r.forEach(function(r){t="%"===r[0]&&r.length>1?e.typeOf(r.slice(1)):r,o.push(t),o.push(" ")}),"".concat.apply("",o).trim()},CustomBlockDefinition.prototype.helpSpec=function(){var t=[],e=this.parseSpec(this.spec);return e.forEach(function(e){"%"!==e[0]&&t.push(e)}),"".concat.apply("",t).replace(/\?/g,"")},CustomBlockDefinition.prototype.typeOf=function(t){return this.declarations[t]?this.declarations[t][0]:"%s"},CustomBlockDefinition.prototype.defaultValueOf=function(t){return this.declarations[t]?this.declarations[t][1]:""},CustomBlockDefinition.prototype.defaultValueOfInputIdx=function(t){var e=this.inputNames()[t];return this.defaultValueOf(e)},CustomBlockDefinition.prototype.dropDownMenuOfInputIdx=function(t){var e=this.inputNames()[t];return this.dropDownMenuOf(e)},CustomBlockDefinition.prototype.isReadOnlyInputIdx=function(t){var e=this.inputNames()[t];return this.isReadOnlyInput(e)},CustomBlockDefinition.prototype.inputOptionsOfIdx=function(t){var e=this.inputNames()[t];return this.inputOptionsOf(e)},CustomBlockDefinition.prototype.dropDownMenuOf=function(t){var e={};return this.declarations[t]&&this.declarations[t][2]?(this.declarations[t][2].split("\n").forEach(function(t){var o=t.split("=");e[o[0]]=isNil(o[1])?o[0]:o[1]}),e):null},CustomBlockDefinition.prototype.isReadOnlyInput=function(t){return this.declarations[t]&&this.declarations[t][3]===!0},CustomBlockDefinition.prototype.inputOptionsOf=function(t){return[this.dropDownMenuOf(t),this.isReadOnlyInput(t)]},CustomBlockDefinition.prototype.inputNames=function(){var t=[],e=this.parseSpec(this.spec);return e.forEach(function(e){"%"===e[0]&&e.length>1&&t.push(e.slice(1))}),t},CustomBlockDefinition.prototype.parseSpec=function(t){var e,o,r=[],i="",n=!1;for(e=0;e<t.length;e+=1)o=t[e],"'"===o?n=!n:" "!==o||n?i=i.concat(o):(r.push(i),i="");return r.push(i),r},CustomBlockDefinition.prototype.scriptsPicture=function(){return this.scriptsModel().scriptsPicture()},CustomBlockDefinition.prototype.sortedElements=function(){return this.scriptsModel().sortedElements()},CustomBlockDefinition.prototype.scriptsModel=function(){var t,e,o,r,i;return t=new ScriptsMorph,t.cleanUpMargin=10,e=new PrototypeHatBlockMorph(this),e.setPosition(t.position().add(10)),null!==this.comment&&(r=this.comment.fullCopy(),e.comment=r,r.block=e),null!==this.body&&e.nextBlock(this.body.expression.fullCopy()),t.add(e),e.fixBlockColor(null,!0),this.scripts.forEach(function(e){o=e.fullCopy(),o.setPosition(t.position().add(e.position())),t.add(o),o instanceof BlockMorph&&o.allComments().forEach(function(t){t.align(o)})}),e.allComments().forEach(function(t){t.align(e)}),i=e.parts()[0],i.fixLayout(),i.forceNormalColoring(),i.fixBlockColor(e,!0),t.fixMultiArgs(),t},CustomCommandBlockMorph.prototype=new CommandBlockMorph,CustomCommandBlockMorph.prototype.constructor=CustomCommandBlockMorph,CustomCommandBlockMorph.uber=CommandBlockMorph.prototype,CustomCommandBlockMorph.prototype.init=function(t,e){this.definition=t,this.isPrototype=e||!1,CustomCommandBlockMorph.uber.init.call(this,!0),this.category=t.category,this.selector="evaluateCustomBlock",this.variables=null,this.initializeVariables(),t&&this.refresh()},CustomCommandBlockMorph.prototype.initializeVariables=function(t){var e=this;this.variables=new VariableFrame,this.definition.variableNames.forEach(function(o){var r=t?t[o]:null;e.variables.addVar(o,r instanceof Variable?r.value:null)})},CustomCommandBlockMorph.prototype.refresh=function(t){var e,o=this.definition,r=this.isPrototype?o.spec:o.blockSpec();this.setCategory(o.category),this.blockSpec!==r?(e=this.inputs(),this.zebraContrast?this.fixBlockColor():this.forceNormalColoring(),this.setSpec(r,t),this.fixLabelColor(),this.restoreInputs(e)):this.inputs().forEach(function(t,e){t instanceof InputSlotMorph&&t.setChoices.apply(t,o.inputOptionsOfIdx(e))}),this.cachedInputs=null,this.inputs().forEach(function(t,e){t instanceof TemplateSlotMorph&&""===t.contents()&&t.setContents(o.inputNames()[e])}),this.initializeVariables(this.variables.vars),this.forceNormalColoring(),this.drawNew(),this.fixBlockColor(null,!0)},CustomCommandBlockMorph.prototype.restoreInputs=function(t){var e,o=0,r=this;this.isPrototype||(this.cachedInputs=null,this.inputs().forEach(function(i){e=t[o],e instanceof ReporterBlockMorph&&!(i instanceof TemplateSlotMorph)?r.silentReplaceInput(i,e.fullCopy()):e instanceof InputSlotMorph&&i instanceof InputSlotMorph?i.setContents(e.evaluate()):e instanceof TemplateSlotMorph&&i instanceof TemplateSlotMorph?i.setContents(e.evaluate()):e instanceof CSlotMorph&&i instanceof CSlotMorph&&i.nestedBlock(e.evaluate()),o+=1}),this.cachedInputs=null)},CustomCommandBlockMorph.prototype.refreshDefaults=function(){var t=this.inputs(),e=0,o=this;t.forEach(function(t){t instanceof InputSlotMorph&&t.setContents(o.definition.defaultValueOfInputIdx(e)),e+=1}),this.cachedInputs=null},CustomCommandBlockMorph.prototype.refreshPrototype=function(){var t,e,o,r,i=[],n=this,s=0;return this.isPrototype?(t=this.parentThatIsA(PrototypeHatBlockMorph),this.parts().forEach(function(t){t.fragment.isDeleted||(t.fragment.type?i.push(t.fragment):(o=n.definition.parseSpec(t.fragment.labelString),o.forEach(function(e){r=t.fragment.copy(),r.labelString=e,i.push(r)})))}),e=this.specFromFragments(),this instanceof CustomCommandBlockMorph&&("reporter"===t.type||"predicate"===t.type)?(n=new CustomReporterBlockMorph(this.definition,"predicate"===t.type,!0),t.silentReplaceInput(this,n)):this instanceof CustomReporterBlockMorph&&("command"===t.type?(n=new CustomCommandBlockMorph(this.definition,!0),t.silentReplaceInput(this,n)):(this.isPredicate="predicate"===t.type,this.drawNew())),n.setCategory(t.blockCategory||"other"),t.fixBlockColor(),n.setSpec(e),n.parts().forEach(function(t){t instanceof BlockLabelPlaceHolderMorph||(i[s]&&(t.fragment=i[s]),s+=1)}),this.refreshPrototypeSlotTypes(),void t.fixLayout()):null},CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes=function(){this.parts().forEach(function(t){t instanceof BlockInputFragmentMorph&&(t.template().instantiationSpec=t.contents(),t.setContents(t.fragment.defTemplateSpecFragment()))}),this.fixBlockColor(null,!0)},CustomCommandBlockMorph.prototype.inputFragmentNames=function(){var t=[];return this.parts().forEach(function(e){!e.fragment.isDeleted&&e.fragment.type&&t.push(e.fragment.labelString)}),t},CustomCommandBlockMorph.prototype.upvarFragmentNames=function(){var t=[];return this.parts().forEach(function(e){e.fragment.isDeleted||"%upvar"!==e.fragment.type||t.push(e.fragment.labelString)}),t},CustomCommandBlockMorph.prototype.upvarFragmentName=function(t){return this.upvarFragmentNames()[t]||""},CustomCommandBlockMorph.prototype.specFromFragments=function(){var t="";return this.parts().forEach(function(e){e.fragment.isDeleted||(t=t+e.fragment.defSpecFragment()+" ")}),t.trim()},CustomCommandBlockMorph.prototype.blockSpecFromFragments=function(){var t="";return this.parts().forEach(function(e){e.fragment.isDeleted||(t=t+e.fragment.blockSpecFragment()+" ")}),t.trim()},CustomCommandBlockMorph.prototype.declarationsFromFragments=function(){var t={};return this.parts().forEach(function(e){e instanceof BlockInputFragmentMorph&&(t[e.fragment.labelString]=[e.fragment.type,e.fragment.defaultValue,e.fragment.options,e.fragment.isReadOnly])}),t},CustomCommandBlockMorph.prototype.parseSpec=function(t){return this.isPrototype?this.definition.parseSpec.call(this,t):CustomCommandBlockMorph.uber.parseSpec.call(this,t)},CustomCommandBlockMorph.prototype.mouseClickLeft=function(){return this.isPrototype?void this.edit():CustomCommandBlockMorph.uber.mouseClickLeft.call(this)},CustomCommandBlockMorph.prototype.edit=function(){var t,e,o,r=this;this.isPrototype?(e=this.definition.blockInstance(),e.addShadow(),o=this.parentThatIsA(PrototypeHatBlockMorph),new BlockDialogMorph(null,function(t){t&&(o.blockCategory=t.category,o.type=t.type,r.refreshPrototype())},r).openForChange("Change block",o.blockCategory,o.type,r.world(),e.fullImage(),r.isInUse())):(Morph.prototype.trackChanges=!1,t=new BlockEditorMorph(this.definition,this.receiver()),t.popUp(),Morph.prototype.trackChanges=!0,t.changed())},CustomCommandBlockMorph.prototype.labelPart=function(t){var e;return this.isPrototype?("%"===t[0]&&t.length>1?e=new BlockInputFragmentMorph(t.replace(/%/g,"")):(e=new BlockLabelFragmentMorph(t),e.fontSize=this.fontSize,e.color=new Color(255,255,255),e.isBold=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=this.embossing,e.drawNew()),e):CustomCommandBlockMorph.uber.labelPart.call(this,t)},CustomCommandBlockMorph.prototype.placeHolder=function(){var t;return t=new BlockLabelPlaceHolderMorph,t.fontSize=1.4*this.fontSize,t.color=new Color(45,45,45),t.drawNew(),t},CustomCommandBlockMorph.prototype.attachTargets=function(){return this.isPrototype?[]:CustomCommandBlockMorph.uber.attachTargets.call(this)},CustomCommandBlockMorph.prototype.isInUse=function(){var t=this.definition,e=this.receiver().parentThatIsA(IDE_Morph);return t.isGlobal&&e?e.sprites.asArray().concat([e.stage]).some(function(e,o){return e.usesBlockInstance(t,!1,o)}):this.receiver().usesBlockInstance(t)},CustomCommandBlockMorph.prototype.userMenu=function(){function t(t){var o=r.parentThatIsA(StageMorph),n=i.variables;e.addItem(t+"...",function(){var e,r=detect(o.children,function(e){return e instanceof WatcherMorph&&e.target===n&&e.getter===t});return null!==r?(r.show(),void r.fixLayout()):(r=new WatcherMorph(t+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,n,t),r.setPosition(o.position().add(10)),e=o.watchers(r.left()),e.length>0&&r.setTop(e[e.length-1].bottom()),o.add(r),void r.fixLayout())})}var e,o=this.parentThatIsA(PrototypeHatBlockMorph),r=this.receiver(),i=this;return this.isPrototype?(e=new MenuMorph(this),e.addItem("script pic...",function(){var t=this.world().children[0];t.saveCanvasAs(this.topBlock().scriptPic(),t.projectName||localize("Untitled")+" "+localize("script pic"),!0)},"open a new window\nwith a picture of this script"),o.inputs().length<2?e.addItem("block variables...",function(){o.enableBlockVars()},"experimental -\nunder construction"):e.addItem("remove block variables...",function(){o.enableBlockVars(!1)},"experimental -\nunder construction")):(e=this.constructor.uber.userMenu.call(this),e?e.addLine():e=new MenuMorph(this),e.addItem("delete block definition...","deleteBlockDefinition"),this.variables.names().forEach(function(e){t(e)})),e.addItem("edit...","edit"),e},CustomCommandBlockMorph.prototype.exportBlockDefinition=function(){var t=(new SnapSerializer).serialize(this.definition),e=this.parentThatIsA(IDE_Morph);e.saveXMLAs(t,this.spec)},CustomCommandBlockMorph.prototype.deleteBlockDefinition=function(){var t,e,o,r,i,n=this;return this.isPrototype?null:(i=n.definition.blockInstance(),i.addShadow(),void new DialogBoxMorph(this,function(){e=n.receiver(),e.deleteAllBlockInstances(n.definition),n.definition.isGlobal?(o=e.parentThatIsA(StageMorph),t=o.globalBlocks.indexOf(n.definition),t!==-1&&o.globalBlocks.splice(t,1)):(t=e.customBlocks.indexOf(n.definition),t!==-1&&e.customBlocks.splice(t,1)),r=e.parentThatIsA(IDE_Morph),r&&(r.flushPaletteCache(),r.refreshPalette())},this).askYesNo("Delete Custom Block",localize("block deletion dialog text"),n.world(),i.fullImage()))},CustomCommandBlockMorph.prototype.mouseEnter=function(){var t,e;this.isTemplate&&this.definition.comment&&(t=this.definition.comment.fullCopy(),t.contents.parse(),e="",t.contents.lines.forEach(function(t){e=e+"\n"+t}),this.popUpbubbleHelp(e.substr(1),this.definition.comment.color))},CustomCommandBlockMorph.prototype.mouseLeave=function(){this.isTemplate&&this.definition.comment&&this.world().hand.destroyTemporaries()},CustomCommandBlockMorph.prototype.popUpbubbleHelp=function(t,e){new SpeechBubbleMorph(t,e,null,1).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))},CustomCommandBlockMorph.prototype.relabel=function(t){var e=new MenuMorph(this),o=this.inputs().map(function(t){return t.fullCopy()}),r=this;t.forEach(function(t){var i=t.blockInstance();i.restoreInputs(o),i.fixBlockColor(null,!0),i.addShadow(new Point(3,3)),e.addItem(i,function(){r.definition=t,r.refresh()})}),e.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))},CustomCommandBlockMorph.prototype.alternatives=function(){var t=this.receiver(),e=t.parentThatIsA(StageMorph),o=t.customBlocks.concat(e.globalBlocks),r=this;return o.filter(function(t){return t!==r.definition&&t.type===r.definition.type})},CustomReporterBlockMorph.prototype=new ReporterBlockMorph,CustomReporterBlockMorph.prototype.constructor=CustomReporterBlockMorph,CustomReporterBlockMorph.uber=ReporterBlockMorph.prototype,CustomReporterBlockMorph.prototype.init=function(t,e,o){this.definition=t,this.isPrototype=o||!1,CustomReporterBlockMorph.uber.init.call(this,e,!0),this.category=t.category,this.variables=new VariableFrame,this.initializeVariables(),this.selector="evaluateCustomBlock",t&&this.refresh()},CustomReporterBlockMorph.prototype.initializeVariables=CustomCommandBlockMorph.prototype.initializeVariables,CustomReporterBlockMorph.prototype.refresh=function(){CustomCommandBlockMorph.prototype.refresh.call(this,!0),this.isPrototype||(this.isPredicate="predicate"===this.definition.type),this.parent instanceof SyntaxElementMorph&&(this.parent.cachedInputs=null),this.drawNew()},CustomReporterBlockMorph.prototype.mouseClickLeft=function(){return this.isPrototype?void this.edit():CustomReporterBlockMorph.uber.mouseClickLeft.call(this)},CustomReporterBlockMorph.prototype.placeHolder=CustomCommandBlockMorph.prototype.placeHolder,CustomReporterBlockMorph.prototype.parseSpec=CustomCommandBlockMorph.prototype.parseSpec,CustomReporterBlockMorph.prototype.edit=CustomCommandBlockMorph.prototype.edit,CustomReporterBlockMorph.prototype.labelPart=CustomCommandBlockMorph.prototype.labelPart,CustomReporterBlockMorph.prototype.upvarFragmentNames=CustomCommandBlockMorph.prototype.upvarFragmentNames,CustomReporterBlockMorph.prototype.upvarFragmentName=CustomCommandBlockMorph.prototype.upvarFragmentName,CustomReporterBlockMorph.prototype.inputFragmentNames=CustomCommandBlockMorph.prototype.inputFragmentNames,CustomReporterBlockMorph.prototype.specFromFragments=CustomCommandBlockMorph.prototype.specFromFragments,CustomReporterBlockMorph.prototype.blockSpecFromFragments=CustomCommandBlockMorph.prototype.blockSpecFromFragments,CustomReporterBlockMorph.prototype.declarationsFromFragments=CustomCommandBlockMorph.prototype.declarationsFromFragments,CustomReporterBlockMorph.prototype.refreshPrototype=CustomCommandBlockMorph.prototype.refreshPrototype,CustomReporterBlockMorph.prototype.refreshPrototypeSlotTypes=CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes,CustomReporterBlockMorph.prototype.restoreInputs=CustomCommandBlockMorph.prototype.restoreInputs,CustomReporterBlockMorph.prototype.refreshDefaults=CustomCommandBlockMorph.prototype.refreshDefaults,CustomReporterBlockMorph.prototype.isInUse=CustomCommandBlockMorph.prototype.isInUse,CustomReporterBlockMorph.prototype.userMenu=CustomCommandBlockMorph.prototype.userMenu,CustomReporterBlockMorph.prototype.deleteBlockDefinition=CustomCommandBlockMorph.prototype.deleteBlockDefinition,CustomReporterBlockMorph.prototype.mouseEnter=CustomCommandBlockMorph.prototype.mouseEnter,CustomReporterBlockMorph.prototype.mouseLeave=CustomCommandBlockMorph.prototype.mouseLeave,CustomReporterBlockMorph.prototype.bubbleHelp=CustomCommandBlockMorph.prototype.bubbleHelp,CustomReporterBlockMorph.prototype.popUpbubbleHelp=CustomCommandBlockMorph.prototype.popUpbubbleHelp,CustomReporterBlockMorph.prototype.relabel=CustomCommandBlockMorph.prototype.relabel,CustomReporterBlockMorph.prototype.alternatives=CustomCommandBlockMorph.prototype.alternatives,JaggedBlockMorph.prototype=new ReporterBlockMorph,JaggedBlockMorph.prototype.constructor=JaggedBlockMorph,JaggedBlockMorph.uber=ReporterBlockMorph.prototype,JaggedBlockMorph.prototype.jag=5,JaggedBlockMorph.prototype.init=function(t){JaggedBlockMorph.uber.init.call(this),t&&this.setSpec(t),"%cs"===t&&(this.minWidth=25,this.fixLayout())},JaggedBlockMorph.prototype.drawNew=function(){var t;this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle=this.cachedClr,this.drawBackground(t),MorphicPreferences.isFlat||this.drawEdges(t),this.eraseHoles(t)},JaggedBlockMorph.prototype.drawBackground=function(t){var e,o,r=this.width(),i=this.height(),n=Math.round(i/this.jag),s=i/n;for(t.fillStyle=this.cachedClr,t.beginPath(),t.moveTo(0,0),t.lineTo(r,0),o=0,e=0;e<n;e+=1)o+=s/2,t.lineTo(r-this.jag/2,o),o+=s/2,t.lineTo(r,o);for(t.lineTo(0,i),o=i,e=0;e<n;e+=1)o-=s/2,t.lineTo(this.jag/2,o),o-=s/2,t.lineTo(0,o);t.closePath(),t.fill()},JaggedBlockMorph.prototype.drawEdges=function(t){var e,o,r,i=this.width(),n=this.height(),s=Math.round(n/this.jag),a=n/s,h=this.edge/2;for(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",e=t.createLinearGradient(0,0,0,this.edge),e.addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(h,h),t.lineTo(i-h,h),t.stroke(),r=0,o=0;o<s;o+=1)t.strokeStyle=this.cachedClrDark,t.beginPath(),t.moveTo(i-h,r),r+=a/2,t.lineTo(i-this.jag/2-h,r),t.stroke(),r+=a/2;for(e=t.createLinearGradient(0,n-this.edge,0,n),e.addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(i-h,n-h),t.lineTo(h,n-h),t.stroke(),r=n,o=0;o<s;o+=1)t.strokeStyle=this.cachedClrBright,t.beginPath(),t.moveTo(h,r),r-=a/2,t.lineTo(this.jag/2+h,r),t.stroke(),r-=a/2},BlockDialogMorph.prototype=new DialogBoxMorph,BlockDialogMorph.prototype.constructor=BlockDialogMorph,BlockDialogMorph.uber=DialogBoxMorph.prototype,BlockDialogMorph.prototype.init=function(t,e,o){this.blockType="command",this.category="other",this.isGlobal=!0,this.types=null,this.categories=null,BlockDialogMorph.uber.init.call(this,t,e,o),this.key="makeABlock",this.types=new AlignmentMorph("row",this.padding),this.add(this.types),this.scopes=new AlignmentMorph("row",this.padding),this.add(this.scopes),this.categories=new BoxMorph,this.categories.color=SpriteMorph.prototype.paletteColor.lighter(8),this.categories.borderColor=this.categories.color.lighter(40),this.createCategoryButtons(),this.fixCategoriesLayout(),this.add(this.categories),this.createTypeButtons(),this.createScopeButtons(),this.fixLayout()},BlockDialogMorph.prototype.openForChange=function(t,e,o,r,i,n){var s=SpriteMorph.prototype.blockColor[e];this.key="changeABlock",this.category=e,this.blockType=o,this.categories.children.forEach(function(t){t.refresh()}),this.types.children.forEach(function(t){t.setColor(s),t.refresh()}),this.labelString=t,this.createLabel(),i&&this.setPicture(i),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),n&&(this.types.destroy(),this.types=null),this.scopes.destroy(),this.scopes=null,this.fixLayout(),this.drawNew(),this.popUp(r)},BlockDialogMorph.prototype.createCategoryButtons=function(){var t=this,e=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,SpriteMorph.prototype.categories.forEach(function(e){t.addCategoryButton(e)}),Morph.prototype.trackChanges=e},BlockDialogMorph.prototype.addCategoryButton=function(t){var e,o=75,r=this,i=[SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.paletteColor.darker(50),SpriteMorph.prototype.blockColor[t]];return e=new ToggleButtonMorph(i,this,function(){r.category=t,r.categories.children.forEach(function(t){t.refresh()}),r.types&&r.types.children.forEach(function(t){t.setColor(i[2])}),r.edit()},t[0].toUpperCase().concat(t.slice(1)),function(){return r.category===t},null,null,null,o,!0),e.corner=8,e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=i[1],e.labelColor=IDE_Morph.prototype.buttonLabelColor,e.contrast=this.buttonContrast,e.fixLayout(),e.refresh(),this.categories.add(e),e},BlockDialogMorph.prototype.fixCategoriesLayout=function(){var t,e,o=this.categories.children[0].width(),r=this.categories.children[0].height(),i=15,n=2,s=10,a=Math.ceil(this.categories.children.length/2),h=this.categories.left(),l=this.categories.top(),p=0,c=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.categories.children.forEach(function(a){p+=1,t=Math.ceil(p/2),e=2-p%2,a.setPosition(new Point(h+(e*i+(e-1)*o),l+(t*n+(t-1)*r+s)))}),MorphicPreferences.isFlat&&(this.categories.corner=0,this.categories.border=0,this.categories.edge=0),this.categories.setExtent(new Point(3*i+2*o,(a+1)*n+a*r+2*s)),Morph.prototype.trackChanges=c,this.categories.changed()},BlockDialogMorph.prototype.createTypeButtons=function(){var t,e=this,o=SpriteMorph.prototype.blockColor[this.category];t=new CommandBlockMorph,t.setColor(o),t.setSpec(localize("Command")),this.addBlockTypeButton(function(){e.setType("command")},t,function(){return"command"===e.blockType}),t=new ReporterBlockMorph,t.setColor(o),t.setSpec(localize("Reporter")),this.addBlockTypeButton(function(){e.setType("reporter")},t,function(){return"reporter"===e.blockType}),t=new ReporterBlockMorph(!0),t.setColor(o),t.setSpec(localize("Predicate")),this.addBlockTypeButton(function(){e.setType("predicate")},t,function(){return"predicate"===e.blockType})},BlockDialogMorph.prototype.addBlockTypeButton=function(t,e,o){var r=new ToggleElementMorph(this,t,e,o,null,null,"rebuild");return r.refresh(),this.types.add(r),r},BlockDialogMorph.prototype.addTypeButton=function(t,e,o){var r=new ToggleMorph("radiobutton",this,t,e,o);return r.edge=this.buttonEdge/2,r.outline=this.buttonOutline/2,r.outlineColor=this.buttonOutlineColor,r.outlineGradient=this.buttonOutlineGradient,r.contrast=this.buttonContrast,r.drawNew(),r.fixLayout(),this.types.add(r),r},BlockDialogMorph.prototype.setType=function(t){this.blockType=t||this.blockType,this.types.children.forEach(function(t){t.refresh()}),this.edit()},BlockDialogMorph.prototype.createScopeButtons=function(){var t=this;this.addScopeButton(function(){t.setScope("gobal")},"for all sprites",function(){return t.isGlobal}),this.addScopeButton(function(){t.setScope("local")},"for this sprite only",function(){return!t.isGlobal})},BlockDialogMorph.prototype.addScopeButton=function(t,e,o){var r=new ToggleMorph("radiobutton",this,t,e,o);return r.edge=this.buttonEdge/2,r.outline=this.buttonOutline/2,r.outlineColor=this.buttonOutlineColor,r.outlineGradient=this.buttonOutlineGradient,r.contrast=this.buttonContrast,r.drawNew(),r.fixLayout(),this.scopes.add(r),r},BlockDialogMorph.prototype.setScope=function(t){this.isGlobal="gobal"===t,this.scopes.children.forEach(function(t){t.refresh()}),this.edit()},BlockDialogMorph.prototype.getInput=function(){var t,e,o;return this.body instanceof InputFieldMorph&&(t=this.normalizeSpaces(this.body.getValue())),e=new CustomBlockDefinition(t),e.type=this.blockType,e.category=this.category,e.isGlobal=this.isGlobal,"reporter"!==e.type&&"predicate"!==e.type||(o=Process.prototype.reify.call(null,SpriteMorph.prototype.blockForSelector("doReport"),new List,!0),o.outerContext=null,e.body=o),e},BlockDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body?(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+t),this.categories&&(this.categories.setCenter(this.body.center()),this.categories.setTop(this.body.top()),this.body.setTop(this.categories.bottom()+this.padding),this.silentSetHeight(this.height()+this.categories.height()+this.padding))):this.head&&(this.types?(this.types.fixLayout(),this.silentSetWidth(Math.max(this.types.width(),this.head.width())+2*this.padding)):this.silentSetWidth(Math.max(this.categories.width(),this.head.width())+2*this.padding),this.head.setCenter(this.center()),this.head.setTop(t+this.padding),this.silentSetHeight(this.head.height()+2*this.padding+t),this.categories&&(this.categories.setCenter(this.center()),this.categories.setTop(this.head.bottom()+this.padding),this.silentSetHeight(this.height()+this.categories.height()+this.padding))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),this.scopes&&(this.scopes.fixLayout(),this.silentSetHeight(this.height()+this.scopes.height()+this.padding/3),this.silentSetWidth(Math.max(this.width(),this.scopes.width()+2*this.padding)),this.scopes.setCenter(this.center()),this.types&&this.scopes.setTop(this.types.bottom()+this.padding/3)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},BlockDialogMorph.prototype.accept=function(){this.body instanceof InputFieldMorph&&""===this.normalizeSpaces(this.body.getValue())?this.edit():BlockDialogMorph.uber.accept.call(this)},BlockEditorMorph.prototype=new DialogBoxMorph,BlockEditorMorph.prototype.constructor=BlockEditorMorph,BlockEditorMorph.uber=DialogBoxMorph.prototype,BlockEditorMorph.prototype.init=function(t,e){var o,r,i,n,s,a=this;this.definition=t,this.handle=null,BlockEditorMorph.uber.init.call(this,e,function(){a.updateDefinition()},e),this.key="editBlock"+t.spec,this.labelString="Block Editor",this.createLabel(),o=new ScriptsMorph(e),o.rejectsHats=!0,o.isDraggable=!1,o.color=IDE_Morph.prototype.groupColor,o.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,o.cleanUpMargin=10,r=new PrototypeHatBlockMorph(this.definition),r.setPosition(o.position().add(10)),null!==t.comment&&(s=t.comment.fullCopy(),r.comment=s,s.block=r),null!==t.body&&r.nextBlock(t.body.expression.fullCopy()),o.add(r),r.fixBlockColor(null,!0),r.drawNew(),this.definition.scripts.forEach(function(t){n=t.fullCopy(),n.setPosition(o.position().add(t.position())),o.add(n),n instanceof BlockMorph&&n.allComments().forEach(function(t){t.align(n)})}),r.allComments().forEach(function(t){t.align(r)}),i=new ScrollFrameMorph(o),i.padding=10,i.growth=50,i.isDraggable=!1,i.acceptsDrops=!1,i.contents.acceptsDrops=!0,o.scrollFrame=i,this.addBody(i),this.addButton("ok","OK"),this.addButton("updateDefinition","Apply"),this.addButton("cancel","Cancel"),this.setExtent(new Point(375,300)),this.fixLayout(),o.fixMultiArgs(),n=r.parts()[0],n.forceNormalColoring(),
n.fixBlockColor(r,!0)},BlockEditorMorph.prototype.popUp=function(){var t=this.target.world();t&&(BlockEditorMorph.uber.popUp.call(this,t),this.setInitialDimensions(),this.handle=new HandleMorph(this,280,220,this.corner,this.corner),t.keyboardReceiver=null)},BlockEditorMorph.prototype.justDropped=function(){nop()},BlockEditorMorph.prototype.accept=function(t){t instanceof CursorMorph||(this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),this.close())},BlockEditorMorph.prototype.cancel=function(t){t instanceof CursorMorph||this.close()},BlockEditorMorph.prototype.close=function(){var t,e,o=this;return this.definition.isGlobal&&(e=detect(this.body.contents.allChildren(),function(t){return t.definition&&!t.definition.isGlobal}))?(e=e.definition.blockInstance(),e.addShadow(),void(new DialogBoxMorph).inform("Local Block(s) in Global Definition","This global block definition contains one or more\nlocal custom blocks which must be removed first.",o.world(),e.fullImage())):(t=this.target.doubleDefinitionsFor(this.definition),t.length>0?(e=t[0].blockInstance(),e.addShadow(),void new DialogBoxMorph(this,"consolidateDoubles",this).askYesNo("Same Named Blocks","Another custom block with this name exists.\nWould you like to replace it?",o.world(),e.fullImage())):void this.destroy())},BlockEditorMorph.prototype.consolidateDoubles=function(){this.target.replaceDoubleDefinitionsFor(this.definition),this.destroy()},BlockEditorMorph.prototype.refreshAllBlockInstances=function(){var t=this.target.paletteBlockInstance(this.definition);this.target.allBlockInstances(this.definition).forEach(function(t){t.refresh()}),t&&t.refreshDefaults()},BlockEditorMorph.prototype.updateDefinition=function(){var t,e,o,r=this.body.contents.position(),i=this;this.definition.receiver=this.target,this.definition.spec=this.prototypeSpec(),this.definition.declarations=this.prototypeSlots(),this.definition.variableNames=this.variableNames(),this.definition.scripts=[],this.definition.editorDimensions=this.bounds.copy(),this.body.contents.children.forEach(function(e){e instanceof PrototypeHatBlockMorph?t=e:(e instanceof BlockMorph||e instanceof CommentMorph&&!e.block)&&(o=e.fullCopy(),o.parent=null,o.setPosition(e.position().subtract(r)),i.definition.scripts.push(o))}),t&&(this.definition.category=t.blockCategory,this.definition.type=t.type,t.comment?(this.definition.comment=t.comment.fullCopy(),this.definition.comment.block=!0):this.definition.comment=null),this.definition.body=this.context(t),this.refreshAllBlockInstances(),e=this.target.parentThatIsA(IDE_Morph),e.flushPaletteCache(),e.refreshPalette()},BlockEditorMorph.prototype.context=function(t){var e,o,r;return e=t||detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}),o=e.nextBlock(),null===o?null:(o.allChildren().forEach(function(t){t instanceof BlockMorph&&(t.cachedInputs=null)}),r=Process.prototype.reify.call(null,o,new List(this.definition.inputNames()),!0),r.outerContext=null,r)},BlockEditorMorph.prototype.prototypeSpec=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).parts()[0].specFromFragments()},BlockEditorMorph.prototype.prototypeSlots=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).parts()[0].declarationsFromFragments()},BlockEditorMorph.prototype.variableNames=function(){return detect(this.body.contents.children,function(t){return t instanceof PrototypeHatBlockMorph}).variableNames()},BlockEditorMorph.prototype.setInitialDimensions=function(){var t=this.world(),e=t.extent().subtract(new Point(this.padding,this.padding)),o=fontHeight(this.titleFontSize)+2*this.titlePadding,r=this.buttons.height();return this.definition.editorDimensions?(this.setPosition(this.definition.editorDimensions.origin),this.setExtent(this.definition.editorDimensions.extent().min(e)),void this.keepWithin(t)):(this.setExtent(this.body.contents.extent().add(new Point(this.padding,this.padding+o+r)).min(e)),void this.setCenter(this.world().center()))},BlockEditorMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.buttons&&this.buttons.children.length>0&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height()))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},PrototypeHatBlockMorph.prototype=new HatBlockMorph,PrototypeHatBlockMorph.prototype.constructor=PrototypeHatBlockMorph,PrototypeHatBlockMorph.uber=HatBlockMorph.prototype,PrototypeHatBlockMorph.prototype.init=function(t){var e,o=t.prototypeInstance();this.definition=t,this.blockCategory=t?t.category:null,this.type=t?t.type:null,HatBlockMorph.uber.init.call(this),this.color=SpriteMorph.prototype.blockColor.control,this.category="control",this.add(o),t.variableNames.length&&(e=this.labelPart("%blockVars"),this.add(this.labelPart("%br")),this.add(e),t.variableNames.forEach(function(t){e.addInput(t)})),o.refreshPrototypeSlotTypes(),this.fixLayout(),o.fixBlockColor(this,!0)},PrototypeHatBlockMorph.prototype.mouseClickLeft=function(){return 16===this.world().currentKey?this.focus():void this.parts()[0].mouseClickLeft()},PrototypeHatBlockMorph.prototype.userMenu=function(){return this.parts()[0].userMenu()},PrototypeHatBlockMorph.prototype.fixBlockColor=function(t,e){var o=this.parts()[0]||t;if(this.zebraContrast||e){if(!this.zebraContrast&&e)return this.forceNormalColoring();o.category===this.category?o.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor(),e&&this.fixChildrensBlockColor(!0)}},PrototypeHatBlockMorph.prototype.variableNames=function(t){var e=this.parts();return e.length<3?[]:e[2].evaluate()},PrototypeHatBlockMorph.prototype.enableBlockVars=function(t){var e=this.parts()[0];t===!1?this.setSpec("%s",!0):this.setSpec("%s %br %blockVars",!0),this.replaceInput(this.parts()[0],e),this.spec=null},BlockLabelFragment.prototype.defSpecFragment=function(){var t=this.type?"%'":"";return this.isDeleted?"":t+this.labelString+(this.type?"'":"")},BlockLabelFragment.prototype.defTemplateSpecFragment=function(){var t="";return this.type?(this.isUpvar()?t=" ":this.isMultipleInput()?t="...":"%cs"===this.type?t=" ":"%b"===this.type?t=" ?":"%l"===this.type?t=" ":"%obj"===this.type?t=" %turtleOutline":contains(["%cmdRing","%repRing","%predRing","%anyUE","%boolUE"],this.type)?t=" ":this.defaultValue?t="%n"===this.type?" # = "+this.defaultValue.toString():" = "+this.defaultValue.toString():"%n"===this.type&&(t=" #"),this.labelString+t):this.defSpecFragment()},BlockLabelFragment.prototype.blockSpecFragment=function(){return this.isDeleted?"":this.type||this.labelString},BlockLabelFragment.prototype.copy=function(){var t=new BlockLabelFragment(this.labelString);return t.type=this.type,t.defaultValue=this.defaultValue,t.options=this.options,t.isReadOnly=this.isReadOnly,t},BlockLabelFragment.prototype.isSingleInput=function(){return!this.isMultipleInput()&&"%upvar"!==this.type},BlockLabelFragment.prototype.isMultipleInput=function(){return!!this.type&&this.type.indexOf("%mult")>-1},BlockLabelFragment.prototype.isUpvar=function(){return!!this.type&&"%upvar"===this.type},BlockLabelFragment.prototype.setToSingleInput=function(){return this.type?void("%upvar"===this.type?this.type="%s":this.type=this.singleInputType()):null},BlockLabelFragment.prototype.setToMultipleInput=function(){return this.type?("%upvar"===this.type&&(this.type="%s"),void(this.type="%mult".concat(this.singleInputType()))):null},BlockLabelFragment.prototype.setToUpvar=function(){return this.type?void(this.type="%upvar"):null},BlockLabelFragment.prototype.singleInputType=function(){return this.type?this.isMultipleInput()?this.type.substr(5):this.type:null},BlockLabelFragment.prototype.setSingleInputType=function(t){this.type&&this.isMultipleInput()?this.type="%mult".concat(t):this.type=t},BlockLabelFragmentMorph.prototype=new StringMorph,BlockLabelFragmentMorph.prototype.constructor=BlockLabelFragmentMorph,BlockLabelFragmentMorph.uber=StringMorph.prototype,BlockLabelFragmentMorph.prototype.init=function(t){this.fragment=new BlockLabelFragment(t),this.fragment.type=null,this.sO=null,BlockLabelFragmentMorph.uber.init.call(this,t,null,SyntaxElementMorph.prototype.labelFontStyle,null,null,null,null,null,null,SyntaxElementMorph.prototype.labelFontName)},BlockLabelFragmentMorph.prototype.mouseEnter=function(){this.sO=this.shadowOffset,this.shadowOffset=this.sO.neg(),this.drawNew(),this.changed()},BlockLabelFragmentMorph.prototype.mouseLeave=function(){this.shadowOffset=this.sO,this.drawNew(),this.changed()},BlockLabelFragmentMorph.prototype.mouseClickLeft=function(){var t=this.fragment.copy(),e=this,o=this instanceof BlockLabelPlaceHolderMorph,r=this.parent.parseSpec(this.parent.blockSpec).length<2;new InputSlotDialogMorph(t,null,function(){e.updateBlockLabel(t)},this,this.parent.definition.category).open(this instanceof BlockLabelFragmentMorph?"Edit label fragment":o?"Create input name":"Edit input name",t.labelString,this.world(),null,o||r)},BlockLabelFragmentMorph.prototype.updateBlockLabel=function(t){var e=this.parentThatIsA(BlockMorph);this.fragment=t,e&&e.refreshPrototype()},BlockLabelFragmentMorph.prototype.userMenu=function(){var t=this,e=new Color(100,100,130),o=new MenuMorph(function(e){var o=t.text.split("-");t.changed(),o[0]="$"+e,t.text=o.join("-"),t.fragment.labelString=t.text,t.parent.parent.changed(),t.drawNew(),t.changed(),t.parent.parent.fixLayout(),t.parent.parent.changed()},null,this,this.fontSize);return SymbolMorph.prototype.names.forEach(function(t){o.addItem([new SymbolMorph(t,o.fontSize,e),t],t)}),o},BlockLabelPlaceHolderMorph.prototype=new StringMorph,BlockLabelPlaceHolderMorph.prototype.constructor=BlockLabelPlaceHolderMorph,BlockLabelPlaceHolderMorph.uber=StringMorph.prototype,BlockLabelPlaceHolderMorph.prototype.plainLabel=!1,BlockLabelPlaceHolderMorph.prototype.init=function(){this.fragment=new BlockLabelFragment(""),this.fragment.type="%s",this.fragment.isDeleted=!0,this.isHighlighted=!1,this.isProtectedLabel=!0,BlockLabelFragmentMorph.uber.init.call(this,"+")},BlockLabelPlaceHolderMorph.prototype.drawNew=function(){var t,e,o,r,i,n;this.plainLabel&&(this.text=this.isHighlighted?" + ":""),this.image=newCanvas(),t=this.image.getContext("2d"),t.font=this.font(),e=Math.max(t.measureText(this.text).width+Math.abs(this.shadowOffset.x),1),this.bounds.corner=this.bounds.origin.add(new Point(e,fontHeight(this.fontSize)+Math.abs(this.shadowOffset.y))),this.image.width=e,this.image.height=this.height(),this.isHighlighted&&(i=Math.floor(e/2),n=Math.floor(this.height()/2),t.fillStyle=this.color.toString(),t.beginPath(),t.arc(i,1.2*n,Math.min(i,n),radians(0),radians(360),!1),t.closePath(),t.fill()),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.shadowColor&&(o=Math.max(this.shadowOffset.x,0),r=Math.max(this.shadowOffset.y,0),t.fillStyle=this.shadowColor.toString(),t.fillText(this.text,o,fontHeight(this.fontSize)+r)),o=Math.abs(Math.min(this.shadowOffset.x,0)),r=Math.abs(Math.min(this.shadowOffset.y,0)),t.fillStyle=this.isHighlighted?"white":this.color.toString(),t.fillText(this.text,o,fontHeight(this.fontSize)+r),this.parent&&(this.parent.fixLayout&&this.parent.fixLayout(),this.parent.parent instanceof PrototypeHatBlockMorph&&this.parent.parent.fixLayout())},BlockLabelPlaceHolderMorph.prototype.mouseEnter=function(){var t=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!0,this.plainLabel&&t?(t.changed(),this.drawNew(),t.changed()):(this.drawNew(),this.changed())},BlockLabelPlaceHolderMorph.prototype.mouseLeave=function(){var t=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!1,this.plainLabel&&t?(t.changed(),this.drawNew(),t.changed()):(this.drawNew(),this.changed())},BlockLabelPlaceHolderMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft,BlockLabelPlaceHolderMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel,BlockInputFragmentMorph.prototype=new TemplateSlotMorph,BlockInputFragmentMorph.prototype.constructor=BlockInputFragmentMorph,BlockInputFragmentMorph.uber=TemplateSlotMorph.prototype,BlockInputFragmentMorph.prototype.init=function(t){this.fragment=new BlockLabelFragment(t),this.fragment.type="%s",BlockInputFragmentMorph.uber.init.call(this,t)},BlockInputFragmentMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft,BlockInputFragmentMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel,InputSlotDialogMorph.prototype=new DialogBoxMorph,InputSlotDialogMorph.prototype.constructor=InputSlotDialogMorph,InputSlotDialogMorph.uber=DialogBoxMorph.prototype,InputSlotDialogMorph.prototype.isLaunchingExpanded=!1,InputSlotDialogMorph.prototype.init=function(t,e,o,r,i){var n=SyntaxElementMorph.prototype.scale,s=fontHeight(10)/1.2*n;this.fragment=t||new BlockLabelFragment,this.textfield=null,this.types=null,this.slots=null,this.isExpanded=!1,this.category=i||"other",this.cachedRadioButton=null,this.noDelete=!1,BlockDialogMorph.uber.init.call(this,e,o,r),this.types=new AlignmentMorph("row",this.padding),this.types.respectHiddens=!0,this.add(this.types),this.slots=new BoxMorph,this.slots.color=new Color(55,55,55),this.slots.borderColor=this.slots.color.lighter(50),this.slots.setExtent(new Point(24*(s+10),10.4*(s+10*n))),this.add(this.slots),this.createSlotTypeButtons(),this.fixSlotsLayout(),this.addSlotsMenu(),this.createTypeButtons(),this.fixLayout()},InputSlotDialogMorph.prototype.createTypeButtons=function(){var t,e,o=this,r=SpriteMorph.prototype.blockColor[this.category];t=new JaggedBlockMorph(localize("Title text")),t.setColor(r),this.addBlockTypeButton(function(){o.setType(null)},t,function(){return null===o.fragment.type}),t=new JaggedBlockMorph("%inputName"),t.setColor(r),this.addBlockTypeButton(function(){o.setType("%s")},t,function(){return null!==o.fragment.type}),e=new ArrowMorph("right",PushButtonMorph.prototype.fontSize+4,2),e.noticesTransparentClick=!0,this.types.add(e),this.types.fixLayout(),e.refresh=function(){null===o.fragment.type?(o.isExpanded=!1,e.hide(),o.drawNew()):(e.show(),o.isExpanded?e.direction="down":e.direction="right",e.drawNew(),e.changed())},e.mouseClickLeft=function(){e.isVisible&&(o.isExpanded=!o.isExpanded,o.types.children.forEach(function(t){t.refresh()}),o.drawNew(),o.edit())},e.refresh()},InputSlotDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton,InputSlotDialogMorph.prototype.addBlockTypeButton=BlockDialogMorph.prototype.addBlockTypeButton,InputSlotDialogMorph.prototype.setType=function(t){this.textfield.choices=t?null:this.symbolMenu,this.textfield.drawNew(),this.fragment.type=t||null,this.types.children.forEach(function(t){t.refresh()}),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.getInput=function(){var t;return this.body instanceof InputFieldMorph&&(t=this.normalizeSpaces(this.body.getValue())),t?(this.fragment.labelString=t,this.fragment.defaultValue=this.slots.defaultInputField.getValue(),t):(this.noDelete||(this.fragment.isDeleted=!0),null)},InputSlotDialogMorph.prototype.fixLayout=function(){var t,e=this.left(),o=fontHeight(this.titleFontSize)+2*this.titlePadding;return this.isExpanded?(this.slots.show(),t=this.slots.width(),this.body.setPosition(this.position().add(new Point(this.padding+(t-this.body.width())/2,o+this.padding))),this.label.setLeft(e+this.padding+(t-this.label.width())/2),this.label.setTop(this.top()+(o-this.label.height())/2),this.types.fixLayout(),this.types.setTop(this.body.bottom()+this.padding),this.types.setLeft(e+this.padding+(t-this.types.width())/2),this.slots.setPosition(new Point(this.left()+this.padding,this.types.bottom()+this.padding)),this.slots.children.forEach(function(t){t.refresh()}),this.buttons.fixLayout(),this.buttons.setTop(this.slots.bottom()+this.padding),this.buttons.setLeft(e+this.padding+(t-this.buttons.width())/2),this.silentSetHeight(this.buttons.bottom()-this.top()+this.padding),void this.silentSetWidth(this.slots.right()-this.left()+this.padding)):(this.slots&&this.slots.hide(),BlockDialogMorph.prototype.fixLayout.call(this))},InputSlotDialogMorph.prototype.open=function(t,e,o,r,i){var n=new InputFieldMorph(e),s=Morph.prototype.trackChanges;this.fragment.type||(n.choices=this.symbolMenu),Morph.prototype.trackChanges=!1,this.isExpanded=this.isLaunchingExpanded,n.setWidth(250),this.labelString=t,this.createLabel(),r&&this.setPicture(r),this.addBody(n),n.drawNew(),this.textfield=n,this.addButton("ok","OK"),i?this.noDelete=!0:this.addButton("deleteFragment","Delete"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew(),this.fixLayout(),this.popUp(o),this.add(this.types),Morph.prototype.trackChanges=s,this.changed()},InputSlotDialogMorph.prototype.symbolMenu=function(){var t=[],e=new Color(100,100,130),o=this;return SymbolMorph.prototype.names.forEach(function(r){t.push([[new SymbolMorph(r,o.fontSize,e),localize(r)],"$"+r])}),t},InputSlotDialogMorph.prototype.deleteFragment=function(){this.fragment.isDeleted=!0,this.accept()},InputSlotDialogMorph.prototype.createSlotTypeButtons=function(){var t,e,o=this,r=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.addSlotTypeButton("Object","%obj"),this.addSlotTypeButton("Text","%txt"),this.addSlotTypeButton("List","%l"),this.addSlotTypeButton("Number","%n"),this.addSlotTypeButton("Any type","%s"),this.addSlotTypeButton("Boolean (T/F)","%b"),this.addSlotTypeButton("Command\n(inline)","%cmdRing"),this.addSlotTypeButton("Reporter","%repRing"),this.addSlotTypeButton("Predicate","%predRing"),this.addSlotTypeButton("Command\n(C-shape)","%cs"),this.addSlotTypeButton("Any\n(unevaluated)","%anyUE"),this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE"),this.slots.radioButtonSingle=this.addSlotArityButton(function(){o.setSlotArity("single")},"Single input.",function(){return o.fragment.isSingleInput()}),this.addSlotArityButton(function(){o.setSlotArity("multiple")},"Multiple inputs (value is list of inputs)",function(){return o.fragment.isMultipleInput()}),this.addSlotArityButton(function(){o.setSlotArity("upvar")},"Upvar - make internal variable visible to caller",function(){return o.fragment.isUpvar()}),t=new StringMorph(localize("Default Value:")),t.fontSize=this.slots.radioButtonSingle.fontSize,t.setColor(new Color(255,255,255)),t.refresh=function(){o.isExpanded&&contains(["%s","%n","%txt","%anyUE"],o.fragment.type)?t.show():t.hide()},this.slots.defaultInputLabel=t,this.slots.add(t),e=new InputFieldMorph(this.fragment.defaultValue),e.contents().fontSize=t.fontSize,e.contrast=90,e.contents().drawNew(),e.setWidth(50),e.refresh=function(){t.isVisible?(e.show(),"%n"===o.fragment.type?e.setIsNumeric(!0):e.setIsNumeric(!1)):e.hide()},this.slots.defaultInputField=e,this.slots.add(e),e.drawNew(),Morph.prototype.trackChanges=r},InputSlotDialogMorph.prototype.setSlotType=function(t){this.fragment.setSingleInputType(t),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.setSlotArity=function(t){"single"===t?this.fragment.setToSingleInput():"multiple"===t?this.fragment.setToMultipleInput():"upvar"===t&&this.fragment.setToUpvar(),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.addSlotTypeButton=function(t,e){var o,r,i=this,n=function(){i.setSlotType(e)},s=new JaggedBlockMorph(e);return o=function(){return i.fragment.singleInputType()===e},s.setCategory(this.category),s.rebuild(),r=new ToggleMorph("radiobutton",this,n,t,o,null,null,this.cachedRadioButton,s.fullImage(),"rebuild"),r.edge=this.buttonEdge/2,r.outline=this.buttonOutline/2,r.outlineColor=this.buttonOutlineColor,r.outlineGradient=this.buttonOutlineGradient,r.drawNew(),r.fixLayout(),r.label.isBold=!1,r.label.setColor(new Color(255,255,255)),this.cachedRadioButton||(this.cachedRadioButton=r),this.slots.add(r),r},InputSlotDialogMorph.prototype.addSlotArityButton=function(t,e,o){var r=new ToggleMorph("radiobutton",this,t,e,o,null,null,this.cachedRadioButton);return r.edge=this.buttonEdge/2,r.outline=this.buttonOutline/2,r.outlineColor=this.buttonOutlineColor,r.outlineGradient=this.buttonOutlineGradient,r.drawNew(),r.fixLayout(),r.label.setColor(new Color(255,255,255)),this.slots.add(r),this.cachedRadioButton||(this.cachedRadioButton=r),r},InputSlotDialogMorph.prototype.fixSlotsLayout=function(){var t,e,o=this.slots,r=SyntaxElementMorph.prototype.scale,i=10*r,n=14*r,s=(fontHeight(10)/1.2+15)*r,a=(fontHeight(10)/1.2+10)*r,h=12,l=[o.left()+i,o.left()+o.width()/3,o.left()+2*o.width()/3],p=[o.top()+n,o.top()+n+s,o.top()+n+2*s,o.top()+n+3*s,o.top()+n+4*s,o.top()+n+5*s,o.top()+n+5*s+a,o.top()+n+5*s+2*a],c=-1,d=Morph.prototype.trackChanges;for(Morph.prototype.trackChanges=!1,t=0;t<h;t+=1)e=t%3,t%3===0&&(c+=1),o.children[t].setPosition(new Point(l[e],p[c]));for(e=0,c=5,t=h;t<h+3;t+=1)o.children[t].setPosition(new Point(l[e],p[c+t-h]));this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new Point(5,0))),this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0))),Morph.prototype.trackChanges=d,this.slots.changed()},InputSlotDialogMorph.prototype.addSlotsMenu=function(){var t=this;this.slots.userMenu=function(){if(contains(["%s","%n","%txt","%anyUE"],t.fragment.type)){var e=new MenuMorph(t),o=" ",r=" ";return e.addItem("options...","editSlotOptions"),e.addItem((t.fragment.isReadOnly?o:r)+localize("read-only"),function(){t.fragment.isReadOnly=!t.fragment.isReadOnly}),e}return Morph.prototype.userMenu.call(t)}},InputSlotDialogMorph.prototype.editSlotOptions=function(){var t=this;new DialogBoxMorph(t,function(e){t.fragment.options=e.trim()},t).promptCode("Input Slot Options",t.fragment.options,t.world(),null,localize('Enter one option per line.Optionally use "=" as key/value delimiter\ne.g.\n   the answer=42'))},InputSlotDialogMorph.prototype.hide=function(){this.isVisible=!1,this.changed()},InputSlotDialogMorph.prototype.show=function(){this.isVisible=!0,this.changed()},VariableDialogMorph.prototype=new DialogBoxMorph,VariableDialogMorph.prototype.constructor=VariableDialogMorph,VariableDialogMorph.uber=DialogBoxMorph.prototype,VariableDialogMorph.prototype.init=function(t,e,o){this.types=null,this.isGlobal=!0,BlockDialogMorph.uber.init.call(this,t,e,o),this.types=new AlignmentMorph("row",this.padding),this.add(this.types),this.createTypeButtons()},VariableDialogMorph.prototype.createTypeButtons=function(){var t=this;this.addTypeButton(function(){t.setType("gobal")},"for all sprites",function(){return t.isGlobal}),this.addTypeButton(function(){t.setType("local")},"for this sprite only",function(){return!t.isGlobal})};VariableDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton;VariableDialogMorph.prototype.setType=function(t){this.isGlobal="gobal"===t,this.types.children.forEach(function(t){t.refresh()}),this.edit()},VariableDialogMorph.prototype.getInput=function(){var t=this.normalizeSpaces(this.body.getValue());return t?[t,this.isGlobal]:null},VariableDialogMorph.prototype.fixLayout=function(){var t=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,t+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+t)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))},BlockExportDialogMorph.prototype=new DialogBoxMorph,BlockExportDialogMorph.prototype.constructor=BlockExportDialogMorph,BlockExportDialogMorph.uber=DialogBoxMorph.prototype,BlockExportDialogMorph.prototype.key="blockExport",BlockExportDialogMorph.prototype.init=function(t,e){var o=this;this.serializer=t,this.blocks=e.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,null,function(){o.exportBlocks()},null),this.labelString="Export blocks",this.createLabel(),this.buildContents()},BlockExportDialogMorph.prototype.buildContents=function(){var t,e,o,r,i,n,s=this,a=4;t=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor),t.color=SpriteMorph.prototype.paletteColor,t.padding=a,t.isDraggable=!1,t.acceptsDrops=!1,t.contents.acceptsDrops=!1,e=t.left()+a,o=t.top()+a,SpriteMorph.prototype.categories.forEach(function(h){s.blocks.forEach(function(l){l.category===h&&(n&&h!==n&&(o+=a),n=h,r=l.templateInstance(),i=new ToggleMorph("checkbox",s,function(){var t=s.blocks.indexOf(l);t>-1?s.blocks.splice(t,1):s.blocks.push(l)},null,function(){return contains(s.blocks,l)},null,null,null,r.fullImage()),i.setPosition(new Point(e,o+(i.top()-i.toggleElement.top()))),t.addContents(i),o+=i.fullBounds().height()+a)})}),t.scrollX(a),t.scrollY(a),this.addBody(t),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.setExtent(new Point(220,300)),this.fixLayout()},BlockExportDialogMorph.prototype.popUp=function(t){var e=t||this.target.world();e&&(BlockExportDialogMorph.uber.popUp.call(this,e),this.handle=new HandleMorph(this,200,220,this.corner,this.corner))},BlockExportDialogMorph.prototype.userMenu=function(){var t=new MenuMorph(this,"select");return t.addItem("all","selectAll"),t.addItem("none","selectNone"),t},BlockExportDialogMorph.prototype.selectAll=function(){this.body.contents.children.forEach(function(t){t.state||t.trigger()})},BlockExportDialogMorph.prototype.selectNone=function(){this.blocks=[],this.body.contents.children.forEach(function(t){t.refresh()})},BlockExportDialogMorph.prototype.exportBlocks=function(){var t=this.serializer.serialize(this.blocks),e=this.world().children[0];this.blocks.length>0?(t='<blocks app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+t+"</blocks>",e.saveXMLAs(t,e.projectName||localize("Untitled")+" "+localize("blocks"))):(new DialogBoxMorph).inform("Export blocks","no blocks were selected",this.world())},BlockExportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,BlockImportDialogMorph.prototype=new DialogBoxMorph,BlockImportDialogMorph.prototype.constructor=BlockImportDialogMorph,BlockImportDialogMorph.uber=DialogBoxMorph.prototype,BlockImportDialogMorph.prototype.key="blockImport",BlockImportDialogMorph.prototype.init=function(t,e,o){var r=this;this.blocks=t.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,e,function(){r.importBlocks(o)},null),this.labelString=localize("Import blocks")+(o?": ":"")+o||"",this.createLabel(),this.buildContents()},BlockImportDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents,BlockImportDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp,BlockImportDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu,BlockImportDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll,BlockImportDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone,BlockImportDialogMorph.prototype.importBlocks=function(t){var e=this.target.parentThatIsA(IDE_Morph);e&&(this.blocks.length>0?(this.blocks.forEach(function(t){t.receiver=e.stage,e.stage.globalBlocks.push(t),e.stage.replaceDoubleDefinitionsFor(t)}),e.flushPaletteCache(),e.refreshPalette(),e.showMessage("Imported Blocks Module"+(t?": "+t:"")+".",2)):(new DialogBoxMorph).inform("Import blocks","no blocks were selected",this.world()))},BlockImportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,BlockRemovalDialogMorph.prototype=new DialogBoxMorph,BlockRemovalDialogMorph.prototype.constructor=BlockImportDialogMorph,BlockRemovalDialogMorph.uber=DialogBoxMorph.prototype,BlockRemovalDialogMorph.prototype.key="blockRemove",BlockRemovalDialogMorph.prototype.init=function(t,e){var o=this;this.blocks=t.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,e,function(){o.removeBlocks()},null),this.labelString=localize("Remove unused blocks")+(name?": ":"")+name||"",this.createLabel(),this.buildContents()},BlockRemovalDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents,BlockRemovalDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp,BlockRemovalDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu,BlockRemovalDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll,BlockRemovalDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone,BlockRemovalDialogMorph.prototype.removeBlocks=function(){var t=this.target.parentThatIsA(IDE_Morph);t&&(this.blocks.length>0?(this.blocks.forEach(function(e){var o=t.stage.globalBlocks.indexOf(e);o!==-1&&t.stage.globalBlocks.splice(o,1)}),t.flushPaletteCache(),t.refreshPalette(),t.showMessage(this.blocks.length+" "+localize("unused block(s) removed"),2)):(new DialogBoxMorph).inform("Remove unused blocks","no blocks were selected",this.world()))},BlockRemovalDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,modules.tables="2016-May-02";var Table,TableCellMorph,TableMorph,TableFrameMorph;Table.prototype.demo=function(t){var e;this.fillWithTestData(),e=new TableDialogMorph(this),e.popUp(t)},Table.prototype.changed=function(){this.lastChanged=Date.now()},Table.prototype.get=function(t,e){return t?e?t>this.colCount||e>this.rowCount?null:(this.contents[e-1]||[])[t-1]:this.colName(t):e?this.rowName(e):[this.rowCount]},Table.prototype.row=function(t){return this.contents[t-1]},Table.prototype.col=function(t){var e,o=[],r=t-1;for(e=0;e<this.rowCount;e+=1)o.push(this.contents[e][r]);return o},Table.prototype.colName=function(t){if(t>this.colCount)return null;var e=this.colNames[t-1];return void 0!==e?e:String.fromCharCode(64+(t%26||26)).repeat(Math.floor((t-1)/26)+1)},Table.prototype.rowName=function(t){return t>this.rowCount?null:this.rowNames[t-1]||t},Table.prototype.rows=function(){return this.rowCount},Table.prototype.cols=function(){return this.colCount},Table.prototype.columnNames=function(){return this.colNames},Table.prototype.set=function(t,e,o){this.contents[o-1][e-1]=t,this.changed()},Table.prototype.setRows=function(t,e,o){this.contents=t,e&&(this.colNames=e),o&&(this.rowNames=o),this.changed()},Table.prototype.setCols=function(t,e,o){var r,i;for(i=0;i<this.colCount;i+=1)for(r=0;r<this.rowCount;r+=1)this.contents[r][i]=t[i][r];e&&(this.colNames=e),o&&(this.rowNames=o),this.changed()},Table.prototype.setColNames=function(t){this.colNames=t||[],this.changed()},Table.prototype.setRowNames=function(t){this.rowNames=t||[],this.changed()},Table.prototype.setColName=function(t,e){this.colNames[t+1]=e,this.changed();
},Table.prototype.setRowName=function(t,e){this.rowNames[t+1]=e,this.changed()},Table.prototype.addRow=function(t,e){t?this.contents[this.rowCount]=t:this.contents[this.rowCount]=new Array(this.rowCount),this.rowNames[this.rowCount]=e,this.rowCount+=1,this.changed()},Table.prototype.addCol=function(t,e){var o;if(t)for(o=0;o<this.col;o+=1)this.contents[o][this.colCount]=t[o];this.colNames[this.colCount]=e,this.colCount+=1,this.changed()},Table.prototype.toList=function(){return new List(this.contents.map(function(t){return new List(t)}))},Table.prototype.fillWithTestData=function(){var t,e;for(t=1;t<=this.colCount;t+=1)for(e=1;e<=this.rowCount;e+=1)this.set(this.colName(t)+this.rowName(e),t,e)},TableCellMorph.prototype=new Morph,TableCellMorph.prototype.constructor=TableCellMorph,TableCellMorph.uber=Morph.prototype,TableCellMorph.prototype.listSymbol=ArgMorph.prototype.listIcon(),TableCellMorph.prototype.init=function(t,e,o){this.data=t,this.isLabel=o||!1,TableCellMorph.uber.init.call(this,!0),this.noticesTransparentClick=!0,e&&this.silentSetExtent(e),this.drawNew()},TableCellMorph.prototype.setData=function(t,e){this.data=t,e&&!e.eq(this.extent())?(this.silentSetExtent(e),this.drawNew()):this.drawData()},TableCellMorph.prototype.getData=function(){return this.data instanceof Array?this.data[0]:this.data},TableCellMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent()),this.drawData()},TableCellMorph.prototype.drawData=function(t,e){var o,r,i,n,s=t||this.dataRepresentation(this.data),a=this.image.getContext("2d"),h=SyntaxElementMorph.prototype.fontSize,l=TableMorph.prototype.highContrast?"rgb(220, 220, 220)":"transparent",p="rgb(217, 77, 17)",c=this.isLabel?this.data instanceof Array?"italic":"":this.shouldBeList()?"bold":"",d=c+" "+h+"px Helvetica, Arial, sans-serif",u=e||(this.isLabel?l:this.shouldBeList()?p:this.isOvershooting()?"white":isNil(this.data)?l:"white"),g=!this.isLabel&&this.shouldBeList()?"white":"black",f=this.width(),m=this.height();a.clearRect(0,0,f,m),a.fillStyle=u,this.shouldBeList()?(BoxMorph.prototype.outlinePath.call(this,a,SyntaxElementMorph.prototype.corner+1,0),a.fill()):this.isOvershooting()?(this.raggedBoxPath(a),a.fill()):a.fillRect(0,0,f,m),s&&(s instanceof HTMLCanvasElement?(i=Math.max((f-s.width)/2,0),n=Math.max((m-s.height)/2,0),a.shadowOffsetX=4,a.shadowOffsetY=4,a.shadowBlur=4,a.shadowColor="lightgray",a.drawImage(s,i,n)):(a.font=d,a.textAlign="left",a.textBaseline="bottom",o=a.measureText(s).width,r=fontHeight(h),a.fillStyle=g,i=Math.max((f-o)/2,0),n=Math.max((m-r)/2,0),a.fillText(s,i,r+n)))},TableCellMorph.prototype.dataRepresentation=function(t){return t instanceof Morph?isSnapObject(t)?t.thumbnail(new Point(40,40)):t.fullImageClassic():isString(t)?t.length>100?t.slice(0,100)+"...":t:"number"==typeof t?t.toString():"boolean"==typeof t?SpriteMorph.prototype.booleanMorph.call(null,t).fullImage():t instanceof Array?this.dataRepresentation(t[0]):t instanceof Variable?this.dataRepresentation(t.value):t instanceof HTMLCanvasElement?t:t instanceof Context?t.image():t instanceof Costume?t.thumbnail(new Point(40,40)):t instanceof List?this.listSymbol:t?t.toString():0===t?"0":null},TableCellMorph.prototype.raggedBoxPath=function(t){var e=this.width(),o=this.height(),r=.75*e,i=o/6,n=0;for(t.beginPath(),t.moveTo(0,0),t.lineTo(e,0),n=0;n<o;n+=2*i)t.lineTo(r,n+i),t.lineTo(e,n+2*i);t.lineTo(e,o),t.lineTo(0,o),t.closePath()},TableCellMorph.prototype.shouldBeList=function(){return this.data instanceof Array},TableCellMorph.prototype.isOvershooting=function(){return this.data instanceof Variable},TableCellMorph.prototype.mouseDoubleClick=function(t){this.data instanceof Table||this.data instanceof List?new TableDialogMorph(this.data).popUp(this.world()):this.data instanceof Array&&this.data[0]instanceof List?new TableDialogMorph(this.data[0]).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},TableCellMorph.prototype.mouseEnter=function(){var t,e,o;this.isLabel&&(t=this.parentThatIsA(TableMorph),e=t.world().hand.left()-t.left(),o=t.columnAt(e),o>0&&(this.drawData(o,"rgb(220, 220, 250)"),this.changed()))},TableCellMorph.prototype.mouseLeave=function(){this.isLabel&&(this.drawData(),this.changed())},TableMorph.prototype=new FrameMorph,TableMorph.prototype.constructor=TableMorph,TableMorph.uber=FrameMorph.prototype,TableMorph.prototype.highContrast=!1,TableMorph.prototype.init=function(t,e,o,r,i,n,s,a,h,l){this.table=t,this.scrollBarSize=e||MorphicPreferences.scrollBarSize,this.startRow=r||1,this.startCol=i||1,this.textHeight=Math.ceil(1.3*fontHeight(SyntaxElementMorph.prototype.fontSize)),this.rowHeight=a||this.textHeight,this.colWidths=s||[],this.globalColWidth=n||Math.ceil(3.5*this.textHeight),this.colLabelHeight=h||this.textHeight,this.padding=l||SyntaxElementMorph.prototype.scale,this.tableVersion=this.table.lastChanged,this.hBar=null,this.vBar=null,this.rowLabelWidth=0,this.columns=[],this.rows=0,this.maxStartRow=null,this.maxStartCol=null,this.dragAnchor=null,this.resizeAnchor=null,this.resizeCol=null,this.resizeRow=null,this.wantsUpdate=!1,Morph.prototype.init.call(this,!0),o&&this.silentSetExtent(o),this.initScrollBars(),this.drawNew()},TableMorph.prototype.initScrollBars=function(){var t=this;this.hBar=new SliderMorph(1,null,null,null,"horizontal"),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=function(e){t.showData(e,null,!0)},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(1,null,null,null,"vertical"),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(e){t.showData(null,e,!0)},this.vBar.isDraggable=!1,this.add(this.vBar)},TableMorph.prototype.updateScrollBars=function(){1===this.maxStartCol?this.hBar.hide():(this.hBar.show(),this.hBar.stop=this.maxStartCol,this.hBar.value=this.startCol,this.hBar.size=Math.max(this.hBar.rangeSize()*this.columns.length/this.table.cols(),this.hBar.rangeSize()/10),this.hBar.drawNew()),this.vBar.stop=this.maxStartRow,this.vBar.value=this.startRow,1===this.maxStartRow?this.vBar.hide():(this.vBar.show(),this.vBar.size=Math.max(this.vBar.rangeSize()*this.rows/this.table.rows(),this.vBar.rangeSize()/10),this.vBar.drawNew())},TableMorph.prototype.drawNew=function(){var t,e,o;if(this.image=newCanvas(this.extent()),t=this.image.getContext("2d"),t.fillStyle="rgb(220, 220, 220)",BoxMorph.prototype.outlinePath.call(this,t,SyntaxElementMorph.prototype.corner+1,0),t.fill(),this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.highContrast&&this.table.cols()>1){for(e=this.padding,o=this.startCol;o<=this.table.cols();o+=1)e+=this.colWidth(o)+this.padding;t.fillStyle="darkGray",t.fillRect(this.padding+this.rowLabelWidth,this.padding+this.colLabelHeight,e,(this.rowHeight+this.padding)*(this.table.rows()+1-this.startRow)+this.padding)}this.buildCells(),this.hBar.setWidth(this.width()-this.vBar.width()),this.hBar.setLeft(this.left()),this.hBar.setBottom(this.bottom()),this.vBar.setHeight(this.height()-this.hBar.height()),this.vBar.setRight(this.right()),this.vBar.setTop(this.top())},TableMorph.prototype.buildCells=function(){var t,e,o,r=this.position();for(this.children=[],o=0;o<=this.columns.length;o+=1)for(e=0;e<=this.rows;e+=1)t=new TableCellMorph(this.table.get(o?o+this.startCol-1:o,e?e+this.startRow-1:e),new Point(o?this.colWidth(o+this.startCol-1):this.rowLabelWidth,e?this.rowHeight:this.colLabelHeight),!(e&&o),!1),t.setPosition(new Point(o?this.columns[o-1]:this.padding,e?2*this.padding+this.colLabelHeight+(e-1)*(this.rowHeight+this.padding):this.padding).add(r)),this.add(t),isSnapObject(t.getData())&&(this.wantsUpdate=!0);this.add(this.hBar),this.add(this.vBar),this.updateScrollBars(),this.changed()},TableMorph.prototype.drawData=function(t){var e,o,r,i=0;for(r=0;r<=this.columns.length;r+=1)for(o=0;o<=this.rows;o+=1)e=this.children[i],i+=1,e.setData(this.table.get(r?r+this.startCol-1:r,o?o+this.startRow-1:o)),isSnapObject(e.getData())&&(this.wantsUpdate=!0);t||this.updateScrollBars(),this.changed()},TableMorph.prototype.scroll=function(t,e){this.showData(Math.min(this.maxStartCol,Math.max(1,this.startCol+Math.round(t))),Math.min(this.maxStartRow,Math.max(1,this.startRow+Math.round(e)))),this.updateScrollBars()},TableMorph.prototype.showData=function(t,e,o){var r=t||this.startCol,i=e||this.startRow;if(r===this.startCol){if(i===this.startRow)return;this.startRow=i,this.rows=this.visibleRows(),this.drawData(o)}else this.startCol=r,this.startRow=i,this.rows=this.visibleRows(),this.colWidths.length?(this.columns=this.columnsLayout(),this.buildCells()):this.drawData(o)},TableMorph.prototype.step=function(){this.dragAnchor?this.shiftCells(this.world().hand.position()):this.resizeAnchor&&this.resizeCells(this.world().hand.position()),this.update()},TableMorph.prototype.update=function(){var t,e,o=this.table instanceof List?this.table.version(this.startRow,this.rows):this.table.lastChanged;(this.tableVersion!==o||this.wantsUpdate)&&(this.wantsUpdate=!1,this.table instanceof List?(t=this.columns.length,e=this.rows,this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.columns.length!==t||this.rows!==e?this.buildCells():this.drawData()):this.drawData(),this.tableVersion=o)},TableMorph.prototype.rowLabelsWidth=function(){var t=newCanvas().getContext("2d");return t.font="italic "+SyntaxElementMorph.prototype.fontSize+"px Helvetica, Arial, sans-serif",Math.max(0,Math.max.apply(null,this.table.columnNames().map(function(e){return e?t.measureText(e).width:0})))||t.measureText(this.table.rows().toString()).width+6*SyntaxElementMorph.prototype.scale},TableMorph.prototype.columnsLayout=function(){var t,e,o=[],r=2*this.padding+this.rowLabelWidth;for(t=this.table.cols(),e=r;e<this.width()&&t>0;)e+=this.colWidth(t),t-=1;for(0===t&&e<this.width()?this.maxStartCol=1:this.maxStartCol=Math.min(t+2,this.table.cols()),this.startCol=Math.min(this.startCol,this.maxStartCol),t=this.startCol;r<this.width()&&t<this.table.cols()+this.startCol;)e=this.colWidth(t),o.push(r),r+=e,r+=this.padding,t+=1;return o},TableMorph.prototype.colWidth=function(t){return this.colWidths[t-1]||this.globalColWidth},TableMorph.prototype.visibleRows=function(){var t,e=this.height()-this.colLabelHeight-this.padding;return e<0?0:(t=Math.ceil(e/(this.rowHeight+this.padding)),this.maxStartRow=Math.max(1,this.table.rows()-t+2),this.startRow=Math.min(this.startRow,this.maxStartRow),Math.min(this.table.rows(),t))},TableMorph.prototype.globalExtent=function(){var t,e=this.rowLabelsWidth()+2,o=this.table.cols();for(t=0;t<o;t+=1)e+=this.colWidth(t+1),e+=this.padding;return 1===o&&(e+=this.scrollBarSize,e+=2*this.padding),new Point(e+this.padding,this.colLabelHeight+2*this.padding+(this.rowHeight+this.padding)*this.table.rows())},TableMorph.prototype.mouseScroll=function(t,e){this.scroll(-(+e*MorphicPreferences.mouseScrollAmount/4),-(+t*MorphicPreferences.mouseScrollAmount))},TableMorph.prototype.mouseDownLeft=function(t){var e=t.subtract(this.position());e.x<=this.rowLabelWidth||e.y<=this.colLabelHeight?(16===this.world().currentKey?this.resizeCol=0:this.resizeCol=this.columnAt(e.x),this.resizeRow=e.y>this.colLabelHeight,this.resizeAnchor=t):(this.resizeRow=null,this.dragAnchor=t)},TableMorph.prototype.mouseClickLeft=function(t){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},TableMorph.prototype.mouseLeaveDragging=function(t){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},TableMorph.prototype.mouseDoubleClick=function(t){this.parentThatIsA(TableDialogMorph)?this.escalateEvent("mouseDoubleClick",t):new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},TableMorph.prototype.shiftCells=function(t){var e=this.dragAnchor.subtract(t),o=Math.round(e.x/this.globalColWidth),r=Math.round(e.y/this.rowHeight);(o||r)&&(this.scroll(o,r),this.dragAnchor=t)},TableMorph.prototype.resizeCells=function(t){var e,o=t.subtract(this.resizeAnchor);if(this.resizeCol)this.colWidths[this.resizeCol-1]=Math.max(16,(this.colWidths[this.resizeCol-1]||this.globalColWidth)+o.x);else if(this.resizeRow)this.rowHeight=Math.max(16,this.rowHeight+o.y);else for(this.globalColWidth=Math.max(16,this.globalColWidth+o.x),e=0;e<this.colWidths.length;e+=1)this.colWidths[e]&&(this.colWidths[e]=Math.max(16,this.colWidths[e]+o.x));this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells()),this.resizeAnchor=t},TableMorph.prototype.columnAt=function(t){var e=0;if(t<this.columns[0])return 0;for(;t>this.columns[e];)e+=1;return e+this.startCol-1},TableMorph.prototype.userMenu=function(){var t=new MenuMorph(this);return this.parentThatIsA(TableDialogMorph)?(this.colWidths.length&&(t.addItem("reset columns","resetColumns"),t.addLine()),t.addItem("open in another dialog...","openInDialog"),t):(this.colWidths.length&&t.addItem("reset columns","resetColumns"),t.addItem("list view...","showListView"),t.addLine(),t.addItem("open in dialog...","openInDialog"),t)},TableMorph.prototype.resetColumns=function(){this.colWidths=[],this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells())},TableMorph.prototype.openInDialog=function(){new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},TableMorph.prototype.showListView=function(){var t=this.parentThatIsAnyOf([SpriteBubbleMorph,SpeechBubbleMorph,CellMorph]);t&&(t instanceof SpriteBubbleMorph?(t.changed(),t.drawNew(!0)):t instanceof SpeechBubbleMorph?(t.contents=new ListWatcherMorph(this.table),t.contents.step=t.contents.update,t.contents.expand(this.extent()),t.drawNew(!0)):(t.drawNew(!0),t.contentsMorph.expand(this.extent())),t.fixLayout())},TableMorph.prototype.show=function(){TableMorph.uber.show.call(this),this.updateScrollBars()},TableFrameMorph.prototype=new Morph,TableFrameMorph.prototype.constructor=TableFrameMorph,TableFrameMorph.uber=Morph.prototype,TableFrameMorph.prototype.init=function(t,e){this.tableMorph=t,this.handle=null,TableFrameMorph.uber.init.call(this,!0),this.color="transparent",this.noticesTransparentClick=!1,this.bounds=this.tableMorph.bounds.copy(),this.add(this.tableMorph),e||(this.handle=new HandleMorph(this,80,25,null,null)),this.drawNew()},TableFrameMorph.prototype.fixLayout=function(){var t=this.extent();this.tableMorph.extent().eq(t)||(this.tableMorph.setExtent(this.extent()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())},TableFrameMorph.prototype.setExtent=function(t,e){TableFrameMorph.uber.setExtent.call(this,t,e),this.fixLayout()},TableFrameMorph.prototype.expand=function(t){var e=this.tableMorph.globalExtent();t&&(e=e.min(t)),this.setExtent(e),this.handle.setRight(this.right()),this.handle.setBottom(this.bottom())},TableDialogMorph.prototype=new DialogBoxMorph,TableDialogMorph.prototype.constructor=TableDialogMorph,TableDialogMorph.uber=DialogBoxMorph.prototype,TableDialogMorph.prototype.init=function(t,e,o,r){this.handle=null,this.data=t,this.tableView=null,TableDialogMorph.uber.init.call(this),this.labelString="Table view",this.createLabel(),this.buildContents(t,e,o,r)},TableDialogMorph.prototype.buildContents=function(t,e,o,r){this.tableView=new TableMorph(t,null,null,null,null,e,o,r,null,null),this.addBody(new TableFrameMorph(this.tableView,!0)),this.addButton("ok","OK")},TableDialogMorph.prototype.setInitialDimensions=function(){var t=this.world(),e=t.extent().subtract(new Point(this.padding,this.padding)),o=fontHeight(this.titleFontSize)+3*this.titlePadding,r=this.buttons.height();this.setExtent(this.tableView.globalExtent().add(new Point(2*this.padding,2*this.padding+o+r)).min(e).max(new Point(100,100))),this.setCenter(this.world().center())},TableDialogMorph.prototype.popUp=function(t){t&&(TableDialogMorph.uber.popUp.call(this,t),this.setInitialDimensions(),this.handle=new HandleMorph(this,100,100,this.corner,this.corner))},TableDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,modules.xml="2015-June-25";var ReadStream,XML_Element;ReadStream.prototype.nonSpace=/\S|$/g,ReadStream.prototype.nonWord=/[\s\>\/\=]|$/g,ReadStream.prototype.next=function(t){var e,o;return void 0===t?(e=this.contents[this.index],this.index+=1,e):(o=this.index,this.index+=t,this.contents.slice(o,this.index))},ReadStream.prototype.peek=function(){return this.contents[this.index]},ReadStream.prototype.skip=function(t){this.index+=t||1},ReadStream.prototype.atEnd=function(){return this.index>this.contents.length-1},ReadStream.prototype.upTo=function(t){var e=this.contents.indexOf(t,this.index);return e===-1?"":this.contents.slice(this.index,this.index=e)},ReadStream.prototype.peekUpTo=function(t){var e=this.contents.indexOf(t,this.index);return e===-1?"":this.contents.slice(this.index,e)},ReadStream.prototype.skipSpace=function(){this.nonSpace.lastIndex=this.index;var t=this.nonSpace.exec(this.contents);t&&(this.index=t.index)},ReadStream.prototype.word=function(){this.nonWord.lastIndex=this.index;var t=this.nonWord.exec(this.contents);return t?this.contents.slice(this.index,this.index=t.index):""},XML_Element.prototype=Object.create(Node.prototype),XML_Element.prototype.constructor=XML_Element,XML_Element.uber=Node.prototype,XML_Element.prototype.indentation="  ",XML_Element.prototype.init=function(t,e,o){this.tag=t||"unnamed",this.attributes={},this.contents=e||"",XML_Element.uber.init.call(this),o&&o.addChild(this)},XML_Element.prototype.require=function(t){var e=this.childNamed(t);if(!e)throw new Error("Missing required element <"+t+">!");return e},XML_Element.prototype.childNamed=function(t){return detect(this.children,function(e){return e.tag===t})},XML_Element.prototype.childrenNamed=function(t){return this.children.filter(function(e){return e.tag===t})},XML_Element.prototype.parentNamed=function(t){return this.tag===t?this:this.parent?this.parent.parentNamed(t):null},XML_Element.prototype.toString=function(t,e){var o,r,i="",n="",s=e||0;if(t){for(r=0;r<s;r+=1)n+=this.indentation;i+=n}i+="<"+this.tag;for(o in this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,o)&&this.attributes[o]&&(i+=" "+o+'="'+this.attributes[o]+'"');return this.contents.length||this.children.length?(i+=">",i+=this.contents,this.children.forEach(function(e){t&&(i+="\n"),i+=e.toString(t,s+1)}),t&&this.children.length&&(i+="\n"+n),i+="</"+this.tag+">"):i+="/>",i},XML_Element.prototype.escape=function(t,e){var o,r,i=isNil(t)?"":t.toString(),n="";for(o=0;o<i.length;o+=1)switch(r=i[o]){case"'":n+="&apos;";break;case'"':n+=e?r:"&quot;";break;case"<":n+="&lt;";break;case">":n+="&gt;";break;case"&":n+="&amp;";break;case"\n":n+="&#xD;";break;case"~":n+="&#126;";break;default:n+=r}return n},XML_Element.prototype.unescape=function(t){return t.replace(/&(amp|apos|quot|lt|gt|#xD|#126);/g,function(t,e){switch(e){case"amp":return"&";case"apos":return"'";case"quot":return'"';case"lt":return"<";case"gt":return">";case"#xD":return"\n";case"#126":return"~";default:console.warn("unreachable")}})},XML_Element.prototype.parseString=function(t){var e=new ReadStream(t);e.upTo("<"),e.skip(),this.parseStream(e)},XML_Element.prototype.parseStream=function(t){var e,o,r,i;for(this.tag=t.word(),t.skipSpace(),r=t.peek();">"!==r&&"/"!==r;){if(e=t.word(),t.skipSpace(),"="!==t.next())throw new Error('Expected "=" after attribute name');if(t.skipSpace(),r=t.next(),'"'!==r&&"'"!==r)throw new Error("Expected single- or double-quoted attribute value");o=t.upTo(r),t.skip(1),t.skipSpace(),this.attributes[e]=this.unescape(o),r=t.peek()}if("/"!==r){if(">"!==t.next())throw new Error('Expected ">" after tag name and attributes');for(;!t.atEnd();)if(r=t.next(),"<"===r){if("/"===t.peek()){if(t.skip(),t.word()!==this.tag)throw new Error("Expected to close "+this.tag);return t.upTo(">"),t.skip(),void(this.contents=this.unescape(this.contents))}i=new XML_Element(null,null,this),i.parseStream(t)}else this.contents+=r}else if(t.skip(),">"!==t.next())throw new Error('Expected ">" after "/" in empty tag')},modules.store="2016-August-03",XML_Serializer.prototype.idProperty="serializationID",XML_Serializer.prototype.mediaIdProperty="serializationMediaID",XML_Serializer.prototype.mediaDetectionProperty="isMedia",XML_Serializer.prototype.version=1,XML_Serializer.prototype.serialize=function(t){var e;return this.flush(),this.flushMedia(),e=this.store(t),this.flush(),e},XML_Serializer.prototype.store=function(t,e){return isNil(t)||!t.toXML?"":this.isCollectingMedia&&t[this.mediaDetectionProperty]?(this.addMedia(t,e),this.format('<ref mediaID="@"></ref>',t[this.mediaIdProperty])):t[this.idProperty]?this.format('<ref id="@"></ref>',t[this.idProperty]):(this.add(t),t.toXML(this,e).replace("~",this.format('id="@"',t[this.idProperty])))},XML_Serializer.prototype.mediaXML=function(){var t="<media>",e=this;return this.media.forEach(function(o){var r=o.toXML(e).replace("~",e.format('mediaID="@"',o[e.mediaIdProperty]));t+=r}),t+"</media>"},XML_Serializer.prototype.add=function(t){return t[this.idProperty]?-1:(this.contents.push(t),t[this.idProperty]=this.contents.length,this.contents.length)},XML_Serializer.prototype.addMedia=function(t,e){return t[this.mediaIdProperty]?-1:(this.media.push(t),e?t[this.mediaIdProperty]=e+"_"+t.name:t[this.mediaIdProperty]=this.media.length,this.media.length)},XML_Serializer.prototype.at=function(t){return this.contents[t-1]},XML_Serializer.prototype.flush=function(){var t=this;this.contents.forEach(function(e){delete e[t.idProperty]}),this.contents=[]},XML_Serializer.prototype.flushMedia=function(){var t=this;this.media instanceof Array&&this.media.forEach(function(e){delete e[t.mediaIdProperty]}),this.media=[]},XML_Serializer.prototype.escape=XML_Element.prototype.escape,XML_Serializer.prototype.unescape=XML_Element.prototype.unescape,XML_Serializer.prototype.format=function(t){var e,o=this,r=-1,i=arguments;return t.replace(/[@$%]([\d]+)?/g,function(t,n){return n=parseInt(n,10),isNaN(n)?(r+=1,e=i[r+1]):e=i[n+1],"@"===t?o.escape(e):"$"===t?o.escape(e,!0):e})},XML_Serializer.prototype.load=function(t){throw nop(t),new Error("loading should be implemented in heir of XML_Serializer")},XML_Serializer.prototype.parse=function(t){var e=new XML_Element;return e.parseString(t),e};var SnapSerializer;SnapSerializer.prototype=new XML_Serializer,SnapSerializer.prototype.constructor=SnapSerializer,SnapSerializer.uber=XML_Serializer.prototype,SnapSerializer.prototype.app="Snap! 4.0, http://snap.berkeley.edu",SnapSerializer.prototype.thumbnailSize=new Point(160,120),SnapSerializer.prototype.watcherLabels={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getTempo:"tempo",getLastAnswer:"answer",getLastMessage:"message",getTimer:"timer",getCostumeIdx:"costume #",reportMouseX:"mouse x",reportMouseY:"mouse y",reportThreadCount:"processes"},SnapSerializer.prototype.init=function(){this.project={},this.objects={},this.mediaDict={}},XML_Serializer.prototype.mediaXML=function(t){var e='<media name="'+(t||"untitled")+'" app="'+this.app+'" version="'+this.version+'">',o=this;return this.media.forEach(function(t){var r=t.toXML(o).replace("~",o.format('mediaID="@"',t[o.mediaIdProperty]));e+=r}),e+"</media>"},SnapSerializer.prototype.load=function(t,e){return this.loadProjectModel(this.parse(t),e)},SnapSerializer.prototype.loadProjectModel=function(t,e){var o=t.attributes.app,r=o?o.split(" ")[0]:null;return e&&r&&r!==this.app.split(" ")[0]&&e.inform(r+" Project","This project has been created by a different app:\n\n"+r+"\n\nand may be incompatible or fail to load here."),this.rawLoadProjectModel(t)},SnapSerializer.prototype.rawLoadProjectModel=function(t){var e,o,r=this,i={sprites:{}};if(this.project=i,e={project:t},+t.attributes.version>this.version)throw"Project uses newer version of Serializer";if(this.objects={},i.name=e.project.attributes.name,!i.name){for(o=1;Object.prototype.hasOwnProperty.call(localStorage,"-snap-project-Untitled "+o);)o+=1;i.name="Untitled "+o}return e.notes=e.project.childNamed("notes"),e.notes&&(i.notes=e.notes.contents),e.globalVariables=e.project.childNamed("variables"),i.globalVariables=new VariableFrame,e.stage=e.project.require("stage"),StageMorph.prototype.frameRate=0,i.stage=new StageMorph(i.globalVariables),Object.prototype.hasOwnProperty.call(e.stage.attributes,"id")&&(this.objects[e.stage.attributes.id]=i.stage),e.stage.attributes.name&&(i.stage.name=e.stage.attributes.name),"true"===e.stage.attributes.scheduled&&(i.stage.fps=30,StageMorph.prototype.frameRate=30),e.pentrails=e.stage.childNamed("pentrails"),e.pentrails&&(i.pentrails=new Image,i.pentrails.onload=function(){normalizeCanvas(i.stage.trailsCanvas);var t=i.stage.trailsCanvas.getContext("2d");t.drawImage(i.pentrails,0,0),i.stage.changed()},i.pentrails.src=e.pentrails.contents),i.stage.setTempo(e.stage.attributes.tempo),StageMorph.prototype.dimensions=new Point(480,360),e.stage.attributes.width&&(StageMorph.prototype.dimensions.x=Math.max(+e.stage.attributes.width,480)),e.stage.attributes.height&&(StageMorph.prototype.dimensions.y=Math.max(+e.stage.attributes.height,180)),i.stage.setExtent(StageMorph.prototype.dimensions),SpriteMorph.prototype.useFlatLineEnds="flat"===e.stage.attributes.lines,i.stage.isThreadSafe="true"===e.stage.attributes.threadsafe,StageMorph.prototype.enableCodeMapping="true"===e.stage.attributes.codify,StageMorph.prototype.enableInheritance="true"===e.stage.attributes.inheritance,StageMorph.prototype.enableSublistIDs="true"===e.stage.attributes.sublistIDs,e.hiddenPrimitives=e.project.childNamed("hidden"),e.hiddenPrimitives&&e.hiddenPrimitives.contents.split(" ").forEach(function(t){t&&(StageMorph.prototype.hiddenPrimitives[t]=!0)}),e.codeHeaders=e.project.childNamed("headers"),e.codeHeaders&&e.codeHeaders.children.forEach(function(t){StageMorph.prototype.codeHeaders[t.tag]=t.contents}),e.codeMappings=e.project.childNamed("code"),e.codeMappings&&e.codeMappings.children.forEach(function(t){StageMorph.prototype.codeMappings[t.tag]=t.contents}),e.globalBlocks=e.project.childNamed("blocks"),e.globalBlocks&&(this.loadCustomBlocks(i.stage,e.globalBlocks,!0),this.populateCustomBlocks(i.stage,e.globalBlocks,!0)),this.loadObject(i.stage,e.stage),e.sprites=e.stage.require("sprites"),i.sprites[i.stage.name]=i.stage,e.sprites.childrenNamed("sprite").forEach(function(t){r.loadValue(t)}),r.project.stage.children.forEach(function(t){var e,o;t.inheritanceInfo&&(e=r.project.sprites[t.inheritanceInfo.exemplar],e&&t.setExemplar(e)),t.nestingInfo&&(o=r.project.sprites[t.nestingInfo.anchor],o&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)}),r.project.stage.children.forEach(function(t){delete t.inheritanceInfo,t.nestingInfo&&(t.nestingScale=+(t.nestingInfo.scale||t.scale),delete t.nestingInfo)}),e.globalVariables&&this.loadVariables(i.globalVariables,e.globalVariables),this.objects={},e.sprites.childrenNamed("watcher").forEach(function(t){var e,o,n,s,a,h;o=r.loadColor(t.attributes.color),n=Object.prototype.hasOwnProperty.call(t.attributes,"scope")?i.sprites[t.attributes.scope]:null,s=Object.prototype.hasOwnProperty.call(t.attributes,"hidden")&&"false"!==t.attributes.hidden,e=Object.prototype.hasOwnProperty.call(t.attributes,"var")?new WatcherMorph(t.attributes.var,o,isNil(n)?i.globalVariables:n.variables,t.attributes.var,s):new WatcherMorph(localize(r.watcherLabels[t.attributes.s]),o,n,t.attributes.s,s),e.setStyle(t.attributes.style||"normal"),"slider"===e.style&&(e.setSliderMin(t.attributes.min||"1",!0),e.setSliderMax(t.attributes.max||"100",!0)),e.setPosition(i.stage.topLeft().add(new Point(+t.attributes.x||0,+t.attributes.y||0))),i.stage.add(e),e.onNextStep=function(){this.currentValue=null},e.currentValue instanceof List&&(a=t.attributes.extX,a&&e.cellMorph.contentsMorph.setWidth(+a),h=t.attributes.extY,h&&e.cellMorph.contentsMorph.setHeight(+h),e.cellMorph.contentsMorph.handle.drawNew())}),this.objects={},i},SnapSerializer.prototype.loadBlocks=function(t,e){var o,r=new StageMorph;if(this.project={stage:r,sprites:{},targetStage:e},o=this.parse(t),+o.attributes.version>this.version)throw"Module uses newer version of Serializer";return this.loadCustomBlocks(r,o,!0),this.populateCustomBlocks(r,o,!0),this.objects={},r.globalBlocks.forEach(function(t){t.receiver=null}),this.objects={},this.project={},this.mediaDict={},r.globalBlocks},SnapSerializer.prototype.loadSprites=function(t,e){var o,r,i=this;if(r=this.project={globalVariables:e.globalVariables,stage:e.stage,sprites:{}},r.sprites[r.stage.name]=r.stage,o=this.parse(t),+o.attributes.version>this.version)throw"Module uses newer version of Serializer";o.childrenNamed("sprite").forEach(function(t){var o=new SpriteMorph(r.globalVariables);t.attributes.id&&(i.objects[t.attributes.id]=o),t.attributes.name&&(o.name=t.attributes.name,r.sprites[t.attributes.name]=o),t.attributes.color&&(o.color=i.loadColor(t.attributes.color)),t.attributes.pen&&(o.penPoint=t.attributes.pen),r.stage.add(o),e.sprites.add(o),o.scale=parseFloat(t.attributes.scale||"1"),o.rotationStyle=parseFloat(t.attributes.rotation||"1"),o.isDraggable="false"!==t.attributes.draggable,o.isVisible="true"!==t.attributes.hidden,o.heading=parseFloat(t.attributes.heading)||0,o.drawNew(),o.gotoXY(+t.attributes.x||0,+t.attributes.y||0),i.loadObject(o,t)}),r.stage.children.forEach(function(t){var e,o;t.inheritanceInfo&&(e=r.sprites[t.inheritanceInfo.exemplar],e&&t.setExemplar(e)),t.nestingInfo&&(o=r.sprites[t.nestingInfo.anchor],o&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)}),r.stage.children.forEach(function(t){delete t.inheritanceInfo,t.nestingInfo&&(t.nestingScale=+(t.nestingInfo.scale||t.scale),delete t.nestingInfo)}),this.objects={},this.project={},this.mediaDict={},e.createCorral(),e.fixLayout()},SnapSerializer.prototype.loadMedia=function(t){return this.loadMediaModel(this.parse(t))},SnapSerializer.prototype.loadMediaModel=function(t){var e=this,o=t;if(this.mediaDict={},+o.attributes.version>this.version)throw"Module uses newer version of Serializer";return o.children.forEach(function(t){e.loadValue(t)}),this.mediaDict},SnapSerializer.prototype.loadObject=function(t,e){var o=e.require("blocks");this.loadInheritanceInfo(t,e),this.loadNestingInfo(t,e),this.loadCostumes(t,e),this.loadSounds(t,e),this.loadCustomBlocks(t,o),this.populateCustomBlocks(t,o),this.loadVariables(t.variables,e.require("variables")),this.loadScripts(t.scripts,e.require("scripts"))},SnapSerializer.prototype.loadInheritanceInfo=function(t,e){var o=e.childNamed("inherit");o&&(t.inheritanceInfo=o.attributes)},SnapSerializer.prototype.loadNestingInfo=function(t,e){var o=e.childNamed("nest");o&&(t.nestingInfo=o.attributes)},SnapSerializer.prototype.loadCostumes=function(t,e){var o,r=e.childNamed("costumes");r&&(t.costumes=this.loadValue(r.require("list"))),Object.prototype.hasOwnProperty.call(e.attributes,"costume")&&(o=t.costumes.asArray()[e.attributes.costume-1],o&&(o.loaded?t.wearCostume(o):o.loaded=function(){t.wearCostume(o),this.loaded=!0}))},SnapSerializer.prototype.loadSounds=function(t,e){var o=e.childNamed("sounds");o&&(t.sounds=this.loadValue(o.require("list")))},SnapSerializer.prototype.loadVariables=function(t,e){var o=this;e.children.forEach(function(e){var r,i;"variable"===e.tag&&(i=e.children[0],r=new Variable,r.isTransient="true"===e.attributes.transient,r.value=r.isTransient||!i?0:o.loadValue(i),t.vars[e.attributes.name]=r)})},SnapSerializer.prototype.loadCustomBlocks=function(t,e,o){var r=this;e.children.forEach(function(e){var i,n,s,a,h,l,p,c;"block-definition"===e.tag&&(i=new CustomBlockDefinition(e.attributes.s||"",t),i.category=e.attributes.category||"other",i.type=e.attributes.type||"command",i.isGlobal=o===!0,i.isGlobal?t.globalBlocks.push(i):t.customBlocks.push(i),n=i.parseSpec(i.spec).filter(function(t){return"%"===t.charAt(0)&&t.length>1}).map(function(t){return t.substr(1);
}),i.names=n,s=e.childNamed("inputs"),s&&(c=-1,s.children.forEach(function(t){var e=t.childNamed("options");"input"===t.tag&&(c+=1,i.declarations[n[c]]=[t.attributes.type,t.contents,e?e.contents:void 0,"true"===t.attributes.readonly])})),a=e.childNamed("variables"),a&&(i.variableNames=r.loadValue(a.require("list")).asArray()),h=e.childNamed("header"),h&&(i.codeHeader=h.contents),l=e.childNamed("code"),l&&(i.codeMapping=l.contents),p=e.childNamed("comment"),p&&(i.comment=r.loadComment(p)))})},SnapSerializer.prototype.populateCustomBlocks=function(t,e,o){var r=this;e.children.forEach(function(e,i){var n,s,a;"block-definition"===e.tag&&(n=o?t.globalBlocks[i]:t.customBlocks[i],s=e.childNamed("script"),s&&(n.body=new Context(null,s?r.loadScript(s):null,null,t),n.body.inputs=n.names.slice(0)),a=e.childNamed("scripts"),a&&(n.scripts=r.loadScriptsArray(a)),delete n.names)})},SnapSerializer.prototype.loadScripts=function(t,e){var o=this,r=SyntaxElementMorph.prototype.scale;t.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,e.children.forEach(function(e){var i;if("script"===e.tag){if(i=o.loadScript(e),!i)return;i.setPosition(new Point((+e.attributes.x||0)*r,(+e.attributes.y||0)*r).add(t.topLeft())),t.add(i),i.fixBlockColor(null,!0),i.allComments().forEach(function(t){t.align(i)})}else if("comment"===e.tag){if(i=o.loadComment(e),!i)return;i.setPosition(new Point((+e.attributes.x||0)*r,(+e.attributes.y||0)*r).add(t.topLeft())),t.add(i)}})},SnapSerializer.prototype.loadScriptsArray=function(t){var e=this,o=SyntaxElementMorph.prototype.scale,r=[];return t.children.forEach(function(t){var i;if("script"===t.tag){if(i=e.loadScript(t),!i)return;i.setPosition(new Point((+t.attributes.x||0)*o,(+t.attributes.y||0)*o)),r.push(i),i.fixBlockColor(null,!0)}else if("comment"===t.tag){if(i=e.loadComment(t),!i)return;i.setPosition(new Point((+t.attributes.x||0)*o,(+t.attributes.y||0)*o)),r.push(i)}}),r},SnapSerializer.prototype.loadScript=function(t){var e,o,r,i=this;return t.children.forEach(function(t){if(r=i.loadBlock(t)){if(o){if(!(o.nextBlock&&r instanceof CommandBlockMorph))return console.log("SNAP: expecting a command but getting a reporter:\n  "+o.blockSpec+"\n  "+r.blockSpec),e;o.nextBlock(r)}else e=r;o=r}}),e},SnapSerializer.prototype.loadComment=function(t){var e=new CommentMorph(t.contents),o=SyntaxElementMorph.prototype.scale;return e.isCollapsed="true"===t.attributes.collapsed,e.setTextWidth(+t.attributes.w*o),e},SnapSerializer.prototype.loadBlock=function(t,e){var o,r,i,n,s,a;if("block"===t.tag){if(Object.prototype.hasOwnProperty.call(t.attributes,"var"))return SpriteMorph.prototype.variableBlock(t.attributes.var);o=SpriteMorph.prototype.blockForSelector(t.attributes.s)}else if("custom-block"===t.tag){if(n=!t.attributes.scope,a=n?this.project.stage:this.project.sprites[t.attributes.scope],s=t.childNamed("receiver"),s&&s.children[0]&&(a=this.loadValue(t.childNamed("receiver").children[0])),!a){if(n)return this.obsoleteBlock(e);a=this.project.stage}if(n?(r=detect(a.globalBlocks,function(e){return e.blockSpec()===t.attributes.s}),!r&&this.project.targetStage&&(r=detect(this.project.targetStage.globalBlocks,function(e){return e.blockSpec()===t.attributes.s}))):r=detect(a.customBlocks,function(e){return e.blockSpec()===t.attributes.s}),!r)return this.obsoleteBlock(e);o="command"===r.type?new CustomCommandBlockMorph(r,!1):new CustomReporterBlockMorph(r,"predicate"===r.type,!1)}return null===o&&(o=this.obsoleteBlock(e)),o.isDraggable=!0,i=o.inputs(),t.children.forEach(function(t,e){"variables"===t.tag?this.loadVariables(o.variables,t):"comment"===t.tag?(o.comment=this.loadComment(t),o.comment.block=o):"receiver"===t.tag?nop():this.loadInput(t,i[e],o)},this),o.cachedInputs=null,o},SnapSerializer.prototype.obsoleteBlock=function(t){var e=t?new ReporterBlockMorph:new CommandBlockMorph;return e.selector="errorObsolete",e.color=new Color(200,0,20),e.setSpec("Obsolete!"),e.isDraggable=!0,e},SnapSerializer.prototype.loadInput=function(t,e,o){var r,i,n=this;if("script"===t.tag)r=this.loadScript(t),r&&(e.add(r),e.fixLayout());else if("autolambda"===t.tag&&t.children[0])r=this.loadBlock(t.children[0],!0),r&&(e.silentReplaceInput(e.children[0],r),e.fixLayout());else if("list"===t.tag){for(;e.inputs().length>0;)e.removeInput();t.children.forEach(function(t){e.addInput(),n.loadInput(t,e.children[e.children.length-2],e)}),e.fixLayout()}else"block"===t.tag||"custom-block"===t.tag?o.silentReplaceInput(e,this.loadBlock(t,!0)):"color"===t.tag?e.setColor(this.loadColor(t.contents)):(i=this.loadValue(t),!isNil(i)&&e.setContents&&e.setContents(this.loadValue(t)))},SnapSerializer.prototype.loadValue=function(t){function e(){Object.prototype.hasOwnProperty.call(t.attributes,"id")&&(u.objects[t.attributes.id]=o),Object.prototype.hasOwnProperty.call(t.attributes,"mediaID")&&(u.mediaDict[t.attributes.mediaID]=o)}var o,r,i,n,s,a,h,l,p,c,d,u=this;switch(t.tag){case"ref":if(Object.prototype.hasOwnProperty.call(t.attributes,"id"))return this.objects[t.attributes.id];if(Object.prototype.hasOwnProperty.call(t.attributes,"mediaID"))return this.mediaDict[t.attributes.mediaID];throw new Error("expecting a reference id");case"l":return(c=t.childNamed("option"))?[c.contents]:(d=t.childNamed("bool"),d?this.loadValue(d):t.contents);case"bool":return"true"===t.contents;case"list":return t.attributes.hasOwnProperty("linked")?(o=new List,o.isLinked=!0,e(),i=o,n=t.childrenNamed("item"),n.forEach(function(e,r){var i=e.children[0];i?o.first=u.loadValue(i):o.first=0;var s=t.childNamed("list")||t.childNamed("ref");s?o.rest=u.loadValue(s):r<n.length-1&&(o.rest=new List,o=o.rest,o.isLinked=!0)}),i):(o=new List,e(),o.contents=t.childrenNamed("item").map(function(t){var e=t.children[0];return e?u.loadValue(e):0}),o);case"sprite":return o=new SpriteMorph(u.project.globalVariables),t.attributes.id&&(u.objects[t.attributes.id]=o),t.attributes.name&&(o.name=t.attributes.name,u.project.sprites[t.attributes.name]=o),t.attributes.idx&&(o.idx=+t.attributes.idx),t.attributes.color&&(o.color=u.loadColor(t.attributes.color)),t.attributes.pen&&(o.penPoint=t.attributes.pen),u.project.stage.add(o),o.scale=parseFloat(t.attributes.scale||"1"),o.rotationStyle=parseFloat(t.attributes.rotation||"1"),o.isDraggable="false"!==t.attributes.draggable,o.isVisible="true"!==t.attributes.hidden,o.heading=parseFloat(t.attributes.heading)||0,o.drawNew(),o.gotoXY(+t.attributes.x||0,+t.attributes.y||0),u.loadObject(o,t),o;case"context":return o=new Context(null),e(),s=t.childNamed("script"),s?o.expression=this.loadScript(s):(s=t.childNamed("block")||t.childNamed("custom-block"),s?o.expression=this.loadBlock(s):(s=t.childNamed("l"),s&&(d=s.childNamed("bool"),d?o.expression=new BooleanSlotMorph(this.loadValue(d)):o.expression=new InputSlotMorph(s.contents)))),o.expression instanceof BlockMorph&&(r=0,o.expression.allEmptySlots().forEach(function(t){r+=1,t instanceof MultiArgMorph?t.bindingID=["arguments"]:t.bindingID=r}),o.emptySlots=r),s=t.childNamed("receiver"),s&&(s=s.childNamed("ref")||s.childNamed("sprite"),s&&(o.receiver=this.loadValue(s))),s=t.childNamed("inputs"),s&&s.children.forEach(function(t){"input"===t.tag&&o.inputs.push(t.contents)}),s=t.childNamed("variables"),s&&this.loadVariables(o.variables,s),s=t.childNamed("context"),s&&(o.outerContext=this.loadValue(s)),o.outerContext&&o.receiver&&!o.outerContext.variables.parentFrame&&(o.outerContext.variables.parentFrame=o.receiver.variables),o;case"costume":return a=new Point,Object.prototype.hasOwnProperty.call(t.attributes,"center-x")&&(a.x=parseFloat(t.attributes["center-x"])),Object.prototype.hasOwnProperty.call(t.attributes,"center-y")&&(a.y=parseFloat(t.attributes["center-y"])),Object.prototype.hasOwnProperty.call(t.attributes,"name")&&(l=t.attributes.name),Object.prototype.hasOwnProperty.call(t.attributes,"image")&&(h=new Image,0!==t.attributes.image.indexOf("data:image/svg+xml")||MorphicPreferences.rasterizeSVGs?(o=new Costume(null,l,a),h.onload=function(){var t=newCanvas(new Point(h.width,h.height),!0),e=t.getContext("2d");e.drawImage(h,0,0),o.contents=t,o.version=+new Date,"function"==typeof o.loaded?o.loaded():o.loaded=!0}):(o=new SVG_Costume(null,l,a),h.onload=function(){o.contents=h,o.version=+new Date,"function"==typeof o.loaded?o.loaded():o.loaded=!0}),h.src=t.attributes.image),e(),o;case"sound":return p=new Audio,p.src=t.attributes.sound,o=new Sound(p,t.attributes.name),Object.prototype.hasOwnProperty.call(t.attributes,"mediaID")&&(u.mediaDict[t.attributes.mediaID]=o),o}},SnapSerializer.prototype.loadColor=function(t){var e=(t||"").split(",");return new Color(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))},SnapSerializer.prototype.openProject=function(t,e){var o,r=e.stage,i=[];t&&t.stage&&(e.projectName=t.name,e.projectNotes=t.notes||"",e.globalVariables&&(e.globalVariables=t.globalVariables),r&&r.destroy(),e.add(t.stage),e.stage=t.stage,i=e.stage.children.filter(function(t){return t instanceof SpriteMorph}),i.sort(function(t,e){return t.idx-e.idx}),e.sprites=new List(i),o=i[0]||t.stage,sizeOf(this.mediaDict)>0?(e.hasChangedMedia=!1,this.mediaDict={}):e.hasChangedMedia=!0,t.stage.drawNew(),e.createCorral(),e.selectSprite(o),e.fixLayout(),e.world().keyboardReceiver=t.stage)},Array.prototype.toXML=function(t){return this.reduce(function(e,o){return e+t.store(o)},"")},StageMorph.prototype.toXML=function(t){function e(t){var e="";return Object.keys(StageMorph.prototype[t]).forEach(function(o){e+="<"+o+">"+XML_Element.prototype.escape(StageMorph.prototype[t][o])+"</"+o+">"}),e}var o,r=normalizeCanvas(this.thumbnail(SnapSerializer.prototype.thumbnailSize),!0),i=this.parentThatIsA(IDE_Morph);try{o=r.toDataURL("image/png")}catch(t){o=null}return this.removeAllClones(),t.format('<project name="@" app="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" costume="@" tempo="@" threadsafe="@" lines="@" codify="@" inheritance="@" sublistIDs="@" scheduled="@" ~><pentrails>$</pentrails><costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><scripts>%</scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables></project>',i&&i.projectName?i.projectName:localize("Untitled"),t.app,t.version,i&&i.projectNotes?i.projectNotes:"",o,this.name,StageMorph.prototype.dimensions.x,StageMorph.prototype.dimensions.y,this.getCostumeIdx(),this.getTempo(),this.isThreadSafe,SpriteMorph.prototype.useFlatLineEnds?"flat":"round",this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,0!==StageMorph.prototype.frameRate,normalizeCanvas(this.trailsCanvas,!0).toDataURL("image/png"),t.store(this.costumes,this.name+"_cst"),t.store(this.sounds,this.name+"_snd"),t.store(this.variables),t.store(this.customBlocks),t.store(this.scripts),t.store(this.children),Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(function(t,e){return t+" "+e},""),e("codeHeaders"),e("codeMappings"),t.store(this.globalBlocks),i&&i.globalVariables?t.store(i.globalVariables):"")},SpriteMorph.prototype.toXML=function(t){var e=this.parentThatIsA(StageMorph),o=e?e.parentThatIsA(IDE_Morph):null,r=o?o.sprites.asArray().indexOf(this)+1:0;return t.format('<sprite name="@" idx="@" x="@" y="@" heading="@" scale="@" rotation="@" draggable="@"% costume="@" color="@,@,@" pen="@" ~>%%<costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><scripts>%</scripts></sprite>',this.name,r,this.xPosition(),this.yPosition(),this.heading,this.scale,this.rotationStyle,this.isDraggable,this.isVisible?"":' hidden="true"',this.getCostumeIdx(),this.color.r,this.color.g,this.color.b,this.penPoint,this.exemplar?'<inherit exemplar="'+this.exemplar.name+'"/>':"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'" scale="'+this.nestingScale)+'"/>':"",t.store(this.costumes,this.name+"_cst"),t.store(this.sounds,this.name+"_snd"),t.store(this.variables),this.customBlocks?t.store(this.customBlocks):"",t.store(this.scripts))},Costume.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0,Costume.prototype.toXML=function(t){return t.format('<costume name="@" center-x="@" center-y="@" image="@" ~/>',this.name,this.rotationCenter.x,this.rotationCenter.y,this instanceof SVG_Costume?this.contents.src:this.contents.toDataURL("image/png"))},Sound.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0,Sound.prototype.toXML=function(t){return t.format('<sound name="@" sound="@" ~/>',this.name,this.toDataURL())},VariableFrame.prototype.toXML=function(t){var e=this;return Object.keys(this.vars).reduce(function(o,r){var i,n=e.vars[r].value;return i=e.vars[r].isTransient?t.format('<variable name="@" transient="true"/>',r):void 0===n||null===n?t.format('<variable name="@"/>',r):t.format('<variable name="@">%</variable>',r,"object"==typeof n?isSnapObject(n)?"":t.store(n):"boolean"==typeof n?t.format("<bool>$</bool>",n):t.format("<l>$</l>",n)),o+i},"")},WatcherMorph.prototype.toXML=function(t){var e=this.target instanceof VariableFrame,o=this.currentValue instanceof List,r=this.readoutColor,i=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return this.isTemporary()?"":t.format('<watcher% % style="@"% x="@" y="@" color="@,@,@"%%/>',e&&this.target.owner||!e&&this.target?t.format(' scope="@"',e?this.target.owner.name:this.target.name):"",t.format(e?'var="@"':'s="@"',this.getter),this.style,e&&"slider"===this.style?t.format(' min="@" max="@"',this.sliderMorph.start,this.sliderMorph.stop):"",i.x,i.y,r.r,r.g,r.b,o?t.format(' extX="@" extY="@"',this.cellMorph.contentsMorph.width(),this.cellMorph.contentsMorph.height()):"",this.isVisible?"":' hidden="true"')},ScriptsMorph.prototype.toXML=function(t){return this.children.reduce(function(e,o){return o instanceof BlockMorph?e+o.toScriptXML(t,!0):o instanceof CommentMorph&&!o.block?e+o.toXML(t):e},"")},BlockMorph.prototype.toXML=BlockMorph.prototype.toScriptXML=function(t,e){var o,r,i=SyntaxElementMorph.prototype.scale,n=this;o=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),r=e?t.format('<script x="@" y="@">',o.x/i,o.y/i):"<script>";do r+=n.toBlockXML(t),n=n.nextBlock();while(n);return r+="</script>"},BlockMorph.prototype.toBlockXML=function(t){return t.format('<block s="@">%%</block>',this.selector,t.store(this.inputs()),this.comment?this.comment.toXML(t):"")},ReporterBlockMorph.prototype.toXML=function(t){return"reportGetVar"===this.selector?t.format('<block var="@"/>',this.blockSpec):this.toBlockXML(t)},ReporterBlockMorph.prototype.toScriptXML=function(t,e){var o,r=SyntaxElementMorph.prototype.scale;return o=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),e?t.format('<script x="@" y="@">%</script>',o.x/r,o.y/r,this.toXML(t)):t.format("<script>%</script>",this.toXML(t))},CustomCommandBlockMorph.prototype.toBlockXML=function(t){var e=this.definition.isGlobal?void 0:this.definition.receiver.name;return t.format('<custom-block s="@"%>%%%%</custom-block>',this.blockSpec,this.definition.isGlobal?"":t.format(' scope="@"',e),t.store(this.inputs()),this.definition.variableNames.length?"<variables>"+this.variables.toXML(t)+"</variables>":"",this.comment?this.comment.toXML(t):"",e&&!this.definition.receiver[t.idProperty]?"<receiver>"+t.store(this.definition.receiver)+"</receiver>":"")},CustomReporterBlockMorph.prototype.toBlockXML=CustomCommandBlockMorph.prototype.toBlockXML,CustomBlockDefinition.prototype.toXML=function(t){function e(e){return e.reduce(function(e,o){return o instanceof BlockMorph?e+o.toScriptXML(t,!0):o instanceof CommentMorph&&!o.block?e+o.toXML(t):e},"")}var o=this;return t.format('<block-definition s="@" type="@" category="@">%'+(this.variableNames.length?"<variables>%</variables>":"@")+"<header>@</header><code>@</code><inputs>%</inputs>%%</block-definition>",this.spec,this.type,this.category||"other",this.comment?this.comment.toXML(t):"",this.variableNames.length?t.store(new List(this.variableNames)):"",this.codeHeader||"",this.codeMapping||"",Object.keys(this.declarations).reduce(function(e,r){return e+t.format('<input type="@"$>$%</input>',o.declarations[r][0],o.declarations[r][3]?' readonly="true"':"",o.declarations[r][1],o.declarations[r][2]?"<options>"+o.declarations[r][2]+"</options>":"")},""),this.body?t.store(this.body.expression):"",this.scripts.length>0?"<scripts>"+e(this.scripts)+"</scripts>":"")},ArgMorph.prototype.toXML=function(){return"<l/>"},BooleanSlotMorph.prototype.toXML=function(){return"boolean"==typeof this.value?"<l><bool>"+this.value+"</bool></l>":"<l/>"},InputSlotMorph.prototype.toXML=function(t){return this.constant?t.format("<l><option>$</option></l>",this.constant):t.format("<l>$</l>",this.contents().text)},TemplateSlotMorph.prototype.toXML=function(t){return t.format("<l>$</l>",this.contents())},CommandSlotMorph.prototype.toXML=function(t){var e=this.children[0];return e instanceof BlockMorph?e instanceof ReporterBlockMorph?t.format("<autolambda>%</autolambda>",t.store(e)):t.store(e):"<script></script>"},FunctionSlotMorph.prototype.toXML=CommandSlotMorph.prototype.toXML,MultiArgMorph.prototype.toXML=function(t){return t.format("<list>%</list>",t.store(this.inputs()))},ArgLabelMorph.prototype.toXML=function(t){return t.format("%",t.store(this.inputs()[0]))},ColorSlotMorph.prototype.toXML=function(t){return t.format("<color>$,$,$,$</color>",this.color.r,this.color.g,this.color.b,this.color.a)},List.prototype.toXML=function(t,e){var o,r,i;if(this.isLinked){if(o='<list linked="linked" ~>',StageMorph.prototype.enableSublistIDs)return r=this.first,isNil(r)||(o+=t.format("<item>%</item>","object"==typeof r?isSnapObject(r)?"":t.store(r,e):"boolean"==typeof r?t.format("<bool>$</bool>",r):t.format("<l>$</l>",r))),isNil(this.rest)||(o+=t.store(this.rest,e)),o+"</list>";i=this;do r=i.first,isNil(r)||(o+=t.format("<item>%</item>","object"==typeof r?isSnapObject(r)?"":t.store(r,e):"boolean"==typeof r?t.format("<bool>$</bool>",r):t.format("<l>$</l>",r))),i=i.rest;while(!isNil(i));return o+"</list>"}return t.format("<list ~>%</list>",this.contents.reduce(function(o,r){return o+t.format("<item>%</item>","object"==typeof r?isSnapObject(r)?"":t.store(r,e):"boolean"==typeof r?t.format("<bool>$</bool>",r):t.format("<l>$</l>",r))},""))},Context.prototype.toXML=function(t){return this.isContinuation?"":t.format("<context ~><inputs>%</inputs><variables>%</variables>%<receiver>%</receiver>%</context>",this.inputs.reduce(function(e,o){return e+t.format("<input>$</input>",o)},""),this.variables?t.store(this.variables):"",this.expression?t.store(this.expression):"",this.receiver?t.store(this.receiver):"",this.outerContext?t.store(this.outerContext):"")},CommentMorph.prototype.toXML=function(t){var e,o=SyntaxElementMorph.prototype.scale;return this.block?t.format('<comment w="@" collapsed="@">%</comment>',this.textWidth()/o,this.isCollapsed,t.escape(this.text())):(e=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),t.format('<comment x="@" y="@" w="@" collapsed="@">%</comment>',e.x/o,e.y/o,this.textWidth()/o,this.isCollapsed,t.escape(this.text())))},modules.cloud="2015-December-15";var Cloud,SnapCloud=new Cloud("https://snap.apps.miosoft.com/SnapCloud");Cloud.prototype.clear=function(){this.username=null,this.password=null,this.session=null,this.limo=null,this.route=null,this.api={}},Cloud.prototype.hasProtocol=function(){return 0===this.url.toLowerCase().indexOf("http")},Cloud.prototype.setRoute=function(t){var e,o=20,r=0;for(e=0;e<t.length;e+=1)r+=t.charCodeAt(e);r=r%o+1,this.route=".sc1m"+(r<10?"0":"")+r},Cloud.prototype.signup=function(t,e,o,r){var i=new XMLHttpRequest,n=this;try{i.open("GET",(this.hasProtocol()?"":"http://")+this.url+"SignUp?Username="+encodeURIComponent(t)+"&Email="+encodeURIComponent(e),!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.withCredentials=!0,i.onreadystatechange=function(){4===i.readyState&&(i.responseText?0===i.responseText.indexOf("ERROR")?r.call(this,i.responseText,"Signup"):o.call(null,i.responseText,"Signup"):r.call(null,n.url+"SignUp",localize("could not connect to:")))},i.send(null)}catch(t){r.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.getPublicProject=function(t,e,o){var r=new XMLHttpRequest,i=this;try{r.open("GET",(this.hasProtocol()?"":"http://")+this.url+"RawPublic?"+t,!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.withCredentials=!0,r.onreadystatechange=function(){4===r.readyState&&(r.responseText?0===r.responseText.indexOf("ERROR")?o.call(this,r.responseText):e.call(null,r.responseText):o.call(null,i.url+"Public",localize("could not connect to:")))},r.send(null)}catch(t){o.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.resetPassword=function(t,e,o){var r=new XMLHttpRequest,i=this;try{r.open("GET",(this.hasProtocol()?"":"http://")+this.url+"ResetPW?Username="+encodeURIComponent(t),!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.withCredentials=!0,r.onreadystatechange=function(){4===r.readyState&&(r.responseText?0===r.responseText.indexOf("ERROR")?o.call(this,r.responseText,"Reset Password"):e.call(null,r.responseText,"Reset Password"):o.call(null,i.url+"ResetPW",localize("could not connect to:")))},r.send(null)}catch(t){o.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.login=function(t,e,o,r){var i=new XMLHttpRequest,n=JSON.stringify({__h:e,__u:t}),s=this;this.setRoute(t);try{i.open("POST",(this.hasProtocol()?"":"http://")+this.url+"?SESSIONGLUE="+this.route,!0),i.setRequestHeader("Content-Type","application/json; charset=utf-8"),i.setRequestHeader("SESSIONGLUE",this.route),i.withCredentials=!0,i.onreadystatechange=function(){4===i.readyState&&(i.responseText?(s.api=s.parseAPI(i.responseText),s.session=i.getResponseHeader("MioCracker").split(";")[0],s.limo=this.getResponseHeader("miocracker").substring(9,this.getResponseHeader("miocracker").indexOf("=")),s.api.logout?(s.username=t,s.password=e,o.call(null,s.api,"Snap!Cloud")):r.call(null,i.responseText,"connection failed")):r.call(null,s.url,localize("could not connect to:")))},i.send(n)}catch(t){r.call(this,t.toString(),"Snap!Cloud")}},Cloud.prototype.reconnect=function(t,e){return this.username&&this.password?void this.login(this.username,this.password,t,e):void this.message("You are not logged in")},Cloud.prototype.saveProject=function(t,e,o){var r,i,n,s,a=this;if(t.serializer.isCollectingMedia=!0,r=t.serializer.serialize(t.stage),i=t.hasChangedMedia?t.serializer.mediaXML(t.projectName):null,t.serializer.isCollectingMedia=!1,t.serializer.flushMedia(),s=i?i.length:0,n=r.length+s,s>10485760)throw(new DialogBoxMorph).inform("Snap!Cloud - Cannot Save Project","The media inside this project exceeds 10 MB.\nPlease reduce the size of costumes or sounds.\n",t.world(),t.cloudIcon(null,new Color(180,0,0))),new Error("Project media exceeds 10 MB size limit");try{t.serializer.parse(r)}catch(e){throw t.showMessage("Serialization of program data failed:\n"+e),new Error("Serialization of program data failed:\n"+e)}if(null!==i)try{t.serializer.parse(i)}catch(e){throw t.showMessage("Serialization of media failed:\n"+e),new Error("Serialization of media failed:\n"+e)}t.serializer.isCollectingMedia=!1,t.serializer.flushMedia(),t.showMessage("Uploading "+Math.round(n/1024)+" KB..."),a.reconnect(function(){a.callService("saveProject",function(o,r){e.call(null,o,r),a.disconnect(),t.hasChangedMedia=!1},o,[t.projectName,r,i,r.length,i?i.length:0])},o)},Cloud.prototype.getProjectList=function(t,e){var o=this;this.reconnect(function(){o.callService("getProjectList",function(e,r){t.call(null,e,r),o.disconnect()},e)},e)},Cloud.prototype.changePassword=function(t,e,o,r){var i=this;this.reconnect(function(){i.callService("changePassword",function(t,e){o.call(null,t,e),i.disconnect()},r,[hex_sha512(t),hex_sha512(e)])},r)},Cloud.prototype.logout=function(t,e){this.clear(),this.callService("logout",t,e)},Cloud.prototype.disconnect=function(){this.callService("logout",nop,nop)},Cloud.prototype.callURL=function(t,e,o){var r,i=new XMLHttpRequest,n=this;try{r=t+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo,i.open("GET",r,!0),i.withCredentials=!0,i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("MioCracker",this.session),i.setRequestHeader("SESSIONGLUE",this.route),i.onreadystatechange=function(){if(4===i.readyState)if(i.responseText){var r=n.parseResponse(i.responseText);e.call(null,r,t)}else o.call(null,t,"no response from:")},i.send(null)}catch(e){o.call(this,e.toString(),t)}},Cloud.prototype.callService=function(t,e,o,r){var i,n,s=new XMLHttpRequest,a=this.api[t],h=this;if(!this.session)return void o.call(null,"You are not connected","Cloud");if(!a)return void o.call(null,"service "+t+" is not available","API");r&&r.length>0&&(n={},a.parameters.forEach(function(t,e){n[t]=r[e]}));try{i=this.url+"/"+a.url+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo,s.open(a.method,i,!0),s.withCredentials=!0,s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.setRequestHeader("MioCracker",this.session),s.setRequestHeader("SESSIONGLUE",this.route),s.onreadystatechange=function(){if(4===s.readyState){var r=[];if(s.responseText&&0===s.responseText.indexOf("ERROR"))return void o.call(this,s.responseText,localize("Service:")+" "+localize(t));"login"===t&&(h.api=h.parseAPI(s.responseText)),r="getRawProject"===t?s.responseText:h.parseResponse(s.responseText),e.call(null,r,a.url)}},s.send(this.encodeDict(n))}catch(t){o.call(this,t.toString(),a.url)}},Cloud.prototype.parseAPI=function(t){var e,o={};return e=t.split(" "),e.forEach(function(t){var e,r=t.split("&"),i={};r.forEach(function(t){var r=t.split("="),n=decodeURIComponent(r[0]).toLowerCase(),s=decodeURIComponent(r[1]);"service"===n?o[s]=i:"parameters"===n?(e=s.split(","),(1!==e.length||e[0])&&(i.parameters=e)):i[n]=s})}),o},Cloud.prototype.parseResponse=function(t){var e,o=[];return t?(e=t.split(" "),e.forEach(function(t){var e=t.split("&"),r={};e.forEach(function(t){var e=t.split("="),o=decodeURIComponent(e[0]),i=decodeURIComponent(e[1]);r[o]=i}),o.push(r)}),o):o},Cloud.prototype.parseDict=function(t){var e={};return t?(t.split("&").forEach(function(t){var o=t.split("="),r=decodeURIComponent(o[0]),i=decodeURIComponent(o[1]);e[r]=i}),e):e},Cloud.prototype.encodeDict=function(t){var e,o,r="";if(!t)return null;for(o in t)t.hasOwnProperty(o)&&(e=encodeURIComponent(o)+"="+encodeURIComponent(t[o]),r.length>0&&(r+="&"),r+=e);return r},Cloud.prototype.message=function(t){alert(t)};var hex_sha512=function(t){function t(t){return o.SHA512(e(t)).toString(o.enc.Hex)}function e(t){for(var e,o,r="",i=-1;++i<t.length;)e=t.charCodeAt(i),o=i+1<t.length?t.charCodeAt(i+1):0,55296<=e&&e<=56319&&56320<=o&&o<=57343&&(e=65536+((1023&e)<<10)+(1023&o),i++),e<=127?r+=String.fromCharCode(e):e<=2047?r+=String.fromCharCode(192|e>>>6&31,128|63&e):e<=65535?r+=String.fromCharCode(224|e>>>12&15,128|e>>>6&63,128|63&e):e<=2097151&&(r+=String.fromCharCode(240|e>>>18&7,128|e>>>12&63,128|e>>>6&63,128|63&e));return r}var o=o||function(t,e){var o={},r=o.lib={},i=r.Base=function(){function t(){}return{extend:function(e){t.prototype=this;var o=new t;return e&&o.mixIn(e),o.$super=this,o},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.$super.extend(this)}}}(),n=r.WordArray=i.extend({init:function(t,o){t=this.words=t||[],this.sigBytes=o!=e?o:4*t.length},toString:function(t){return(t||a).stringify(this)},concat:function(t){var e=this.words,o=t.words,r=this.sigBytes,t=t.sigBytes;if(this.clamp(),r%4)for(var i=0;i<t;i++)e[r+i>>>2]|=(o[i>>>2]>>>24-8*(i%4)&255)<<24-8*((r+i)%4);else if(65535<o.length)for(i=0;i<t;i+=4)e[r+i>>>2]=o[i>>>2];else e.push.apply(e,o);return this.sigBytes+=t,this},clamp:function(){var e=this.words,o=this.sigBytes;e[o>>>2]&=4294967295<<32-8*(o%4),e.length=t.ceil(o/4)},clone:function(){var t=i.clone.call(this);return t.words=this.words.slice(0),t},random:function(e){for(var o=[],r=0;r<e;r+=4)o.push(4294967296*t.random()|0);return n.create(o,e)}}),s=o.enc={},a=s.Hex={stringify:function(t){for(var e=t.words,t=t.sigBytes,o=[],r=0;r<t;r++){var i=e[r>>>2]>>>24-8*(r%4)&255;o.push((i>>>4).toString(16)),o.push((15&i).toString(16))}return o.join("")},parse:function(t){for(var e=t.length,o=[],r=0;r<e;r+=2)o[r>>>3]|=parseInt(t.substr(r,2),16)<<24-4*(r%8);return n.create(o,e/2)}},h=s.Latin1={stringify:function(t){for(var e=t.words,t=t.sigBytes,o=[],r=0;r<t;r++)o.push(String.fromCharCode(e[r>>>2]>>>24-8*(r%4)&255));return o.join("")},parse:function(t){for(var e=t.length,o=[],r=0;r<e;r++)o[r>>>2]|=(255&t.charCodeAt(r))<<24-8*(r%4);return n.create(o,e)}},l=s.Utf8={stringify:function(t){try{return decodeURIComponent(escape(h.stringify(t)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(t){return h.parse(unescape(encodeURIComponent(t)))}},p=r.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=n.create(),this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=l.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var o=this._data,r=o.words,i=o.sigBytes,s=this.blockSize,a=i/(4*s),a=e?t.ceil(a):t.max((0|a)-this._minBufferSize,0),e=a*s,i=t.min(4*e,i);if(e){for(var h=0;h<e;h+=s)this._doProcessBlock(r,h);h=r.splice(0,e),o.sigBytes-=i}return n.create(h,i)},clone:function(){var t=i.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});r.Hasher=p.extend({init:function(){this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize(),this._hash},clone:function(){var t=p.clone.call(this);return t._hash=this._hash.clone(),t},blockSize:16,_createHelper:function(t){return function(e,o){return t.create(o).finalize(e)}},_createHmacHelper:function(t){return function(e,o){return c.HMAC.create(t,o).finalize(e)}}});var c=o.algo={};return o}(Math);!function(t){var e=o,r=e.lib,i=r.Base,n=r.WordArray,e=e.x64={};e.Word=i.extend({init:function(t,e){this.high=t,this.low=e}}),e.WordArray=i.extend({init:function(e,o){e=this.words=e||[],this.sigBytes=o!=t?o:8*e.length},toX32:function(){for(var t=this.words,e=t.length,o=[],r=0;r<e;r++){var i=t[r];o.push(i.high),o.push(i.low)}return n.create(o,this.sigBytes)},clone:function(){for(var t=i.clone.call(this),e=t.words=this.words.slice(0),o=e.length,r=0;r<o;r++)e[r]=e[r].clone();return t}})}(),function(){function t(){return n.create.apply(n,arguments)}var e=o,r=e.lib.Hasher,i=e.x64,n=i.Word,s=i.WordArray,i=e.algo,a=[t(1116352408,3609767458),t(1899447441,602891725),t(3049323471,3964484399),t(3921009573,2173295548),t(961987163,4081628472),t(1508970993,3053834265),t(2453635748,2937671579),t(2870763221,3664609560),t(3624381080,2734883394),t(310598401,1164996542),t(607225278,1323610764),t(1426881987,3590304994),t(1925078388,4068182383),t(2162078206,991336113),t(2614888103,633803317),t(3248222580,3479774868),t(3835390401,2666613458),t(4022224774,944711139),t(264347078,2341262773),t(604807628,2007800933),t(770255983,1495990901),t(1249150122,1856431235),t(1555081692,3175218132),t(1996064986,2198950837),t(2554220882,3999719339),t(2821834349,766784016),t(2952996808,2566594879),t(3210313671,3203337956),t(3336571891,1034457026),t(3584528711,2466948901),t(113926993,3758326383),t(338241895,168717936),t(666307205,1188179964),t(773529912,1546045734),t(1294757372,1522805485),t(1396182291,2643833823),t(1695183700,2343527390),t(1986661051,1014477480),t(2177026350,1206759142),t(2456956037,344077627),t(2730485921,1290863460),t(2820302411,3158454273),t(3259730800,3505952657),t(3345764771,106217008),t(3516065817,3606008344),t(3600352804,1432725776),t(4094571909,1467031594),t(275423344,851169720),t(430227734,3100823752),t(506948616,1363258195),t(659060556,3750685593),t(883997877,3785050280),t(958139571,3318307427),t(1322822218,3812723403),t(1537002063,2003034995),t(1747873779,3602036899),t(1955562222,1575990012),t(2024104815,1125592928),t(2227730452,2716904306),t(2361852424,442776044),t(2428436474,593698344),t(2756734187,3733110249),t(3204031479,2999351573),t(3329325298,3815920427),t(3391569614,3928383900),t(3515267271,566280711),t(3940187606,3454069534),t(4118630271,4000239992),t(116418474,1914138554),t(174292421,2731055270),t(289380356,3203993006),t(460393269,320620315),t(685471733,587496836),t(852142971,1086792851),t(1017036298,365543100),t(1126000580,2618297676),t(1288033470,3409855158),t(1501505948,4234509866),t(1607167915,987167468),t(1816402316,1246189591)],h=[];
!function(){for(var e=0;80>e;e++)h[e]=t()}(),i=i.SHA512=r.extend({_doReset:function(){this._hash=s.create([t(1779033703,4089235720),t(3144134277,2227873595),t(1013904242,4271175723),t(2773480762,1595750129),t(1359893119,2917565137),t(2600822924,725511199),t(528734635,4215389547),t(1541459225,327033209)])},_doProcessBlock:function(t,e){for(var o=this._hash.words,r=o[0],i=o[1],n=o[2],s=o[3],l=o[4],p=o[5],c=o[6],o=o[7],d=r.high,u=r.low,g=i.high,f=i.low,m=n.high,y=n.low,M=s.high,b=s.low,w=l.high,S=l.low,C=p.high,v=p.low,x=c.high,k=c.low,B=o.high,P=o.low,T=d,I=u,L=g,E=f,D=m,R=y,N=M,F=b,A=w,O=S,z=C,j=v,H=x,W=k,_=B,V=P,U=0;80>U;U++){var G=h[U];if(16>U)var X=G.high=0|t[e+2*U],K=G.low=0|t[e+2*U+1];else{var X=h[U-15],K=X.high,q=X.low,X=(q<<31|K>>>1)^(q<<24|K>>>8)^K>>>7,q=(K<<31|q>>>1)^(K<<24|q>>>8)^(K<<25|q>>>7),Y=h[U-2],K=Y.high,J=Y.low,Y=(J<<13|K>>>19)^(K<<3|J>>>29)^K>>>6,J=(K<<13|J>>>19)^(J<<3|K>>>29)^(K<<26|J>>>6),K=h[U-7],$=K.high,Q=h[U-16],Z=Q.high,Q=Q.low,K=q+K.low,X=X+$+(K>>>0<q>>>0?1:0),K=K+J,X=X+Y+(K>>>0<J>>>0?1:0),K=K+Q,X=X+Z+(K>>>0<Q>>>0?1:0);G.high=X,G.low=K}var $=A&z^~A&H,Q=O&j^~O&W,G=T&L^T&D^L&D,tt=I&E^I&R^E&R,q=(I<<4|T>>>28)^(T<<30|I>>>2)^(T<<25|I>>>7),Y=(T<<4|I>>>28)^(I<<30|T>>>2)^(I<<25|T>>>7),J=a[U],et=J.high,ot=J.low,J=V+((A<<18|O>>>14)^(A<<14|O>>>18)^(O<<23|A>>>9)),Z=_+((O<<18|A>>>14)^(O<<14|A>>>18)^(A<<23|O>>>9))+(J>>>0<V>>>0?1:0),J=J+Q,Z=Z+$+(J>>>0<Q>>>0?1:0),J=J+ot,Z=Z+et+(J>>>0<ot>>>0?1:0),J=J+K,Z=Z+X+(J>>>0<K>>>0?1:0),K=Y+tt,G=q+G+(K>>>0<Y>>>0?1:0),_=H,V=W,H=z,W=j,z=A,j=O,O=F+J|0,A=N+Z+(O>>>0<F>>>0?1:0)|0,N=D,F=R,D=L,R=E,L=T,E=I,I=J+K|0,T=Z+G+(I>>>0<J>>>0?1:0)|0}u=r.low=u+I|0,r.high=d+T+(u>>>0<I>>>0?1:0)|0,f=i.low=f+E|0,i.high=g+L+(f>>>0<E>>>0?1:0)|0,y=n.low=y+R|0,n.high=m+D+(y>>>0<R>>>0?1:0)|0,b=s.low=b+F|0,s.high=M+N+(b>>>0<F>>>0?1:0)|0,S=l.low=S+O|0,l.high=w+A+(S>>>0<O>>>0?1:0)|0,v=p.low=v+j|0,p.high=C+z+(v>>>0<j>>>0?1:0)|0,k=c.low=k+W|0,c.high=x+H+(k>>>0<W>>>0?1:0)|0,P=o.low=P+V|0,o.high=B+_+(P>>>0<V>>>0?1:0)|0},_doFinalize:function(){var t=this._data,e=t.words,o=8*this._nDataBytes,r=8*t.sigBytes;e[r>>>5]|=128<<24-r%32,e[(r+128>>>10<<5)+31]=o,t.sigBytes=4*e.length,this._process(),this._hash=this._hash.toX32()},blockSize:32}),e.SHA512=r._createHelper(i),e.HmacSHA512=r._createHmacHelper(i)}();return t}({}),saveAs=saveAs||function(t){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var e=t.document,o=function(){return t.URL||t.webkitURL||t},r=e.createElementNS("http://www.w3.org/1999/xhtml","a"),i="download"in r,n=function(t){var e=new MouseEvent("click");t.dispatchEvent(e)},s=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),a=t.webkitRequestFileSystem,h=t.requestFileSystem||a||t.mozRequestFileSystem,l=function(e){(t.setImmediate||t.setTimeout)(function(){throw e},0)},p="application/octet-stream",c=0,d=500,u=function(e){var r=function(){"string"==typeof e?o().revokeObjectURL(e):e.remove()};t.chrome?r():setTimeout(r,d)},g=function(t,e,o){e=[].concat(e);for(var r=e.length;r--;){var i=t["on"+e[r]];if("function"==typeof i)try{i.call(t,o||t)}catch(t){l(t)}}},f=function(t){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\ufeff",t],{type:t.type}):t},m=function(e,l,d){d||(e=f(e));var m,y,M,b=this,w=e.type,S=!1,C=function(){g(b,"writestart progress write writeend".split(" "))},v=function(){if(y&&s&&"undefined"!=typeof FileReader){var r=new FileReader;return r.onloadend=function(){var t=r.result;y.location.href="data:attachment/file"+t.slice(t.search(/[,;]/)),b.readyState=b.DONE,C()},r.readAsDataURL(e),void(b.readyState=b.INIT)}if(!S&&m||(m=o().createObjectURL(e)),y)y.location.href=m;else{var i=t.open(m,"_blank");void 0==i&&s&&(t.location.href=m)}b.readyState=b.DONE,C(),u(m)},x=function(t){return function(){if(b.readyState!==b.DONE)return t.apply(this,arguments)}},k={create:!0,exclusive:!1};return b.readyState=b.INIT,l||(l="download"),i?(m=o().createObjectURL(e),r.href=m,r.download=l,void setTimeout(function(){n(r),C(),u(m),b.readyState=b.DONE})):(t.chrome&&w&&w!==p&&(M=e.slice||e.webkitSlice,e=M.call(e,0,e.size,p),S=!0),a&&"download"!==l&&(l+=".download"),(w===p||a)&&(y=t),h?(c+=e.size,void h(t.TEMPORARY,c,x(function(t){t.root.getDirectory("saved",k,x(function(t){var o=function(){t.getFile(l,k,x(function(t){t.createWriter(x(function(o){o.onwriteend=function(e){y.location.href=t.toURL(),b.readyState=b.DONE,g(b,"writeend",e),u(t)},o.onerror=function(){var t=o.error;t.code!==t.ABORT_ERR&&v()},"writestart progress write abort".split(" ").forEach(function(t){o["on"+t]=b["on"+t]}),o.write(e),b.abort=function(){o.abort(),b.readyState=b.DONE},b.readyState=b.WRITING}),v)}),v)};t.getFile(l,{create:!1},x(function(t){t.remove(),o()}),x(function(t){t.code===t.NOT_FOUND_ERR?o():v()}))}),v)}),v)):void v())},y=m.prototype,M=function(t,e,o){return new m(t,e,o)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(t,e,o){return o||(t=f(t)),navigator.msSaveOrOpenBlob(t,e||"download")}:(y.abort=function(){var t=this;t.readyState=t.DONE,g(t,"abort")},y.readyState=y.INIT=0,y.WRITING=1,y.DONE=2,y.error=y.onwritestart=y.onprogress=y.onwrite=y.onabort=y.onerror=y.onwriteend=null,M)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),SpriteMorph.prototype.categories=["motion","control","looks","sensing","sound","operators","pen","variables","services","custom","lists","other"],SpriteMorph.prototype.blockColor.services=new Color(217,77,17),SpriteMorph.prototype.blockColor.custom=new Color(120,120,120),SpriteMorph.prototype.freshPalette=function(t){var e,o=new ScrollFrameMorph(null,null,this.sliderColor),r=SyntaxElementMorph.prototype.fontSize,i=0,n=5,s=0,a=!1,h=this,l=this.parentThatIsA(StageMorph),p=Morph.prototype.trackChanges;return Morph.prototype.trackChanges=!1,o.owner=this,o.padding=r/2,o.color=this.paletteColor,o.growth=new Point(0,MorphicPreferences.scrollBarSize),o.userMenu=function(){function e(){var e=SpriteMorph.prototype.blocks,o=StageMorph.prototype.hiddenPrimitives;return Object.keys(o).some(function(o){return!isNil(e[o])&&(e[o].category===t||contains(s[t]||[],o))})}function r(){return o.contents.children.some(function(t){return contains(Object.keys(SpriteMorph.prototype.blocks),t.selector)})}var i=new MenuMorph,n=this.parentThatIsA(IDE_Morph),s={operators:["reifyScript","reifyReporter","reifyPredicate"],control:["doWarp"],variables:["doDeclareVariables","reportNewList","reportCONS","reportListItem","reportCDR","reportListLength","reportListContainsItem","doAddToList","doDeleteFromList","doInsertInList","doReplaceInList"]};return i.addItem("find blocks...",function(){h.searchBlocks()}),r()&&i.addItem("hide primitives",function(){var e=SpriteMorph.prototype.blocks;Object.keys(e).forEach(function(o){e[o].category===t&&(StageMorph.prototype.hiddenPrimitives[o]=!0)}),(s[t]||[]).forEach(function(t){StageMorph.prototype.hiddenPrimitives[t]=!0}),n.flushBlocksCache(t),n.refreshPalette()}),e()&&i.addItem("show primitives",function(){var e=StageMorph.prototype.hiddenPrimitives,o=SpriteMorph.prototype.blocks;Object.keys(e).forEach(function(e){o[e]&&o[e].category===t&&delete StageMorph.prototype.hiddenPrimitives[e]}),(s[t]||[]).forEach(function(t){delete StageMorph.prototype.hiddenPrimitives[t]}),n.flushBlocksCache(t),n.refreshPalette()}),i},e=this.blocksCache[t],e||(e=h.blockTemplates(t),this.isCachingPrimitives&&(h.blocksCache[t]=e)),e.forEach(function(t){if(null!==t)if("-"===t){if(a)return;n+=.8*r,a=!0}else if("="===t){if(a)return;n+=1.6*r,a=!0}else"#"===t?(i=0,n=s):(a=!1,0===i&&(n+=.3*r),t.setPosition(new Point(i,n)),o.addContents(t),t instanceof ToggleMorph||t instanceof RingMorph?(i=t.right()+r/2,s=t.bottom()):(t.fixLayout&&t.fixLayout(),i=0,n+=t.height()))}),"custom"===t&&(l&&(n+=1.6*r,l.globalBlocks.forEach(function(t){var e=t.templateInstance();n+=.3*r,e.setPosition(new Point(i,n)),o.addContents(e),i=0,n+=e.height()})),n+=1.6*r,this.customBlocks.forEach(function(t){var e=t.templateInstance();n+=.3*r,e.setPosition(new Point(i,n)),o.addContents(e),i=0,n+=e.height()})),o.scrollX(o.padding),o.scrollY(o.padding),Morph.prototype.trackChanges=p,o},SpriteMorph.prototype._initBlocks=SpriteMorph.prototype.initBlocks,SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype._initBlocks(),SpriteMorph.prototype.blocks.getJSFromRPC={type:"reporter",category:"services",spec:"call %s with %s",defaults:["tictactoe"]},SpriteMorph.prototype.blocks.getJSFromRPCDropdown={type:"reporter",category:"services",spec:"call %rpcNames / %rpcActions with %s",defaults:["tictactoe"]},SpriteMorph.prototype.blocks.getCostumeFromRPC={type:"reporter",category:"services",spec:"costume from %rpcNames / %rpcActions with %s",defaults:["staticmap","getMap"]},SpriteMorph.prototype.blocks.doSocketMessage={type:"command",category:"services",spec:"send msg %msgInput to %roles"},SpriteMorph.prototype.blocks.receiveSocketMessage={type:"hat",category:"services",spec:"when I receive %msgOutput"},SpriteMorph.prototype.blocks.getProjectId={type:"reporter",category:"services",spec:"role name"},SpriteMorph.prototype.blocks.getProjectIds={type:"reporter",category:"services",spec:"all role names"},SpriteMorph.prototype.blocks.reportLatitude={type:"reporter",category:"sensing",spec:"my latitude"},SpriteMorph.prototype.blocks.reportLongitude={type:"reporter",category:"sensing",spec:"my longitude"},SpriteMorph.prototype.blocks.reportStageWidth={type:"reporter",category:"sensing",spec:"stage width"},SpriteMorph.prototype.blocks.reportStageHeight={type:"reporter",category:"sensing",spec:"stage height"},SpriteMorph.prototype.blocks.reportUsername={type:"reporter",category:"sensing",spec:"username"}},SpriteMorph.prototype.initBlocks(),SpriteMorph.prototype.getProjectId=function(){var t=this.parentThatIsA(IDE_Morph);return t.projectName},SpriteMorph.prototype.getProjectIds=function(){var t=this.parentThatIsA(IDE_Morph),e=Object.keys(t.room.roles);return new List(e)},StageMorph.prototype.getProjectId=SpriteMorph.prototype.getProjectId,StageMorph.prototype.getProjectIds=SpriteMorph.prototype.getProjectIds,SpriteMorph.prototype.reportUsername=function(){return SnapCloud.username||""},StageMorph.prototype.reportUsername=SpriteMorph.prototype.reportUsername,SpriteMorph.prototype._blockForSelector=SpriteMorph.prototype.blockForSelector,SpriteMorph.prototype.blockForSelector=function(t,e){var o=this._blockForSelector(t,e);return"receiveSocketMessage"===t&&(o.blockSequence=CommandBlockMorph.prototype.blockSequence),o},SpriteMorph.prototype.blockTemplates=function(t){function e(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function o(t){var e=SpriteMorph.prototype.variableBlock(t);return e.isDraggable=!1,e.isTemplate=!0,contains(g,t)&&e.ghost(),e}function r(t){if(StageMorph.prototype.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){d.toggleWatcher(t,localize(e.spec),d.blockColor[e.category])},null,function(){return d.showingWatcher(t)},null)}function i(t){return new ToggleMorph("checkbox",this,function(){d.toggleVariableWatcher(t)},null,function(){return d.showingVariableWatcher(t)},null)}function n(){var t=new MenuMorph(this);return t.addItem("help...","showHelp"),t}function s(t){var e;t&&(d.isVariableNameInUse(t[0],t[1])?d.inform("that name is already in use"):(e=d.parentThatIsA(IDE_Morph),d.addVariable(t[0],t[1]),d.showingVariableWatcher(t[0])||d.toggleVariableWatcher(t[0],t[1]),e.flushBlocksCache("variables"),e.refreshPalette()))}function a(t){var e,o=d.parentThatIsA(StageMorph);t.fields=t.fields.filter(function(t){return!!t}),o.messageTypes.getMsgType(t.name)?d.inform("that name is already in use"):(o.addMessageType(t),e=d.parentThatIsA(IDE_Morph),e.flushBlocksCache(u),e.refreshPalette())}var h,l,p,c=[],d=this,u=t||"motion",g=this.inheritedVariableNames();return"motion"===u?(c.push(e("forward")),c.push(e("turn")),c.push(e("turnLeft")),c.push("-"),c.push(e("setHeading")),c.push(e("doFaceTowards")),c.push("-"),c.push(e("gotoXY")),c.push(e("doGotoObject")),c.push(e("doGlide")),c.push("-"),c.push(e("changeXPosition")),c.push(e("setXPosition")),c.push(e("changeYPosition")),c.push(e("setYPosition")),c.push("-"),c.push(e("bounceOffEdge")),c.push("-"),c.push(r("xPosition")),c.push(e("xPosition")),c.push(r("yPosition")),c.push(e("yPosition")),c.push(r("direction")),c.push(e("direction"))):"looks"===u?(c.push(e("doSwitchToCostume")),c.push(e("doWearNextCostume")),c.push(r("getCostumeIdx")),c.push(e("getCostumeIdx")),c.push("-"),c.push(e("doSayFor")),c.push(e("bubble")),c.push(e("doThinkFor")),c.push(e("doThink")),c.push("-"),c.push(e("changeEffect")),c.push(e("setEffect")),c.push(e("clearEffects")),c.push("-"),c.push(e("changeScale")),c.push(e("setScale")),c.push(r("getScale")),c.push(e("getScale")),c.push("-"),c.push(e("show")),c.push(e("hide")),c.push("-"),c.push(e("comeToFront")),c.push(e("goBack")),this.world().isDevMode&&(c.push("-"),p=new TextMorph(localize("development mode \ndebugging primitives:")),p.fontSize=9,p.setColor(this.paletteTextColor),c.push(p),c.push("-"),c.push(e("reportCostumes")),c.push("-"),c.push(e("log")),c.push(e("alert")),c.push("-"),c.push(e("doScreenshot")))):"sound"===u?(c.push(e("playSound")),c.push(e("doPlaySoundUntilDone")),c.push(e("doStopAllSounds")),c.push("-"),c.push(e("doRest")),c.push("-"),c.push(e("doPlayNote")),c.push("-"),c.push(e("doChangeTempo")),c.push(e("doSetTempo")),c.push(r("getTempo")),c.push(e("getTempo")),this.world().isDevMode&&(c.push("-"),p=new TextMorph(localize("development mode \ndebugging primitives:")),p.fontSize=9,p.setColor(this.paletteTextColor),c.push(p),c.push("-"),c.push(e("reportSounds")))):"pen"===u?(c.push(e("clear")),c.push("-"),c.push(e("down")),c.push(e("up")),c.push("-"),c.push(e("setColor")),c.push(e("changeHue")),c.push(e("setHue")),c.push("-"),c.push(e("changeBrightness")),c.push(e("setBrightness")),c.push("-"),c.push(e("changeSize")),c.push(e("setSize")),c.push("-"),c.push(e("doStamp"))):"control"===u?(c.push(e("receiveGo")),c.push(e("receiveKey")),c.push(e("receiveInteraction")),c.push(e("receiveMessage")),c.push("-"),c.push(e("doBroadcast")),c.push(e("doBroadcastAndWait")),c.push(r("getLastMessage")),c.push(e("getLastMessage")),c.push("-"),c.push(e("doWarp")),c.push("-"),c.push(e("doWait")),c.push(e("doWaitUntil")),c.push("-"),c.push(e("doForever")),c.push(e("doRepeat")),c.push(e("doUntil")),c.push("-"),c.push(e("doIf")),c.push(e("doIfElse")),c.push("-"),c.push(e("doReport")),c.push("-"),c.push(e("doStopThis")),c.push(e("doStopOthers")),c.push("-"),c.push(e("doRun")),c.push(e("fork")),c.push(e("evaluate")),c.push("-"),c.push(e("doCallCC")),c.push(e("reportCallCC")),c.push("-"),c.push(e("receiveOnClone")),c.push(e("createClone")),c.push(e("removeClone")),c.push("-"),c.push(e("doPauseAll"))):"services"===u?(c.push(e("receiveSocketMessage")),c.push(e("doSocketMessage")),c.push("-"),c.push(e("getProjectId")),c.push(e("getProjectIds")),c.push("-"),this.world().isDevMode&&(c.push(e("getJSFromRPCDropdown")),c.push(e("getCostumeFromRPC")),c.push("-")),c.push("-"),l=new PushButtonMorph(null,function(){new MessageCreatorMorph(d,a).popUp()},"Make a message type"),c.push(l),this.deletableMessageNames().length>0&&(l=new PushButtonMorph(null,function(){var t=new MenuMorph(d.deleteMessageType,null,d);d.deletableMessageNames().forEach(function(e){t.addItem(e,e)}),t.popUpAtHand(d.world())},"Delete a message type"),l.userMenu=n,l.selector="deleteMessageType",l.showHelp=BlockMorph.prototype.showHelp,c.push(l))):"sensing"===u?(c.push(e("reportTouchingObject")),c.push(e("reportTouchingColor")),c.push(e("reportColorIsTouchingColor")),c.push("-"),c.push(e("doAsk")),c.push(r("getLastAnswer")),c.push(e("getLastAnswer")),c.push("-"),c.push(r("reportMouseX")),c.push(e("reportMouseX")),c.push(r("reportMouseY")),c.push(e("reportMouseY")),c.push(e("reportMouseDown")),c.push("-"),c.push(e("reportKeyPressed")),c.push("-"),c.push(e("reportDistanceTo")),c.push("-"),c.push(e("doResetTimer")),c.push(r("getTimer")),c.push(e("getTimer")),c.push("-"),c.push(e("reportAttributeOf")),c.push("-"),c.push(e("reportURL")),c.push("-"),c.push(e("reportIsFastTracking")),c.push(e("doSetFastTracking")),c.push("-"),c.push(e("reportDate")),c.push(e("reportUsername")),c.push("-"),c.push(e("reportLatitude")),c.push(e("reportLongitude")),c.push("-"),c.push(e("reportStageHeight")),c.push(e("reportStageWidth")),this.world().isDevMode&&(c.push("-"),p=new TextMorph(localize("development mode \ndebugging primitives:")),p.fontSize=9,p.setColor(this.paletteTextColor),c.push(p),c.push("-"),c.push(r("reportThreadCount")),c.push(e("reportThreadCount")),c.push(e("colorFiltered")),c.push(e("reportStackSize")),c.push(e("reportFrameCount")))):"operators"===u?(c.push(e("reifyScript")),c.push(e("reifyReporter")),c.push(e("reifyPredicate")),c.push("#"),c.push("-"),c.push(e("reportSum")),c.push(e("reportDifference")),c.push(e("reportProduct")),c.push(e("reportQuotient")),c.push("-"),c.push(e("reportModulus")),c.push(e("reportRound")),c.push(e("reportMonadic")),c.push(e("reportRandom")),c.push("-"),c.push(e("reportLessThan")),c.push(e("reportEquals")),c.push(e("reportGreaterThan")),c.push("-"),c.push(e("reportAnd")),c.push(e("reportOr")),c.push(e("reportNot")),c.push("-"),c.push(e("reportTrue")),c.push(e("reportFalse")),c.push("-"),c.push(e("reportJoinWords")),c.push(e("reportTextSplit")),c.push(e("reportLetter")),c.push(e("reportStringSize")),c.push("-"),c.push(e("reportUnicode")),c.push(e("reportUnicodeAsLetter")),c.push("-"),c.push(e("reportIsA")),c.push(e("reportIsIdentical")),c.push("-"),c.push(e("reportJSFunction")),this.world().isDevMode&&(c.push("-"),p=new TextMorph("development mode \ndebugging primitives:"),p.fontSize=9,p.setColor(this.paletteTextColor),c.push(p),c.push("-"),c.push(e("reportTypeOf")),c.push(e("reportTextFunction")))):"variables"===u?(l=new PushButtonMorph(null,function(){new VariableDialogMorph(null,s,d).prompt("Variable name",null,d.world())},"Make a variable"),l.userMenu=n,l.selector="addVariable",l.showHelp=BlockMorph.prototype.showHelp,c.push(l),this.deletableVariableNames().length>0&&(l=new PushButtonMorph(null,function(){var t=new MenuMorph(d.deleteVariable,null,d);d.deletableVariableNames().forEach(function(e){t.addItem(e,e)}),t.popUpAtHand(d.world())},"Delete a variable"),l.userMenu=n,l.selector="deleteVariable",l.showHelp=BlockMorph.prototype.showHelp,c.push(l)),c.push("-"),h=this.variables.allNames(),h.length>0&&(h.forEach(function(t){c.push(i(t)),c.push(o(t))}),c.push("-")),c.push(e("doSetVar")),c.push(e("doChangeVar")),c.push(e("doShowVar")),c.push(e("doHideVar")),c.push(e("doDeclareVariables")),StageMorph.prototype.enableInheritance&&(c.push("-"),c.push(e("doDeleteAttr"))),c.push("="),c.push(e("reportNewList")),c.push("-"),c.push(e("reportCONS")),c.push(e("reportListItem")),c.push(e("reportCDR")),c.push("-"),c.push(e("reportListLength")),c.push(e("reportListContainsItem")),c.push("-"),c.push(e("doAddToList")),c.push(e("doDeleteFromList")),c.push(e("doInsertInList")),c.push(e("doReplaceInList")),this.world().isDevMode&&(c.push("-"),p=new TextMorph(localize("development mode \ndebugging primitives:")),p.fontSize=9,p.setColor(this.paletteTextColor),c.push(p),c.push("-"),c.push(e("reportMap")),c.push("-"),c.push(e("doForEach"))),c.push("="),StageMorph.prototype.enableCodeMapping&&(c.push(e("doMapCodeOrHeader")),c.push(e("doMapStringCode")),c.push(e("doMapListCode")),c.push("-"),c.push(e("reportMappedCode")),c.push("="))):"custom"===u&&(l=new PushButtonMorph(null,function(){var t=d.parentThatIsA(IDE_Morph),e=d.parentThatIsA(StageMorph);new BlockDialogMorph(null,function(o){""!==o.spec&&(o.isGlobal?e.globalBlocks.push(o):d.customBlocks.push(o),t.flushPaletteCache(),t.refreshPalette(),new BlockEditorMorph(o,d).popUp())},d).prompt("Make a block",null,d.world())},"Make a block"),l.userMenu=n,l.selector="addCustomBlock",l.showHelp=BlockMorph.prototype.showHelp,c.push(l)),c},SpriteMorph.prototype.deletableMessageNames=function(){var t=this.parentThatIsA(StageMorph);return t.deletableMessageNames()},StageMorph.prototype.deletableMessageNames=function(){return this.messageTypes.names().filter(function(t){return"message"!==t})},SpriteMorph.prototype.deleteMessageType=function(t){var e=this.parentThatIsA(IDE_Morph),o=e.stage,r="services";o.messageTypes.deleteMsgType(t);try{e.room.parentThatIsA(ProjectsMorph).updateRoom(),e&&"room"===e.currentTab&&e.spriteBar.tabBar.tabTo("room")}catch(t){}e.flushBlocksCache(r),e.refreshPalette()},StageMorph.prototype.deleteMessageType=SpriteMorph.prototype.deleteMessageType,StageMorph.prototype.freshPalette=SpriteMorph.prototype.freshPalette,StageMorph.prototype._init=StageMorph.prototype.init,StageMorph.prototype.init=function(t){this.messageTypes=new MessageFrame,this.addMessageType({name:"message",fields:["msg"]}),this._init(t)},StageMorph.prototype.addMessageTypeByName=function(t){var e,o="api/MessageTypes/"+t,r=new XMLHttpRequest;try{if(r.open("GET",o,!1),r.send(),200===!r.status)throw new Error("unable to retrieve "+o)}catch(e){return void console.error('could not retrieve message "'+t+'": '+e)}e=JSON.parse(r.responseText),this.addMessageType(e)},StageMorph.prototype.addMessageType=function(t){var e,o,r;o=t.name,r=t.fields,e=new MessageType(o,r),this.messageTypes.addMsgType(e);try{var i=this.parentThatIsA(NetsBloxMorph);i.room.parentThatIsA(ProjectsMorph).updateRoom(),i&&"room"===i.currentTab&&i.spriteBar.tabBar.tabTo("room")}catch(t){}},StageMorph.prototype.processKeyEvent=function(t,e){var o;switch(t.keyCode){case 13:o="enter",t.ctrlKey||t.metaKey?o="ctrl enter":t.shiftKey&&(o="shift enter");break;case 187:o="+";break;case 189:o="-";break;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=String.fromCharCode(t.keyCode||t.charCode),(t.ctrlKey||t.metaKey)&&(o="ctrl "+(t.shiftKey?"shift ":"")+o)}e.call(this,o)},StageMorph.prototype.blockTemplates=function(t){function e(t){if(c.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function o(t){var e=SpriteMorph.prototype.variableBlock(t);return e.isDraggable=!1,e.isTemplate=!0,e}function r(t){if(c.hiddenPrimitives[t])return null;var e=SpriteMorph.prototype.blocks[t];return new ToggleMorph("checkbox",this,function(){c.toggleWatcher(t,localize(e.spec),c.blockColor[e.category])},null,function(){return c.showingWatcher(t)},null)}function i(t){return new ToggleMorph("checkbox",this,function(){c.toggleVariableWatcher(t)},null,function(){return c.showingVariableWatcher(t)},null)}function n(t){t&&(c.isVariableNameInUse(t[0])?c.inform("that name is already in use"):(c.addVariable(t[0],t[1]),c.toggleVariableWatcher(t[0],t[1]),c.blocksCache[d]=null,c.paletteCache[d]=null,c.parentThatIsA(IDE_Morph).refreshPalette()))}function s(t){var e,o=c.parentThatIsA(StageMorph);t.fields=t.fields.filter(function(t){return!!t}),o.messageTypes.getMsgType(t.name)?c.inform("that name is already in use"):(o.addMessageType(t),e=c.parentThatIsA(IDE_Morph),e.flushBlocksCache(d),e.refreshPalette())}var a,h,l,p=[],c=this,d=t||"motion";return"motion"===d?(l=new TextMorph(localize("Stage selected:\nno motion primitives")),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l)):"looks"===d?(p.push(e("doSwitchToCostume")),p.push(e("doWearNextCostume")),p.push(r("getCostumeIdx")),p.push(e("getCostumeIdx")),p.push("-"),p.push(e("changeEffect")),p.push(e("setEffect")),p.push(e("clearEffects")),p.push("-"),p.push(e("show")),p.push(e("hide")),this.world().isDevMode&&(p.push("-"),l=new TextMorph(localize("development mode \ndebugging primitives:")),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("reportCostumes")),p.push("-"),p.push(e("log")),p.push(e("alert")),p.push("-"),p.push(e("doScreenshot")))):"sound"===d?(p.push(e("playSound")),p.push(e("doPlaySoundUntilDone")),p.push(e("doStopAllSounds")),p.push("-"),p.push(e("doRest")),p.push("-"),p.push(e("doPlayNote")),p.push("-"),p.push(e("doChangeTempo")),p.push(e("doSetTempo")),p.push(r("getTempo")),p.push(e("getTempo")),this.world().isDevMode&&(p.push("-"),l=new TextMorph(localize("development mode \ndebugging primitives:")),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("reportSounds")))):"pen"===d?p.push(e("clear")):"services"===d?(p.push(e("receiveSocketMessage")),p.push(e("doSocketMessage")),p.push("-"),p.push(e("getProjectId")),p.push(e("getProjectIds")),p.push("-"),this.world().isDevMode&&(p.push(e("getJSFromRPCDropdown")),p.push(e("getCostumeFromRPC")),p.push("-")),h=new PushButtonMorph(null,function(){new MessageCreatorMorph(c,s).popUp()},"Make a message type"),p.push(h),this.deletableMessageNames().length>0&&(h=new PushButtonMorph(null,function(){var t=new MenuMorph(c.deleteMessageType,null,c);c.deletableMessageNames().forEach(function(e){t.addItem(e,e)}),t.popUpAtHand(c.world())},"Delete a message type"),h.selector="deleteMessageType",h.showHelp=BlockMorph.prototype.showHelp,p.push(h))):"control"===d?(p.push(e("receiveGo")),p.push(e("receiveKey")),p.push(e("receiveInteraction")),p.push(e("receiveMessage")),p.push("-"),p.push(e("doBroadcast")),p.push(e("doBroadcastAndWait")),p.push(r("getLastMessage")),p.push(e("getLastMessage")),p.push("-"),p.push(e("doWarp")),p.push("-"),p.push(e("doWait")),p.push(e("doWaitUntil")),p.push("-"),p.push(e("doForever")),p.push(e("doRepeat")),p.push(e("doUntil")),p.push("-"),p.push(e("doIf")),p.push(e("doIfElse")),p.push("-"),p.push(e("doReport")),p.push("-"),p.push(e("doStopThis")),p.push(e("doStopOthers")),p.push("-"),p.push(e("doRun")),p.push(e("fork")),p.push(e("evaluate")),p.push("-"),p.push(e("doCallCC")),p.push(e("reportCallCC")),p.push("-"),p.push(e("createClone")),p.push("-"),p.push(e("doPauseAll"))):"sensing"===d?(p.push(e("doAsk")),p.push(r("getLastAnswer")),p.push(e("getLastAnswer")),p.push("-"),p.push(r("reportMouseX")),p.push(e("reportMouseX")),p.push(r("reportMouseY")),p.push(e("reportMouseY")),p.push(e("reportMouseDown")),p.push("-"),p.push(e("reportKeyPressed")),p.push("-"),p.push(e("doResetTimer")),p.push(r("getTimer")),p.push(e("getTimer")),p.push("-"),p.push(e("reportAttributeOf")),p.push("-"),p.push(e("reportURL")),p.push("-"),p.push(e("reportIsFastTracking")),p.push(e("doSetFastTracking")),p.push("-"),p.push(e("reportDate")),p.push(e("reportUsername")),p.push("-"),p.push(e("reportLatitude")),p.push(e("reportLongitude")),p.push("-"),p.push(e("reportStageHeight")),p.push(e("reportStageWidth")),this.world().isDevMode&&(p.push("-"),l=new TextMorph(localize("development mode \ndebugging primitives:")),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(r("reportThreadCount")),p.push(e("reportThreadCount")),p.push(e("colorFiltered")),p.push(e("reportStackSize")),p.push(e("reportFrameCount")))):"operators"===d?(p.push(e("reifyScript")),p.push(e("reifyReporter")),p.push(e("reifyPredicate")),p.push("#"),p.push("-"),p.push(e("reportSum")),p.push(e("reportDifference")),p.push(e("reportProduct")),p.push(e("reportQuotient")),p.push("-"),p.push(e("reportModulus")),p.push(e("reportRound")),p.push(e("reportMonadic")),p.push(e("reportRandom")),p.push("-"),p.push(e("reportLessThan")),p.push(e("reportEquals")),p.push(e("reportGreaterThan")),p.push("-"),p.push(e("reportAnd")),p.push(e("reportOr")),p.push(e("reportNot")),p.push("-"),p.push(e("reportTrue")),p.push(e("reportFalse")),p.push("-"),p.push(e("reportJoinWords")),p.push(e("reportTextSplit")),p.push(e("reportLetter")),p.push(e("reportStringSize")),p.push("-"),p.push(e("reportUnicode")),p.push(e("reportUnicodeAsLetter")),p.push("-"),p.push(e("reportIsA")),p.push(e("reportIsIdentical")),p.push("-"),p.push(e("reportJSFunction")),this.world().isDevMode&&(p.push("-"),l=new TextMorph("development mode \ndebugging primitives:"),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("reportTypeOf")),p.push(e("reportTextFunction")))):"variables"===d?(h=new PushButtonMorph(null,function(){new VariableDialogMorph(null,n,c).prompt("Variable name",null,c.world())},"Make a variable"),p.push(h),this.variables.allNames().length>0&&(h=new PushButtonMorph(null,function(){var t=new MenuMorph(c.deleteVariable,null,c);c.variables.allNames().forEach(function(e){t.addItem(e,e)}),t.popUpAtHand(c.world())},"Delete a variable"),p.push(h)),p.push("-"),a=this.variables.allNames(),a.length>0&&(a.forEach(function(t){p.push(i(t)),p.push(o(t))}),p.push("-")),p.push(e("doSetVar")),p.push(e("doChangeVar")),p.push(e("doShowVar")),p.push(e("doHideVar")),p.push(e("doDeclareVariables")),p.push("="),p.push(e("reportNewList")),p.push("-"),p.push(e("reportCONS")),p.push(e("reportListItem")),p.push(e("reportCDR")),p.push("-"),p.push(e("reportListLength")),p.push(e("reportListContainsItem")),p.push("-"),p.push(e("doAddToList")),p.push(e("doDeleteFromList")),p.push(e("doInsertInList")),p.push(e("doReplaceInList")),this.world().isDevMode&&(p.push("-"),l=new TextMorph(localize("development mode \ndebugging primitives:")),l.fontSize=9,l.setColor(this.paletteTextColor),p.push(l),p.push("-"),p.push(e("reportMap")),p.push("-"),p.push(e("doForEach"))),p.push("="),StageMorph.prototype.enableCodeMapping&&(p.push(e("doMapCodeOrHeader")),p.push(e("doMapStringCode")),p.push(e("doMapListCode")),p.push("-"),p.push(e("reportMappedCode")),p.push("="))):"custom"===d&&(h=new PushButtonMorph(null,function(){var t=c.parentThatIsA(IDE_Morph);new BlockDialogMorph(null,function(e){""!==e.spec&&(e.isGlobal?c.globalBlocks.push(e):c.customBlocks.push(e),t.flushPaletteCache(),t.refreshPalette(),new BlockEditorMorph(e,c).popUp())},c).prompt("Make a block",null,c.world())},"Make a block"),p.push(h)),p},BlockMorph.prototype.setSpec=function(t,e){var o,r=this,i=-1;t&&(this.parts().forEach(function(t){t.destroy()}),this.isPrototype&&this.add(this.placeHolder()),this.parseSpec(t).forEach(function(t){"%"===t[0]&&(i+=1),o=r.labelPart(t),r.add(o),o instanceof CommandSlotMorph||o instanceof StringMorph||o.drawNew(),o instanceof RingMorph&&o.fixBlockColor(),(o instanceof MultiArgMorph||o.constructor===CommandSlotMorph||o.constructor===RingCommandSlotMorph)&&o.fixLayout(),r.isPrototype&&r.add(r.placeHolder()),o instanceof InputSlotMorph&&!o.choices&&r.definition&&o.setChoices.apply(o,r.definition.inputOptionsOfIdx(i))}),this.blockSpec=t,this.fixLayout(e),this.cachedInputs=null)},InputSlotMorph.prototype.messageTypesMenu=function(){for(var t=this.parentThatIsA(BlockMorph).receiver(),e=t.parentThatIsA(StageMorph),o=e.messageTypes.names(),r={},i=o.length;i--;)r[o[i]]=o[i];return r},MultiArgMorph.prototype.addHintInput=function(t){var e=this.labelPart("%hint"+t),o=this.children.length-1;e.parent=this,this.children.splice(o,0,e),e.drawNew(),this.fixLayout()},SyntaxElementMorph.prototype.labelPart=function(t){var e,o;if("%"===t[0]&&t.length>1&&("reportGetVar"!==this.selector||"%turtleOutline"===t&&this.isObjInputFragment())){if(t.length>5&&"%mult"===t.slice(0,5))return e=new MultiArgMorph(t.slice(5)),e.addInput(),e;if(t.length>5&&"%hint"===t.slice(0,5))return e=new HintInputSlotMorph("",t.slice(5));if(t.length>6&&"%mhint"===t.slice(0,6))return o=t.slice(6).split("%"),e=new MultiArgMorph("%s",null,0),o.forEach(function(t){e.addHintInput(t)}),e.isStatic=!0,e.canBeEmpty=!1,e;switch(t){case"%imgsource":e=new InputSlotMorph(null,!1,{"pen trails":["pen trails"],"stage image":["stage image"]},!0),e.setContents(["pen trails"]);break;case"%inputs":e=new MultiArgMorph("%s","with inputs"),e.isStatic=!1,e.canBeEmpty=!1;break;case"%scriptVars":e=new MultiArgMorph("%t",null,1,t),e.canBeEmpty=!1;break;case"%parms":e=new MultiArgMorph("%t","Input Names:",0,t),e.canBeEmpty=!1;break;
case"%ringparms":e=new MultiArgMorph("%t","input names:",0,t);break;case"%cmdRing":e=new RingMorph,e.color=SpriteMorph.prototype.blockColor.other,e.selector="reifyScript",e.setSpec("%rc %ringparms"),e.isDraggable=!0;break;case"%repRing":e=new RingMorph,e.color=SpriteMorph.prototype.blockColor.other,e.selector="reifyReporter",e.setSpec("%rr %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%predRing":e=new RingMorph(!0),e.color=SpriteMorph.prototype.blockColor.other,e.selector="reifyPredicate",e.setSpec("%rp %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%words":e=new MultiArgMorph("%s",null,0),e.addInput(),e.addInput(),e.isStatic=!1;break;case"%exp":e=new MultiArgMorph("%s",null,0),e.addInput(),e.isStatic=!0,e.canBeEmpty=!1;break;case"%br":e=new Morph,e.setExtent(new Point(0,0)),e.isBlockLabelBreak=!0,e.getSpec=function(){return"%br"};break;case"%inputName":e=new ReporterBlockMorph,e.category="variables",e.color=SpriteMorph.prototype.blockColor.variables,e.setSpec(localize("Input name"));break;case"%s":e=new InputSlotMorph;break;case"%anyUE":e=new InputSlotMorph,e.isUnevaluated=!0;break;case"%txt":e=new InputSlotMorph,e.minWidth=1.7*e.height(),e.fixLayout();break;case"%mlt":e=new TextSlotMorph,e.fixLayout();break;case"%code":e=new TextSlotMorph,e.contents().fontName="monospace",e.contents().fontStyle="monospace",e.fixLayout();break;case"%obj":e=new ArgMorph("object");break;case"%n":e=new InputSlotMorph(null,!0);break;case"%dir":e=new InputSlotMorph(null,!0,{"(90) right":90,"(-90) left":-90,"(0) up":"0","(180) down":180}),e.setContents(90);break;case"%inst":e=new InputSlotMorph(null,!0,{"(1) Acoustic Grand":1,"(2) Bright Acoustic":2,"(3) Electric Grand":3,"(4) Honky Tonk":4,"(5) Electric Piano 1":5,"(6) Electric Piano 2":6,"(7) Harpsichord":7}),e.setContents(1);break;case"%month":e=new InputSlotMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);break;case"%interaction":e=new InputSlotMorph(null,!1,{clicked:["clicked"],pressed:["pressed"],dropped:["dropped"],"mouse-entered":["mouse-entered"],"mouse-departed":["mouse-departed"]},!0);break;case"%dates":e=new InputSlotMorph(null,!1,{year:["year"],month:["month"],date:["date"],"day of week":["day of week"],hour:["hour"],minute:["minute"],second:["second"],"time in milliseconds":["time in milliseconds"]},!0),e.setContents(["date"]);break;case"%delim":e=new InputSlotMorph(null,!1,{letter:["letter"],whitespace:["whitespace"],line:["line"],tab:["tab"],cr:["cr"]},!1);break;case"%ida":e=new InputSlotMorph(null,!0,{1:1,last:["last"],"~":null,all:["all"]}),e.setContents(1);break;case"%idx":e=new InputSlotMorph(null,!0,{1:1,last:["last"],any:["any"]}),e.setContents(1);break;case"%spr":e=new InputSlotMorph(null,!1,"objectsMenu",!0);break;case"%col":e=new InputSlotMorph(null,!1,"collidablesMenu",!0);break;case"%dst":e=new InputSlotMorph(null,!1,"distancesMenu",!0);break;case"%cln":e=new InputSlotMorph(null,!1,"clonablesMenu",!0);break;case"%cst":e=new InputSlotMorph(null,!1,"costumesMenu",!0);break;case"%eff":e=new InputSlotMorph(null,!1,{brightness:["brightness"],ghost:["ghost"],negative:["negative"],comic:["comic"],duplicate:["duplicate"],confetti:["confetti"]},!0),e.setContents(["ghost"]);break;case"%snd":e=new InputSlotMorph(null,!1,"soundsMenu",!0);break;case"%key":e=new InputSlotMorph(null,!1,{"up arrow":["up arrow"],"down arrow":["down arrow"],"right arrow":["right arrow"],"left arrow":["left arrow"],space:["space"],"+":["+"],"-":["-"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"]},!0),e.setContents(["space"]);break;case"%keyHat":e=this.labelPart("%key"),e.isStatic=!0;break;case"%msgType":e=new InputSlotMorph(null,!1,"messageTypes",!0);break;case"%msgOutput":e=new MessageOutputSlotMorph;break;case"%msgInput":e=new MessageInputSlotMorph;break;case"%roles":e=new InputSlotMorph(null,!1,"roleNames",!0);break;case"%rpcNames":e=new InputSlotMorph(null,!1,"rpcNames",!0);break;case"%rpcActions":e=new InputSlotMorph(null,!1,"rpcActions",!0);break;case"%msg":e=new InputSlotMorph(null,!1,"messagesMenu",!0);break;case"%msgHat":e=new InputSlotMorph(null,!1,"messagesReceivedMenu",!0),e.isStatic=!0;break;case"%att":e=new InputSlotMorph(null,!1,"attributesMenu",!0);break;case"%fun":e=new InputSlotMorph(null,!1,{abs:["abs"],ceiling:["ceiling"],floor:["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],log:["log"],"e^":["e^"],"10^":["10^"]},!0),e.setContents(["sqrt"]);break;case"%txtfun":e=new InputSlotMorph(null,!1,{"encode URI":["encode URI"],"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],"hex sha512 hash":["hex sha512 hash"]},!0),e.setContents(["encode URI"]);break;case"%stopChoices":e=new InputSlotMorph(null,!1,{all:["all"],"this script":["this script"],"this block":["this block"]},!0),e.setContents(["all"]),e.isStatic=!0;break;case"%stopOthersChoices":e=new InputSlotMorph(null,!1,{"all but this script":["all but this script"],"other scripts in sprite":["other scripts in sprite"]},!0),e.setContents(["all but this script"]),e.isStatic=!0;break;case"%typ":e=new InputSlotMorph(null,!1,{number:["number"],text:["text"],Boolean:["Boolean"],list:["list"],command:["command"],reporter:["reporter"],predicate:["predicate"]},!0),e.setContents(["number"]);break;case"%var":e=new InputSlotMorph(null,!1,"getVarNamesDict",!0),e.isStatic=!0;break;case"%shd":e=new InputSlotMorph(null,!1,"shadowedVariablesMenu",!0),e.isStatic=!0;break;case"%lst":e=new InputSlotMorph(null,!1,{list1:"list1",list2:"list2",list3:"list3"},!0);break;case"%codeKind":e=new InputSlotMorph(null,!1,{code:["code"],header:["header"]},!0),e.setContents(["code"]);break;case"%l":e=new ArgMorph("list");break;case"%b":case"%boolUE":e=new BooleanSlotMorph(null,!0);break;case"%cmd":e=new CommandSlotMorph;break;case"%rc":e=new RingCommandSlotMorph,e.isStatic=!0;break;case"%rr":e=new RingReporterSlotMorph,e.isStatic=!0;break;case"%rp":e=new RingReporterSlotMorph(!0),e.isStatic=!0;break;case"%c":e=new CSlotMorph,e.isStatic=!0;break;case"%cs":e=new CSlotMorph;break;case"%clr":e=new ColorSlotMorph,e.isStatic=!0;break;case"%t":e=new TemplateSlotMorph("a");break;case"%message":e=new TemplateSlotMorph("message");break;case"%upvar":e=new TemplateSlotMorph("");break;case"%f":e=new FunctionSlotMorph;break;case"%r":e=new ReporterSlotMorph;break;case"%p":e=new ReporterSlotMorph(!0);break;case"%codeListPart":e=new InputSlotMorph(null,!1,{list:["list"],item:["item"],delimiter:["delimiter"]},!0);break;case"%codeListKind":e=new InputSlotMorph(null,!1,{collection:["collection"],variables:["variables"],parameters:["parameters"]},!0);break;case"%turtle":e=new SymbolMorph("turtle"),e.size=1.2*this.fontSize,e.color=new Color(255,255,255),e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%turtleOutline":e=new SymbolMorph("turtleOutline"),e.size=this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%clockwise":e=new SymbolMorph("turnRight"),e.size=1.5*this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%counterclockwise":e=new SymbolMorph("turnLeft"),e.size=1.5*this.fontSize,e.color=new Color(255,255,255),e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%greenflag":e=new SymbolMorph("flag"),e.size=1.5*this.fontSize,e.color=new Color(0,200,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%stop":e=new SymbolMorph("octagon"),e.size=1.5*this.fontSize,e.color=new Color(200,0,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;case"%pause":e=new SymbolMorph("pause"),e.size=this.fontSize,e.color=new Color(255,220,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew();break;default:nop()}}else if("$"===t[0]&&t.length>1&&"reportGetVar"!==this.selector){if(o=t.slice(1).split("-"),!contains(SymbolMorph.prototype.names,o[0]))return e=new StringMorph(t),e.fontName=this.labelFontName,e.fontStyle=this.labelFontStyle,e.fontSize=this.fontSize,e.color=new Color(255,255,255),e.isBold=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew(),e;e=new SymbolMorph(o[0]),e.size=this.fontSize*(+o[1]||1.2),e.color=new Color(0===+o[2]?0:+o[2]||255,0===+o[3]?0:+o[3]||255,0===+o[4]?0:+o[4]||255),e.isProtectedLabel=o.length>2,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing,e.drawNew()}else e=new StringMorph(t,this.fontSize,this.labelFontStyle,!0,!1,!1,MorphicPreferences.isFlat?new Point:this.embossing,this.color.darker(this.labelContrast),new Color(255,255,255),this.labelFontName);return e},InputSlotMorph.prototype.messageTypes=function(){var t=this.parentThatIsA(IDE_Morph).stage,e=t.messageTypes.names();dict={};for(var o=e.length;o--;)dict[e[o]]=e[o];return dict},InputSlotMorph.prototype.roleNames=function(){for(var t=this.root().children[0],e=Object.keys(t.room.roles),o={},r=e.length;r--;)t.projectName!==e[r]&&(o[e[r]]=e[r]);return o["others in room"]="others in room",o["everyone in room"]="everyone in room",o},InputSlotMorph.prototype.getURL=function(t){try{var e=new XMLHttpRequest;if(e.open("GET",t,!1),e.send(),200===e.status)return e.responseText;throw new Error("unable to retrieve "+t)}catch(t){return""}},InputSlotMorph.prototype.rpcNames=function(){for(var t,e=JSON.parse(this.getURL("/rpc")),o={},r=e.length;r--;)t=e[r].replace("/",""),o[t]=t;return o},InputSlotMorph.prototype.rpcActions=function(){var t,e,o,r,i=this.parent.inputs(),n={};if(r=i.indexOf(this),t=i[r-1])for(o=t.evaluate(),e=JSON.parse(this.getURL("/rpc/"+o)),r=e.length;r--;)n[e[r]]=e[r];return n},SymbolMorph.prototype.symbolCanvasColored=function(t){if(this.name instanceof Costume)return this.name.thumbnail(new Point(this.symbolWidth(),this.size));var e=newCanvas(new Point(this.symbolWidth(),this.size));switch(this.name){case"plus":return this.drawSymbolPlus(e,t);case"square":return this.drawSymbolStop(e,t);case"pointRight":return this.drawSymbolPointRight(e,t);case"gears":return this.drawSymbolGears(e,t);case"file":return this.drawSymbolFile(e,t);case"fullScreen":return this.drawSymbolFullScreen(e,t);case"normalScreen":return this.drawSymbolNormalScreen(e,t);case"smallStage":return this.drawSymbolSmallStage(e,t);case"normalStage":return this.drawSymbolNormalStage(e,t);case"turtle":return this.drawSymbolTurtle(e,t);case"stage":return this.drawSymbolStop(e,t);case"turtleOutline":return this.drawSymbolTurtleOutline(e,t);case"pause":return this.drawSymbolPause(e,t);case"flag":return this.drawSymbolFlag(e,t);case"octagon":return this.drawSymbolOctagon(e,t);case"cloud":return this.drawSymbolCloud(e,t);case"cloudOutline":return this.drawSymbolCloudOutline(e,t);case"cloudGradient":return this.drawSymbolCloudGradient(e,t);case"turnRight":return this.drawSymbolTurnRight(e,t);case"turnLeft":return this.drawSymbolTurnLeft(e,t);case"storage":return this.drawSymbolStorage(e,t);case"poster":return this.drawSymbolPoster(e,t);case"flash":return this.drawSymbolFlash(e,t);case"brush":return this.drawSymbolBrush(e,t);case"rectangle":return this.drawSymbolRectangle(e,t);case"rectangleSolid":return this.drawSymbolRectangleSolid(e,t);case"circle":return this.drawSymbolCircle(e,t);case"circleSolid":return this.drawSymbolCircleSolid(e,t);case"line":return this.drawSymbolLine(e,t);case"crosshairs":return this.drawSymbolCrosshairs(e,t);case"paintbucket":return this.drawSymbolPaintbucket(e,t);case"eraser":return this.drawSymbolEraser(e,t);case"pipette":return this.drawSymbolPipette(e,t);case"speechBubble":return this.drawSymbolSpeechBubble(e,t);case"speechBubbleOutline":return this.drawSymbolSpeechBubbleOutline(e,t);case"arrowUp":return this.drawSymbolArrowUp(e,t);case"arrowUpOutline":return this.drawSymbolArrowUpOutline(e,t);case"arrowLeft":return this.drawSymbolArrowLeft(e,t);case"arrowLeftOutline":return this.drawSymbolArrowLeftOutline(e,t);case"arrowDown":return this.drawSymbolArrowDown(e,t);case"arrowDownOutline":return this.drawSymbolArrowDownOutline(e,t);case"arrowRight":return this.drawSymbolArrowRight(e,t);case"arrowRightOutline":return this.drawSymbolArrowRightOutline(e,t);case"robot":return this.drawSymbolRobot(e,t);default:return e}},SymbolMorph.prototype.drawSymbolPlus=function(t,e){var o=t.getContext("2d"),r=t.width,i=Math.max(r/12,1),n=t.height;return o.lineWidth=i,o.strokeStyle=e.toString(),o.fillStyle=e.toString(),o.moveTo(0,n/2),o.lineTo(r,n/2),o.moveTo(r/2,0),o.lineTo(r/2,n),o.stroke(),t},ProjectDialogMorph.prototype.buildContents=function(){var t,e;this.addBody(new Morph),this.body.color=this.color,this.srcBar=new AlignmentMorph("column",this.padding/2),this.ide.cloudMsg&&(e=new TextMorph(this.ide.cloudMsg,10,null,!1,null,null,null,null,new Point(1,1),new Color(255,255,255)),e.refresh=nop,this.srcBar.add(e)),this.addSourceButton("cloud",localize("Cloud"),"cloud"),this.addSourceButton("local",localize("Browser"),"storage"),"open"===this.task&&this.addSourceButton("examples",localize("Examples"),"poster"),this.srcBar.fixLayout(),this.body.add(this.srcBar),"save"===this.task&&(this.nameField=new InputFieldMorph(this.ide.room.name),this.body.add(this.nameField)),this.listField=new ListMorph([]),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.body.add(this.listField),this.preview=new Morph,this.preview.fixLayout=nop,this.preview.edge=InputFieldMorph.prototype.edge,this.preview.fontSize=InputFieldMorph.prototype.fontSize,this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.preview.contrast=InputFieldMorph.prototype.contrast,this.preview.drawNew=function(){InputFieldMorph.prototype.drawNew.call(this),this.texture&&this.drawTexture(this.texture)},this.preview.drawCachedTexture=function(){var t=this.image.getContext("2d");t.drawImage(this.cachedTexture,this.edge,this.edge),this.changed()},this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.preview.setExtent(this.ide.serializer.thumbnailSize.add(2*this.preview.edge)),this.body.add(this.preview),this.preview.drawNew(),"save"===this.task&&(t=this.ide.stage.thumbnail(SnapSerializer.prototype.thumbnailSize),this.preview.texture=null,this.preview.cachedTexture=t,this.preview.drawCachedTexture()),this.notesField=new ScrollFrameMorph,this.notesField.fixLayout=nop,this.notesField.edge=InputFieldMorph.prototype.edge,this.notesField.fontSize=InputFieldMorph.prototype.fontSize,this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.notesField.contrast=InputFieldMorph.prototype.contrast,this.notesField.drawNew=InputFieldMorph.prototype.drawNew,this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,"open"===this.task?this.notesText=new TextMorph(""):(this.notesText=new TextMorph(this.ide.projectNotes),this.notesText.isEditable=!0,this.notesText.enableSelecting()),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setWidth(this.preview.width()),this.body.add(this.notesField),"open"===this.task?(this.addButton("openProject","Open"),this.action="openProject"):(this.addButton("saveProject","Save"),this.action="saveProject"),this.shareButton=this.addButton("shareProject","Share"),this.unshareButton=this.addButton("unshareProject","Unshare"),this.shareButton.hide(),this.unshareButton.hide(),this.deleteButton=this.addButton("deleteProject","Delete"),this.addButton("cancel","Cancel"),e?this.setExtent(new Point(455,335).add(e.extent())):this.setExtent(new Point(455,335)),this.fixLayout()},ProjectDialogMorph.prototype.setSource=function(t){var e,o=this;switch(this.source=t,this.srcBar.children.forEach(function(t){t.refresh()}),this.source){case"cloud":return e=o.ide.showMessage("Updating\nproject list..."),this.projectList=[],void SnapCloud.getProjectList(function(t){"cloud"===o.source&&o.installCloudProjectList(t),e.destroy()},function(t,r){e.destroy(),o.ide.cloudError().call(null,t,r)});case"examples":this.projectList=this.getExamplesProjectList();break;case"local":this.projectList=this.getLocalProjectList()}this.listField.destroy(),this.listField=new ListMorph(this.projectList,this.projectList.length>0?function(t){return t.name}:null,null,function(){o.ok()}),this.fixListFieldItemColors(),this.listField.fixLayout=nop,this.listField.edge=InputFieldMorph.prototype.edge,this.listField.fontSize=InputFieldMorph.prototype.fontSize,this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding,this.listField.contrast=InputFieldMorph.prototype.contrast,this.listField.drawNew=InputFieldMorph.prototype.drawNew,this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,"local"===this.source?this.listField.action=function(t){var e,r;void 0!==t&&(o.nameField&&o.nameField.setContents(t.name||""),"open"===o.task&&(e=localStorage["-snap-project-"+t.name],r=o.ide.serializer.parse(e),r=r.children[0].children[0],o.notesText.text=r.childNamed("notes").contents||"",o.notesText.drawNew(),o.notesField.contents.adjustBounds(),o.preview.texture=r.childNamed("thumbnail").contents||null,o.preview.cachedTexture=null,o.preview.drawNew()),o.edit())}:this.listField.action=function(t){var e,r;void 0!==t&&(o.nameField&&o.nameField.setContents(t.name||""),e=JSON.parse(o.ide.getURL("api/Examples/"+t.name+"?socketId="+o.ide.sockets.uuid+"&preview=true")).src.SourceCode,r=o.ide.serializer.parse(e),o.notesText.text=r.childNamed("notes").contents||"",o.notesText.drawNew(),o.notesField.contents.adjustBounds(),o.preview.texture=r.childNamed("thumbnail").contents||null,o.preview.cachedTexture=null,o.preview.drawNew(),o.edit())},this.body.add(this.listField),this.shareButton.hide(),this.unshareButton.hide(),"local"===this.source?this.deleteButton.show():this.deleteButton.hide(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()};var superOpenProj=ProjectDialogMorph.prototype.openProject;ProjectDialogMorph.prototype.openProject=function(){var t,e=this.listField.selected;return"examples"!==this.source?superOpenProj.call(this):(t=JSON.parse(this.ide.getURL("api/Examples/"+e.name+"?socketId="+this.ide.sockets.uuid)),this.ide.room.nextRoom={ownerId:t.ownerId,roomName:t.roomName,roleId:t.role},t.src.SourceCode?this.ide.openProjectString(t.src.SourceCode):this.ide.clearProject(),this.ide.loadNextRoom(),this.destroy(),void 0)},ProjectDialogMorph.prototype.rawOpenCloudProject=function(t){var e=this,o=t.ProjectName,r=this.ide;SnapCloud.reconnect(function(){SnapCloud.callService("getProject",function(e){var i=e[0].ProjectName;r.source="cloud",e[0].SourceCode?(r.droppedText(e[0].SourceCode),r.room.nextRoom={ownerId:SnapCloud.username,roomName:o,roleId:i}):(r.clearProject(),r.room._name=o,r.room.ownerId=SnapCloud.username,r.silentSetProjectName(i),r.sockets.updateRoomInfo()),"true"===t.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(t.ProjectName))},e.ide.cloudError(),[t.ProjectName])},e.ide.cloudError()),this.destroy()},ProjectDialogMorph.prototype.saveProject=function(){var t=this.nameField.contents().text.text,e=this.notesText.text,o=this;this.ide.projectNotes=e||this.ide.projectNotes,t&&("cloud"===this.source?detect(this.projectList,function(e){return e.ProjectName===t})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+t+'"?',"Replace Project",function(){o.ide.room.name=t,o.saveCloudProject()}):(o.ide.room.name=t,o.saveCloudProject()):detect(this.projectList,function(e){return e.name===t})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+t+'"?',"Replace Project",function(){o.ide.room.name=t,o.ide.source="local",o.ide.saveProject(t),o.destroy()}):(this.ide.room.name=t,o.ide.source="local",this.ide.saveProject(t),this.destroy()))},IDE_Morph.prototype.exportGlobalBlocks=function(){this.stage.globalBlocks.length>0||this.stage.deletableMessageNames().length?new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks,this.stage).popUp(this.world()):this.inform("Export blocks/msg types","this project doesn't have any\ncustom global blocks or message types yet")},IDE_Morph.prototype.rawOpenBlocksString=function(t,e,o){var r,i=this;if(Process.prototype.isCatchingErrors)try{r=this.serializer.loadBlocks(t,i.stage)}catch(t){this.showMessage("Load failed: "+t)}else r=this.serializer.loadBlocks(t,i.stage);o?(r.forEach(function(t){"msg"===t.category?i.stage.addMessageType(JSON.parse(t.spec)):(t.receiver=i.stage,i.stage.globalBlocks.push(t),i.stage.replaceDoubleDefinitionsFor(t))}),this.flushBlocksCache(),this.flushPaletteCache(),this.refreshPalette(),this.showMessage("Imported Blocks / Message Types Module"+(e?": "+e:"")+".",2)):new BlockImportDialogMorph(r,this.stage,e).popUp()},NetCloud.prototype=new Cloud,NetCloud.prototype.login=function(t,e,o,r,i){var n=new XMLHttpRequest,s=JSON.stringify({__h:e,__u:t,remember:o,socketId:this.socketId()}),a=this;this.setRoute(t);try{n.open("POST",(this.hasProtocol()?"":"http://")+this.url+"?SESSIONGLUE="+this.route,!0),n.setRequestHeader("Content-Type","application/json; charset=utf-8"),n.setRequestHeader("SESSIONGLUE",this.route),n.withCredentials=!0,n.onreadystatechange=function(){4===n.readyState&&(200===n.status?(a.api=a.parseAPI(n.responseText),a.session=!0,a.api.logout?(a.username=t,a.password=e,a.onLogin(),r.call(null,a.api,"NetsBlox Cloud")):i.call(null,n.responseText,"connection failed")):403===n.status?i.call(null,"",localize(n.responseText||"wrong username or password")):i.call(null,a.url,localize("could not connect to:")))},n.send(s)}catch(t){i.call(this,t.toString(),"NetsBlox Cloud")}},NetCloud.prototype.cloneRole=function(t,e,o){var r=this;this.reconnect(function(){r.callService("cloneRole",t,e,o)},function(t){r.ide.showMessage(t,2)})},NetCloud.prototype.moveToRole=function(t,e,o){var r=this;o.push(this.socketId()),this.reconnect(function(){r.callService("moveToRole",t,e,o)},function(t){r.ide.showMessage(t,2)})},NetCloud.prototype.invitationResponse=function(t,e,o,r){var i=this,n=[t,e,this.socketId()];this.reconnect(function(){i.callService("invitationResponse",o,r,n)},function(t){i.ide.showMessage(t,2)})},NetCloud.prototype.inviteToRoom=function(){var t=this,e=arguments;this.reconnect(function(){t.callService("inviteToRoom",nop,nop,e)},nop)},NetCloud.prototype.getFriendList=function(t,e){var o=this;this.reconnect(function(){o.callService("getFriendList",function(e,o){var r=Object.keys(e[0]||{});t.call(null,r,o)},e)},e)},NetCloud.prototype.deleteRole=function(t,e,o){var r=this;this.reconnect(function(){r.callService("deleteRole",function(){t.call(null)},e,o)},e)},NetCloud.prototype.evictUser=function(t,e,o){var r=this;this.reconnect(function(){r.callService("evictUser",t.bind(null),e,o)},e)},NetCloud.prototype.socketId=function(){var t;return t=detect(world.children,function(t){return t instanceof IDE_Morph}),t.sockets.uuid},NetCloud.prototype.saveProject=function(t,e,o){var r=this;r.reconnect(function(){r.callService("saveProject",function(t,o){e.call(null,t,o)},o,[r.socketId()])},o)},NetCloud.prototype.callService=function(t,e,o,r){var i,n,s=new XMLHttpRequest,a=this.api[t],h=this;if(!this.session)return void o.call(null,"You are not connected","Cloud");if(!a)return void o.call(null,"service "+t+" is not available","API");r&&r.length>0&&(n={},a.parameters.forEach(function(t,e){n[t]=r[e]}));try{i=this.url+"/"+a.url,s.open(a.method,i,!0),s.withCredentials=!0,s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.onreadystatechange=function(){if(4===s.readyState){var r=[];if(s.responseText&&0===s.responseText.indexOf("ERROR"))return void o.call(this,s.responseText,localize("Service:")+" "+localize(t));"login"===t&&(h.api=h.parseAPI(s.responseText)),r=h.parseResponse(s.responseText),e.call(null,r,a.url)}},s.send(this.encodeDict(n))}catch(t){o.call(this,t.toString(),a.url)}},NetCloud.prototype.passiveLogin=function(t,e){var o,r=new XMLHttpRequest,i=this.socketId(),n=JSON.stringify({return_user:!0,api:!0,socketId:i}),s=this;e=e||nop;try{r.open("POST",(this.hasProtocol()?"":"http://")+this.url,!0),r.setRequestHeader("Content-Type","application/json; charset=utf-8"),r.withCredentials=!0,r.onreadystatechange=function(){4===r.readyState&&200===r.status&&(o=JSON.parse(r.responseText),s.api=s.parseAPI(o.api),s.username=o.username,s.session=!0,s.password=!0,t&&(t.source="cloud"),s.onPassiveLogin(),e())},r.send(n)}catch(t){console.error(t.toString())}},NetCloud.prototype.reconnect=function(t,e){if(this.password===!0)this.passiveLogin(null,t);else{if(!this.username||!this.password)return void this.message("You are not logged in");this.login(this.username,this.password,void 0,t,e)}},NetCloud.prototype.disconnect=nop,NetCloud.prototype.logout=function(t,e){this.callService("logout",t,e),this.clear()},NetCloud.prototype.signup=function(t,e,o,r){var i=new XMLHttpRequest,n=this,s="Username="+encodeURIComponent(t)+"&Email="+encodeURIComponent(e);try{i.open("POST",(this.hasProtocol()?"":"http://")+this.url+"SignUp",!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.withCredentials=!0,i.onreadystatechange=function(){4===i.readyState&&(i.responseText?0===i.responseText.indexOf("ERROR")?r.call(this,i.responseText,"Signup"):o.call(null,i.responseText,"Signup"):r.call(null,n.url+"SignUp",localize("could not connect to:")))},i.send(s)}catch(t){r.call(this,t.toString(),"NetsBlox Cloud")}};var SnapCloud=new NetCloud(window.location.protocol+"//"+window.location.host+"/api/");ThreadManager.prototype.startProcess=function(t,e,o,r,i,n){var s,a=this.findProcess(t),h=t.topBlock();if(a){if(e)return a;a.stop(),this.removeTerminatedProcesses()}return s=new NetsProcess(t.topBlock(),r,n),s.exportResult=o,s.isClicked=i||!1,s.homeContext.receiver.isClone||h.addHighlight(),this.processes.push(s),s},NetsProcess.prototype=new Process,NetsProcess.prototype.constructor=NetsProcess,NetsProcess.prototype.timeout=500,NetsProcess.prototype.isCatchingErrors=!0,NetsProcess.prototype.doSocketMessage=function(t){var e,o,r,i=this.homeContext.receiver.parentThatIsA(IDE_Morph),n=arguments[arguments.length-1],s=i.projectName,a=Array.prototype.slice.call(arguments,1),h=i.stage;if(t){e=h.messageTypes.getMsgType(t),o=e.fields,r=new Message(e);for(var l=o.length;l--;)r.set(o[l],a[l]||"");i.sockets.sendMessage({type:"message",dstId:n,srcId:s,msgType:r.type.name,content:r.contents})}},NetsProcess.prototype.receiveSocketMessage=function(t){var e,o=this.context.outerContext.variables,r=o.names();if(r.indexOf("__message__")!==-1){e=this.context.variables.getVar("__message__"),t.length||(t=Object.keys(e));for(var i=t.length;i--;)o.addVar(t[i],e[t[i]]);o.deleteVar("__message__")}},NetsProcess.prototype.createRPCUrl=function(t,e){var o=this.homeContext.receiver.parentThatIsA(IDE_Morph),r=o.sockets.uuid;return window.location.origin+"/rpc/"+t+"?uuid="+r+"&"+e},NetsProcess.prototype.callRPC=function(t,e,o){var r,i=this.createRPCUrl(t,e);if(o&&(i+="&t="+Date.now()),this.rpcRequest){if(4===this.rpcRequest.readyState)return r=this.rpcRequest.responseText,this.rpcRequest=null,r}else this.rpcRequest=new XMLHttpRequest,this.rpcRequest.open("GET",i,!0),this.rpcRequest.send(null);this.pushContext("doYield"),this.pushContext()},NetsProcess.prototype.getJSFromRPC=function(t,e){var o=this.callRPC(t,e,!0);if(o)try{o=JSON.parse(o)}catch(t){}return o instanceof Array&&(o=new List(o)),o},NetsProcess.prototype.getJSFromRPCDropdown=function(t,e,o){return this.getJSFromRPC(["",t,e].join("/"),o)},NetsProcess.prototype.getCostumeFromRPC=function(t,e,o){var r,i=this.homeContext.receiver.parentThatIsA(StageMorph),n=o.length?o.split("&"):[];if(t=["",t,e].join("/"),o.indexOf("width")===-1&&n.push("width="+i.width()),o.indexOf("height")===-1&&n.push("height="+i.height()),o=n.join("&"),this.requestedImage){if(this.requestedImage.complete&&this.requestedImage.naturalWidth)return r=this.requestedImage,this.requestedImage=null,new Costume(r,t)}else this.requestedImage=new Image,this.requestedImage.crossOrigin="Anonymous",this.requestedImage.src=this.createRPCUrl(t,o);this.pushContext("doYield"),this.pushContext()},NetsProcess.prototype.reportLatitude=function(){var t=this;if(this.location){if("loading..."!==this.location){var e=this.location;return this.location=null,e.coords.latitude}}else navigator.geolocation.getCurrentPosition(function(e){t.location=e}),this.location="loading...";this.pushContext("doYield"),this.pushContext()},NetsProcess.prototype.reportLongitude=function(){var t=this;if(this.location){if("loading..."!==this.location){var e=this.location;return this.location=null,e.coords.longitude}}else navigator.geolocation.getCurrentPosition(function(e){t.location=e}),this.location="loading...";this.pushContext("doYield"),this.pushContext()},NetsProcess.prototype.reportStageWidth=function(){var t=this.homeContext.receiver.parentThatIsA(StageMorph);return t.dimensions.x},NetsProcess.prototype.reportStageHeight=function(){var t=this.homeContext.receiver.parentThatIsA(StageMorph);return t.dimensions.y},InputSlotDialogMorph.prototype.init=function(t,e,o,r,i){var n=SyntaxElementMorph.prototype.scale,s=fontHeight(10)/1.2*n;this.fragment=t||new BlockLabelFragment,this.textfield=null,this.types=null,this.slots=null,this.isExpanded=!1,this.category=i||"other",this.cachedRadioButton=null,BlockDialogMorph.uber.init.call(this,e,o,r),this.types=new AlignmentMorph("row",this.padding),this.types.respectHiddens=!0,this.add(this.types),this.slots=new BoxMorph,this.slots.color=new Color(55,55,55),this.slots.borderColor=this.slots.color.lighter(50),this.slots.setExtent(new Point(24*(s+10),11.4*(s+10*n))),this.add(this.slots),this.createSlotTypeButtons(),this.fixSlotsLayout(),this.addSlotsMenu(),this.createTypeButtons(),this.fixLayout()},InputSlotDialogMorph.prototype.fixSlotsLayout=function(){var t,e,o=this.slots,r=SyntaxElementMorph.prototype.scale,i=10*r,n=14*r,s=(fontHeight(10)/1.2+15)*r,a=(fontHeight(10)/1.2+10)*r,h=12,l=[o.left()+i,o.left()+o.width()/3,o.left()+2*o.width()/3],p=[o.top()+n,o.top()+n+s,o.top()+n+2*s,o.top()+n+3*s,o.top()+n+4*s,o.top()+n+5*s,o.top()+n+5*s+a,o.top()+n+5*s+2*a,o.top()+n+5*s+3*a],c=-1,d=Morph.prototype.trackChanges;for(Morph.prototype.trackChanges=!1,t=0;t<h;t+=1)e=t%3,t%3===0&&(c+=1),o.children[t].setPosition(new Point(l[e],p[c]));for(e=0,c=5,t=h;t<h+4;t+=1)o.children[t].setPosition(new Point(l[e],p[c+t-h]));
this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new Point(5,0))),this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0))),Morph.prototype.trackChanges=d,this.slots.changed()},BlockLabelFragment.prototype.setToSingleInput=function(){return this.type?void("%upvar"===this.type||"%msgType"===this.type?this.type="%s":this.type=this.singleInputType()):null},BlockLabelFragment.prototype.setToMultipleInput=function(){return this.type?("%upvar"!==this.type&&"%msgType"!==this.type||(this.type="%s"),void(this.type="%mult".concat(this.singleInputType()))):null},BlockLabelFragment.prototype.isSingleInput=function(){return!this.isMultipleInput()&&"%upvar"!==this.type&&"%msgType"!==this.type},InputSlotDialogMorph.prototype.setSlotArity=function(t){"single"===t?this.fragment.setToSingleInput():"message"===t?this.fragment.type="%msgType":"multiple"===t?this.fragment.setToMultipleInput():"upvar"===t&&this.fragment.setToUpvar(),this.slots.children.forEach(function(t){t.refresh()}),this.edit()},InputSlotDialogMorph.prototype.createSlotTypeButtons=function(){var t,e,o=this,r=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1,this.addSlotTypeButton("Object","%obj"),this.addSlotTypeButton("Text","%txt"),this.addSlotTypeButton("List","%l"),this.addSlotTypeButton("Number","%n"),this.addSlotTypeButton("Any type","%s"),this.addSlotTypeButton("Boolean (T/F)","%b"),this.addSlotTypeButton("Command\n(inline)","%cmdRing"),this.addSlotTypeButton("Reporter","%repRing"),this.addSlotTypeButton("Predicate","%predRing"),this.addSlotTypeButton("Command\n(C-shape)","%cs"),this.addSlotTypeButton("Any\n(unevaluated)","%anyUE"),this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE"),this.slots.radioButtonSingle=this.addSlotArityButton(function(){o.setSlotArity("single")},"Single input.",function(){return o.fragment.isSingleInput()}),this.addSlotArityButton(function(){o.setSlotArity("message")},"Message Type",function(){return"%msgType"===o.fragment.type}),this.addSlotArityButton(function(){o.setSlotArity("multiple")},"Multiple inputs (value is list of inputs)",function(){return o.fragment.isMultipleInput()}),this.addSlotArityButton(function(){o.setSlotArity("upvar")},"Upvar - make internal variable visible to caller",function(){return o.fragment.isUpvar()}),t=new StringMorph(localize("Default Value:")),t.fontSize=this.slots.radioButtonSingle.fontSize,t.setColor(new Color(255,255,255)),t.refresh=function(){o.isExpanded&&contains(["%s","%n","%txt","%anyUE"],o.fragment.type)?t.show():t.hide()},this.slots.defaultInputLabel=t,this.slots.add(t),e=new InputFieldMorph(this.fragment.defaultValue),e.contents().fontSize=t.fontSize,e.contrast=90,e.contents().drawNew(),e.setWidth(50),e.refresh=function(){t.isVisible?(e.show(),"%n"===o.fragment.type?e.setIsNumeric(!0):e.setIsNumeric(!1)):e.hide()},this.slots.defaultInputField=e,this.slots.add(e),e.drawNew(),Morph.prototype.trackChanges=r},BlockExportDialogMorph.prototype=new DialogBoxMorph,BlockExportDialogMorph.prototype.constructor=BlockExportDialogMorph,BlockExportDialogMorph.uber=DialogBoxMorph.prototype,BlockExportDialogMorph.prototype.init=function(t,e,o){var r=this;this.serializer=t,this.blocks=e.slice(0),this.handle=null,BlockExportDialogMorph.uber.init.call(this,null,function(){r.exportBlocks(o)},null),this.labelString="Export blocks / message types",this.createLabel(),this.buildContents(o)},BlockExportDialogMorph.prototype.buildContents=function(t){var e,o,r,i,n,s,a=this,h=4;this.msgs=[],e=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor),e.color=SpriteMorph.prototype.paletteColor,e.padding=h,e.isDraggable=!1,e.acceptsDrops=!1,e.contents.acceptsDrops=!1,o=e.left()+h,r=e.top()+h,SpriteMorph.prototype.categories.forEach(function(t){a.blocks.forEach(function(l){l.category===t&&(s&&t!==s&&(r+=h),s=t,i=l.templateInstance(),n=new ToggleMorph("checkbox",a,function(){var t=a.blocks.indexOf(l);t>-1?a.blocks.splice(t,1):a.blocks.push(l)},null,function(){return contains(a.blocks,l)},null,null,null,i.fullImage()),n.setPosition(new Point(o,r+(n.top()-n.toggleElement.top()))),e.addContents(n),r+=n.fullBounds().height()+h)})});for(var l=0;l<t.deletableMessageNames().length;l++){var p=new ReporterBlockMorph;p.setSpec(t.deletableMessageNames()[l]),p.setColor(new Color(217,77,17)),this.msgs.push(p)}this.msgs.forEach(function(t){n=new ToggleMorph("checkbox",this,function(){this.msgs.includes(t)?this.msgs.splice(this.msgs.indexOf(t),1):this.msgs.push(t)},null,function(){return this.msgs.includes(t)},null,null,null,t.fullImage()),n.setPosition(new Point(o,r+(n.top()-n.toggleElement.top()))),e.addContents(n),r+=n.fullBounds().height()+h}.bind(this)),e.scrollX(h),e.scrollY(h),this.addBody(e),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.setExtent(new Point(220,300)),this.fixLayout()},BlockExportDialogMorph.prototype.exportBlocks=function(t){for(var e=this.serializer.serialize(this.blocks),o=this.world().children[0],r="",i=0;i<this.msgs.length;i++)r=r+"<block-definition s='"+JSON.stringify(t.messageTypes.getMsgType(this.msgs[i].blockSpec))+"' category='msg'/>";this.blocks.length>0||this.msgs.length>0?(e='<blocks app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+e+r+"</blocks>",o.saveXMLAs(e,o.projectName||localize("Untitled")+" "+localize("blocks"))):(new DialogBoxMorph).inform("Export blocks / message types","no blocks or message types were selected",this.world())},BlockExportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout,BlockImportDialogMorph.prototype.importBlocks=function(t){var e=this.target.parentThatIsA(IDE_Morph);e&&(this.blocks.length>0?(this.blocks.forEach(function(t){"msg"===t.category?e.stage.addMessageType(JSON.parse(t.spec)):(t.receiver=e.stage,e.stage.globalBlocks.push(t),e.stage.replaceDoubleDefinitionsFor(t))}),e.flushPaletteCache(),e.refreshPalette(),e.showMessage("Imported Blocks / Message Types Module"+(t?": "+t:"")+".",2)):(new DialogBoxMorph).inform("Import blocks/msg types","no blocks or message types were selected",this.world()))};var WebSocketManager=function(t){this.ide=t,this.uuid=null,this.websocket=null,this.messages=[],this.processes=[],this._protocol="https:"===window.location.protocol?"wss:":"ws:",this.url=this._protocol+"//"+window.location.host,this._connectWebSocket(),this._heartbeat(),this.version=Date.now(),this.errored=!1,this.hasConnected=!1,this.connected=!1};WebSocketManager.HEARTBEAT_INTERVAL=55e3,WebSocketManager.MessageHandlers={uuid:function(t){this.uuid=t.body,this._onConnect()},message:function(t){var e=t.dstId,o=t.msgType,r=t.content;e!==this.ide.projectName&&"others in room"!==e&&"everyone in room"!==e||this.onMessageReceived(o,r,"role")},"export-room":function(t){"export"===t.action?this.ide.exportRoom(t.roles):"save"===t.action&&this.ide.saveRoomLocal(t.roles)},"room-roles":function(t){this.ide.room.update(t.owner,t.name,t.occupants)},"close-invite":function(t){this.ide.room.invitations[t.id]&&(this.ide.room.invitations[t.id].destroy(),delete this.ide.room.invitations[t.id])},"room-invitation":function(t){this.ide.room.promptInvite(t)},"project-closed":function(){var t=this.ide.room.ownerId;this.ide.showMessage(t+" closed the room. You can ask to join again once "+t+" opens the project again"),this.ide.newProject()},"project-fork":function(){this.ide.showMessage("That other room sucked. You are now the boss.")},"project-request":function(t){var e=this.getSerializedProject();t.type="project-response",t.project=e,this.sendMessage(t)},"rename-role":function(t){t.roleId===this.ide.projectName&&this.ide.silentSetProjectName(t.name)},notification:function(t){this.ide.showMessage(t.message)},"share-msg-type":function(t){if(this.ide.projectName===t.roleId){var e=this,o=new DialogBoxMorph;if(this.ide.stage.messageTypes.msgTypes[t.name])this.ide.showMessage(t.from+" tried sending you message type '"+t.name+"' when you already have it!",2);else{var r=t.from+" requested to send you a message type:\n'"+t.name+"' with "+t.fields.length+(1!==t.fields.length?" fields.":" field.")+"\nWould you like to accept?";o.askYesNo("Message Share Request",r,e.ide.root()),o.ok=function(){var o=e.ide.root().children[0].parentThatIsA(IDE_Morph);e.ide.stage.addMessageType({name:t.name,fields:t.fields}),o.flushBlocksCache("services"),o.refreshPalette();for(var r=[],i=0;i<t.fields.length;i++)r.push(" '"+t.fields[i]+"'");var n="Received message type '"+t.name+"' with "+t.fields.length+(0===t.fields.length?" fields.":1===t.fields.length?" field: "+t.fields:" fields: "+t.fields);this.destroy();new DialogBoxMorph;e.ide.showMessage(n,2),o.room.parentThatIsA(ProjectsMorph).updateRoom(),o&&"room"===o.currentTab&&o.spriteBar.tabBar.tabTo("room")}}}}},WebSocketManager.prototype._connectWebSocket=function(){var t=this,e=null!==this.websocket;if(e){if(this.websocket.readyState===this.websocket.OPEN)return;if(this.websocket.readyState===this.websocket.CONNECTING)return void setTimeout(t._connectWebSocket.bind(t),500)}this.websocket=new WebSocket(this.url),this.websocket.onopen=function(){for(console.log("Connection established"),t.errored===!0&&(t.ide.showMessage((t.hasConnected?"re":"")+"connected!",2),t.errored=!1),t.hasConnected=!0,t.connected=!0;t.messages.length;)t.websocket.send(t.messages.shift())},this.websocket.onmessage=function(e){var o=JSON.parse(e.data),r=o.type;WebSocketManager.MessageHandlers[r]?WebSocketManager.MessageHandlers[r].call(t,o):console.error("Unknown message:",o)},this.websocket.onclose=function(){var e;t.connected&&(t.version=Date.now(),t.connected=!1),!t.errored&&Date.now()-t.version>5e3&&(e=t.hasConnected?"Temporarily disconnected.\nSome network functionality may be nonfunctional.\nTrying to reconnect...":"Could not fully connect to NetsBlox.\nPlease try refreshing your browser or try a different browser",t.ide.showMessage(e),t.errored=!0),setTimeout(t._connectWebSocket.bind(t),500)}},WebSocketManager.prototype.sendMessage=function(t){var e=this.websocket.readyState;t=JSON.stringify(t),e===this.websocket.OPEN?this.websocket.send(t):this.messages.push(t)},WebSocketManager.prototype.setGameType=function(t){this.gameType=t.name},WebSocketManager.prototype._onConnect=function(){if(SnapCloud.username){var t=this.updateRoomInfo.bind(this);SnapCloud.reconnect(t,t)}else SnapCloud.passiveLogin(this.ide),this.updateRoomInfo()},WebSocketManager.prototype.updateRoomInfo=function(){var t=this.ide.room.ownerId,e=this.ide.projectName,o=this.ide.room.name||"__new_project__",r={type:"create-room",room:o,role:e};t&&(r.type="join-room",r.owner=t),this.sendMessage(r)},WebSocketManager.prototype.onMessageReceived=function(t,e,o){var r,i,n=[],s=!this.processes.length,a=this.ide.stage;if(e=e||[],""!==t){a.children.concat(a).forEach(function(e){(e instanceof SpriteMorph||e instanceof StageMorph)&&(n=n.concat(e.allHatBlocksForSocket(t,o)))});for(var h=n.length;h--;)i=n[h],r=null,"receiveSocketMessage"===i.selector&&(r=new Context,r.variables.addVar("__message__",e)),this.addProcess({block:i,isThreadSafe:a.isThreadSafe,context:r});s&&setTimeout(this.startProcesses.bind(this),50)}},WebSocketManager.prototype.addProcess=function(t){for(var e=0;e<this.processes.length;e++)if(t.block===this.processes[e][0].block)return void this.processes[e].push(t);this.processes.push([t])},WebSocketManager.prototype.startProcesses=function(){for(var t,e,o,r=this.ide.stage,i=0;i<this.processes.length;i++)e=this.processes[i][0].block,o=!!r.threads.findProcess(e),o||(t=this.processes[i].shift(),r.threads.startProcess(t.block,t.isThreadSafe,null,null,null,t.context),this.processes[i].length||(this.processes.splice(i,1),i--));this.processes.length&&setTimeout(this.startProcesses.bind(this),5)},WebSocketManager.prototype.getSerializedProject=function(){var t,e,o=this.ide;o.serializer.isCollectingMedia=!0,t=o.serializer.serialize(o.stage),e=o.serializer.mediaXML(o.projectName),o.serializer.isCollectingMedia=!1,o.serializer.flushMedia();try{o.serializer.parse(t)}catch(t){throw o.showMessage("Serialization of program data failed:\n"+t),new Error("Serialization of program data failed:\n"+t)}if(null!==e)try{o.serializer.parse(e)}catch(t){throw o.showMessage("Serialization of media failed:\n"+t),new Error("Serialization of media failed:\n"+t)}return o.serializer.isCollectingMedia=!1,o.serializer.flushMedia(),{ProjectName:o.projectName,SourceCode:t,Media:e,SourceSize:t.length,MediaSize:e?e.length:0,RoomName:this.ide.room.name}},WebSocketManager.prototype.destroy=function(){this.websocket.readyState===this.websocket.OPEN?this._destroy():this.websocket.onopen=this._destroy.bind(this)},WebSocketManager.prototype._destroy=function(){this.websocket.onclose=nop,this.websocket.close()},WebSocketManager.prototype._heartbeat=function(){this.sendMessage({type:"beat"}),setTimeout(this._heartbeat.bind(this),WebSocketManager.HEARTBEAT_INTERVAL)},modules.messages="2015-October-02",Message.prototype.init=function(){for(var t=this.type.fields.length;t--;)this.set(this.type.fields[t],0)},Message.prototype.set=function(t,e){this.contents[t]=e},Message.prototype.get=function(t){return this.contents[t]},Message.prototype.getFieldNames=function(){return this.type.fields.slice()},Message.prototype.toString=function(){return this.type.name+" Message"},MessageFrame.prototype.addMsgType=function(t){this.msgTypes[t.name]=t},MessageFrame.prototype.getMsgType=function(t){return this.msgTypes[t]},MessageFrame.prototype.deleteMsgType=function(t){delete this.msgTypes[t]},MessageFrame.prototype.names=function(){return Object.keys(this.msgTypes)},MessageCreatorMorph.prototype=new DialogBoxMorph,MessageCreatorMorph.prototype.constructor=MessageCreatorMorph,MessageCreatorMorph.uber=DialogBoxMorph.prototype,MessageCreatorMorph.prototype.init=function(t,e){var o=this;MessageCreatorMorph.uber.init.call(this,t),this.key="createNewMsgType",this.labelString="Create Message Type",this.createLabel();var r=new MessageDefinitionBlock;this.addBody(r);var i=r.fixLayout;r.fixLayout=function(){this.parent.drawNew(),i.call(this),o.fixLayout(),o.handle.drawNew(),o.drawNew()},this.accept=function(){var t={name:r.messageName(),fields:r.fields()};t.name&&e(t),this.destroy()},this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.drawNew()},MessageCreatorMorph.prototype.popUp=function(){var t=this.target.world();t&&(BlockEditorMorph.uber.popUp.call(this,t),this.handle=new HandleMorph(this,280,220,this.corner,this.corner))},MessageDefinitionBlock.prototype=new ReporterBlockMorph,MessageDefinitionBlock.prototype.constructor=MessageDefinitionBlock,MessageDefinitionBlock.uber=ReporterBlockMorph.prototype,MessageDefinitionBlock.prototype.init=function(){MessageDefinitionBlock.uber.init.call(this),this.color=SpriteMorph.prototype.blockColor.services,this.category="services",this.setSpec("name: %hintname fields: %mhintfield"),this.drawNew()},MessageDefinitionBlock.prototype.messageName=function(){return this.inputs()[0].evaluate()},MessageDefinitionBlock.prototype.fields=function(){return this.inputs()[1].evaluate()},MessageInputSlotMorph.prototype=new InputSlotMorph,MessageInputSlotMorph.prototype.constructor=MessageInputSlotMorph,MessageInputSlotMorph.uber=InputSlotMorph.prototype,MessageInputSlotMorph.prototype.executeOnSliderEdit=!1,MessageInputSlotMorph.prototype.setContents=function(t,e){var o,r,i=this,n=e&&e.pop?e.pop():"";InputSlotMorph.prototype.setContents.call(this,t),this._updateMessage(t,function(){i.parent&&i._updateFields(e)}),n&&(r=this.parent.inputs().length,o=this.parent.inputs()[r-1],"string"==typeof n?o.setContents(n):this.parent.silentReplaceInput(o,n))},MessageInputSlotMorph.prototype._updateMessage=function(t,e){var o=this._getMsgType();if(this.msgFields=[],t){if(!o)return setTimeout(this._updateMessage.bind(this,t,e),100);this.msgFields=o.fields}e()},MessageInputSlotMorph.prototype._updateFields=function(t){for(var e=this.parent.children,o=e.indexOf(this),r=this._msgContent.length+o+1,i=e[--r],n=[],s=this.parentThatIsA(ScriptsMorph);r-- >o;)n.push(i),this.parent.removeChild(i),i=e[r];for(s&&n.filter(function(t){return t instanceof BlockMorph}).forEach(s.add.bind(s)),this._msgContent=[],t=t||[],r=0;r<this.msgFields.length;r++)this._msgContent.push(this._updateField(this.msgFields[r],t[r]));this.fixLayout(),this.drawNew()},MessageInputSlotMorph.prototype.setDefaultFieldArg=function(t){var e,o,r=t<this.msgFields.length;if(r)o=this._msgContent[t]=this._getFieldValue(this.msgFields[t]),t++,e=this.parent.inputs()[t],t=this.parent.children.indexOf(e),this.parent.children.splice(t,1,o),o.parent=this.parent;else{var i,n;t++,i=t-this.msgFields.length,n=this.parent.blockSpec.split(" ").filter(function(t){return"%"===t[0]})[i],o=this.labelPart(n),e=this.parent.inputs()[t],t=this.parent.children.indexOf(e),this.parent.children.splice(t,1,o),o.parent=this.parent}return o.drawNew(),o.fixLayout(),o.drawNew(),this.parent.drawNew(),this.parent.fixLayout(),this.parent.drawNew(),o},MessageInputSlotMorph.prototype._getFieldValue=function(t,e){if(!e||"string"==typeof e){var o=new HintInputSlotMorph(e||"",t);return o}return e},MessageInputSlotMorph.prototype._updateField=function(t,e){var o=this.parent.children.indexOf(this)+this.msgFields.indexOf(t)+1,r=this._getFieldValue(t,e);return this.parent.children.splice(o,0,r),r.parent=this.parent,r},MessageInputSlotMorph.prototype._getMsgType=function(){var t,e=this.contents().text||null,o=this.parentThatIsA(BlockMorph),r=null;return o&&o.receiver()&&(t=o.receiver().parentThatIsA(StageMorph),r=t.messageTypes.getMsgType(e)),r},HintInputSlotMorph.prototype=new InputSlotMorph,HintInputSlotMorph.prototype.constructor=HintInputSlotMorph,HintInputSlotMorph.uber=InputSlotMorph.prototype,HintInputSlotMorph.prototype.evaluate=function(){return this.empty?this.isNumeric?0:"":InputSlotMorph.prototype.evaluate.call(this)},HintInputSlotMorph.prototype.setContents=function(t){var e=new Color(0,0,0),o=this.contents();InputSlotMorph.prototype.setContents.apply(this,arguments),this.empty=""===t,this.empty&&(o.text=this.hintText,e=new Color(100,100,100)),o.color=e,o.drawNew()},HintInputSlotMorph.prototype.changed=function(){var t=this.contents();return t&&(this.empty=t.text===this.hintText),InputSlotMorph.prototype.changed.call(this)},CommandBlockMorph.prototype.revertToDefaultInput=function(t){for(var e,o,r=-1,i=this.inputs(),n=i.indexOf(t),s=i.length;s--;)i[s]instanceof MessageInputSlotMorph&&(r=s,e=i[s]);if(e&&r<n){o=n-r-1;var a=e.setDefaultFieldArg(o);this.silentReplaceInput(t,a),this.cachedInputs=null}else SyntaxElementMorph.prototype.revertToDefaultInput.apply(this,arguments)},MessageOutputSlotMorph.prototype=new MessageInputSlotMorph,MessageOutputSlotMorph.prototype.constructor=MessageOutputSlotMorph,MessageOutputSlotMorph.uber=MessageInputSlotMorph.prototype,MessageOutputSlotMorph.prototype.executeOnSliderEdit=!1,MessageOutputSlotMorph.prototype.evaluate=function(){return this._msgContent.map(function(t){return t.evaluate()})},MessageOutputSlotMorph.prototype._updateFields=function(t){for(var e,o,r=this.parent.children,i=(r.indexOf(this),[]),n=this.parentThatIsA(ScriptsMorph),o=0;o<this.parent.children.length;o++)this.parent.children[o]instanceof ReadOnlyTemplateSlotMorph&&(e=this.parent.children[o],i.push(e),this.parent.removeChild(e),o--);for(n&&i.filter(function(t){return t instanceof BlockMorph}).forEach(n.add.bind(n)),this._msgContent=[],t=t||[],o=0;o<this.msgFields.length;o++)this._msgContent.push(this._updateField(this.msgFields[o],t[o]));this.fixLayout(),this.drawNew()},MessageOutputSlotMorph.prototype.setContents=function(t,e){var o=this;InputSlotMorph.prototype.setContents.call(this,t),this._updateMessage(t,function(){o.parent&&o._updateFields(e)})},MessageOutputSlotMorph.prototype._updateField=function(t){var e=new ReadOnlyTemplateSlotMorph(t);return this.parent.add(e),e.fixLayout(),e.drawNew(),e},ReadOnlyTemplateSlotMorph.prototype=new TemplateSlotMorph,ReadOnlyTemplateSlotMorph.prototype.constructor=ReadOnlyTemplateSlotMorph,ReadOnlyTemplateSlotMorph.uber=TemplateSlotMorph.prototype;var readOnlyReporterClick=function(t){return this.parent instanceof BlockInputFragmentMorph?this.parent.mouseClickLeft():ReporterBlockMorph.uber.mouseClickLeft.call(this,t)};SpriteMorph.prototype.allHatBlocksForSocket=function(t,e){"number"==typeof t&&(t=t.toString());var o,r;return this.scripts.children.filter(function(i){return"receiveSocketEvent"===i.selector?(o=i.inputs()[0].evaluate(),r=i.inputs()[1].evaluate(),(o===t||o instanceof Array)&&(r===e||r instanceof Array)):"receiveSocketMessage"===i.selector&&t===i.inputs()[0].contents().text})},StageMorph.prototype.allHatBlocksForSocket=SpriteMorph.prototype.allHatBlocksForSocket,RoomMorph.prototype=new Morph,RoomMorph.prototype.constructor=RoomMorph,RoomMorph.uber=Morph.prototype,RoomMorph.SIZE=300,RoomMorph.DEFAULT_ROLE="myRole",RoomMorph.prototype._onNameChanged=function(t){this.name!==t&&this.ide.sockets.sendMessage({type:"rename-room",name:t})},RoomMorph.prototype.update=function(t,e,o){var r,i,n=this,s=this.editable,a=this.roles,h=Object.keys(a);if(this.ownerId=t||this.ownerId,this.roles=o||this.roles,this.editable=this.ownerId&&this.ownerId===SnapCloud.username,i=e&&this.name!==e,i&&(this._name=e,this.ide.controlBar.updateLabel()),r=Object.keys(this.roles),i=i||s!==this.editable||h.length!==r.length||r.reduce(function(t,e){return t||a[e]!==n.roles[e]},!1)){this.version=Date.now(),this.drawNew(),this.changed();for(var l=0;l<this.ide.children.length;l++)if(this.ide.children[l]instanceof Morph&&this.ide.children[l].tabBar)return void this.ide.children[l].tabBar.children[3].mouseClickLeft()}},RoomMorph.prototype.drawNew=function(){var t,e,o,r,i=4,n=(Math.min(this.width(),this.height())-i)/2,s=i+n;for(e=Object.keys(this.roleLabels),r=e.length;r--;)this.roleLabels[e[r]].destroy();for(this.setPosition(new Point(115,0)),this.image=newCanvas(this.extent()),e=Object.keys(this.roles),o=e.length,r=0;r<e.length;r++)t=new RoleMorph(localize(e[r]),localize(this.roles[e[r]]),r,o),this.add(t),t.setExtent(this.extent()),t.setCenter(this.center()),this.roleLabels[e[r]]=t;this.renderRoomTitle(new Point(s,s).translateBy(this.topLeft())),this.showOwnerName(new Point(s,s).translateBy(this.topLeft()).translateBy(new Point(0,1.15*n)))},RoomMorph.prototype.showOwnerName=function(t){this.ownerLabel&&this.ownerLabel.destroy(),this.ownerId&&!this.ownerId.startsWith("_client_")&&(this.ownerLabel=new StringMorph("Owner: "+this.ownerId,!1,!1,!0),this.ownerLabel.setCenter(t),this.add(this.ownerLabel),this.owner=!1)},RoomMorph.prototype.mouseClickLeft=function(){this.editable||(SnapCloud.username?this.ide.confirm(localize('would you like to leave "'+this.name+'"?'),localize("Leave Room"),this.ide.newProject.bind(this.ide)):this.ide.showMessage(localize("Please login before editing the room")))},RoomMorph.prototype.renderRoomTitle=function(t){var e=100,o=25;this.roomLabel&&(this.roomLabel.destroy(),this.titleBox.destroy()),this.titleBox=new Morph,this.titleBox.image=newCanvas(this.extent()),this.titleBox.color=new Color(158,158,158),this.add(this.titleBox),this.titleBox.setExtent(new Point(e,o)),this.titleBox.setCenter(t),this.editable&&(this.titleBox.mouseClickLeft=this.editRoomName.bind(this)),this.roomLabel=new StringMorph(this.name,15,null,!0,!1),this.titleBox.add(this.roomLabel),this.roomLabel.setCenter(t)},RoomMorph.prototype.editRoomName=function(){var t=this;this.ide.prompt("New Room Name",function(e){e&&(t.name=e)},null,"editRoomName")},RoomMorph.prototype.createNewRole=function(){var t=this,e=this.world();this.ide.prompt("New Role Name",function(o){t.roles.hasOwnProperty(o)?(new DialogBoxMorph).inform("Existing Role Name","Could not create a new role because\nthe provided name already exists.",e):t._createNewRole(o)},null,"createNewRole")},RoomMorph.prototype._createNewRole=function(t){this.ide.sockets.sendMessage({type:"add-role",name:t})},RoomMorph.prototype.editRole=function(t){var e=new EditRoleMorph(this,t,!!this.roles[t.name]),o=this.world();e.fixLayout(),e.drawNew(),e.popUp(o),e.setCenter(o.center())},RoomMorph.prototype.editRoleName=function(t){var e=this;this.ide.prompt("New Role Name",function(o){/^\s*$/.test(o)||(e.roles.hasOwnProperty(o)?(new DialogBoxMorph).inform("Existing Role Name","Could not rename role because\nthe provided name already exists.",e.world()):e.ide.sockets.sendMessage({type:"rename-role",roleId:t,name:o}))},null,"editRoleName")},RoomMorph.prototype.moveToRole=function(t){var e=this,o=this.ide.projectName;SnapCloud.moveToRole(function(o){e.ide.showMessage("moved to "+t+"!"),e.ide.projectName=t;var r=o[0];r?(e.ide.source="cloud",e.ide.droppedText(r.SourceCode),"true"===r.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(r.ProjectName))):e.ide.clearProject(t)},function(t,o){e.ide.cloudError().call(null,t,o)},[t,o,this.ownerId,this.name])},RoomMorph.prototype.deleteRole=function(t){var e=this;SnapCloud.deleteRole(function(){e.ide.showMessage("deleted "+t+"!")},function(t,o){e.ide.cloudError().call(null,t,o)},[t,this.ownerId,this.name])},RoomMorph.prototype.createRoleClone=function(t){var e=this;SnapCloud.cloneRole(function(o){var r=Object.keys(o[0])[0];e.ide.showMessage("cloned "+t+" to "+r+" !")},function(t,o){e.ide.cloudError().call(null,t,o)},[t,e.ide.sockets.uuid])},RoomMorph.prototype.role=function(){return this.ide.projectName},RoomMorph.prototype.setRoleName=function(t){this.ide.sockets.sendMessage({type:"rename-role",roleId:this.ide.projectName,name:t||"untitled"})},RoomMorph.prototype.evictUser=function(t,e){var o=this;SnapCloud.evictUser(function(e){o.ide.showMessage(e||"evicted "+t+"!")},function(t,e){o.ide.cloudError().call(null,t,e)},[t,e,this.ownerId,this.name])},RoomMorph.prototype.inviteUser=function(t){var e,o=this;e=function(e){e.push("myself"),o._inviteFriendDialog(t,e)},SnapCloud.username?SnapCloud.getFriendList(e,function(t,e){o.ide.cloudError().call(null,t,e)}):e([])},RoomMorph.prototype.promptShare=function(t){var e=Object.keys(this.roles),o={},r=this;e.splice(e.indexOf(this.ide.projectName),1);for(var i=0;i<e.length;i++)o[e[i]]=e[i];if(Object.keys(e).length){var n=new DialogBoxMorph;n.prompt("Send to...","",world,!1,o),n.accept=function(){var o=n.getInput();e.indexOf(o)!==-1?r.roles[o]?(r.ide.sockets.sendMessage({type:"share-msg-type",roleId:o,from:r.ide.projectName,name:t,fields:r.ide.stage.messageTypes.getMsgType(t).fields}),r.ide.showMessage("Successfully sent!",2)):(r.sharedMsgs.push({roleId:o,msg:{name:t,fields:r.ide.stage.messageTypes.getMsgType(t).fields},from:r.ide.projectName}),r.ide.showMessage("The role will receive this message type on next occupation.",2)):r.ide.showMessage("There is no role by the name of '"+o+"'!",2),this.destroy()}}else r.ide.showMessage("There are no other roles in the room!",2)},RoomMorph.prototype._inviteFriendDialog=function(t,e){var o,r=(new DialogBoxMorph).withKey("inviteFriend"),i=new AlignmentMorph("column",7),n=r.ok,s=this,a=200,h=50,l=250,p=15*e.length,c=this.world();i.padding=6,i.setWidth(a),i.acceptsDrops=!1,o=new ListMorph(e),o.fixLayout=nop,o.edge=InputFieldMorph.prototype.edge,o.fontSize=InputFieldMorph.prototype.fontSize,o.typeInPadding=InputFieldMorph.prototype.typeInPadding,o.contrast=InputFieldMorph.prototype.contrast,o.drawNew=InputFieldMorph.prototype.drawNew,o.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,o.setWidth(a-2*i.padding),o.setHeight(Math.max(Math.min(l,p),h)),i.add(o),i.edge=InputFieldMorph.prototype.edge,i.fontSize=InputFieldMorph.prototype.fontSize,i.typeInPadding=InputFieldMorph.prototype.typeInPadding,i.contrast=InputFieldMorph.prototype.contrast,i.drawNew=InputFieldMorph.prototype.drawNew,i.drawRectBorder=InputFieldMorph.prototype.drawRectBorder,r.ok=function(){var e=o.selected;e&&s._inviteFriend(e,t),n.call(this)},r.labelString="Invite a Friend to the Room",r.createLabel(),r.addBody(i),i.drawNew(),r.addButton("ok","OK"),r.addButton("cancel","Cancel"),r.fixLayout(),r.drawNew(),r.popUp(c),r.setCenter(c.center())},RoomMorph.prototype._inviteFriend=function(t,e){var o=this.ide.sockets.uuid;"myself"===t&&(t=SnapCloud.username),SnapCloud.inviteToRoom(o,t,this.ownerId,this.name,e)},RoomMorph.prototype.promptInvite=function(t){var e,o=this,r=t.id,i=t.role,n=t.roomName,s=this._invitationResponse.bind(this,r,!0,i),a=new DialogBoxMorph(null,s);e=t.inviter===SnapCloud.username?'Would you like to move to "'+n+'"?':t.inviter+' has invited you to join\nhim/her at "'+n+'"\nAccept?',a.cancel=function(){o._invitationResponse(r,!1,i),delete o.invitations[r],this.destroy()},a.askYesNo("Room Invitation",localize(e),this.ide.world()),this.invitations[r]=a},RoomMorph.prototype._invitationResponse=function(t,e,o){var r=this;SnapCloud.invitationResponse(t,e,function(t){if(e){var i=t[0];i?(r.ide.source="cloud",r.ide.droppedText(i.SourceCode),"true"===i.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(i.ProjectName))):r.ide.clearProject(o),r.ide.showMessage("you have joined the room!",2),r.ide.silentSetProjectName(o)}SnapCloud.disconnect()},function(t){r.ide.showMessage(t,2)})},RoomMorph.prototype.checkForSharedMsgs=function(t){for(var e=0;e<this.sharedMsgs.length;e++)this.sharedMsgs[e].roleId===t&&(this.ide.sockets.sendMessage({type:"share-msg-type",name:this.sharedMsgs[e].msg.name,fields:this.sharedMsgs[e].msg.fields,from:this.sharedMsgs[e].from,roleId:t}),this.sharedMsgs.splice(e,1),e--)},RoleMorph.prototype=new Morph,RoleMorph.prototype.constructor=RoleMorph,RoleMorph.uber=Morph.prototype,RoleMorph.COLORS=[new Color(74,108,212),new Color(217,77,17).lighter(),new Color(207,74,217),new Color(0,161,120),new Color(143,86,227),new Color(230,168,34),new Color(4,148,220),new Color(98,194,19),new Color(243,118,29),new Color(150,150,150)].map(function(t){return t.darker()}),RoleMorph.prototype.init=function(t,e,o,r){RoleMorph.uber.init.call(this,!0),this.name=t,this.user=e,this._label=new RoleLabelMorph(t,e),this.add(this._label),this.index=o,this.total=r,this.drawNew()},RoleMorph.prototype.destroy=function(){for(var t=this.children.length;t--;)this.children[t].destroy();RoleMorph.uber.destroy.call(this)},RoleMorph.prototype.drawNew=function(){var t,e,o=4,r=(Math.min(this.width(),this.height())-o)/2,i=o+r;this.image=newCanvas(this.extent()),e=this.image.getContext("2d");var n,s,a=2*Math.PI/this.total,h=this.index*a,l=RoleMorph.COLORS.length;e.textAlign="center",e.fillStyle=RoleMorph.COLORS[this.index%l].toString(),e.beginPath(),e.moveTo(i,i),e.arc(i,i,r,h,h+a,!1),e.lineTo(i,i),e.fill(),n=.65*r*Math.cos(h+a/2),s=.65*r*Math.sin(h+a/2),t=new Point(n,s).translateBy(this.center()),this.acceptsDrops=!0,this._label&&this._label.destroy(),this.ownerLabel&&this.ownerLabel.destroy(),this._label=new RoleLabelMorph(this.name,this.user),this.add(this._label),this._label.setCenter(t),this.parent&&this.user===this.parent.ownerId&&!this.parent.owner&&(this.ownerLabel=new StringMorph("[OWNER]",11,!1,!0,!0),this.add(this.ownerLabel),this.ownerLabel.setCenter(new Point(t.x-12.5,t.y+25)),this.parent.owner=!0)},RoleMorph.prototype.mouseClickLeft=function(){this.parent.editable?this.editRole(this._label):this.escalateEvent("mouseClickLeft")},RoleMorph.prototype.reactToDropOf=function(t){function e(t,e,o){return t.user&&t.parent.ide.projectName===t.name?void t.parent.ide.showMessage("Can't send a message type to yourself!",2):void(t.user&&t.parent.ide.projectName!==t.name?(t.parent.ide.sockets.sendMessage({type:"share-msg-type",roleId:t.name,from:t.parent.ide.projectName,name:e,fields:o}),t.parent.ide.showMessage("Successfully sent!",2)):(t.parent.sharedMsgs.push({roleId:t.name,msg:{name:e,fields:o},from:t.parent.ide.projectName}),t.parent.ide.showMessage("The role will receive this message type on next occupation.",2)))}if(t instanceof ReporterBlockMorph&&t.forMsg&&e(this,t.blockSpec,this.parent.ide.stage.messageTypes.getMsgType(t.blockSpec).fields),
"receiveSocketMessage"===t.selector||"doSocketMessage"===t.selector){for(var o,r=0;r<t.children.length;r++)if(t.children[r]instanceof MessageOutputSlotMorph||t.children[r]instanceof MessageInputSlotMorph){o=t.children[r];break}""!==o.children[0].text&&e(this,o.children[0].text,o.msgFields)}t.destroy()},RoleLabelMorph.prototype=new Morph,RoleLabelMorph.prototype.constructor=RoleLabelMorph,RoleLabelMorph.uber=Morph.prototype,RoleLabelMorph.prototype.init=function(){var t=this.user||"<empty>";this.isMine()&&(t="me"),this._roleLabel=new StringMorph(this.name,14,null,!0,!1),this._userLabel=new StringMorph(t,14,null,!1,!0),RoleLabelMorph.uber.init.call(this),this.add(this._roleLabel),this.add(this._userLabel),this.drawNew()},RoleLabelMorph.prototype.isMine=function(){return SnapCloud.username?this.user===SnapCloud.username:!!this.user},RoleLabelMorph.prototype.drawNew=function(){this.image=newCanvas(new Point(1,1)),this.fixLayout()},RoleLabelMorph.prototype.fixLayout=function(){var t,e=this.center();t=this._roleLabel.height(),this._roleLabel.setCenter(new Point(e.x/2,e.y-t/2)),t=this._userLabel.height(),this._userLabel.setCenter(new Point(e.x/2,e.y+t/2))},EditRoleMorph.prototype=new DialogBoxMorph,EditRoleMorph.prototype.constructor=EditRoleMorph,EditRoleMorph.uber=DialogBoxMorph.prototype,EditRoleMorph.prototype.inviteUser=function(){this.room.inviteUser(this.role.name),this.destroy()},EditRoleMorph.prototype.editRoleName=function(){this.room.editRoleName(this.role.name),this.destroy()},EditRoleMorph.prototype.createRoleClone=function(){this.room.createRoleClone(this.role.name),this.destroy()},EditRoleMorph.prototype.deleteRole=function(){this.room.deleteRole(this.role.name),this.destroy()},EditRoleMorph.prototype.moveToRole=function(){this.room.moveToRole(this.role.name),this.destroy()},EditRoleMorph.prototype.evictUser=function(){this.room.evictUser(this.role.user,this.role.name),this.destroy()},ProjectsMorph.prototype=new ScrollFrameMorph,ProjectsMorph.prototype.constructor=ProjectsMorph,ProjectsMorph.uber=ScrollFrameMorph.prototype,ProjectsMorph.prototype.updateRoom=function(){var t=4;this.contents.destroy(),this.contents=new FrameMorph(this),this.contents.acceptsDrops=!1,this.addBack(this.contents),this.room.drawNew(),this.addContents(this.room),this.drawMsgPalette(),this.room.editable&&this._addButton({selector:"createNewRole",icon:"plus",hint:"Add a role to the room",left:this.room.right()+4*t})},ProjectsMorph.prototype.drawMsgPalette=function(){var t=0,e=this.room.ide.stage,o=new ScrollFrameMorph;o.owner=this,o.setColor(new Color(71,71,71,1)),o.setWidth(t),o.setHeight(2*this.room.center().y),o.bounds=o.bounds.insetBy(10),o.padding=12;for(var r=0;r<e.deletableMessageNames().length;r++){var i=new ReporterBlockMorph;i.blockSpec=e.deletableMessageNames()[r],i.setSpec(e.deletableMessageNames()[r]),i.setWidth(.75*t),i.setHeight(50),i.forMsg=!0,i.isTemplate=!0,i.setColor(new Color(217,77,17)),i.setPosition(new Point(o.bounds.origin.x+10,o.bounds.origin.y+24*r+6)),i.category="services",i.hint=new StringMorph("test"),i.justDropped=function(){this.destroy()},i.mouseClickLeft=function(){var t=0===e.messageTypes.msgTypes[this.blockSpec].fields.length?"This message type has no fields.":e.messageTypes.msgTypes[this.blockSpec].fields;new SpeechBubbleMorph(t,null,null,2).popUp(this.world(),new Point(0,0).add(this.bounds.corner))};var n=new MenuMorph(this,null);n.addItem("Send to...",function(){this.room.promptShare(i.blockSpec)}),i.children[0].customContextMenu=n,i.customContextMenu=n,o.addContents(i)}o.contents.width()>o.width()&&(o.setWidth(o.contents.width()),this.room.setPosition(new Point(o.width()+15,0))),this.addContents(o),this.vBar.hide()},ProjectsMorph.prototype.destroy=function(){this.room.changed=nop,ProjectsMorph.uber.destroy.call(this)},ProjectsMorph.prototype._addButton=function(t){var e,o=t.selector,r=t.icon,i=t.hint,n=t.left||this.room.center().x,s=t.top||this.room.center().y;return e=new PushButtonMorph(this.room,o,new SymbolMorph(r,12)),e.padding=0,e.corner=12,e.color=IDE_Morph.prototype.groupColor,e.highlightColor=IDE_Morph.prototype.frameColor.darker(50),e.pressColor=e.highlightColor,e.labelMinExtent=new Point(36,18),e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=e.highlightColor,e.labelColor=TurtleIconMorph.prototype.labelColor,e.contrast=this.buttonContrast,e.drawNew(),i&&(e.hint=i),e.fixLayout(),e.setLeft(n),e.setTop(s),this.addContents(e),e},NetsBloxMorph.prototype=new IDE_Morph,NetsBloxMorph.prototype.constructor=NetsBloxMorph,NetsBloxMorph.uber=IDE_Morph.prototype,NetsBloxMorph.prototype.init=function(t){this.sockets=new WebSocketManager(this),this.room=null,NetsBloxMorph.uber.init.call(this,t),this.serializer=new NetsBloxSerializer},NetsBloxMorph.prototype.buildPanes=function(){this.createRoom(),NetsBloxMorph.uber.buildPanes.call(this)},NetsBloxMorph.prototype.resourceURL=function(t,e){return"api/"+t+"/"+e},NetsBloxMorph.prototype.clearProject=function(){this.source=SnapCloud.username?"cloud":"local",this.stage&&this.stage.destroy(),"#lang:"!==location.hash.substr(0,6)&&(location.hash=""),this.globalVariables=new VariableFrame,this.currentSprite=new SpriteMorph(this.globalVariables),this.sprites=new List([this.currentSprite]),StageMorph.prototype.dimensions=new Point(480,360),StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,SpriteMorph.prototype.useFlatLineEnds=!1,this.projectNotes="",this.createStage(),this.add(this.stage),this.createCorral(),this.selectSprite(this.stage.children[0]),this.fixLayout()},NetsBloxMorph.prototype.newProject=function(t){this.clearProject(),this.sockets.sendMessage({type:"create-room",role:t||RoomMorph.DEFAULT_ROLE}),this.silentSetProjectName(t||RoomMorph.DEFAULT_ROLE),this.createRoom(),this.selectSprite(this.stage.children[0])},NetsBloxMorph.prototype.createRoom=function(){this.room=new RoomMorph(this)},NetsBloxMorph.prototype.createSpriteEditor=function(){"room"===this.currentTab?(this.spriteEditor&&this.spriteEditor.destroy(),this.spriteEditor=new ProjectsMorph(this.room,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor)):NetsBloxMorph.uber.createSpriteEditor.call(this)},NetsBloxMorph.prototype.setProjectName=function(t){this.room.setRoleName(t)},NetsBloxMorph.prototype.silentSetProjectName=function(t){return NetsBloxMorph.uber.setProjectName.call(this,t)},NetsBloxMorph.prototype.createControlBar=function(){var t=this,e=5;NetsBloxMorph.uber.createControlBar.call(this),this.controlBar.updateLabel=function(){var o=" @ "+t.room.name;o+=t.world().isDevMode?" - "+localize("development mode"):"",this.label&&this.label.destroy(),t.isAppMode||(this.label=new StringMorph((t.projectName||localize("untitled"))+o,14,"sans-serif",!0,!1,!1,MorphicPreferences.isFlat?null:new Point(2,1),t.frameColor.darker(t.buttonContrast)),this.label.color=t.buttonLabelColor,this.label.drawNew(),this.add(this.label),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+e))}},NetsBloxMorph.prototype.loadNextRoom=function(){if(this.room.nextRoom){var t=this.room.nextRoom;this.room._name=t.roomName,this.room.leaderId=t.leaderId,this.silentSetProjectName(t.roleId),this.sockets.updateRoomInfo(),this.room.nextRoom=null}},NetsBloxMorph.prototype.rawOpenCloudDataString=function(t,e){if(StageMorph.prototype.hiddenPrimitives={},StageMorph.prototype.codeMappings={},StageMorph.prototype.codeHeaders={},StageMorph.prototype.enableCodeMapping=!1,StageMorph.prototype.enableInheritance=!1,Process.prototype.isCatchingErrors)try{t=e?t:this.serializer.parse(t),this.serializer.loadMediaModel(t.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(t.childNamed("project"),this),this),this.loadNextRoom()}catch(t){this.showMessage("Load failed: "+t)}else t=e?t:this.serializer.parse(t),this.serializer.loadMediaModel(t.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(t.childNamed("project"),this),this),this.loadNextRoom();this.stopFastTracking()},NetsBloxMorph.prototype.createSpriteBar=function(){function t(t){var e,o=d.rotationStyleColors;return e=new ToggleButtonMorph(o,d,function(){d.currentSprite instanceof SpriteMorph&&(d.currentSprite.rotationStyle=t,d.currentSprite.changed(),d.currentSprite.drawNew(),d.currentSprite.changed()),n.forEach(function(t){t.refresh()})},p[t],function(){return d.currentSprite instanceof SpriteMorph&&d.currentSprite.rotationStyle===t},null,localize(c[t])),e.corner=8,e.labelMinExtent=new Point(11,11),e.padding=0,e.labelShadowOffset=new Point(-1,-1),e.labelShadowColor=o[1],e.labelColor=d.buttonLabelColor,e.fixLayout(),e.refresh(),n.push(e),e.setPosition(d.spriteBar.position().add(2)),e.setTop(e.top()+(n.length-1)*(e.height()+2)),d.spriteBar.add(e),d.currentSprite instanceof StageMorph&&e.hide(),e}var e,o,r,i,n=[],s=new Point(45,45),a=15,h=this.tabColors,l=new AlignmentMorph("row",2*-a),p=["","",""],c=["don't rotate","can rotate","only face left/right"],d=this;this.spriteBar&&this.spriteBar.destroy(),this.spriteBar=new Morph,this.spriteBar.color=this.frameColor,this.add(this.spriteBar),t(1),t(2),t(0),this.rotationStyleButtons=n,r=new Morph,r.setExtent(s),r.image=this.currentSprite.thumbnail(s),r.setPosition(n[0].topRight().add(new Point(5,3))),this.spriteBar.add(r),r.fps=3,r.step=function(){r.version!==d.currentSprite.version&&(r.image=d.currentSprite.thumbnail(s),r.changed(),r.version=d.currentSprite.version)},e=new InputFieldMorph(this.currentSprite.name),e.setWidth(100),e.contrast=90,e.setPosition(r.topRight().add(new Point(10,3))),this.spriteBar.add(e),e.drawNew(),e.accept=function(){var t=e.getValue();d.currentSprite.setName(d.newSpriteName(t,d.currentSprite)),e.setContents(d.currentSprite.name)},this.spriteBar.reactToEdit=e.accept,o=new ToggleMorph("checkbox",null,function(){d.currentSprite.isDraggable=!d.currentSprite.isDraggable},localize("draggable"),function(){return d.currentSprite.isDraggable}),o.label.isBold=!1,o.label.setColor(this.buttonLabelColor),o.color=h[2],o.highlightColor=h[0],o.pressColor=h[1],o.tick.shadowOffset=MorphicPreferences.isFlat?new Point:new Point(-1,-1),o.tick.shadowColor=new Color,o.tick.color=this.buttonLabelColor,o.tick.isBold=!1,o.tick.drawNew(),o.setPosition(e.bottomLeft().add(2)),o.drawNew(),this.spriteBar.add(o),this.currentSprite instanceof StageMorph&&o.hide(),l.tabTo=function(t){var e;d.currentTab=t,this.children.forEach(function(t){t.refresh(),t.state&&(e=t)}),e.refresh(),d.createSpriteEditor(),d.fixLayout("tabEditor")},i=new TabMorph(h,null,function(){l.tabTo("scripts")},localize("Scripts"),function(){return"scripts"===d.currentTab}),i.padding=3,i.corner=a,i.edge=1,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=h[1],i.labelColor=this.buttonLabelColor,i.drawNew(),i.fixLayout(),l.add(i),i=new TabMorph(h,null,function(){l.tabTo("costumes")},localize("Costumes"),function(){return"costumes"===d.currentTab}),i.padding=3,i.corner=a,i.edge=1,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=h[1],i.labelColor=this.buttonLabelColor,i.drawNew(),i.fixLayout(),l.add(i),i=new TabMorph(h,null,function(){l.tabTo("sounds")},localize("Sounds"),function(){return"sounds"===d.currentTab}),i.padding=3,i.corner=a,i.edge=1,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=h[1],i.labelColor=this.buttonLabelColor,i.drawNew(),i.fixLayout(),l.add(i),i=new TabMorph(h,null,function(){l.tabTo("room")},localize("Room"),function(){return"room"===d.currentTab}),i.padding=3,i.corner=a,i.edge=1,i.labelShadowOffset=new Point(-1,-1),i.labelShadowColor=h[1],i.labelColor=this.buttonLabelColor,i.drawNew(),i.fixLayout(),l.add(i),l.fixLayout(),l.children.forEach(function(t){t.refresh()}),this.spriteBar.tabBar=l,this.spriteBar.add(this.spriteBar.tabBar),this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left()),this.tabBar.setBottom(this.bottom())}},NetsBloxMorph.prototype.projectMenu=function(){function t(t,e){return function(){var n=this.getMediaList(t),s=new MenuMorph(o,localize("Import")+" "+localize(t));n.forEach(function(t){s.addItem(t.name,function(){e(t.file,t.name)},t.help)}),s.popup(r,i)}}var e,o=this,r=this.world(),i=this.controlBar.projectButton.bottomLeft(),n=this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds",s=16===r.currentKey;e=new MenuMorph(this),e.addItem("Project notes...","editProjectNotes"),e.addLine(),e.addItem("New","createNewProject"),e.addItem("Open...","openProjectsBrowser"),e.addItem("Save","save"),e.addItem("Save As...","saveProjectsBrowser"),e.addLine(),e.addItem("Import...",function(){var t=document.createElement("input");o.filePicker&&(document.body.removeChild(o.filePicker),o.filePicker=null),t.type="file",t.style.color="transparent",t.style.backgroundColor="transparent",t.style.border="none",t.style.outline="none",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="0px",t.style.height="0px",t.addEventListener("change",function(){document.body.removeChild(t),o.filePicker=null,r.hand.processDrop(t.files)},!1),document.body.appendChild(t),o.filePicker=t,t.click()},"file menu import hint"),s&&e.addItem(localize("Export role..."),function(){o.projectName?o.exportRole(o.projectName,s):o.prompt("Export Project As...",function(t){o.exportRole(t,!1,!0)},null,"exportRole")},'save "'+o.projectName+'" as XML\nto your downloads folder',new Color(100,0,0)),e.addItem(s?"Export project as plain text...":"Export project...",function(){o.projectName?o.exportProject(o.projectName,s):o.prompt("Export Project As...",function(t){o.exportProject(t,s)},null,"exportProject")},"save project data as XML\nto your downloads folder",s?new Color(100,0,0):null),(this.stage.globalBlocks.length||this.stage.deletableMessageNames().length)&&(e.addItem("Export blocks/msgs...",function(){o.exportGlobalBlocks()},"show global custom block definitions/message types as XML\nin a new browser window"),e.addItem("Unused blocks...",function(){o.removeUnusedBlocks()},"find unused global custom blocks\nand remove their definitions")),e.addItem("Export summary...",function(){o.exportProjectSummary()},"open a new browser browser window\n with a summary of this project"),s&&(e.addItem("Export summary with drop-shadows...",function(){o.exportProjectSummary(!0)},"open a new browser browser window\nwith a summary of this project\nwith drop-shadows on all pictures.\nnot supported by all browsers",new Color(100,0,0)),e.addItem("Export all scripts as pic...",function(){o.exportScriptsPicture()},"show a picture of all scripts\nand block definitions",new Color(100,0,0))),e.addLine(),e.addItem("Import tools",function(){o.droppedText(o.getURL("api/tools.xml"),"tools")},"load the official library of\npowerful blocks"),e.addItem("Libraries...",t("libraries",function(t,e){var r=o.resourceURL("libraries",t);o.droppedText(o.getURL(r),e)}),"Select categories of additional blocks to add to this project."),e.addItem("Remote Calls...",t("rpc",function(t,e){var r=o.resourceURL("rpc",t);o.droppedText(o.getURL(r),e)}),"Select remote procedure calls to add to this project."),e.addItem("Message Types...",function(){function t(t){var e="/api/MessageTypes/"+t;try{var r=JSON.parse(o.getURL(e));o.stage.addMessageType(r)}catch(e){console.error('could not load the message type "'+t+'"')}}var e=new MenuMorph(this,"Import Network Message Type"),n="/api/MessageTypes/index",s=[];try{s=JSON.parse(o.getURL(n))}catch(t){console.error("could not load the message types")}s.forEach(function(o){e.addItem(o,t.bind(null,o))}),e.popup(r,i)},"Add new types of messages to your project!"),e.addItem(localize(n)+"...",t(n,function(t,e){var r=o.resourceURL(n,t),i=new Image;i.onload=function(){var t=newCanvas(new Point(i.width,i.height));t.getContext("2d").drawImage(i,0,0),o.droppedImage(t,e)},i.src=r}),"Select a costume from the media library"),e.addItem(localize("Sounds")+"...",t("Sounds",function(t,e){var r=o.resourceURL("Sounds",t),i=new Audio;i.src=r,i.load(),o.droppedAudio(i,e)}),"Select a sound from the media library"),e.popup(r,i)},NetsBloxMorph.prototype.requestAndroidApp=function(t){var e,o,r,i=this,n=window.location.origin+"/";t!==this.projectName&&this.setProjectName(t),e=encodeURIComponent(this.serializer.serialize(this.stage)),o=new XMLHttpRequest,r="projectName="+t+"&username="+SnapCloud.username+"&xml="+e+"&baseURL="+encodeURIComponent(n),o.open("post",n+"api/mobile/compile",!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onload=function(){i.showMessage(o.responseText)},o.send(r)},NetsBloxMorph.prototype.exportRole=NetsBloxMorph.prototype.exportProject,NetsBloxMorph.prototype.exportProject=function(t){this.showMessage("Exporting",3),this.sockets.sendMessage({type:"export-room",action:"export"})},NetsBloxMorph.prototype.exportRoom=function(t){var e,o=this.room.name;try{e=this.serializer.serializeRoom(o,t),this.saveXMLAs(e,o),this.showMessage("Exported!",1)}catch(t){if(!Process.prototype.isCatchingErrors)throw t;this.showMessage("Export failed: "+t)}},NetsBloxMorph.prototype.openRoomString=function(t){var e,o=this.serializer.parse(t),r={};return o.children[0]?(o.children.forEach(function(t){r[t.attributes.name]={SourceCode:t.children[0].toString(),Media:t.children[1].toString()}}),e=o.children[0].attributes.name,this.showMessage("Opening room...",3),this.newProject(e),this.sockets.sendMessage({type:"import-room",name:o.attributes.name,role:e,roles:r}),void this.openCloudDataString(o.children[0],!0)):void this.showMessage("Malformed room - No roles found.")},NetsBloxMorph.prototype.openCloudDataString=function(t,e){var o,r=this,i=e?t:t.toString(),n=Math.round(i.length/1024);this.nextSteps([function(){o=r.showMessage("Opening project\n"+n+" KB...")},function(){nop()},function(){r.rawOpenCloudDataString(t,e)},function(){o.destroy()}])},NetsBloxMorph.prototype.rawSaveProject=function(t){this.showMessage("Saving",3),t&&(this.room.name=t),this.sockets.sendMessage({type:"export-room",action:"save"})},NetsBloxMorph.prototype.saveRoomLocal=function(t){var e,o=this.room.name;if(Process.prototype.isCatchingErrors)try{localStorage["-snap-project-"+o]=e=this.serializer.serializeRoom(o,t),this.setURL("#open:"+e),this.showMessage("Saved!",1)}catch(t){this.showMessage("Save failed: "+t)}else localStorage["-snap-project-"+o]=e=this.serializer.serializeRoom(o,t),this.setURL("#open:"+e),this.showMessage("Saved!",1)},NetsBloxMorph.prototype.openProject=function(t){var e;t&&(this.showMessage("opening project\n"+t),e=localStorage["-snap-project-"+t],this.openRoomString(e),this.setURL("#open:"+e))},NetsBloxMorph.prototype.save=function(){"examples"===this.source&&(this.source="local"),this.projectName?"local"===this.source?this.saveProject(this.room.name):this.saveProjectToCloud(this.projectName):this.saveProjectsBrowser()},NetsBloxMorph.prototype.getURL=function(t){var e=new XMLHttpRequest,o=this;try{if(e.open("GET",t,!1),e.send(),200===e.status)return e.responseText;var r=0===e.responseText.indexOf("ERROR")?e.responseText:"unable to retrieve "+t;throw new Error(r)}catch(t){return void o.showMessage(t.message)}},NetsBloxMorph.prototype.logout=function(){NetsBloxMorph.uber.logout.call(this),this.room.update()},NetsBloxMorph.prototype.droppedText=function(t,e){return 0===t.indexOf("<rpc")?this.openBlocksMsgTypeString(t):0===t.indexOf("<room")?(location.hash="",this.openRoomString(t)):IDE_Morph.prototype.droppedText.call(this,t,e)},NetsBloxMorph.prototype.openBlocksMsgTypeString=function(t){var e,o=this;this.nextSteps([function(){e=o.showMessage("Opening...")},function(){nop()},function(){if(Process.prototype.isCatchingErrors)try{o.rawOpenBlocksMsgTypeString(t)}catch(t){o.showMessage("Load failed: "+t)}else o.rawOpenBlocksMsgTypeString(t)},function(){e.destroy()}])},NetsBloxMorph.prototype.rawOpenBlocksMsgTypeString=function(t){var e,o=this.serializer.parse(t),r=o.childNamed("messageTypes"),i=o.childNamed("blocks").toString();r&&(e=r.children,e.forEach(this.serializer.loadMessageType.bind(this,this.stage))),this.rawOpenBlocksString(i,"",!0)},NetsBloxMorph.prototype.initializeCloud=function(){var t=this,e=this.world();new DialogBoxMorph(null,function(e){var o,r=hex_sha512(e.password);SnapCloud.login(e.username,r,e.choice,function(){e.choice&&(o=SnapCloud.encodeDict({username:e.username,password:r}),localStorage["-snap-user"]=o),t.source="cloud",t.showMessage("now connected.",2)},t.cloudError())}).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",e,t.cloudIcon(),t.cloudMsg)},NetsBloxSerializer.prototype=new SnapSerializer,NetsBloxSerializer.prototype.constructor=NetsBloxSerializer,NetsBloxSerializer.uber=SnapSerializer.prototype,NetsBloxSerializer.prototype.app="NetsBlox 0.7.1, http://netsblox.org",NetsBloxSerializer.prototype.serializeRoom=function(t,e){for(var o,r=Object.keys(e),i="",n=r.length;n--;)o=e[r[n]],i+=this.format('<role name="@">',r[n])+o.SourceCode+o.Media+"</role>";return this.format('<room name="@" app="@">',t,this.app)+i+"</room>"},NetsBloxSerializer.prototype.loadMessageType=function(t,e){var o=e.childNamed("name").contents,r=e.childNamed("fields").children.map(function(t){return t.contents});t.addMessageType({name:o,fields:r})},NetsBloxSerializer.prototype.openProject=function(t,e){var o,r=e.stage,i=[];t&&t.stage&&("myRole"===e.projectName&&e.setProjectName(t.name),e.projectNotes=t.notes||"",e.globalVariables&&(e.globalVariables=t.globalVariables),r&&r.destroy(),e.add(t.stage),e.stage=t.stage,i=e.stage.children.filter(function(t){return t instanceof SpriteMorph}),i.sort(function(t,e){return t.idx-e.idx}),e.sprites=new List(i),o=i[0]||t.stage,sizeOf(this.mediaDict)>0?(e.hasChangedMedia=!1,this.mediaDict={}):e.hasChangedMedia=!0,t.stage.drawNew(),e.createCorral(),e.selectSprite(o),e.fixLayout(),e.world().keyboardReceiver=t.stage)},NetsBloxSerializer.prototype.loadBlock=function(t,e){var o,r,i,n,s,a;if("block"===t.tag){if(Object.prototype.hasOwnProperty.call(t.attributes,"var"))return SpriteMorph.prototype.variableBlock(t.attributes.var);o=SpriteMorph.prototype.blockForSelector(t.attributes.s)}else if("custom-block"===t.tag){if(n=!t.attributes.scope,a=n?this.project.stage:this.project.sprites[t.attributes.scope],s=t.childNamed("receiver"),s&&s.children[0]&&(a=this.loadValue(t.childNamed("receiver").children[0])),!a){if(n)return this.obsoleteBlock(e);a=this.project.stage}if(n?(r=detect(a.globalBlocks,function(e){return e.blockSpec()===t.attributes.s}),!r&&this.project.targetStage&&(r=detect(this.project.targetStage.globalBlocks,function(e){return e.blockSpec()===t.attributes.s}))):r=detect(a.customBlocks,function(e){return e.blockSpec()===t.attributes.s}),!r)return this.obsoleteBlock(e);o="command"===r.type?new CustomCommandBlockMorph(r,!1):new CustomReporterBlockMorph(r,"predicate"===r.type,!1)}if(null===o&&(o=this.obsoleteBlock(e)),o.isDraggable=!0,i=o.inputs(),i.length<t.children.length){for(var h=[],l=["comment","receiver"],p=t.children.length;p--&&l.indexOf(t.children[p].tag)===-1;)h=t.children.splice(p,1).concat(h);if(h.length){var c=this,d=h.map(function(t){return"block"===t.tag||"custom-block"===t.tag?c.loadBlock(t):"script"===t.tag?c.loadScript(t):"color"===t.tag?c.loadColor(t):c.loadValue(t)||""}),u=i[++p];u.setContents&&u.setContents(d[0],d.slice(1))}}return t.children.forEach(function(t,e){"comment"===t.tag?(o.comment=this.loadComment(t),o.comment.block=o):"receiver"===t.tag?nop():this.loadInput(t,i[e],o)},this),o.cachedInputs=null,o},NetsBloxSerializer.prototype.rawLoadProjectModel=function(t){var e,o,r=this,i={sprites:{}};if(this.project=i,e={project:t},+t.attributes.version>this.version)throw"Project uses newer version of Serializer";if(this.objects={},i.name=e.project.attributes.name,!i.name){for(o=1;Object.prototype.hasOwnProperty.call(localStorage,"-snap-project-Untitled "+o);)o+=1;i.name="Untitled "+o}if(e.notes=e.project.childNamed("notes"),e.notes&&(i.notes=e.notes.contents),e.globalVariables=e.project.childNamed("variables"),i.globalVariables=new VariableFrame,e.stage=e.project.require("stage"),StageMorph.prototype.frameRate=0,i.stage&&i.stage.destroy(),i.stage=new StageMorph(i.globalVariables),Object.prototype.hasOwnProperty.call(e.stage.attributes,"id")&&(this.objects[e.stage.attributes.id]=i.stage),e.stage.attributes.name&&(i.stage.name=e.stage.attributes.name),"true"===e.stage.attributes.scheduled&&(i.stage.fps=30,StageMorph.prototype.frameRate=30),e.pentrails=e.stage.childNamed("pentrails"),e.pentrails&&(i.pentrails=new Image,i.pentrails.onload=function(){var t=i.stage.trailsCanvas.getContext("2d");t.drawImage(i.pentrails,0,0),i.stage.changed()},i.pentrails.src=e.pentrails.contents),i.stage.setTempo(e.stage.attributes.tempo),StageMorph.prototype.dimensions=new Point(480,360),e.stage.attributes.width&&(StageMorph.prototype.dimensions.x=Math.max(+e.stage.attributes.width,480)),e.stage.attributes.height&&(StageMorph.prototype.dimensions.y=Math.max(+e.stage.attributes.height,180)),i.stage.setExtent(StageMorph.prototype.dimensions),SpriteMorph.prototype.useFlatLineEnds="flat"===e.stage.attributes.lines,i.stage.isThreadSafe="true"===e.stage.attributes.threadsafe,StageMorph.prototype.enableCodeMapping="true"===e.stage.attributes.codify,StageMorph.prototype.enableInheritance="true"===e.stage.attributes.inheritance,e.hiddenPrimitives=e.project.childNamed("hidden"),e.hiddenPrimitives&&e.hiddenPrimitives.contents.split(" ").forEach(function(t){t&&(StageMorph.prototype.hiddenPrimitives[t]=!0)}),e.codeHeaders=e.project.childNamed("headers"),e.codeHeaders&&e.codeHeaders.children.forEach(function(t){StageMorph.prototype.codeHeaders[t.tag]=t.contents}),e.codeMappings=e.project.childNamed("code"),e.codeMappings&&e.codeMappings.children.forEach(function(t){StageMorph.prototype.codeMappings[t.tag]=t.contents}),e.globalBlocks=e.project.childNamed("blocks"),e.globalBlocks&&(this.loadCustomBlocks(i.stage,e.globalBlocks,!0),this.populateCustomBlocks(i.stage,e.globalBlocks,!0)),e.messageTypes=e.stage.childNamed("messageTypes"),e.messageTypes){var n=e.messageTypes.children;n.forEach(this.loadMessageType.bind(this,i.stage))}return this.loadObject(i.stage,e.stage),e.sprites=e.stage.require("sprites"),i.sprites[i.stage.name]=i.stage,e.sprites.childrenNamed("sprite").forEach(function(t){r.loadValue(t)}),r.project.stage.children.forEach(function(t){var e,o;t.inheritanceInfo&&(e=r.project.sprites[t.inheritanceInfo.exemplar],e&&t.setExemplar(e)),t.nestingInfo&&(o=r.project.sprites[t.nestingInfo.anchor],o&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)}),r.project.stage.children.forEach(function(t){delete t.inheritanceInfo,t.nestingInfo&&(t.nestingScale=+(t.nestingInfo.scale||t.scale),delete t.nestingInfo)}),e.globalVariables&&this.loadVariables(i.globalVariables,e.globalVariables),this.objects={},e.sprites.childrenNamed("watcher").forEach(function(t){var e,o,n,s,a,h;o=r.loadColor(t.attributes.color),n=Object.prototype.hasOwnProperty.call(t.attributes,"scope")?i.sprites[t.attributes.scope]:null,s=Object.prototype.hasOwnProperty.call(t.attributes,"hidden")&&"false"!==t.attributes.hidden,e=Object.prototype.hasOwnProperty.call(t.attributes,"var")?new WatcherMorph(t.attributes.var,o,isNil(n)?i.globalVariables:n.variables,t.attributes.var,s):new WatcherMorph(localize(r.watcherLabels[t.attributes.s]),o,n,t.attributes.s,s),e.setStyle(t.attributes.style||"normal"),"slider"===e.style&&(e.setSliderMin(t.attributes.min||"1",!0),e.setSliderMax(t.attributes.max||"100",!0)),e.setPosition(i.stage.topLeft().add(new Point(+t.attributes.x||0,+t.attributes.y||0))),i.stage.add(e),e.onNextStep=function(){this.currentValue=null},e.currentValue instanceof List&&(a=t.attributes.extX,a&&e.cellMorph.contentsMorph.setWidth(+a),h=t.attributes.extY,h&&e.cellMorph.contentsMorph.setHeight(+h),e.cellMorph.contentsMorph.handle.drawNew())}),this.objects={},i},StageMorph.prototype.toXML=function(t){function e(t){var e="";return Object.keys(StageMorph.prototype[t]).forEach(function(o){e+="<"+o+">"+XML_Element.prototype.escape(StageMorph.prototype[t][o])+"</"+o+">"}),e}var o,r=this.thumbnail(NetsBloxSerializer.prototype.thumbnailSize),i=this.parentThatIsA(IDE_Morph);try{o=r.toDataURL("image/png")}catch(t){o=null}return this.removeAllClones(),t.format('<project name="@" app="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" costume="@" tempo="@" threadsafe="@" lines="@" codify="@" inheritance="@" scheduled="@" ~><pentrails>$</pentrails><costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><messageTypes>%</messageTypes><scripts>%</scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables></project>',i&&i.projectName?i.projectName:localize("Untitled"),t.app,t.version,i&&i.projectNotes?i.projectNotes:"",o,this.name,StageMorph.prototype.dimensions.x,StageMorph.prototype.dimensions.y,this.getCostumeIdx(),this.getTempo(),this.isThreadSafe,SpriteMorph.prototype.useFlatLineEnds?"flat":"round",this.enableCodeMapping,this.enableInheritance,0!==StageMorph.prototype.frameRate,this.trailsCanvas.toDataURL("image/png"),t.store(this.costumes,this.name+"_cst"),t.store(this.sounds,this.name+"_snd"),t.store(this.variables),t.store(this.customBlocks),t.store(this.messageTypes),t.store(this.scripts),t.store(this.children),Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(function(t,e){return t+" "+e},""),e("codeHeaders"),e("codeMappings"),t.store(this.globalBlocks),i&&i.globalVariables?t.store(i.globalVariables):"")},MessageFrame.prototype.toXML=function(t){var e=this,o=this.names().map(function(t){return e.getMsgType(t)});return o.map(function(e){return t.format("<messageType>%</messageType>",t.store(e))}).join("")},MessageType.prototype.toXML=function(t){var e=this.fields.map(function(e){return t.format("<field>%</field>",t.escape(e))}).join("");return t.format("<name>%</name><fields>%</fields>",t.escape(this.name),e)};
//# sourceMappingURL=/home/irishninja/projects/netsblox/src/client/netsblox-build.js.map